<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\transam\xact.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\transam\xact.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:30 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * xact.c 
 *    top level transaction system support routines 
 * 
 * See src/backend/access/transam/README for more information. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/access/transam/xact.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/commit_ts.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/parallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/subtrans.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/storage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/async.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/be-fsstubs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logical.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logicallauncher.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/origin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/syncrep.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/condition_variable.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinvaladt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/catcache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/combocid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/relmapper.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timeout.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  User-tweakable parameters 
 */ 
</span><a name="LN72"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>DefaultXactIsoLevel</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN28"><span class='Ref_to_Const'>XACT_READ_COMMITTED</span></a><span class='Delimiter'>; 
</span><a name="LN73"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>XactIsoLevel</span><span class='Delimiter'>; 
</span> 
<a name="LN75"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>DefaultXactReadOnly</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN76"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>XactReadOnly</span><span class='Delimiter'>; 
</span> 
<a name="LN78"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>DefaultXactDeferrable</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>XactDeferrable</span><span class='Delimiter'>; 
</span> 
<a name="LN81"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>synchronous_commit</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN68"><span class='Ref_to_Const'>SYNCHRONOUS_COMMIT_ON</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * When running as a parallel worker, we place only a single 
 * TransactionStateData on the parallel worker's state stack, and the XID 
 * reflected there will be that of the *innermost* currently-active 
 * subtransaction in the backend that initiated parallelism.  However, 
 * GetTopTransactionId() and TransactionIdIsCurrentTransactionId() 
 * need to return the same answers in the parallel worker as they would have 
 * in the user backend, so we need some additional bookkeeping. 
 * 
 * XactTopTransactionId stores the XID of our toplevel transaction, which 
 * will be the same as TopTransactionState.transactionId in an ordinary 
 * backend; but in a parallel backend, which does not have the entire 
 * transaction state, it will instead be copied from the backend that started 
 * the parallel operation. 
 * 
 * nParallelCurrentXids will be 0 and ParallelCurrentXids NULL in an ordinary 
 * backend, but in a parallel backend, nParallelCurrentXids will contain the 
 * number of XIDs that need to be considered current, and ParallelCurrentXids 
 * will contain the XIDs themselves.  This includes all XIDs that were current 
 * or sub-committed in the parent at the time the parallel operation began. 
 * The XIDs are stored sorted in numerical order (not logical order) to make 
 * lookups as fast as possible. 
 */ 
</span><a name="LN106"></a><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>XactTopTransactionId</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN107"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>nParallelCurrentXids</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN108"></a><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ParallelCurrentXids</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Miscellaneous flag bits to record events which occur on the top level 
 * transaction. These flags are only persisted in MyXactFlags and are intended 
 * so we remember to do certain things later on in the transaction. This is 
 * globally accessible, so can be set from anywhere in the code that requires 
 * recording flags. 
 */ 
</span><a name="LN117"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>MyXactFlags</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  transaction states - transaction state from server perspective 
 */ 
</span><a name="LN122"></a><span class='Control'>typedef</span> <span class='Control'>enum</span> <span class='Declare_Enum'>TransState</span> 
<span class='Delimiter'>{ 
</span><a name="LN124"></a>    <span class='Declare_Enum_Const'>TRANS_DEFAULT</span><span class='Delimiter'>,</span>              <span class='Comment_Single_Line'>/* idle */ 
</span><a name="LN125"></a>    <span class='Declare_Enum_Const'>TRANS_START</span><span class='Delimiter'>,</span>                <span class='Comment_Single_Line'>/* transaction starting */ 
</span><a name="LN126"></a>    <span class='Declare_Enum_Const'>TRANS_INPROGRESS</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* inside a valid transaction */ 
</span><a name="LN127"></a>    <span class='Declare_Enum_Const'>TRANS_COMMIT</span><span class='Delimiter'>,</span>               <span class='Comment_Single_Line'>/* commit in progress */ 
</span><a name="LN128"></a>    <span class='Declare_Enum_Const'>TRANS_ABORT</span><span class='Delimiter'>,</span>                <span class='Comment_Single_Line'>/* abort in progress */ 
</span><a name="LN129"></a>    <span class='Declare_Enum_Const'>TRANS_PREPARE</span>               <span class='Comment_Single_Line'>/* prepare in progress */ 
</span><a name="LN130"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TransState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  transaction block states - transaction state of client queries 
 * 
 * Note: the subtransaction states are used only for non-topmost 
 * transactions; the others appear only in the topmost transaction. 
 */ 
</span><a name="LN138"></a><span class='Control'>typedef</span> <span class='Control'>enum</span> <span class='Declare_Enum'>TBlockState</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* not-in-transaction-block states */ 
</span><a name="LN141"></a>    <span class='Declare_Enum_Const'>TBLOCK_DEFAULT</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* idle */ 
</span><a name="LN142"></a>    <span class='Declare_Enum_Const'>TBLOCK_STARTED</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* running single-query transaction */ 
</span> 
    <span class='Comment_Multi_Line'>/* transaction block states */ 
</span><a name="LN145"></a>    <span class='Declare_Enum_Const'>TBLOCK_BEGIN</span><span class='Delimiter'>,</span>               <span class='Comment_Single_Line'>/* starting transaction block */ 
</span><a name="LN146"></a>    <span class='Declare_Enum_Const'>TBLOCK_INPROGRESS</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* live transaction */ 
</span><a name="LN147"></a>    <span class='Declare_Enum_Const'>TBLOCK_PARALLEL_INPROGRESS</span><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* live transaction inside parallel worker */ 
</span><a name="LN148"></a>    <span class='Declare_Enum_Const'>TBLOCK_END</span><span class='Delimiter'>,</span>                 <span class='Comment_Single_Line'>/* COMMIT received */ 
</span><a name="LN149"></a>    <span class='Declare_Enum_Const'>TBLOCK_ABORT</span><span class='Delimiter'>,</span>               <span class='Comment_Single_Line'>/* failed xact, awaiting ROLLBACK */ 
</span><a name="LN150"></a>    <span class='Declare_Enum_Const'>TBLOCK_ABORT_END</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* failed xact, ROLLBACK received */ 
</span><a name="LN151"></a>    <span class='Declare_Enum_Const'>TBLOCK_ABORT_PENDING</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* live xact, ROLLBACK received */ 
</span><a name="LN152"></a>    <span class='Declare_Enum_Const'>TBLOCK_PREPARE</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* live xact, PREPARE received */ 
</span> 
    <span class='Comment_Multi_Line'>/* subtransaction states */ 
</span><a name="LN155"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBBEGIN</span><span class='Delimiter'>,</span>            <span class='Comment_Single_Line'>/* starting a subtransaction */ 
</span><a name="LN156"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBINPROGRESS</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* live subtransaction */ 
</span><a name="LN157"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBRELEASE</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* RELEASE received */ 
</span><a name="LN158"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBCOMMIT</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* COMMIT received while TBLOCK_SUBINPROGRESS */ 
</span><a name="LN159"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBABORT</span><span class='Delimiter'>,</span>            <span class='Comment_Single_Line'>/* failed subxact, awaiting ROLLBACK */ 
</span><a name="LN160"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBABORT_END</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* failed subxact, ROLLBACK received */ 
</span><a name="LN161"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBABORT_PENDING</span><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* live subxact, ROLLBACK received */ 
</span><a name="LN162"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBRESTART</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* live subxact, ROLLBACK TO received */ 
</span><a name="LN163"></a>    <span class='Declare_Enum_Const'>TBLOCK_SUBABORT_RESTART</span>     <span class='Comment_Single_Line'>/* failed subxact, ROLLBACK TO received */ 
</span><a name="LN164"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end TBlockState &raquo; </span> <span class='Declare_Typedef'>TBlockState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  transaction state structure 
 */ 
</span><a name="LN169"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TransactionStateData</span> 
<span class='Delimiter'>{ 
</span><a name="LN171"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>transactionId</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* my XID, or Invalid if none */ 
</span><a name="LN172"></a>    <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Member'>subTransactionId</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* my subxact ID */ 
</span><a name="LN173"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>name</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* savepoint name, if any */ 
</span><a name="LN174"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>savepointLevel</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* savepoint level */ 
</span><a name="LN175"></a>    <a href="xact.c.html#LN122"><span class='Ref_to_Enum'>TransState</span></a>  <span class='Declare_Member'>state</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* low-level state */ 
</span><a name="LN176"></a>    <a href="xact.c.html#LN138"><span class='Ref_to_Enum'>TBlockState</span></a> <span class='Declare_Member'>blockState</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* high-level state */ 
</span><a name="LN177"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nestingLevel</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* transaction nesting depth */ 
</span><a name="LN178"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>gucNestLevel</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* GUC context nesting depth */ 
</span><a name="LN179"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>curTransactionContext</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* my xact-lifetime context */ 
</span><a name="LN180"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Member'>curTransactionOwner</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* my query resources */ 
</span><a name="LN181"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Member'>childXids</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* subcommitted child XIDs, in XID order */ 
</span><a name="LN182"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nChildXids</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* # of subcommitted child XIDs */ 
</span><a name="LN183"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>maxChildXids</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* allocated size of childXids[] */ 
</span><a name="LN184"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>prevUser</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* previous CurrentUserId setting */ 
</span><a name="LN185"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>prevSecContext</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* previous SecurityRestrictionContext */ 
</span><a name="LN186"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>prevXactReadOnly</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* entry-time xact r/o state */ 
</span><a name="LN187"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>startedInRecovery</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* did we start in recovery? */ 
</span><a name="LN188"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>didLogXid</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* has xid been included in WAL record? */ 
</span><a name="LN189"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>parallelModeLevel</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Enter/ExitParallelMode counter */ 
</span><a name="LN190"></a>    <span class='Control'>struct</span> <a href="xact.c.html#LN169"><span class='Ref_to_Struct'>TransactionStateData</span></a> <span class='Operator'>*</span><span class='Declare_Member'>parent</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* back link to parent */ 
</span><a name="LN191"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end TransactionStateData &raquo; </span> <span class='Declare_Typedef'>TransactionStateData</span><span class='Delimiter'>; 
</span> 
<a name="LN193"></a><span class='Control'>typedef</span> <a href="xact.c.html#LN169"><span class='Ref_to_Struct'>TransactionStateData</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>TransactionState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CurrentTransactionState always points to the current transaction state 
 * block.  It will point to TopTransactionStateData when not in a 
 * transaction at all, or when in a top-level transaction. 
 */ 
</span><a name="LN200"></a><span class='Keyword'>static </span><a href="xact.c.html#LN169"><span class='Ref_to_Struct'>TransactionStateData</span></a> <span class='Declare_Var'>TopTransactionStateData</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* transaction id */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* subtransaction id */ 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* savepoint name */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* savepoint level */ 
</span>    <a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>,</span>              <span class='Comment_Single_Line'>/* transaction state */ 
</span>    <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>,</span>             <span class='Comment_Multi_Line'>/* transaction block state from the client 
                                 * perspective */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* transaction nesting depth */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* GUC context nesting depth */ 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* cur transaction context */ 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* cur transaction resource owner */ 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>                       <span class='Comment_Single_Line'>/* subcommitted child Xids */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* # of subcommitted child Xids */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* allocated size of childXids[] */ 
</span>    <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>                 <span class='Comment_Single_Line'>/* previous CurrentUserId setting */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* previous SecurityRestrictionContext */ 
</span>    <span class='Boolean'>false</span><span class='Delimiter'>,</span>                      <span class='Comment_Single_Line'>/* entry-time xact r/o state */ 
</span>    <span class='Boolean'>false</span><span class='Delimiter'>,</span>                      <span class='Comment_Single_Line'>/* startedInRecovery */ 
</span>    <span class='Boolean'>false</span><span class='Delimiter'>,</span>                      <span class='Comment_Single_Line'>/* didLogXid */ 
</span>    <span class='Number'>0</span><span class='Delimiter'>,</span>                          <span class='Comment_Single_Line'>/* parallelMode */ 
</span>    <span class='Null_Value'>NULL</span>                        <span class='Comment_Single_Line'>/* link to parent state block */ 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * unreportedXids holds XIDs of all subtransactions that have not yet been 
 * reported in an XLOG_XACT_ASSIGNMENT record. 
 */ 
</span><a name="LN228"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nUnreportedXids</span><span class='Delimiter'>; 
</span><a name="LN229"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>unreportedXids</span><span class='Delimiter'>[</span><a href="../../../include/storage/proc.h.html#LN34"><span class='Ref_to_Const'>PGPROC_MAX_CACHED_SUBXIDS</span></a><span class='Delimiter'>]; 
</span> 
<a name="LN231"></a><span class='Keyword'>static </span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Var'>CurrentTransactionState</span> <span class='Operator'>= &</span><a href="xact.c.html#LN200"><span class='Ref_to_Global_Var'>TopTransactionStateData</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The subtransaction ID and command ID assignment counters are global 
 * to a whole transaction, so we do not keep them in the state stack. 
 */ 
</span><a name="LN237"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Var'>currentSubTransactionId</span><span class='Delimiter'>; 
</span><a name="LN238"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Var'>currentCommandId</span><span class='Delimiter'>; 
</span><a name="LN239"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>currentCommandIdUsed</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * xactStartTimestamp is the value of transaction_timestamp(). 
 * stmtStartTimestamp is the value of statement_timestamp(). 
 * xactStopTimestamp is the time at which we log a commit or abort WAL record. 
 * These do not change as we enter and exit subtransactions, so we don't 
 * keep them inside the TransactionState stack. 
 */ 
</span><a name="LN248"></a><span class='Keyword'>static </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Var'>xactStartTimestamp</span><span class='Delimiter'>; 
</span><a name="LN249"></a><span class='Keyword'>static </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Var'>stmtStartTimestamp</span><span class='Delimiter'>; 
</span><a name="LN250"></a><span class='Keyword'>static </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Var'>xactStopTimestamp</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GID to be used for preparing the current transaction.  This is also 
 * global to a whole transaction, so we don't keep it in the state stack. 
 */ 
</span><a name="LN256"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>prepareGID</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Some commands want to force synchronous commit. 
 */ 
</span><a name="LN261"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>forceSyncCommit</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Private context for transaction-abort work --- we reserve space for this 
 * at startup to ensure that AbortTransaction and AbortSubTransaction can work 
 * when we've run out of memory. 
 */ 
</span><a name="LN268"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>TransactionAbortContext</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of add-on start- and end-of-xact callbacks 
 */ 
</span><a name="LN273"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>XactCallbackItem</span> 
<span class='Delimiter'>{ 
</span><a name="LN275"></a>    <span class='Control'>struct</span> <a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span><a name="LN276"></a>    <a href="../../../include/access/xact.h.html#LN110"><span class='Ref_to_Typedef'>XactCallback</span></a> <span class='Declare_Member'>callback</span><span class='Delimiter'>; 
</span><a name="LN277"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>arg</span><span class='Delimiter'>; 
</span><a name="LN278"></a>} <span class='Declare_Typedef'>XactCallbackItem</span><span class='Delimiter'>; 
</span> 
<a name="LN280"></a><span class='Keyword'>static </span><a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Var'>Xact_callbacks</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of add-on start- and end-of-subxact callbacks 
 */ 
</span><a name="LN285"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>SubXactCallbackItem</span> 
<span class='Delimiter'>{ 
</span><a name="LN287"></a>    <span class='Control'>struct</span> <a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span><a name="LN288"></a>    <a href="../../../include/access/xact.h.html#LN120"><span class='Ref_to_Typedef'>SubXactCallback</span></a> <span class='Declare_Member'>callback</span><span class='Delimiter'>; 
</span><a name="LN289"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>arg</span><span class='Delimiter'>; 
</span><a name="LN290"></a>} <span class='Declare_Typedef'>SubXactCallbackItem</span><span class='Delimiter'>; 
</span> 
<a name="LN292"></a><span class='Keyword'>static </span><a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Var'>SubXact_callbacks</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* local function prototypes */ 
</span><a name="LN296"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AssignTransactionId</span><span class='Parentheses'>(</span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN297"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AbortTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN298"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtAbort_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN299"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtCleanup_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN300"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtAbort_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN301"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtCCI_LocalCache</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN302"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtCommit_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN303"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtStart_Cache</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN304"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtStart_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN305"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtStart_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN306"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CallXactCallbacks</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN98"><span class='Ref_to_Typedef'>XactEvent</span></a> <span class='Declare_Parameter'>event</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN307"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CallSubXactCallbacks</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN112"><span class='Ref_to_Typedef'>SubXactEvent</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, 
</span><a name="LN308"></a>                     <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubid</span><span class='Delimiter'>, 
</span><a name="LN309"></a>                     <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>parentSubid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN310"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CleanupTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN311"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CheckTransactionChain</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>throwError</span><span class='Delimiter'>, 
</span><a name="LN312"></a>                      <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>stmtType</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN313"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CommitTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN314"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Prototype'>RecordTransactionAbort</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isSubXact</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN315"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>StartTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN317"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>StartSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN318"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CommitSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN319"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AbortSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN320"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CleanupSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN321"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PushTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN322"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PopTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN324"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtSubAbort_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN325"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtSubCleanup_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN326"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtSubAbort_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN327"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtSubCommit_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN328"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtSubStart_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN329"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtSubStart_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN331"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ShowTransactionState</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN332"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ShowTransactionStateRec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN333"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>BlockStateAsString</span><span class='Parentheses'>(</span><a href="xact.c.html#LN138"><span class='Ref_to_Enum'>TBlockState</span></a> <span class='Declare_Parameter'>blockState</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN334"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>TransStateAsString</span><span class='Parentheses'>(</span><a href="xact.c.html#LN122"><span class='Ref_to_Enum'>TransState</span></a> <span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *  transaction state accessors 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  IsTransactionState 
 * 
 *  This returns true if we are inside a valid transaction; that is, 
 *  it is safe to initiate database access, take heavyweight locks, etc. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN349"></a><span class='Declare_Function'>IsTransactionState</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN351"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * TRANS_DEFAULT and TRANS_ABORT are obviously unsafe states.  However, we 
     * also reject the startup/shutdown states TRANS_START, TRANS_COMMIT, 
     * TRANS_PREPARE since it might be too soon or too late within those 
     * transition states to do anything interesting.  Hence, the only "valid" 
     * state is TRANS_INPROGRESS. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN351"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  IsAbortedTransactionBlockState 
 * 
 *  This returns true if we are within an aborted transaction block. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN369"></a><span class='Declare_Function'>IsAbortedTransactionBlockState</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN371"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN371"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a> <span class='Operator'>|| 
</span>        <a href="xact.c.html#LN371"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  GetTopTransactionId 
 * 
 * This will return the XID of the main transaction, assigning one if 
 * it's not yet set.  Be careful to call this only inside a valid xact. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN388"></a><span class='Declare_Function'>GetTopTransactionId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN296"><span class='Ref_to_Proto'>AssignTransactionId</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN200"><span class='Ref_to_Global_Var'>TopTransactionStateData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetTopTransactionIdIfAny 
 * 
 * This will return the XID of the main transaction, if one is assigned. 
 * It will return InvalidTransactionId if we are not currently inside a 
 * transaction, or inside a transaction that hasn't yet been assigned an XID. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN403"></a><span class='Declare_Function'>GetTopTransactionIdIfAny</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentTransactionId 
 * 
 * This will return the XID of the current transaction (main or sub 
 * transaction), assigning one if it's not yet set.  Be careful to call this 
 * only inside a valid xact. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN416"></a><span class='Declare_Function'>GetCurrentTransactionId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN418"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN418"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN296"><span class='Ref_to_Proto'>AssignTransactionId</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN418"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN418"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentTransactionIdIfAny 
 * 
 * This will return the XID of the current sub xact, if one is assigned. 
 * It will return InvalidTransactionId if we are not currently inside a 
 * transaction, or inside a transaction that hasn't been assigned an XID yet. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN433"></a><span class='Declare_Function'>GetCurrentTransactionIdIfAny</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  MarkCurrentTransactionIdLoggedIfAny 
 * 
 * Remember that the current xid - if it is assigned - now has been wal logged. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN444"></a><span class='Declare_Function'>MarkCurrentTransactionIdLoggedIfAny</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN188"><span class='Ref_to_Member'>didLogXid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  GetStableLatestTransactionId 
 * 
 * Get the transaction's XID if it has one, else read the next-to-be-assigned 
 * XID.  Once we have a value, return that same value for the remainder of the 
 * current transaction.  This is meant to provide the reference point for the 
 * age(xid) function, but might be useful for other maintenance tasks as well. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN460"></a><span class='Declare_Function'>GetStableLatestTransactionId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN462"></a>    <span class='Keyword'>static </span><a href="../../../include/c.h.html#LN398"><span class='Ref_to_Typedef'>LocalTransactionId</span></a> <span class='Declare_Local'>lxid</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN69"><span class='Ref_to_Const'>InvalidLocalTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN463"></a>    <span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>stablexid</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN462"><span class='Ref_To_Local'>lxid</span></a> <span class='Operator'>!= </span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN462"><span class='Ref_To_Local'>lxid</span></a> <span class='Operator'>= </span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN463"><span class='Ref_To_Local'>stablexid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN332"><span class='Ref_to_Proto'>GetTopTransactionIdIfAny</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN463"><span class='Ref_To_Local'>stablexid</span></a><span class='Parentheses'>))</span> 
            <a href="xact.c.html#LN463"><span class='Ref_To_Local'>stablexid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN178"><span class='Ref_to_Proto'>ReadNewTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN463"><span class='Ref_To_Local'>stablexid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xact.c.html#LN463"><span class='Ref_To_Local'>stablexid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AssignTransactionId 
 * 
 * Assigns a new permanent XID to the given TransactionState. 
 * We do not assign XIDs to transactions until/unless this is called. 
 * Also, any parent TransactionStates that don't yet have XIDs are assigned 
 * one; this maintains the invariant that a child transaction has an XID 
 * following its parent's. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN488"></a><span class='Declare_Function'>AssignTransactionId</span><span class='Parentheses'>(</span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN490"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isSubXact</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN491"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>currentOwner</span><span class='Delimiter'>; 
</span><a name="LN492"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>log_unknown_top</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert that caller didn't screw up */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Workers synchronize transaction state at the beginning of each parallel 
     * operation, so we can't account for new XIDs at this point. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>() </span><span class='Operator'>|| </span><a href="../../../include/access/parallel.h.html#LN51"><span class='Ref_to_Macro'>IsParallelWorker</span></a><span class='Parentheses'>())</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot assign XIDs during a parallel operation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure parent(s) have XIDs, so that a child always has an XID later 
     * than its parent.  Musn't recurse here, or we might get a stack overflow 
     * if we're at the bottom of a huge stack of subtransactions none of which 
     * have XIDs yet. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a> <span class='Operator'>&& !</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN513"></a>        <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span><a name="LN514"></a>        <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parents</span><span class='Delimiter'>; 
</span><a name="LN515"></a>        size_t      <span class='Declare_Local'>parentOffset</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN514"><span class='Ref_To_Local'>parents</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN513"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& !</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN513"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="xact.c.html#LN514"><span class='Ref_To_Local'>parents</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN515"><span class='Ref_To_Local'>parentOffset</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN513"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN513"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN513"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This is technically a recursive call, but the recursion will never 
         * be more than one layer deep. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN515"><span class='Ref_To_Local'>parentOffset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="xact.c.html#LN296"><span class='Ref_to_Proto'>AssignTransactionId</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN514"><span class='Ref_To_Local'>parents</span></a><span class='Delimiter'>[</span><span class='Operator'>--</span><a href="xact.c.html#LN515"><span class='Ref_To_Local'>parentOffset</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN514"><span class='Ref_To_Local'>parents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isSubXact&&!Transacti... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * When wal_level=logical, guarantee that a subtransaction's xid can only 
     * be seen in the WAL stream if its toplevel xid has been logged before. 
     * If necessary we log an xact_assignment record with fewer than 
     * PGPROC_MAX_CACHED_SUBXIDS. Note that it is fine if didLogXid isn't set 
     * for a transaction even though it appears in a WAL record, we just might 
     * superfluously log something. That can happen when an xid is included 
     * somewhere inside a wal record, but not in XLogRecord-&GT;xl_xid, like in 
     * xl_standby_locks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a> <span class='Operator'>&& </span><a href="../../../include/access/xlog.h.html#LN161"><span class='Ref_to_Macro'>XLogLogicalInfoActive</span></a><span class='Parentheses'>() </span><span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="xact.c.html#LN200"><span class='Ref_to_Global_Var'>TopTransactionStateData</span></a><span class='Operator'>.</span><a href="xact.c.html#LN188"><span class='Ref_to_Member'>didLogXid</span></a><span class='Parentheses'>)</span> 
        <a href="xact.c.html#LN492"><span class='Ref_To_Local'>log_unknown_top</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate a new Xid and record it in PG_PROC and pg_subtrans. 
     * 
     * NB: we must make the subtrans entry BEFORE the Xid appears anywhere in 
     * shared storage other than PG_PROC; because if there's no room for it in 
     * PG_PROC, the subtrans entry is needed to ensure that other backends see 
     * the Xid as "running".  See GetNewTransactionId. 
     */ 
</span>    <a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="varsup.c.html#LN46"><span class='Ref_to_Func'>GetNewTransactionId</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/subtrans.h.html#LN16"><span class='Ref_to_Proto'>SubTransSetParent</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If it's a top-level transaction, the predicate locking system needs to 
     * be told about it too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/predicate.h.html#LN49"><span class='Ref_to_Proto'>RegisterPredicateLockingXid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Acquire lock on the transaction XID.  (We assume this cannot block.) We 
     * have to ensure that the lock is assigned to the transaction's own 
     * ResourceOwner. 
     */ 
</span>    <a href="xact.c.html#LN491"><span class='Ref_To_Local'>currentOwner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lmgr.h.html#LN71"><span class='Ref_to_Proto'>XactLockTableInsert</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Ensure CurrentResourceOwner is restored on error */ 
</span>        <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN491"><span class='Ref_To_Local'>currentOwner</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN491"><span class='Ref_To_Local'>currentOwner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Every PGPROC_MAX_CACHED_SUBXIDS assigned transaction ids within each 
     * top-level transaction we issue a WAL record for the assignment. We 
     * include the top-level xid and all the subxids that have not yet been 
     * reported using XLOG_XACT_ASSIGNMENT records. 
     * 
     * This is required to limit the amount of shared memory required in a hot 
     * standby server to keep track of in-progress XIDs. See notes for 
     * RecordKnownAssignedTransactionIds(). 
     * 
     * We don't keep track of the immediate parent of each subxid, only the 
     * top-level transaction that each subxact belongs to. This is correct in 
     * recovery only because aborted subtransactions are separately WAL 
     * logged. 
     * 
     * This is correct even for the case where several levels above us didn't 
     * have an xid assigned as we recursed up to them beforehand. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN490"><span class='Ref_To_Local'>isSubXact</span></a> <span class='Operator'>&& </span><a href="../../../include/access/xlog.h.html#LN158"><span class='Ref_to_Macro'>XLogStandbyInfoActive</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN229"><span class='Ref_to_Global_Var'>unreportedXids</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN488"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ensure this test matches similar one in 
         * RecoverPreparedTransactions() 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/proc.h.html#LN34"><span class='Ref_to_Const'>PGPROC_MAX_CACHED_SUBXIDS</span></a> <span class='Operator'>|| 
</span>            <a href="xact.c.html#LN492"><span class='Ref_To_Local'>log_unknown_top</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN620"></a>            <a href="../../../include/access/xact.h.html#LN180"><span class='Ref_to_Struct'>xl_xact_assignment</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * xtop is always set by now because we recurse up transaction 
             * stack to the highest unassigned xid and then come back down 
             */ 
</span>            <a href="xact.c.html#LN620"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN182"><span class='Ref_to_Member'>xtop</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN331"><span class='Ref_to_Proto'>GetTopTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN620"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN182"><span class='Ref_to_Member'>xtop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN620"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN183"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="xact.c.html#LN620"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN187"><span class='Ref_to_Const'>MinSizeOfXactAssignment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN229"><span class='Ref_to_Global_Var'>unreportedXids</span></a><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_XACT_ID<span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN138"><span class='Ref_to_Const'>XLOG_XACT_ASSIGNMENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* mark top, not current xact as having been logged */ 
</span>            <a href="xact.c.html#LN200"><span class='Ref_to_Global_Var'>TopTransactionStateData</span></a><span class='Operator'>.</span><a href="xact.c.html#LN188"><span class='Ref_to_Member'>didLogXid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nUnreportedXids&GT;=PGPR... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isSubXact&&XLogStandb... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AssignTransactionId &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentSubTransactionId 
 */ 
</span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> 
<a name="LN648"></a><span class='Declare_Function'>GetCurrentSubTransactionId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN650"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xact.c.html#LN650"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  SubTransactionIsActive 
 * 
 * Test if the specified subxact ID is still active.  Note caller is 
 * responsible for checking whether this ID is relevant to the current xact. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN662"></a><span class='Declare_Function'>SubTransactionIsActive</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>subxid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN664"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN664"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN664"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="xact.c.html#LN664"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN664"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN664"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN664"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN662"><span class='Ref_to_Parameter'>subxid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentCommandId 
 * 
 * "used" must be TRUE if the caller intends to use the command ID to mark 
 * inserted/updated/deleted tuples.  FALSE means the ID is being fetched 
 * for read-only purposes (ie, as a snapshot validity cutoff).  See 
 * CommandCounterIncrement() for discussion. 
 */ 
</span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> 
<a name="LN686"></a><span class='Declare_Function'>GetCurrentCommandId</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>used</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* this is global to a transaction, not subtransaction-local */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN686"><span class='Ref_to_Parameter'>used</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Forbid setting currentCommandIdUsed in parallel mode, because we 
         * have no provision for communicating this back to the master.  We 
         * could relax this restriction when currentCommandIdUsed was already 
         * true at the start of the parallel operation. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN239"><span class='Ref_to_Global_Var'>currentCommandIdUsed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentTransactionStartTimestamp 
 */ 
</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> 
<a name="LN707"></a><span class='Declare_Function'>GetCurrentTransactionStartTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN248"><span class='Ref_to_Global_Var'>xactStartTimestamp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentStatementStartTimestamp 
 */ 
</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> 
<a name="LN716"></a><span class='Declare_Function'>GetCurrentStatementStartTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN249"><span class='Ref_to_Global_Var'>stmtStartTimestamp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentTransactionStopTimestamp 
 * 
 * We return current time if the transaction stop time hasn't been set 
 * (which can happen if we decide we don't need to log an XLOG record). 
 */ 
</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> 
<a name="LN728"></a><span class='Declare_Function'>GetCurrentTransactionStopTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  SetCurrentStatementStartTimestamp 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN739"></a><span class='Declare_Function'>SetCurrentStatementStartTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="xact.c.html#LN249"><span class='Ref_to_Global_Var'>stmtStartTimestamp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  SetCurrentTransactionStopTimestamp 
 */ 
</span><span class='Keyword'>static inline void 
</span><a name="LN748"></a><span class='Declare_Function'>SetCurrentTransactionStopTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  GetCurrentTransactionNestLevel 
 * 
 * Note: this will return zero when not inside any transaction, one when 
 * inside a top-level transaction, etc. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN760"></a><span class='Declare_Function'>GetCurrentTransactionNestLevel</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN762"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xact.c.html#LN762"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  TransactionIdIsCurrentTransactionId 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN772"></a><span class='Declare_Function'>TransactionIdIsCurrentTransactionId</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN774"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We always say that BootstrapTransactionId is "not my transaction ID" 
     * even when it is (ie, during bootstrap).  Along with the fact that 
     * transam.c always treats BootstrapTransactionId as already committed, 
     * this causes the tqual.c routines to see all tuples as committed, which 
     * is what we need during bootstrap.  (Bootstrap mode only inserts tuples, 
     * it never updates or deletes them, so all tuples can be presumed good 
     * immediately.) 
     * 
     * Likewise, InvalidTransactionId and FrozenTransactionId are certainly 
     * not my transaction ID, so we can just return "false" immediately for 
     * any non-normal XID. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN772"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In parallel workers, the XIDs we must consider as current are stored in 
     * ParallelCurrentXids rather than the transaction-state stack.  Note that 
     * the XIDs in this array are sorted numerically rather than according to 
     * transactionIdPrecedes order. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN800"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>low</span><span class='Delimiter'>, 
</span><a name="LN801"></a>                    <span class='Declare_Local'>high</span><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN800"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN801"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN800"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>&LT;= </span><a href="xact.c.html#LN801"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN807"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>middle</span><span class='Delimiter'>; 
</span><a name="LN808"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>probe</span><span class='Delimiter'>; 
</span> 
            <a href="xact.c.html#LN807"><span class='Ref_To_Local'>middle</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN800"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="xact.c.html#LN801"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>- </span><a href="xact.c.html#LN800"><span class='Ref_To_Local'>low</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN808"><span class='Ref_To_Local'>probe</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN108"><span class='Ref_to_Global_Var'>ParallelCurrentXids</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN807"><span class='Ref_To_Local'>middle</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN808"><span class='Ref_To_Local'>probe</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN772"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN808"><span class='Ref_To_Local'>probe</span></a> <span class='Operator'>&LT; </span><a href="xact.c.html#LN772"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN800"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN807"><span class='Ref_To_Local'>middle</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="xact.c.html#LN801"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN807"><span class='Ref_To_Local'>middle</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nParallelCurrentXids&GT;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We will return true for the Xid of the current subtransaction, any of 
     * its subcommitted children, any of its parents, or any of their 
     * previously subcommitted children.  However, a transaction being aborted 
     * is no longer "current", even though it may still have an entry on the 
     * state stack. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN831"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>low</span><span class='Delimiter'>, 
</span><a name="LN832"></a>                    <span class='Declare_Local'>high</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* it can't have any child XIDs either */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN772"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* As the childXids array is ordered, we can use binary search */ 
</span>        <a href="xact.c.html#LN831"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN832"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN831"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>&LT;= </span><a href="xact.c.html#LN832"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN845"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>middle</span><span class='Delimiter'>; 
</span><a name="LN846"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>probe</span><span class='Delimiter'>; 
</span> 
            <a href="xact.c.html#LN845"><span class='Ref_To_Local'>middle</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN831"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="xact.c.html#LN832"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>- </span><a href="xact.c.html#LN831"><span class='Ref_To_Local'>low</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN846"><span class='Ref_To_Local'>probe</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN774"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN845"><span class='Ref_To_Local'>middle</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN846"><span class='Ref_To_Local'>probe</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN772"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN846"><span class='Ref_To_Local'>probe</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN772"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
                <a href="xact.c.html#LN831"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN845"><span class='Ref_To_Local'>middle</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="xact.c.html#LN832"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN845"><span class='Ref_To_Local'>middle</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for s=CurrentTransactionS... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TransactionIdIsCurrentTransactionId &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  TransactionStartedDuringRecovery 
 * 
 * Returns true if the current transaction started while recovery was still 
 * in progress. Recovery might have ended since so RecoveryInProgress() might 
 * return false already. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN870"></a><span class='Declare_Function'>TransactionStartedDuringRecovery</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN187"><span class='Ref_to_Member'>startedInRecovery</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  EnterParallelMode 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN879"></a><span class='Declare_Function'>EnterParallelMode</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN881"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN881"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>++</span><a href="xact.c.html#LN881"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  ExitParallelMode 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN892"></a><span class='Declare_Function'>ExitParallelMode</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN894"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN894"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN894"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>|| !</span><a href="../../../include/access/parallel.h.html#LN59"><span class='Ref_to_Proto'>ParallelContextActive</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>--</span><a href="xact.c.html#LN894"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  IsInParallelMode 
 * 
 * Are we in a parallel operation, as either the master or a worker?  Check 
 * this to prohibit operations that change backend-local state expected to 
 * match across all workers.  Mere caches usually don't require such a 
 * restriction.  State modified in a strict push/pop fashion, such as the 
 * active snapshot stack, is often fine. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN912"></a><span class='Declare_Function'>IsInParallelMode</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  CommandCounterIncrement 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN921"></a><span class='Declare_Function'>CommandCounterIncrement</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If the current value of the command counter hasn't been "used" to mark 
     * tuples, we need not increment it, since there's no need to distinguish 
     * a read-only command from others.  This helps postpone command counter 
     * overflow, and keeps no-op CommandCounterIncrement operations cheap. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN239"><span class='Ref_to_Global_Var'>currentCommandIdUsed</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Workers synchronize transaction state at the beginning of each 
         * parallel operation, so we can't account for new commands after that 
         * point. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>() </span><span class='Operator'>|| </span><a href="../../../include/access/parallel.h.html#LN51"><span class='Ref_to_Macro'>IsParallelWorker</span></a><span class='Parentheses'>())</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot start commands during a parallel operation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a> <span class='Operator'>-= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot have more than 2^32-2 commands in a transaction"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="xact.c.html#LN239"><span class='Ref_to_Global_Var'>currentCommandIdUsed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Propagate new command ID into static snapshots */ 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN65"><span class='Ref_to_Proto'>SnapshotSetCommandId</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make any catalog changes done by the just-completed command visible 
         * in the local syscache.  We obviously don't need to do this after a 
         * read-only command.  (But see hacks in inval.c to make real sure we 
         * don't think a command that queued inval messages was read-only.) 
         */ 
</span>        <a href="xact.c.html#LN301"><span class='Ref_to_Proto'>AtCCI_LocalCache</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if currentCommandIdUsed &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CommandCounterIncrement &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ForceSyncCommit 
 * 
 * Interface routine to allow commands to force a synchronous commit of the 
 * current top-level transaction 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN969"></a><span class='Declare_Function'>ForceSyncCommit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="xact.c.html#LN261"><span class='Ref_to_Global_Var'>forceSyncCommit</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      StartTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  AtStart_Cache 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN984"></a><span class='Declare_Function'>AtStart_Cache</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  AtStart_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN993"></a><span class='Declare_Function'>AtStart_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN995"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is the first time through, create a private context for 
     * AbortTransaction to work in.  By reserving some space now, we can 
     * insulate AbortTransaction from out-of-memory scenarios.  Like 
     * ErrorContext, we set it up with slow growth rate and a nonzero minimum 
     * size, so that space will be reserved immediately. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"TransactionAbortContext"</span><span class='Delimiter'>, 
</span>                                  <span class='Number'>32</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Delimiter'>, 
</span>                                  <span class='Number'>32</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Delimiter'>, 
</span>                                  <span class='Number'>32</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We shouldn't have a transaction context already. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a toplevel context for the transaction. 
     */ 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"TopTransactionContext"</span><span class='Delimiter'>, 
</span>                              <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In a top-level transaction, CurTransactionContext is the same as 
     * TopTransactionContext. 
     */ 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN995"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make the CurTransactionContext active. */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtStart_Memory &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  AtStart_ResourceOwner 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1040"></a><span class='Declare_Function'>AtStart_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1042"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We shouldn't have a transaction resource owner already. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a toplevel resource owner for the transaction. 
     */ 
</span>    <a href="xact.c.html#LN1042"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= </span><a href="../../../include/utils/resowner.h.html#LN66"><span class='Ref_to_Proto'>ResourceOwnerCreate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"TopTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1042"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1042"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1042"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      StartSubTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtSubStart_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1068"></a><span class='Declare_Function'>AtSubStart_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1070"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a CurTransactionContext, which will be used to hold data that 
     * survives subtransaction commit but disappears on subtransaction abort. 
     * We make it a child of the immediate parent's CurTransactionContext. 
     */ 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Delimiter'>, 
</span>                                                  <span class='String'>"CurTransactionContext"</span><span class='Delimiter'>, 
</span>                                                  <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1070"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make the CurTransactionContext active. */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtSubStart_Memory &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtSubStart_ResourceOwner 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1092"></a><span class='Declare_Function'>AtSubStart_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1094"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1094"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a resource owner for the subtransaction.  We make it a child of 
     * the immediate parent's resource owner. 
     */ 
</span>    <a href="xact.c.html#LN1094"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/resowner.h.html#LN66"><span class='Ref_to_Proto'>ResourceOwnerCreate</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1094"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                            <span class='String'>"SubTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1094"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1094"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      CommitTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  RecordTransactionCommit 
 * 
 * Returns latest XID among xact and its children, or InvalidTransactionId 
 * if the xact has no XID.  (We compute that here just because it's easier.) 
 * 
 * If you change this function, see RecordTransactionCommitPrepared also. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN1124"></a><span class='Declare_Function'>RecordTransactionCommit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1126"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN332"><span class='Ref_to_Proto'>GetTopTransactionIdIfAny</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1127"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>markXidCommitted</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1126"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1128"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latestXid</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN1129"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nrels</span><span class='Delimiter'>; 
</span><a name="LN1130"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rels</span><span class='Delimiter'>; 
</span><a name="LN1131"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nchildren</span><span class='Delimiter'>; 
</span><a name="LN1132"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>children</span><span class='Delimiter'>; 
</span><a name="LN1133"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nmsgs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1134"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Local'>invalMessages</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1135"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>RelcacheInitFileInval</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1136"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>wrote_xlog</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get data needed for commit record */ 
</span>    <a href="xact.c.html#LN1129"><span class='Ref_To_Local'>nrels</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/storage.h.html#LN30"><span class='Ref_to_Proto'>smgrGetPendingDeletes</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xact.c.html#LN1130"><span class='Ref_To_Local'>rels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN379"><span class='Ref_to_Proto'>xactGetCommittedChildren</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN1132"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN158"><span class='Ref_to_Macro'>XLogStandbyInfoActive</span></a><span class='Parentheses'>())</span> 
        <a href="xact.c.html#LN1133"><span class='Ref_To_Local'>nmsgs</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN145"><span class='Ref_to_Proto'>xactGetCommittedInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN1134"><span class='Ref_To_Local'>invalMessages</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="xact.c.html#LN1135"><span class='Ref_To_Local'>RelcacheInitFileInval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1136"><span class='Ref_To_Local'>wrote_xlog</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we haven't been assigned an XID yet, we neither can, nor do we want 
     * to write a COMMIT record. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1127"><span class='Ref_To_Local'>markXidCommitted</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We expect that every smgrscheduleunlink is followed by a catalog 
         * update, and hence XID assignment, so we shouldn't get here with any 
         * pending deletes.  Use a real test not just an Assert to check this, 
         * since it's a bit fragile. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1129"><span class='Ref_To_Local'>nrels</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot commit a transaction that deleted files but has no xid"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't have child XIDs either; AssignTransactionId enforces this */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Transactions without an assigned xid can contain invalidation 
         * messages (e.g. explicit relcache invalidations or catcache 
         * invalidations for inplace updates); standbys need to process those. 
         * We can't emit a commit record without an xid, and we don't want to 
         * force assigning an xid, because that'd be problematic for e.g. 
         * vacuum.  Hence we emit a bespoke record for the invalidations. We 
         * don't want to use that in case a commit record is emitted, so they 
         * happen synchronously with commits (besides not wanting to emit more 
         * WAL recoreds). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1133"><span class='Ref_To_Local'>nmsgs</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/standby.h.html#LN87"><span class='Ref_to_Proto'>LogStandbyInvalidations</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1133"><span class='Ref_To_Local'>nmsgs</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1134"><span class='Ref_To_Local'>invalMessages</span></a><span class='Delimiter'>, 
</span>                                    <a href="xact.c.html#LN1135"><span class='Ref_To_Local'>RelcacheInitFileInval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN1136"><span class='Ref_To_Local'>wrote_xlog</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* not strictly necessary */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we didn't create XLOG entries, we're done here; otherwise we 
         * should trigger flushing those entries the same as a commit record 
         * would.  This will primarily happen for HOT pruning and the like; we 
         * want these to be flushed to disk in due time. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1136"><span class='Ref_To_Local'>wrote_xlog</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xact.c.html#LN1351"><span class='Ref_to_Label'>cleanup</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !markXidCommitted &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1193"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>replorigin</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Are we using the replication origins feature?  Or, in other words, 
         * are we replaying remote actions? 
         */ 
</span>        <a href="xact.c.html#LN1193"><span class='Ref_To_Local'>replorigin</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a> <span class='Operator'>!= </span><a href="../../../include/replication/origin.h.html#LN33"><span class='Ref_to_Const'>InvalidRepOriginId</span></a> <span class='Operator'>&& 
</span>                      <a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a> <span class='Operator'>!= </span><a href="../../../include/replication/origin.h.html#LN34"><span class='Ref_to_Const'>DoNotReplicateId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Begin commit critical section and insert the commit XLOG record. 
         */ 
</span>        <span class='Comment_Multi_Line'>/* Tell bufmgr and smgr to prepare for commit */ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN223"><span class='Ref_to_Proto'>BufmgrCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Mark ourselves as within our "commit critical section".  This 
         * forces any concurrent checkpoint to wait until we've updated 
         * pg_xact.  Without this, it is possible for the checkpoint to set 
         * REDO after the XLOG record but fail to flush the pg_xact update to 
         * disk, leading to loss of the transaction commit if the system 
         * crashes a little later. 
         * 
         * Note: we could, but don't bother to, set this flag in 
         * RecordTransactionAbort.  That's because loss of a transaction abort 
         * is noncritical; the presumption would be that it aborted, anyway. 
         * 
         * It's safe to change the delayChkpt flag of our own backend without 
         * holding the ProcArrayLock, since we're the only one modifying it. 
         * This makes checkpoint's determination of which xacts are delayChkpt 
         * a bit fuzzy, but it doesn't matter. 
         */ 
</span>        <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN747"><span class='Ref_to_Func'>SetCurrentTransactionStopTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xact.h.html#LN381"><span class='Ref_to_Proto'>XactLogCommitRecord</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a><span class='Delimiter'>, 
</span>                            <a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1132"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1129"><span class='Ref_To_Local'>nrels</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1130"><span class='Ref_To_Local'>rels</span></a><span class='Delimiter'>, 
</span>                            <a href="xact.c.html#LN1133"><span class='Ref_To_Local'>nmsgs</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1134"><span class='Ref_To_Local'>invalMessages</span></a><span class='Delimiter'>, 
</span>                            <a href="xact.c.html#LN1135"><span class='Ref_To_Local'>RelcacheInitFileInval</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN261"><span class='Ref_to_Global_Var'>forceSyncCommit</span></a><span class='Delimiter'>, 
</span>                            <a href="xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a> <span class='Comment_Multi_Line'>/* plain commit */ </span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1193"><span class='Ref_To_Local'>replorigin</span></a><span class='Parentheses'>) 
</span>            <span class='Comment_Multi_Line'>/* Move LSNs forward for this replication origin */ 
</span>            <a href="../../../include/replication/origin.h.html#LN54"><span class='Ref_to_Proto'>replorigin_session_advance</span></a><span class='Parentheses'>(</span><a href="../../replication/logical/origin.c.html#LN150"><span class='Ref_to_Global_Var'>replorigin_session_origin_lsn</span></a><span class='Delimiter'>, 
</span>                                       <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Record commit timestamp.  The value comes from plain commit 
         * timestamp if there's no replication origin; otherwise, the 
         * timestamp was already set in replorigin_session_origin_timestamp by 
         * replication. 
         * 
         * We don't need to WAL-log anything here, as the commit record 
         * written above already contains the data. 
         */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1193"><span class='Ref_To_Local'>replorigin</span></a> <span class='Operator'>|| </span><a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/commit_ts.h.html#LN24"><span class='Ref_to_Proto'>TransactionTreeSetCommitTsData</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1126"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1132"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Check if we want to commit asynchronously.  We can allow the XLOG flush 
     * to happen asynchronously if synchronous_commit=off, or if the current 
     * transaction has not performed any WAL-logged operation or didn't assign 
     * an xid.  The transaction can end up not writing any WAL, even if it has 
     * an xid, if it only wrote to temporary and/or unlogged tables.  It can 
     * end up having written WAL without an xid if it did HOT pruning.  In 
     * case of a crash, the loss of such a transaction will be irrelevant; 
     * temp tables will be lost anyway, unlogged tables will be truncated and 
     * HOT pruning will be done again later. (Given the foregoing, you might 
     * think that it would be unnecessary to emit the XLOG record at all in 
     * this case, but we don't currently try to do that.  It would certainly 
     * cause problems at least in Hot Standby mode, where the 
     * KnownAssignedXids machinery requires tracking every XID assignment.  It 
     * might be OK to skip it only when wal_level &LT; replica, but for now we 
     * don't.) 
     * 
     * However, if we're doing cleanup of any non-temp rels or committing any 
     * command that wanted to force sync commit, then we must flush XLOG 
     * immediately.  (We must not allow asynchronous commit if there are any 
     * non-temp tables to be deleted, because we might delete the files before 
     * the COMMIT record is flushed to disk.  We do allow asynchronous commit 
     * if all to-be-deleted tables are temporary though, since they are lost 
     * anyway if we crash.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xact.c.html#LN1136"><span class='Ref_To_Local'>wrote_xlog</span></a> <span class='Operator'>&& </span><a href="xact.c.html#LN1127"><span class='Ref_To_Local'>markXidCommitted</span></a> <span class='Operator'>&& 
</span>         <a href="xact.c.html#LN81"><span class='Ref_to_Global_Var'>synchronous_commit</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/xact.h.html#LN58"><span class='Ref_to_EnumConst'>SYNCHRONOUS_COMMIT_OFF</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="xact.c.html#LN261"><span class='Ref_to_Global_Var'>forceSyncCommit</span></a> <span class='Operator'>|| </span><a href="xact.c.html#LN1129"><span class='Ref_To_Local'>nrels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now we may update the CLOG, if we wrote a COMMIT record above 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1127"><span class='Ref_To_Local'>markXidCommitted</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/transam.h.html#LN165"><span class='Ref_to_Proto'>TransactionIdCommitTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1126"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1132"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Asynchronous commit case: 
         * 
         * This enables possible committed transaction loss in the case of a 
         * postmaster crash because WAL buffers are left unwritten. Ideally we 
         * could issue the WAL write without the fsync, but some 
         * wal_sync_methods do not allow separate write/fsync. 
         * 
         * Report the latest async commit LSN, so that the WAL writer knows to 
         * flush this commit. 
         */ 
</span>        <a href="../../../include/access/xlog.h.html#LN233"><span class='Ref_to_Proto'>XLogSetAsyncXactLSN</span></a><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We must not immediately update the CLOG, since we didn't flush the 
         * XLOG. Instead, we store the LSN up to which the XLOG must be 
         * flushed before the CLOG may be updated. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1127"><span class='Ref_To_Local'>markXidCommitted</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/transam.h.html#LN166"><span class='Ref_to_Proto'>TransactionIdAsyncCommitTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1126"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1132"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, </span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we entered a commit critical section, leave it now, and let 
     * checkpoints proceed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1127"><span class='Ref_To_Local'>markXidCommitted</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN219"><span class='Ref_to_Member'>delayChkpt</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Compute latestXid while we have the child XIDs handy */ 
</span>    <a href="xact.c.html#LN1128"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN172"><span class='Ref_to_Proto'>TransactionIdLatest</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1126"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1131"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1132"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Wait for synchronous replication, if required. Similar to the decision 
     * above about using committing asynchronously we only want to wait if 
     * this backend assigned an xid and wrote WAL.  No need to wait if an xid 
     * was assigned due to temporary/unlogged tables or due to HOT pruning. 
     * 
     * Note that at this stage we have marked clog, but still show as running 
     * in the procarray and continue to hold locks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1136"><span class='Ref_To_Local'>wrote_xlog</span></a> <span class='Operator'>&& </span><a href="xact.c.html#LN1127"><span class='Ref_To_Local'>markXidCommitted</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/replication/syncrep.h.html#LN66"><span class='Ref_to_Proto'>SyncRepWaitForLSN</span></a><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* remember end of last commit record */ 
</span>    <a href="xlog.c.html#LN337"><span class='Ref_to_Global_Var'>XactLastCommitEnd</span></a> <span class='Operator'>= </span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset XactLastRecEnd until the next transaction writes something */ 
</span>    <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1351"></a><span class='Label'>cleanup</span><span class='Operator'>: 
</span>    <span class='Comment_Multi_Line'>/* Clean up local data */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1130"><span class='Ref_To_Local'>rels</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1130"><span class='Ref_To_Local'>rels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xact.c.html#LN1128"><span class='Ref_To_Local'>latestXid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecordTransactionCommit &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  AtCCI_LocalCache 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1364"></a><span class='Declare_Function'>AtCCI_LocalCache</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Make any pending relation map changes visible.  We must do this before 
     * processing local sinval messages, so that the map changes will get 
     * reflected into the relcache when relcache invals are processed. 
     */ 
</span>    <a href="../../../include/utils/relmapper.h.html#LN49"><span class='Ref_to_Proto'>AtCCI_RelationMap</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make catalog changes visible to me for the next command. 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN35"><span class='Ref_to_Proto'>CommandEndInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  AtCommit_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1383"></a><span class='Declare_Function'>AtCommit_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Now that we're "out" of a transaction, have the system allocate things 
     * in the top memory context instead of per-transaction contexts. 
     */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release all transaction-local memory. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      CommitSubTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtSubCommit_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1410"></a><span class='Declare_Function'>AtSubCommit_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1412"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1412"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return to parent transaction level's memory context. */ 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1412"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ordinarily we cannot throw away the child's CurTransactionContext, 
     * since the data it contains will be needed at upper commit.  However, if 
     * there isn't actually anything in it, we can throw it away.  This avoids 
     * a small memory leak in the common case of "trivial" subxacts. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/memutils.h.html#LN82"><span class='Ref_to_Proto'>MemoryContextIsEmpty</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1412"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1412"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN1412"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AtSubCommit_Memory &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtSubCommit_childXids 
 * 
 * Pass my own XID and my child XIDs up to my parent as committed children. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1439"></a><span class='Declare_Function'>AtSubCommit_childXids</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1441"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN1442"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>new_nChildXids</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The parent childXids array will need to hold my XID and all my 
     * childXids, in addition to the XIDs already there. 
     */ 
</span>    <a href="xact.c.html#LN1442"><span class='Ref_To_Local'>new_nChildXids</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>+ </span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate or enlarge the parent array if necessary */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>&LT; </span><a href="xact.c.html#LN1442"><span class='Ref_To_Local'>new_nChildXids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1455"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>new_maxChildXids</span><span class='Delimiter'>; 
</span><a name="LN1456"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_childXids</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make it 2x what's needed right now, to avoid having to enlarge it 
         * repeatedly. But we can't go above MaxAllocSize.  (The latter limit 
         * is what ensures that we don't need to worry about integer overflow 
         * here or in the calculation of new_nChildXids.) 
         */ 
</span>        <a href="xact.c.html#LN1455"><span class='Ref_To_Local'>new_maxChildXids</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1442"><span class='Ref_To_Local'>new_nChildXids</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                               <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1455"><span class='Ref_To_Local'>new_maxChildXids</span></a> <span class='Operator'>&LT; </span><a href="xact.c.html#LN1442"><span class='Ref_To_Local'>new_nChildXids</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"maximum number of committed subtransactions (%d) exceeded"</span><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We keep the child-XID arrays in TopTransactionContext; this avoids 
         * setting up child-transaction contexts for what might be just a few 
         * bytes of grandchild XIDs. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="xact.c.html#LN1456"><span class='Ref_To_Local'>new_childXids</span></a> <span class='Operator'>= 
</span>                <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                                   <a href="xact.c.html#LN1455"><span class='Ref_To_Local'>new_maxChildXids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="xact.c.html#LN1456"><span class='Ref_To_Local'>new_childXids</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>, 
</span>                                   <a href="xact.c.html#LN1455"><span class='Ref_To_Local'>new_maxChildXids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1456"><span class='Ref_To_Local'>new_childXids</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1455"><span class='Ref_To_Local'>new_maxChildXids</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if s-&GT;parent-&GT;maxChildXi... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Copy all my XIDs to parent's array. 
     * 
     * Note: We rely on the fact that the XID of a child always follows that 
     * of its parent.  By copying the XID of this subtransaction before the 
     * XIDs of its children, we ensure that the array stays ordered. Likewise, 
     * all XIDs already in the array belong to subtransactions started and 
     * subcommitted before us, so their XIDs must precede ours. 
     */ 
</span>    <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>               <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>, 
</span>               <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1442"><span class='Ref_To_Local'>new_nChildXids</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release child's array to avoid leakage */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We must reset these to avoid double-free if fail later in commit */ 
</span>    <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1441"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtSubCommit_childXids &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      AbortTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  RecordTransactionAbort 
 * 
 * Returns latest XID among xact and its children, or InvalidTransactionId 
 * if the xact has no XID.  (We compute that here just because it's easier.) 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN1529"></a><span class='Declare_Function'>RecordTransactionAbort</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isSubXact</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1531"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN334"><span class='Ref_to_Proto'>GetCurrentTransactionIdIfAny</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1532"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latestXid</span><span class='Delimiter'>; 
</span><a name="LN1533"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nrels</span><span class='Delimiter'>; 
</span><a name="LN1534"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rels</span><span class='Delimiter'>; 
</span><a name="LN1535"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nchildren</span><span class='Delimiter'>; 
</span><a name="LN1536"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>children</span><span class='Delimiter'>; 
</span><a name="LN1537"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>xact_time</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we haven't been assigned an XID, nobody will care whether we aborted 
     * or not.  Hence, we're done in that case.  It does not matter if we have 
     * rels to delete (note that this routine is not responsible for actually 
     * deleting 'em).  We cannot have any child XIDs, either. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1531"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Reset XactLastRecEnd until the next transaction writes something */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1529"><span class='Ref_to_Parameter'>isSubXact</span></a><span class='Parentheses'>) 
</span>            <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have a valid XID, so we should write an ABORT record for it. 
     * 
     * We do not flush XLOG to disk here, since the default assumption after a 
     * crash would be that we aborted, anyway.  For the same reason, we don't 
     * need to worry about interlocking against checkpoint start. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that we haven't aborted halfway through RecordTransactionCommit. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1531"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"cannot abort transaction %u, it was already committed"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN1531"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch the data we need for the abort record */ 
</span>    <a href="xact.c.html#LN1533"><span class='Ref_To_Local'>nrels</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/storage.h.html#LN30"><span class='Ref_to_Proto'>smgrGetPendingDeletes</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xact.c.html#LN1534"><span class='Ref_To_Local'>rels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1535"><span class='Ref_To_Local'>nchildren</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN379"><span class='Ref_to_Proto'>xactGetCommittedChildren</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN1536"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XXX do we really need a critical section here? */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Write the ABORT record */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1529"><span class='Ref_to_Parameter'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN1537"><span class='Ref_To_Local'>xact_time</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN747"><span class='Ref_to_Func'>SetCurrentTransactionStopTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN1537"><span class='Ref_To_Local'>xact_time</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/access/xact.h.html#LN389"><span class='Ref_to_Proto'>XactLogAbortRecord</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1537"><span class='Ref_To_Local'>xact_time</span></a><span class='Delimiter'>, 
</span>                       <a href="xact.c.html#LN1535"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1536"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, 
</span>                       <a href="xact.c.html#LN1533"><span class='Ref_To_Local'>nrels</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1534"><span class='Ref_To_Local'>rels</span></a><span class='Delimiter'>, 
</span>                       <a href="xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report the latest async abort LSN, so that the WAL writer knows to 
     * flush this abort. There's nothing to be gained by delaying this, since 
     * WALWriter may as well do this when it can. This is important with 
     * streaming replication because if we don't flush WAL regularly we will 
     * find that large aborts leave us with a long backlog for when commits 
     * occur after the abort, increasing our window of data loss should 
     * problems occur at that point. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1529"><span class='Ref_to_Parameter'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xlog.h.html#LN233"><span class='Ref_to_Proto'>XLogSetAsyncXactLSN</span></a><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the transaction aborted in clog.  This is not absolutely necessary 
     * but we may as well do it while we are here; also, in the subxact case 
     * it is helpful because XactLockTableWait makes use of it to avoid 
     * waiting for already-aborted subtransactions.  It is OK to do it without 
     * having flushed the ABORT record to disk, because in event of a crash 
     * we'd be assumed to have aborted anyway. 
     */ 
</span>    <a href="../../../include/access/transam.h.html#LN167"><span class='Ref_to_Proto'>TransactionIdAbortTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1531"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1535"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1536"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compute latestXid while we have the child XIDs handy */ 
</span>    <a href="xact.c.html#LN1532"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN172"><span class='Ref_to_Proto'>TransactionIdLatest</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1531"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1535"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1536"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're aborting a subtransaction, we can immediately remove failed 
     * XIDs from PGPROC's cache of running child XIDs.  We do that here for 
     * subxacts, because we already have the child XID array at hand.  For 
     * main xacts, the equivalent happens just after this function returns. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1529"><span class='Ref_to_Parameter'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/procarray.h.html#LN117"><span class='Ref_to_Proto'>XidCacheRemoveRunningXids</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1531"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1535"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1536"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1532"><span class='Ref_To_Local'>latestXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset XactLastRecEnd until the next transaction writes something */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1529"><span class='Ref_to_Parameter'>isSubXact</span></a><span class='Parentheses'>) 
</span>        <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And clean up local data */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1534"><span class='Ref_To_Local'>rels</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1534"><span class='Ref_To_Local'>rels</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xact.c.html#LN1532"><span class='Ref_To_Local'>latestXid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecordTransactionAbort &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  AtAbort_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1640"></a><span class='Declare_Function'>AtAbort_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Switch into TransactionAbortContext, which should have some free space 
     * even if nothing else does.  We'll work in this context until we've 
     * finished cleaning up. 
     * 
     * It is barely possible to get here when we've not been able to create 
     * TransactionAbortContext yet; if so use TopMemoryContext. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtSubAbort_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1660"></a><span class='Declare_Function'>AtSubAbort_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  AtAbort_ResourceOwner 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1672"></a><span class='Declare_Function'>AtAbort_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Make sure we have a valid ResourceOwner, if possible (else it will be 
     * NULL, which is OK) 
     */ 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtSubAbort_ResourceOwner 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1685"></a><span class='Declare_Function'>AtSubAbort_ResourceOwner</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1687"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we have a valid ResourceOwner */ 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1687"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtSubAbort_childXids 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1698"></a><span class='Declare_Function'>AtSubAbort_childXids</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1700"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We keep the child-XID arrays in TopTransactionContext (see 
     * AtSubCommit_childXids).  This means we'd better free the array 
     * explicitly at abort to avoid leakage. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1700"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1700"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1700"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1700"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1700"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We could prune the unreportedXids array here. But we don't bother. That 
     * would potentially reduce number of XLOG_XACT_ASSIGNMENT records but it 
     * would likely introduce more CPU time into the more common paths, so we 
     * choose not to do that. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtSubAbort_childXids &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      CleanupTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  AtCleanup_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1730"></a><span class='Declare_Function'>AtCleanup_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we're "out" of a transaction, have the system allocate things 
     * in the top memory context instead of per-transaction contexts. 
     */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear the special abort context for next time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release all transaction-local memory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtCleanup_Memory &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      CleanupSubTransaction stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtSubCleanup_Memory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1766"></a><span class='Declare_Function'>AtSubCleanup_Memory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1768"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1768"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we're not in an about-to-be-deleted context */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1768"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1768"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear the special abort context for next time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN268"><span class='Ref_to_Global_Var'>TransactionAbortContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete the subxact local memory contexts. Its CurTransactionContext can 
     * go too (note this also kills CurTransactionContexts from any children 
     * of the subxact). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1768"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1768"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1768"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtSubCleanup_Memory &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      interface routines 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  StartTransaction 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1801"></a><span class='Declare_Function'>StartTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1803"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN1804"></a>    <a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Local'>vxid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Let's just make sure the state stack is empty 
     */ 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= &</span><a href="xact.c.html#LN200"><span class='Ref_to_Global_Var'>TopTransactionStateData</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a> <span class='Operator'>== </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * check the current transaction state 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"StartTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * set the current transaction state information appropriately during 
     * start processing 
     */ 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN125"><span class='Ref_to_EnumConst'>TRANS_START</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* until assigned */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure we've reset xact state variables 
     * 
     * If recovery is still in progress, mark this transaction as read-only. 
     * We have lower level defences in XLogInsert and elsewhere to stop us 
     * from modifying data during recovery, but this gives the normal 
     * indication to the user that the transaction is read-only. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN187"><span class='Ref_to_Member'>startedInRecovery</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN187"><span class='Ref_to_Member'>startedInRecovery</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN75"><span class='Ref_to_Global_Var'>DefaultXactReadOnly</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="xact.c.html#LN79"><span class='Ref_to_Global_Var'>XactDeferrable</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN78"><span class='Ref_to_Global_Var'>DefaultXactDeferrable</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN73"><span class='Ref_to_Global_Var'>XactIsoLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN72"><span class='Ref_to_Global_Var'>DefaultXactIsoLevel</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN261"><span class='Ref_to_Global_Var'>forceSyncCommit</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * reinitialize within-transaction counters 
     */ 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN403"><span class='Ref_to_Const'>TopSubTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN237"><span class='Ref_to_Global_Var'>currentSubTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN403"><span class='Ref_to_Const'>TopSubTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN239"><span class='Ref_to_Global_Var'>currentCommandIdUsed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize reported xid accounting 
     */ 
</span>    <a href="xact.c.html#LN228"><span class='Ref_to_Global_Var'>nUnreportedXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN188"><span class='Ref_to_Member'>didLogXid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * must initialize resource-management stuff first 
     */ 
</span>    <a href="xact.c.html#LN304"><span class='Ref_to_Proto'>AtStart_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN305"><span class='Ref_to_Proto'>AtStart_ResourceOwner</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Assign a new LocalTransactionId, and combine it with the backendId to 
     * form a virtual transaction id. 
     */ 
</span>    <a href="xact.c.html#LN1804"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1804"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinvaladt.h.html#LN40"><span class='Ref_to_Proto'>GetNextLocalTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lock the virtual transaction id before we announce it in the proc array 
     */ 
</span>    <a href="../../../include/storage/lock.h.html#LN584"><span class='Ref_to_Proto'>VirtualXactLockTableInsert</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1804"><span class='Ref_To_Local'>vxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advertise it in the proc array.  We assume assignment of 
     * LocalTransactionID is atomic, and the backendId should be set already. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN1804"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1804"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_TRANSACTION_START<span class='Parentheses'>(</span><a href="xact.c.html#LN1804"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * set transaction_timestamp() (a/k/a now()).  We want this to be the same 
     * as the first command's statement_timestamp(), so don't do a fresh 
     * GetCurrentTimestamp() call (which'd be expensive anyway).  Also, mark 
     * xactStopTimestamp as unset. 
     */ 
</span>    <a href="xact.c.html#LN248"><span class='Ref_to_Global_Var'>xactStartTimestamp</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN249"><span class='Ref_to_Global_Var'>stmtStartTimestamp</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN250"><span class='Ref_to_Global_Var'>xactStopTimestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1171"><span class='Ref_to_Proto'>pgstat_report_xact_timestamp</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN248"><span class='Ref_to_Global_Var'>xactStartTimestamp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize current transaction state fields 
     * 
     * note: prevXactReadOnly is not used at the outermost level 
     */ 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN312"><span class='Ref_to_Proto'>GetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN184"><span class='Ref_to_Member'>prevUser</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN185"><span class='Ref_to_Member'>prevSecContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* SecurityRestrictionContext should never be set outside a transaction */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN185"><span class='Ref_to_Member'>prevSecContext</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize other subsystems for new transaction 
     */ 
</span>    <a href="../../../include/utils/guc.h.html#LN353"><span class='Ref_to_Proto'>AtStart_GUC</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN303"><span class='Ref_to_Proto'>AtStart_Cache</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/trigger.h.html#LN186"><span class='Ref_to_Proto'>AfterTriggerBeginXact</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * done with start processing, set current transaction state to "in 
     * progress" 
     */ 
</span>    <a href="xact.c.html#LN1803"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"StartTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartTransaction &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  CommitTransaction 
 * 
 * NB: if you change this routine, better look at PrepareTransaction too! 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1939"></a><span class='Declare_Function'>CommitTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1941"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN1942"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latestXid</span><span class='Delimiter'>; 
</span><a name="LN1943"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_parallel_worker</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN1943"><span class='Ref_To_Local'>is_parallel_worker</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Enforce parallel mode restrictions during parallel worker commit. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1943"><span class='Ref_To_Local'>is_parallel_worker</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xact.h.html#LN403"><span class='Ref_to_Proto'>EnterParallelMode</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"CommitTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * check the current transaction state 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"CommitTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do pre-commit processing that involves calling user-defined code, such 
     * as triggers.  Since closing cursors could queue trigger actions, 
     * triggers could open cursors, etc, we have to keep looping until there's 
     * nothing left to do. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Fire all currently pending deferred triggers. 
         */ 
</span>        <a href="../../../include/commands/trigger.h.html#LN189"><span class='Ref_to_Proto'>AfterTriggerFireDeferred</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Close open portals (converting holdable ones into static portals). 
         * If there weren't any, we are done ... otherwise loop back to check 
         * if they queued deferred triggers.  Lather, rinse, repeat. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/portal.h.html#LN209"><span class='Ref_to_Proto'>PreCommit_Portals</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="xact.c.html#LN306"><span class='Ref_to_Proto'>CallXactCallbacks</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1943"><span class='Ref_To_Local'>is_parallel_worker</span></a> <span class='Operator'>? </span><a href="../../../include/access/xact.h.html#LN106"><span class='Ref_to_EnumConst'>XACT_EVENT_PARALLEL_PRE_COMMIT</span></a> 
                      <span class='Operator'>: </span><a href="../../../include/access/xact.h.html#LN105"><span class='Ref_to_EnumConst'>XACT_EVENT_PRE_COMMIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The remaining actions cannot call any user-defined code, so it's safe 
     * to start shutting down within-transaction services.  But note that most 
     * of this stuff could still throw an error, which would switch us into 
     * the transaction-abort path. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* If we might have parallel workers, clean them up now. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/access/parallel.h.html#LN63"><span class='Ref_to_Proto'>AtEOXact_Parallel</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Shut down the deferred-trigger manager */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN190"><span class='Ref_to_Proto'>AfterTriggerEndXact</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Let ON COMMIT management do its thing (must happen after closing 
     * cursors, to avoid dangling-reference problems) 
     */ 
</span>    <a href="../../../include/commands/tablecmds.h.html#LN78"><span class='Ref_to_Proto'>PreCommit_on_commit_actions</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* close large objects before lower-level cleanup */ 
</span>    <a href="../../../include/libpq/be-fsstubs.h.html#LN32"><span class='Ref_to_Proto'>AtEOXact_LargeObject</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark serializable transaction as complete for predicate locking 
     * purposes.  This should be done as late as we can put it and still allow 
     * errors to be raised for failure patterns found at commit. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN65"><span class='Ref_to_Proto'>PreCommit_CheckForSerializationFailure</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insert notifications sent by NOTIFY commands into the queue.  This 
     * should be late in the pre-commit sequence to minimize time spent 
     * holding the notify-insertion lock. 
     */ 
</span>    <a href="../../../include/commands/async.h.html#LN41"><span class='Ref_to_Proto'>PreCommit_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prevent cancel/die interrupt while cleaning up */ 
</span>    <a href="../../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Commit updates to the relation map --- do this as late as possible */ 
</span>    <a href="../../../include/utils/relmapper.h.html#LN50"><span class='Ref_to_Proto'>AtEOXact_RelationMap</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * set the current transaction state information appropriately during 
     * commit processing 
     */ 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN127"><span class='Ref_to_EnumConst'>TRANS_COMMIT</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN1943"><span class='Ref_To_Local'>is_parallel_worker</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We need to mark our XIDs as committed in pg_xact.  This is where we 
         * durably commit. 
         */ 
</span>        <a href="xact.c.html#LN1942"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN1123"><span class='Ref_to_Func'>RecordTransactionCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We must not mark our XID committed; the parallel master is 
         * responsible for that. 
         */ 
</span>        <a href="xact.c.html#LN1942"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make sure the master will know about any WAL we wrote before it 
         * commits. 
         */ 
</span>        <a href="../../../include/access/parallel.h.html#LN65"><span class='Ref_to_Proto'>ParallelWorkerReportLastRecEnd</span></a><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    TRACE_POSTGRESQL_TRANSACTION_COMMIT<span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Let others know about no transaction in progress by me. Note that this 
     * must be done _before_ releasing locks we hold and _after_ 
     * RecordTransactionCommit. 
     */ 
</span>    <a href="../../../include/storage/procarray.h.html#LN63"><span class='Ref_to_Proto'>ProcArrayEndTransaction</span></a><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN1942"><span class='Ref_To_Local'>latestXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is all post-commit cleanup.  Note that if an error is raised here, 
     * it's too late to abort the transaction.  This should be just 
     * noncritical resource releasing. 
     * 
     * The ordering of operations is not entirely random.  The idea is: 
     * release resources visible to other backends (eg, files, buffer pins); 
     * then release locks; then release backend-local resources. We want to 
     * release locks at the point where any backend waiting for us will see 
     * our transaction as being fully cleaned up. 
     * 
     * Resources that can be associated with individual queries are handled by 
     * the ResourceOwner mechanism.  The other calls here are for backend-wide 
     * state. 
     */ 
</span> 
    <a href="xact.c.html#LN306"><span class='Ref_to_Proto'>CallXactCallbacks</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN1943"><span class='Ref_To_Local'>is_parallel_worker</span></a> <span class='Operator'>? </span><a href="../../../include/access/xact.h.html#LN101"><span class='Ref_to_EnumConst'>XACT_EVENT_PARALLEL_COMMIT</span></a> 
                      <span class='Operator'>: </span><a href="../../../include/access/xact.h.html#LN100"><span class='Ref_to_EnumConst'>XACT_EVENT_COMMIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we've released all buffer pins */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN184"><span class='Ref_to_Proto'>AtEOXact_Buffers</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up the relation cache */ 
</span>    <a href="../../../include/utils/relcache.h.html#LN119"><span class='Ref_to_Proto'>AtEOXact_RelationCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make catalog changes visible to all backends.  This has to happen after 
     * relcache references are dropped (see comments for 
     * AtEOXact_RelationCache), but before locks are released (if anyone is 
     * waiting for lock on a relation we've modified, we want them to know 
     * about the catalog change before they start using the relation). 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN27"><span class='Ref_to_Proto'>AtEOXact_Inval</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/multixact.h.html#LN118"><span class='Ref_to_Proto'>AtEOXact_MultiXact</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN47"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Likewise, dropping of files deleted during the transaction is best done 
     * after releasing relcache and buffer pins.  (This is not strictly 
     * necessary during commit, since such pins should have been released 
     * already, but this ordering is definitely critical during abort.)  Since 
     * this may take many seconds, also delay until after releasing locks. 
     * Other backends will observe the attendant catalog changes and not 
     * attempt to access affected files. 
     */ 
</span>    <a href="../../../include/catalog/storage.h.html#LN29"><span class='Ref_to_Proto'>smgrDoPendingDeletes</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we've released all catcache entries */ 
</span>    <a href="../../../include/utils/catcache.h.html#LN169"><span class='Ref_to_Proto'>AtEOXact_CatCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/commands/async.h.html#LN42"><span class='Ref_to_Proto'>AtCommit_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/spi.h.html#LN158"><span class='Ref_to_Proto'>AtEOXact_SPI</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/tablecmds.h.html#LN79"><span class='Ref_to_Proto'>AtEOXact_on_commit_actions</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/namespace.h.html#LN149"><span class='Ref_to_Proto'>AtEOXact_Namespace</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN1943"><span class='Ref_To_Local'>is_parallel_worker</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/smgr.h.html#LN111"><span class='Ref_to_Proto'>AtEOXact_SMgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/fd.h.html#LN109"><span class='Ref_to_Proto'>AtEOXact_Files</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/combocid.h.html#LN22"><span class='Ref_to_Proto'>AtEOXact_ComboCid</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/hsearch.h.html#LN141"><span class='Ref_to_Proto'>AtEOXact_HashTables</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1298"><span class='Ref_to_Proto'>AtEOXact_PgStat</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN87"><span class='Ref_to_Proto'>AtEOXact_Snapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/replication/logicallauncher.h.html#LN24"><span class='Ref_to_Proto'>AtEOXact_ApplyLauncher</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1171"><span class='Ref_to_Proto'>pgstat_report_xact_timestamp</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner.h.html#LN72"><span class='Ref_to_Proto'>ResourceOwnerDelete</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN302"><span class='Ref_to_Proto'>AtCommit_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * done with commit processing, set current transaction state back to 
     * default 
     */ 
</span>    <a href="xact.c.html#LN1941"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CommitTransaction &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  PrepareTransaction 
 * 
 * NB: if you change this routine, better look at CommitTransaction too! 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2178"></a><span class='Declare_Function'>PrepareTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2180"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN2181"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN2182"></a>    <a href="../../../include/access/twophase.h.html#LN24"><span class='Ref_to_Typedef'>GlobalTransaction</span></a> <span class='Declare_Local'>gxact</span><span class='Delimiter'>; 
</span><a name="LN2183"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>prepared_at</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"PrepareTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * check the current transaction state 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"PrepareTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do pre-commit processing that involves calling user-defined code, such 
     * as triggers.  Since closing cursors could queue trigger actions, 
     * triggers could open cursors, etc, we have to keep looping until there's 
     * nothing left to do. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Fire all currently pending deferred triggers. 
         */ 
</span>        <a href="../../../include/commands/trigger.h.html#LN189"><span class='Ref_to_Proto'>AfterTriggerFireDeferred</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Close open portals (converting holdable ones into static portals). 
         * If there weren't any, we are done ... otherwise loop back to check 
         * if they queued deferred triggers.  Lather, rinse, repeat. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/portal.h.html#LN209"><span class='Ref_to_Proto'>PreCommit_Portals</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="xact.c.html#LN306"><span class='Ref_to_Proto'>CallXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN107"><span class='Ref_to_EnumConst'>XACT_EVENT_PRE_PREPARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The remaining actions cannot call any user-defined code, so it's safe 
     * to start shutting down within-transaction services.  But note that most 
     * of this stuff could still throw an error, which would switch us into 
     * the transaction-abort path. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Shut down the deferred-trigger manager */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN190"><span class='Ref_to_Proto'>AfterTriggerEndXact</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Let ON COMMIT management do its thing (must happen after closing 
     * cursors, to avoid dangling-reference problems) 
     */ 
</span>    <a href="../../../include/commands/tablecmds.h.html#LN78"><span class='Ref_to_Proto'>PreCommit_on_commit_actions</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* close large objects before lower-level cleanup */ 
</span>    <a href="../../../include/libpq/be-fsstubs.h.html#LN32"><span class='Ref_to_Proto'>AtEOXact_LargeObject</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark serializable transaction as complete for predicate locking 
     * purposes.  This should be done as late as we can put it and still allow 
     * errors to be raised for failure patterns found at commit. 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN65"><span class='Ref_to_Proto'>PreCommit_CheckForSerializationFailure</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NOTIFY will be handled below */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't allow PREPARE TRANSACTION if we've accessed a temporary table in 
     * this transaction.  Having the prepared xact hold locks on another 
     * backend's temp table seems a bad idea --- for instance it would prevent 
     * the backend from exiting.  There are other problems too, such as how to 
     * clean up the source backend's local buffers and ON COMMIT state if the 
     * prepared xact includes a DROP of a temp table. 
     * 
     * We must check this after executing any ON COMMIT actions, because they 
     * might still access a temp relation. 
     * 
     * XXX In principle this could be relaxed to allow some useful special 
     * cases, such as a temp table created and dropped all within the 
     * transaction.  That seems to require much more bookkeeping though. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xact.c.html#LN117"><span class='Ref_to_Global_Var'>MyXactFlags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN86"><span class='Ref_to_Const'>XACT_FLAGS_ACCESSEDTEMPREL</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot PREPARE a transaction that has operated on temporary tables"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Likewise, don't allow PREPARE after pg_export_snapshot.  This could be 
     * supported if we added cleanup logic to twophase.c, but for now it 
     * doesn't seem worth the trouble. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN90"><span class='Ref_to_Proto'>XactHasExportedSnapshots</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot PREPARE a transaction that has exported snapshots"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prevent cancel/die interrupt while cleaning up */ 
</span>    <a href="../../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * set the current transaction state information appropriately during 
     * prepare processing 
     */ 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN129"><span class='Ref_to_EnumConst'>TRANS_PREPARE</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN2183"><span class='Ref_To_Local'>prepared_at</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Tell bufmgr and smgr to prepare for commit */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN223"><span class='Ref_to_Proto'>BufmgrCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reserve the GID for this transaction. This could fail if the requested 
     * GID is invalid or already in use. 
     */ 
</span>    <a href="xact.c.html#LN2182"><span class='Ref_To_Local'>gxact</span></a> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN38"><span class='Ref_to_Proto'>MarkAsPreparing</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2181"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN256"><span class='Ref_to_Global_Var'>prepareGID</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN2183"><span class='Ref_To_Local'>prepared_at</span></a><span class='Delimiter'>, 
</span>                            <a href="../../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN256"><span class='Ref_to_Global_Var'>prepareGID</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Collect data for the 2PC state file.  Note that in general, no actual 
     * state change should happen in the called modules during this step, 
     * since it's still possible to fail before commit, and in that case we 
     * want transaction abort to be able to clean up.  (In particular, the 
     * AtPrepare routines may error out if they find cases they cannot 
     * handle.)  State cleanup should happen in the PostPrepare routines 
     * below.  However, some modules can go ahead and clear state here because 
     * they wouldn't do anything with it during abort anyway. 
     * 
     * Note: because the 2PC state file records will be replayed in the same 
     * order they are made, the order of these calls has to match the order in 
     * which we want things to happen during COMMIT PREPARED or ROLLBACK 
     * PREPARED; in particular, pay attention to whether things should happen 
     * before or after releasing the transaction's locks. 
     */ 
</span>    <a href="../../../include/access/twophase.h.html#LN42"><span class='Ref_to_Proto'>StartPrepare</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2182"><span class='Ref_To_Local'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/commands/async.h.html#LN47"><span class='Ref_to_Proto'>AtPrepare_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lock.h.html#LN543"><span class='Ref_to_Proto'>AtPrepare_Locks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/predicate.h.html#LN68"><span class='Ref_to_Proto'>AtPrepare_PredicateLocks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1301"><span class='Ref_to_Proto'>AtPrepare_PgStat</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/multixact.h.html#LN119"><span class='Ref_to_Proto'>AtPrepare_MultiXact</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relmapper.h.html#LN51"><span class='Ref_to_Proto'>AtPrepare_RelationMap</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Here is where we really truly prepare. 
     * 
     * We have to record transaction prepares even if we didn't make any 
     * updates, because the transaction manager might get confused if we lose 
     * a global transaction. 
     */ 
</span>    <a href="../../../include/access/twophase.h.html#LN43"><span class='Ref_to_Proto'>EndPrepare</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2182"><span class='Ref_To_Local'>gxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we clean up backend-internal state and release internal resources. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Reset XactLastRecEnd until the next transaction writes something */ 
</span>    <a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Let others know about no transaction in progress by me.  This has to be 
     * done *after* the prepared transaction has been marked valid, else 
     * someone may think it is unlocked and recyclable. 
     */ 
</span>    <a href="../../../include/storage/procarray.h.html#LN64"><span class='Ref_to_Proto'>ProcArrayClearTransaction</span></a><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In normal commit-processing, this is all non-critical post-transaction 
     * cleanup.  When the transaction is prepared, however, it's important 
     * that the locks and other per-backend resources are transferred to the 
     * prepared transaction's PGPROC entry.  Note that if an error is raised 
     * here, it's too late to abort the transaction. XXX: This probably should 
     * be in a critical section, to force a PANIC if any of this fails, but 
     * that cure could be worse than the disease. 
     */ 
</span> 
    <a href="xact.c.html#LN306"><span class='Ref_to_Proto'>CallXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN104"><span class='Ref_to_EnumConst'>XACT_EVENT_PREPARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we've released all buffer pins */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN184"><span class='Ref_to_Proto'>AtEOXact_Buffers</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up the relation cache */ 
</span>    <a href="../../../include/utils/relcache.h.html#LN119"><span class='Ref_to_Proto'>AtEOXact_RelationCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* notify doesn't need a postprepare call */ 
</span> 
    <a href="../../../include/pgstat.h.html#LN1302"><span class='Ref_to_Proto'>PostPrepare_PgStat</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/inval.h.html#LN33"><span class='Ref_to_Proto'>PostPrepare_Inval</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/catalog/storage.h.html#LN33"><span class='Ref_to_Proto'>PostPrepare_smgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/multixact.h.html#LN120"><span class='Ref_to_Proto'>PostPrepare_MultiXact</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2181"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN544"><span class='Ref_to_Proto'>PostPrepare_Locks</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2181"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/predicate.h.html#LN69"><span class='Ref_to_Proto'>PostPrepare_PredicateLocks</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2181"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN47"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow another backend to finish the transaction.  After 
     * PostPrepare_Twophase(), the transaction is completely detached from our 
     * backend.  The rest is just non-critical cleanup of backend-local state. 
     */ 
</span>    <a href="../../../include/access/twophase.h.html#LN33"><span class='Ref_to_Proto'>PostPrepare_Twophase</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we've released all catcache entries */ 
</span>    <a href="../../../include/utils/catcache.h.html#LN169"><span class='Ref_to_Proto'>AtEOXact_CatCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* PREPARE acts the same as COMMIT as far as GUC is concerned */ 
</span>    <a href="../../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/spi.h.html#LN158"><span class='Ref_to_Proto'>AtEOXact_SPI</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/tablecmds.h.html#LN79"><span class='Ref_to_Proto'>AtEOXact_on_commit_actions</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/namespace.h.html#LN149"><span class='Ref_to_Proto'>AtEOXact_Namespace</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/smgr.h.html#LN111"><span class='Ref_to_Proto'>AtEOXact_SMgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/fd.h.html#LN109"><span class='Ref_to_Proto'>AtEOXact_Files</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/combocid.h.html#LN22"><span class='Ref_to_Proto'>AtEOXact_ComboCid</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/hsearch.h.html#LN141"><span class='Ref_to_Proto'>AtEOXact_HashTables</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* don't call AtEOXact_PgStat here; we fixed pgstat state above */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN87"><span class='Ref_to_Proto'>AtEOXact_Snapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1171"><span class='Ref_to_Proto'>pgstat_report_xact_timestamp</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner.h.html#LN72"><span class='Ref_to_Proto'>ResourceOwnerDelete</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN302"><span class='Ref_to_Proto'>AtCommit_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * done with 1st phase commit processing, set current transaction state 
     * back to default 
     */ 
</span>    <a href="xact.c.html#LN2180"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrepareTransaction &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  AbortTransaction 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2447"></a><span class='Declare_Function'>AbortTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2449"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN2450"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latestXid</span><span class='Delimiter'>; 
</span><a name="LN2451"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_parallel_worker</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prevent cancel/die interrupt while cleaning up */ 
</span>    <a href="../../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we have a valid memory context and resource owner */ 
</span>    <a href="xact.c.html#LN298"><span class='Ref_to_Proto'>AtAbort_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN300"><span class='Ref_to_Proto'>AtAbort_ResourceOwner</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release any LW locks we might be holding as quickly as possible. 
     * (Regular locks, however, must be held till we finish aborting.) 
     * Releasing LW locks is critical since we might try to grab them again 
     * while cleaning up! 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN150"><span class='Ref_to_Proto'>LWLockReleaseAll</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clear wait information and command progress indicator */ 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1184"><span class='Ref_to_Proto'>pgstat_progress_end_command</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up buffer I/O and buffer context locks, too */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN221"><span class='Ref_to_Proto'>AbortBufferIO</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN213"><span class='Ref_to_Proto'>UnlockBuffers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset WAL record construction state */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN51"><span class='Ref_to_Proto'>XLogResetInsertion</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Cancel condition variable sleep */ 
</span>    <a href="../../../include/storage/condition_variable.h.html#LN45"><span class='Ref_to_Proto'>ConditionVariableCancelSleep</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also clean up any open wait for lock, since the lock manager will choke 
     * if we try to wait for another lock before doing this. 
     */ 
</span>    <a href="../../../include/storage/proc.h.html#LN305"><span class='Ref_to_Proto'>LockErrorCleanup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If any timeout events are still active, make sure the timeout interrupt 
     * is scheduled.  This covers possible loss of a timeout interrupt due to 
     * longjmp'ing out of the SIGINT handler (see notes in handle_sig_alarm). 
     * We delay this till after LockErrorCleanup so that we don't uselessly 
     * reschedule lock or deadlock check timeouts. 
     */ 
</span>    <a href="../../../include/utils/timeout.h.html#LN71"><span class='Ref_to_Proto'>reschedule_timeouts</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Re-enable signals, in case we got here by longjmp'ing out of a signal 
     * handler.  We do this fairly early in the sequence so that the timeout 
     * infrastructure will be functional if needed while aborting. 
     */ 
</span>    <a href="../../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * check the current transaction state 
     */ 
</span>    <a href="xact.c.html#LN2451"><span class='Ref_To_Local'>is_parallel_worker</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a> <span class='Operator'>&& </span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN129"><span class='Ref_to_EnumConst'>TRANS_PREPARE</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"AbortTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * set the current transaction state information appropriately during the 
     * abort processing 
     */ 
</span>    <a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset user ID which might have been changed transiently.  We need this 
     * to clean up in case control escaped out of a SECURITY DEFINER function 
     * or other local change of CurrentUserId; therefore, the prior value of 
     * SecurityRestrictionContext also needs to be restored. 
     * 
     * (Note: it is not necessary to restore session authorization or role 
     * settings here because those can only be changed via GUC, and GUC will 
     * take care of rolling them back if need be.) 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN184"><span class='Ref_to_Member'>prevUser</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN185"><span class='Ref_to_Member'>prevSecContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If in parallel mode, clean up workers and exit parallel mode. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/parallel.h.html#LN63"><span class='Ref_to_Proto'>AtEOXact_Parallel</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN2449"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * do abort processing 
     */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN190"><span class='Ref_to_Proto'>AfterTriggerEndXact</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* 'false' means it's abort */ 
</span>    <a href="../../../include/utils/portal.h.html#LN210"><span class='Ref_to_Proto'>AtAbort_Portals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/be-fsstubs.h.html#LN32"><span class='Ref_to_Proto'>AtEOXact_LargeObject</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/async.h.html#LN43"><span class='Ref_to_Proto'>AtAbort_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relmapper.h.html#LN50"><span class='Ref_to_Proto'>AtEOXact_RelationMap</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/twophase.h.html#LN32"><span class='Ref_to_Proto'>AtAbort_Twophase</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advertise the fact that we aborted in pg_xact (assuming that we got as 
     * far as assigning an XID to advertise).  But if we're inside a parallel 
     * worker, skip this; the user backend must be the one to write the abort 
     * record. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN2451"><span class='Ref_To_Local'>is_parallel_worker</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN2450"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN314"><span class='Ref_to_Proto'>RecordTransactionAbort</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN2450"><span class='Ref_To_Local'>latestXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Since the parallel master won't get our value of XactLastRecEnd in 
         * this case, we nudge WAL-writer ourselves in this case.  See related 
         * comments in RecordTransactionAbort for why this matters. 
         */ 
</span>        <a href="../../../include/access/xlog.h.html#LN233"><span class='Ref_to_Proto'>XLogSetAsyncXactLSN</span></a><span class='Parentheses'>(</span><a href="xlog.c.html#LN336"><span class='Ref_to_Global_Var'>XactLastRecEnd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    TRACE_POSTGRESQL_TRANSACTION_ABORT<span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Let others know about no transaction in progress by me. Note that this 
     * must be done _before_ releasing locks we hold and _after_ 
     * RecordTransactionAbort. 
     */ 
</span>    <a href="../../../include/storage/procarray.h.html#LN63"><span class='Ref_to_Proto'>ProcArrayEndTransaction</span></a><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN2450"><span class='Ref_To_Local'>latestXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Post-abort cleanup.  See notes in CommitTransaction() concerning 
     * ordering.  We can skip all of it if the transaction failed before 
     * creating a resource owner. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2451"><span class='Ref_To_Local'>is_parallel_worker</span></a><span class='Parentheses'>) 
</span>            <a href="xact.c.html#LN306"><span class='Ref_to_Proto'>CallXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN103"><span class='Ref_to_EnumConst'>XACT_EVENT_PARALLEL_ABORT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="xact.c.html#LN306"><span class='Ref_to_Proto'>CallXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN102"><span class='Ref_to_EnumConst'>XACT_EVENT_ABORT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN184"><span class='Ref_to_Proto'>AtEOXact_Buffers</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/relcache.h.html#LN119"><span class='Ref_to_Proto'>AtEOXact_RelationCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/inval.h.html#LN27"><span class='Ref_to_Proto'>AtEOXact_Inval</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/multixact.h.html#LN118"><span class='Ref_to_Proto'>AtEOXact_MultiXact</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN47"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/catalog/storage.h.html#LN29"><span class='Ref_to_Proto'>smgrDoPendingDeletes</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/catcache.h.html#LN169"><span class='Ref_to_Proto'>AtEOXact_CatCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/executor/spi.h.html#LN158"><span class='Ref_to_Proto'>AtEOXact_SPI</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/commands/tablecmds.h.html#LN79"><span class='Ref_to_Proto'>AtEOXact_on_commit_actions</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/catalog/namespace.h.html#LN149"><span class='Ref_to_Proto'>AtEOXact_Namespace</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN2451"><span class='Ref_To_Local'>is_parallel_worker</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN111"><span class='Ref_to_Proto'>AtEOXact_SMgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/fd.h.html#LN109"><span class='Ref_to_Proto'>AtEOXact_Files</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/combocid.h.html#LN22"><span class='Ref_to_Proto'>AtEOXact_ComboCid</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN141"><span class='Ref_to_Proto'>AtEOXact_HashTables</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1298"><span class='Ref_to_Proto'>AtEOXact_PgStat</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/replication/logicallauncher.h.html#LN24"><span class='Ref_to_Proto'>AtEOXact_ApplyLauncher</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1171"><span class='Ref_to_Proto'>pgstat_report_xact_timestamp</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TopTransactionResourc... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * State remains TRANS_ABORT until CleanupTransaction(). 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AbortTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  CleanupTransaction 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2628"></a><span class='Declare_Function'>CleanupTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2630"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * State should still be TRANS_ABORT from AbortTransaction(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"CleanupTransaction: unexpected state %s"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * do abort cleanup processing 
     */ 
</span>    <a href="../../../include/utils/portal.h.html#LN211"><span class='Ref_to_Proto'>AtCleanup_Portals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* now safe to release portal memory */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN87"><span class='Ref_to_Proto'>AtEOXact_Snapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Multi_Line'>/* and release the transaction's 
                                         * snapshots */ 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* and resource owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/resowner.h.html#LN72"><span class='Ref_to_Proto'>ResourceOwnerDelete</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN299"><span class='Ref_to_Proto'>AtCleanup_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* and transaction memory */ 
</span> 
    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN183"><span class='Ref_to_Member'>maxChildXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * done with abort processing, set current transaction state back to 
     * default 
     */ 
</span>    <a href="xact.c.html#LN2630"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CleanupTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  StartTransactionCommand 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2678"></a><span class='Declare_Function'>StartTransactionCommand</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2680"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2680"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * if we aren't in a transaction block, we just do our usual start 
             * transaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_dump/pg_backup_db.h.html#LN22"><span class='Ref_to_Proto'>StartTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2680"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are somewhere in a transaction block or subtransaction and 
             * about to start a new command.  For now we do nothing, but 
             * someday we may do command-local resource initialization. (Note 
             * that any needed CommandCounterIncrement was done by the 
             * previous CommitTransactionCommand.) 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here we are in a failed transaction block (one of the commands 
             * caused an abort) so we do nothing but remain in the abort 
             * state.  Eventually we will get a ROLLBACK command which will 
             * get us out of this state.  (It is up to other code to ensure 
             * that no commands other than ROLLBACK will be processed in these 
             * states.) 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"StartTransactionCommand: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2680"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We must switch to CurTransactionContext before returning. This is 
     * already done if we called StartTransaction, otherwise not. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartTransactionCommand &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  CommitTransactionCommand 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2748"></a><span class='Declare_Function'>CommitTransactionCommand</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2750"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * These shouldn't happen.  TBLOCK_DEFAULT means the previous 
             * StartTransactionCommand didn't set the STARTED state 
             * appropriately, while TBLOCK_PARALLEL_INPROGRESS should be ended 
             * by EndParallelWorkerTransaction(), not this function. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"CommitTransactionCommand: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we aren't in a transaction block, just do our usual 
             * transaction commit, and return to the idle state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_dump/pg_backup_db.h.html#LN23"><span class='Ref_to_Proto'>CommitTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are completing a "BEGIN TRANSACTION" command, so we change 
             * to the "transaction block in progress" state and return.  (We 
             * assume the BEGIN did nothing to the database, so we need no 
             * CommandCounterIncrement.) 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * This is the case when we have finished executing a command 
             * someplace within a transaction block.  We increment the command 
             * counter and return. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are completing a "COMMIT" command.  Do it and return to the 
             * idle state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_dump/pg_backup_db.h.html#LN23"><span class='Ref_to_Proto'>CommitTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here we are in the middle of a transaction block but one of the 
             * commands caused an abort so we do nothing but remain in the 
             * abort state.  Eventually we will get a ROLLBACK command. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here we were in an aborted transaction block and we just got 
             * the ROLLBACK command from the user, so clean up the 
             * already-aborted transaction and return to the idle state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here we were in a perfectly good transaction block but the user 
             * told us to ROLLBACK anyway.  We have to abort the transaction 
             * and then clean up. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are completing a "PREPARE TRANSACTION" command.  Do it and 
             * return to the idle state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN2177"><span class='Ref_to_Func'>PrepareTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We were just issued a SAVEPOINT inside a transaction block. 
             * Start a subtransaction.  (DefineSavepoint already did 
             * PushTransaction, so as to have someplace to put the SUBBEGIN 
             * state.) 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN317"><span class='Ref_to_Proto'>StartSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We were issued a RELEASE command, so we end the current 
             * subtransaction and return to the parent transaction. The parent 
             * might be ended too, so repeat till we find an INPROGRESS 
             * transaction or subtransaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>            <span class='Control'>do</span> 
            <span class='Delimiter'>{ 
</span>                <a href="xact.c.html#LN318"><span class='Ref_to_Proto'>CommitSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by pop */ 
</span>            <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a> <span class='Operator'>|| 
</span>                   <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We were issued a COMMIT, so we end the current subtransaction 
             * hierarchy and perform final commit. We do this by rolling up 
             * any subtransactions into their parent, which leads to O(N^2) 
             * operations with respect to resource owners - this isn't that 
             * bad until we approach a thousands of savepoints but is 
             * necessary for correctness should after triggers create new 
             * resource owners. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>            <span class='Control'>do</span> 
            <span class='Delimiter'>{ 
</span>                <a href="xact.c.html#LN318"><span class='Ref_to_Proto'>CommitSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by pop */ 
</span>            <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* If we had a COMMIT command, finish off the main xact too */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_dump/pg_backup_db.h.html#LN23"><span class='Ref_to_Proto'>CommitTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2177"><span class='Ref_to_Func'>PrepareTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"CommitTransactionCommand: unexpected state %s"</span><span class='Delimiter'>, 
</span>                     <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The current already-failed subtransaction is ending due to a 
             * ROLLBACK or ROLLBACK TO command, so pop it and recursively 
             * examine the parent (which could be in any of several states). 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * As above, but it's not dead yet, so abort first. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN319"><span class='Ref_to_Proto'>AbortSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The current subtransaction is the target of a ROLLBACK TO 
             * command.  Abort and pop it, then start a new subtransaction 
             * with the same name. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2930"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>; 
</span><a name="LN2931"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>savepointLevel</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* save name and keep Cleanup from freeing it */ 
</span>                <a href="xact.c.html#LN2930"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2931"><span class='Ref_To_Local'>savepointLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a><span class='Delimiter'>; 
</span> 
                <a href="xact.c.html#LN319"><span class='Ref_to_Proto'>AbortSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/xact.h.html#LN356"><span class='Ref_to_Proto'>DefineSavepoint</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by push */ 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2930"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2931"><span class='Ref_To_Local'>savepointLevel</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* This is the same as TBLOCK_SUBBEGIN case */ 
</span>                <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN317"><span class='Ref_to_Proto'>StartSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Same as above, but the subtransaction had already failed, so we 
             * don't need AbortSubTransaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2959"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>; 
</span><a name="LN2960"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>savepointLevel</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* save name and keep Cleanup from freeing it */ 
</span>                <a href="xact.c.html#LN2959"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2960"><span class='Ref_To_Local'>savepointLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a><span class='Delimiter'>; 
</span> 
                <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/xact.h.html#LN356"><span class='Ref_to_Proto'>DefineSavepoint</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by push */ 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2959"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN2960"><span class='Ref_To_Local'>savepointLevel</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* This is the same as TBLOCK_SUBBEGIN case */ 
</span>                <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN317"><span class='Ref_to_Proto'>StartSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN2750"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CommitTransactionCommand &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  AbortCurrentTransaction 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2987"></a><span class='Declare_Function'>AbortCurrentTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2989"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* we are idle, so nothing to do */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * We can get here after an error during transaction start 
                 * (state will be TRANS_START).  Need to clean up the 
                 * incompletely started transaction.  First, adjust the 
                 * low-level state to suppress warning message from 
                 * AbortTransaction. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN125"><span class='Ref_to_EnumConst'>TRANS_START</span></a><span class='Parentheses'>) 
</span>                    <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * if we aren't in a transaction block, we just do the basic abort 
             * & cleanup transaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we are in TBLOCK_BEGIN it means something screwed up right 
             * after reading "BEGIN TRANSACTION".  We assume that the user 
             * will interpret the error as meaning the BEGIN failed to get him 
             * into a transaction block, so we should abort and return to idle 
             * state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are somewhere in a transaction block and we've gotten a 
             * failure, so we abort the transaction and set up the persistent 
             * ABORT state.  We will stay in ABORT until we get a ROLLBACK. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* CleanupTransaction happens when we exit TBLOCK_ABORT_END */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here, we failed while trying to COMMIT.  Clean up the 
             * transaction and return to idle state (we do not want to stay in 
             * the transaction). 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here, we are already in an aborted transaction state and are 
             * waiting for a ROLLBACK, but for some reason we failed again! So 
             * we just remain in the abort state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are in a failed transaction and we got the ROLLBACK command. 
             * We have already aborted, we just need to cleanup and go to idle 
             * state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are in a live transaction and we got a ROLLBACK command. 
             * Abort, cleanup, go to idle state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here, we failed while trying to PREPARE.  Clean up the 
             * transaction and return to idle state (we do not want to stay in 
             * the transaction). 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We got an error inside a subtransaction.  Abort just the 
             * subtransaction, and go to the persistent SUBABORT state until 
             * we get ROLLBACK. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN319"><span class='Ref_to_Proto'>AbortSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN2989"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we failed while trying to create a subtransaction, clean up 
             * the broken subtransaction and abort the parent.  The same 
             * applies if we get a failure while ending a subtransaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN319"><span class='Ref_to_Proto'>AbortSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Same as above, except the Abort() was already done. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AbortCurrentTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  PreventTransactionChain 
 * 
 *  This routine is to be called by statements that must not run inside 
 *  a transaction block, typically because they have non-rollback-able 
 *  side effects or do internal commits. 
 * 
 *  If we have already started a transaction block, issue an error; also issue 
 *  an error if we appear to be running inside a user-defined function (which 
 *  could issue more commands and possibly cause a failure after the statement 
 *  completes).  Subtransactions are verboten too. 
 * 
 *  isTopLevel: passed down from ProcessUtility to determine whether we are 
 *  inside a function or multi-query querystring.  (We will always fail if 
 *  this is false, but it's convenient to centralize the check here instead of 
 *  making callers do it.) 
 *  stmtType: statement type name, for error messages. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3155"></a><span class='Declare_Function'>PreventTransactionChain</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>stmtType</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * xact block already started? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN366"><span class='Ref_to_Proto'>IsTransactionBlock</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <span class='Comment_Multi_Line'>/* translator: %s represents an SQL statement name */ 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s cannot run inside a transaction block"</span><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN3155"><span class='Ref_to_Parameter'>stmtType</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * subtransaction? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN361"><span class='Ref_to_Proto'>IsSubTransaction</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <span class='Comment_Multi_Line'>/* translator: %s represents an SQL statement name */ 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s cannot run inside a subtransaction"</span><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN3155"><span class='Ref_to_Parameter'>stmtType</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * inside a function call? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN3155"><span class='Ref_to_Parameter'>isTopLevel</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <span class='Comment_Multi_Line'>/* translator: %s represents an SQL statement name */ 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s cannot be executed from a function or multi-command string"</span><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN3155"><span class='Ref_to_Parameter'>stmtType</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we got past IsTransactionBlock test, should be in default state */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a> <span class='Operator'>&& 
</span>        <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"cannot prevent transaction chain"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* all okay */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PreventTransactionChain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  These two functions allow for warnings or errors if a command is 
 *  executed outside of a transaction block. 
 * 
 *  While top-level transaction control commands (BEGIN/COMMIT/ABORT) and 
 *  SET that have no effect issue warnings, all other no-effect commands 
 *  generate errors. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3203"></a><span class='Declare_Function'>WarnNoTransactionChain</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>stmtType</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="xact.c.html#LN311"><span class='Ref_to_Proto'>CheckTransactionChain</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3203"><span class='Ref_to_Parameter'>isTopLevel</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN3203"><span class='Ref_to_Parameter'>stmtType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN3209"></a><span class='Declare_Function'>RequireTransactionChain</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>stmtType</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="xact.c.html#LN311"><span class='Ref_to_Proto'>CheckTransactionChain</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3209"><span class='Ref_to_Parameter'>isTopLevel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN3209"><span class='Ref_to_Parameter'>stmtType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  RequireTransactionChain 
 * 
 *  This routine is to be called by statements that must run inside 
 *  a transaction block, because they have no effects that persist past 
 *  transaction end (and so calling them outside a transaction block 
 *  is presumably an error).  DECLARE CURSOR is an example. 
 * 
 *  If we appear to be running inside a user-defined function, we do not 
 *  issue anything, since the function could issue more commands that make 
 *  use of the current statement's results.  Likewise subtransactions. 
 *  Thus this is an inverse for PreventTransactionChain. 
 * 
 *  isTopLevel: passed down from ProcessUtility to determine whether we are 
 *  inside a function. 
 *  stmtType: statement type name, for warning or error messages. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3232"></a><span class='Declare_Function'>CheckTransactionChain</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>throwError</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>stmtType</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * xact block already started? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN366"><span class='Ref_to_Proto'>IsTransactionBlock</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * subtransaction? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN361"><span class='Ref_to_Proto'>IsSubTransaction</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * inside a function call? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN3232"><span class='Ref_to_Parameter'>isTopLevel</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3232"><span class='Ref_to_Parameter'>throwError</span></a> <span class='Operator'>? </span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a> <span class='Operator'>: </span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NO_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* translator: %s represents an SQL statement name */ 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s can only be used in transaction blocks"</span><span class='Delimiter'>, 
</span>                    <a href="xact.c.html#LN3232"><span class='Ref_to_Parameter'>stmtType</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckTransactionChain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  IsInTransactionChain 
 * 
 *  This routine is for statements that need to behave differently inside 
 *  a transaction block than when running as single commands.  ANALYZE is 
 *  currently the only example. 
 * 
 *  isTopLevel: passed down from ProcessUtility to determine whether we are 
 *  inside a function. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3271"></a><span class='Declare_Function'>IsInTransactionChain</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Return true on same conditions that would make PreventTransactionChain 
     * error out 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN366"><span class='Ref_to_Proto'>IsTransactionBlock</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN361"><span class='Ref_to_Proto'>IsSubTransaction</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xact.c.html#LN3271"><span class='Ref_to_Parameter'>isTopLevel</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a> <span class='Operator'>&& 
</span>        <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end IsInTransactionChain &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Register or deregister callback functions for start- and end-of-xact 
 * operations. 
 * 
 * These functions are intended for use by dynamically loaded modules. 
 * For built-in modules we generally just hardwire the appropriate calls 
 * (mainly because it's easier to control the order that way, where needed). 
 * 
 * At transaction end, the callback occurs post-commit or post-abort, so the 
 * callback functions can only do noncritical cleanup. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3306"></a><span class='Declare_Function'>RegisterXactCallback</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN110"><span class='Ref_to_Typedef'>XactCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3308"></a>    <a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN3308"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN3308"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN276"><span class='Ref_to_Member'>callback</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3306"><span class='Ref_to_Parameter'>callback</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN3308"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN277"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3306"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN3308"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN275"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN280"><span class='Ref_to_Global_Var'>Xact_callbacks</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN280"><span class='Ref_to_Global_Var'>Xact_callbacks</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3308"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN3319"></a><span class='Declare_Function'>UnregisterXactCallback</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN110"><span class='Ref_to_Typedef'>XactCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3321"></a>    <a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span><a name="LN3322"></a>    <a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN3322"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN280"><span class='Ref_to_Global_Var'>Xact_callbacks</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3322"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN275"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN276"><span class='Ref_to_Member'>callback</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN3319"><span class='Ref_to_Parameter'>callback</span></a> <span class='Operator'>&& </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN277"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN3319"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3322"><span class='Ref_To_Local'>prev</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3322"><span class='Ref_To_Local'>prev</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN275"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN275"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="xact.c.html#LN280"><span class='Ref_to_Global_Var'>Xact_callbacks</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN275"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3321"><span class='Ref_To_Local'>item</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end UnregisterXactCallback &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN3340"></a><span class='Declare_Function'>CallXactCallbacks</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN98"><span class='Ref_to_Typedef'>XactEvent</span></a> <span class='Declare_Parameter'>event</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3342"></a>    <a href="xact.c.html#LN273"><span class='Ref_to_Struct'>XactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3342"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN280"><span class='Ref_to_Global_Var'>Xact_callbacks</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3342"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3342"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3342"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN275"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="xact.c.html#LN3342"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN276"><span class='Ref_to_Member'>callback</span></a><span class='Parentheses'>) (</span><a href="xact.c.html#LN3340"><span class='Ref_to_Parameter'>event</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3342"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN277"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Register or deregister callback functions for start- and end-of-subxact 
 * operations. 
 * 
 * Pretty much same as above, but for subtransaction events. 
 * 
 * At subtransaction end, the callback occurs post-subcommit or post-subabort, 
 * so the callback functions can only do noncritical cleanup.  At 
 * subtransaction start, the callback is called when the subtransaction has 
 * finished initializing. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3361"></a><span class='Declare_Function'>RegisterSubXactCallback</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN120"><span class='Ref_to_Typedef'>SubXactCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3363"></a>    <a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN3363"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN3363"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN288"><span class='Ref_to_Member'>callback</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3361"><span class='Ref_to_Parameter'>callback</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN3363"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN289"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3361"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN3363"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN287"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN292"><span class='Ref_to_Global_Var'>SubXact_callbacks</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN292"><span class='Ref_to_Global_Var'>SubXact_callbacks</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3363"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN3374"></a><span class='Declare_Function'>UnregisterSubXactCallback</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN120"><span class='Ref_to_Typedef'>SubXactCallback</span></a> <span class='Declare_Parameter'>callback</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3376"></a>    <a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span><a name="LN3377"></a>    <a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN3377"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN292"><span class='Ref_to_Global_Var'>SubXact_callbacks</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3377"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN287"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN288"><span class='Ref_to_Member'>callback</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN3374"><span class='Ref_to_Parameter'>callback</span></a> <span class='Operator'>&& </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN289"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN3374"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3377"><span class='Ref_To_Local'>prev</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3377"><span class='Ref_To_Local'>prev</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN287"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN287"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="xact.c.html#LN292"><span class='Ref_to_Global_Var'>SubXact_callbacks</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN287"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3376"><span class='Ref_To_Local'>item</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end UnregisterSubXactCallback &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN3395"></a><span class='Declare_Function'>CallSubXactCallbacks</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN112"><span class='Ref_to_Typedef'>SubXactEvent</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, 
</span><a name="LN3396"></a>                     <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubid</span><span class='Delimiter'>, 
</span><a name="LN3397"></a>                     <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>parentSubid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3399"></a>    <a href="xact.c.html#LN285"><span class='Ref_to_Struct'>SubXactCallbackItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3399"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN292"><span class='Ref_to_Global_Var'>SubXact_callbacks</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3399"><span class='Ref_To_Local'>item</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN3399"><span class='Ref_To_Local'>item</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3399"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN287"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="xact.c.html#LN3399"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN288"><span class='Ref_to_Member'>callback</span></a><span class='Parentheses'>) (</span><a href="xact.c.html#LN3395"><span class='Ref_to_Parameter'>event</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3396"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3397"><span class='Ref_to_Parameter'>parentSubid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3399"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN289"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                     transaction block support 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  BeginTransactionBlock 
 *      This executes a BEGIN command. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3416"></a><span class='Declare_Function'>BeginTransactionBlock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3418"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3418"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We are not inside a transaction block, so allow one to begin. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN3418"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Already a transaction block in progress. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"there is already a transaction in progress"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"BeginTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3418"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end BeginTransactionBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  PrepareTransactionBlock 
 *      This executes a PREPARE command. 
 * 
 * Since PREPARE may actually do a ROLLBACK, the result indicates what 
 * happened: TRUE for PREPARE, FALSE for ROLLBACK. 
 * 
 * Note that we don't actually do anything here except change blockState. 
 * The real work will be done in the upcoming PrepareTransaction(). 
 * We do it this way because it's not convenient to change memory context, 
 * resource owner, etc while executing inside a Portal. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3475"></a><span class='Declare_Function'>PrepareTransactionBlock</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3477"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN3478"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up to commit the current transaction */ 
</span>    <a href="xact.c.html#LN3478"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN352"><span class='Ref_to_Proto'>EndTransactionBlock</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If successful, change outer tblock state to PREPARE */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3478"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Save GID where PrepareTransaction can find it again */ 
</span>            <a href="xact.c.html#LN256"><span class='Ref_to_Global_Var'>prepareGID</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3475"><span class='Ref_to_Parameter'>gid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * ignore case where we are not in a transaction; 
             * EndTransactionBlock already issued a warning. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN3477"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Don't send back a PREPARE result tag... */ 
</span>            <a href="xact.c.html#LN3478"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result &raquo; </span> 
 
    <span class='Control'>return</span> <a href="xact.c.html#LN3478"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrepareTransactionBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  EndTransactionBlock 
 *      This executes a COMMIT command. 
 * 
 * Since COMMIT may actually do a ROLLBACK, the result indicates what 
 * happened: TRUE for COMMIT, FALSE for ROLLBACK. 
 * 
 * Note that we don't actually do anything here except change blockState. 
 * The real work will be done in the upcoming CommitTransactionCommand(). 
 * We do it this way because it's not convenient to change memory context, 
 * resource owner, etc while executing inside a Portal. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3526"></a><span class='Declare_Function'>EndTransactionBlock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3528"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN3529"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We are in a transaction block, so tell CommitTransactionCommand 
             * to COMMIT. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN3529"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are in a failed transaction block.  Tell 
             * CommitTransactionCommand it's time to exit the block. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are in a live subtransaction block.  Set up to subcommit all 
             * open subtransactions and then commit the main transaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>                    <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"EndTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"EndTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                     <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN3529"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here we are inside an aborted subtransaction.  Treat the COMMIT 
             * as ROLLBACK: set up to abort everything and exit the main 
             * transaction. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>                    <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Parentheses'>) 
</span>                    <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"EndTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"EndTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                     <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The user issued COMMIT when not inside a transaction.  Issue a 
             * WARNING, staying in TBLOCK_STARTED state.  The upcoming call to 
             * CommitTransactionCommand() will then close the transaction and 
             * put us back into the default state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NO_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"there is no transaction in progress"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN3529"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The user issued a COMMIT that somehow ran inside a parallel 
             * worker.  We can't cope with that. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot commit during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"EndTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3528"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <span class='Control'>return</span> <a href="xact.c.html#LN3529"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end EndTransactionBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  UserAbortTransactionBlock 
 *      This executes a ROLLBACK command. 
 * 
 * As above, we don't actually do anything here except change blockState. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3650"></a><span class='Declare_Function'>UserAbortTransactionBlock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3652"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We are inside a transaction block and we got a ROLLBACK command 
             * from the user, so tell CommitTransactionCommand to abort and 
             * exit the transaction block. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are inside a failed transaction block and we got a ROLLBACK 
             * command from the user.  Abort processing is already done, so 
             * CommitTransactionCommand just has to cleanup and go back to 
             * idle state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>            <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are inside a subtransaction.  Mark everything up to top 
             * level as exitable. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>                    <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Parentheses'>) 
</span>                    <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"UserAbortTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"UserAbortTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                     <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The user issued ABORT when not inside a transaction. Issue a 
             * WARNING and go to abort state.  The upcoming call to 
             * CommitTransactionCommand() will then put us back into the 
             * default state. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NO_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"there is no transaction in progress"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The user issued an ABORT that somehow ran inside a parallel 
             * worker.  We can't cope with that. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot abort during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"UserAbortTransactionBlock: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3652"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end UserAbortTransactionBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DefineSavepoint 
 *      This executes a SAVEPOINT command. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3749"></a><span class='Declare_Function'>DefineSavepoint</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3751"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Workers synchronize transaction state at the beginning of each parallel 
     * operation, so we can't account for new subtransactions after that 
     * point.  (Note that this check will certainly error out if s-&GT;blockState 
     * is TBLOCK_PARALLEL_INPROGRESS, so we can treat that as an invalid case 
     * below.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot define savepoints during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3751"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Normal subtransaction start */ 
</span>            <a href="xact.c.html#LN321"><span class='Ref_to_Proto'>PushTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN3751"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* changed by push */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Savepoint names, like the TransactionState block itself, live 
             * in TopTransactionContext. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3749"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN3751"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3749"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"DefineSavepoint: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3751"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DefineSavepoint &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReleaseSavepoint 
 *      This executes a RELEASE command. 
 * 
 * As above, we don't actually do anything here except change blockState. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3812"></a><span class='Declare_Function'>ReleaseSavepoint</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3814"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN3815"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>, 
</span><a name="LN3816"></a>                <span class='Declare_Local'>xact</span><span class='Delimiter'>; 
</span><a name="LN3817"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN3818"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Workers synchronize transaction state at the beginning of each parallel 
     * operation, so we can't account for transaction state change after that 
     * point.  (Note that this check will certainly error out if s-&GT;blockState 
     * is TBLOCK_PARALLEL_INPROGRESS, so we can treat that as an invalid case 
     * below.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot release savepoints during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3814"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We can't rollback to a savepoint if there is no savepoint 
             * defined. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_E_INVALID_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no such savepoint"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We are in a non-aborted subtransaction.  This is the only valid 
             * case. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"ReleaseSavepoint: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3814"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3817"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3812"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3876"></a>        <a href="../../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>elem</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3817"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="xact.c.html#LN3876"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"savepoint_name"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="xact.c.html#LN3818"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3876"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3818"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3814"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; </span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3818"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_E_INVALID_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no such savepoint"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* disallow crossing savepoint level boundaries */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN3814"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_E_INVALID_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no such savepoint"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark "commit pending" all subtransactions up to the target 
     * subtransaction.  The actual commits will happen when control gets to 
     * CommitTransactionCommand. 
     */ 
</span>    <a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN3815"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3816"><span class='Ref_To_Local'>xact</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReleaseSavepoint &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RollbackToSavepoint 
 *      This executes a ROLLBACK TO &LT;savepoint&GT; command. 
 * 
 * As above, we don't actually do anything here except change blockState. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3925"></a><span class='Declare_Function'>RollbackToSavepoint</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3927"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN3928"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>, 
</span><a name="LN3929"></a>                <span class='Declare_Local'>xact</span><span class='Delimiter'>; 
</span><a name="LN3930"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN3931"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Workers synchronize transaction state at the beginning of each parallel 
     * operation, so we can't account for transaction state change after that 
     * point.  (Note that this check will certainly error out if s-&GT;blockState 
     * is TBLOCK_PARALLEL_INPROGRESS, so we can treat that as an invalid case 
     * below.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot rollback to savepoints during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3927"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We can't rollback to a savepoint if there is no savepoint 
             * defined. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_E_INVALID_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no such savepoint"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * There is at least one savepoint, so proceed. 
             */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"RollbackToSavepoint: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3927"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3930"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3925"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3988"></a>        <a href="../../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>elem</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3930"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="xact.c.html#LN3988"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"savepoint_name"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="xact.c.html#LN3931"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3988"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3931"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3927"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; </span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN3931"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_E_INVALID_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no such savepoint"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* disallow crossing savepoint level boundaries */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN3927"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_S_E_INVALID_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no such savepoint"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark "abort pending" all subtransactions up to the target 
     * subtransaction.  The actual aborts will happen when control gets to 
     * CommitTransactionCommand. 
     */ 
</span>    <a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN3928"><span class='Ref_To_Local'>target</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>            <a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Parentheses'>) 
</span>            <a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"RollbackToSavepoint: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* And mark the target as "restart pending" */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"RollbackToSavepoint: unexpected state %s"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN3929"><span class='Ref_To_Local'>xact</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RollbackToSavepoint &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * BeginInternalSubTransaction 
 *      This is the same as DefineSavepoint except it allows TBLOCK_STARTED, 
 *      TBLOCK_END, and TBLOCK_PREPARE states, and therefore it can safely be 
 *      used in functions that might be called when not inside a BEGIN block 
 *      or when running deferred triggers at COMMIT/PREPARE time.  Also, it 
 *      automatically does CommitTransactionCommand/StartTransactionCommand 
 *      instead of expecting the caller to do it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4054"></a><span class='Declare_Function'>BeginInternalSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4056"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Workers synchronize transaction state at the beginning of each parallel 
     * operation, so we can't account for new subtransactions after that 
     * point. We might be able to make an exception for the type of 
     * subtransaction established by this function, which is typically used in 
     * contexts where we're going to release or roll back the subtransaction 
     * before proceeding further, so that no enduring change to the 
     * transaction state occurs. For now, however, we prohibit this case along 
     * with all the others. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot start subtransactions during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4056"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Normal subtransaction start */ 
</span>            <a href="xact.c.html#LN321"><span class='Ref_to_Proto'>PushTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN4056"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* changed by push */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Savepoint names, like the TransactionState block itself, live 
             * in TopTransactionContext. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4054"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) 
</span>                <a href="xact.c.html#LN4056"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4054"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"BeginInternalSubTransaction: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4056"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BeginInternalSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReleaseCurrentSubTransaction 
 * 
 * RELEASE (ie, commit) the innermost subtransaction, regardless of its 
 * savepoint name (if any). 
 * NB: do NOT use CommitTransactionCommand/StartTransactionCommand with this. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4124"></a><span class='Declare_Function'>ReleaseCurrentSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4126"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Workers synchronize transaction state at the beginning of each parallel 
     * operation, so we can't account for commit of subtransactions after that 
     * point.  This should not happen anyway.  Code calling this would 
     * typically have called BeginInternalSubTransaction() first, failing 
     * there. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot commit subtransactions during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4126"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"ReleaseCurrentSubTransaction: unexpected state %s"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4126"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN4126"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN318"><span class='Ref_to_Proto'>CommitSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4126"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by pop */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN4126"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReleaseCurrentSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RollbackAndReleaseCurrentSubTransaction 
 * 
 * ROLLBACK and RELEASE (ie, abort) the innermost subtransaction, regardless 
 * of its savepoint name (if any). 
 * NB: do NOT use CommitTransactionCommand/StartTransactionCommand with this. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4158"></a><span class='Declare_Function'>RollbackAndReleaseCurrentSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4160"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unlike ReleaseCurrentSubTransaction(), this is nominally permitted 
     * during parallel operations.  That's because we may be in the master, 
     * recovering from an error thrown while we were in parallel mode.  We 
     * won't reach here in a worker, because BeginInternalSubTransaction() 
     * will have failed. 
     */ 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Must be in a subtransaction */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* These cases are invalid. */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"RollbackAndReleaseCurrentSubTransaction: unexpected state %s"</span><span class='Delimiter'>, 
</span>                 <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Abort the current subtransaction, if needed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN319"><span class='Ref_to_Proto'>AbortSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And clean it up, too */ 
</span>    <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by pop */ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a> <span class='Operator'>|| 
</span>                <a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a> <span class='Operator'>|| 
</span>                <a href="xact.c.html#LN4160"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RollbackAndReleaseCurrentSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  AbortOutOfAnyTransaction 
 * 
 *  This routine is provided for error recovery purposes.  It aborts any 
 *  active transaction or transaction block, leaving the system in a known 
 *  idle state. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4223"></a><span class='Declare_Function'>AbortOutOfAnyTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4225"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get out of any transaction or nested transaction 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Not in a transaction, do nothing */ 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We can get here after an error during transaction start 
                     * (state will be TRANS_START).  Need to clean up the 
                     * incompletely started transaction.  First, adjust the 
                     * low-level state to suppress warning message from 
                     * AbortTransaction. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN125"><span class='Ref_to_EnumConst'>TRANS_START</span></a><span class='Parentheses'>) 
</span>                        <a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Delimiter'>; 
</span>                    <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* In a transaction, so clean up */ 
</span>                <a href="xact.c.html#LN297"><span class='Ref_to_Proto'>AbortTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* AbortTransaction already done, still need Cleanup */ 
</span>                <a href="xact.c.html#LN310"><span class='Ref_to_Proto'>CleanupTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * In a subtransaction, so clean it up and abort parent too 
                 */ 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>                <a href="xact.c.html#LN319"><span class='Ref_to_Proto'>AbortSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by pop */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* As above, but AbortSubTransaction already done */ 
</span>                <a href="xact.c.html#LN320"><span class='Ref_to_Proto'>CleanupSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* changed by pop */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Should be out of all subxacts now */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN4225"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AbortOutOfAnyTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * IsTransactionBlock --- are we within a transaction block? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN4305"></a><span class='Declare_Function'>IsTransactionBlock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4307"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4307"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a> <span class='Operator'>|| </span><a href="xact.c.html#LN4307"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * IsTransactionOrTransactionBlock --- are we within either a transaction 
 * or a transaction block?  (The backend is only really "idle" when this 
 * returns false.) 
 * 
 * This should match up with IsTransactionBlock and IsTransactionState. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN4323"></a><span class='Declare_Function'>IsTransactionOrTransactionBlock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4325"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4325"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * TransactionBlockStatusCode - return status code to send in ReadyForQuery 
 */ 
</span><span class='Keyword'>char 
</span><a name="LN4337"></a><span class='Declare_Function'>TransactionBlockStatusCode</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4339"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4339"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>'I'</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* idle --- not in transaction */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>'T'</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* in transaction */ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>'E'</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* in failed transaction */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch s-&GT;blockState &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* should never get here */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"invalid transaction block state: %s"</span><span class='Delimiter'>, 
</span>         <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4339"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end TransactionBlockStatusCode &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * IsSubTransaction 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN4377"></a><span class='Declare_Function'>IsSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4379"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4379"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>&GT;= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * StartSubTransaction 
 * 
 * If you're wondering why this is separate from PushTransaction: it's because 
 * we can't conveniently do this stuff right inside DefineSavepoint.  The 
 * SAVEPOINT utility command will be executed inside a Portal, and if we 
 * muck with CurrentMemoryContext or CurrentResourceOwner then exit from 
 * the Portal will undo those settings.  So we make DefineSavepoint just 
 * push a dummy transaction block, and when control returns to the main 
 * idle loop, CommitTransactionCommand will be called, and we'll come here 
 * to finish starting the subtransaction. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4400"></a><span class='Declare_Function'>StartSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4402"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4402"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"StartSubTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4402"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4402"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN125"><span class='Ref_to_EnumConst'>TRANS_START</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize subsystems for new subtransaction 
     * 
     * must initialize resource-management stuff first 
     */ 
</span>    <a href="xact.c.html#LN328"><span class='Ref_to_Proto'>AtSubStart_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN329"><span class='Ref_to_Proto'>AtSubStart_ResourceOwner</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/async.h.html#LN44"><span class='Ref_to_Proto'>AtSubStart_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/trigger.h.html#LN191"><span class='Ref_to_Proto'>AfterTriggerBeginSubXact</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4402"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Call start-of-subxact callbacks 
     */ 
</span>    <a href="xact.c.html#LN307"><span class='Ref_to_Proto'>CallSubXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN114"><span class='Ref_to_EnumConst'>SUBXACT_EVENT_START_SUB</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4402"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN4402"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"StartSubTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CommitSubTransaction 
 * 
 *  The caller has to make sure to always reassign CurrentTransactionState 
 *  if it has a local pointer to it after calling this function. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4438"></a><span class='Declare_Function'>CommitSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4440"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"CommitSubTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"CommitSubTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pre-commit processing goes here */ 
</span> 
    <a href="xact.c.html#LN307"><span class='Ref_to_Proto'>CallSubXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN117"><span class='Ref_to_EnumConst'>SUBXACT_EVENT_PRE_COMMIT_SUB</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If in parallel mode, clean up workers and exit parallel mode. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/parallel.h.html#LN64"><span class='Ref_to_Proto'>AtEOSubXact_Parallel</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Do the actual "commit", such as it is */ 
</span>    <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN127"><span class='Ref_to_EnumConst'>TRANS_COMMIT</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must CCI to ensure commands of subtransaction are seen as done */ 
</span>    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prior to 8.4 we marked subcommit in clog at this point.  We now only 
     * perform that step, if required, as part of the atomic update of the 
     * whole transaction tree at top level commit or abort. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Post-commit cleanup */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN1438"><span class='Ref_to_Func'>AtSubCommit_childXids</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/trigger.h.html#LN192"><span class='Ref_to_Proto'>AfterTriggerEndSubXact</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/portal.h.html#LN212"><span class='Ref_to_Proto'>AtSubCommit_Portals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                        <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/be-fsstubs.h.html#LN33"><span class='Ref_to_Proto'>AtEOSubXact_LargeObject</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                            <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/async.h.html#LN45"><span class='Ref_to_Proto'>AtSubCommit_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN307"><span class='Ref_to_Proto'>CallSubXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN115"><span class='Ref_to_EnumConst'>SUBXACT_EVENT_COMMIT_SUB</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relcache.h.html#LN120"><span class='Ref_to_Proto'>AtEOSubXact_RelationCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                              <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN29"><span class='Ref_to_Proto'>AtEOSubXact_Inval</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/storage.h.html#LN31"><span class='Ref_to_Proto'>AtSubCommit_smgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The only lock we actually release here is the subtransaction XID lock. 
     */ 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/lmgr.h.html#LN72"><span class='Ref_to_Proto'>XactLockTableDelete</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Other locks should get transferred to their parent resource owner. 
     */ 
</span>    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN47"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Delimiter'>, 
</span>                         <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/spi.h.html#LN159"><span class='Ref_to_Proto'>AtEOSubXact_SPI</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/tablecmds.h.html#LN80"><span class='Ref_to_Proto'>AtEOSubXact_on_commit_actions</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                                  <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/namespace.h.html#LN150"><span class='Ref_to_Proto'>AtEOSubXact_Namespace</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                          <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/fd.h.html#LN110"><span class='Ref_to_Proto'>AtEOSubXact_Files</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                      <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/hsearch.h.html#LN142"><span class='Ref_to_Proto'>AtEOSubXact_HashTables</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1299"><span class='Ref_to_Proto'>AtEOSubXact_PgStat</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN85"><span class='Ref_to_Proto'>AtSubCommit_Snapshot</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to restore the upper transaction's read-only state, in case the 
     * upper is read-write while the child is read-only; GUC will incorrectly 
     * think it should leave the child state in place. 
     */ 
</span>    <a href="xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN186"><span class='Ref_to_Member'>prevXactReadOnly</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner.h.html#LN72"><span class='Ref_to_Proto'>ResourceOwnerDelete</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN327"><span class='Ref_to_Proto'>AtSubCommit_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4440"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN322"><span class='Ref_to_Proto'>PopTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CommitSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AbortSubTransaction 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4546"></a><span class='Declare_Function'>AbortSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4548"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prevent cancel/die interrupt while cleaning up */ 
</span>    <a href="../../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we have a valid memory context and resource owner */ 
</span>    <a href="xact.c.html#LN324"><span class='Ref_to_Proto'>AtSubAbort_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN326"><span class='Ref_to_Proto'>AtSubAbort_ResourceOwner</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release any LW locks we might be holding as quickly as possible. 
     * (Regular locks, however, must be held till we finish aborting.) 
     * Releasing LW locks is critical since we might try to grab them again 
     * while cleaning up! 
     * 
     * FIXME This may be incorrect --- Are there some locks we should keep? 
     * Buffer locks, for example?  I don't think so but I'm not sure. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN150"><span class='Ref_to_Proto'>LWLockReleaseAll</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1184"><span class='Ref_to_Proto'>pgstat_progress_end_command</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN221"><span class='Ref_to_Proto'>AbortBufferIO</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN213"><span class='Ref_to_Proto'>UnlockBuffers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset WAL record construction state */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN51"><span class='Ref_to_Proto'>XLogResetInsertion</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also clean up any open wait for lock, since the lock manager will choke 
     * if we try to wait for another lock before doing this. 
     */ 
</span>    <a href="../../../include/storage/proc.h.html#LN305"><span class='Ref_to_Proto'>LockErrorCleanup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If any timeout events are still active, make sure the timeout interrupt 
     * is scheduled.  This covers possible loss of a timeout interrupt due to 
     * longjmp'ing out of the SIGINT handler (see notes in handle_sig_alarm). 
     * We delay this till after LockErrorCleanup so that we don't uselessly 
     * reschedule lock or deadlock check timeouts. 
     */ 
</span>    <a href="../../../include/utils/timeout.h.html#LN71"><span class='Ref_to_Proto'>reschedule_timeouts</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Re-enable signals, in case we got here by longjmp'ing out of a signal 
     * handler.  We do this fairly early in the sequence so that the timeout 
     * infrastructure will be functional if needed while aborting. 
     */ 
</span>    <a href="../../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * check the current transaction state 
     */ 
</span>    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"AbortSubTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"AbortSubTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset user ID which might have been changed transiently.  (See notes in 
     * AbortTransaction.) 
     */ 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN184"><span class='Ref_to_Member'>prevUser</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN185"><span class='Ref_to_Member'>prevSecContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Exit from parallel mode, if necessary. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/parallel.h.html#LN64"><span class='Ref_to_Proto'>AtEOSubXact_Parallel</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can skip all this stuff if the subxact failed before creating a 
     * ResourceOwner... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/commands/trigger.h.html#LN192"><span class='Ref_to_Proto'>AfterTriggerEndSubXact</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/portal.h.html#LN215"><span class='Ref_to_Proto'>AtSubAbort_Portals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                           <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                           <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                           <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/libpq/be-fsstubs.h.html#LN33"><span class='Ref_to_Proto'>AtEOSubXact_LargeObject</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                                <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/commands/async.h.html#LN46"><span class='Ref_to_Proto'>AtSubAbort_Notify</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Advertise the fact that we aborted in pg_xact. */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="xact.c.html#LN314"><span class='Ref_to_Proto'>RecordTransactionAbort</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Post-abort cleanup */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
            <a href="xact.c.html#LN1697"><span class='Ref_to_Func'>AtSubAbort_childXids</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN307"><span class='Ref_to_Proto'>CallSubXactCallbacks</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN116"><span class='Ref_to_EnumConst'>SUBXACT_EVENT_ABORT_SUB</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/relcache.h.html#LN120"><span class='Ref_to_Proto'>AtEOSubXact_RelationCache</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                                  <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/inval.h.html#LN29"><span class='Ref_to_Proto'>AtEOSubXact_Inval</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN47"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/catalog/storage.h.html#LN32"><span class='Ref_to_Proto'>AtSubAbort_smgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/executor/spi.h.html#LN159"><span class='Ref_to_Proto'>AtEOSubXact_SPI</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/commands/tablecmds.h.html#LN80"><span class='Ref_to_Proto'>AtEOSubXact_on_commit_actions</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                                      <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/catalog/namespace.h.html#LN150"><span class='Ref_to_Proto'>AtEOSubXact_Namespace</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                              <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/fd.h.html#LN110"><span class='Ref_to_Proto'>AtEOSubXact_Files</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                          <a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN142"><span class='Ref_to_Proto'>AtEOSubXact_HashTables</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1299"><span class='Ref_to_Proto'>AtEOSubXact_PgStat</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN86"><span class='Ref_to_Proto'>AtSubAbort_Snapshot</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if s-&GT;curTransactionOwne... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Restore the upper transaction's read-only state, too.  This should be 
     * redundant with GUC's cleanup but we may as well do it for consistency 
     * with the commit case. 
     */ 
</span>    <a href="xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4548"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN186"><span class='Ref_to_Member'>prevXactReadOnly</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AbortSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CleanupSubTransaction 
 * 
 *  The caller has to make sure to always reassign CurrentTransactionState 
 *  if it has a local pointer to it after calling this function. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4691"></a><span class='Declare_Function'>CleanupSubTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4693"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN331"><span class='Ref_to_Proto'>ShowTransactionState</span></a><span class='Parentheses'>(</span><span class='String'>"CleanupSubTransaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"CleanupSubTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/portal.h.html#LN219"><span class='Ref_to_Proto'>AtSubCleanup_Portals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/resowner.h.html#LN72"><span class='Ref_to_Proto'>ResourceOwnerDelete</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN325"><span class='Ref_to_Proto'>AtSubCleanup_Memory</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4693"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN322"><span class='Ref_to_Proto'>PopTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CleanupSubTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PushTransaction 
 *      Create transaction state stack entry for a subtransaction 
 * 
 *  The caller has to make sure to always reassign CurrentTransactionState 
 *  if it has a local pointer to it after calling this function. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4724"></a><span class='Declare_Function'>PushTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4726"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span><a name="LN4727"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We keep subtransaction state nodes in TopTransactionContext. 
     */ 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN169"><span class='Ref_to_Struct'>TransactionStateData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Assign a subtransaction ID, watching out for counter wraparound. 
     */ 
</span>    <a href="xact.c.html#LN237"><span class='Ref_to_Global_Var'>currentSubTransactionId</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN237"><span class='Ref_to_Global_Var'>currentSubTransactionId</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN237"><span class='Ref_to_Global_Var'>currentSubTransactionId</span></a> <span class='Operator'>-= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot have more than 2^32-1 subtransactions in a transaction"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can now stack a minimally valid subtransaction without fear of 
     * failure. 
     */ 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* until assigned */ 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN237"><span class='Ref_to_Global_Var'>currentSubTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4726"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4726"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN178"><span class='Ref_to_Member'>gucNestLevel</span></a> <span class='Operator'>= </span><a href="../../../include/utils/guc.h.html#LN354"><span class='Ref_to_Proto'>NewGUCNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4726"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN174"><span class='Ref_to_Member'>savepointLevel</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN312"><span class='Ref_to_Proto'>GetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN184"><span class='Ref_to_Member'>prevUser</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN185"><span class='Ref_to_Member'>prevSecContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN186"><span class='Ref_to_Member'>prevXactReadOnly</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN189"><span class='Ref_to_Member'>parallelModeLevel</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4727"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * AbortSubTransaction and CleanupSubTransaction have to be able to cope 
     * with the subtransaction from here on out; in particular they should not 
     * assume that it necessarily has a transaction context, resource owner, 
     * or XID. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PushTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PopTransaction 
 *      Pop back to parent transaction state 
 * 
 *  The caller has to make sure to always reassign CurrentTransactionState 
 *  if it has a local pointer to it after calling this function. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4783"></a><span class='Declare_Function'>PopTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4785"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"PopTransaction while in %s state"</span><span class='Delimiter'>, 
</span>             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"PopTransaction with no parent"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Let's just make sure CurTransactionContext is good */ 
</span>    <a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN179"><span class='Ref_to_Member'>curTransactionContext</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Ditto for ResourceOwner links */ 
</span>    <a href="../../utils/resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN180"><span class='Ref_to_Member'>curTransactionOwner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Free the old child structure */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4785"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PopTransaction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * EstimateTransactionStateSpace 
 *      Estimate the amount of space that will be needed by 
 *      SerializeTransactionState.  It would be OK to overestimate slightly, 
 *      but it's simple for us to work out the precise value, so we do. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN4817"></a><span class='Declare_Function'>EstimateTransactionStateSpace</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4819"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN4820"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nxids</span> <span class='Operator'>= </span><span class='Number'>6</span><span class='Delimiter'>;</span>      <span class='Comment_Multi_Line'>/* iso level, deferrable, top & current XID, 
                                 * command counter, XID count */ 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4819"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN4819"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="xact.c.html#LN4819"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4819"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4819"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
            <a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4819"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4820"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SerializeTransactionState 
 *      Write out relevant details of our transaction state that will be 
 *      needed by a parallel worker. 
 * 
 * We need to save and restore XactDeferrable, XactIsoLevel, and the XIDs 
 * associated with this transaction.  The first eight bytes of the result 
 * contain XactDeferrable and XactIsoLevel; the next twelve bytes contain the 
 * XID of the top-level transaction, the XID of the current transaction 
 * (or, in each case, InvalidTransactionId if none), and the current command 
 * counter.  After that, the next 4 bytes contain a count of how many 
 * additional XIDs follow; this is followed by all of those XIDs one after 
 * another.  We emit the XIDs in sorted order for the convenience of the 
 * receiving process. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4850"></a><span class='Declare_Function'>SerializeTransactionState</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>maxsize</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_address</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4852"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN4853"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nxids</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN4854"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN4855"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>c</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN4856"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span><a name="LN4857"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4850"><span class='Ref_to_Parameter'>start_address</span></a><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="xact.c.html#LN73"><span class='Ref_to_Global_Var'>XactIsoLevel</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="xact.c.html#LN79"><span class='Ref_to_Global_Var'>XactDeferrable</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN4850"><span class='Ref_to_Parameter'>maxsize</span></a> <span class='Operator'>&GT;= </span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're running in a parallel worker and launching a parallel worker 
     * of our own, we can just pass along the information that was passed to 
     * us. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN4850"><span class='Ref_to_Parameter'>maxsize</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>+ </span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>], </span><a href="xact.c.html#LN108"><span class='Ref_to_Global_Var'>ParallelCurrentXids</span></a><span class='Delimiter'>, 
</span>               <a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * OK, we need to generate a sorted list of XIDs that our workers should 
     * view as current.  First, figure out how many there are. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
            <a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="xact.c.html#LN4850"><span class='Ref_to_Parameter'>maxsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy them to our scratch space. */ 
</span>    <a href="xact.c.html#LN4856"><span class='Ref_To_Local'>workspace</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Parentheses'>))</span> 
            <a href="xact.c.html#LN4856"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4854"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4856"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4854"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>, 
</span>               <a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN4854"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+= </span><a href="xact.c.html#LN4852"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN4854"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sort them. */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4856"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN94"><span class='Ref_to_Proto'>xidComparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy data into output area. */ 
</span>    <a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4857"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4855"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>], </span><a href="xact.c.html#LN4856"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4853"><span class='Ref_To_Local'>nxids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SerializeTransactionState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * StartParallelWorkerTransaction 
 *      Start a parallel worker transaction, restoring the relevant 
 *      transaction state serialized by SerializeTransactionState. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4918"></a><span class='Declare_Function'>StartParallelWorkerTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tstatespace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4920"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tstate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4918"><span class='Ref_to_Parameter'>tstatespace</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_dump/pg_backup_db.h.html#LN22"><span class='Ref_to_Proto'>StartTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN73"><span class='Ref_to_Global_Var'>XactIsoLevel</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="xact.c.html#LN79"><span class='Ref_to_Global_Var'>XactDeferrable</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <a href="xact.c.html#LN106"><span class='Ref_to_Global_Var'>XactTopTransactionId</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span>    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span>    <a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span>    <a href="xact.c.html#LN107"><span class='Ref_to_Global_Var'>nParallelCurrentXids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>]; 
</span>    <a href="xact.c.html#LN108"><span class='Ref_to_Global_Var'>ParallelCurrentXids</span></a> <span class='Operator'>= &</span><a href="xact.c.html#LN4920"><span class='Ref_To_Local'>tstate</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>]; 
</span> 
    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * EndParallelWorkerTransaction 
 *      End a parallel worker transaction. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4941"></a><span class='Declare_Function'>EndParallelWorkerTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>== </span><a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_dump/pg_backup_db.h.html#LN23"><span class='Ref_to_Proto'>CommitTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ShowTransactionState 
 *      Debug support 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4953"></a><span class='Declare_Function'>ShowTransactionState</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* skip work if message will definitely not be printed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/guc.c.html#LN450"><span class='Ref_to_Global_Var'>log_min_messages</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/utils/elog.h.html#LN19"><span class='Ref_to_Const'>DEBUG5</span></a> <span class='Operator'>|| </span><a href="../../utils/misc/guc.c.html#LN451"><span class='Ref_to_Global_Var'>client_min_messages</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/utils/elog.h.html#LN19"><span class='Ref_to_Const'>DEBUG5</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN332"><span class='Ref_to_Proto'>ShowTransactionStateRec</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4953"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ShowTransactionStateRec 
 *      Recursive subroutine for ShowTransactionState 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4965"></a><span class='Declare_Function'>ShowTransactionStateRec</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Delimiter'>, </span><a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4967"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4967"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN4973"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4967"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>", children: %u"</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4973"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="xact.c.html#LN4973"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN4973"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN4967"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" %u"</span><span class='Delimiter'>, </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN4973"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN332"><span class='Ref_to_Proto'>ShowTransactionStateRec</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN190"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* use ereport to suppress computation if msg will not be printed */ 
</span>    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN19"><span class='Ref_to_Const'>DEBUG5</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s(%d) name: %s; blockState: %s; state: %s, xid/subid/cid: %u/%u/%u%s%s"</span><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN177"><span class='Ref_to_Member'>nestingLevel</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN173"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>: </span><span class='String'>"unnamed"</span><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN333"><span class='Ref_to_Proto'>BlockStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN176"><span class='Ref_to_Member'>blockState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN334"><span class='Ref_to_Proto'>TransStateAsString</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN175"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN171"><span class='Ref_to_Member'>transactionId</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xact.c.html#LN4965"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN172"><span class='Ref_to_Member'>subTransactionId</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xact.c.html#LN238"><span class='Ref_to_Global_Var'>currentCommandId</span></a><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN239"><span class='Ref_to_Global_Var'>currentCommandIdUsed</span></a> <span class='Operator'>? </span><span class='String'>" (used)"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN4967"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN4967"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ShowTransactionStateRec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * BlockStateAsString 
 *      Debug support 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN5004"></a><span class='Declare_Function'>BlockStateAsString</span><span class='Parentheses'>(</span><a href="xact.c.html#LN138"><span class='Ref_to_Enum'>TBlockState</span></a> <span class='Declare_Parameter'>blockState</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5004"><span class='Ref_to_Parameter'>blockState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN141"><span class='Ref_to_EnumConst'>TBLOCK_DEFAULT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"DEFAULT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN142"><span class='Ref_to_EnumConst'>TBLOCK_STARTED</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"STARTED"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN145"><span class='Ref_to_EnumConst'>TBLOCK_BEGIN</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"BEGIN"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN146"><span class='Ref_to_EnumConst'>TBLOCK_INPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"INPROGRESS"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN147"><span class='Ref_to_EnumConst'>TBLOCK_PARALLEL_INPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"PARALLEL_INPROGRESS"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN148"><span class='Ref_to_EnumConst'>TBLOCK_END</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"END"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN149"><span class='Ref_to_EnumConst'>TBLOCK_ABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"ABORT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN150"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_END</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"ABORT END"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN151"><span class='Ref_to_EnumConst'>TBLOCK_ABORT_PENDING</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"ABORT PEND"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN152"><span class='Ref_to_EnumConst'>TBLOCK_PREPARE</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"PREPARE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN155"><span class='Ref_to_EnumConst'>TBLOCK_SUBBEGIN</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB BEGIN"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN156"><span class='Ref_to_EnumConst'>TBLOCK_SUBINPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB INPROGRS"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN157"><span class='Ref_to_EnumConst'>TBLOCK_SUBRELEASE</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB RELEASE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN158"><span class='Ref_to_EnumConst'>TBLOCK_SUBCOMMIT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB COMMIT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN159"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB ABORT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN160"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_END</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB ABORT END"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN161"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_PENDING</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB ABRT PEND"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN162"><span class='Ref_to_EnumConst'>TBLOCK_SUBRESTART</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB RESTART"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN163"><span class='Ref_to_EnumConst'>TBLOCK_SUBABORT_RESTART</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"SUB AB RESTRT"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch blockState &raquo; </span> 
    <span class='Control'>return</span> <span class='String'>"UNRECOGNIZED"</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BlockStateAsString &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * TransStateAsString 
 *      Debug support 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN5055"></a><span class='Declare_Function'>TransStateAsString</span><span class='Parentheses'>(</span><a href="xact.c.html#LN122"><span class='Ref_to_Enum'>TransState</span></a> <span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5055"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN124"><span class='Ref_to_EnumConst'>TRANS_DEFAULT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"DEFAULT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN125"><span class='Ref_to_EnumConst'>TRANS_START</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"START"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN126"><span class='Ref_to_EnumConst'>TRANS_INPROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"INPROGR"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN127"><span class='Ref_to_EnumConst'>TRANS_COMMIT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"COMMIT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN128"><span class='Ref_to_EnumConst'>TRANS_ABORT</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"ABORT"</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="xact.c.html#LN129"><span class='Ref_to_EnumConst'>TRANS_PREPARE</span></a><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='String'>"PREPARE"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='String'>"UNRECOGNIZED"</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TransStateAsString &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * xactGetCommittedChildren 
 * 
 * Gets the list of committed children of the current transaction.  The return 
 * value is the number of child transactions.  *ptr is set to point to an 
 * array of TransactionIds.  The array is allocated in TopTransactionContext; 
 * the caller should *not* pfree() it (this is a change from pre-8.4 code!). 
 * If there are no subxacts, *ptr is set to NULL. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN5085"></a><span class='Declare_Function'>xactGetCommittedChildren</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5087"></a>    <a href="xact.c.html#LN193"><span class='Ref_to_Typedef'>TransactionState</span></a> <span class='Declare_Local'>s</span> <span class='Operator'>= </span><a href="xact.c.html#LN231"><span class='Ref_to_Global_Var'>CurrentTransactionState</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5087"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="xact.c.html#LN5085"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Operator'>*</span><a href="xact.c.html#LN5085"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5087"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN181"><span class='Ref_to_Member'>childXids</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xact.c.html#LN5087"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="xact.c.html#LN182"><span class='Ref_to_Member'>nChildXids</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  XLOG support routines 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Log the commit record for a plain or twophase transaction commit. 
 * 
 * A 2pc commit will be emitted when twophase_xid is valid, a plain one 
 * otherwise. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN5109"></a><span class='Declare_Function'>XactLogCommitRecord</span><span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>commit_time</span><span class='Delimiter'>, 
</span><a name="LN5110"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>nsubxacts</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>subxacts</span><span class='Delimiter'>, 
</span><a name="LN5111"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>nrels</span><span class='Delimiter'>, </span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rels</span><span class='Delimiter'>, 
</span><a name="LN5112"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>nmsgs</span><span class='Delimiter'>, </span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msgs</span><span class='Delimiter'>, 
</span><a name="LN5113"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>relcacheInval</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>forceSync</span><span class='Delimiter'>, 
</span><a name="LN5114"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>xactflags</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>twophase_xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5116"></a>    <a href="../../../include/access/xact.h.html#LN254"><span class='Ref_to_Struct'>xl_xact_commit</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN5117"></a>    <a href="../../../include/access/xact.h.html#LN206"><span class='Ref_to_Struct'>xl_xact_xinfo</span></a> <span class='Declare_Local'>xl_xinfo</span><span class='Delimiter'>; 
</span><a name="LN5118"></a>    <a href="../../../include/access/xact.h.html#LN216"><span class='Ref_to_Struct'>xl_xact_dbinfo</span></a> <span class='Declare_Local'>xl_dbinfo</span><span class='Delimiter'>; 
</span><a name="LN5119"></a>    <a href="../../../include/access/xact.h.html#LN222"><span class='Ref_to_Struct'>xl_xact_subxacts</span></a> <span class='Declare_Local'>xl_subxacts</span><span class='Delimiter'>; 
</span><a name="LN5120"></a>    <a href="../../../include/access/xact.h.html#LN229"><span class='Ref_to_Struct'>xl_xact_relfilenodes</span></a> <span class='Declare_Local'>xl_relfilenodes</span><span class='Delimiter'>; 
</span><a name="LN5121"></a>    <a href="../../../include/access/xact.h.html#LN236"><span class='Ref_to_Struct'>xl_xact_invals</span></a> <span class='Declare_Local'>xl_invals</span><span class='Delimiter'>; 
</span><a name="LN5122"></a>    <a href="../../../include/access/xact.h.html#LN243"><span class='Ref_to_Struct'>xl_xact_twophase</span></a> <span class='Declare_Local'>xl_twophase</span><span class='Delimiter'>; 
</span><a name="LN5123"></a>    <a href="../../../include/access/xact.h.html#LN248"><span class='Ref_to_Struct'>xl_xact_origin</span></a> <span class='Declare_Local'>xl_origin</span><span class='Delimiter'>; 
</span> 
<a name="LN5125"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN36"><span class='Ref_to_Global_Var'>CritSectionCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* decide between a plain and 2pc commit */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5114"><span class='Ref_to_Parameter'>twophase_xid</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN5125"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN133"><span class='Ref_to_Const'>XLOG_XACT_COMMIT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="xact.c.html#LN5125"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN136"><span class='Ref_to_Const'>XLOG_XACT_COMMIT_PREPARED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First figure out and collect all the information needed */ 
</span> 
    <a href="xact.c.html#LN5116"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN256"><span class='Ref_to_Member'>xact_time</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5109"><span class='Ref_to_Parameter'>commit_time</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5113"><span class='Ref_to_Parameter'>relcacheInval</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN169"><span class='Ref_to_Const'>XACT_COMPLETION_UPDATE_RELCACHE_FILE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN261"><span class='Ref_to_Global_Var'>forceSyncCommit</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN170"><span class='Ref_to_Const'>XACT_COMPLETION_FORCE_SYNC_COMMIT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xact.c.html#LN5114"><span class='Ref_to_Parameter'>xactflags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN92"><span class='Ref_to_Const'>XACT_FLAGS_ACQUIREDACCESSEXCLUSIVELOCK</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN158"><span class='Ref_to_Const'>XACT_XINFO_HAS_AE_LOCKS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if the caller would like to ask standbys for immediate feedback 
     * once this commit is applied. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN81"><span class='Ref_to_Global_Var'>synchronous_commit</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/xact.h.html#LN63"><span class='Ref_to_EnumConst'>SYNCHRONOUS_COMMIT_REMOTE_APPLY</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN168"><span class='Ref_to_Const'>XACT_COMPLETION_APPLY_FEEDBACK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Relcache invalidations requires information about the current database 
     * and so does logical decoding. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5112"><span class='Ref_to_Parameter'>nmsgs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="../../../include/access/xlog.h.html#LN161"><span class='Ref_to_Macro'>XLogLogicalInfoActive</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN152"><span class='Ref_to_Const'>XACT_XINFO_HAS_DBINFO</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5118"><span class='Ref_To_Local'>xl_dbinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN218"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5118"><span class='Ref_To_Local'>xl_dbinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN219"><span class='Ref_to_Member'>tsId</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5110"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN153"><span class='Ref_to_Const'>XACT_XINFO_HAS_SUBXACTS</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5119"><span class='Ref_To_Local'>xl_subxacts</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN224"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5110"><span class='Ref_to_Parameter'>nsubxacts</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5111"><span class='Ref_to_Parameter'>nrels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN154"><span class='Ref_to_Const'>XACT_XINFO_HAS_RELFILENODES</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5120"><span class='Ref_To_Local'>xl_relfilenodes</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN231"><span class='Ref_to_Member'>nrels</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5111"><span class='Ref_to_Parameter'>nrels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5112"><span class='Ref_to_Parameter'>nmsgs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN155"><span class='Ref_to_Const'>XACT_XINFO_HAS_INVALS</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5121"><span class='Ref_To_Local'>xl_invals</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN238"><span class='Ref_to_Member'>nmsgs</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5112"><span class='Ref_to_Parameter'>nmsgs</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5114"><span class='Ref_to_Parameter'>twophase_xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN156"><span class='Ref_to_Const'>XACT_XINFO_HAS_TWOPHASE</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5122"><span class='Ref_To_Local'>xl_twophase</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN245"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5114"><span class='Ref_to_Parameter'>twophase_xid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* dump transaction origin information */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../replication/logical/origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a> <span class='Operator'>!= </span><a href="../../../include/replication/origin.h.html#LN33"><span class='Ref_to_Const'>InvalidRepOriginId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN157"><span class='Ref_to_Const'>XACT_XINFO_HAS_ORIGIN</span></a><span class='Delimiter'>; 
</span> 
        <a href="xact.c.html#LN5123"><span class='Ref_To_Local'>xl_origin</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN250"><span class='Ref_to_Member'>origin_lsn</span></a> <span class='Operator'>= </span><a href="../../replication/logical/origin.c.html#LN150"><span class='Ref_to_Global_Var'>replorigin_session_origin_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5123"><span class='Ref_To_Local'>xl_origin</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN251"><span class='Ref_to_Member'>origin_timestamp</span></a> <span class='Operator'>= </span><a href="../../replication/logical/origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN5125"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN146"><span class='Ref_to_Const'>XLOG_XACT_HAS_INFO</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Then include all the collected data into the commit record. */ 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5116"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN254"><span class='Ref_to_Struct'>xl_xact_commit</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN152"><span class='Ref_to_Const'>XACT_XINFO_HAS_DBINFO</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5118"><span class='Ref_To_Local'>xl_dbinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN5118"><span class='Ref_To_Local'>xl_dbinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN153"><span class='Ref_to_Const'>XACT_XINFO_HAS_SUBXACTS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5119"><span class='Ref_To_Local'>xl_subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/xact.h.html#LN227"><span class='Ref_to_Const'>MinSizeOfXactSubxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN5110"><span class='Ref_to_Parameter'>subxacts</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN5110"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN154"><span class='Ref_to_Const'>XACT_XINFO_HAS_RELFILENODES</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5120"><span class='Ref_To_Local'>xl_relfilenodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/xact.h.html#LN234"><span class='Ref_to_Const'>MinSizeOfXactRelfilenodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN5111"><span class='Ref_to_Parameter'>rels</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN5111"><span class='Ref_to_Parameter'>nrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN155"><span class='Ref_to_Const'>XACT_XINFO_HAS_INVALS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5121"><span class='Ref_To_Local'>xl_invals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN241"><span class='Ref_to_Const'>MinSizeOfXactInvals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN5112"><span class='Ref_to_Parameter'>msgs</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN5112"><span class='Ref_to_Parameter'>nmsgs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN156"><span class='Ref_to_Const'>XACT_XINFO_HAS_TWOPHASE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5122"><span class='Ref_To_Local'>xl_twophase</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN243"><span class='Ref_to_Struct'>xl_xact_twophase</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5117"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN157"><span class='Ref_to_Const'>XACT_XINFO_HAS_ORIGIN</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5123"><span class='Ref_To_Local'>xl_origin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN248"><span class='Ref_to_Struct'>xl_xact_origin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we allow filtering by xacts */ 
</span>    <a href="../../../include/access/xloginsert.h.html#LN42"><span class='Ref_to_Proto'>XLogSetRecordFlags</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN191"><span class='Ref_to_Const'>XLOG_INCLUDE_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_XACT_ID<span class='Delimiter'>, </span><a href="xact.c.html#LN5125"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XactLogCommitRecord &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Log the commit record for a plain or twophase transaction abort. 
 * 
 * A 2pc abort will be emitted when twophase_xid is valid, a plain one 
 * otherwise. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN5256"></a><span class='Declare_Function'>XactLogAbortRecord</span><span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>abort_time</span><span class='Delimiter'>, 
</span><a name="LN5257"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>nsubxacts</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>subxacts</span><span class='Delimiter'>, 
</span><a name="LN5258"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>nrels</span><span class='Delimiter'>, </span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rels</span><span class='Delimiter'>, 
</span><a name="LN5259"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>xactflags</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>twophase_xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5261"></a>    <a href="../../../include/access/xact.h.html#LN268"><span class='Ref_to_Struct'>xl_xact_abort</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span><a name="LN5262"></a>    <a href="../../../include/access/xact.h.html#LN206"><span class='Ref_to_Struct'>xl_xact_xinfo</span></a> <span class='Declare_Local'>xl_xinfo</span><span class='Delimiter'>; 
</span><a name="LN5263"></a>    <a href="../../../include/access/xact.h.html#LN222"><span class='Ref_to_Struct'>xl_xact_subxacts</span></a> <span class='Declare_Local'>xl_subxacts</span><span class='Delimiter'>; 
</span><a name="LN5264"></a>    <a href="../../../include/access/xact.h.html#LN229"><span class='Ref_to_Struct'>xl_xact_relfilenodes</span></a> <span class='Declare_Local'>xl_relfilenodes</span><span class='Delimiter'>; 
</span><a name="LN5265"></a>    <a href="../../../include/access/xact.h.html#LN243"><span class='Ref_to_Struct'>xl_xact_twophase</span></a> <span class='Declare_Local'>xl_twophase</span><span class='Delimiter'>; 
</span> 
<a name="LN5267"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN36"><span class='Ref_to_Global_Var'>CritSectionCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* decide between a plain and 2pc abort */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5259"><span class='Ref_to_Parameter'>twophase_xid</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN5267"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN135"><span class='Ref_to_Const'>XLOG_XACT_ABORT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="xact.c.html#LN5267"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN137"><span class='Ref_to_Const'>XLOG_XACT_ABORT_PREPARED</span></a><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* First figure out and collect all the information needed */ 
</span> 
    <a href="xact.c.html#LN5261"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN270"><span class='Ref_to_Member'>xact_time</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5256"><span class='Ref_to_Parameter'>abort_time</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xact.c.html#LN5259"><span class='Ref_to_Parameter'>xactflags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN92"><span class='Ref_to_Const'>XACT_FLAGS_ACQUIREDACCESSEXCLUSIVELOCK</span></a><span class='Parentheses'>))</span> 
        <a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN158"><span class='Ref_to_Const'>XACT_XINFO_HAS_AE_LOCKS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5257"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN153"><span class='Ref_to_Const'>XACT_XINFO_HAS_SUBXACTS</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5263"><span class='Ref_To_Local'>xl_subxacts</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN224"><span class='Ref_to_Member'>nsubxacts</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5257"><span class='Ref_to_Parameter'>nsubxacts</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5258"><span class='Ref_to_Parameter'>nrels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN154"><span class='Ref_to_Const'>XACT_XINFO_HAS_RELFILENODES</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5264"><span class='Ref_To_Local'>xl_relfilenodes</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN231"><span class='Ref_to_Member'>nrels</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5258"><span class='Ref_to_Parameter'>nrels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5259"><span class='Ref_to_Parameter'>twophase_xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN156"><span class='Ref_to_Const'>XACT_XINFO_HAS_TWOPHASE</span></a><span class='Delimiter'>; 
</span>        <a href="xact.c.html#LN5265"><span class='Ref_To_Local'>xl_twophase</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN245"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5259"><span class='Ref_to_Parameter'>twophase_xid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN5267"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>|= </span><a href="../../../include/access/xact.h.html#LN146"><span class='Ref_to_Const'>XLOG_XACT_HAS_INFO</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Then include all the collected data into the abort record. */ 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5261"><span class='Ref_To_Local'>xlrec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN279"><span class='Ref_to_Const'>MinSizeOfXactAbort</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN153"><span class='Ref_to_Const'>XACT_XINFO_HAS_SUBXACTS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5263"><span class='Ref_To_Local'>xl_subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/xact.h.html#LN227"><span class='Ref_to_Const'>MinSizeOfXactSubxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN5257"><span class='Ref_to_Parameter'>subxacts</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN5257"><span class='Ref_to_Parameter'>nsubxacts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN154"><span class='Ref_to_Const'>XACT_XINFO_HAS_RELFILENODES</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5264"><span class='Ref_To_Local'>xl_relfilenodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/access/xact.h.html#LN234"><span class='Ref_to_Const'>MinSizeOfXactRelfilenodes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xact.c.html#LN5258"><span class='Ref_to_Parameter'>rels</span></a><span class='Delimiter'>, 
</span>                         <a href="xact.c.html#LN5258"><span class='Ref_to_Parameter'>nrels</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5262"><span class='Ref_To_Local'>xl_xinfo</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN213"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN156"><span class='Ref_to_Const'>XACT_XINFO_HAS_TWOPHASE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="xact.c.html#LN5265"><span class='Ref_To_Local'>xl_twophase</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN243"><span class='Ref_to_Struct'>xl_xact_twophase</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_XACT_ID<span class='Delimiter'>, </span><a href="xact.c.html#LN5267"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XactLogAbortRecord &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Before 9.0 this was a fairly short function, but now it performs many 
 * actions for which the order of execution is critical. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5344"></a><span class='Declare_Function'>xact_redo_commit</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN286"><span class='Ref_to_Struct'>xl_xact_parsed_commit</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsed</span><span class='Delimiter'>, 
</span><a name="LN5345"></a>                 <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN5346"></a>                 <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, 
</span><a name="LN5347"></a>                 <a href="../../../include/access/xlogdefs.h.html#LN50"><span class='Ref_to_Typedef'>RepOriginId</span></a> <span class='Declare_Parameter'>origin_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5349"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>max_xid</span><span class='Delimiter'>; 
</span><a name="LN5350"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN5351"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>commit_time</span><span class='Delimiter'>; 
</span> 
    <a href="xact.c.html#LN5349"><span class='Ref_To_Local'>max_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN172"><span class='Ref_to_Proto'>TransactionIdLatest</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5345"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN295"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN296"><span class='Ref_to_Member'>subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure nextXid is beyond any XID mentioned in the record. 
     * 
     * We don't expect anyone else to modify nextXid, hence we don't need to 
     * hold a lock while checking this. We still acquire the lock to modify 
     * it, though. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5349"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>, 
</span>                                     <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5349"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/transam.h.html#LN47"><span class='Ref_to_Macro'>TransactionIdAdvance</span></a><span class='Parentheses'>(</span><a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(((</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN157"><span class='Ref_to_Const'>XACT_XINFO_HAS_ORIGIN</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>== 
</span>           <span class='Parentheses'>(</span><a href="xact.c.html#LN5347"><span class='Ref_to_Parameter'>origin_id</span></a> <span class='Operator'>== </span><a href="../../../include/replication/origin.h.html#LN33"><span class='Ref_to_Const'>InvalidRepOriginId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN157"><span class='Ref_to_Const'>XACT_XINFO_HAS_ORIGIN</span></a><span class='Parentheses'>) 
</span>        <a href="xact.c.html#LN5351"><span class='Ref_To_Local'>commit_time</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN307"><span class='Ref_to_Member'>origin_timestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="xact.c.html#LN5351"><span class='Ref_To_Local'>commit_time</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN288"><span class='Ref_to_Member'>xact_time</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set the transaction commit timestamp and metadata */ 
</span>    <a href="../../../include/access/commit_ts.h.html#LN24"><span class='Ref_to_Proto'>TransactionTreeSetCommitTsData</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5345"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN295"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN296"><span class='Ref_to_Member'>subxacts</span></a><span class='Delimiter'>, 
</span>                                   <a href="xact.c.html#LN5351"><span class='Ref_To_Local'>commit_time</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5347"><span class='Ref_to_Parameter'>origin_id</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlog.c.html#LN194"><span class='Ref_to_Global_Var'>standbyState</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlog.h.html#LN65"><span class='Ref_to_EnumConst'>STANDBY_DISABLED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Mark the transaction committed in pg_xact. 
         */ 
</span>        <a href="../../../include/access/transam.h.html#LN165"><span class='Ref_to_Proto'>TransactionIdCommitTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5345"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN295"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN296"><span class='Ref_to_Member'>subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If a transaction completion record arrives that has as-yet 
         * unobserved subtransactions then this will not have been fully 
         * handled by the call to RecordKnownAssignedTransactionIds() in the 
         * main recovery loop in xlog.c. So we need to do bookkeeping again to 
         * cover that case. This is confusing and it is easy to think this 
         * call is irrelevant, which has happened three times in development 
         * already. Leave it in. 
         */ 
</span>        <a href="../../../include/storage/procarray.h.html#LN71"><span class='Ref_to_Proto'>RecordKnownAssignedTransactionIds</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5349"><span class='Ref_To_Local'>max_xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Mark the transaction committed in pg_xact. We use async commit 
         * protocol during recovery to provide information on database 
         * consistency for when users try to set hint bits. It is important 
         * that we do not set hint bits until the minRecoveryPoint is past 
         * this commit record. This ensures that if we crash we don't see hint 
         * bits set on changes made by transactions that haven't yet 
         * recovered. It's unlikely but it's good to be safe. 
         */ 
</span>        <a href="../../../include/access/transam.h.html#LN166"><span class='Ref_to_Proto'>TransactionIdAsyncCommitTree</span></a><span class='Parentheses'>( 
</span>                              <a href="xact.c.html#LN5345"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN295"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN296"><span class='Ref_to_Member'>subxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5346"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We must mark clog before we update the ProcArray. 
         */ 
</span>        <a href="../../../include/storage/procarray.h.html#LN72"><span class='Ref_to_Proto'>ExpireTreeKnownAssignedTransactionIds</span></a><span class='Parentheses'>( 
</span>                          <a href="xact.c.html#LN5345"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN295"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN296"><span class='Ref_to_Member'>subxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5349"><span class='Ref_To_Local'>max_xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Send any cache invalidations attached to the commit. We must 
         * maintain the same order of invalidation then release locks as 
         * occurs in CommitTransaction(). 
         */ 
</span>        <a href="../../../include/storage/sinval.h.html#LN147"><span class='Ref_to_Proto'>ProcessCommittedInvalidationMessages</span></a><span class='Parentheses'>(</span> 
                                             <a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN302"><span class='Ref_to_Member'>msgs</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN301"><span class='Ref_to_Member'>nmsgs</span></a><span class='Delimiter'>, 
</span>                          <a href="../../../include/access/xact.h.html#LN175"><span class='Ref_to_Macro'>XactCompletionRelcacheInitFileInval</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN292"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN293"><span class='Ref_to_Member'>tsId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Release locks, if any. We do this for both two phase and normal one 
         * phase transactions. In effect we are ignoring the prepare phase and 
         * just going straight to lock release. At commit we release all locks 
         * via their top-level xid only, so no need to provide subxact list, 
         * which will save time when replaying commits. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN158"><span class='Ref_to_Const'>XACT_XINFO_HAS_AE_LOCKS</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/standby.h.html#LN49"><span class='Ref_to_Proto'>StandbyReleaseLockTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5345"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN157"><span class='Ref_to_Const'>XACT_XINFO_HAS_ORIGIN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* recover apply progress */ 
</span>        <a href="../../../include/replication/origin.h.html#LN48"><span class='Ref_to_Proto'>replorigin_advance</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5347"><span class='Ref_to_Parameter'>origin_id</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN306"><span class='Ref_to_Member'>origin_lsn</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5346"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, 
</span>                           <span class='Boolean'>false </span><span class='Comment_Multi_Line'>/* backward */ </span><span class='Delimiter'>, </span><span class='Boolean'>false </span><span class='Comment_Multi_Line'>/* WAL */ </span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure files supposed to be dropped are dropped */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN298"><span class='Ref_to_Member'>nrels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * First update minimum recovery point to cover this WAL record. Once 
         * a relation is deleted, there's no going back. The buffer manager 
         * enforces the WAL-first rule for normal updates to relation files, 
         * so that the minimum recovery point is always updated before the 
         * corresponding change in the data file is flushed to disk, but we 
         * have to do the same here since we're bypassing the buffer manager. 
         * 
         * Doing this before deleting the files means that if a deletion fails 
         * for some reason, you cannot start up the system even after restart, 
         * until you fix the underlying situation so that the deletion will 
         * succeed. Alternatively, we could update the minimum recovery point 
         * after deletion, but that would leave a small window where the 
         * WAL-first rule would be violated. 
         */ 
</span>        <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5346"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5350"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xact.c.html#LN5350"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN298"><span class='Ref_to_Member'>nrels</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN5350"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN5471"></a>            <a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Local'>srel</span> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN83"><span class='Ref_to_Proto'>smgropen</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN299"><span class='Ref_to_Member'>xnodes</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN5350"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN5472"></a>            <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>fork</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5472"><span class='Ref_To_Local'>fork</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xact.c.html#LN5472"><span class='Ref_To_Local'>fork</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN5472"><span class='Ref_To_Local'>fork</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="../../../include/access/xlogutils.h.html#LN20"><span class='Ref_to_Proto'>XLogDropRelation</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN299"><span class='Ref_to_Member'>xnodes</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN5350"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="xact.c.html#LN5472"><span class='Ref_To_Local'>fork</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/smgr.h.html#LN91"><span class='Ref_to_Proto'>smgrdounlink</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5471"><span class='Ref_To_Local'>srel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/smgr.h.html#LN87"><span class='Ref_to_Proto'>smgrclose</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5471"><span class='Ref_To_Local'>srel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsed-&GT;nrels&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We issue an XLogFlush() for the same reason we emit ForceSyncCommit() 
     * in normal operation. For example, in CREATE DATABASE, we copy all files 
     * from the template database, and then commit the transaction. If we 
     * crash after all the files have been copied but before the commit, you 
     * have files in the data directory without an entry in pg_database. To 
     * minimize the window for that, we use ForceSyncCommit() to rush the 
     * commit record to disk as quick as possible. We have the same window 
     * during recovery, and forcing an XLogFlush() (which updates 
     * minRecoveryPoint during recovery) helps to reduce that problem window, 
     * for any user that requested ForceSyncCommit(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN177"><span class='Ref_to_Macro'>XactCompletionForceSyncCommit</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5346"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If asked by the primary (because someone is waiting for a synchronous 
     * commit = remote_apply), we will need to ask walreceiver to send a reply 
     * immediately. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN173"><span class='Ref_to_Macro'>XactCompletionApplyFeedback</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5344"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN290"><span class='Ref_to_Member'>xinfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/access/xlog.h.html#LN284"><span class='Ref_to_Proto'>XLogRequestWalReceiverReply</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xact_redo_commit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Be careful with the order of execution, as with xact_redo_commit(). 
 * The two functions are similar but differ in key places. 
 * 
 * Note also that an abort can be for a subtransaction and its children, 
 * not just for a top level abort. That means we have to consider 
 * topxid != xid, whereas in commit we would find topxid == xid always 
 * because subtransaction commit is never WAL logged. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5515"></a><span class='Declare_Function'>xact_redo_abort</span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN310"><span class='Ref_to_Struct'>xl_xact_parsed_abort</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsed</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5517"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN5518"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>max_xid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure nextXid is beyond any XID mentioned in the record. 
     * 
     * We don't expect anyone else to modify nextXid, hence we don't need to 
     * hold a lock while checking this. We still acquire the lock to modify 
     * it, though. 
     */ 
</span>    <a href="xact.c.html#LN5518"><span class='Ref_To_Local'>max_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN172"><span class='Ref_to_Proto'>TransactionIdLatest</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, 
</span>                                  <a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN315"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, 
</span>                                  <a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN316"><span class='Ref_to_Member'>subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5518"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>, 
</span>                                     <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a> <span class='Operator'>= </span><a href="xact.c.html#LN5518"><span class='Ref_To_Local'>max_xid</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/transam.h.html#LN47"><span class='Ref_to_Macro'>TransactionIdAdvance</span></a><span class='Parentheses'>(</span><a href="varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/transam.h.html#LN116"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>XidGenLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlog.c.html#LN194"><span class='Ref_to_Global_Var'>standbyState</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlog.h.html#LN65"><span class='Ref_to_EnumConst'>STANDBY_DISABLED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Mark the transaction aborted in pg_xact, no need for async stuff */ 
</span>        <a href="../../../include/access/transam.h.html#LN167"><span class='Ref_to_Proto'>TransactionIdAbortTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN315"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN316"><span class='Ref_to_Member'>subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If a transaction completion record arrives that has as-yet 
         * unobserved subtransactions then this will not have been fully 
         * handled by the call to RecordKnownAssignedTransactionIds() in the 
         * main recovery loop in xlog.c. So we need to do bookkeeping again to 
         * cover that case. This is confusing and it is easy to think this 
         * call is irrelevant, which has happened three times in development 
         * already. Leave it in. 
         */ 
</span>        <a href="../../../include/storage/procarray.h.html#LN71"><span class='Ref_to_Proto'>RecordKnownAssignedTransactionIds</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5518"><span class='Ref_To_Local'>max_xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark the transaction aborted in pg_xact, no need for async stuff */ 
</span>        <a href="../../../include/access/transam.h.html#LN167"><span class='Ref_to_Proto'>TransactionIdAbortTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN315"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN316"><span class='Ref_to_Member'>subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We must update the ProcArray after we have marked clog. 
         */ 
</span>        <a href="../../../include/storage/procarray.h.html#LN72"><span class='Ref_to_Proto'>ExpireTreeKnownAssignedTransactionIds</span></a><span class='Parentheses'>( 
</span>                          <a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN315"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN316"><span class='Ref_to_Member'>subxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5518"><span class='Ref_To_Local'>max_xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * There are no flat files that need updating, nor invalidation 
         * messages to send or undo. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Release locks, if any. There are no invalidations to send. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN313"><span class='Ref_to_Member'>xinfo</span></a> <span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN158"><span class='Ref_to_Const'>XACT_XINFO_HAS_AE_LOCKS</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/standby.h.html#LN49"><span class='Ref_to_Proto'>StandbyReleaseLockTree</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN315"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN316"><span class='Ref_to_Member'>subxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Make sure files supposed to be dropped are dropped */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5517"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xact.c.html#LN5517"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN318"><span class='Ref_to_Member'>nrels</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN5517"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5582"></a>        <a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Local'>srel</span> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN83"><span class='Ref_to_Proto'>smgropen</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN319"><span class='Ref_to_Member'>xnodes</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN5517"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN5583"></a>        <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>fork</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5583"><span class='Ref_To_Local'>fork</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xact.c.html#LN5583"><span class='Ref_To_Local'>fork</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="xact.c.html#LN5583"><span class='Ref_To_Local'>fork</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xlogutils.h.html#LN20"><span class='Ref_to_Proto'>XLogDropRelation</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5515"><span class='Ref_to_Parameter'>parsed</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN319"><span class='Ref_to_Member'>xnodes</span></a><span class='Delimiter'>[</span><a href="xact.c.html#LN5517"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="xact.c.html#LN5583"><span class='Ref_To_Local'>fork</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN91"><span class='Ref_to_Proto'>smgrdounlink</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5582"><span class='Ref_To_Local'>srel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN87"><span class='Ref_to_Proto'>smgrclose</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5582"><span class='Ref_To_Local'>srel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end xact_redo_abort &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN5593"></a><span class='Declare_Function'>xact_redo</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5595"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="../../../include/access/xact.h.html#LN143"><span class='Ref_to_Const'>XLOG_XACT_OPMASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Backup blocks are not used in xact records */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlogreader.h.html#LN221"><span class='Ref_to_Macro'>XLogRecHasAnyBlockRefs</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN133"><span class='Ref_to_Const'>XLOG_XACT_COMMIT</span></a> <span class='Operator'>|| </span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN136"><span class='Ref_to_Const'>XLOG_XACT_COMMIT_PREPARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5602"></a>        <a href="../../../include/access/xact.h.html#LN254"><span class='Ref_to_Struct'>xl_xact_commit</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN254"><span class='Ref_to_Struct'>xl_xact_commit</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN5603"></a>        <a href="../../../include/access/xact.h.html#LN286"><span class='Ref_to_Struct'>xl_xact_parsed_commit</span></a> <span class='Declare_Local'>parsed</span><span class='Delimiter'>; 
</span> 
        <a href="../rmgrdesc/xactdesc.c.html#LN33"><span class='Ref_to_Func'>ParseCommitRecord</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="xact.c.html#LN5602"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN133"><span class='Ref_to_Const'>XLOG_XACT_COMMIT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN304"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN5343"><span class='Ref_to_Func'>xact_redo_commit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN218"><span class='Ref_to_Macro'>XLogRecGetOrigin</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN304"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN5343"><span class='Ref_to_Func'>xact_redo_commit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN304"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Delimiter'>, 
</span>                             <a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN218"><span class='Ref_to_Macro'>XLogRecGetOrigin</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Delete TwoPhaseState gxact entry and/or 2PC file. */ 
</span>            <a href="../../../include/access/twophase.h.html#LN57"><span class='Ref_to_Proto'>PrepareRedoRemove</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5603"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN304"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_XACT_COMMI... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN135"><span class='Ref_to_Const'>XLOG_XACT_ABORT</span></a> <span class='Operator'>|| </span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN137"><span class='Ref_to_Const'>XLOG_XACT_ABORT_PREPARED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5626"></a>        <a href="../../../include/access/xact.h.html#LN268"><span class='Ref_to_Struct'>xl_xact_abort</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN268"><span class='Ref_to_Struct'>xl_xact_abort</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN5627"></a>        <a href="../../../include/access/xact.h.html#LN310"><span class='Ref_to_Struct'>xl_xact_parsed_abort</span></a> <span class='Declare_Local'>parsed</span><span class='Delimiter'>; 
</span> 
        <a href="../rmgrdesc/xactdesc.c.html#LN120"><span class='Ref_to_Func'>ParseAbortRecord</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="xact.c.html#LN5626"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN135"><span class='Ref_to_Const'>XLOG_XACT_ABORT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN321"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN5514"><span class='Ref_to_Func'>xact_redo_abort</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlogreader.h.html#LN217"><span class='Ref_to_Macro'>XLogRecGetXid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN321"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xact.c.html#LN5514"><span class='Ref_to_Func'>xact_redo_abort</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN321"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Delete TwoPhaseState gxact entry and/or 2PC file. */ 
</span>            <a href="../../../include/access/twophase.h.html#LN57"><span class='Ref_to_Proto'>PrepareRedoRemove</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5627"><span class='Ref_To_Local'>parsed</span></a><span class='Operator'>.</span><a href="../../../include/access/xact.h.html#LN321"><span class='Ref_to_Member'>twophase_xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_XACT_ABORT... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN134"><span class='Ref_to_Const'>XLOG_XACT_PREPARE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Store xid and start/end pointers of the WAL record in TwoPhaseState 
         * gxact entry. 
         */ 
</span>        <a href="../../../include/access/twophase.h.html#LN55"><span class='Ref_to_Proto'>PrepareRedoAdd</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Delimiter'>, 
</span>                       <a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN138"><span class='Ref_to_Const'>XLOG_XACT_ASSIGNMENT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5658"></a>        <a href="../../../include/access/xact.h.html#LN180"><span class='Ref_to_Struct'>xl_xact_assignment</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN180"><span class='Ref_to_Struct'>xl_xact_assignment</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5593"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlog.c.html#LN194"><span class='Ref_to_Global_Var'>standbyState</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/xlog.h.html#LN66"><span class='Ref_to_EnumConst'>STANDBY_INITIALIZED</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/procarray.h.html#LN68"><span class='Ref_to_Proto'>ProcArrayApplyXidAssignment</span></a><span class='Parentheses'>(</span><a href="xact.c.html#LN5658"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN182"><span class='Ref_to_Member'>xtop</span></a><span class='Delimiter'>, 
</span>                                        <a href="xact.c.html#LN5658"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN183"><span class='Ref_to_Member'>nsubxacts</span></a><span class='Delimiter'>, </span><a href="xact.c.html#LN5658"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xact.h.html#LN184"><span class='Ref_to_Member'>xsub</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"xact_redo: unknown op code %u"</span><span class='Delimiter'>, </span><a href="xact.c.html#LN5595"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xact_redo &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>