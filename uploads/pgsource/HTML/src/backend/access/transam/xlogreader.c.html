<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\access\transam\xlogreader.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\access\transam\xlogreader.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:31 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * xlogreader.c 
 *      Generic XLog reading facility 
 * 
 * Portions Copyright (c) 2013-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *      src/backend/access/transam/xlogreader.c 
 * 
 * NOTES 
 *      See xlogreader.h for more notes on this facility. 
 * 
 *      This file is compiled as both front-end and backend code, so it 
 *      may not use ereport, server-defined static variables, etc. 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogrecord.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogreader.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_control.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/pg_lzcompress.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/origin.h"</span> 
 
<a name="LN27"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>allocate_recordbuf</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>reclength</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN29"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ValidXLogPageHeader</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recptr</span><span class='Delimiter'>, 
</span><a name="LN30"></a>                    <a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a> <span class='Declare_Parameter'>hdr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN31"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ValidXLogRecordHeader</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>RecPtr</span><span class='Delimiter'>, 
</span><a name="LN32"></a>                 <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>PrevRecPtr</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>randAccess</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN33"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ValidXLogRecord</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, 
</span><a name="LN34"></a>                <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN35"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>ReadPageInternal</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>pageptr</span><span class='Delimiter'>, 
</span><a name="LN36"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>reqLen</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN37"></a><span class='Keyword'>static void </span><span class='Declare_Function'>report_invalid_record</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fmt</span><span class='Delimiter'>,</span><span class='Operator'>...</span><span class='Parentheses'>) </span><a href="../../../port/win32security.c.html#LN25"><span class='Ref_to_Func'>pg_attribute_printf</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void </span><a href="xlogreader.c.html#LN985"><span class='Ref_to_Func'>ResetDecoder</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* size of the buffer allocated for error message. */ 
</span><span class='Keyword'>#define </span>MAX_ERRORMSG_LEN <span class='Number'>1000</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Construct a string in state-&GT;errormsg_buf explaining what's wrong with 
 * the current record being read. 
 */ 
</span><span class='Keyword'>static void 
</span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>fmt</span></a><span class='Delimiter'>,</span><span class='Operator'>...</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN51"></a>    va_list     <span class='Declare_Local'>args</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>fmt</span></a> <span class='Operator'>= </span>_<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>fmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../pl/plperl/ppport.h.html#LN5587"><span class='Ref_to_Proto'>va_start</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN51"><span class='Ref_To_Local'>args</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>fmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN59"><span class='Ref_to_Macro'>vsnprintf</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Delimiter'>, </span>MAX_ERRORMSG_LEN<span class='Delimiter'>, </span><a href="xlogreader.c.html#LN37"><span class='Ref_to_Parameter'>fmt</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN51"><span class='Ref_To_Local'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../pl/plperl/ppport.h.html#LN5589"><span class='Ref_to_Proto'>va_end</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN51"><span class='Ref_To_Local'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end report_invalid_record &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate and initialize a new XLogReader. 
 * 
 * Returns NULL if the xlogreader couldn't be allocated. 
 */ 
</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>* 
</span><a name="LN66"></a><span class='Declare_Function'>XLogReaderAllocate</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN32"><span class='Ref_to_Typedef'>XLogPageReadCB</span></a> <span class='Declare_Parameter'>pagereadfunc</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>private_data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN68"></a>    <a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN35"><span class='Ref_to_Proto'>palloc_extended</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/common/fe_memutils.h.html#LN17"><span class='Ref_to_Const'>MCXT_ALLOC_NO_OOM</span></a> <span class='Operator'>| </span><a href="../../../include/common/fe_memutils.h.html#LN18"><span class='Ref_to_Const'>MCXT_ALLOC_ZERO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN135"><span class='Ref_to_Member'>max_block_id</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Permanently allocate readBuf.  We do it this way, rather than just 
     * making a static array, for two reasons: (1) no need to waste the 
     * storage in most instantiations of the backend; (2) a static char array 
     * isn't guaranteed to have any particular alignment, whereas 
     * palloc_extended() will provide MAXALIGN'd storage. 
     */ 
</span>    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN35"><span class='Ref_to_Proto'>palloc_extended</span></a><span class='Parentheses'>(</span>XLOG_BLCKSZ<span class='Delimiter'>, 
</span>                                              <a href="../../../include/common/fe_memutils.h.html#LN17"><span class='Ref_to_Const'>MCXT_ALLOC_NO_OOM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN96"><span class='Ref_to_Member'>read_page</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN66"><span class='Ref_to_Parameter'>pagereadfunc</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* system_identifier initialized to zeroes above */ 
</span>    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN107"><span class='Ref_to_Member'>private_data</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN66"><span class='Ref_to_Parameter'>private_data</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ReadRecPtr and EndRecPtr initialized to zeroes above */ 
</span>    <span class='Comment_Multi_Line'>/* readSegNo, readOff, readLen, readPageTLI initialized to zeroes above */ 
</span>    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN35"><span class='Ref_to_Proto'>palloc_extended</span></a><span class='Parentheses'>(</span>MAX_ERRORMSG_LEN <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                          <a href="../../../include/common/fe_memutils.h.html#LN17"><span class='Ref_to_Const'>MCXT_ALLOC_NO_OOM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate an initial readRecordBuf of minimal size, which can later be 
     * enlarged if necessary. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN27"><span class='Ref_to_Proto'>allocate_recordbuf</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="xlogreader.c.html#LN68"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XLogReaderAllocate &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN124"></a><span class='Declare_Function'>XLogReaderFree</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN126"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>block_id</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN126"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xlogreader.c.html#LN126"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/xlogrecord.h.html#LN220"><span class='Ref_to_Const'>XLR_MAX_BLOCK_ID</span></a><span class='Delimiter'>; </span><a href="xlogreader.c.html#LN126"><span class='Ref_To_Local'>block_id</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN126"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN126"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN124"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Allocate readRecordBuf to fit a record of at least the given length. 
 * Returns true if successful, false if out of memory. 
 * 
 * readRecordBufSize is set to the new buffer size. 
 * 
 * To avoid useless small increases, round its size to a multiple of 
 * XLOG_BLCKSZ, and make sure it's at least 5*Max(BLCKSZ, XLOG_BLCKSZ) to start 
 * with.  (That is enough for all "normal" records, but very large commit or 
 * abort records might need more space.) 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN155"></a><span class='Declare_Function'>allocate_recordbuf</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>reclength</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN157"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newSize</span> <span class='Operator'>= </span><a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>reclength</span></a><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN157"><span class='Ref_To_Local'>newSize</span></a> <span class='Operator'>+= </span>XLOG_BLCKSZ <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN157"><span class='Ref_To_Local'>newSize</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN157"><span class='Ref_To_Local'>newSize</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN157"><span class='Ref_To_Local'>newSize</span></a><span class='Delimiter'>, </span><span class='Number'>5</span> <span class='Operator'>* </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN35"><span class='Ref_to_Proto'>palloc_extended</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN157"><span class='Ref_To_Local'>newSize</span></a><span class='Delimiter'>, </span><a href="../../../include/common/fe_memutils.h.html#LN17"><span class='Ref_to_Const'>MCXT_ALLOC_NO_OOM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN184"><span class='Ref_to_Member'>readRecordBufSize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="xlogreader.c.html#LN155"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN184"><span class='Ref_to_Member'>readRecordBufSize</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN157"><span class='Ref_To_Local'>newSize</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end allocate_recordbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Attempt to read an XLOG record. 
 * 
 * If RecPtr is valid, try to read a record at that position.  Otherwise 
 * try to read a record just after the last one previously read. 
 * 
 * If the read_page callback fails to read the requested data, NULL is 
 * returned.  The callback is expected to have reported the error; errormsg 
 * is set to NULL. 
 * 
 * If the reading fails for some other reason, NULL is also returned, and 
 * *errormsg is set to a string with details of the failure. 
 * 
 * The returned pointer (or *errormsg) points to an internal buffer that's 
 * valid until the next call to XLogReadRecord. 
 */ 
</span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>* 
</span><a name="LN192"></a><span class='Declare_Function'>XLogReadRecord</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>RecPtr</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>errormsg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN194"></a>    <a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>record</span><span class='Delimiter'>; 
</span><a name="LN195"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>targetPagePtr</span><span class='Delimiter'>; 
</span><a name="LN196"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>randAccess</span><span class='Delimiter'>; 
</span><a name="LN197"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>len</span><span class='Delimiter'>, 
</span><a name="LN198"></a>                <span class='Declare_Local'>total_len</span><span class='Delimiter'>; 
</span><a name="LN199"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>targetRecOff</span><span class='Delimiter'>; 
</span><a name="LN200"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>pageHeaderSize</span><span class='Delimiter'>; 
</span><a name="LN201"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>gotheader</span><span class='Delimiter'>; 
</span><a name="LN202"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>readOff</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * randAccess indicates whether to verify the previous-record pointer of 
     * the record we're reading.  We only do this if we're reading 
     * sequentially, which is what we initially assume. 
     */ 
</span>    <a href="xlogreader.c.html#LN196"><span class='Ref_To_Local'>randAccess</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* reset error state */ 
</span>    <span class='Operator'>*</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>errormsg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN985"><span class='Ref_to_Func'>ResetDecoder</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No explicit start point; read the record after the one we just read */ 
</span>        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>            <a href="xlogreader.c.html#LN196"><span class='Ref_To_Local'>randAccess</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * RecPtr is pointing to end+1 of the previous WAL record.  If we're 
         * at a page boundary, no more records can fit on the current page. We 
         * must skip over the page header, but we can't do that until we've 
         * read in the page, since the header size is variable. 
         */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Caller supplied a position to start at. 
         * 
         * In this case, the passed-in record pointer should already be 
         * pointing to a valid record starting position. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN124"><span class='Ref_to_Macro'>XRecOffIsValid</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN196"><span class='Ref_To_Local'>randAccess</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN162"><span class='Ref_to_Member'>currRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the page containing the record into state-&GT;readBuf. Request enough 
     * byte to cover the whole record header, or at least the part of it that 
     * fits on the same page. 
     */ 
</span>    <a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                               <a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, 
</span>                          <a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>+ </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ReadPageInternal always returns at least the page header, so we can 
     * examine it now. 
     */ 
</span>    <a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlog_internal.h.html#LN84"><span class='Ref_to_Macro'>XLogPageHeaderSize</span></a><span class='Parentheses'>((</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * At page start, so skip over page header. 
         */ 
</span>        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='String'>"invalid record offset at %X/%X"</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((((</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>xlp_info <span class='Operator'>& </span><a href="../../../include/access/xlog_internal.h.html#LN76"><span class='Ref_to_Const'>XLP_FIRST_IS_CONTRECORD</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>        <a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>== </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='String'>"contrecord is requested by %X/%X"</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* ReadPageInternal has verified the page header */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read the record length. 
     * 
     * NB: Even though we use an XLogRecord pointer here, the whole record 
     * header might not fit on this page. xl_tot_len is the first field of the 
     * struct, so it must be on this page (the records are MAXALIGNed), but we 
     * cannot access any other fields until we've verified that we got the 
     * whole header. 
     */ 
</span>    <a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN42"><span class='Ref_to_Member'>xl_tot_len</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the whole record header is on this page, validate it immediately. 
     * Otherwise do just a basic sanity check on xl_tot_len, and validate the 
     * rest of the header after reading it from the next page.  The xl_tot_len 
     * check is necessary here to ensure that we enter the "Need to reassemble 
     * record" code path below; otherwise we might fail to apply 
     * ValidXLogRecordHeader at all. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>&LT;= </span>XLOG_BLCKSZ <span class='Operator'>- </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN31"><span class='Ref_to_Proto'>ValidXLogRecordHeader</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, 
</span>                                   <a href="xlogreader.c.html#LN196"><span class='Ref_To_Local'>randAccess</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN201"><span class='Ref_To_Local'>gotheader</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* XXX: more validation should be done here */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"invalid record length at %X/%X: wanted %u, got %u"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="xlogreader.c.html#LN201"><span class='Ref_To_Local'>gotheader</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Enlarge readRecordBuf as needed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a> <span class='Operator'>&GT; </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN184"><span class='Ref_to_Member'>readRecordBufSize</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="xlogreader.c.html#LN27"><span class='Ref_to_Proto'>allocate_recordbuf</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We treat this as a "bogus data" condition */ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><span class='String'>"record length %u at %X/%X too long"</span><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>XLOG_BLCKSZ <span class='Operator'>- </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a> <span class='Operator'>&GT; </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Need to reassemble record */ 
</span><a name="LN349"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>contdata</span><span class='Delimiter'>; 
</span><a name="LN350"></a>        <a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a> <span class='Declare_Local'>pageHeader</span><span class='Delimiter'>; 
</span><a name="LN351"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN352"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>gotlen</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Copy the first fragment of the record from the first page. */ 
</span>        memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Delimiter'>, 
</span>               <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Delimiter'>, </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN351"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN352"><span class='Ref_To_Local'>gotlen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>do</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Calculate pointer to beginning of next page */ 
</span>            <a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>+= </span>XLOG_BLCKSZ<span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Wait for the next page to become available */ 
</span>            <a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a> <span class='Operator'>- </span><a href="xlogreader.c.html#LN352"><span class='Ref_To_Local'>gotlen</span></a> <span class='Operator'>+ </span><a href="../../../include/access/xlog_internal.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogShortPHD</span></a><span class='Delimiter'>, 
</span>                                     XLOG_BLCKSZ<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogShortPHD</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Check that the continuation on next page looks valid */ 
</span>            <a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN38"><span class='Ref_to_Member'>xlp_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlog_internal.h.html#LN76"><span class='Ref_to_Const'>XLP_FIRST_IS_CONTRECORD</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                      <span class='String'>"there is no contrecord flag at %X/%X"</span><span class='Delimiter'>, 
</span>                                   <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Cross-check that xlp_rem_len agrees with how much of the record 
             * we expect there to be left. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                <a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN352"><span class='Ref_To_Local'>gotlen</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                      <span class='String'>"invalid contrecord length %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                      <a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a><span class='Delimiter'>, 
</span>                                   <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Append the continuation from this page to the buffer */ 
</span>            <a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlog_internal.h.html#LN84"><span class='Ref_to_Macro'>XLogPageHeaderSize</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Parentheses'>) 
</span>                <a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, 
</span>                                           <a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN349"><span class='Ref_To_Local'>contdata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>XLOG_BLCKSZ <span class='Operator'>- </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>                <a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>                <a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, 
</span>                                           <a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN351"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN349"><span class='Ref_To_Local'>contdata</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN351"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN352"><span class='Ref_To_Local'>gotlen</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN197"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If we just reassembled the record header, validate it. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN201"><span class='Ref_To_Local'>gotheader</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN31"><span class='Ref_to_Proto'>ValidXLogRecordHeader</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Delimiter'>, 
</span>                                           <a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN196"><span class='Ref_To_Local'>randAccess</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN201"><span class='Ref_To_Local'>gotheader</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN352"><span class='Ref_To_Local'>gotlen</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN201"><span class='Ref_To_Local'>gotheader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN33"><span class='Ref_to_Proto'>ValidXLogRecord</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlog_internal.h.html#LN84"><span class='Ref_to_Macro'>XLogPageHeaderSize</span></a><span class='Parentheses'>((</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN200"><span class='Ref_To_Local'>pageHeaderSize</span></a> 
            <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN350"><span class='Ref_To_Local'>pageHeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if total_len&GT;len &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Wait for the record data to become available */ 
</span>        <a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN195"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN199"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN202"><span class='Ref_To_Local'>readOff</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Record does not cross a page boundary */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN33"><span class='Ref_to_Proto'>ValidXLogRecord</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN477"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN183"><span class='Ref_to_Member'>readRecordBuf</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN198"><span class='Ref_To_Local'>total_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Special processing if it's an XLOG SWITCH record 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN46"><span class='Ref_to_Member'>xl_rmid</span></a> <span class='Operator'>== </span>RM_XLOG_ID <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN45"><span class='Ref_to_Member'>xl_info</span></a> <span class='Operator'>& ~</span><a href="../../../include/access/xlogrecord.h.html#LN61"><span class='Ref_to_Const'>XLR_INFO_MASK</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_control.h.html#LN69"><span class='Ref_to_Const'>XLOG_SWITCH</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Pretend it extends to end of segment */ 
</span>        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a> <span class='Operator'>+= </span><a href="../../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a> <span class='Operator'>-= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a> <span class='Operator'>% </span><a href="../../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN210"><span class='Ref_to_Proto'>DecodeXLogRecord</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>errormsg</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="xlogreader.c.html#LN194"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN477"></a><span class='Label'>err</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Invalidate the read state. We might read from a different source after 
     * failure. 
     */ 
</span>    <a href="../../../include/access/xlogreader.h.html#LN202"><span class='Ref_to_Proto'>XLogReaderInvalReadState</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>errormsg</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN192"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XLogReadRecord &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read a single xlog page including at least [pageptr, reqLen] of valid data 
 * via the read_page() callback. 
 * 
 * Returns -1 if the required page cannot be read for some reason; errormsg_buf 
 * is set in that case (unless the error occurs in the read_page callback). 
 * 
 * We fetch the page from a reader-local cache if we know we have the required 
 * data and if there hasn't been any error since caching the data. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN502"></a><span class='Declare_Function'>ReadPageInternal</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>pageptr</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>reqLen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN504"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>readLen</span><span class='Delimiter'>; 
</span><a name="LN505"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>targetPageOff</span><span class='Delimiter'>; 
</span><a name="LN506"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>targetSegNo</span><span class='Delimiter'>; 
</span><a name="LN507"></a>    <a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a> <span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN506"><span class='Ref_To_Local'>targetSegNo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN505"><span class='Ref_To_Local'>targetPageOff</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a> <span class='Operator'>% </span><a href="../../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check whether we have all the requested data already */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN506"><span class='Ref_To_Local'>targetSegNo</span></a> <span class='Operator'>== </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN150"><span class='Ref_to_Member'>readSegNo</span></a> <span class='Operator'>&& </span><a href="xlogreader.c.html#LN505"><span class='Ref_To_Local'>targetPageOff</span></a> <span class='Operator'>== </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN151"><span class='Ref_to_Member'>readOff</span></a> <span class='Operator'>&& 
</span>        <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>reqLen</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN147"><span class='Ref_to_Member'>readLen</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN147"><span class='Ref_to_Member'>readLen</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Data is not in our buffer. 
     * 
     * Every time we actually read the page, even if we looked at parts of it 
     * before, we need to do verification as the read_page callback might now 
     * be rereading data from a different source. 
     * 
     * Whenever switching to a new WAL segment, we read the first page of the 
     * file and validate its header, even if that's not where the target 
     * record is.  This is so that we can check the additional identification 
     * info that is present in the first page's "long" header. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN506"><span class='Ref_To_Local'>targetSegNo</span></a> <span class='Operator'>!= </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN150"><span class='Ref_to_Member'>readSegNo</span></a> <span class='Operator'>&& </span><a href="xlogreader.c.html#LN505"><span class='Ref_To_Local'>targetPageOff</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN533"></a>        <a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a> <span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN534"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>targetSegmentPtr</span> <span class='Operator'>= </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a> <span class='Operator'>- </span><a href="xlogreader.c.html#LN505"><span class='Ref_To_Local'>targetPageOff</span></a><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN96"><span class='Ref_to_Member'>read_page</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN534"><span class='Ref_To_Local'>targetSegmentPtr</span></a><span class='Delimiter'>, </span>XLOG_BLCKSZ<span class='Delimiter'>, 
</span>                                   <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN162"><span class='Ref_to_Member'>currRecPtr</span></a><span class='Delimiter'>, 
</span>                                   <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN594"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we can be sure to have enough WAL available, we scrolled back */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>== </span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN533"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN29"><span class='Ref_to_Proto'>ValidXLogPageHeader</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN534"><span class='Ref_To_Local'>targetSegmentPtr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN533"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN594"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, read the requested data length, but at least a short page header 
     * so that we can validate it. 
     */ 
</span>    <a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN96"><span class='Ref_to_Member'>read_page</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a><span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>reqLen</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlog_internal.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogShortPHD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN162"><span class='Ref_to_Member'>currRecPtr</span></a><span class='Delimiter'>, 
</span>                               <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN594"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT;= </span>XLOG_BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do we have enough data to check the header length? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/xlog_internal.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogShortPHD</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN594"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&GT;= </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>reqLen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN507"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* still not enough */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/xlog_internal.h.html#LN84"><span class='Ref_to_Macro'>XLogPageHeaderSize</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN507"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN96"><span class='Ref_to_Member'>read_page</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlog_internal.h.html#LN84"><span class='Ref_to_Macro'>XLogPageHeaderSize</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN507"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN162"><span class='Ref_to_Member'>currRecPtr</span></a><span class='Delimiter'>, 
</span>                                   <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN594"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we know we have the full header, validate it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN29"><span class='Ref_to_Proto'>ValidXLogPageHeader</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>pageptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN507"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN594"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* update read state information */ 
</span>    <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN150"><span class='Ref_to_Member'>readSegNo</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN506"><span class='Ref_To_Local'>targetSegNo</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN151"><span class='Ref_to_Member'>readOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN505"><span class='Ref_To_Local'>targetPageOff</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN147"><span class='Ref_to_Member'>readLen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xlogreader.c.html#LN504"><span class='Ref_To_Local'>readLen</span></a><span class='Delimiter'>; 
</span> 
<a name="LN594"></a><span class='Label'>err</span><span class='Operator'>: 
</span>    <a href="../../../include/access/xlogreader.h.html#LN202"><span class='Ref_to_Proto'>XLogReaderInvalReadState</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN502"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReadPageInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Invalidate the xlogreader's read state to force a re-read. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN603"></a><span class='Declare_Function'>XLogReaderInvalReadState</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="xlogreader.c.html#LN603"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN150"><span class='Ref_to_Member'>readSegNo</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN603"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN151"><span class='Ref_to_Member'>readOff</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN603"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN147"><span class='Ref_to_Member'>readLen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Validate an XLOG record header. 
 * 
 * This is just a convenience subroutine to avoid duplicated code in 
 * XLogReadRecord.  It's not intended for use from anywhere else. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN617"></a><span class='Declare_Function'>ValidXLogRecordHeader</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>RecPtr</span><span class='Delimiter'>, 
</span><a name="LN618"></a>                      <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>PrevRecPtr</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, 
</span><a name="LN619"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>randAccess</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN42"><span class='Ref_to_Member'>xl_tot_len</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"invalid record length at %X/%X: wanted %u, got %u"</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN42"><span class='Ref_to_Member'>xl_tot_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN46"><span class='Ref_to_Member'>xl_rmid</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/rmgr.h.html#LN32"><span class='Ref_to_Const'>RM_MAX_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"invalid resource manager ID %u at %X/%X"</span><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN46"><span class='Ref_to_Member'>xl_rmid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN619"><span class='Ref_to_Parameter'>randAccess</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We can't exactly verify the prev-link, but surely it should be less 
         * than the record's own address. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN44"><span class='Ref_to_Member'>xl_prev</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                            <span class='String'>"record with incorrect prev-link %X/%X at %X/%X"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN44"><span class='Ref_to_Member'>xl_prev</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN44"><span class='Ref_to_Member'>xl_prev</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Record's prev-link should exactly match our previous location. This 
         * check guards against torn WAL pages where a stale but valid-looking 
         * WAL record starts on a sector boundary. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN44"><span class='Ref_to_Member'>xl_prev</span></a> <span class='Operator'>!= </span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>PrevRecPtr</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                            <span class='String'>"record with incorrect prev-link %X/%X at %X/%X"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN44"><span class='Ref_to_Member'>xl_prev</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN618"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN44"><span class='Ref_to_Member'>xl_prev</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN617"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ValidXLogRecordHeader &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * CRC-check an XLOG record.  We do not believe the contents of an XLOG 
 * record (other than to the minimal extent of computing the amount of 
 * data to read in) until we've checked the CRCs. 
 * 
 * We assume all of the record (that is, xl_tot_len bytes) has been read 
 * into memory at *record.  Also, ValidXLogRecordHeader() has accepted the 
 * record's header, which means in particular that xl_tot_len is at least 
 * SizeOfXlogRecord. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN686"></a><span class='Declare_Function'>ValidXLogRecord</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN688"></a>    <a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Local'>crc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Calculate the CRC */ 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN688"><span class='Ref_To_Local'>crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN688"><span class='Ref_To_Local'>crc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN42"><span class='Ref_to_Member'>xl_tot_len</span></a> <span class='Operator'>- </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* include the record header last */ 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN688"><span class='Ref_To_Local'>crc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a><span class='Delimiter'>, </span>xl_crc<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN688"><span class='Ref_To_Local'>crc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port/pg_crc32c.h.html#LN41"><span class='Ref_to_Macro'>EQ_CRC32C</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN48"><span class='Ref_to_Member'>xl_crc</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN688"><span class='Ref_To_Local'>crc</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>               <span class='String'>"incorrect resource manager data checksum in record at %X/%X"</span><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>recptr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN686"><span class='Ref_to_Parameter'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ValidXLogRecord &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Validate a page header 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN712"></a><span class='Declare_Function'>ValidXLogPageHeader</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recptr</span><span class='Delimiter'>, 
</span><a name="LN713"></a>                    <a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a> <span class='Declare_Parameter'>hdr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN715"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recaddr</span><span class='Delimiter'>; 
</span><a name="LN716"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span><a name="LN717"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>recptr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>recptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>recptr</span></a> <span class='Operator'>% </span><a href="../../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlog_internal.h.html#LN94"><span class='Ref_to_Macro'>XLogSegNoOffsetToRecPtr</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN715"><span class='Ref_To_Local'>recaddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN37"><span class='Ref_to_Member'>xlp_magic</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlog_internal.h.html#LN33"><span class='Ref_to_Const'>XLOG_PAGE_MAGIC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN728"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>fname</span><span class='Delimiter'>[</span><a href="../../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN728"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                    <span class='String'>"invalid magic number %04X in log segment %s, offset %u"</span><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN37"><span class='Ref_to_Member'>xlp_magic</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN728"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN38"><span class='Ref_to_Member'>xlp_info</span></a> <span class='Operator'>& ~</span><a href="../../../include/access/xlog_internal.h.html#LN82"><span class='Ref_to_Const'>XLP_ALL_FLAGS</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN742"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>fname</span><span class='Delimiter'>[</span><a href="../../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN742"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                       <span class='String'>"invalid info bits %04X in log segment %s, offset %u"</span><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN38"><span class='Ref_to_Member'>xlp_info</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN742"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN38"><span class='Ref_to_Member'>xlp_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlog_internal.h.html#LN78"><span class='Ref_to_Const'>XLP_LONG_HEADER</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN756"></a>        <a href="../../../include/access/xlog_internal.h.html#LN73"><span class='Ref_to_Typedef'>XLogLongPageHeader</span></a> <span class='Declare_Local'>longhdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN73"><span class='Ref_to_Typedef'>XLogLongPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN102"><span class='Ref_to_Member'>system_identifier</span></a> <span class='Operator'>&& 
</span>            <a href="xlogreader.c.html#LN756"><span class='Ref_To_Local'>longhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN66"><span class='Ref_to_Member'>xlp_sysid</span></a> <span class='Operator'>!= </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN102"><span class='Ref_to_Member'>system_identifier</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN761"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>fhdrident_str</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN762"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>sysident_str</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Format sysids separately to keep platform-dependent format code 
             * out of the translatable message string. 
             */ 
</span>            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN761"><span class='Ref_To_Local'>fhdrident_str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN761"><span class='Ref_To_Local'>fhdrident_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN315"><span class='Ref_to_Const'>UINT64_FORMAT</span></a><span class='Delimiter'>, 
</span>                     <a href="xlogreader.c.html#LN756"><span class='Ref_To_Local'>longhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN66"><span class='Ref_to_Member'>xlp_sysid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN762"><span class='Ref_To_Local'>sysident_str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN762"><span class='Ref_To_Local'>sysident_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN315"><span class='Ref_to_Const'>UINT64_FORMAT</span></a><span class='Delimiter'>, 
</span>                     <a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN102"><span class='Ref_to_Member'>system_identifier</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"WAL file is from different database system: WAL file database system identifier is %s, pg_control database system identifier is %s"</span><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN761"><span class='Ref_To_Local'>fhdrident_str</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN762"><span class='Ref_To_Local'>sysident_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN756"><span class='Ref_To_Local'>longhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN67"><span class='Ref_to_Member'>xlp_seg_size</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"WAL file is from different database system: incorrect XLOG_SEG_SIZE in page header"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN756"><span class='Ref_To_Local'>longhdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN68"><span class='Ref_to_Member'>xlp_xlog_blcksz</span></a> <span class='Operator'>!= </span>XLOG_BLCKSZ<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"WAL file is from different database system: incorrect XLOG_BLCKSZ in page header"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if hdr-&GT;xlp_info&XLP_LON... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN792"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>fname</span><span class='Delimiter'>[</span><a href="../../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN792"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* hmm, first page of file doesn't have a long header? */ 
</span>        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                       <span class='String'>"invalid info bits %04X in log segment %s, offset %u"</span><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN38"><span class='Ref_to_Member'>xlp_info</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN792"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN40"><span class='Ref_to_Member'>xlp_pageaddr</span></a> <span class='Operator'>!= </span><a href="xlogreader.c.html#LN715"><span class='Ref_To_Local'>recaddr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN807"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>fname</span><span class='Delimiter'>[</span><a href="../../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN807"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                    <span class='String'>"unexpected pageaddr %X/%X in log segment %s, offset %u"</span><span class='Delimiter'>, 
</span>              <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN40"><span class='Ref_to_Member'>xlp_pageaddr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN40"><span class='Ref_to_Member'>xlp_pageaddr</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN807"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, 
</span>                              <a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since child timelines are always assigned a TLI greater than their 
     * immediate parent's TLI, we should never see TLI go backwards across 
     * successive pages of a consistent WAL sequence. 
     * 
     * Sometimes we re-read a segment that's already been (partially) read. So 
     * we only verify TLIs for pages that are later than the last remembered 
     * LSN. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>recptr</span></a> <span class='Operator'>&GT; </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN158"><span class='Ref_to_Member'>latestPagePtr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN39"><span class='Ref_to_Member'>xlp_tli</span></a> <span class='Operator'>&LT; </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN159"><span class='Ref_to_Member'>latestPageTLI</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN832"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>fname</span><span class='Delimiter'>[</span><a href="../../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
            <a href="../../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN832"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN152"><span class='Ref_to_Member'>readPageTLI</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN716"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"out-of-sequence timeline ID %u (after %u) in log segment %s, offset %u"</span><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN39"><span class='Ref_to_Member'>xlp_tli</span></a><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN159"><span class='Ref_to_Member'>latestPageTLI</span></a><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN832"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN717"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN158"><span class='Ref_to_Member'>latestPagePtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>recptr</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN712"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN159"><span class='Ref_to_Member'>latestPageTLI</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN713"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN39"><span class='Ref_to_Member'>xlp_tli</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ValidXLogPageHeader &raquo; </span> 
 
<span class='Directive'>#ifdef</span> <a href="../../../bin/pg_waldump/rmgrdesc.c.html#LN7"><span class='Ref_to_Const'>FRONTEND</span></a> 
<span class='Comment_Multi_Line'>/* 
 * Functions that are currently not needed in the backend, but are better 
 * implemented inside xlogreader.c because of the internal facilities available 
 * here. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Find the first record with an lsn &GT;= RecPtr. 
 * 
 * Useful for checking whether RecPtr is a valid xlog address for reading, and 
 * to find the first valid address after some address when dumping records for 
 * debugging purposes. 
 */ 
</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN866"></a><span class='Declare_Function'>XLogFindNextRecord</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>RecPtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN868"></a>    <a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Declare_Local'>saved_state</span> <span class='Operator'>= *</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; 
</span><a name="LN869"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>tmpRecPtr</span><span class='Delimiter'>; 
</span><a name="LN870"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>found</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN871"></a>    <a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a> <span class='Declare_Local'>header</span><span class='Delimiter'>; 
</span><a name="LN872"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>errormsg</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * skip over potential continuation data, keeping in mind that it may span 
     * multiple pages 
     */ 
</span>    <a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>RecPtr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN883"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>targetPagePtr</span><span class='Delimiter'>; 
</span><a name="LN884"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>targetRecOff</span><span class='Delimiter'>; 
</span><a name="LN885"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>pageHeaderSize</span><span class='Delimiter'>; 
</span><a name="LN886"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>readLen</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Compute targetRecOff. It should typically be equal or greater than 
         * short page-header since a valid record can't start anywhere before 
         * that, except when caller has explicitly specified the offset that 
         * falls somewhere there or when we are skipping multi-page 
         * continuation record. It doesn't matter though because 
         * ReadPageInternal() is prepared to handle that and will read at 
         * least short page-header worth of data 
         */ 
</span>        <a href="xlogreader.c.html#LN884"><span class='Ref_To_Local'>targetRecOff</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>% </span>XLOG_BLCKSZ<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* scroll back to page boundary */ 
</span>        <a href="xlogreader.c.html#LN883"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>- </span><a href="xlogreader.c.html#LN884"><span class='Ref_To_Local'>targetRecOff</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Read the page containing the record */ 
</span>        <a href="xlogreader.c.html#LN886"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN883"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN884"><span class='Ref_To_Local'>targetRecOff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN886"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN966"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN871"><span class='Ref_To_Local'>header</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/xlog_internal.h.html#LN56"><span class='Ref_to_Typedef'>XLogPageHeader</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN146"><span class='Ref_to_Member'>readBuf</span></a><span class='Delimiter'>; 
</span> 
        <a href="xlogreader.c.html#LN885"><span class='Ref_To_Local'>pageHeaderSize</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlog_internal.h.html#LN84"><span class='Ref_to_Macro'>XLogPageHeaderSize</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN871"><span class='Ref_To_Local'>header</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* make sure we have enough data for the page header */ 
</span>        <a href="xlogreader.c.html#LN886"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN35"><span class='Ref_to_Proto'>ReadPageInternal</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN883"><span class='Ref_To_Local'>targetPagePtr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN885"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN886"><span class='Ref_To_Local'>readLen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN966"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* skip over potential continuation data */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN871"><span class='Ref_To_Local'>header</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN38"><span class='Ref_to_Member'>xlp_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlog_internal.h.html#LN76"><span class='Ref_to_Const'>XLP_FIRST_IS_CONTRECORD</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If the length of the remaining continuation data is more than 
             * what can fit in this page, the continuation record crosses over 
             * this page. Read the next page and try again. xlp_rem_len in the 
             * next page header will contain the remaining length of the 
             * continuation data 
             * 
             * Note that record headers are MAXALIGN'ed 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN871"><span class='Ref_To_Local'>header</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Parentheses'>(</span>XLOG_BLCKSZ <span class='Operator'>- </span><a href="xlogreader.c.html#LN885"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Parentheses'>))</span> 
                <a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN883"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>+ </span>XLOG_BLCKSZ<span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The previous continuation record ends in this page. Set 
                 * tmpRecPtr to point to the first valid record 
                 */ 
</span>                <a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN883"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN885"><span class='Ref_To_Local'>pageHeaderSize</span></a> 
                    <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN871"><span class='Ref_To_Local'>header</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlog_internal.h.html#LN51"><span class='Ref_to_Member'>xlp_rem_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if header-&GT;xlp_info&XLP_... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN883"><span class='Ref_To_Local'>targetPagePtr</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN885"><span class='Ref_To_Local'>pageHeaderSize</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * we know now that tmpRecPtr is an address pointing to a valid XLogRecord 
     * because either we're at the first record after the beginning of a page 
     * or we just jumped over the remaining data of a continuation. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN191"><span class='Ref_to_Func'>XLogReadRecord</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="xlogreader.c.html#LN872"><span class='Ref_To_Local'>errormsg</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* continue after the record */ 
</span>        <a href="xlogreader.c.html#LN869"><span class='Ref_To_Local'>tmpRecPtr</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* past the record we've found, break out */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>RecPtr</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN870"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN967"><span class='Ref_to_Label'>out</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
<a name="LN966"></a><span class='Label'>err</span><span class='Operator'>: 
</span><a name="LN967"></a><span class='Label'>out</span><span class='Operator'>: 
</span>    <span class='Comment_Multi_Line'>/* Reset state to what we had before finding the record */ 
</span>    <a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN868"><span class='Ref_To_Local'>saved_state</span></a><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN868"><span class='Ref_To_Local'>saved_state</span></a><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN114"><span class='Ref_to_Member'>EndRecPtr</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xlogreader.h.html#LN202"><span class='Ref_to_Proto'>XLogReaderInvalReadState</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN866"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="xlogreader.c.html#LN870"><span class='Ref_To_Local'>found</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XLogFindNextRecord &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* FRONTEND */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------- 
 * Functions for decoding the data and block references in a record. 
 * ---------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* private function to reset the state between records */ 
</span><span class='Keyword'>static void 
</span><a name="LN986"></a><span class='Declare_Function'>ResetDecoder</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN988"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>block_id</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN124"><span class='Ref_to_Member'>decoded_record</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN135"><span class='Ref_to_Member'>max_block_id</span></a><span class='Delimiter'>; </span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN42"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN53"><span class='Ref_to_Member'>has_image</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN62"><span class='Ref_to_Member'>has_data</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN988"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN54"><span class='Ref_to_Member'>apply_image</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="xlogreader.c.html#LN986"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN135"><span class='Ref_to_Member'>max_block_id</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Decode the previously read record. 
 * 
 * On error, a human-readable error message is returned in *errormsg, and 
 * the return value is false. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1011"></a><span class='Declare_Function'>DecodeXLogRecord</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogrecord.h.html#LN40"><span class='Ref_to_Struct'>XLogRecord</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>errormsg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * read next _size bytes from record buffer, but check for overrun first. 
     */ 
</span><a name="LN1016"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>COPY_HEADER_FIELD</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_dst</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_size</span><span class='Parentheses'>)</span>          <span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{</span>                                        <span class='Operator'>\ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1026"><span class='Ref_To_Local'>remaining</span></a> <span class='Operator'>&LT; </span>_size<span class='Parentheses'>)</span>                  <span class='Operator'>\ 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1288"><span class='Ref_to_Label'>shortdata_err</span></a><span class='Delimiter'>;</span>                 <span class='Operator'>\ 
</span>        memcpy<span class='Parentheses'>(</span>_dst<span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span>_size<span class='Parentheses'>)</span><span class='Delimiter'>;</span>               <span class='Operator'>\ 
</span>        <a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span>_size<span class='Delimiter'>;</span>                           <span class='Operator'>\ 
</span>        <a href="xlogreader.c.html#LN1026"><span class='Ref_To_Local'>remaining</span></a> <span class='Operator'>-= </span>_size<span class='Delimiter'>;</span>                     <span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN1025"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN1026"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>remaining</span><span class='Delimiter'>; 
</span><a name="LN1027"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>datatotal</span><span class='Delimiter'>; 
</span><a name="LN1028"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rnode</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1029"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>block_id</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN985"><span class='Ref_to_Func'>ResetDecoder</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN124"><span class='Ref_to_Member'>decoded_record</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN130"><span class='Ref_to_Member'>record_origin</span></a> <span class='Operator'>= </span><a href="../../../include/replication/origin.h.html#LN33"><span class='Ref_to_Const'>InvalidRepOriginId</span></a><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Delimiter'>; 
</span>    <a href="xlogreader.c.html#LN1026"><span class='Ref_To_Local'>remaining</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogrecord.h.html#LN42"><span class='Ref_to_Member'>xl_tot_len</span></a> <span class='Operator'>- </span><a href="../../../include/access/xlogrecord.h.html#LN54"><span class='Ref_to_Const'>SizeOfXLogRecord</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Decode the headers */ 
</span>    <a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1026"><span class='Ref_To_Local'>remaining</span></a> <span class='Operator'>&GT; </span><a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogrecord.h.html#LN222"><span class='Ref_to_Const'>XLR_BLOCK_ID_DATA_SHORT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* XLogRecordDataHeaderShort */ 
</span><a name="LN1049"></a>            <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>main_data_len</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1049"><span class='Ref_To_Local'>main_data_len</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1049"><span class='Ref_To_Local'>main_data_len</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1049"><span class='Ref_To_Local'>main_data_len</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Multi_Line'>/* by convention, the main data fragment is 
                                 * always last */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogrecord.h.html#LN223"><span class='Ref_to_Const'>XLR_BLOCK_ID_DATA_LONG</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* XLogRecordDataHeaderLong */ 
</span><a name="LN1061"></a>            <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>main_data_len</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1061"><span class='Ref_To_Local'>main_data_len</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1061"><span class='Ref_To_Local'>main_data_len</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1061"><span class='Ref_To_Local'>main_data_len</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Multi_Line'>/* by convention, the main data fragment is 
                                 * always last */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogrecord.h.html#LN224"><span class='Ref_to_Const'>XLR_BLOCK_ID_ORIGIN</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN130"><span class='Ref_to_Member'>record_origin</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN50"><span class='Ref_to_Typedef'>RepOriginId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/xlogrecord.h.html#LN220"><span class='Ref_to_Const'>XLR_MAX_BLOCK_ID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* XLogRecordBlockHeader */ 
</span><a name="LN1076"></a>            <a href="../../../include/access/xlogreader.h.html#LN39"><span class='Ref_to_Typedef'>DecodedBkpBlock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>blk</span><span class='Delimiter'>; 
</span><a name="LN1077"></a>            <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>fork_flags</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN135"><span class='Ref_to_Member'>max_block_id</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                      <span class='String'>"out-of-order block_id %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                      <a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN135"><span class='Ref_to_Member'>max_block_id</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a> <span class='Operator'>= &</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]; 
</span>            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN42"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN54"><span class='Ref_to_Member'>apply_image</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1077"><span class='Ref_To_Local'>fork_flags</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN46"><span class='Ref_to_Member'>forknum</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1077"><span class='Ref_To_Local'>fork_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN177"><span class='Ref_to_Const'>BKPBLOCK_FORK_MASK</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN50"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1077"><span class='Ref_To_Local'>fork_flags</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN53"><span class='Ref_to_Member'>has_image</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="xlogreader.c.html#LN1077"><span class='Ref_To_Local'>fork_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN179"><span class='Ref_to_Const'>BKPBLOCK_HAS_IMAGE</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN62"><span class='Ref_to_Member'>has_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="xlogreader.c.html#LN1077"><span class='Ref_To_Local'>fork_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN180"><span class='Ref_to_Const'>BKPBLOCK_HAS_DATA</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* cross-check that the HAS_DATA flag is set iff data_length &GT; 0 */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN62"><span class='Ref_to_Member'>has_data</span></a> <span class='Operator'>&& </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                      <span class='String'>"BKPBLOCK_HAS_DATA set, but no data included at %X/%X"</span><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN62"><span class='Ref_to_Member'>has_data</span></a> <span class='Operator'>&& </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"BKPBLOCK_HAS_DATA not set, but data length is %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN53"><span class='Ref_to_Member'>has_image</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN54"><span class='Ref_to_Member'>apply_image</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN148"><span class='Ref_to_Const'>BKPIMAGE_APPLY</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN147"><span class='Ref_to_Const'>BKPIMAGE_IS_COMPRESSED</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN146"><span class='Ref_to_Const'>BKPIMAGE_HAS_HOLE</span></a><span class='Parentheses'>) 
</span>                        <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                    <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a> <span class='Operator'>= </span>BLCKSZ <span class='Operator'>- </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * cross-check that hole_offset &GT; 0, hole_length &GT; 0 and 
                 * bimg_len &LT; BLCKSZ if the HAS_HOLE flag is set. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN146"><span class='Ref_to_Const'>BKPIMAGE_HAS_HOLE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                     <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                     <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"BKPIMAGE_HAS_HOLE set, but hole offset %u length %u block image length %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * cross-check that hole_offset == 0 and hole_length == 0 if 
                 * the HAS_HOLE flag is not set. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN146"><span class='Ref_to_Const'>BKPIMAGE_HAS_HOLE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"BKPIMAGE_HAS_HOLE not set, but hole offset %u length %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * cross-check that bimg_len &LT; BLCKSZ if the IS_COMPRESSED 
                 * flag is set. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN147"><span class='Ref_to_Const'>BKPIMAGE_IS_COMPRESSED</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"BKPIMAGE_IS_COMPRESSED set, but block image length %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * cross-check that bimg_len = BLCKSZ if neither HAS_HOLE nor 
                 * IS_COMPRESSED flag is set. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN146"><span class='Ref_to_Const'>BKPIMAGE_HAS_HOLE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN147"><span class='Ref_to_Const'>BKPIMAGE_IS_COMPRESSED</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a> <span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"neither BKPIMAGE_HAS_HOLE nor BKPIMAGE_IS_COMPRESSED set, but block image length is %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if blk-&GT;has_image &raquo; </span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1077"><span class='Ref_To_Local'>fork_flags</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN182"><span class='Ref_to_Const'>BKPBLOCK_SAME_REL</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN45"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN1028"><span class='Ref_To_Local'>rnode</span></a> <span class='Operator'>= &</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN45"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1028"><span class='Ref_To_Local'>rnode</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                        <span class='String'>"BKPBLOCK_SAME_REL set but no previous rel at %X/%X"</span><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN45"><span class='Ref_to_Member'>rnode</span></a> <span class='Operator'>= *</span><a href="xlogreader.c.html#LN1028"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="xlogreader.c.html#LN1016"><span class='Ref_to_Macro'>COPY_HEADER_FIELD</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="xlogreader.c.html#LN1076"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN47"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if block_id&LT;=XLR_MAX_BLO... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"invalid block_id %u at %X/%X"</span><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1292"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while remaining&GT;datatotal &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1026"><span class='Ref_To_Local'>remaining</span></a> <span class='Operator'>!= </span><a href="xlogreader.c.html#LN1027"><span class='Ref_To_Local'>datatotal</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="xlogreader.c.html#LN1288"><span class='Ref_to_Label'>shortdata_err</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ok, we've parsed the fragment headers, and verified that the total 
     * length of the payload in the fragments is equal to the amount of data 
     * left. Copy the data of each fragment to a separate buffer. 
     * 
     * We could just set up pointers into readRecordBuf, but we want to align 
     * the data for the convenience of the callers. Backup images are not 
     * copied, however; they don't need alignment. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* block data first */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a> <span class='Operator'>&LT;= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN135"><span class='Ref_to_Member'>max_block_id</span></a><span class='Delimiter'>; </span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1246"></a>        <a href="../../../include/access/xlogreader.h.html#LN39"><span class='Ref_to_Typedef'>DecodedBkpBlock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>blk</span> <span class='Operator'>= &</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1029"><span class='Ref_To_Local'>block_id</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN42"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN53"><span class='Ref_to_Member'>has_image</span></a> <span class='Operator'>|| !</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN54"><span class='Ref_to_Member'>apply_image</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN53"><span class='Ref_to_Member'>has_image</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN55"><span class='Ref_to_Member'>bkp_image</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN62"><span class='Ref_to_Member'>has_data</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>|| </span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a> <span class='Operator'>&GT; </span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN65"><span class='Ref_to_Member'>data_bufsz</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN65"><span class='Ref_to_Member'>data_bufsz</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>; 
</span>                <a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN65"><span class='Ref_to_Member'>data_bufsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1246"><span class='Ref_To_Local'>blk</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for block_id=0;block_id&LT;=... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* and finally, the main data */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a> <span class='Operator'>|| </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a> <span class='Operator'>&GT; </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN128"><span class='Ref_to_Member'>main_data_bufsz</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN128"><span class='Ref_to_Member'>main_data_bufsz</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a><span class='Delimiter'>; 
</span>            <a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN128"><span class='Ref_to_Member'>main_data_bufsz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN126"><span class='Ref_to_Member'>main_data</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="xlogreader.c.html#LN1025"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN127"><span class='Ref_to_Member'>main_data_len</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<a name="LN1288"></a><span class='Label'>shortdata_err</span><span class='Operator'>: 
</span>    <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>, 
</span>                          <span class='String'>"record with invalid length at %X/%X"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1292"></a><span class='Label'>err</span><span class='Operator'>: 
</span>    <span class='Operator'>*</span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>errormsg</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1011"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN187"><span class='Ref_to_Member'>errormsg_buf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DecodeXLogRecord &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns information about the block that a block reference refers to. 
 * 
 * If the WAL record contains a block reference with the given ID, *rnode, 
 * *forknum, and *blknum are filled in (if not NULL), and returns TRUE. 
 * Otherwise returns FALSE. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1306"></a><span class='Declare_Function'>XLogRecGetBlockTag</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>block_id</span><span class='Delimiter'>, 
</span><a name="LN1307"></a>                <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>blknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1309"></a>    <a href="../../../include/access/xlogreader.h.html#LN39"><span class='Ref_to_Typedef'>DecodedBkpBlock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bkpb</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1306"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1306"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN42"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN1309"><span class='Ref_To_Local'>bkpb</span></a> <span class='Operator'>= &</span><a href="xlogreader.c.html#LN1306"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1306"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1307"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="xlogreader.c.html#LN1307"><span class='Ref_to_Parameter'>rnode</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1309"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN45"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1307"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="xlogreader.c.html#LN1307"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1309"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN46"><span class='Ref_to_Member'>forknum</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1307"><span class='Ref_to_Parameter'>blknum</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="xlogreader.c.html#LN1307"><span class='Ref_to_Parameter'>blknum</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1309"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN47"><span class='Ref_to_Member'>blkno</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Returns the data associated with a block reference, or NULL if there is 
 * no data (e.g. because a full-page image was taken instead). The returned 
 * pointer points to a MAXALIGNed buffer. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1330"></a><span class='Declare_Function'>XLogRecGetBlockData</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>block_id</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1332"></a>    <a href="../../../include/access/xlogreader.h.html#LN39"><span class='Ref_to_Typedef'>DecodedBkpBlock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bkpb</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN42"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN1332"><span class='Ref_To_Local'>bkpb</span></a> <span class='Operator'>= &</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1332"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN62"><span class='Ref_to_Member'>has_data</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="xlogreader.c.html#LN1330"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1332"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN64"><span class='Ref_to_Member'>data_len</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="xlogreader.c.html#LN1332"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN63"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end XLogRecGetBlockData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Restore a full-page image from a backup block attached to an XLOG record. 
 * 
 * Returns the buffer number containing the page. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1359"></a><span class='Declare_Function'>RestoreBlockImage</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>block_id</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1361"></a>    <a href="../../../include/access/xlogreader.h.html#LN39"><span class='Ref_to_Typedef'>DecodedBkpBlock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bkpb</span><span class='Delimiter'>; 
</span><a name="LN1362"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN1363"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmp</span><span class='Delimiter'>[</span>BLCKSZ<span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN42"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/access/xlogreader.h.html#LN53"><span class='Ref_to_Member'>has_image</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a> <span class='Operator'>= &</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN133"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>[</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>block_id</span></a><span class='Delimiter'>]; 
</span>    <a href="xlogreader.c.html#LN1362"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN55"><span class='Ref_to_Member'>bkp_image</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN59"><span class='Ref_to_Member'>bimg_info</span></a> <span class='Operator'>& </span><a href="../../../include/access/xlogrecord.h.html#LN147"><span class='Ref_to_Const'>BKPIMAGE_IS_COMPRESSED</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If a backup block image is compressed, decompress it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/common/pg_lzcompress.h.html#LN87"><span class='Ref_to_Proto'>pglz_decompress</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1362"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN58"><span class='Ref_to_Member'>bimg_len</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1363"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, 
</span>                            BLCKSZ <span class='Operator'>- </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="xlogreader.c.html#LN37"><span class='Ref_to_Func'>report_invalid_record</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>record</span></a><span class='Delimiter'>, </span><span class='String'>"invalid compressed image at %X/%X, block %d"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>record</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN113"><span class='Ref_to_Member'>ReadRecPtr</span></a><span class='Delimiter'>, 
</span>                                  <a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>block_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="xlogreader.c.html#LN1362"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="xlogreader.c.html#LN1363"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* generate page, taking into account hole if necessary */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1362"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1362"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* must zero-fill the hole */ 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1359"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="xlogreader.c.html#LN1362"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a><span class='Delimiter'>, 
</span>               BLCKSZ <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN56"><span class='Ref_to_Member'>hole_offset</span></a> <span class='Operator'>+ </span><a href="xlogreader.c.html#LN1361"><span class='Ref_To_Local'>bkpb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/xlogreader.h.html#LN57"><span class='Ref_to_Member'>hole_length</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RestoreBlockImage &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>