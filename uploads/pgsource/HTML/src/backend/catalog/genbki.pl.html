<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\catalog\genbki.pl</title>
<LINK REL=StyleSheet HREF="../../../Perl_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\catalog\genbki.pl</b></p></td>
<td align='right'>
Wed Jun 14 08:25:31 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Operator'>#!/usr/</span>bin<span class='Operator'>/</span>perl <span class='Operator'>-</span>w 
<span class='Comment_Single_Line'>#---------------------------------------------------------------------- 
# 
# genbki.pl 
#    Perl script that generates postgres.bki, postgres.description, 
#    postgres.shdescription, and schemapg.h from specially formatted 
#    header files.  The .bki files are used to initialize the postgres 
#    template database. 
# 
# Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
# Portions Copyright (c) 1994, Regents of the University of California 
# 
# src/backend/catalog/genbki.pl 
# 
#---------------------------------------------------------------------- 
</span> 
<span class='Control'>use</span> Catalog<span class='Delimiter'>; 
</span> 
<span class='Control'>use</span> strict<span class='Delimiter'>; 
</span><span class='Control'>use</span> warnings<span class='Delimiter'>; 
</span> 
<span class='Keyword'>my </span>@input_files<span class='Delimiter'>; 
</span><span class='Keyword'>our </span>@include_path<span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$output_path <span class='Operator'>= </span><span class='String'>''</span><span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$major_version<span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Process command line switches. 
</span><span class='Control'>while</span> <span class='Parentheses'>(</span>@ARGV<span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span>$arg <span class='Operator'>= </span><span class='Keyword'>shift </span>@ARGV<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$arg <span class='Operator'>!~ /^-/</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>push </span>@input_files<span class='Delimiter'>, </span>$arg<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$arg <span class='Operator'>=~ /^-o/</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $output_path <span class='Operator'>= </span><span class='Keyword'>length</span><span class='Parentheses'>(</span>$arg<span class='Parentheses'>) </span><span class='Operator'>&GT; </span>2 <span class='Operator'>? </span><span class='Keyword'>substr</span><span class='Parentheses'>(</span>$arg<span class='Delimiter'>, </span>2<span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Keyword'>shift </span>@ARGV<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$arg <span class='Operator'>=~ /^-I/</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>push </span>@include_path<span class='Delimiter'>, </span><span class='Keyword'>length</span><span class='Parentheses'>(</span>$arg<span class='Parentheses'>) </span><span class='Operator'>&GT; </span>2 <span class='Operator'>? </span><span class='Keyword'>substr</span><span class='Parentheses'>(</span>$arg<span class='Delimiter'>, </span>2<span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Keyword'>shift </span>@ARGV<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$arg <span class='Operator'>=~ /^--set-version=(.*)$/</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $major_version <span class='Operator'>= </span>$1<span class='Delimiter'>; 
</span>        <span class='Control'>die</span> <span class='String'>"Invalid version string.\n"</span> 
          <span class='Control'>if</span> <span class='Operator'>!</span><span class='Parentheses'>(</span>$major_version <span class='Operator'>=~ /^\d+$/</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../tools/fix-old-flex-code.pl.html#LN55"><span class='Ref_to_Func'>usage</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Single_Line'># Sanity check arguments. 
</span><span class='Control'>die</span> <span class='String'>"No input files.\n"</span>                                     <span class='Control'>if</span> <span class='Operator'>!</span>@input_files<span class='Delimiter'>; 
</span><span class='Control'>die</span> <span class='String'>"No include path; you must specify -I at least once.\n"</span> <span class='Control'>if</span> <span class='Operator'>!</span>@include_path<span class='Delimiter'>; 
</span><span class='Control'>die</span> <span class='String'>"--set-version must be specified.\n"</span> <span class='Control'>if</span> <span class='Operator'>!</span><span class='Keyword'>defined </span>$major_version<span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Make sure output_path ends in a slash. 
</span><span class='Control'>if</span> <span class='Parentheses'>(</span>$output_path <span class='Operator'>ne </span><span class='String'>''</span> <span class='Operator'>&& </span><span class='Keyword'>substr</span><span class='Parentheses'>(</span>$output_path<span class='Delimiter'>, </span><span class='Operator'>-</span>1<span class='Parentheses'>) </span><span class='Operator'>ne </span><span class='String'>'/'</span><span class='Parentheses'>)</span> 
<span class='Delimiter'>{ 
</span>    $output_path <span class='Operator'>.= </span><span class='String'>'/'</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'># Open temp files 
</span><span class='Keyword'>my </span>$tmpext  <span class='Operator'>= </span><span class='String'>".tmp$$"</span><span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$bkifile <span class='Operator'>= </span>$output_path <span class='Operator'>. </span><span class='String'>'postgres.bki'</span><span class='Delimiter'>; 
</span><span class='Keyword'>open my </span>$bki<span class='Delimiter'>, </span><span class='String'>'&GT;'</span><span class='Delimiter'>, </span>$bkifile <span class='Operator'>. </span>$tmpext 
  or <span class='Control'>die</span> <span class='String'>"can't open $bkifile$tmpext: $!"</span><span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$schemafile <span class='Operator'>= </span>$output_path <span class='Operator'>. </span><span class='String'>'schemapg.h'</span><span class='Delimiter'>; 
</span><span class='Keyword'>open my </span>$schemapg<span class='Delimiter'>, </span><span class='String'>'&GT;'</span><span class='Delimiter'>, </span>$schemafile <span class='Operator'>. </span>$tmpext 
  or <span class='Control'>die</span> <span class='String'>"can't open $schemafile$tmpext: $!"</span><span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$descrfile <span class='Operator'>= </span>$output_path <span class='Operator'>. </span><span class='String'>'postgres.description'</span><span class='Delimiter'>; 
</span><span class='Keyword'>open my </span>$descr<span class='Delimiter'>, </span><span class='String'>'&GT;'</span><span class='Delimiter'>, </span>$descrfile <span class='Operator'>. </span>$tmpext 
  or <span class='Control'>die</span> <span class='String'>"can't open $descrfile$tmpext: $!"</span><span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$shdescrfile <span class='Operator'>= </span>$output_path <span class='Operator'>. </span><span class='String'>'postgres.shdescription'</span><span class='Delimiter'>; 
</span><span class='Keyword'>open my </span>$shdescr<span class='Delimiter'>, </span><span class='String'>'&GT;'</span><span class='Delimiter'>, </span>$shdescrfile <span class='Operator'>. </span>$tmpext 
  or <span class='Control'>die</span> <span class='String'>"can't open $shdescrfile$tmpext: $!"</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Fetch some special data that we will substitute into the output file. 
# CAUTION: be wary about what symbols you substitute into the .bki file here! 
# It's okay to substitute things that are expected to be really constant 
# within a given Postgres release, such as fixed OIDs.  Do not substitute 
# anything that could depend on platform or configuration.  (The right place 
# to handle those sorts of things is in initdb.c's bootstrap_template1().) 
# NB: make sure that the files used here are known to be part of the .bki 
# file's dependencies by src/backend/catalog/Makefile. 
</span><span class='Keyword'>my </span>$BOOTSTRAP_SUPERUSERID <span class='Operator'>= 
</span>  <a href="genbki.pl.html#LN503"><span class='Ref_to_Func'>find_defined_symbol</span></a><span class='Parentheses'>(</span><span class='String'>'pg_authid.h'</span><span class='Delimiter'>, </span><span class='String'>'BOOTSTRAP_SUPERUSERID'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>my </span>$PG_CATALOG_NAMESPACE <span class='Operator'>= 
</span>  <a href="genbki.pl.html#LN503"><span class='Ref_to_Func'>find_defined_symbol</span></a><span class='Parentheses'>(</span><span class='String'>'pg_namespace.h'</span><span class='Delimiter'>, </span><span class='String'>'PG_CATALOG_NAMESPACE'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Read all the input header files into internal data structures 
</span><span class='Keyword'>my </span>$catalogs <span class='Operator'>= </span>Catalog<span class='Operator'>::</span><a href="Catalog.pm.html#LN25"><span class='Ref_to_Func'>Catalogs</span></a><span class='Parentheses'>(</span>@input_files<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Generate postgres.bki, postgres.description, and postgres.shdescription 
</span> 
<span class='Comment_Single_Line'># version marker for .bki file 
</span><span class='Keyword'>print </span>$bki <span class='String'>"# PostgreSQL $major_version\n"</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># vars to hold data needed for schemapg.h 
</span><span class='Keyword'>my </span>%schemapg_entries<span class='Delimiter'>; 
</span><span class='Keyword'>my </span>@tables_needing_macros<span class='Delimiter'>; 
</span><span class='Keyword'>my </span>%regprocoids<span class='Delimiter'>; 
</span><span class='Keyword'>our </span>@types<span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># produce output, one catalog at a time 
</span><span class='Control'>foreach</span> <span class='Keyword'>my </span>$catname <span class='Parentheses'>(</span>@<span class='Delimiter'>{ </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>names<span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span> 
    <span class='Comment_Single_Line'># .bki CREATE command for this catalog 
</span>    <span class='Keyword'>my </span>$catalog <span class='Operator'>= </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$catname<span class='Delimiter'>}; 
</span>    <span class='Keyword'>print </span>$bki <span class='String'>"create $catname $catalog-&GT;{relation_oid}"</span> 
      <span class='Operator'>. </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>shared_relation<span class='Delimiter'>} 
</span>      <span class='Operator'>. </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>bootstrap<span class='Delimiter'>} 
</span>      <span class='Operator'>. </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>without_oids<span class='Delimiter'>} 
</span>      <span class='Operator'>. </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>rowtype_oid<span class='Delimiter'>} </span><span class='Operator'>. </span><span class='String'>"\n"</span><span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>%bki_attr<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>@attnames<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$first <span class='Operator'>= </span>1<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>print </span>$bki <span class='String'>" (\n"</span><span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$column <span class='Parentheses'>(</span>@<span class='Delimiter'>{ </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>columns<span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>my </span>$attname <span class='Operator'>= </span>$column<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a><span class='Delimiter'>}; 
</span>        <span class='Keyword'>my </span>$atttype <span class='Operator'>= </span>$column<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>type<span class='Delimiter'>}; 
</span>        $bki_attr<span class='Delimiter'>{</span>$attname<span class='Delimiter'>} </span><span class='Operator'>= </span>$column<span class='Delimiter'>; 
</span>        <span class='Keyword'>push </span>@attnames<span class='Delimiter'>, </span>$attname<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>$first<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>print </span>$bki <span class='String'>" ,\n"</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        $first <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span> 
        <span class='Keyword'>print </span>$bki <span class='String'>" $attname = $atttype"</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$column<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>forcenotnull<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>print </span>$bki <span class='String'>" FORCE NOT NULL"</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>elsif</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$column<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>forcenull<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>print </span>$bki <span class='String'>" FORCE NULL"</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Keyword'>print </span>$bki <span class='String'>"\n )\n"</span><span class='Delimiter'>; 
</span> 
   <span class='Comment_Single_Line'># open it, unless bootstrap case (create bootstrap does this automatically) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>bootstrap<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>''</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print </span>$bki <span class='String'>"open $catname\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>data<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <span class='Comment_Single_Line'># Ordinary catalog with DATA line(s) 
</span>        <span class='Control'>foreach</span> <span class='Keyword'>my </span>$row <span class='Parentheses'>(</span>@<span class='Delimiter'>{ </span>$catalog<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>data<span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span> 
            <span class='Comment_Single_Line'># Split line into tokens without interpreting their meaning. 
</span>            <span class='Keyword'>my </span>%bki_values<span class='Delimiter'>; 
</span>            @bki_values<span class='Delimiter'>{</span>@attnames<span class='Delimiter'>} </span><span class='Operator'>= 
</span>              Catalog<span class='Operator'>::</span><a href="Catalog.pm.html#LN225"><span class='Ref_to_Func'>SplitDataLine</span></a><span class='Parentheses'>(</span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>bki_values<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Single_Line'># Perform required substitutions on fields 
</span>            <span class='Control'>foreach</span> <span class='Keyword'>my </span>$att <span class='Parentheses'>(</span><span class='Keyword'>keys </span>%bki_values<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span> 
                <span class='Comment_Single_Line'># Substitute constant values we acquired above. 
</span>                <span class='Comment_Single_Line'># (It's intentional that this can apply to parts of a field). 
</span>                $bki_values<span class='Delimiter'>{</span>$att<span class='Delimiter'>} </span><span class='Operator'>=~ s</span><span class='String'>/\bPGUID\b/$BOOTSTRAP_SUPERUSERID/</span>g<span class='Delimiter'>; 
</span>                $bki_values<span class='Delimiter'>{</span>$att<span class='Delimiter'>} </span><span class='Operator'>=~ s</span><span class='String'>/\bPGNSP\b/$PG_CATALOG_NAMESPACE/</span>g<span class='Delimiter'>; 
</span> 
                <span class='Comment_Single_Line'># Replace regproc columns' values with OIDs. 
</span>                <span class='Comment_Single_Line'># If we don't have a unique value to substitute, 
</span>                <span class='Comment_Single_Line'># just do nothing (regprocin will complain). 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>$bki_attr<span class='Delimiter'>{</span>$att<span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>type<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'regproc'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Keyword'>my </span>$procoid <span class='Operator'>= </span>$regprocoids<span class='Delimiter'>{ </span>$bki_values<span class='Delimiter'>{</span>$att<span class='Delimiter'>} }; 
</span>                    $bki_values<span class='Delimiter'>{</span>$att<span class='Delimiter'>} </span><span class='Operator'>= </span>$procoid 
                      <span class='Control'>if</span> <span class='Keyword'>defined</span><span class='Parentheses'>(</span>$procoid<span class='Parentheses'>) </span><span class='Operator'>&& </span>$procoid <span class='Operator'>ne </span><span class='String'>'MULTIPLE'</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Single_Line'># Save pg_proc oids for use in later regproc substitutions. 
</span>            <span class='Comment_Single_Line'># This relies on the order we process the files in! 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>$catname <span class='Operator'>eq </span><span class='String'>'pg_proc'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined</span><span class='Parentheses'>(</span>$regprocoids<span class='Delimiter'>{ </span>$bki_values<span class='Delimiter'>{</span>proname<span class='Delimiter'>} }</span><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    $regprocoids<span class='Delimiter'>{ </span>$bki_values<span class='Delimiter'>{</span>proname<span class='Delimiter'>} } </span><span class='Operator'>= </span><span class='String'>'MULTIPLE'</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    $regprocoids<span class='Delimiter'>{ </span>$bki_values<span class='Delimiter'>{</span>proname<span class='Delimiter'>} } </span><span class='Operator'>= </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>}; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Single_Line'># Save pg_type info for pg_attribute processing below 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>$catname <span class='Operator'>eq </span><span class='String'>'pg_type'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Keyword'>my </span>%type <span class='Operator'>= </span>%bki_values<span class='Delimiter'>; 
</span>                $type<span class='Delimiter'>{</span>oid<span class='Delimiter'>} </span><span class='Operator'>= </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>}; 
</span>                <span class='Keyword'>push </span>@types<span class='Delimiter'>, </span><span class='Operator'>\</span>%type<span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Single_Line'># Write to postgres.bki 
</span>            <span class='Keyword'>my </span>$oid <span class='Operator'>= </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>} </span><span class='Operator'>? </span><span class='String'>"OID = $row-&GT;{oid} "</span> <span class='Operator'>: </span><span class='String'>''</span><span class='Delimiter'>; 
</span>            <span class='Keyword'>printf </span>$bki <span class='String'>"insert %s( %s )\n"</span><span class='Delimiter'>, </span>$oid<span class='Delimiter'>, 
</span>              <span class='Keyword'>join</span><span class='Parentheses'>(</span><span class='String'>' '</span><span class='Delimiter'>, </span>@bki_values<span class='Delimiter'>{</span>@attnames<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
           <span class='Comment_Single_Line'># Write comments to postgres.description and postgres.shdescription 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>descr<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Keyword'>printf </span>$descr <span class='String'>"%s\t%s\t0\t%s\n"</span><span class='Delimiter'>, </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>}, </span>$catname<span class='Delimiter'>, 
</span>                  $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>descr<span class='Delimiter'>}; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>shdescr<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Keyword'>printf </span>$shdescr <span class='String'>"%s\t%s\t%s\n"</span><span class='Delimiter'>, </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>}, </span>$catname<span class='Delimiter'>, 
</span>                  $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>shdescr<span class='Delimiter'>}; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$catname <span class='Operator'>eq </span><span class='String'>'pg_attribute'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <span class='Comment_Single_Line'># For pg_attribute.h, we generate DATA entries ourselves. 
</span>        <span class='Comment_Single_Line'># NB: pg_type.h must come before pg_attribute.h in the input list 
</span>        <span class='Comment_Single_Line'># of catalog names, since we use info from pg_type.h here. 
</span>        <span class='Control'>foreach</span> <span class='Keyword'>my </span>$table_name <span class='Parentheses'>(</span>@<span class='Delimiter'>{ </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>names<span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>my </span>$table <span class='Operator'>= </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$table_name<span class='Delimiter'>}; 
</span> 
            <span class='Comment_Single_Line'># Currently, all bootstrapped relations also need schemapg.h 
</span>            <span class='Comment_Single_Line'># entries, so skip if the relation isn't to be in schemapg.h. 
</span>            <span class='Control'>next</span> <span class='Control'>if</span> $table<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>schema_macro<span class='Delimiter'>} </span><span class='Operator'>ne </span><span class='String'>'True'</span><span class='Delimiter'>; 
</span> 
            $schemapg_entries<span class='Delimiter'>{</span>$table_name<span class='Delimiter'>} </span><span class='Operator'>= </span><span class='Delimiter'>[]; 
</span>            <span class='Keyword'>push </span>@tables_needing_macros<span class='Delimiter'>, </span>$table_name<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$is_bootstrap <span class='Operator'>= </span>$table<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>bootstrap<span class='Delimiter'>}; 
</span> 
            <span class='Comment_Single_Line'># Generate entries for user attributes. 
</span>            <span class='Keyword'>my </span>$attnum       <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$priornotnull <span class='Operator'>= </span>1<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>@user_attrs   <span class='Operator'>= </span>@<span class='Delimiter'>{ </span>$table<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>columns<span class='Delimiter'>} }; 
</span>            <span class='Control'>foreach</span> <span class='Keyword'>my </span>$attr <span class='Parentheses'>(</span>@user_attrs<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                $attnum<span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Keyword'>my </span>$row <span class='Operator'>= </span><a href="genbki.pl.html#LN380"><span class='Ref_to_Func'>emit_pgattr_row</span></a><span class='Parentheses'>(</span>$table_name<span class='Delimiter'>, </span>$attr<span class='Delimiter'>, </span>$priornotnull<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attnum<span class='Delimiter'>}</span>        <span class='Operator'>= </span>$attnum<span class='Delimiter'>; 
</span>                $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attstattarget<span class='Delimiter'>} </span><span class='Operator'>= </span><span class='String'>'-1'</span><span class='Delimiter'>; 
</span>                $priornotnull <span class='Operator'>&= </span><span class='Parentheses'>(</span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attnotnull<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'t'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Single_Line'># If it's bootstrapped, put an entry in postgres.bki. 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>$is_bootstrap <span class='Operator'>eq </span><span class='String'>' bootstrap'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="genbki.pl.html#LN458"><span class='Ref_to_Func'>bki_insert</span></a><span class='Parentheses'>(</span>$row<span class='Delimiter'>, </span>@attnames<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Single_Line'># Store schemapg entries for later. 
</span>                $row <span class='Operator'>= 
</span>                  <a href="genbki.pl.html#LN470"><span class='Ref_to_Func'>emit_schemapg_row</span></a><span class='Parentheses'>(</span>$row<span class='Delimiter'>, 
</span>                    <span class='Keyword'>grep </span><span class='Delimiter'>{ </span>$bki_attr<span class='Delimiter'>{</span>$_<span class='Delimiter'>}{</span>type<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'bool'</span> <span class='Delimiter'>} </span>@attnames<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Keyword'>push </span>@<span class='Delimiter'>{ </span>$schemapg_entries<span class='Delimiter'>{</span>$table_name<span class='Delimiter'>} }, </span><span class='String'>'{ '</span> 
                  <span class='Operator'>. </span><span class='Keyword'>join</span><span class='Parentheses'>( 
</span>                    <span class='String'>', '</span><span class='Delimiter'>,</span>             <span class='Keyword'>grep </span><span class='Delimiter'>{ </span><span class='Keyword'>defined </span>$_ <span class='Delimiter'>} 
</span>                      <span class='Keyword'>map </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$_<span class='Delimiter'>}, </span>@attnames<span class='Parentheses'>) </span><span class='Operator'>. </span><span class='String'>' }'</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Single_Line'># Generate entries for system attributes. 
</span>            <span class='Comment_Single_Line'># We only need postgres.bki entries, not schemapg.h entries. 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>$is_bootstrap <span class='Operator'>eq </span><span class='String'>' bootstrap'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                $attnum <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>                <span class='Keyword'>my </span>@SYS_ATTRS <span class='Operator'>= </span><span class='Parentheses'>( 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'ctid'</span><span class='Delimiter'>,</span>     type <span class='Operator'>=&GT; </span><span class='String'>'tid'</span> <span class='Delimiter'>}, 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'oid'</span><span class='Delimiter'>,</span>      type <span class='Operator'>=&GT; </span><span class='String'>'oid'</span> <span class='Delimiter'>}, 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'xmin'</span><span class='Delimiter'>,</span>     type <span class='Operator'>=&GT; </span><span class='String'>'xid'</span> <span class='Delimiter'>}, 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'cmin'</span><span class='Delimiter'>,</span>     type <span class='Operator'>=&GT; </span><span class='String'>'cid'</span> <span class='Delimiter'>}, 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'xmax'</span><span class='Delimiter'>,</span>     type <span class='Operator'>=&GT; </span><span class='String'>'xid'</span> <span class='Delimiter'>}, 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'cmax'</span><span class='Delimiter'>,</span>     type <span class='Operator'>=&GT; </span><span class='String'>'cid'</span> <span class='Delimiter'>}, 
</span>                    <span class='Delimiter'>{ </span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a> <span class='Operator'>=&GT; </span><span class='String'>'tableoid'</span><span class='Delimiter'>, </span>type <span class='Operator'>=&GT; </span><span class='String'>'oid'</span> <span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>foreach</span> <span class='Keyword'>my </span>$attr <span class='Parentheses'>(</span>@SYS_ATTRS<span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    $attnum<span class='Operator'>--</span><span class='Delimiter'>; 
</span>                    <span class='Keyword'>my </span>$row <span class='Operator'>= </span><a href="genbki.pl.html#LN380"><span class='Ref_to_Func'>emit_pgattr_row</span></a><span class='Parentheses'>(</span>$table_name<span class='Delimiter'>, </span>$attr<span class='Delimiter'>, </span>1<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attnum<span class='Delimiter'>}</span>        <span class='Operator'>= </span>$attnum<span class='Delimiter'>; 
</span>                    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attstattarget<span class='Delimiter'>} </span><span class='Operator'>= </span><span class='String'>'0'</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Single_Line'># some catalogs don't have oids 
</span>                    <span class='Control'>next</span> 
                      <span class='Control'>if</span> $table<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>without_oids<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>' without_oids'</span> 
                          <span class='Operator'>&& </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attname<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'oid'</span><span class='Delimiter'>; 
</span> 
                    <a href="genbki.pl.html#LN458"><span class='Ref_to_Func'>bki_insert</span></a><span class='Parentheses'>(</span>$row<span class='Delimiter'>, </span>@attnames<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>print </span>$bki <span class='String'>"close $catname\n"</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'># Any information needed for the BKI that is not contained in a pg_*.h header 
# (i.e., not contained in a header with a CATALOG() statement) comes here 
</span> 
<span class='Comment_Single_Line'># Write out declare toast/index statements 
</span><span class='Control'>foreach</span> <span class='Keyword'>my </span>$declaration <span class='Parentheses'>(</span>@<span class='Delimiter'>{ </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>toasting<span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>data<span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Keyword'>print </span>$bki $declaration<span class='Delimiter'>; 
} 
</span> 
<span class='Control'>foreach</span> <span class='Keyword'>my </span>$declaration <span class='Parentheses'>(</span>@<span class='Delimiter'>{ </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>indexing<span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>data<span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Keyword'>print </span>$bki $declaration<span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Single_Line'># Now generate schemapg.h 
</span> 
<span class='Comment_Single_Line'># Opening boilerplate for schemapg.h 
</span><span class='Keyword'>print </span>$schemapg <span class='Operator'>&LT;&LT;</span>EOM<span class='Delimiter'>; 
</span><span class='Operator'>/*------------------------------------------------------------------------- 
</span> <span class='Operator'>* 
</span> <span class='Operator'>* </span>schemapg<span class='Operator'>.</span>h 
 <span class='Operator'>*</span>    Schema_pg_xxx macros <span class='Control'>for</span> <span class='Control'>use</span> by relcache<span class='Operator'>.</span>c 
 <span class='Operator'>* 
</span> <span class='Operator'>* </span>Portions Copyright <span class='Parentheses'>(</span>c<span class='Parentheses'>) </span>1996<span class='Operator'>-</span>2017<span class='Delimiter'>, </span>PostgreSQL Global Development Group 
 <span class='Operator'>* </span>Portions Copyright <span class='Parentheses'>(</span>c<span class='Parentheses'>) </span>1994<span class='Delimiter'>, </span>Regents of the University of California 
 <span class='Operator'>* 
</span> <span class='Operator'>* </span>NOTES 
 <span class='Operator'>*</span>  <span class='Operator'>****************************** 
</span> <span class='Operator'>*</span>  <span class='Operator'>*** </span>DO NOT EDIT THIS FILE<span class='Operator'>! *** 
</span> <span class='Operator'>*</span>  <span class='Operator'>****************************** 
</span> <span class='Operator'>* 
</span> <span class='Operator'>*</span>  It has been GENERATED by $0 
 <span class='Operator'>* 
</span> <span class='Operator'>*------------------------------------------------------------------------- 
</span> <span class='Operator'>*/ 
</span><span class='Comment_Single_Line'>#ifndef SCHEMAPG_H 
#define SCHEMAPG_H 
</span>EOM 
 
<span class='Comment_Single_Line'># Emit schemapg declarations 
</span><span class='Control'>foreach</span> <span class='Keyword'>my </span>$table_name <span class='Parentheses'>(</span>@tables_needing_macros<span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Keyword'>print </span>$schemapg <span class='String'>"\n#define Schema_$table_name \\\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$schemapg <span class='Keyword'>join </span><span class='String'>", \\\n"</span><span class='Delimiter'>, </span>@<span class='Delimiter'>{ </span>$schemapg_entries<span class='Delimiter'>{</span>$table_name<span class='Delimiter'>} }; 
</span>    <span class='Keyword'>print </span>$schemapg <span class='String'>"\n"</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'># Closing boilerplate for schemapg.h 
</span><span class='Keyword'>print </span>$schemapg <span class='String'>"\n#endif /* SCHEMAPG_H */\n"</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># We're done emitting data 
</span><span class='Keyword'>close </span>$bki<span class='Delimiter'>; 
</span><span class='Keyword'>close </span>$schemapg<span class='Delimiter'>; 
</span><span class='Keyword'>close </span>$descr<span class='Delimiter'>; 
</span><span class='Keyword'>close </span>$shdescr<span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Finally, rename the completed files into place. 
</span>Catalog<span class='Operator'>::</span><a href="Catalog.pm.html#LN245"><span class='Ref_to_Func'>RenameTempFile</span></a><span class='Parentheses'>(</span>$bkifile<span class='Delimiter'>,</span>     $tmpext<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>Catalog<span class='Operator'>::</span><a href="Catalog.pm.html#LN245"><span class='Ref_to_Func'>RenameTempFile</span></a><span class='Parentheses'>(</span>$schemafile<span class='Delimiter'>,</span>  $tmpext<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>Catalog<span class='Operator'>::</span><a href="Catalog.pm.html#LN245"><span class='Ref_to_Func'>RenameTempFile</span></a><span class='Parentheses'>(</span>$descrfile<span class='Delimiter'>,</span>   $tmpext<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>Catalog<span class='Operator'>::</span><a href="Catalog.pm.html#LN245"><span class='Ref_to_Func'>RenameTempFile</span></a><span class='Parentheses'>(</span>$shdescrfile<span class='Delimiter'>, </span>$tmpext<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Control'>exit</span> 0<span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'>#################### Subroutines ######################## 
</span> 
 
<span class='Comment_Single_Line'># Given a system catalog name and a reference to a key-value pair corresponding 
# to the name and type of a column, generate a reference to a hash that 
# represents a pg_attribute entry.  We must also be told whether preceding 
# columns were all not-null. 
</span><a name="LN380"></a><span class='Control'>sub</span> <span class='Declare_Function'>emit_pgattr_row</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$table_name<span class='Delimiter'>, </span>$attr<span class='Delimiter'>, </span>$priornotnull<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$attname <span class='Operator'>= </span>$attr<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><a href="../../test/perl/PostgresNode.pm.html#LN216"><span class='Ref_to_Func'>name</span></a><span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$atttype <span class='Operator'>= </span>$attr<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>type<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>%row<span class='Delimiter'>; 
</span> 
    $row<span class='Delimiter'>{</span>attrelid<span class='Delimiter'>} </span><span class='Operator'>= </span>$catalogs<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$table_name<span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>relation_oid<span class='Delimiter'>}; 
</span>    $row<span class='Delimiter'>{</span>attname<span class='Delimiter'>}</span>  <span class='Operator'>= </span>$attname<span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># Adjust type name for arrays: foo[] becomes _foo 
</span>    <span class='Comment_Single_Line'># so we can look it up in pg_type 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$atttype <span class='Operator'>=~ /(.+)\[\]$/</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $atttype <span class='Operator'>= </span><span class='String'>'_'</span> <span class='Operator'>. </span>$1<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'># Copy the type data from pg_type, and add some type-dependent items 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$type <span class='Parentheses'>(</span>@types<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typname<span class='Delimiter'>} </span><span class='Operator'>&& </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typname<span class='Delimiter'>} </span><span class='Operator'>eq </span>$atttype<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $row<span class='Delimiter'>{</span>atttypid<span class='Delimiter'>}</span>   <span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>}; 
</span>            $row<span class='Delimiter'>{</span>attlen<span class='Delimiter'>}</span>     <span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typlen<span class='Delimiter'>}; 
</span>            $row<span class='Delimiter'>{</span>attbyval<span class='Delimiter'>}</span>   <span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typbyval<span class='Delimiter'>}; 
</span>            $row<span class='Delimiter'>{</span>attstorage<span class='Delimiter'>} </span><span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typstorage<span class='Delimiter'>}; 
</span>            $row<span class='Delimiter'>{</span>attalign<span class='Delimiter'>}</span>   <span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typalign<span class='Delimiter'>}; 
</span> 
            <span class='Comment_Single_Line'># set attndims if it's an array type 
</span>            $row<span class='Delimiter'>{</span>attndims<span class='Delimiter'>} </span><span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typcategory<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'A'</span> <span class='Operator'>? </span><span class='String'>'1'</span> <span class='Operator'>: </span><span class='String'>'0'</span><span class='Delimiter'>; 
</span>            $row<span class='Delimiter'>{</span>attcollation<span class='Delimiter'>} </span><span class='Operator'>= </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typcollation<span class='Delimiter'>}; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$attr<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>forcenotnull<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                $row<span class='Delimiter'>{</span>attnotnull<span class='Delimiter'>} </span><span class='Operator'>= </span><span class='String'>'t'</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>elsif</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$attr<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>forcenull<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                $row<span class='Delimiter'>{</span>attnotnull<span class='Delimiter'>} </span><span class='Operator'>= </span><span class='String'>'f'</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$priornotnull<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span> 
                <span class='Comment_Single_Line'># attnotnull will automatically be set if the type is 
</span>                <span class='Comment_Single_Line'># fixed-width and prior columns are all NOT NULL --- 
</span>                <span class='Comment_Single_Line'># compare DefineAttr in bootstrap.c. oidvector and 
</span>                <span class='Comment_Single_Line'># int2vector are also treated as not-nullable. 
</span>                $row<span class='Delimiter'>{</span>attnotnull<span class='Delimiter'>} </span><span class='Operator'>= 
</span>                    $type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typname<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'oidvector'</span>   <span class='Operator'>? </span><span class='String'>'t'</span> 
                  <span class='Operator'>: </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typname<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'int2vector'</span>  <span class='Operator'>? </span><span class='String'>'t'</span> 
                  <span class='Operator'>: </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typlen<span class='Delimiter'>}</span>  <span class='Operator'>eq </span><span class='String'>'NAMEDATALEN'</span> <span class='Operator'>? </span><span class='String'>'t'</span> 
                  <span class='Operator'>: </span>$type<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>typlen<span class='Delimiter'>} </span><span class='Operator'>&GT; </span>0 <span class='Operator'>? </span><span class='String'>'t'</span> 
                  <span class='Operator'>:</span>                       <span class='String'>'f'</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                $row<span class='Delimiter'>{</span>attnotnull<span class='Delimiter'>} </span><span class='Operator'>= </span><span class='String'>'f'</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>last</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'># Add in default values for pg_attribute 
</span>    <span class='Keyword'>my </span>%PGATTR_DEFAULTS <span class='Operator'>= </span><span class='Parentheses'>( 
</span>        attcacheoff   <span class='Operator'>=&GT; </span><span class='String'>'-1'</span><span class='Delimiter'>, 
</span>        atttypmod     <span class='Operator'>=&GT; </span><span class='String'>'-1'</span><span class='Delimiter'>, 
</span>        atthasdef     <span class='Operator'>=&GT; </span><span class='String'>'f'</span><span class='Delimiter'>, 
</span>        attidentity   <span class='Operator'>=&GT; </span><span class='String'>''</span><span class='Delimiter'>, 
</span>        attisdropped  <span class='Operator'>=&GT; </span><span class='String'>'f'</span><span class='Delimiter'>, 
</span>        attislocal    <span class='Operator'>=&GT; </span><span class='String'>'t'</span><span class='Delimiter'>, 
</span>        attinhcount   <span class='Operator'>=&GT; </span><span class='String'>'0'</span><span class='Delimiter'>, 
</span>        attacl        <span class='Operator'>=&GT; </span><span class='String'>'_null_'</span><span class='Delimiter'>, 
</span>        attoptions    <span class='Operator'>=&GT; </span><span class='String'>'_null_'</span><span class='Delimiter'>, 
</span>        attfdwoptions <span class='Operator'>=&GT; </span><span class='String'>'_null_'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Delimiter'>{ </span>%PGATTR_DEFAULTS<span class='Delimiter'>, </span>%row <span class='Delimiter'>}; 
} 
</span> 
<span class='Comment_Single_Line'># Write a pg_attribute entry to postgres.bki 
</span><a name="LN458"></a><span class='Control'>sub</span> <span class='Declare_Function'>bki_insert</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span>$row        <span class='Operator'>= </span><span class='Keyword'>shift</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>@attnames   <span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$oid        <span class='Operator'>= </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>oid<span class='Delimiter'>} </span><span class='Operator'>? </span><span class='String'>"OID = $row-&GT;{oid} "</span> <span class='Operator'>: </span><span class='String'>''</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$bki_values <span class='Operator'>= </span><span class='Keyword'>join </span><span class='String'>' '</span><span class='Delimiter'>, </span><span class='Keyword'>map </span><span class='Delimiter'>{ </span>$_ <span class='Operator'>eq </span><span class='String'>''</span> <span class='Operator'>? </span><span class='String'>'""'</span> <span class='Operator'>: </span>$_ <span class='Delimiter'>} </span><span class='Keyword'>map </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$_<span class='Delimiter'>}, 
</span>      @attnames<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$bki <span class='String'>"insert %s( %s )\n"</span><span class='Delimiter'>, </span>$oid<span class='Delimiter'>, </span>$bki_values<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'># The field values of a Schema_pg_xxx declaration are similar, but not 
# quite identical, to the corresponding values in postgres.bki. 
</span><a name="LN470"></a><span class='Control'>sub</span> <span class='Declare_Function'>emit_schemapg_row</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span>$row        <span class='Operator'>= </span><span class='Keyword'>shift</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>@bool_attrs <span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># Replace empty string by zero char constant 
</span>    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attidentity<span class='Delimiter'>} </span><span class='Operator'>||= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># Supply appropriate quoting for these fields. 
</span>    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attname<span class='Delimiter'>}</span>     <span class='Operator'>= q</span><span class='String'>|{"|</span> <span class='Operator'>. </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attname<span class='Delimiter'>} </span><span class='Operator'>. q</span><span class='String'>|"}|</span><span class='Delimiter'>; 
</span>    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attstorage<span class='Delimiter'>}</span>  <span class='Operator'>= q</span><span class='String'>|'|</span> <span class='Operator'>. </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attstorage<span class='Delimiter'>} </span><span class='Operator'>. q</span><span class='String'>|'|</span><span class='Delimiter'>; 
</span>    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attalign<span class='Delimiter'>}</span>    <span class='Operator'>= q</span><span class='String'>|'|</span> <span class='Operator'>. </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attalign<span class='Delimiter'>} </span><span class='Operator'>. q</span><span class='String'>|'|</span><span class='Delimiter'>; 
</span>    $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attidentity<span class='Delimiter'>} </span><span class='Operator'>= q</span><span class='String'>|'|</span> <span class='Operator'>. </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attidentity<span class='Delimiter'>} </span><span class='Operator'>. q</span><span class='String'>|'|</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># We don't emit initializers for the variable length fields at all. 
</span>    <span class='Comment_Single_Line'># Only the fixed-size portions of the descriptors are ever used. 
</span>    <span class='Keyword'>delete </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attacl<span class='Delimiter'>}; 
</span>    <span class='Keyword'>delete </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attoptions<span class='Delimiter'>}; 
</span>    <span class='Keyword'>delete </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>attfdwoptions<span class='Delimiter'>}; 
</span> 
    <span class='Comment_Single_Line'># Expand booleans from 'f'/'t' to 'false'/'true'. 
</span>    <span class='Comment_Single_Line'># Some values might be other macros (eg FLOAT4PASSBYVAL), don't change. 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$attr <span class='Parentheses'>(</span>@bool_attrs<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$attr<span class='Delimiter'>} </span><span class='Operator'>= 
</span>            $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$attr<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'t'</span> <span class='Operator'>? </span><span class='String'>'true'</span> 
          <span class='Operator'>: </span>$row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$attr<span class='Delimiter'>} </span><span class='Operator'>eq </span><span class='String'>'f'</span> <span class='Operator'>? </span><span class='String'>'false'</span> 
          <span class='Operator'>:</span>                        $row<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$attr<span class='Delimiter'>}; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> $row<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'># Find a symbol defined in a particular header file and extract the value. 
</span><a name="LN503"></a><span class='Control'>sub</span> <span class='Declare_Function'>find_defined_symbol</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$catalog_header<span class='Delimiter'>, </span>$symbol<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Keyword'>my </span>$path <span class='Parentheses'>(</span>@include_path<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <span class='Comment_Single_Line'># Make sure include path ends in a slash. 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>substr</span><span class='Parentheses'>(</span>$path<span class='Delimiter'>, </span><span class='Operator'>-</span>1<span class='Parentheses'>) </span><span class='Operator'>ne </span><span class='String'>'/'</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            $path <span class='Operator'>.= </span><span class='String'>'/'</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Keyword'>my </span>$file <span class='Operator'>= </span>$path <span class='Operator'>. </span>$catalog_header<span class='Delimiter'>; 
</span>        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Operator'>!-</span>f $file<span class='Delimiter'>; 
</span>        <span class='Keyword'>open</span><span class='Parentheses'>(</span><span class='Keyword'>my </span>$find_defined_symbol<span class='Delimiter'>, </span><span class='String'>'&LT;'</span><span class='Delimiter'>, </span>$file<span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Control'>die</span> <span class='String'>"$file: $!"</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>&LT;</span>$find_defined_symbol<span class='Operator'>&GT;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>/^#define\s+\Q$symbol\E\s+(\S+)/</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>return</span> $1<span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Keyword'>close </span>$find_defined_symbol<span class='Delimiter'>; 
</span>        <span class='Control'>die</span> <span class='String'>"$file: no definition found for $symbol\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>die</span> <span class='String'>"$catalog_header: not found in any include directory\n"</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN530"></a><span class='Control'>sub</span> <span class='Declare_Function'>usage</span> 
<span class='Delimiter'>{ 
</span>    <span class='Control'>die</span> <span class='Operator'>&LT;&LT;</span>EOM<span class='Delimiter'>; 
</span><a href="../../tools/msvc/install.pl.html#LN27"><span class='Ref_to_Func'>Usage</span></a><span class='Operator'>: </span>genbki<span class='Operator'>.</span>pl <span class='Delimiter'>[</span>options<span class='Delimiter'>] </span>header<span class='Operator'>... 
</span> 
Options<span class='Operator'>: 
</span>    <span class='Operator'>-</span>I               path to include files 
    <span class='Operator'>-</span>o               output path 
    <span class='Operator'>--</span>set<span class='Operator'>-</span>version    PostgreSQL version number <span class='Control'>for</span> initdb cross<span class='Operator'>-</span><a href="../../tools/msvc/vcregress.pl.html#LN114"><span class='Ref_to_Func'>check</span></a> 
 
genbki<span class='Operator'>.</span>pl generates BKI files from specially formatted 
header files<span class='Operator'>.</span>  These BKI files are used to initialize the 
postgres template database<span class='Operator'>. 
</span> 
Report bugs to <span class='Operator'>&LT;</span>pgsql<span class='Operator'>-</span>bugs<span class='Operator'>\</span>@postgresql<span class='Operator'>.</span>org<span class='Operator'>&GT;. 
</span>EOM 
<span class='Delimiter'>} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>