<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\catalog\heap.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\catalog\heap.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:31 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * heap.c 
 *    code to create and destroy POSTGRES heap relations 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/catalog/heap.c 
 * 
 * 
 * INTERFACE ROUTINES 
 *      heap_create()           - Create an uncataloged heap relation 
 *      heap_create_with_catalog() - Create a cataloged relation 
 *      heap_drop_with_catalog() - Removes named relation from catalogs 
 * 
 * NOTES 
 *    this code taken from access/heap/create.c, which contains 
 *    the old heap_create_with_catalog, amcreate, and amdestroy. 
 *    those routines will soon call these routines using the function 
 *    manager, 
 *    just like the poorly named "NewXXX" routines do.  The 
 *    "New" routines are all going to die soon, once and for all! 
 *      -cim 1/13/91 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/binary_upgrade.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/heap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/partition.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_attrdef.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_collation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_constraint.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_constraint_fn.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_foreign_table.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_inherits.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opclass.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_partitioned_table.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_statistic.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_subscription_rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type_fn.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/storage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/storage_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/typecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/nodeFuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/var.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_coerce.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_collate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_expr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_relation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ruleutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Potentially set by pg_upgrade_support functions */ 
</span><a name="LN85"></a><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Var'>binary_upgrade_next_heap_pg_class_oid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN86"></a><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Var'>binary_upgrade_next_toast_pg_class_oid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
<a name="LN88"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AddNewRelationTuple</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Delimiter'>, 
</span><a name="LN89"></a>                    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>new_rel_desc</span><span class='Delimiter'>, 
</span><a name="LN90"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_rel_oid</span><span class='Delimiter'>, 
</span><a name="LN91"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_type_oid</span><span class='Delimiter'>, 
</span><a name="LN92"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reloftype</span><span class='Delimiter'>, 
</span><a name="LN93"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relowner</span><span class='Delimiter'>, 
</span><a name="LN94"></a>                    <span class='Keyword'>char </span><span class='Declare_Parameter'>relkind</span><span class='Delimiter'>, 
</span><a name="LN95"></a>                    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>relacl</span><span class='Delimiter'>, 
</span><a name="LN96"></a>                    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static </span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Prototype'>AddNewRelationType</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>typeName</span><span class='Delimiter'>, 
</span><a name="LN98"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typeNamespace</span><span class='Delimiter'>, 
</span><a name="LN99"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_rel_oid</span><span class='Delimiter'>, 
</span><a name="LN100"></a>                   <span class='Keyword'>char </span><span class='Declare_Parameter'>new_rel_kind</span><span class='Delimiter'>, 
</span><a name="LN101"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>ownerid</span><span class='Delimiter'>, 
</span><a name="LN102"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_row_type</span><span class='Delimiter'>, 
</span><a name="LN103"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_array_type</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN104"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RelationRemoveInheritance</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN105"></a><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Prototype'>StoreRelCheck</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ccname</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>expr</span><span class='Delimiter'>, 
</span><a name="LN106"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_validated</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_local</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>inhcount</span><span class='Delimiter'>, 
</span><a name="LN107"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_inherit</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN108"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>StoreConstraints</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cooked_constraints</span><span class='Delimiter'>, 
</span><a name="LN109"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN110"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>MergeWithExistingConstraint</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ccname</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>expr</span><span class='Delimiter'>, 
</span><a name="LN111"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_merge</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_local</span><span class='Delimiter'>, 
</span><a name="LN112"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_initially_valid</span><span class='Delimiter'>, 
</span><a name="LN113"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_inherit</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN114"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SetRelationNumChecks</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>numchecks</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN115"></a><span class='Keyword'>static </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>cookConstraint</span><span class='Parentheses'>(</span><a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN116"></a>               <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>raw_constraint</span><span class='Delimiter'>, 
</span><a name="LN117"></a>               <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>insert_ordered_unique_oid</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>datum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *              XXX UGLY HARD CODED BADNESS FOLLOWS XXX 
 * 
 *      these should all be moved to someplace in the lib/catalog 
 *      module, if not obliterated first. 
 * ---------------------------------------------------------------- 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Note: 
 *      Should the system special case these attributes in the future? 
 *      Advantage:  consume much less space in the ATTRIBUTE relation. 
 *      Disadvantage:  special cases will be all over the place. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The initializers below do not include trailing variable length fields, 
 * but that's OK - we're never going to reference anything beyond the 
 * fixed-size portion of the structure anyway. 
 */ 
</span> 
<a name="LN143"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a1</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"ctid"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN28"><span class='Ref_to_Const'>TIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN20"><span class='Ref_to_Const'>SelfItemPointerAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'s'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN149"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a2</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"oid"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN155"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a3</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"xmin"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN29"><span class='Ref_to_Const'>XIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN22"><span class='Ref_to_Const'>MinTransactionIdAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN161"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a4</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"cmin"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN30"><span class='Ref_to_Const'>CIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN23"><span class='Ref_to_Const'>MinCommandIdAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN167"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a5</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"xmax"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN29"><span class='Ref_to_Const'>XIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN24"><span class='Ref_to_Const'>MaxTransactionIdAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN173"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a6</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"cmax"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN30"><span class='Ref_to_Const'>CIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN25"><span class='Ref_to_Const'>MaxCommandIdAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We decided to call this attribute "tableoid" rather than say 
 * "classoid" on the basis that in the future there may be more than one 
 * table of a particular class/type. In any case table is still the word 
 * used in SQL. 
 */ 
</span><a name="LN185"></a><span class='Keyword'>static </span>FormData_pg_attribute <span class='Declare_Var'>a7</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, {</span><span class='String'>"tableoid"</span><span class='Delimiter'>}, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="../../include/access/sysattr.h.html#LN26"><span class='Ref_to_Const'>TableOidAttributeNumber</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'\0'</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN191"></a><span class='Keyword'>static const </span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Var'>SysAtt</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Operator'>&</span><a href="heap.c.html#LN143"><span class='Ref_to_Global_Var'>a1</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN149"><span class='Ref_to_Global_Var'>a2</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN155"><span class='Ref_to_Global_Var'>a3</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN161"><span class='Ref_to_Global_Var'>a4</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN167"><span class='Ref_to_Global_Var'>a5</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN173"><span class='Ref_to_Global_Var'>a6</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN185"><span class='Ref_to_Global_Var'>a7</span></a><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This function returns a Form_pg_attribute pointer for a system attribute. 
 * Note that we elog if the presented attno is invalid, which would only 
 * happen if there's a problem upstream. 
 */ 
</span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> 
<a name="LN199"></a><span class='Declare_Function'>SystemAttributeDefinition</span><span class='Parentheses'>(</span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Declare_Parameter'>attno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>relhasoids</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>&LT; -</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid system attribute number %d"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>== </span><a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a> <span class='Operator'>&& !</span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>relhasoids</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid system attribute number %d"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Delimiter'>[</span><span class='Operator'>-</span><a href="heap.c.html#LN199"><span class='Ref_to_Parameter'>attno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * If the given name is a system attribute name, return a Form_pg_attribute 
 * pointer for a prototype definition.  If not, return NULL. 
 */ 
</span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> 
<a name="LN213"></a><span class='Declare_Function'>SystemAttributeByName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>relhasoids</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN215"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN215"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN215"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="heap.c.html#LN215"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN219"></a>        <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN215"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN213"><span class='Ref_to_Parameter'>relhasoids</span></a> <span class='Operator'>|| </span><a href="heap.c.html#LN219"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attnum <span class='Operator'>!= </span><a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN219"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN213"><span class='Ref_to_Parameter'>attname</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <a href="heap.c.html#LN219"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *              XXX END OF UGLY HARD CODED BADNESS XXX 
 * ---------------------------------------------------------------- */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      heap_create     - Create an uncataloged heap relation 
 * 
 *      Note API change: the caller must now always provide the OID 
 *      to use for the relation.  The relfilenode may (and, normally, 
 *      should) be left unspecified. 
 * 
 *      rel-&GT;rd_rel is initialized by RelationBuildLocalRelation, 
 *      and is mostly zeroes at return. 
 * ---------------------------------------------------------------- 
 */ 
</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> 
<a name="LN249"></a><span class='Declare_Function'>heap_create</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Delimiter'>, 
</span><a name="LN250"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relnamespace</span><span class='Delimiter'>, 
</span><a name="LN251"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reltablespace</span><span class='Delimiter'>, 
</span><a name="LN252"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, 
</span><a name="LN253"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relfilenode</span><span class='Delimiter'>, 
</span><a name="LN254"></a>            <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupDesc</span><span class='Delimiter'>, 
</span><a name="LN255"></a>            <span class='Keyword'>char </span><span class='Declare_Parameter'>relkind</span><span class='Delimiter'>, 
</span><a name="LN256"></a>            <span class='Keyword'>char </span><span class='Declare_Parameter'>relpersistence</span><span class='Delimiter'>, 
</span><a name="LN257"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>shared_relation</span><span class='Delimiter'>, 
</span><a name="LN258"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>mapped_relation</span><span class='Delimiter'>, 
</span><a name="LN259"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_system_table_mods</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN261"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>create_storage</span><span class='Delimiter'>; 
</span><a name="LN262"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The caller must have provided an OID for the relation. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN252"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't allow creating relations in pg_catalog directly, even though it 
     * is allowed to move user defined relations there. Semantics with search 
     * paths including pg_catalog are too confusing for now. 
     * 
     * But allow creating indexes on relations in pg_catalog even if 
     * allow_system_table_mods = off, upper layers already guarantee it's on a 
     * user defined relation, not a system one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heap.c.html#LN259"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>((</span><a href="../../include/catalog/catalog.h.html#LN37"><span class='Ref_to_Proto'>IsSystemNamespace</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN250"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="heap.c.html#LN255"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>         <a href="../../include/catalog/catalog.h.html#LN38"><span class='Ref_to_Proto'>IsToastNamespace</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN250"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>        <a href="../../include/miscadmin.h.html#LN371"><span class='Ref_to_Macro'>IsNormalProcessingMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to create \"%s.%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN250"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN249"><span class='Ref_to_Parameter'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"System catalog modifications are currently disallowed."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decide if we need storage or not, and handle a couple other special 
     * cases for particular relkinds. 
     */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN255"><span class='Ref_to_Parameter'>relkind</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Operator'>: 
</span>            <a href="heap.c.html#LN261"><span class='Ref_To_Local'>create_storage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Force reltablespace to zero if the relation has no physical 
             * storage.  This is mainly just for cleanliness' sake. 
             */ 
</span>            <a href="heap.c.html#LN251"><span class='Ref_to_Parameter'>reltablespace</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN161"><span class='Ref_to_Const'>RELKIND_SEQUENCE</span></a><span class='Operator'>: 
</span>            <a href="heap.c.html#LN261"><span class='Ref_To_Local'>create_storage</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Force reltablespace to zero for sequences, since we don't 
             * support moving them around into different tablespaces. 
             */ 
</span>            <a href="heap.c.html#LN251"><span class='Ref_to_Parameter'>reltablespace</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="heap.c.html#LN261"><span class='Ref_To_Local'>create_storage</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch relkind &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Unless otherwise requested, the physical ID (relfilenode) is initially 
     * the same as the logical ID (OID).  When the caller did specify a 
     * relfilenode, it already exists; do not attempt to create it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN253"><span class='Ref_to_Parameter'>relfilenode</span></a><span class='Parentheses'>))</span> 
        <a href="heap.c.html#LN261"><span class='Ref_To_Local'>create_storage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heap.c.html#LN253"><span class='Ref_to_Parameter'>relfilenode</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN252"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Never allow a pg_class entry to explicitly specify the database's 
     * default tablespace in reltablespace; force it to zero instead. This 
     * ensures that if the database is cloned with a different default 
     * tablespace, the pg_class entry will still match where CREATE DATABASE 
     * will put the physically copied relation. 
     * 
     * Yes, this is a bit of a hack. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN251"><span class='Ref_to_Parameter'>reltablespace</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a><span class='Parentheses'>) 
</span>        <a href="heap.c.html#LN251"><span class='Ref_to_Parameter'>reltablespace</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * build the relcache entry. 
     */ 
</span>    <a href="heap.c.html#LN262"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/utils/relcache.h.html#LN91"><span class='Ref_to_Proto'>RelationBuildLocalRelation</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN249"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN250"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN254"><span class='Ref_to_Parameter'>tupDesc</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN252"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN253"><span class='Ref_to_Parameter'>relfilenode</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN251"><span class='Ref_to_Parameter'>reltablespace</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN257"><span class='Ref_to_Parameter'>shared_relation</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN258"><span class='Ref_to_Parameter'>mapped_relation</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN256"><span class='Ref_to_Parameter'>relpersistence</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN255"><span class='Ref_to_Parameter'>relkind</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Have the storage manager create the relation's disk file, if needed. 
     * 
     * We only create the main fork here, other forks will be created on 
     * demand. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN261"><span class='Ref_To_Local'>create_storage</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN262"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/storage.h.html#LN20"><span class='Ref_to_Proto'>RelationCreateStorage</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN262"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN256"><span class='Ref_to_Parameter'>relpersistence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN262"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_create &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      heap_create_with_catalog        - Create a cataloged relation 
 * 
 *      this is done in multiple steps: 
 * 
 *      1) CheckAttributeNamesTypes() is used to make certain the tuple 
 *         descriptor contains a valid set of attribute names and types 
 * 
 *      2) pg_class is opened and get_relname_relid() 
 *         performs a scan to ensure that no relation with the 
 *         same name already exists. 
 * 
 *      3) heap_create() is called to create the new relation on disk. 
 * 
 *      4) TypeCreate() is called to define a new type corresponding 
 *         to the new relation. 
 * 
 *      5) AddNewRelationTuple() is called to register the 
 *         relation in pg_class. 
 * 
 *      6) AddNewAttributeTuples() is called to register the 
 *         new relation's schema in pg_attribute. 
 * 
 *      7) StoreConstraints is called ()        - vadim 08/22/97 
 * 
 *      8) the relations are closed and the new relation's oid 
 *         is returned. 
 * 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      CheckAttributeNamesTypes 
 * 
 *      this is used to make certain the tuple descriptor contains a 
 *      valid set of attribute names and datatypes.  a problem simply 
 *      generates ereport(ERROR) which aborts the current transaction. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN409"></a><span class='Declare_Function'>CheckAttributeNamesTypes</span><span class='Parentheses'>(</span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Declare_Parameter'>relkind</span><span class='Delimiter'>, 
</span><a name="LN410"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_system_table_mods</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN412"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN413"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN414"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sanity check on column count */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN414"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="heap.c.html#LN414"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>&GT; </span><a href="../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_TOO_MANY_COLUMNS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tables can have at most %d columns"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/access/htup_details.h.html#LN46"><span class='Ref_to_Const'>MaxHeapAttributeNumber</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * first check for collision with system attribute names 
     * 
     * Skip this for a view or type relation, since those don't have system 
     * attributes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& </span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN414"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN125"><span class='Ref_to_Proto'>SystemAttributeByName</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN78"><span class='Ref_to_Member'>tdhasoid</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column name \"%s\" conflicts with a system column name"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * next check for repeated attribute names 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN414"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN413"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN413"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN413"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN413"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column name \"%s\" specified more than once"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN413"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * next check the attribute types 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN414"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/catalog/heap.h.html#LN131"><span class='Ref_to_Proto'>CheckAttributeType</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN409"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN412"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>, 
</span>                           <a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* assume we're creating a new rowtype */ 
</span>                           <a href="heap.c.html#LN410"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end CheckAttributeNamesTypes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      CheckAttributeType 
 * 
 *      Verify that the proposed datatype of an attribute is legal. 
 *      This is needed mainly because there are types (and pseudo-types) 
 *      in the catalogs that we do not support as elements of real tuples. 
 *      We also check some other properties required of a table column. 
 * 
 * If the attribute is being proposed for addition to an existing table or 
 * composite type, pass a one-element list of the rowtype OID as 
 * containing_rowtypes.  When checking a to-be-created rowtype, it's 
 * sufficient to pass NIL, because there could not be any recursive reference 
 * to a not-yet-existing rowtype. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN487"></a><span class='Declare_Function'>CheckAttributeType</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attname</span><span class='Delimiter'>, 
</span><a name="LN488"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>atttypid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>attcollation</span><span class='Delimiter'>, 
</span><a name="LN489"></a>                   <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>containing_rowtypes</span><span class='Delimiter'>, 
</span><a name="LN490"></a>                   <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_system_table_mods</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN492"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>att_typtype</span> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN149"><span class='Ref_to_Proto'>get_typtype</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN493"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>att_typelem</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN492"><span class='Ref_To_Local'>att_typtype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN723"><span class='Ref_to_Const'>TYPTYPE_PSEUDO</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Refuse any attempt to create a pseudo-type column, except for a 
         * special hack for pg_statistic: allow ANYARRAY when modifying system 
         * catalogs (this allows creating pg_statistic and cloning it during 
         * VACUUM FULL) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_type.h.html#LN687"><span class='Ref_to_Const'>ANYARRAYOID</span></a> <span class='Operator'>|| !</span><a href="heap.c.html#LN490"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TABLE_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column \"%s\" has pseudo-type %s"</span><span class='Delimiter'>, 
</span>                            <a href="heap.c.html#LN487"><span class='Ref_to_Parameter'>attname</span></a><span class='Delimiter'>, </span><a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN492"><span class='Ref_To_Local'>att_typtype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN721"><span class='Ref_to_Const'>TYPTYPE_DOMAIN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If it's a domain, recurse to check its base type. 
         */ 
</span>        <a href="../../include/catalog/heap.h.html#LN131"><span class='Ref_to_Proto'>CheckAttributeType</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN487"><span class='Ref_to_Parameter'>attname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/lsyscache.h.html#LN168"><span class='Ref_to_Proto'>getBaseType</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>attcollation</span></a><span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a><span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN490"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN492"><span class='Ref_To_Local'>att_typtype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_type.h.html#LN720"><span class='Ref_to_Const'>TYPTYPE_COMPOSITE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * For a composite type, recurse into its attributes. 
         */ 
</span><a name="LN523"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>relation</span><span class='Delimiter'>; 
</span><a name="LN524"></a>        <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN525"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check for self-containment.  Eventually we might be able to allow 
         * this (just return without complaint, if so) but it's not clear how 
         * many other places would require anti-recursion defenses before it 
         * would be safe to allow tables to contain their own rowtype. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TABLE_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"composite type %s cannot be made a member of itself"</span><span class='Delimiter'>, 
</span>                       <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN217"><span class='Ref_to_Proto'>lcons_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN523"><span class='Ref_To_Local'>relation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN156"><span class='Ref_to_Proto'>get_typ_typrelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN524"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN523"><span class='Ref_To_Local'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN525"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN525"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN524"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN525"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN547"></a>            <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attr</span> <span class='Operator'>= </span><a href="heap.c.html#LN524"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN525"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN547"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <a href="../../include/catalog/heap.h.html#LN131"><span class='Ref_to_Proto'>CheckAttributeType</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN547"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN547"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, </span><a href="heap.c.html#LN547"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN490"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN523"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if att_typtype==TYPTYPE_... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>((</span><a href="heap.c.html#LN493"><span class='Ref_To_Local'>att_typelem</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN157"><span class='Ref_to_Proto'>get_element_type</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Must recurse into array types, too, in case they are composite. 
         */ 
</span>        <a href="../../include/catalog/heap.h.html#LN131"><span class='Ref_to_Proto'>CheckAttributeType</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN487"><span class='Ref_to_Parameter'>attname</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN493"><span class='Ref_To_Local'>att_typelem</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>attcollation</span></a><span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN489"><span class='Ref_to_Parameter'>containing_rowtypes</span></a><span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN490"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This might not be strictly invalid per SQL standard, but it is pretty 
     * useless, and it cannot be dumped, so we must disallow it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>attcollation</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../include/utils/lsyscache.h.html#LN167"><span class='Ref_to_Proto'>type_is_collatable</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TABLE_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no collation was derived for column \"%s\" with collatable type %s"</span><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN487"><span class='Ref_to_Parameter'>attname</span></a><span class='Delimiter'>, </span><a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN488"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use the COLLATE clause to set the collation explicitly."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckAttributeType &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * InsertPgAttributeTuple 
 *      Construct and insert a new tuple in pg_attribute. 
 * 
 * Caller has already opened and locked pg_attribute.  new_attribute is the 
 * attribute to insert (but we ignore attacl and attoptions, which are always 
 * initialized to NULL). 
 * 
 * indstate is the index state for CatalogTupleInsertWithInfo.  It can be 
 * passed as NULL, in which case we'll fetch the necessary info.  (Don't do 
 * this when inserting multiple attributes, because it's a tad more 
 * expensive.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN597"></a><span class='Declare_Function'>InsertPgAttributeTuple</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pg_attribute_rel</span><span class='Delimiter'>, 
</span><a name="LN598"></a>                       <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Parameter'>new_attribute</span><span class='Delimiter'>, 
</span><a name="LN599"></a>                       <a href="../../include/catalog/indexing.h.html#LN25"><span class='Ref_to_Typedef'>CatalogIndexState</span></a> <span class='Declare_Parameter'>indstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN601"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN193"><span class='Ref_to_Const'>Natts_pg_attribute</span></a><span class='Delimiter'>]; 
</span><a name="LN602"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN193"><span class='Ref_to_Const'>Natts_pg_attribute</span></a><span class='Delimiter'>]; 
</span><a name="LN603"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This is a tad tedious, but way cleaner than what we used to do... */ 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN602"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN602"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN194"><span class='Ref_to_Const'>Anum_pg_attribute_attrelid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attrelid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN195"><span class='Ref_to_Const'>Anum_pg_attribute_attname</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN600"><span class='Ref_to_Macro'>NameGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN196"><span class='Ref_to_Const'>Anum_pg_attribute_atttypid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN197"><span class='Ref_to_Const'>Anum_pg_attribute_attstattarget</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attstattarget<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN198"><span class='Ref_to_Const'>Anum_pg_attribute_attlen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attlen<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN199"><span class='Ref_to_Const'>Anum_pg_attribute_attnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attnum<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN200"><span class='Ref_to_Const'>Anum_pg_attribute_attndims</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attndims<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN201"><span class='Ref_to_Const'>Anum_pg_attribute_attcacheoff</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attcacheoff<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN202"><span class='Ref_to_Const'>Anum_pg_attribute_atttypmod</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN203"><span class='Ref_to_Const'>Anum_pg_attribute_attbyval</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attbyval<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN204"><span class='Ref_to_Const'>Anum_pg_attribute_attstorage</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attstorage<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN205"><span class='Ref_to_Const'>Anum_pg_attribute_attalign</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attalign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN206"><span class='Ref_to_Const'>Anum_pg_attribute_attnotnull</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attnotnull<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN207"><span class='Ref_to_Const'>Anum_pg_attribute_atthasdef</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>atthasdef<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN208"><span class='Ref_to_Const'>Anum_pg_attribute_attidentity</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attidentity<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN209"><span class='Ref_to_Const'>Anum_pg_attribute_attisdropped</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN210"><span class='Ref_to_Const'>Anum_pg_attribute_attislocal</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attislocal<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN211"><span class='Ref_to_Const'>Anum_pg_attribute_attinhcount</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attinhcount<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN212"><span class='Ref_to_Const'>Anum_pg_attribute_attcollation</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN598"><span class='Ref_to_Parameter'>new_attribute</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* start out with empty permissions and empty options */ 
</span>    <a href="heap.c.html#LN602"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN213"><span class='Ref_to_Const'>Anum_pg_attribute_attacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN602"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN214"><span class='Ref_to_Const'>Anum_pg_attribute_attoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN602"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attribute.h.html#LN215"><span class='Ref_to_Const'>Anum_pg_attribute_attfdwoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN603"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN597"><span class='Ref_to_Parameter'>pg_attribute_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN601"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN602"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* finally insert the new tuple, update the indexes, and clean up */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN599"><span class='Ref_to_Parameter'>indstate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/catalog/indexing.h.html#LN33"><span class='Ref_to_Proto'>CatalogTupleInsertWithInfo</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN597"><span class='Ref_to_Parameter'>pg_attribute_rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN603"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN599"><span class='Ref_to_Parameter'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN597"><span class='Ref_to_Parameter'>pg_attribute_rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN603"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN603"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InsertPgAttributeTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      AddNewAttributeTuples 
 * 
 *      this registers the new relation's schema by adding 
 *      tuples to pg_attribute. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN653"></a><span class='Declare_Function'>AddNewAttributeTuples</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_rel_oid</span><span class='Delimiter'>, 
</span><a name="LN654"></a>                      <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, 
</span><a name="LN655"></a>                      <span class='Keyword'>char </span><span class='Declare_Parameter'>relkind</span><span class='Delimiter'>, 
</span><a name="LN656"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>oidislocal</span><span class='Delimiter'>, 
</span><a name="LN657"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>oidinhcount</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN659"></a>    <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attr</span><span class='Delimiter'>; 
</span><a name="LN660"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN661"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN662"></a>    <a href="../../include/catalog/indexing.h.html#LN25"><span class='Ref_to_Typedef'>CatalogIndexState</span></a> <span class='Declare_Local'>indstate</span><span class='Delimiter'>; 
</span><a name="LN663"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="heap.c.html#LN654"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN664"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>, 
</span><a name="LN665"></a>                <span class='Declare_Local'>referenced</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * open pg_attribute and its indexes. 
     */ 
</span>    <a href="heap.c.html#LN661"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN662"><span class='Ref_To_Local'>indstate</span></a> <span class='Operator'>= </span><a href="../../include/catalog/indexing.h.html#LN30"><span class='Ref_to_Proto'>CatalogOpenIndexes</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN661"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First we add the user attributes.  This is also a convenient place to 
     * add dependencies on their datatypes and collations. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN663"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN654"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Comment_Multi_Line'>/* Fill in the correct relation OID */ 
</span>        <a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attrelid <span class='Operator'>= </span><a href="heap.c.html#LN653"><span class='Ref_to_Parameter'>new_rel_oid</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Make sure these are OK, too */ 
</span>        <a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attstattarget <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attcacheoff <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/heap.h.html#LN87"><span class='Ref_to_Proto'>InsertPgAttributeTuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN661"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN662"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Add dependency info */ 
</span>        <a href="heap.c.html#LN664"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN664"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN653"><span class='Ref_to_Parameter'>new_rel_oid</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN664"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_type.h.html#LN33"><span class='Ref_to_Const'>TypeRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN664"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The default collation is pinned, so don't bother recording it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attcollation <span class='Operator'>!= </span><a href="../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_collation.h.html#LN29"><span class='Ref_to_Const'>CollationRelationId</span></a><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN659"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN664"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN665"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;natts;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Next we add the system attributes.  Skip OID if rel has no OIDs. Skip 
     * all for a view or type relation.  We don't bother with making datatype 
     * dependencies here, since presumably all these types are pinned. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN655"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& </span><a href="heap.c.html#LN655"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN718"></a>            FormData_pg_attribute <span class='Declare_Local'>attStruct</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* skip OID where appropriate */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heap.c.html#LN654"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN78"><span class='Ref_to_Member'>tdhasoid</span></a> <span class='Operator'>&& 
</span>                <a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attnum <span class='Operator'>== </span><a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN718"><span class='Ref_To_Local'>attStruct</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heap.c.html#LN191"><span class='Ref_to_Global_Var'>SysAtt</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN660"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>FormData_pg_attribute<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Fill in the correct relation OID in the copied tuple */ 
</span>            <a href="heap.c.html#LN718"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>.</span>attrelid <span class='Operator'>= </span><a href="heap.c.html#LN653"><span class='Ref_to_Parameter'>new_rel_oid</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Fill in correct inheritance info for the OID column */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN718"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>.</span>attnum <span class='Operator'>== </span><a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="heap.c.html#LN718"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>.</span>attislocal <span class='Operator'>= </span><a href="heap.c.html#LN656"><span class='Ref_to_Parameter'>oidislocal</span></a><span class='Delimiter'>; 
</span>                <a href="heap.c.html#LN718"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>.</span>attinhcount <span class='Operator'>= </span><a href="heap.c.html#LN657"><span class='Ref_to_Parameter'>oidinhcount</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/catalog/heap.h.html#LN87"><span class='Ref_to_Proto'>InsertPgAttributeTuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN661"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN718"><span class='Ref_To_Local'>attStruct</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN662"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;(int)lengthof(S... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if relkind!=RELKIND_VIEW... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * clean up 
     */ 
</span>    <a href="../../include/catalog/indexing.h.html#LN31"><span class='Ref_to_Proto'>CatalogCloseIndexes</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN662"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN661"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddNewAttributeTuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      InsertPgClassTuple 
 * 
 *      Construct and insert a new tuple in pg_class. 
 * 
 * Caller has already opened and locked pg_class. 
 * Tuple data is taken from new_rel_desc-&GT;rd_rel, except for the 
 * variable-width fields which are not present in a cached reldesc. 
 * relacl and reloptions are passed in Datum form (to avoid having 
 * to reference the data types in heap.h).  Pass (Datum) 0 to set them 
 * to NULL. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN763"></a><span class='Declare_Function'>InsertPgClassTuple</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Delimiter'>, 
</span><a name="LN764"></a>                   <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>new_rel_desc</span><span class='Delimiter'>, 
</span><a name="LN765"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_rel_oid</span><span class='Delimiter'>, 
</span><a name="LN766"></a>                   <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>relacl</span><span class='Delimiter'>, 
</span><a name="LN767"></a>                   <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN769"></a>    <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>rd_rel</span> <span class='Operator'>= </span><a href="heap.c.html#LN764"><span class='Ref_to_Parameter'>new_rel_desc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Delimiter'>; 
</span><a name="LN770"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN101"><span class='Ref_to_Const'>Natts_pg_class</span></a><span class='Delimiter'>]; 
</span><a name="LN771"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN101"><span class='Ref_to_Const'>Natts_pg_class</span></a><span class='Delimiter'>]; 
</span><a name="LN772"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This is a tad tedious, but way cleaner than what we used to do... */ 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN771"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN771"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN102"><span class='Ref_to_Const'>Anum_pg_class_relname</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN600"><span class='Ref_to_Macro'>NameGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN103"><span class='Ref_to_Const'>Anum_pg_class_relnamespace</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN104"><span class='Ref_to_Const'>Anum_pg_class_reltype</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN105"><span class='Ref_to_Const'>Anum_pg_class_reloftype</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>reloftype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN106"><span class='Ref_to_Const'>Anum_pg_class_relowner</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relowner<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN107"><span class='Ref_to_Const'>Anum_pg_class_relam</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relam<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN108"><span class='Ref_to_Const'>Anum_pg_class_relfilenode</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relfilenode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN109"><span class='Ref_to_Const'>Anum_pg_class_reltablespace</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltablespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN110"><span class='Ref_to_Const'>Anum_pg_class_relpages</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpages<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN111"><span class='Ref_to_Const'>Anum_pg_class_reltuples</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN696"><span class='Ref_to_Func'>Float4GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltuples<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN112"><span class='Ref_to_Const'>Anum_pg_class_relallvisible</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relallvisible<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN113"><span class='Ref_to_Const'>Anum_pg_class_reltoastrelid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN114"><span class='Ref_to_Const'>Anum_pg_class_relhasindex</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasindex<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN115"><span class='Ref_to_Const'>Anum_pg_class_relisshared</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN116"><span class='Ref_to_Const'>Anum_pg_class_relpersistence</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN117"><span class='Ref_to_Const'>Anum_pg_class_relkind</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN118"><span class='Ref_to_Const'>Anum_pg_class_relnatts</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnatts<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN119"><span class='Ref_to_Const'>Anum_pg_class_relchecks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relchecks<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN120"><span class='Ref_to_Const'>Anum_pg_class_relhasoids</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasoids<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN121"><span class='Ref_to_Const'>Anum_pg_class_relhaspkey</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhaspkey<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN122"><span class='Ref_to_Const'>Anum_pg_class_relhasrules</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasrules<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN123"><span class='Ref_to_Const'>Anum_pg_class_relhastriggers</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhastriggers<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN125"><span class='Ref_to_Const'>Anum_pg_class_relrowsecurity</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relrowsecurity<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN126"><span class='Ref_to_Const'>Anum_pg_class_relforcerowsecurity</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relforcerowsecurity<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN124"><span class='Ref_to_Const'>Anum_pg_class_relhassubclass</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhassubclass<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN127"><span class='Ref_to_Const'>Anum_pg_class_relispopulated</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relispopulated<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN128"><span class='Ref_to_Const'>Anum_pg_class_relreplident</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relreplident<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN129"><span class='Ref_to_Const'>Anum_pg_class_relispartition</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relispartition<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN130"><span class='Ref_to_Const'>Anum_pg_class_relfrozenxid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN526"><span class='Ref_to_Macro'>TransactionIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relfrozenxid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN131"><span class='Ref_to_Const'>Anum_pg_class_relminmxid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN533"><span class='Ref_to_Macro'>MultiXactIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN769"><span class='Ref_To_Local'>rd_rel</span></a><span class='Operator'>-&GT;</span>relminmxid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN766"><span class='Ref_to_Parameter'>relacl</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN132"><span class='Ref_to_Const'>Anum_pg_class_relacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heap.c.html#LN766"><span class='Ref_to_Parameter'>relacl</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heap.c.html#LN771"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN132"><span class='Ref_to_Const'>Anum_pg_class_relacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN767"><span class='Ref_to_Parameter'>reloptions</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN133"><span class='Ref_to_Const'>Anum_pg_class_reloptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heap.c.html#LN767"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heap.c.html#LN771"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN133"><span class='Ref_to_Const'>Anum_pg_class_reloptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* relpartbound is set by updating this tuple, if necessary */ 
</span>    <a href="heap.c.html#LN771"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN134"><span class='Ref_to_Const'>Anum_pg_class_relpartbound</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN772"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN763"><span class='Ref_to_Parameter'>pg_class_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN770"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN771"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The new tuple must have the oid already chosen for the rel.  Sure would 
     * be embarrassing to do this sort of thing in polite company. 
     */ 
</span>    <a href="../../include/access/htup_details.h.html#LN697"><span class='Ref_to_Macro'>HeapTupleSetOid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN772"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN765"><span class='Ref_to_Parameter'>new_rel_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* finally insert the new tuple, update the indexes, and clean up */ 
</span>    <a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN763"><span class='Ref_to_Parameter'>pg_class_desc</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN772"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN772"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InsertPgClassTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      AddNewRelationTuple 
 * 
 *      this registers the new relation in the catalogs by 
 *      adding a tuple to pg_class. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN842"></a><span class='Declare_Function'>AddNewRelationTuple</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Delimiter'>, 
</span><a name="LN843"></a>                    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>new_rel_desc</span><span class='Delimiter'>, 
</span><a name="LN844"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_rel_oid</span><span class='Delimiter'>, 
</span><a name="LN845"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_type_oid</span><span class='Delimiter'>, 
</span><a name="LN846"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reloftype</span><span class='Delimiter'>, 
</span><a name="LN847"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relowner</span><span class='Delimiter'>, 
</span><a name="LN848"></a>                    <span class='Keyword'>char </span><span class='Declare_Parameter'>relkind</span><span class='Delimiter'>, 
</span><a name="LN849"></a>                    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>relacl</span><span class='Delimiter'>, 
</span><a name="LN850"></a>                    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN852"></a>    <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>new_rel_reltup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * first we update some of the information in our uncataloged relation's 
     * relation descriptor. 
     */ 
</span>    <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN843"><span class='Ref_to_Parameter'>new_rel_desc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN848"><span class='Ref_to_Parameter'>relkind</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* The relation is real, but as yet empty */ 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relpages <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>reltuples <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relallvisible <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN161"><span class='Ref_to_Const'>RELKIND_SEQUENCE</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Sequences always have a known size */ 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relpages <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>reltuples <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relallvisible <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Views, etc, have no disk storage */ 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relpages <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>reltuples <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relallvisible <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch relkind &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Initialize relfrozenxid and relminmxid */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN848"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>        <a href="heap.c.html#LN848"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>        <a href="heap.c.html#LN848"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Initialize to the minimum XID that could put tuples in the table. 
         * We know that no xacts older than RecentXmin are still running, so 
         * that will do. 
         */ 
</span>        <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relfrozenxid <span class='Operator'>= </span><a href="../utils/time/snapmgr.c.html#LN164"><span class='Ref_to_Global_Var'>RecentXmin</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Similarly, initialize the minimum Multixact to the first value that 
         * could possibly be stored in tuples in the table.  Running 
         * transactions could reuse values from their local cache, so we are 
         * careful to consider all currently running multis. 
         * 
         * XXX this could be refined further, but is it worth the hassle? 
         */ 
</span>        <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relminmxid <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN137"><span class='Ref_to_Proto'>GetOldestMultiXactId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if relkind==RELKIND_RELA... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Other relation types will not contain XIDs, so set relfrozenxid to 
         * InvalidTransactionId.  (Note: a sequence does contain a tuple, but 
         * we force its xmin to be FrozenTransactionId always; see 
         * commands/sequence.c.) 
         */ 
</span>        <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relfrozenxid <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relminmxid <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relowner <span class='Operator'>= </span><a href="heap.c.html#LN847"><span class='Ref_to_Parameter'>relowner</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>reltype <span class='Operator'>= </span><a href="heap.c.html#LN845"><span class='Ref_to_Parameter'>new_type_oid</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>reloftype <span class='Operator'>= </span><a href="heap.c.html#LN846"><span class='Ref_to_Parameter'>reloftype</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* relispartition is always set by updating this tuple later */ 
</span>    <a href="heap.c.html#LN852"><span class='Ref_To_Local'>new_rel_reltup</span></a><span class='Operator'>-&GT;</span>relispartition <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN843"><span class='Ref_to_Parameter'>new_rel_desc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN76"><span class='Ref_to_Member'>tdtypeid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN845"><span class='Ref_to_Parameter'>new_type_oid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now build and insert the tuple */ 
</span>    <a href="../../include/catalog/heap.h.html#LN91"><span class='Ref_to_Proto'>InsertPgClassTuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN842"><span class='Ref_to_Parameter'>pg_class_desc</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN843"><span class='Ref_to_Parameter'>new_rel_desc</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN844"><span class='Ref_to_Parameter'>new_rel_oid</span></a><span class='Delimiter'>, 
</span>                       <a href="heap.c.html#LN849"><span class='Ref_to_Parameter'>relacl</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN850"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddNewRelationTuple &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      AddNewRelationType - 
 * 
 *      define a composite type corresponding to the new relation 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN941"></a><span class='Declare_Function'>AddNewRelationType</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>typeName</span><span class='Delimiter'>, 
</span><a name="LN942"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typeNamespace</span><span class='Delimiter'>, 
</span><a name="LN943"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_rel_oid</span><span class='Delimiter'>, 
</span><a name="LN944"></a>                   <span class='Keyword'>char </span><span class='Declare_Parameter'>new_rel_kind</span><span class='Delimiter'>, 
</span><a name="LN945"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>ownerid</span><span class='Delimiter'>, 
</span><a name="LN946"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_row_type</span><span class='Delimiter'>, 
</span><a name="LN947"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>new_array_type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> 
        <a href="../../include/catalog/pg_type_fn.h.html#LN24"><span class='Ref_to_Proto'>TypeCreate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN946"><span class='Ref_to_Parameter'>new_row_type</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* optional predetermined OID */ 
</span>                   <a href="heap.c.html#LN941"><span class='Ref_to_Parameter'>typeName</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* type name */ 
</span>                   <a href="heap.c.html#LN942"><span class='Ref_to_Parameter'>typeNamespace</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* type namespace */ 
</span>                   <a href="heap.c.html#LN943"><span class='Ref_to_Parameter'>new_rel_oid</span></a><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* relation oid */ 
</span>                   <a href="heap.c.html#LN944"><span class='Ref_to_Parameter'>new_rel_kind</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* relation kind */ 
</span>                   <a href="heap.c.html#LN945"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* owner's ID */ 
</span>                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* internal size (varlena) */ 
</span>                   <a href="../../include/catalog/pg_type.h.html#LN720"><span class='Ref_to_Const'>TYPTYPE_COMPOSITE</span></a><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* type-type (composite) */ 
</span>                   <a href="../../include/catalog/pg_type.h.html#LN729"><span class='Ref_to_Const'>TYPCATEGORY_COMPOSITE</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* type-category (ditto) */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* composite types are never preferred */ 
</span>                   <a href="../../include/commands/typecmds.h.html#LN21"><span class='Ref_to_Const'>DEFAULT_TYPDELIM</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* default array delimiter */ 
</span>                   F_RECORD_IN<span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* input procedure */ 
</span>                   F_RECORD_OUT<span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* output procedure */ 
</span>                   F_RECORD_RECV<span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* receive procedure */ 
</span>                   F_RECORD_SEND<span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* send procedure */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* typmodin procedure - none */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* typmodout procedure - none */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* analyze procedure - default */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* array element type - irrelevant */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* this is not an array type */ 
</span>                   <a href="heap.c.html#LN947"><span class='Ref_to_Parameter'>new_array_type</span></a><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* array type if any */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* domain base type - irrelevant */ 
</span>                   <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* default value - none */ 
</span>                   <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* default binary representation */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* passed by reference */ 
</span>                   <span class='String'>'d'</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* alignment - must be the largest! */ 
</span>                   <span class='String'>'x'</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* fully TOASTable */ 
</span>                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* typmod */ 
</span>                   <span class='Number'>0</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* array dimensions for typBaseType */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* Type NOT NULL */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* rowtypes never have a collation */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AddNewRelationType &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      heap_create_with_catalog 
 * 
 *      creates a new cataloged relation.  see comments above. 
 * 
 * Arguments: 
 *  relname: name to give to new rel 
 *  relnamespace: OID of namespace it goes in 
 *  reltablespace: OID of tablespace it goes in 
 *  relid: OID to assign to new rel, or InvalidOid to select a new OID 
 *  reltypeid: OID to assign to rel's rowtype, or InvalidOid to select one 
 *  reloftypeid: if a typed table, OID of underlying type; else InvalidOid 
 *  ownerid: OID of new rel's owner 
 *  tupdesc: tuple descriptor (source of column definitions) 
 *  cooked_constraints: list of precooked check constraints and defaults 
 *  relkind: relkind for new rel 
 *  relpersistence: rel's persistence status (permanent, temp, or unlogged) 
 *  shared_relation: TRUE if it's to be a shared relation 
 *  mapped_relation: TRUE if the relation will use the relfilenode map 
 *  oidislocal: TRUE if oid column (if any) should be marked attislocal 
 *  oidinhcount: attinhcount to assign to oid column (if any) 
 *  oncommit: ON COMMIT marking (only relevant if it's a temp table) 
 *  reloptions: reloptions in Datum form, or (Datum) 0 if none 
 *  use_user_acl: TRUE if should look for user-defined default permissions; 
 *      if FALSE, relacl is always set NULL 
 *  allow_system_table_mods: TRUE to allow creation in system namespaces 
 *  is_internal: is this a system-generated catalog? 
 * 
 * Output parameters: 
 *  typaddress: if not null, gets the object address of the new pg_type entry 
 * 
 * Returns the OID of the new relation 
 * -------------------------------- 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1018"></a><span class='Declare_Function'>heap_create_with_catalog</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Delimiter'>, 
</span><a name="LN1019"></a>                         <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relnamespace</span><span class='Delimiter'>, 
</span><a name="LN1020"></a>                         <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reltablespace</span><span class='Delimiter'>, 
</span><a name="LN1021"></a>                         <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, 
</span><a name="LN1022"></a>                         <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reltypeid</span><span class='Delimiter'>, 
</span><a name="LN1023"></a>                         <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reloftypeid</span><span class='Delimiter'>, 
</span><a name="LN1024"></a>                         <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>ownerid</span><span class='Delimiter'>, 
</span><a name="LN1025"></a>                         <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, 
</span><a name="LN1026"></a>                         <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cooked_constraints</span><span class='Delimiter'>, 
</span><a name="LN1027"></a>                         <span class='Keyword'>char </span><span class='Declare_Parameter'>relkind</span><span class='Delimiter'>, 
</span><a name="LN1028"></a>                         <span class='Keyword'>char </span><span class='Declare_Parameter'>relpersistence</span><span class='Delimiter'>, 
</span><a name="LN1029"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>shared_relation</span><span class='Delimiter'>, 
</span><a name="LN1030"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>mapped_relation</span><span class='Delimiter'>, 
</span><a name="LN1031"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>oidislocal</span><span class='Delimiter'>, 
</span><a name="LN1032"></a>                         <span class='Keyword'>int </span><span class='Declare_Parameter'>oidinhcount</span><span class='Delimiter'>, 
</span><a name="LN1033"></a>                         <a href="../../include/nodes/primnodes.h.html#LN46"><span class='Ref_to_Enum'>OnCommitAction</span></a> <span class='Declare_Parameter'>oncommit</span><span class='Delimiter'>, 
</span><a name="LN1034"></a>                         <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, 
</span><a name="LN1035"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>use_user_acl</span><span class='Delimiter'>, 
</span><a name="LN1036"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_system_table_mods</span><span class='Delimiter'>, 
</span><a name="LN1037"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Delimiter'>, 
</span><a name="LN1038"></a>                         <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typaddress</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1040"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_class_desc</span><span class='Delimiter'>; 
</span><a name="LN1041"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>new_rel_desc</span><span class='Delimiter'>; 
</span><a name="LN1042"></a>    <a href="../../include/utils/acl.h.html#LN98"><span class='Ref_to_Typedef'>Acl</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>relacl</span><span class='Delimiter'>; 
</span><a name="LN1043"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>existing_relid</span><span class='Delimiter'>; 
</span><a name="LN1044"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>old_type_oid</span><span class='Delimiter'>; 
</span><a name="LN1045"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>new_type_oid</span><span class='Delimiter'>; 
</span><a name="LN1046"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>new_type_addr</span><span class='Delimiter'>; 
</span><a name="LN1047"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>new_array_oid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1040"><span class='Ref_To_Local'>pg_class_desc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * sanity checks 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN371"><span class='Ref_to_Macro'>IsNormalProcessingMode</span></a><span class='Parentheses'>() </span><span class='Operator'>|| </span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/heap.h.html#LN128"><span class='Ref_to_Proto'>CheckAttributeNamesTypes</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1025"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1036"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This would fail later on anyway, if the relation already exists.  But 
     * by catching it here we can emit a nicer error message. 
     */ 
</span>    <a href="heap.c.html#LN1043"><span class='Ref_To_Local'>existing_relid</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN123"><span class='Ref_to_Proto'>get_relname_relid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1043"><span class='Ref_To_Local'>existing_relid</span></a> <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_TABLE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"relation \"%s\" already exists"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we are going to create a rowtype as well, also check for 
     * collision with an existing type name.  If there is one and it's an 
     * autogenerated array, we can rename it out of the way; otherwise we can 
     * at least give a good error message. 
     */ 
</span>    <a href="heap.c.html#LN1044"><span class='Ref_To_Local'>old_type_oid</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN184"><span class='Ref_to_Macro'>GetSysCacheOid2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN106"><span class='Ref_to_EnumConst'>TYPENAMENSP</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1044"><span class='Ref_To_Local'>old_type_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/catalog/pg_type_fn.h.html#LN80"><span class='Ref_to_Proto'>moveArrayTypeName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1044"><span class='Ref_To_Local'>old_type_oid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"type \"%s\" already exists"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"A relation has an associated type of the same name, "</span> 
                       <span class='String'>"so you must use a name that doesn't conflict "</span> 
                       <span class='String'>"with any existing type."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Shared relations must be in pg_global (last-ditch check) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1029"><span class='Ref_to_Parameter'>shared_relation</span></a> <span class='Operator'>&& </span><a href="heap.c.html#LN1020"><span class='Ref_to_Parameter'>reltablespace</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"shared relations must be placed in pg_global tablespace"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate an OID for the relation, unless we were told what to use. 
     * 
     * The OID will be the relfilenode as well, so make sure it doesn't 
     * collide with either pg_class OIDs or existing physical files. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Use binary-upgrade override for pg_class.oid/relfilenode? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| </span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN161"><span class='Ref_to_Const'>RELKIND_SEQUENCE</span></a> <span class='Operator'>|| 
</span>             <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>|| </span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>             <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a> <span class='Operator'>|| </span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a> <span class='Operator'>|| 
</span>             <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN85"><span class='Ref_to_Global_Var'>binary_upgrade_next_heap_pg_class_oid</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_class heap OID value not set when in binary upgrade mode"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN85"><span class='Ref_to_Global_Var'>binary_upgrade_next_heap_pg_class_oid</span></a><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN85"><span class='Ref_to_Global_Var'>binary_upgrade_next_heap_pg_class_oid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* There might be no TOAST table, so we have to test for it. */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>&& 
</span>                 <a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN86"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_class_oid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                 <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN86"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_class_oid</span></a><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN86"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_class_oid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/catalog.h.html#LN47"><span class='Ref_to_Proto'>GetNewRelFileNode</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1020"><span class='Ref_to_Parameter'>reltablespace</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1040"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Delimiter'>, 
</span>                                      <a href="heap.c.html#LN1028"><span class='Ref_to_Parameter'>relpersistence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !OidIsValid(relid) &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Determine the relation's initial permissions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1035"><span class='Ref_to_Parameter'>use_user_acl</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Operator'>: 
</span>                <a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN212"><span class='Ref_to_Proto'>get_user_default_acl</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1814"><span class='Ref_to_EnumConst'>ACL_OBJECT_RELATION</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>, 
</span>                                              <a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN161"><span class='Ref_to_Const'>RELKIND_SEQUENCE</span></a><span class='Operator'>: 
</span>                <a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN212"><span class='Ref_to_Proto'>get_user_default_acl</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1815"><span class='Ref_to_EnumConst'>ACL_OBJECT_SEQUENCE</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>, 
</span>                                              <a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if use_user_acl &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the relcache entry (mostly dummy at this point) and the physical 
     * disk file.  (If we fail further down, it's the smgr's responsibility to 
     * remove the disk file again.) 
     */ 
</span>    <a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN41"><span class='Ref_to_Proto'>heap_create</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1020"><span class='Ref_to_Parameter'>reltablespace</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1025"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1028"><span class='Ref_to_Parameter'>relpersistence</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1029"><span class='Ref_to_Parameter'>shared_relation</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1030"><span class='Ref_to_Parameter'>mapped_relation</span></a><span class='Delimiter'>, 
</span>                               <a href="heap.c.html#LN1036"><span class='Ref_to_Parameter'>allow_system_table_mods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>== </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decide whether to create an array type over the relation's rowtype. We 
     * do not create any array types for system catalogs (ie, those made 
     * during initdb). We do not create them where the use of a relation as 
     * such is an implementation detail: toast tables, sequences and indexes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>                              <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>|| 
</span>                              <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>                              <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a> <span class='Operator'>|| 
</span>                              <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a> <span class='Operator'>|| 
</span>                              <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>))</span> 
        <a href="heap.c.html#LN1047"><span class='Ref_To_Local'>new_array_oid</span></a> <span class='Operator'>= </span><a href="../../include/commands/typecmds.h.html#LN30"><span class='Ref_to_Proto'>AssignTypeArrayOid</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since defining a relation also defines a complex type, we add a new 
     * system type corresponding to the new relation.  The OID of the type can 
     * be preselected by the caller, but if reltypeid is InvalidOid, we'll 
     * generate a new OID for it. 
     * 
     * NOTE: we could get a unique-index failure here, in case someone else is 
     * creating the same type name in parallel but hadn't committed yet when 
     * we checked for a duplicate name above. 
     */ 
</span>    <a href="heap.c.html#LN1046"><span class='Ref_To_Local'>new_type_addr</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN97"><span class='Ref_to_Proto'>AddNewRelationType</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN1022"><span class='Ref_to_Parameter'>reltypeid</span></a><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN1047"><span class='Ref_To_Local'>new_array_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1045"><span class='Ref_To_Local'>new_type_oid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1046"><span class='Ref_To_Local'>new_type_addr</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1038"><span class='Ref_to_Parameter'>typaddress</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="heap.c.html#LN1038"><span class='Ref_to_Parameter'>typaddress</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1046"><span class='Ref_To_Local'>new_type_addr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now make the array type if wanted. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1047"><span class='Ref_To_Local'>new_array_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1216"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relarrayname</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN1216"><span class='Ref_To_Local'>relarrayname</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_type_fn.h.html#LN78"><span class='Ref_to_Proto'>makeArrayTypeName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1018"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/pg_type_fn.h.html#LN24"><span class='Ref_to_Proto'>TypeCreate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1047"><span class='Ref_To_Local'>new_array_oid</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* force the type's OID to this */ 
</span>                   <a href="heap.c.html#LN1216"><span class='Ref_To_Local'>relarrayname</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Array type name */ 
</span>                   <a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Same namespace as parent */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* Not composite, no relationOid */ 
</span>                   <span class='Number'>0</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* relkind, also N/A here */ 
</span>                   <a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* owner's ID */ 
</span>                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* Internal size (varlena) */ 
</span>                   <a href="../../include/catalog/pg_type.h.html#LN719"><span class='Ref_to_Const'>TYPTYPE_BASE</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Not composite - typelem is */ 
</span>                   <a href="../../include/catalog/pg_type.h.html#LN727"><span class='Ref_to_Const'>TYPCATEGORY_ARRAY</span></a><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* type-category (array) */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* array types are never preferred */ 
</span>                   <a href="../../include/commands/typecmds.h.html#LN21"><span class='Ref_to_Const'>DEFAULT_TYPDELIM</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* default array delimiter */ 
</span>                   F_ARRAY_IN<span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* array input proc */ 
</span>                   F_ARRAY_OUT<span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* array output proc */ 
</span>                   F_ARRAY_RECV<span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* array recv (bin) proc */ 
</span>                   F_ARRAY_SEND<span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* array send (bin) proc */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* typmodin procedure - none */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* typmodout procedure - none */ 
</span>                   F_ARRAY_TYPANALYZE<span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* array analyze procedure */ 
</span>                   <a href="heap.c.html#LN1045"><span class='Ref_To_Local'>new_type_oid</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* array element type - the rowtype */ 
</span>                   <span class='Boolean'>true</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* yes, this is an array type */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* this has no array type */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* domain base type - irrelevant */ 
</span>                   <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* default value - none */ 
</span>                   <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* default binary representation */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* passed by reference */ 
</span>                   <span class='String'>'d'</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* alignment - must be the largest! */ 
</span>                   <span class='String'>'x'</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* fully TOASTable */ 
</span>                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* typmod */ 
</span>                   <span class='Number'>0</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* array dimensions for typBaseType */ 
</span>                   <span class='Boolean'>false</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* Type NOT NULL */ 
</span>                   <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* rowtypes never have a collation */ 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1216"><span class='Ref_To_Local'>relarrayname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if OidIsValid(new_array_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * now create an entry in pg_class for the relation. 
     * 
     * NOTE: we could get a unique-index failure here, in case someone else is 
     * creating the same relation name in parallel but hadn't committed yet 
     * when we checked for a duplicate name above. 
     */ 
</span>    <a href="heap.c.html#LN88"><span class='Ref_to_Proto'>AddNewRelationTuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1040"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1045"><span class='Ref_To_Local'>new_type_oid</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1023"><span class='Ref_to_Parameter'>reloftypeid</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1034"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * now add tuples to pg_attribute for the attributes in our new relation. 
     */ 
</span>    <a href="heap.c.html#LN652"><span class='Ref_to_Func'>AddNewAttributeTuples</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a><span class='Delimiter'>, 
</span>                          <a href="heap.c.html#LN1031"><span class='Ref_to_Parameter'>oidislocal</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1032"><span class='Ref_to_Parameter'>oidinhcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a dependency link to force the relation to be deleted if its 
     * namespace is.  Also make a dependency link to its owner, as well as 
     * dependencies for any roles mentioned in the default ACL. 
     * 
     * For composite types, these dependencies are tracked for the pg_type 
     * entry, so we needn't record them here.  Likewise, TOAST tables don't 
     * need a namespace dependency (they live in a pinned namespace) nor an 
     * owner dependency (they depend indirectly through the parent table), nor 
     * should they have any ACL entries.  The same applies for extension 
     * dependencies. 
     * 
     * Also, skip this in bootstrap mode, since we don't make dependencies 
     * while bootstrapping. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a> <span class='Operator'>&& 
</span>        <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1297"></a>        <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>, 
</span><a name="LN1298"></a>                    <span class='Declare_Local'>referenced</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN1297"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1297"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1297"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_namespace.h.html#LN33"><span class='Ref_to_Const'>NamespaceRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1019"><span class='Ref_to_Parameter'>relnamespace</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1297"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN157"><span class='Ref_to_Func'>recordDependencyOnOwner</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_depend.c.html#LN137"><span class='Ref_to_Func'>recordDependencyOnCurrentExtension</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1297"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1023"><span class='Ref_to_Parameter'>reloftypeid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_type.h.html#LN33"><span class='Ref_to_Const'>TypeRelationId</span></a><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1023"><span class='Ref_to_Parameter'>reloftypeid</span></a><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1297"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1298"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1322"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nnewmembers</span><span class='Delimiter'>; 
</span><a name="LN1323"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>newmembers</span><span class='Delimiter'>; 
</span> 
            <a href="heap.c.html#LN1322"><span class='Ref_To_Local'>nnewmembers</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN227"><span class='Ref_to_Proto'>aclmembers</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1042"><span class='Ref_To_Local'>relacl</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1323"><span class='Ref_To_Local'>newmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/catalog/dependency.h.html#LN262"><span class='Ref_to_Proto'>updateAclDependencies</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  <a href="heap.c.html#LN1024"><span class='Ref_to_Parameter'>ownerid</span></a><span class='Delimiter'>, 
</span>                                  <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                  <a href="heap.c.html#LN1322"><span class='Ref_To_Local'>nnewmembers</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1323"><span class='Ref_To_Local'>newmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if relkind!=RELKIND_COMP... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Post creation hook for new relation */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN146"><span class='Ref_to_Macro'>InvokeObjectPostCreateHookArg</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1037"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store any supplied constraints and defaults. 
     * 
     * NB: this may do a CommandCounterIncrement and rebuild the relcache 
     * entry, so the relation must be valid and self-consistent at this point. 
     * In particular, there are not yet constraints and defaults anywhere. 
     */ 
</span>    <a href="heap.c.html#LN108"><span class='Ref_to_Proto'>StoreConstraints</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1026"><span class='Ref_to_Parameter'>cooked_constraints</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1037"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's a special on-commit action, remember it 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1033"><span class='Ref_to_Parameter'>oncommit</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/primnodes.h.html#LN48"><span class='Ref_to_EnumConst'>ONCOMMIT_NOOP</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/commands/tablecmds.h.html#LN75"><span class='Ref_to_Proto'>register_on_commit_action</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1033"><span class='Ref_to_Parameter'>oncommit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unlogged objects need an init fork, except for partitioned tables which 
     * have no storage at all. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1028"><span class='Ref_to_Parameter'>relpersistence</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN170"><span class='Ref_to_Const'>RELPERSISTENCE_UNLOGGED</span></a> <span class='Operator'>&& 
</span>        <a href="heap.c.html#LN1027"><span class='Ref_to_Parameter'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/catalog/heap.h.html#LN75"><span class='Ref_to_Proto'>heap_create_init_fork</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ok, the relation has been cataloged, so close our relations and return 
     * the OID of the newly created relation. 
     */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1041"><span class='Ref_To_Local'>new_rel_desc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* do not unlock till end of xact */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1040"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN1021"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_create_with_catalog &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Set up an init fork for an unlogged table so that it can be correctly 
 * reinitialized on restart.  An immediate sync is required even if the 
 * page has been logged, because the write did not go through 
 * shared_buffers and therefore a concurrent checkpoint may have moved 
 * the redo pointer past our xlog record.  Recovery may as well remove it 
 * while replaying, for example, XLOG_DBASE_CREATE or XLOG_TBLSPC_CREATE 
 * record. Therefore, logging is necessary even if wal_level=minimal. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1379"></a><span class='Declare_Function'>heap_create_init_fork</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>           <a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>           <a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/rel.h.html#LN460"><span class='Ref_to_Macro'>RelationOpenSmgr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/smgr.h.html#LN90"><span class='Ref_to_Proto'>smgrcreate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/catalog/storage_xlog.h.html#LN52"><span class='Ref_to_Proto'>log_smgrcreate</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/smgr.h.html#LN107"><span class='Ref_to_Proto'>smgrimmedsync</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1379"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN86"><span class='Ref_to_Member'>rd_smgr</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      RelationRemoveInheritance 
 * 
 * Formerly, this routine checked for child relations and aborted the 
 * deletion if any were found.  Now we rely on the dependency mechanism 
 * to check for or delete child relations.  By the time we get here, 
 * there are no children and we need only remove any pg_inherits rows 
 * linking this relation to its parent(s). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1400"></a><span class='Declare_Function'>RelationRemoveInheritance</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1402"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>catalogRelation</span><span class='Delimiter'>; 
</span><a name="LN1403"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1404"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN1405"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1402"><span class='Ref_To_Local'>catalogRelation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_inherits.h.html#LN28"><span class='Ref_to_Const'>InheritsRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1404"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/catalog/pg_inherits.h.html#LN49"><span class='Ref_to_Const'>Anum_pg_inherits_inhrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1400"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1403"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1402"><span class='Ref_To_Local'>catalogRelation</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN166"><span class='Ref_to_Const'>InheritsRelidSeqnoIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1404"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1405"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1403"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1402"><span class='Ref_To_Local'>catalogRelation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1405"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1403"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1402"><span class='Ref_To_Local'>catalogRelation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RelationRemoveInheritance &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      DeleteRelationTuple 
 * 
 * Remove pg_class row for the given relid. 
 * 
 * Note: this is shared by relation deletion and index deletion.  It's 
 * not intended for use anyplace else. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1433"></a><span class='Declare_Function'>DeleteRelationTuple</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1435"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_class_desc</span><span class='Delimiter'>; 
</span><a name="LN1436"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Grab an appropriate lock on the pg_class relation */ 
</span>    <a href="heap.c.html#LN1435"><span class='Ref_To_Local'>pg_class_desc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1436"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1433"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1436"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1433"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* delete the relation tuple from pg_class, and finish up */ 
</span>    <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1435"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1436"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1436"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1435"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DeleteRelationTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      DeleteAttributeTuples 
 * 
 * Remove pg_attribute rows for the given relid. 
 * 
 * Note: this is shared by relation deletion and index deletion.  It's 
 * not intended for use anyplace else. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1462"></a><span class='Declare_Function'>DeleteAttributeTuples</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1464"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attrel</span><span class='Delimiter'>; 
</span><a name="LN1465"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1466"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1467"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>atttup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Grab an appropriate lock on the pg_attribute relation */ 
</span>    <a href="heap.c.html#LN1464"><span class='Ref_To_Local'>attrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Use the index to scan only attributes of the target relation */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1466"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_attribute.h.html#LN194"><span class='Ref_to_Const'>Anum_pg_attribute_attrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1462"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1465"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1464"><span class='Ref_To_Local'>attrel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN93"><span class='Ref_to_Const'>AttributeRelidNumIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1466"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Delete all the matching tuples */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="heap.c.html#LN1467"><span class='Ref_To_Local'>atttup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1465"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1464"><span class='Ref_To_Local'>attrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1467"><span class='Ref_To_Local'>atttup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up after the scan */ 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1465"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1464"><span class='Ref_To_Local'>attrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DeleteAttributeTuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      DeleteSystemAttributeTuples 
 * 
 * Remove pg_attribute rows for system columns of the given relid. 
 * 
 * Note: this is only used when converting a table to a view.  Views don't 
 * have system columns, so we should remove them from pg_attribute. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1499"></a><span class='Declare_Function'>DeleteSystemAttributeTuples</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1501"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attrel</span><span class='Delimiter'>; 
</span><a name="LN1502"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1503"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1504"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>atttup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Grab an appropriate lock on the pg_attribute relation */ 
</span>    <a href="heap.c.html#LN1501"><span class='Ref_To_Local'>attrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Use the index to scan only system attributes of the target relation */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1503"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_attribute.h.html#LN194"><span class='Ref_to_Const'>Anum_pg_attribute_attrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1499"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1503"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_attribute.h.html#LN199"><span class='Ref_to_Const'>Anum_pg_attribute_attnum</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN29"><span class='Ref_to_Const'>BTLessEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT2LE<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1502"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1501"><span class='Ref_To_Local'>attrel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN93"><span class='Ref_to_Const'>AttributeRelidNumIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1503"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Delete all the matching tuples */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="heap.c.html#LN1504"><span class='Ref_To_Local'>atttup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1502"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1501"><span class='Ref_To_Local'>attrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1504"><span class='Ref_To_Local'>atttup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up after the scan */ 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1502"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1501"><span class='Ref_To_Local'>attrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DeleteSystemAttributeTuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      RemoveAttributeById 
 * 
 * This is the guts of ALTER TABLE DROP COLUMN: actually mark the attribute 
 * deleted in pg_attribute.  We also remove pg_statistic entries for it. 
 * (Everything else needed, such as getting rid of any pg_attrdef entry, 
 * is handled by dependency.c.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1540"></a><span class='Declare_Function'>RemoveAttributeById</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1542"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1543"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attr_rel</span><span class='Delimiter'>; 
</span><a name="LN1544"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1545"></a>    <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attStruct</span><span class='Delimiter'>; 
</span><a name="LN1546"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>newattname</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Grab an exclusive lock on the target table, which we will NOT release 
     * until end of transaction.  (In the simple case where we are directly 
     * dropping this column, AlterTableDropColumn already did this ... but 
     * when cascading from a drop of some other object, we may not have any 
     * lock.) 
     */ 
</span>    <a href="heap.c.html#LN1542"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1543"><span class='Ref_To_Local'>attr_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1544"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN166"><span class='Ref_to_Macro'>SearchSysCacheCopy2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN40"><span class='Ref_to_EnumConst'>ATTNUM</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1544"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span>       <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for attribute %d of relation %u"</span><span class='Delimiter'>, 
</span>             <a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1545"><span class='Ref_To_Local'>attStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1544"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>attnum</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* System attribute (probably OID) ... just delete the row */ 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1543"><span class='Ref_To_Local'>attr_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1544"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Dropping user attributes is lots harder */ 
</span> 
        <span class='Comment_Multi_Line'>/* Mark the attribute as dropped */ 
</span>        <a href="heap.c.html#LN1545"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>attisdropped <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Set the type OID to invalid.  A dropped attribute's type link 
         * cannot be relied on (once the attribute is dropped, the type might 
         * be too). Fortunately we do not need the type row --- the only 
         * really essential information is the type's typlen and typalign, 
         * which are preserved in the attribute's attlen and attalign.  We set 
         * atttypid to zero here as a means of catching code that incorrectly 
         * expects it to be valid. 
         */ 
</span>        <a href="heap.c.html#LN1545"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remove any NOT NULL constraint the column may have */ 
</span>        <a href="heap.c.html#LN1545"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>attnotnull <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We don't want to keep stats for it anymore */ 
</span>        <a href="heap.c.html#LN1545"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>attstattarget <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Change the column name to something that isn't likely to conflict 
         */ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1546"><span class='Ref_To_Local'>newattname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN1546"><span class='Ref_To_Local'>newattname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <span class='String'>"........pg.dropped.%d........"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/builtins.h.html#LN40"><span class='Ref_to_Proto'>namestrcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="heap.c.html#LN1545"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1546"><span class='Ref_To_Local'>newattname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1543"><span class='Ref_To_Local'>attr_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1544"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1544"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Because updating the pg_attribute row will trigger a relcache flush for 
     * the target relation, we need not do anything else to notify other 
     * backends of the change. 
     */ 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1543"><span class='Ref_To_Local'>attr_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>attnum</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/catalog/heap.h.html#LN120"><span class='Ref_to_Proto'>RemoveStatistics</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1540"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1542"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveAttributeById &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      RemoveAttrDefault 
 * 
 * If the specified relation/attribute has a default, remove it. 
 * (If no default, raise error if complain is true, else return quietly.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1628"></a><span class='Declare_Function'>RemoveAttrDefault</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, 
</span><a name="LN1629"></a>                  <a href="../../include/nodes/parsenodes.h.html#LN1652"><span class='Ref_to_Enum'>DropBehavior</span></a> <span class='Declare_Parameter'>behavior</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>complain</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>internal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1631"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attrdef_rel</span><span class='Delimiter'>; 
</span><a name="LN1632"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scankeys</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1633"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1634"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1635"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1631"><span class='Ref_To_Local'>attrdef_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attrdef.h.html#LN28"><span class='Ref_to_Const'>AttrDefaultRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1632"><span class='Ref_To_Local'>scankeys</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_attrdef.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_attrdef_adrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1628"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1632"><span class='Ref_To_Local'>scankeys</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_attrdef.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_attrdef_adnum</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT2EQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1628"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1633"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1631"><span class='Ref_To_Local'>attrdef_rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN86"><span class='Ref_to_Const'>AttrDefaultIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1632"><span class='Ref_To_Local'>scankeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* There should be at most one matching tuple, but we loop anyway */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1634"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1633"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1654"></a>        <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>object</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN1654"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_attrdef.h.html#LN28"><span class='Ref_to_Const'>AttrDefaultRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1654"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1634"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN1654"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/dependency.h.html#LN182"><span class='Ref_to_Proto'>performDeletion</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1654"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1629"><span class='Ref_to_Parameter'>behavior</span></a><span class='Delimiter'>, 
</span>                        <a href="heap.c.html#LN1629"><span class='Ref_to_Parameter'>internal</span></a> <span class='Operator'>? </span><a href="../../include/catalog/dependency.h.html#LN173"><span class='Ref_to_Const'>PERFORM_DELETION_INTERNAL</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN1635"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1633"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1631"><span class='Ref_To_Local'>attrdef_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1629"><span class='Ref_to_Parameter'>complain</span></a> <span class='Operator'>&& !</span><a href="heap.c.html#LN1635"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find attrdef tuple for relation %u attnum %d"</span><span class='Delimiter'>, 
</span>             <a href="heap.c.html#LN1628"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1628"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveAttrDefault &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      RemoveAttrDefaultById 
 * 
 * Remove a pg_attrdef entry specified by OID.  This is the guts of 
 * attribute-default removal.  Note it should be called via performDeletion, 
 * not directly. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1682"></a><span class='Declare_Function'>RemoveAttrDefaultById</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>attrdefId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1684"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attrdef_rel</span><span class='Delimiter'>; 
</span><a name="LN1685"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attr_rel</span><span class='Delimiter'>; 
</span><a name="LN1686"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>myrel</span><span class='Delimiter'>; 
</span><a name="LN1687"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scankeys</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1688"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1689"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1690"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>myrelid</span><span class='Delimiter'>; 
</span><a name="LN1691"></a>    <a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a>  <span class='Declare_Local'>myattnum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Grab an appropriate lock on the pg_attrdef relation */ 
</span>    <a href="heap.c.html#LN1684"><span class='Ref_To_Local'>attrdef_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attrdef.h.html#LN28"><span class='Ref_to_Const'>AttrDefaultRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find the pg_attrdef tuple */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1687"><span class='Ref_To_Local'>scankeys</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1682"><span class='Ref_to_Parameter'>attrdefId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1688"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1684"><span class='Ref_To_Local'>attrdef_rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN88"><span class='Ref_to_Const'>AttrDefaultOidIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1687"><span class='Ref_To_Local'>scankeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1688"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find tuple for attrdef %u"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1682"><span class='Ref_to_Parameter'>attrdefId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1690"><span class='Ref_To_Local'>myrelid</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_attrdef.h.html#LN46"><span class='Ref_to_Typedef'>Form_pg_attrdef</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>adrelid<span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1691"><span class='Ref_To_Local'>myattnum</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_attrdef.h.html#LN46"><span class='Ref_to_Typedef'>Form_pg_attrdef</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>adnum<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get an exclusive lock on the relation owning the attribute */ 
</span>    <a href="heap.c.html#LN1686"><span class='Ref_To_Local'>myrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1690"><span class='Ref_To_Local'>myrelid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can delete the pg_attrdef row */ 
</span>    <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1684"><span class='Ref_To_Local'>attrdef_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1688"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1684"><span class='Ref_To_Local'>attrdef_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fix the pg_attribute row */ 
</span>    <a href="heap.c.html#LN1685"><span class='Ref_To_Local'>attr_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN166"><span class='Ref_to_Macro'>SearchSysCacheCopy2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN40"><span class='Ref_to_EnumConst'>ATTNUM</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1690"><span class='Ref_To_Local'>myrelid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1691"><span class='Ref_To_Local'>myattnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span>       <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for attribute %d of relation %u"</span><span class='Delimiter'>, 
</span>             <a href="heap.c.html#LN1691"><span class='Ref_To_Local'>myattnum</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1690"><span class='Ref_To_Local'>myrelid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>((</span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>atthasdef <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1685"><span class='Ref_To_Local'>attr_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1689"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Our update of the pg_attribute row will force a relcache rebuild, so 
     * there's nothing else to do here. 
     */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1685"><span class='Ref_To_Local'>attr_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Keep lock on attribute's rel until end of xact */ 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1686"><span class='Ref_To_Local'>myrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveAttrDefaultById &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_drop_with_catalog   - removes specified relation from catalogs 
 * 
 * Note that this routine is not responsible for dropping objects that are 
 * linked to the pg_class entry via dependencies (for example, indexes and 
 * constraints).  Those are deleted by the dependency-tracing logic in 
 * dependency.c before control gets here.  In general, therefore, this routine 
 * should never be called directly; go through performDeletion() instead. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1755"></a><span class='Declare_Function'>heap_drop_with_catalog</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1757"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1758"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1759"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>parentOid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To drop a partition safely, we must grab exclusive lock on its parent, 
     * because another backend might be about to execute a query on the parent 
     * table.  If it relies on previously cached partition descriptor, then it 
     * could attempt to access the just-dropped relation as its partition. We 
     * must therefore take a table lock strong enough to prevent all queries 
     * on the table from proceeding until we commit and send out a 
     * shared-cache-inval notice that will make them update their index lists. 
     */ 
</span>    <a href="heap.c.html#LN1758"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1758"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>relispartition<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="heap.c.html#LN1759"><span class='Ref_To_Local'>parentOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/partition.h.html#LN78"><span class='Ref_to_Proto'>get_partition_parent</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1759"><span class='Ref_To_Local'>parentOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1758"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open and lock the relation. 
     */ 
</span>    <a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There can no longer be anyone *else* touching the relation, but we 
     * might still have open queries or cursors, or pending trigger events, in 
     * our own session. 
     */ 
</span>    <a href="../../include/commands/tablecmds.h.html#LN52"><span class='Ref_to_Proto'>CheckTableNotInUse</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='String'>"DROP TABLE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This effectively deletes all rows in the table, and may be done in a 
     * serializable transaction.  In that case we must record a rw-conflict in 
     * to this transaction from each transaction holding a predicate lock on 
     * the table. 
     */ 
</span>    <a href="../../include/storage/predicate.h.html#LN62"><span class='Ref_to_Proto'>CheckTableForSerializableConflictIn</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete pg_foreign_table tuple first. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1804"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1804"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1805"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN1804"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_foreign_table.h.html#LN26"><span class='Ref_to_Const'>ForeignTableRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN1805"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN64"><span class='Ref_to_EnumConst'>FOREIGNTABLEREL</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1805"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for foreign table %u"</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1804"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1805"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1805"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1804"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a partitioned table, delete the pg_partitioned_table tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/catalog/heap.h.html#LN144"><span class='Ref_to_Proto'>RemovePartitionKeyByRelId</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Schedule unlinking of the relation's physical files at commit. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>        <a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN165"><span class='Ref_to_Const'>RELKIND_COMPOSITE_TYPE</span></a> <span class='Operator'>&& 
</span>        <a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a> <span class='Operator'>&& 
</span>        <a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/catalog/storage.h.html#LN21"><span class='Ref_to_Proto'>RelationDropStorage</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close relcache entry, but *keep* AccessExclusiveLock on the relation 
     * until transaction commit.  This ensures no one else will try to do 
     * something with the doomed relation. 
     */ 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1757"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove any associated relation synchronization states. 
     */ 
</span>    <a href="../../include/catalog/pg_subscription_rel.h.html#LN76"><span class='Ref_to_Proto'>RemoveSubscriptionRel</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Forget any ON COMMIT action for the rel 
     */ 
</span>    <a href="../../include/commands/tablecmds.h.html#LN76"><span class='Ref_to_Proto'>remove_on_commit_action</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flush the relation from the relcache.  We want to do this before 
     * starting to remove catalog entries, just to be certain that no relcache 
     * entry rebuild will happen partway through.  (That should not really 
     * matter, since we don't do CommandCounterIncrement here, but let's be 
     * safe.) 
     */ 
</span>    <a href="../../include/utils/relcache.h.html#LN111"><span class='Ref_to_Proto'>RelationForgetRelation</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * remove inheritance information 
     */ 
</span>    <a href="heap.c.html#LN104"><span class='Ref_to_Proto'>RelationRemoveInheritance</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * delete statistics 
     */ 
</span>    <a href="../../include/catalog/heap.h.html#LN120"><span class='Ref_to_Proto'>RemoveStatistics</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * delete attribute tuples 
     */ 
</span>    <a href="../../include/catalog/heap.h.html#LN114"><span class='Ref_to_Proto'>DeleteAttributeTuples</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * delete relation tuple 
     */ 
</span>    <a href="../../include/catalog/heap.h.html#LN113"><span class='Ref_to_Proto'>DeleteRelationTuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1755"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1759"><span class='Ref_To_Local'>parentOid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Invalidate the parent's relcache so that the partition is no longer 
         * included in its partition descriptor. 
         */ 
</span>        <a href="../../include/utils/inval.h.html#LN49"><span class='Ref_to_Proto'>CacheInvalidateRelcacheByRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1759"><span class='Ref_To_Local'>parentOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* keep the lock */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_drop_with_catalog &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Store a default expression for column attnum of relation rel. 
 * 
 * Returns the OID of the new pg_attrdef tuple. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1900"></a><span class='Declare_Function'>StoreAttrDefault</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Delimiter'>, 
</span><a name="LN1901"></a>                 <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>expr</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1903"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>adbin</span><span class='Delimiter'>; 
</span><a name="LN1904"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>adsrc</span><span class='Delimiter'>; 
</span><a name="LN1905"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>adrel</span><span class='Delimiter'>; 
</span><a name="LN1906"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1907"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span><a name="LN1908"></a>    <span class='Keyword'>static bool </span><span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>}; 
</span><a name="LN1909"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>attrrel</span><span class='Delimiter'>; 
</span><a name="LN1910"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>atttup</span><span class='Delimiter'>; 
</span><a name="LN1911"></a>    <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attStruct</span><span class='Delimiter'>; 
</span><a name="LN1912"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>attrdefOid</span><span class='Delimiter'>; 
</span><a name="LN1913"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>colobject</span><span class='Delimiter'>, 
</span><a name="LN1914"></a>                <span class='Declare_Local'>defobject</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flatten expression to string form for storage. 
     */ 
</span>    <a href="heap.c.html#LN1903"><span class='Ref_To_Local'>adbin</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1901"><span class='Ref_to_Parameter'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also deparse it to form the mostly-obsolete adsrc field. 
     */ 
</span>    <a href="heap.c.html#LN1904"><span class='Ref_To_Local'>adsrc</span></a> <span class='Operator'>= </span><a href="../../include/utils/ruleutils.h.html#LN26"><span class='Ref_to_Proto'>deparse_expression</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1901"><span class='Ref_to_Parameter'>expr</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/utils/ruleutils.h.html#LN28"><span class='Ref_to_Proto'>deparse_context_for</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                               <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make the pg_attrdef entry. 
     */ 
</span>    <a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attrdef.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_attrdef_adrelid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attrdef.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_attrdef_adnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attrdef.h.html#LN55"><span class='Ref_to_Const'>Anum_pg_attrdef_adbin</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1903"><span class='Ref_To_Local'>adbin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attrdef.h.html#LN56"><span class='Ref_to_Const'>Anum_pg_attrdef_adsrc</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1904"><span class='Ref_To_Local'>adsrc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1905"><span class='Ref_To_Local'>adrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attrdef.h.html#LN28"><span class='Ref_to_Const'>AttrDefaultRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1906"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1905"><span class='Ref_To_Local'>adrel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1908"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1912"><span class='Ref_To_Local'>attrdefOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1905"><span class='Ref_To_Local'>adrel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1906"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN1914"><span class='Ref_To_Local'>defobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_attrdef.h.html#LN28"><span class='Ref_to_Const'>AttrDefaultRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1914"><span class='Ref_To_Local'>defobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1912"><span class='Ref_To_Local'>attrdefOid</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1914"><span class='Ref_To_Local'>defobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1905"><span class='Ref_To_Local'>adrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now can free some of the stuff allocated above */ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attrdef.h.html#LN55"><span class='Ref_to_Const'>Anum_pg_attrdef_adbin</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1907"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_attrdef.h.html#LN56"><span class='Ref_to_Const'>Anum_pg_attrdef_adsrc</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1906"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1903"><span class='Ref_To_Local'>adbin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1904"><span class='Ref_To_Local'>adsrc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update the pg_attribute entry for the column to show that a default 
     * exists. 
     */ 
</span>    <a href="heap.c.html#LN1909"><span class='Ref_To_Local'>attrrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1910"><span class='Ref_To_Local'>atttup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN166"><span class='Ref_to_Macro'>SearchSysCacheCopy2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN40"><span class='Ref_to_EnumConst'>ATTNUM</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1910"><span class='Ref_To_Local'>atttup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for attribute %d of relation %u"</span><span class='Delimiter'>, 
</span>             <a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1911"><span class='Ref_To_Local'>attStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1910"><span class='Ref_To_Local'>atttup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heap.c.html#LN1911"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>atthasdef<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heap.c.html#LN1911"><span class='Ref_To_Local'>attStruct</span></a><span class='Operator'>-&GT;</span>atthasdef <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1909"><span class='Ref_To_Local'>attrrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1910"><span class='Ref_To_Local'>atttup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1910"><span class='Ref_To_Local'>atttup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1909"><span class='Ref_To_Local'>attrrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1910"><span class='Ref_To_Local'>atttup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a dependency so that the pg_attrdef entry goes away if the column 
     * (or whole table) is deleted. 
     */ 
</span>    <a href="heap.c.html#LN1913"><span class='Ref_To_Local'>colobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1913"><span class='Ref_To_Local'>colobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN1913"><span class='Ref_To_Local'>colobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>; 
</span> 
    <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1914"><span class='Ref_To_Local'>defobject</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN1913"><span class='Ref_To_Local'>colobject</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN75"><span class='Ref_to_EnumConst'>DEPENDENCY_AUTO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Record dependencies on objects used in the expression, too. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN1914"><span class='Ref_To_Local'>defobject</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1901"><span class='Ref_to_Parameter'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Post creation hook for attribute defaults. 
     * 
     * XXX. ALTER TABLE ALTER COLUMN SET/DROP DEFAULT is implemented with a 
     * couple of deletion/creation of the attribute's default entry, so the 
     * callee should check existence of an older version of this entry if it 
     * needs to distinguish. 
     */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN146"><span class='Ref_to_Macro'>InvokeObjectPostCreateHookArg</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attrdef.h.html#LN28"><span class='Ref_to_Const'>AttrDefaultRelationId</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN1900"><span class='Ref_to_Parameter'>attnum</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN1901"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN1912"><span class='Ref_To_Local'>attrdefOid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StoreAttrDefault &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Store a check-constraint expression for the given relation. 
 * 
 * Caller is responsible for updating the count of constraints 
 * in the pg_class entry for the relation. 
 * 
 * The OID of the new constraint is returned. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN2013"></a><span class='Declare_Function'>StoreRelCheck</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ccname</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>expr</span><span class='Delimiter'>, 
</span><a name="LN2014"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_validated</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_local</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>inhcount</span><span class='Delimiter'>, 
</span><a name="LN2015"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_inherit</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2017"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ccbin</span><span class='Delimiter'>; 
</span><a name="LN2018"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ccsrc</span><span class='Delimiter'>; 
</span><a name="LN2019"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>varList</span><span class='Delimiter'>; 
</span><a name="LN2020"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>keycount</span><span class='Delimiter'>; 
</span><a name="LN2021"></a>    <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>attNos</span><span class='Delimiter'>; 
</span><a name="LN2022"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>constrOid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flatten expression to string form for storage. 
     */ 
</span>    <a href="heap.c.html#LN2017"><span class='Ref_To_Local'>ccbin</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also deparse it to form the mostly-obsolete consrc field. 
     */ 
</span>    <a href="heap.c.html#LN2018"><span class='Ref_To_Local'>ccsrc</span></a> <span class='Operator'>= </span><a href="../../include/utils/ruleutils.h.html#LN26"><span class='Ref_to_Proto'>deparse_expression</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>expr</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/utils/ruleutils.h.html#LN28"><span class='Ref_to_Proto'>deparse_context_for</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                               <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find columns of rel that are used in expr 
     * 
     * NB: pull_var_clause is okay here only because we don't allow subselects 
     * in check constraints; it would fail to examine the contents of 
     * subselects. 
     */ 
</span>    <a href="heap.c.html#LN2019"><span class='Ref_To_Local'>varList</span></a> <span class='Operator'>= </span><a href="../../include/optimizer/var.h.html#LN36"><span class='Ref_to_Proto'>pull_var_clause</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>expr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN2020"><span class='Ref_To_Local'>keycount</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2019"><span class='Ref_To_Local'>varList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2020"><span class='Ref_To_Local'>keycount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2049"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>vl</span><span class='Delimiter'>; 
</span><a name="LN2050"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2021"><span class='Ref_To_Local'>attNos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2020"><span class='Ref_To_Local'>keycount</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2049"><span class='Ref_To_Local'>vl</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2019"><span class='Ref_To_Local'>varList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2055"></a>            <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>var</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2049"><span class='Ref_To_Local'>vl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2056"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2056"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN2056"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN2050"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN2056"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2021"><span class='Ref_To_Local'>attNos</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN2056"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="heap.c.html#LN2055"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2056"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>== </span><a href="heap.c.html#LN2050"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>                <a href="heap.c.html#LN2021"><span class='Ref_To_Local'>attNos</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN2050"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heap.c.html#LN2055"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="heap.c.html#LN2020"><span class='Ref_To_Local'>keycount</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2050"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heap.c.html#LN2021"><span class='Ref_To_Local'>attNos</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Partitioned tables do not contain any rows themselves, so a NO INHERIT 
     * constraint makes no sense. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2015"><span class='Ref_to_Parameter'>is_no_inherit</span></a> <span class='Operator'>&& 
</span>        <a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TABLE_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot add NO INHERIT constraint to partitioned table \"%s\""</span><span class='Delimiter'>, 
</span>               <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the Check Constraint 
     */ 
</span>    <a href="heap.c.html#LN2022"><span class='Ref_To_Local'>constrOid</span></a> <span class='Operator'>= 
</span>        <a href="../../include/catalog/pg_constraint_fn.h.html#LN29"><span class='Ref_to_Proto'>CreateConstraintEntry</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>ccname</span></a><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* Constraint Name */ 
</span>                              <a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* namespace */ 
</span>                              <a href="../../include/catalog/pg_constraint.h.html#LN187"><span class='Ref_to_Const'>CONSTRAINT_CHECK</span></a><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* Constraint Type */ 
</span>                              <span class='Boolean'>false</span><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Is Deferrable */ 
</span>                              <span class='Boolean'>false</span><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Is Deferred */ 
</span>                              <a href="heap.c.html#LN2014"><span class='Ref_to_Parameter'>is_validated</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* relation */ 
</span>                              <a href="heap.c.html#LN2021"><span class='Ref_To_Local'>attNos</span></a><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* attrs in the constraint */ 
</span>                              <a href="heap.c.html#LN2020"><span class='Ref_To_Local'>keycount</span></a><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* # attrs in the constraint */ 
</span>                              <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* not a domain constraint */ 
</span>                              <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* no associated index */ 
</span>                              <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* Foreign key fields */ 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                              <span class='Number'>0</span><span class='Delimiter'>, 
</span>                              <span class='String'>' '</span><span class='Delimiter'>, 
</span>                              <span class='String'>' '</span><span class='Delimiter'>, 
</span>                              <span class='String'>' '</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* not an exclusion constraint */ 
</span>                              <a href="heap.c.html#LN2013"><span class='Ref_to_Parameter'>expr</span></a><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* Tree form of check constraint */ 
</span>                              <a href="heap.c.html#LN2017"><span class='Ref_To_Local'>ccbin</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Binary form of check constraint */ 
</span>                              <a href="heap.c.html#LN2018"><span class='Ref_To_Local'>ccsrc</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* Source form of check constraint */ 
</span>                              <a href="heap.c.html#LN2014"><span class='Ref_to_Parameter'>is_local</span></a><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* conislocal */ 
</span>                              <a href="heap.c.html#LN2014"><span class='Ref_to_Parameter'>inhcount</span></a><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* coninhcount */ 
</span>                              <a href="heap.c.html#LN2015"><span class='Ref_to_Parameter'>is_no_inherit</span></a><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* connoinherit */ 
</span>                              <a href="heap.c.html#LN2015"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* internally constructed? */ 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2017"><span class='Ref_To_Local'>ccbin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2018"><span class='Ref_To_Local'>ccsrc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN2022"><span class='Ref_To_Local'>constrOid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StoreRelCheck &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Store defaults and constraints (passed as a list of CookedConstraint). 
 * 
 * Each CookedConstraint struct is modified to store the new catalog tuple OID. 
 * 
 * NOTE: only pre-cooked expressions will be passed this way, which is to 
 * say expressions inherited from an existing relation.  Newly parsed 
 * expressions can be added later, by direct calls to StoreAttrDefault 
 * and StoreRelCheck (see AddRelationNewConstraints()). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2130"></a><span class='Declare_Function'>StoreConstraints</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cooked_constraints</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2132"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numchecks</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2133"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>cooked_constraints</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Deparsing of constraint expressions will fail unless the just-created 
     * pg_attribute tuples for this relation are made visible.  So, bump the 
     * command counter.  CAUTION: this will cause a relcache entry rebuild. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2133"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>cooked_constraints</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2147"></a>        <a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a> <span class='Operator'>*</span><span class='Declare_Local'>con</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2133"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN29"><span class='Ref_to_Member'>contype</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN2025"><span class='Ref_to_EnumConst'>CONSTR_DEFAULT</span></a><span class='Operator'>: 
</span>                <a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN30"><span class='Ref_to_Member'>conoid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN104"><span class='Ref_to_Proto'>StoreAttrDefault</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN32"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN33"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>, 
</span>                                               <a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN2027"><span class='Ref_to_EnumConst'>CONSTR_CHECK</span></a><span class='Operator'>: 
</span>                <a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN30"><span class='Ref_to_Member'>conoid</span></a> <span class='Operator'>= 
</span>                    <a href="heap.c.html#LN105"><span class='Ref_to_Proto'>StoreRelCheck</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN31"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN33"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>!</span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN34"><span class='Ref_to_Member'>skip_validation</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN35"><span class='Ref_to_Member'>is_local</span></a><span class='Delimiter'>, 
</span>                                  <a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN36"><span class='Ref_to_Member'>inhcount</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN37"><span class='Ref_to_Member'>is_no_inherit</span></a><span class='Delimiter'>, 
</span>                                  <a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heap.c.html#LN2132"><span class='Ref_To_Local'>numchecks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized constraint type: %d"</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="heap.c.html#LN2147"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN29"><span class='Ref_to_Member'>contype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2132"><span class='Ref_To_Local'>numchecks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="heap.c.html#LN114"><span class='Ref_to_Proto'>SetRelationNumChecks</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2130"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2132"><span class='Ref_To_Local'>numchecks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StoreConstraints &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AddRelationNewConstraints 
 * 
 * Add new column default expressions and/or constraint check expressions 
 * to an existing relation.  This is defined to do both for efficiency in 
 * DefineRelation, but of course you can do just one or the other by passing 
 * empty lists. 
 * 
 * rel: relation to be modified 
 * newColDefaults: list of RawColumnDefault structures 
 * newConstraints: list of Constraint nodes 
 * allow_merge: TRUE if check constraints may be merged with existing ones 
 * is_local: TRUE if definition is local, FALSE if it's inherited 
 * is_internal: TRUE if result of some internal process, not a user request 
 * 
 * All entries in newColDefaults will be processed.  Entries in newConstraints 
 * will be processed only if they are CONSTR_CHECK type. 
 * 
 * Returns a list of CookedConstraint nodes that shows the cooked form of 
 * the default and constraint expressions added to the relation. 
 * 
 * NB: caller should have opened rel with AccessExclusiveLock, and should 
 * hold that lock till end of transaction.  Also, we assume the caller has 
 * done a CommandCounterIncrement if necessary to make the relation's catalog 
 * tuples visible. 
 */ 
</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN2200"></a><span class='Declare_Function'>AddRelationNewConstraints</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN2201"></a>                          <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newColDefaults</span><span class='Delimiter'>, 
</span><a name="LN2202"></a>                          <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newConstraints</span><span class='Delimiter'>, 
</span><a name="LN2203"></a>                          <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_merge</span><span class='Delimiter'>, 
</span><a name="LN2204"></a>                          <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_local</span><span class='Delimiter'>, 
</span><a name="LN2205"></a>                          <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_internal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2207"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>cookedConstraints</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN2208"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupleDesc</span><span class='Delimiter'>; 
</span><a name="LN2209"></a>    <a href="../../include/access/tupdesc.h.html#LN36"><span class='Ref_to_Typedef'>TupleConstr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oldconstr</span><span class='Delimiter'>; 
</span><a name="LN2210"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numoldchecks</span><span class='Delimiter'>; 
</span><a name="LN2211"></a>    <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pstate</span><span class='Delimiter'>; 
</span><a name="LN2212"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>; 
</span><a name="LN2213"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numchecks</span><span class='Delimiter'>; 
</span><a name="LN2214"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>checknames</span><span class='Delimiter'>; 
</span><a name="LN2215"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN2216"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>expr</span><span class='Delimiter'>; 
</span><a name="LN2217"></a>    <a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cooked</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get info about existing constraints. 
     */ 
</span>    <a href="heap.c.html#LN2208"><span class='Ref_To_Local'>tupleDesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN2209"><span class='Ref_To_Local'>oldconstr</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2208"><span class='Ref_To_Local'>tupleDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN75"><span class='Ref_to_Member'>constr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2209"><span class='Ref_To_Local'>oldconstr</span></a><span class='Parentheses'>) 
</span>        <a href="heap.c.html#LN2210"><span class='Ref_To_Local'>numoldchecks</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2209"><span class='Ref_To_Local'>oldconstr</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN41"><span class='Ref_to_Member'>num_check</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="heap.c.html#LN2210"><span class='Ref_To_Local'>numoldchecks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a dummy ParseState and insert the target relation as its sole 
     * rangetable entry.  We need a ParseState for transformExpr. 
     */ 
</span>    <a href="heap.c.html#LN2211"><span class='Ref_To_Local'>pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN2212"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2211"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>, 
</span>                                        <a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, 
</span>                                        <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                        <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                        <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/parser/parse_relation.h.html#LN114"><span class='Ref_to_Proto'>addRTEtoQuery</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2211"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2212"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process column default expressions. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2215"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2201"><span class='Ref_to_Parameter'>newColDefaults</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2246"></a>        <a href="../../include/catalog/heap.h.html#LN21"><span class='Ref_to_Struct'>RawColumnDefault</span></a> <span class='Operator'>*</span><span class='Declare_Local'>colDef</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN21"><span class='Ref_to_Struct'>RawColumnDefault</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2215"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2247"></a>        <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>atp</span> <span class='Operator'>= </span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN2246"><span class='Ref_To_Local'>colDef</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN23"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN2248"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>defOid</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN107"><span class='Ref_to_Proto'>cookDefault</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2211"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2246"><span class='Ref_To_Local'>colDef</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN24"><span class='Ref_to_Member'>raw_default</span></a><span class='Delimiter'>, 
</span>                           <a href="heap.c.html#LN2247"><span class='Ref_To_Local'>atp</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, </span><a href="heap.c.html#LN2247"><span class='Ref_To_Local'>atp</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>, 
</span>                           <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2247"><span class='Ref_To_Local'>atp</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the expression is just a NULL constant, we do not bother to make 
         * an explicit pg_attrdef entry, since the default behavior is 
         * equivalent. 
         * 
         * Note a nonobvious property of this test: if the column is of a 
         * domain type, what we'll get is not a bare null Const but a 
         * CoerceToDomain expr, so we will not discard the default.  This is 
         * critical because the column default needs to be retained to 
         * override any default that the domain might have. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a><span class='Parentheses'>)</span> <span class='Operator'>&&</span><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>constisnull<span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2248"><span class='Ref_To_Local'>defOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN104"><span class='Ref_to_Proto'>StoreAttrDefault</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2246"><span class='Ref_To_Local'>colDef</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN23"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2205"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN29"><span class='Ref_to_Member'>contype</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN2025"><span class='Ref_to_EnumConst'>CONSTR_DEFAULT</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN30"><span class='Ref_to_Member'>conoid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2248"><span class='Ref_To_Local'>defOid</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN31"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN32"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2246"><span class='Ref_To_Local'>colDef</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN23"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN33"><span class='Ref_to_Member'>expr</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN34"><span class='Ref_to_Member'>skip_validation</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN35"><span class='Ref_to_Member'>is_local</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN36"><span class='Ref_to_Member'>inhcount</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a> <span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN37"><span class='Ref_to_Member'>is_no_inherit</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2207"><span class='Ref_To_Local'>cookedConstraints</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2207"><span class='Ref_To_Local'>cookedConstraints</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process constraint expressions. 
     */ 
</span>    <a href="heap.c.html#LN2213"><span class='Ref_To_Local'>numchecks</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2210"><span class='Ref_To_Local'>numoldchecks</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2215"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2202"><span class='Ref_to_Parameter'>newConstraints</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2291"></a>        <a href="../../include/nodes/parsenodes.h.html#LN2050"><span class='Ref_to_Struct'>Constraint</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cdef</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2050"><span class='Ref_to_Struct'>Constraint</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2215"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2292"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ccname</span><span class='Delimiter'>; 
</span><a name="LN2293"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>constrOid</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2053"><span class='Ref_to_Member'>contype</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN2027"><span class='Ref_to_EnumConst'>CONSTR_CHECK</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2063"><span class='Ref_to_Member'>raw_expr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2064"><span class='Ref_to_Member'>cooked_expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Transform raw parsetree to executable expression, and verify 
             * it's valid as a CHECK constraint. 
             */ 
</span>            <a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN115"><span class='Ref_to_Proto'>cookConstraint</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2211"><span class='Ref_To_Local'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2063"><span class='Ref_to_Member'>raw_expr</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2064"><span class='Ref_to_Member'>cooked_expr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Here, we assume the parser will only pass us valid CHECK 
             * expressions, so we do no particular checking. 
             */ 
</span>            <a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2064"><span class='Ref_to_Member'>cooked_expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check name uniqueness, or generate a name if none was given. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2056"><span class='Ref_to_Member'>conname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2325"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell2</span><span class='Delimiter'>; 
</span> 
            <a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2056"><span class='Ref_to_Member'>conname</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Check against other new constraints */ 
</span>            <span class='Comment_Multi_Line'>/* Needed because we don't do CommandCounterIncrement in loop */ 
</span>            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2325"><span class='Ref_To_Local'>cell2</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2325"><span class='Ref_To_Local'>cell2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"check constraint \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                                    <a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* save name for future checks */ 
</span>            <a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check against pre-existing constraints.  If we are allowed to 
             * merge with an existing constraint, there's no more to do here. 
             * (We omit the duplicate constraint from the result, which is 
             * what ATAddCheckConstraint wants.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN110"><span class='Ref_to_Proto'>MergeWithExistingConstraint</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, 
</span>                                            <a href="heap.c.html#LN2203"><span class='Ref_to_Parameter'>allow_merge</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a><span class='Delimiter'>, 
</span>                                            <a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2093"><span class='Ref_to_Member'>initially_valid</span></a><span class='Delimiter'>, 
</span>                                            <a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2062"><span class='Ref_to_Member'>is_no_inherit</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cdef-&GT;conname!=NULL &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * When generating a name, we want to create "tab_col_check" for a 
             * column constraint and "tab_check" for a table constraint.  We 
             * no longer have any info about the syntactic positioning of the 
             * constraint phrase, so we approximate this by seeing whether the 
             * expression references more than one column.  (If the user 
             * played by the rules, the result is the same...) 
             * 
             * Note: pull_var_clause() doesn't descend into sublinks, but we 
             * eliminated those above; and anyway this only needs to be an 
             * approximate answer. 
             */ 
</span><a name="LN2368"></a>            <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>vars</span><span class='Delimiter'>; 
</span><a name="LN2369"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>colname</span><span class='Delimiter'>; 
</span> 
            <a href="heap.c.html#LN2368"><span class='Ref_To_Local'>vars</span></a> <span class='Operator'>= </span><a href="../../include/optimizer/var.h.html#LN36"><span class='Ref_to_Proto'>pull_var_clause</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* eliminate duplicates */ 
</span>            <a href="heap.c.html#LN2368"><span class='Ref_To_Local'>vars</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN240"><span class='Ref_to_Proto'>list_union</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2368"><span class='Ref_To_Local'>vars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2368"><span class='Ref_To_Local'>vars</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="heap.c.html#LN2369"><span class='Ref_To_Local'>colname</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN85"><span class='Ref_to_Proto'>get_attname</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2368"><span class='Ref_To_Local'>vars</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>varattno<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="heap.c.html#LN2369"><span class='Ref_To_Local'>colname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_constraint_fn.h.html#LN64"><span class='Ref_to_Proto'>ChooseConstraintName</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                          <a href="heap.c.html#LN2369"><span class='Ref_To_Local'>colname</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"check"</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                          <a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* save name for future checks */ 
</span>            <a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2214"><span class='Ref_To_Local'>checknames</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * OK, store it. 
         */ 
</span>        <a href="heap.c.html#LN2293"><span class='Ref_To_Local'>constrOid</span></a> <span class='Operator'>= 
</span>            <a href="heap.c.html#LN105"><span class='Ref_to_Proto'>StoreRelCheck</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2093"><span class='Ref_to_Member'>initially_valid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a><span class='Delimiter'>, 
</span>                          <a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a> <span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2062"><span class='Ref_to_Member'>is_no_inherit</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2205"><span class='Ref_to_Parameter'>is_internal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2213"><span class='Ref_To_Local'>numchecks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/catalog/heap.h.html#LN27"><span class='Ref_to_Struct'>CookedConstraint</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN29"><span class='Ref_to_Member'>contype</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN2027"><span class='Ref_to_EnumConst'>CONSTR_CHECK</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN30"><span class='Ref_to_Member'>conoid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2293"><span class='Ref_To_Local'>constrOid</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN31"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2292"><span class='Ref_To_Local'>ccname</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN32"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN33"><span class='Ref_to_Member'>expr</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2216"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN34"><span class='Ref_to_Member'>skip_validation</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2092"><span class='Ref_to_Member'>skip_validation</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN35"><span class='Ref_to_Member'>is_local</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN36"><span class='Ref_to_Member'>inhcount</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2204"><span class='Ref_to_Parameter'>is_local</span></a> <span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/heap.h.html#LN37"><span class='Ref_to_Member'>is_no_inherit</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2291"><span class='Ref_To_Local'>cdef</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2062"><span class='Ref_to_Member'>is_no_inherit</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2207"><span class='Ref_To_Local'>cookedConstraints</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2207"><span class='Ref_To_Local'>cookedConstraints</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2217"><span class='Ref_To_Local'>cooked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update the count of constraints in the relation's pg_class tuple. We do 
     * this even if there was no change, in order to ensure that an SI update 
     * message is sent out for the pg_class tuple, which will force other 
     * backends to rebuild their relcache entries for the rel. (This is 
     * critical if we added defaults but not constraints.) 
     */ 
</span>    <a href="heap.c.html#LN114"><span class='Ref_to_Proto'>SetRelationNumChecks</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2200"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2213"><span class='Ref_To_Local'>numchecks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN2207"><span class='Ref_To_Local'>cookedConstraints</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddRelationNewConstraints &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check for a pre-existing check constraint that conflicts with a proposed 
 * new one, and either adjust its conislocal/coninhcount settings or throw 
 * error as needed. 
 * 
 * Returns TRUE if merged (constraint is a duplicate), or FALSE if it's 
 * got a so-far-unique name, or throws error if conflict. 
 * 
 * XXX See MergeConstraintsIntoExisting too if you change this code. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2437"></a><span class='Declare_Function'>MergeWithExistingConstraint</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ccname</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>expr</span><span class='Delimiter'>, 
</span><a name="LN2438"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_merge</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_local</span><span class='Delimiter'>, 
</span><a name="LN2439"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_initially_valid</span><span class='Delimiter'>, 
</span><a name="LN2440"></a>                            <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_inherit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2442"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN2443"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>conDesc</span><span class='Delimiter'>; 
</span><a name="LN2444"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>conscan</span><span class='Delimiter'>; 
</span><a name="LN2445"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN2446"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search for a pg_constraint entry with same name and relation */ 
</span>    <a href="heap.c.html#LN2443"><span class='Ref_To_Local'>conDesc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_constraint.h.html#LN28"><span class='Ref_to_Const'>ConstraintRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN2442"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN2445"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_constraint.h.html#LN153"><span class='Ref_to_Const'>Anum_pg_constraint_conname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>ccname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN2445"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_constraint.h.html#LN154"><span class='Ref_to_Const'>Anum_pg_constraint_connamespace</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN2444"><span class='Ref_To_Local'>conscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2443"><span class='Ref_To_Local'>conDesc</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN123"><span class='Ref_to_Const'>ConstraintNameNspIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="heap.c.html#LN2445"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2444"><span class='Ref_To_Local'>conscan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2468"></a>        <a href="../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a> <span class='Declare_Local'>con</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>conrelid <span class='Operator'>== </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Found it.  Conflicts if not identical check constraint */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>contype <span class='Operator'>== </span><a href="../../include/catalog/pg_constraint.h.html#LN187"><span class='Ref_to_Const'>CONSTRAINT_CHECK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2475"></a>                <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN2476"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
                <a href="heap.c.html#LN2475"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/catalog/pg_constraint.h.html#LN175"><span class='Ref_to_Const'>Anum_pg_constraint_conbin</span></a><span class='Delimiter'>, 
</span>                                  <a href="heap.c.html#LN2443"><span class='Ref_To_Local'>conDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN2476"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2476"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null conbin for rel %s"</span><span class='Delimiter'>, 
</span>                         <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN626"><span class='Ref_to_Proto'>equal</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>expr</span></a><span class='Delimiter'>, </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2475"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))))</span> 
                    <a href="heap.c.html#LN2442"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the existing constraint is purely inherited (no local 
             * definition) then interpret addition of a local constraint as a 
             * legal merge.  This allows ALTER ADD CONSTRAINT on parent and 
             * child tables to be given in either order with same end state. 
             * However if the relation is a partition, all inherited 
             * constraints are always non-local, including those that were 
             * merged. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2438"><span class='Ref_to_Parameter'>is_local</span></a> <span class='Operator'>&& !</span><a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>conislocal <span class='Operator'>&& !</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relispartition<span class='Parentheses'>) 
</span>                <a href="heap.c.html#LN2438"><span class='Ref_to_Parameter'>allow_merge</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heap.c.html#LN2442"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>|| !</span><a href="heap.c.html#LN2438"><span class='Ref_to_Parameter'>allow_merge</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"constraint \"%s\" for relation \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                       <a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>ccname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If the child constraint is "no inherit" then cannot merge */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>connoinherit<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"constraint \"%s\" conflicts with non-inherited constraint on relation \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>ccname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Must not change an existing inherited constraint to "no 
             * inherit" status.  That's because inherited constraints should 
             * be able to propagate to lower-level children. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>coninhcount <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="heap.c.html#LN2440"><span class='Ref_to_Parameter'>is_no_inherit</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"constraint \"%s\" conflicts with inherited constraint on relation \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>ccname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the child constraint is "not valid" then cannot merge with a 
             * valid parent constraint 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2439"><span class='Ref_to_Parameter'>is_initially_valid</span></a> <span class='Operator'>&& !</span><a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>convalidated<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"constraint \"%s\" conflicts with NOT VALID constraint on relation \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>ccname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* OK to update the tuple */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"merging constraint \"%s\" with inherited definition"</span><span class='Delimiter'>, 
</span>                       <a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>ccname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN606"><span class='Ref_to_Func'>heap_copytuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * In case of partitions, an inherited constraint must be 
             * inherited only once since it cannot have multiple parents and 
             * it is never considered local. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2437"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relispartition<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>coninhcount <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>conislocal <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2438"><span class='Ref_to_Parameter'>is_local</span></a><span class='Parentheses'>) 
</span>                    <a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>conislocal <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>coninhcount<span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2440"><span class='Ref_to_Parameter'>is_no_inherit</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN2438"><span class='Ref_to_Parameter'>is_local</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="heap.c.html#LN2468"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>connoinherit <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2443"><span class='Ref_To_Local'>conDesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2446"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if con-&GT;conrelid==Relati... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while HeapTupleIsValid(tup=... &raquo; </span> 
 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2444"><span class='Ref_To_Local'>conscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2443"><span class='Ref_To_Local'>conDesc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN2442"><span class='Ref_To_Local'>found</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MergeWithExistingConstraint &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update the count of constraints in the relation's pg_class tuple. 
 * 
 * Caller had better hold exclusive lock on the relation. 
 * 
 * An important side effect is that a SI update message will be sent out for 
 * the pg_class tuple, which will force other backends to rebuild their 
 * relcache entries for the rel.  Also, this backend will rebuild its 
 * own relcache entry at the next CommandCounterIncrement. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2587"></a><span class='Declare_Function'>SetRelationNumChecks</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>numchecks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2589"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>relrel</span><span class='Delimiter'>; 
</span><a name="LN2590"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>reltup</span><span class='Delimiter'>; 
</span><a name="LN2591"></a>    <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>relStruct</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN2589"><span class='Ref_To_Local'>relrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN2590"><span class='Ref_To_Local'>reltup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2587"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2590"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2587"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN2591"><span class='Ref_To_Local'>relStruct</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2590"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2591"><span class='Ref_To_Local'>relStruct</span></a><span class='Operator'>-&GT;</span>relchecks <span class='Operator'>!= </span><a href="heap.c.html#LN2587"><span class='Ref_to_Parameter'>numchecks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heap.c.html#LN2591"><span class='Ref_To_Local'>relStruct</span></a><span class='Operator'>-&GT;</span>relchecks <span class='Operator'>= </span><a href="heap.c.html#LN2587"><span class='Ref_to_Parameter'>numchecks</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2589"><span class='Ref_To_Local'>relrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN2590"><span class='Ref_To_Local'>reltup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2590"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Skip the disk update, but force relcache inval anyway */ 
</span>        <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2587"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2590"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2589"><span class='Ref_To_Local'>relrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetRelationNumChecks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Take a raw default and convert it to a cooked format ready for 
 * storage. 
 * 
 * Parse state should be set up to recognize any vars that might appear 
 * in the expression.  (Even though we plan to reject vars, it's more 
 * user-friendly to give the correct error message than "unknown var".) 
 * 
 * If atttypid is not InvalidOid, coerce the expression to the specified 
 * type (and typmod atttypmod).   attname is only needed in this case: 
 * it is used in the error message, if any. 
 */ 
</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>* 
</span><a name="LN2630"></a><span class='Declare_Function'>cookDefault</span><span class='Parentheses'>(</span><a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN2631"></a>            <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>raw_default</span><span class='Delimiter'>, 
</span><a name="LN2632"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>atttypid</span><span class='Delimiter'>, 
</span><a name="LN2633"></a>            <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>atttypmod</span><span class='Delimiter'>, 
</span><a name="LN2634"></a>            <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2636"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>expr</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN2631"><span class='Ref_to_Parameter'>raw_default</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Transform raw parsetree to executable expression. 
     */ 
</span>    <a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_expr.h.html#LN21"><span class='Ref_to_Proto'>transformExpr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2630"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2631"><span class='Ref_to_Parameter'>raw_default</span></a><span class='Delimiter'>, </span><a href="../../include/parser/parse_node.h.html#LN61"><span class='Ref_to_EnumConst'>EXPR_KIND_COLUMN_DEFAULT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure default expr does not refer to any vars (we need this check 
     * since the pstate includes the target table). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/optimizer/var.h.html#LN33"><span class='Ref_to_Proto'>contain_var_clause</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_COLUMN_REFERENCE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot use column references in default expression"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * transformExpr() should have already rejected subqueries, aggregates, 
     * window functions, and SRFs, based on the EXPR_KIND_ for a default 
     * expression. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Coerce the expression to the correct type and typmod, if given. This 
     * should match the parser's processing of non-defaulted expressions --- 
     * see transformAssignedExpr(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2632"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2667"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>type_id</span> <span class='Operator'>= </span><a href="../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_coerce.h.html#LN37"><span class='Ref_to_Proto'>coerce_to_target_type</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2630"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2667"><span class='Ref_To_Local'>type_id</span></a><span class='Delimiter'>, 
</span>                                     <a href="heap.c.html#LN2632"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2633"><span class='Ref_to_Parameter'>atttypmod</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/nodes/primnodes.h.html#LN421"><span class='Ref_to_EnumConst'>COERCION_ASSIGNMENT</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/nodes/primnodes.h.html#LN438"><span class='Ref_to_EnumConst'>COERCE_IMPLICIT_CAST</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column \"%s\" is of type %s"</span> 
                            <span class='String'>" but default expression is of type %s"</span><span class='Delimiter'>, 
</span>                            <a href="heap.c.html#LN2634"><span class='Ref_to_Parameter'>attname</span></a><span class='Delimiter'>, 
</span>                            <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2632"><span class='Ref_to_Parameter'>atttypid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2667"><span class='Ref_To_Local'>type_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You will need to rewrite or cast the expression."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Finally, take care of collations in the finished expression. 
     */ 
</span>    <a href="../../include/parser/parse_collate.h.html#LN22"><span class='Ref_to_Proto'>assign_expr_collations</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2630"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN2636"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end cookDefault &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Take a raw CHECK constraint expression and convert it to a cooked format 
 * ready for storage. 
 * 
 * Parse state must be set up to recognize any vars that might appear 
 * in the expression. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>* 
</span><a name="LN2701"></a><span class='Declare_Function'>cookConstraint</span><span class='Parentheses'>(</span><a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, 
</span><a name="LN2702"></a>               <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>raw_constraint</span><span class='Delimiter'>, 
</span><a name="LN2703"></a>               <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2705"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>expr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Transform raw parsetree to executable expression. 
     */ 
</span>    <a href="heap.c.html#LN2705"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_expr.h.html#LN21"><span class='Ref_to_Proto'>transformExpr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2701"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2702"><span class='Ref_to_Parameter'>raw_constraint</span></a><span class='Delimiter'>, </span><a href="../../include/parser/parse_node.h.html#LN59"><span class='Ref_to_EnumConst'>EXPR_KIND_CHECK_CONSTRAINT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure it yields a boolean result. 
     */ 
</span>    <a href="heap.c.html#LN2705"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_coerce.h.html#LN54"><span class='Ref_to_Proto'>coerce_to_boolean</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2701"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2705"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><span class='String'>"CHECK"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Take care of collations. 
     */ 
</span>    <a href="../../include/parser/parse_collate.h.html#LN22"><span class='Ref_to_Proto'>assign_expr_collations</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2701"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2705"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure no outside relations are referred to (this is probably dead 
     * code now that add_missing_from is history). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2701"><span class='Ref_to_Parameter'>pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_COLUMN_REFERENCE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"only table \"%s\" can be referenced in check constraint"</span><span class='Delimiter'>, 
</span>                   <a href="heap.c.html#LN2703"><span class='Ref_to_Parameter'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN2705"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end cookConstraint &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * RemoveStatistics --- remove entries in pg_statistic for a rel or column 
 * 
 * If attnum is zero, remove all entries for rel; else remove only the one(s) 
 * for that column. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2743"></a><span class='Declare_Function'>RemoveStatistics</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Declare_Parameter'>attnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2745"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pgstatistic</span><span class='Delimiter'>; 
</span><a name="LN2746"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN2747"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN2748"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nkeys</span><span class='Delimiter'>; 
</span><a name="LN2749"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN2745"><span class='Ref_To_Local'>pgstatistic</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_statistic.h.html#LN28"><span class='Ref_to_Const'>StatisticRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN2747"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_statistic.h.html#LN135"><span class='Ref_to_Const'>Anum_pg_statistic_starelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2743"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2743"><span class='Ref_to_Parameter'>attnum</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="heap.c.html#LN2748"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN2747"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_statistic.h.html#LN136"><span class='Ref_to_Const'>Anum_pg_statistic_staattnum</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT2EQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2743"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2748"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="heap.c.html#LN2746"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2745"><span class='Ref_To_Local'>pgstatistic</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN233"><span class='Ref_to_Const'>StatisticRelidAttnumInhIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="heap.c.html#LN2748"><span class='Ref_To_Local'>nkeys</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2747"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we must loop even when attnum != 0, in case of inherited stats */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2749"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2746"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2745"><span class='Ref_To_Local'>pgstatistic</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN2749"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2746"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2745"><span class='Ref_To_Local'>pgstatistic</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveStatistics &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * RelationTruncateIndexes - truncate all indexes associated 
 * with the heap relation to zero tuples. 
 * 
 * The routine will truncate and then reconstruct the indexes on 
 * the specified relation.  Caller must hold exclusive lock on rel. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2790"></a><span class='Declare_Function'>RelationTruncateIndexes</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>heapRelation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2792"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>indlist</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Ask the relcache to produce a list of the indexes of the rel */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2792"><span class='Ref_To_Local'>indlist</span></a><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN40"><span class='Ref_to_Proto'>RelationGetIndexList</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2790"><span class='Ref_to_Parameter'>heapRelation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2797"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indexId</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2792"><span class='Ref_To_Local'>indlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2798"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>currentIndex</span><span class='Delimiter'>; 
</span><a name="LN2799"></a>        <a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indexInfo</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Open the index relation; use exclusive lock, just to be sure */ 
</span>        <a href="heap.c.html#LN2798"><span class='Ref_To_Local'>currentIndex</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2797"><span class='Ref_To_Local'>indexId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch info needed for index_build */ 
</span>        <a href="heap.c.html#LN2799"><span class='Ref_To_Local'>indexInfo</span></a> <span class='Operator'>= </span><a href="../../include/catalog/index.h.html#LN81"><span class='Ref_to_Proto'>BuildIndexInfo</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2798"><span class='Ref_To_Local'>currentIndex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now truncate the actual file (and discard buffers). 
         */ 
</span>        <a href="../../include/catalog/storage.h.html#LN23"><span class='Ref_to_Proto'>RelationTruncate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2798"><span class='Ref_To_Local'>currentIndex</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize the index and rebuild */ 
</span>        <span class='Comment_Multi_Line'>/* Note: we do not need to re-establish pkey setting */ 
</span>        <a href="../../include/catalog/index.h.html#LN91"><span class='Ref_to_Proto'>index_build</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2790"><span class='Ref_to_Parameter'>heapRelation</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2798"><span class='Ref_To_Local'>currentIndex</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2799"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We're done with this index */ 
</span>        <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2798"><span class='Ref_To_Local'>currentIndex</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end RelationTruncateIndexes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *   heap_truncate 
 * 
 *   This routine deletes all data within all the specified relations. 
 * 
 * This is not transaction-safe!  There is another, transaction-safe 
 * implementation in commands/tablecmds.c.  We now use this only for 
 * ON COMMIT truncation of temporary tables, where it doesn't matter. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2831"></a><span class='Declare_Function'>heap_truncate</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relids</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2833"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>relations</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN2834"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open relations for processing, and grab exclusive access on each */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2834"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2831"><span class='Ref_to_Parameter'>relids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2839"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>rid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2834"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2840"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2840"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2839"><span class='Ref_To_Local'>rid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2833"><span class='Ref_To_Local'>relations</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2833"><span class='Ref_To_Local'>relations</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2840"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Don't allow truncate on tables that are referenced by foreign keys */ 
</span>    <a href="../../include/catalog/heap.h.html#LN83"><span class='Ref_to_Proto'>heap_truncate_check_FKs</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2833"><span class='Ref_To_Local'>relations</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK to do it */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2834"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2833"><span class='Ref_To_Local'>relations</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2852"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2834"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Truncate the relation */ 
</span>        <a href="../../include/catalog/heap.h.html#LN81"><span class='Ref_to_Proto'>heap_truncate_one_rel</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2852"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Close the relation, but keep exclusive lock on it until commit */ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2852"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_truncate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *   heap_truncate_one_rel 
 * 
 *   This routine deletes all data within the specified relation. 
 * 
 * This is not transaction-safe, because the truncation is done immediately 
 * and cannot be rolled back later.  Caller is responsible for having 
 * checked permissions etc, and must have obtained AccessExclusiveLock. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2872"></a><span class='Declare_Function'>heap_truncate_one_rel</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2874"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>toastrelid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Truncate the actual file (and discard buffers) */ 
</span>    <a href="../../include/catalog/storage.h.html#LN23"><span class='Ref_to_Proto'>RelationTruncate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2872"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the relation has indexes, truncate the indexes too */ 
</span>    <a href="heap.c.html#LN2789"><span class='Ref_to_Func'>RelationTruncateIndexes</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2872"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there is a toast table, truncate that too */ 
</span>    <a href="heap.c.html#LN2874"><span class='Ref_To_Local'>toastrelid</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN2872"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2874"><span class='Ref_To_Local'>toastrelid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2886"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toastrel</span> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2874"><span class='Ref_To_Local'>toastrelid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/storage.h.html#LN23"><span class='Ref_to_Proto'>RelationTruncate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2886"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN2789"><span class='Ref_to_Func'>RelationTruncateIndexes</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2886"><span class='Ref_To_Local'>toastrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* keep the lock... */ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2886"><span class='Ref_To_Local'>toastrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_truncate_one_rel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_truncate_check_FKs 
 *      Check for foreign keys referencing a list of relations that 
 *      are to be truncated, and raise error if there are any 
 * 
 * We disallow such FKs (except self-referential ones) since the whole point 
 * of TRUNCATE is to not scan the individual rows to be thrown away. 
 * 
 * This is split out so it can be shared by both implementations of truncate. 
 * Caller should already hold a suitable lock on the relations. 
 * 
 * tempTables is only used to select an appropriate error message. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2909"></a><span class='Declare_Function'>heap_truncate_check_FKs</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relations</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>tempTables</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2911"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>oids</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN2912"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>dependents</span><span class='Delimiter'>; 
</span><a name="LN2913"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build a list of OIDs of the interesting relations. 
     * 
     * If a relation has no triggers, then it can neither have FKs nor be 
     * referenced by a FK from another table, so we can ignore it. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2913"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2909"><span class='Ref_to_Parameter'>relations</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2923"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2913"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2923"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhastriggers<span class='Parentheses'>) 
</span>            <a href="heap.c.html#LN2911"><span class='Ref_To_Local'>oids</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN162"><span class='Ref_to_Func'>lappend_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2911"><span class='Ref_To_Local'>oids</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2923"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fast path: if no relation has triggers, none has FKs either. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2911"><span class='Ref_To_Local'>oids</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise, must scan pg_constraint.  We make one pass with all the 
     * relations considered; if this finds nothing, then all is well. 
     */ 
</span>    <a href="heap.c.html#LN2912"><span class='Ref_To_Local'>dependents</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN85"><span class='Ref_to_Proto'>heap_truncate_find_FKs</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2911"><span class='Ref_To_Local'>oids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2912"><span class='Ref_To_Local'>dependents</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise we repeat the scan once per relation to identify a particular 
     * pair of relations to complain about.  This is pretty slow, but 
     * performance shouldn't matter much in a failure path.  The reason for 
     * doing things this way is to ensure that the message produced is not 
     * dependent on chance row locations within pg_constraint. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2913"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2911"><span class='Ref_To_Local'>oids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2952"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2913"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2953"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell2</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN2912"><span class='Ref_To_Local'>dependents</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN85"><span class='Ref_to_Proto'>heap_truncate_find_FKs</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN150"><span class='Ref_to_Macro'>list_make1_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2952"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2953"><span class='Ref_To_Local'>cell2</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2912"><span class='Ref_To_Local'>dependents</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2959"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid2</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2953"><span class='Ref_To_Local'>cell2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2911"><span class='Ref_To_Local'>oids</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2959"><span class='Ref_To_Local'>relid2</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN2963"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2952"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2964"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname2</span> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN2959"><span class='Ref_To_Local'>relid2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN2909"><span class='Ref_to_Parameter'>tempTables</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unsupported ON COMMIT and foreign key combination"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Table \"%s\" references \"%s\", but they do not have the same ON COMMIT setting."</span><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN2964"><span class='Ref_To_Local'>relname2</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2963"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot truncate a table referenced in a foreign key constraint"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Table \"%s\" references \"%s\"."</span><span class='Delimiter'>, 
</span>                                       <a href="heap.c.html#LN2964"><span class='Ref_To_Local'>relname2</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN2963"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Truncate table \"%s\" at the same time, "</span> 
                                   <span class='String'>"or use TRUNCATE ... CASCADE."</span><span class='Delimiter'>, 
</span>                                   <a href="heap.c.html#LN2964"><span class='Ref_To_Local'>relname2</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !list_member_oid(oids... &raquo; </span> 
        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end heap_truncate_check_FKs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * heap_truncate_find_FKs 
 *      Find relations having foreign keys referencing any of the given rels 
 * 
 * Input and result are both lists of relation OIDs.  The result contains 
 * no duplicates, does *not* include any rels that were already in the input 
 * list, and is sorted in OID order.  (The last property is enforced mainly 
 * to guarantee consistent behavior in the regression tests; we don't want 
 * behavior to change depending on chance locations of rows in pg_constraint.) 
 * 
 * Note: caller should already have appropriate lock on all rels mentioned 
 * in relationIds.  Since adding or dropping an FK requires exclusive lock 
 * on both rels, this ensures that the answer will be stable. 
 */ 
</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN3001"></a><span class='Declare_Function'>heap_truncate_find_FKs</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relationIds</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3003"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN3004"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fkeyRel</span><span class='Delimiter'>; 
</span><a name="LN3005"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>fkeyScan</span><span class='Delimiter'>; 
</span><a name="LN3006"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Must scan pg_constraint.  Right now, it is a seqscan because there is 
     * no available index on confrelid. 
     */ 
</span>    <a href="heap.c.html#LN3004"><span class='Ref_To_Local'>fkeyRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_constraint.h.html#LN28"><span class='Ref_to_Const'>ConstraintRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3005"><span class='Ref_To_Local'>fkeyScan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3004"><span class='Ref_To_Local'>fkeyRel</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3006"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3005"><span class='Ref_To_Local'>fkeyScan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3019"></a>        <a href="../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a> <span class='Declare_Local'>con</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3006"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Not a foreign key */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3019"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>contype <span class='Operator'>!= </span><a href="../../include/catalog/pg_constraint.h.html#LN188"><span class='Ref_to_Const'>CONSTRAINT_FOREIGN</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Not referencing one of our list of tables */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3001"><span class='Ref_to_Parameter'>relationIds</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3019"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>confrelid<span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Add referencer unless already in input or result list */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3001"><span class='Ref_to_Parameter'>relationIds</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3019"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>conrelid<span class='Parentheses'>))</span> 
            <a href="heap.c.html#LN3003"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN118"><span class='Ref_to_Proto'>insert_ordered_unique_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3003"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3019"><span class='Ref_To_Local'>con</span></a><span class='Operator'>-&GT;</span>conrelid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3005"><span class='Ref_To_Local'>fkeyScan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3004"><span class='Ref_To_Local'>fkeyRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="heap.c.html#LN3003"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_truncate_find_FKs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * insert_ordered_unique_oid 
 *      Insert a new Oid into a sorted list of Oids, preserving ordering, 
 *      and eliminating duplicates 
 * 
 * Building the ordered list this way is O(N^2), but with a pretty small 
 * constant, so for the number of entries we expect it will probably be 
 * faster than trying to apply qsort().  It seems unlikely someone would be 
 * trying to truncate a table with thousands of dependent tables ... 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN3051"></a><span class='Declare_Function'>insert_ordered_unique_oid</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>datum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3053"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Does the datum belong at the front? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>|| </span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>datum</span></a> <span class='Operator'>&LT; </span><a href="../../include/nodes/pg_list.h.html#LN112"><span class='Ref_to_Macro'>linitial_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/nodes/pg_list.h.html#LN217"><span class='Ref_to_Proto'>lcons_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>datum</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Does it match the first entry? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>datum</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN112"><span class='Ref_to_Macro'>linitial_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* duplicate, so don't insert */ 
</span>    <span class='Comment_Multi_Line'>/* No, so find the entry it belongs after */ 
</span>    <a href="heap.c.html#LN3053"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3065"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>curr</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3053"><span class='Ref_To_Local'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3065"><span class='Ref_To_Local'>curr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>datum</span></a> <span class='Operator'>&LT; </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3065"><span class='Ref_To_Local'>curr</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* it belongs after 'prev', before 'curr' */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>datum</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3065"><span class='Ref_To_Local'>curr</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* duplicate, so don't insert */ 
</span> 
        <a href="heap.c.html#LN3053"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN3065"><span class='Ref_To_Local'>curr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* Insert datum into list after 'prev' */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN213"><span class='Ref_to_Proto'>lappend_cell_oid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3053"><span class='Ref_To_Local'>prev</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="heap.c.html#LN3051"><span class='Ref_to_Parameter'>list</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end insert_ordered_unique_oid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * StorePartitionKey 
 *      Store information about the partition key rel into the catalog 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3085"></a><span class='Declare_Function'>StorePartitionKey</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN3086"></a>                  <span class='Keyword'>char </span><span class='Declare_Parameter'>strategy</span><span class='Delimiter'>, 
</span><a name="LN3087"></a>                  <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Declare_Parameter'>partnatts</span><span class='Delimiter'>, 
</span><a name="LN3088"></a>                  <a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>partattrs</span><span class='Delimiter'>, 
</span><a name="LN3089"></a>                  <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>partexprs</span><span class='Delimiter'>, 
</span><a name="LN3090"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>partopclass</span><span class='Delimiter'>, 
</span><a name="LN3091"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>partcollation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3093"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3094"></a>    <a href="../../include/c.h.html#LN466"><span class='Ref_to_Typedef'>int2vector</span></a> <span class='Operator'>*</span><span class='Declare_Local'>partattrs_vec</span><span class='Delimiter'>; 
</span><a name="LN3095"></a>    <a href="../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>partopclass_vec</span><span class='Delimiter'>; 
</span><a name="LN3096"></a>    <a href="../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>partcollation_vec</span><span class='Delimiter'>; 
</span><a name="LN3097"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>partexprDatum</span><span class='Delimiter'>; 
</span><a name="LN3098"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_partitioned_table</span><span class='Delimiter'>; 
</span><a name="LN3099"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN3100"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN64"><span class='Ref_to_Const'>Natts_pg_partitioned_table</span></a><span class='Delimiter'>]; 
</span><a name="LN3101"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN64"><span class='Ref_to_Const'>Natts_pg_partitioned_table</span></a><span class='Delimiter'>]; 
</span><a name="LN3102"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>; 
</span><a name="LN3103"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>referenced</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN3085"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3099"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN74"><span class='Ref_to_EnumConst'>PARTRELID</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3085"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy the partition attribute numbers, opclass OIDs into arrays */ 
</span>    <a href="heap.c.html#LN3094"><span class='Ref_To_Local'>partattrs_vec</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN36"><span class='Ref_to_Proto'>buildint2vector</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3088"><span class='Ref_to_Parameter'>partattrs</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3087"><span class='Ref_to_Parameter'>partnatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3095"><span class='Ref_To_Local'>partopclass_vec</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN67"><span class='Ref_to_Proto'>buildoidvector</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3090"><span class='Ref_to_Parameter'>partopclass</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3087"><span class='Ref_to_Parameter'>partnatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3096"><span class='Ref_To_Local'>partcollation_vec</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN67"><span class='Ref_to_Proto'>buildoidvector</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3091"><span class='Ref_to_Parameter'>partcollation</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3087"><span class='Ref_to_Parameter'>partnatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert the expressions (if any) to a text datum */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3089"><span class='Ref_to_Parameter'>partexprs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3118"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>exprString</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN3118"><span class='Ref_To_Local'>exprString</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3089"><span class='Ref_to_Parameter'>partexprs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN3097"><span class='Ref_To_Local'>partexprDatum</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3118"><span class='Ref_To_Local'>exprString</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3118"><span class='Ref_To_Local'>exprString</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="heap.c.html#LN3097"><span class='Ref_To_Local'>partexprDatum</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3098"><span class='Ref_To_Local'>pg_partitioned_table</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN27"><span class='Ref_to_Const'>PartitionedRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3101"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN3101"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Only this can ever be NULL */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heap.c.html#LN3097"><span class='Ref_To_Local'>partexprDatum</span></a><span class='Parentheses'>) 
</span>        <a href="heap.c.html#LN3101"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partexprs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN65"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partrelid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3085"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN66"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partstrat</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3086"><span class='Ref_to_Parameter'>strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN67"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partnatts</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3087"><span class='Ref_to_Parameter'>partnatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN68"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partattrs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3094"><span class='Ref_To_Local'>partattrs_vec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN69"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partclass</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3095"><span class='Ref_To_Local'>partopclass_vec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partcollation</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3096"><span class='Ref_To_Local'>partcollation_vec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_partitioned_table_partexprs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="heap.c.html#LN3097"><span class='Ref_To_Local'>partexprDatum</span></a><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3099"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3098"><span class='Ref_To_Local'>pg_partitioned_table</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="heap.c.html#LN3100"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3101"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3098"><span class='Ref_To_Local'>pg_partitioned_table</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3099"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3098"><span class='Ref_To_Local'>pg_partitioned_table</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mark this relation as dependent on a few things as follows */ 
</span>    <a href="heap.c.html#LN3102"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3102"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3085"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;; 
</span>    <a href="heap.c.html#LN3102"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Operator class and collation per key column */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="heap.c.html#LN3087"><span class='Ref_to_Parameter'>partnatts</span></a><span class='Delimiter'>; </span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_opclass.h.html#LN48"><span class='Ref_to_Const'>OperatorClassRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN3090"><span class='Ref_to_Parameter'>partopclass</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN3102"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The default collation is pinned, so don't bother recording it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3091"><span class='Ref_to_Parameter'>partcollation</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="heap.c.html#LN3091"><span class='Ref_to_Parameter'>partcollation</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_collation.h.html#LN29"><span class='Ref_to_Const'>CollationRelationId</span></a><span class='Delimiter'>; 
</span>            <a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="heap.c.html#LN3091"><span class='Ref_to_Parameter'>partcollation</span></a><span class='Delimiter'>[</span><a href="heap.c.html#LN3093"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN3102"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN3103"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Anything mentioned in the expressions.  We must ignore the column 
     * references, which will depend on the table itself; there is no separate 
     * partition key object. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="heap.c.html#LN3089"><span class='Ref_to_Parameter'>partexprs</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/catalog/dependency.h.html#LN192"><span class='Ref_to_Proto'>recordDependencyOnSingleRelExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="heap.c.html#LN3102"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, 
</span>                                        <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="heap.c.html#LN3089"><span class='Ref_to_Parameter'>partexprs</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3085"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../include/catalog/dependency.h.html#LN75"><span class='Ref_to_EnumConst'>DEPENDENCY_AUTO</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must invalidate the relcache so that the next 
     * CommandCounterIncrement() will cause the same to be rebuilt using the 
     * information in just created catalog entry. 
     */ 
</span>    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3085"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StorePartitionKey &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  RemovePartitionKeyByRelId 
 *      Remove pg_partitioned_table entry for a relation 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3199"></a><span class='Declare_Function'>RemovePartitionKeyByRelId</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3201"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN3202"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3201"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_partitioned_table.h.html#LN27"><span class='Ref_to_Const'>PartitionedRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="heap.c.html#LN3202"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN74"><span class='Ref_to_EnumConst'>PARTRELID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3199"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3202"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for partition key of relation %u"</span><span class='Delimiter'>, 
</span>             <a href="heap.c.html#LN3199"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3201"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN3202"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3202"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3201"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * StorePartitionBound 
 *      Update pg_class tuple of rel to store the partition bound and set 
 *      relispartition to true 
 * 
 * Also, invalidate the parent's relcache, so that the next rebuild will load 
 * the new partition's info into its partition descriptor. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3226"></a><span class='Declare_Function'>StorePartitionBound</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>parent</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN795"><span class='Ref_to_Struct'>PartitionBoundSpec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bound</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3228"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>classRel</span><span class='Delimiter'>; 
</span><a name="LN3229"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>, 
</span><a name="LN3230"></a>                <span class='Declare_Local'>newtuple</span><span class='Delimiter'>; 
</span><a name="LN3231"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_val</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN101"><span class='Ref_to_Const'>Natts_pg_class</span></a><span class='Delimiter'>]; 
</span><a name="LN3232"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_null</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN101"><span class='Ref_to_Const'>Natts_pg_class</span></a><span class='Delimiter'>], 
</span><a name="LN3233"></a>                <span class='Declare_Local'>new_repl</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN101"><span class='Ref_to_Const'>Natts_pg_class</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Update pg_class tuple */ 
</span>    <a href="heap.c.html#LN3228"><span class='Ref_To_Local'>classRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3229"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3226"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3229"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3226"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
    <span class='Delimiter'>{ 
</span><a name="LN3245"></a>        <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classForm</span><span class='Delimiter'>; 
</span><a name="LN3246"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
        <a href="heap.c.html#LN3245"><span class='Ref_To_Local'>classForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3229"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="heap.c.html#LN3245"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relispartition<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3229"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_class.h.html#LN134"><span class='Ref_to_Const'>Anum_pg_class_relpartbound</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="heap.c.html#LN3246"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="heap.c.html#LN3246"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Fill in relpartbound value */ 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN3231"><span class='Ref_To_Local'>new_val</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN3231"><span class='Ref_To_Local'>new_val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN3232"><span class='Ref_To_Local'>new_null</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN3232"><span class='Ref_To_Local'>new_null</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="heap.c.html#LN3233"><span class='Ref_To_Local'>new_repl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="heap.c.html#LN3233"><span class='Ref_To_Local'>new_repl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3231"><span class='Ref_To_Local'>new_val</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN134"><span class='Ref_to_Const'>Anum_pg_class_relpartbound</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3226"><span class='Ref_to_Parameter'>bound</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3232"><span class='Ref_To_Local'>new_null</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN134"><span class='Ref_to_Const'>Anum_pg_class_relpartbound</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3233"><span class='Ref_To_Local'>new_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_class.h.html#LN134"><span class='Ref_to_Const'>Anum_pg_class_relpartbound</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="heap.c.html#LN3230"><span class='Ref_To_Local'>newtuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3229"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3228"><span class='Ref_To_Local'>classRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="heap.c.html#LN3231"><span class='Ref_To_Local'>new_val</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3232"><span class='Ref_To_Local'>new_null</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3233"><span class='Ref_To_Local'>new_repl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Also set the flag */ 
</span>    <span class='Parentheses'>((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3230"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>relispartition <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3228"><span class='Ref_To_Local'>classRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="heap.c.html#LN3230"><span class='Ref_To_Local'>newtuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="heap.c.html#LN3230"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3230"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3228"><span class='Ref_To_Local'>classRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN3226"><span class='Ref_to_Parameter'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StorePartitionBound &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>