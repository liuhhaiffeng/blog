<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\catalog\pg_shdepend.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\catalog\pg_shdepend.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:33 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pg_shdepend.c 
 *    routines to support manipulation of the pg_shdepend relation 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/catalog/pg_shdepend.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_authid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_collation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_conversion.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_database.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_default_acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_event_trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_extension.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_foreign_data_wrapper.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_foreign_server.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_language.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_largeobject.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_largeobject_metadata.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_operator.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opclass.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opfamily.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_shdepend.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_statistic_ext.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_subscription.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_ts_config.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_ts_dict.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_user_mapping.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/alter.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/collationcmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/conversioncmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/defrem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/event_trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/extension.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/policy.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/proclang.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/publicationcmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/schemacmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/subscriptioncmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/typecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN72"></a>    <span class='Declare_Enum_Const'>LOCAL_OBJECT</span><span class='Delimiter'>, 
</span><a name="LN73"></a>    <span class='Declare_Enum_Const'>SHARED_OBJECT</span><span class='Delimiter'>, 
</span><a name="LN74"></a>    <span class='Declare_Enum_Const'>REMOTE_OBJECT</span> 
<a name="LN75"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>SharedDependencyObjectType</span><span class='Delimiter'>; 
</span> 
<a name="LN77"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>getOidListDiff</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list1</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nlist1</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list2</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nlist2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Declare_Prototype'>classIdGetDbId</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>shdepChangeDep</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Delimiter'>, 
</span><a name="LN80"></a>               <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN81"></a>               <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refclassid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refobjid</span><span class='Delimiter'>, 
</span><a name="LN82"></a>               <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN83"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>shdepAddDependency</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Delimiter'>, 
</span><a name="LN84"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubId</span><span class='Delimiter'>, 
</span><a name="LN85"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refclassId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refobjId</span><span class='Delimiter'>, 
</span><a name="LN86"></a>                   <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>shdepDropDependency</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Delimiter'>, 
</span><a name="LN88"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubId</span><span class='Delimiter'>, 
</span><a name="LN89"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>drop_subobjects</span><span class='Delimiter'>, 
</span><a name="LN90"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refclassId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refobjId</span><span class='Delimiter'>, 
</span><a name="LN91"></a>                    <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN92"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>storeObjectDescription</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>descs</span><span class='Delimiter'>, 
</span><a name="LN93"></a>                       <a href="pg_shdepend.c.html#LN70"><span class='Ref_to_Typedef'>SharedDependencyObjectType</span></a> <span class='Declare_Parameter'>type</span><span class='Delimiter'>, 
</span><a name="LN94"></a>                       <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>object</span><span class='Delimiter'>, 
</span><a name="LN95"></a>                       <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Delimiter'>, 
</span><a name="LN96"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>count</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>isSharedObjectPinned</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * recordSharedDependencyOn 
 * 
 * Record a dependency between 2 objects via their respective ObjectAddresses. 
 * The first argument is the dependent object, the second the one it 
 * references (which must be a shared object). 
 * 
 * This locks the referenced object and makes sure it still exists. 
 * Then it creates an entry in pg_shdepend.  The lock is kept until 
 * the end of the transaction. 
 * 
 * Dependencies on pinned objects are not recorded. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN114"></a><span class='Declare_Function'>recordSharedDependencyOn</span><span class='Parentheses'>(</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>depender</span><span class='Delimiter'>, 
</span><a name="LN115"></a>                         <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>referenced</span><span class='Delimiter'>, 
</span><a name="LN116"></a>                         <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN118"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Objects in pg_shdepend can't have SubIds. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN114"><span class='Ref_to_Parameter'>depender</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN115"><span class='Ref_to_Parameter'>referenced</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * During bootstrap, do nothing since pg_shdepend may not exist yet. 
     * initdb will fill in appropriate pg_shdepend entries after bootstrap. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN118"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the referenced object is pinned, do nothing. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_shdepend.c.html#LN97"><span class='Ref_to_Proto'>isSharedObjectPinned</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN115"><span class='Ref_to_Parameter'>referenced</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN115"><span class='Ref_to_Parameter'>referenced</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a><span class='Delimiter'>, 
</span>                              <a href="pg_shdepend.c.html#LN118"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_shdepend.c.html#LN83"><span class='Ref_to_Proto'>shdepAddDependency</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN118"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN114"><span class='Ref_to_Parameter'>depender</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN114"><span class='Ref_to_Parameter'>depender</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a><span class='Delimiter'>, 
</span>                           <a href="pg_shdepend.c.html#LN114"><span class='Ref_to_Parameter'>depender</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a><span class='Delimiter'>, 
</span>                           <a href="pg_shdepend.c.html#LN115"><span class='Ref_to_Parameter'>referenced</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN115"><span class='Ref_to_Parameter'>referenced</span></a><span class='Operator'>-&GT;</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a><span class='Delimiter'>, 
</span>                           <a href="pg_shdepend.c.html#LN116"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN118"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end recordSharedDependencyOn &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * recordDependencyOnOwner 
 * 
 * A convenient wrapper of recordSharedDependencyOn -- register the specified 
 * user as owner of the given object. 
 * 
 * Note: it's the caller's responsibility to ensure that there isn't an owner 
 * entry for the object already. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN158"></a><span class='Declare_Function'>recordDependencyOnOwner</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN160"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>, 
</span><a name="LN161"></a>                <span class='Declare_Local'>referenced</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN160"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN158"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN160"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN158"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN160"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN161"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN161"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN158"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN161"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN113"><span class='Ref_to_Func'>recordSharedDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN160"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN161"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN115"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_OWNER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * shdepChangeDep 
 * 
 * Update shared dependency records to account for an updated referenced 
 * object.  This is an internal workhorse for operations such as changing 
 * an object's owner. 
 * 
 * There must be no more than one existing entry for the given dependent 
 * object and dependency type!  So in practice this can only be used for 
 * updating SHARED_DEPENDENCY_OWNER entries, which should have that property. 
 * 
 * If there is no previous entry, we assume it was referencing a PINned 
 * object, so we create a new entry.  If the new referenced object is 
 * PINned, we don't create an entry (and drop the old one, if any). 
 * 
 * sdepRel must be the pg_shdepend relation, already opened and suitably 
 * locked. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN193"></a><span class='Declare_Function'>shdepChangeDep</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Delimiter'>, 
</span><a name="LN194"></a>               <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN195"></a>               <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refclassid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refobjid</span><span class='Delimiter'>, 
</span><a name="LN196"></a>               <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN198"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN78"><span class='Ref_to_Proto'>classIdGetDbId</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>classid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN199"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>oldtup</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN200"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>scantup</span><span class='Delimiter'>; 
</span><a name="LN201"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span><a name="LN202"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure the new referenced object doesn't go away while we record the 
     * dependency. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN270"><span class='Ref_to_Proto'>shdepLockAndCheckObject</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refclassid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refobjid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look for a previous entry 
     */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN201"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN198"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN201"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_shdepend_classid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>classid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN201"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN72"><span class='Ref_to_Const'>Anum_pg_shdepend_objid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>objid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN201"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN73"><span class='Ref_to_Const'>Anum_pg_shdepend_objsubid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4EQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN202"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN193"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN228"><span class='Ref_to_Const'>SharedDependDependerIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN201"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_shdepend.c.html#LN200"><span class='Ref_To_Local'>scantup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN202"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Ignore if not of the target dependency type */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN200"><span class='Ref_To_Local'>scantup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>deptype <span class='Operator'>!= </span><a href="pg_shdepend.c.html#LN196"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Caller screwed up if multiple matches */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>) 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>               <span class='String'>"multiple pg_shdepend entries for object %u/%u/%d deptype %c"</span><span class='Delimiter'>, 
</span>                 <a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN196"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN606"><span class='Ref_to_Func'>heap_copytuple</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN200"><span class='Ref_To_Local'>scantup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN202"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN97"><span class='Ref_to_Proto'>isSharedObjectPinned</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refclassid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refobjid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN193"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No new entry needed, so just delete existing entry if any */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN193"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Need to update existing entry */ 
</span><a name="LN257"></a>        <a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a> <span class='Declare_Local'>shForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Since oldtup is a copy, we can just modify it in-memory */ 
</span>        <a href="pg_shdepend.c.html#LN257"><span class='Ref_To_Local'>shForm</span></a><span class='Operator'>-&GT;</span>refclassid <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refclassid</span></a><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN257"><span class='Ref_To_Local'>shForm</span></a><span class='Operator'>-&GT;</span>refobjid <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refobjid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN193"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Need to insert new entry */ 
</span><a name="LN268"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span><a name="LN269"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span> 
        memset<span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN269"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN269"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN198"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_shdepend_classid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>classid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN72"><span class='Ref_to_Const'>Anum_pg_shdepend_objid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>objid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN73"><span class='Ref_to_Const'>Anum_pg_shdepend_objsubid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN194"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_shdepend_refclassid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refclassid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_shdepend_refobjid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN195"><span class='Ref_to_Parameter'>refobjid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN76"><span class='Ref_to_Const'>Anum_pg_shdepend_deptype</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN196"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * we are reusing oldtup just to avoid declaring a new variable, but 
         * it's certainly a new tuple 
         */ 
</span>        <a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN193"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN268"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN269"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN193"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN199"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shdepChangeDep &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * changeDependencyOnOwner 
 * 
 * Update the shared dependencies to account for the new owner. 
 * 
 * Note: we don't need an objsubid argument because only whole objects 
 * have owners. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN303"></a><span class='Declare_Function'>changeDependencyOnOwner</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newOwnerId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN305"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN305"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Adjust the SHARED_DEPENDENCY_OWNER entry */ 
</span>    <a href="pg_shdepend.c.html#LN79"><span class='Ref_to_Proto'>shdepChangeDep</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN305"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, 
</span>                   <a href="pg_shdepend.c.html#LN303"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN303"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                   <a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN303"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Delimiter'>, 
</span>                   <a href="../../include/catalog/dependency.h.html#LN115"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_OWNER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * There should never be a SHARED_DEPENDENCY_ACL entry for the owner, 
     * so get rid of it if there is one.  This can happen if the new owner 
     * was previously granted some rights to the object. 
     * 
     * This step is analogous to aclnewowner's removal of duplicate entries 
     * in the ACL.  We have to do it to handle this scenario: 
     *      A grants some rights on an object to B 
     *      ALTER OWNER changes the object's owner to B 
     *      ALTER OWNER changes the object's owner to C 
     * The third step would remove all mention of B from the object's ACL, 
     * but we'd still have a SHARED_DEPENDENCY_ACL for B if we did not do 
     * things this way. 
     * 
     * The rule against having a SHARED_DEPENDENCY_ACL entry for the owner 
     * allows us to fix things up in just this one place, without having 
     * to make the various ALTER OWNER routines each know about it. 
     *---------- 
     */ 
</span>    <a href="pg_shdepend.c.html#LN87"><span class='Ref_to_Proto'>shdepDropDependency</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN305"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN303"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN303"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                        <a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN303"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/catalog/dependency.h.html#LN116"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_ACL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN305"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end changeDependencyOnOwner &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * getOidListDiff 
 *      Helper for updateAclDependencies. 
 * 
 * Takes two Oid arrays and removes elements that are common to both arrays, 
 * leaving just those that are in one input but not the other. 
 * We assume both arrays have been sorted and de-duped. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN350"></a><span class='Declare_Function'>getOidListDiff</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list1</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nlist1</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list2</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nlist2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN352"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>in1</span><span class='Delimiter'>, 
</span><a name="LN353"></a>                <span class='Declare_Local'>in2</span><span class='Delimiter'>, 
</span><a name="LN354"></a>                <span class='Declare_Local'>out1</span><span class='Delimiter'>, 
</span><a name="LN355"></a>                <span class='Declare_Local'>out2</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN354"><span class='Ref_To_Local'>out1</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN355"><span class='Ref_To_Local'>out2</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a> <span class='Operator'>&LT; *</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>nlist1</span></a> <span class='Operator'>&& </span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a> <span class='Operator'>&LT; *</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>nlist2</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list1</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list2</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* skip over duplicates */ 
</span>            <a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list1</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list2</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* list1[in1] is not in list2 */ 
</span>            <a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list1</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN354"><span class='Ref_To_Local'>out1</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list1</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* list2[in2] is not in list1 */ 
</span>            <a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list2</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN355"><span class='Ref_To_Local'>out2</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list2</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* any remaining list1 entries are not in list2 */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a> <span class='Operator'>&LT; *</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>nlist1</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list1</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN354"><span class='Ref_To_Local'>out1</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list1</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN352"><span class='Ref_To_Local'>in1</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* any remaining list2 entries are not in list1 */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a> <span class='Operator'>&LT; *</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>nlist2</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list2</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN355"><span class='Ref_To_Local'>out2</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>list2</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN353"><span class='Ref_To_Local'>in2</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>nlist1</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN354"><span class='Ref_To_Local'>out1</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="pg_shdepend.c.html#LN350"><span class='Ref_to_Parameter'>nlist2</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN355"><span class='Ref_To_Local'>out2</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end getOidListDiff &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * updateAclDependencies 
 *      Update the pg_shdepend info for an object's ACL during GRANT/REVOKE. 
 * 
 * classId, objectId, objsubId: identify the object whose ACL this is 
 * ownerId: role owning the object 
 * noldmembers, oldmembers: array of roleids appearing in old ACL 
 * nnewmembers, newmembers: array of roleids appearing in new ACL 
 * 
 * We calculate the differences between the new and old lists of roles, 
 * and then insert or delete from pg_shdepend as appropriate. 
 * 
 * Note that we can't just insert all referenced roles blindly during GRANT, 
 * because we would end up with duplicate registered dependencies.  We could 
 * check for existence of the tuples before inserting, but that seems to be 
 * more expensive than what we are doing here.  Likewise we can't just delete 
 * blindly during REVOKE, because the user may still have other privileges. 
 * It is also possible that REVOKE actually adds dependencies, due to 
 * instantiation of a formerly implicit default ACL (although at present, 
 * all such dependencies should be for the owning role, which we ignore here). 
 * 
 * NOTE: Both input arrays must be sorted and de-duped.  (Typically they 
 * are extracted from an ACL array by aclmembers(), which takes care of 
 * both requirements.)  The arrays are pfreed before return. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN420"></a><span class='Declare_Function'>updateAclDependencies</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubId</span><span class='Delimiter'>, 
</span><a name="LN421"></a>                      <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>ownerId</span><span class='Delimiter'>, 
</span><a name="LN422"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>noldmembers</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>oldmembers</span><span class='Delimiter'>, 
</span><a name="LN423"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>nnewmembers</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>newmembers</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN425"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span><a name="LN426"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove entries that are common to both lists; those represent existing 
     * dependencies we don't need to change. 
     * 
     * OK to overwrite the inputs since we'll pfree them anyway. 
     */ 
</span>    <a href="pg_shdepend.c.html#LN77"><span class='Ref_to_Proto'>getOidListDiff</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>oldmembers</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>noldmembers</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>newmembers</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>nnewmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>noldmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>nnewmembers</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_shdepend.c.html#LN425"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Add new dependencies that weren't already present */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>nnewmembers</span></a><span class='Delimiter'>; </span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN443"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>roleid</span> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>newmembers</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Skip the owner: he has an OWNER shdep entry instead. (This is 
             * not just a space optimization; it makes ALTER OWNER easier. See 
             * notes in changeDependencyOnOwner.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN443"><span class='Ref_To_Local'>roleid</span></a> <span class='Operator'>== </span><a href="pg_shdepend.c.html#LN421"><span class='Ref_to_Parameter'>ownerId</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip pinned roles; they don't need dependency entries */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN97"><span class='Ref_to_Proto'>isSharedObjectPinned</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN443"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN425"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="pg_shdepend.c.html#LN83"><span class='Ref_to_Proto'>shdepAddDependency</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN425"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN420"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN420"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN420"><span class='Ref_to_Parameter'>objsubId</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN443"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/dependency.h.html#LN116"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_ACL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nnewmembers;i++ &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Drop no-longer-used old dependencies */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>noldmembers</span></a><span class='Delimiter'>; </span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN465"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>roleid</span> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>oldmembers</span></a><span class='Delimiter'>[</span><a href="pg_shdepend.c.html#LN426"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip the owner, same as above */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN465"><span class='Ref_To_Local'>roleid</span></a> <span class='Operator'>== </span><a href="pg_shdepend.c.html#LN421"><span class='Ref_to_Parameter'>ownerId</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip pinned roles */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN97"><span class='Ref_to_Proto'>isSharedObjectPinned</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN465"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN425"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="pg_shdepend.c.html#LN87"><span class='Ref_to_Proto'>shdepDropDependency</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN425"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN420"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN420"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN420"><span class='Ref_to_Parameter'>objsubId</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* exact match on objsubId */ 
</span>                                <a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN465"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/catalog/dependency.h.html#LN116"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_ACL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN425"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if noldmembers&GT;0||nnewme... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>oldmembers</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN422"><span class='Ref_to_Parameter'>oldmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>newmembers</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN423"><span class='Ref_to_Parameter'>newmembers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end updateAclDependencies &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * A struct to keep track of dependencies found in other databases. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN495"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>dbOid</span><span class='Delimiter'>; 
</span><a name="LN496"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>count</span><span class='Delimiter'>; 
</span><a name="LN497"></a>} <span class='Declare_Typedef'>remoteDep</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * checkSharedDependencies 
 * 
 * Check whether there are shared dependency entries for a given shared 
 * object; return true if so. 
 * 
 * In addition, return a string containing a newline-separated list of object 
 * descriptions that depend on the shared object, or NULL if none is found. 
 * We actually return two such strings; the "detail" result is suitable for 
 * returning to the client as an errdetail() string, and is limited in size. 
 * The "detail_log" string is potentially much longer, and should be emitted 
 * to the server log only. 
 * 
 * We can find three different kinds of dependencies: dependencies on objects 
 * of the current database; dependencies on shared objects; and dependencies 
 * on objects local to other databases.  We can (and do) provide descriptions 
 * of the two former kinds of objects, but we can't do that for "remote" 
 * objects, so we just provide a count of them. 
 * 
 * If we find a SHARED_DEPENDENCY_PIN entry, we can error out early. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN521"></a><span class='Declare_Function'>checkSharedDependencies</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, 
</span><a name="LN522"></a>                        <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>detail_msg</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>detail_log_msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN524"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span><a name="LN525"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN526"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN527"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN528"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numReportedDeps</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN529"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numNotReportedDeps</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN530"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numNotReportedDbs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN531"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>remDeps</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN532"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN533"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>object</span><span class='Delimiter'>; 
</span><a name="LN534"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>descs</span><span class='Delimiter'>; 
</span><a name="LN535"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>alldescs</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We limit the number of dependencies reported to the client to 
     * MAX_REPORTED_DEPS, since client software may not deal well with 
     * enormous error strings.  The server log always gets a full report. 
     */ 
</span><a name="LN542"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_REPORTED_DEPS</span> <span class='Number'>100</span> 
 
    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN535"><span class='Ref_To_Local'>alldescs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN524"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN525"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_shdepend_refclassid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN521"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN525"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_shdepend_refobjid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN521"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN526"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN524"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN230"><span class='Ref_to_Const'>SharedDependReferenceIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN525"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN527"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN526"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN563"></a>        <a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a> <span class='Declare_Local'>sdepForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN527"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* This case can be dispatched quickly */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype <span class='Operator'>== </span><a href="../../include/catalog/dependency.h.html#LN114"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_PIN</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN521"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN521"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DEPENDENT_OBJECTS_STILL_EXIST<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot drop %s because it is required by the database system"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/catalog/objectaddress.h.html#LN70"><span class='Ref_to_Proto'>getObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objsubid<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If it's a dependency local to this database or it's a shared 
         * object, describe it. 
         * 
         * If it's a remote dependency, keep track of it so we can report the 
         * number of them later. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN528"><span class='Ref_To_Local'>numReportedDeps</span></a> <span class='Operator'>&LT; </span><a href="pg_shdepend.c.html#LN542"><span class='Ref_to_Const'>MAX_REPORTED_DEPS</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_shdepend.c.html#LN528"><span class='Ref_To_Local'>numReportedDeps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="pg_shdepend.c.html#LN92"><span class='Ref_to_Proto'>storeObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN72"><span class='Ref_to_EnumConst'>LOCAL_OBJECT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, 
</span>                                       <a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="pg_shdepend.c.html#LN529"><span class='Ref_To_Local'>numNotReportedDeps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN92"><span class='Ref_to_Proto'>storeObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN535"><span class='Ref_To_Local'>alldescs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN72"><span class='Ref_to_EnumConst'>LOCAL_OBJECT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, 
</span>                                   <a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>== </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN528"><span class='Ref_To_Local'>numReportedDeps</span></a> <span class='Operator'>&LT; </span><a href="pg_shdepend.c.html#LN542"><span class='Ref_to_Const'>MAX_REPORTED_DEPS</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_shdepend.c.html#LN528"><span class='Ref_To_Local'>numReportedDeps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="pg_shdepend.c.html#LN92"><span class='Ref_to_Proto'>storeObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN73"><span class='Ref_to_EnumConst'>SHARED_OBJECT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, 
</span>                                       <a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="pg_shdepend.c.html#LN529"><span class='Ref_To_Local'>numNotReportedDeps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN92"><span class='Ref_to_Proto'>storeObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN535"><span class='Ref_To_Local'>alldescs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN73"><span class='Ref_to_EnumConst'>SHARED_OBJECT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, 
</span>                                   <a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* It's not local nor shared, so it must be remote. */ 
</span><a name="LN617"></a>            <a href="pg_shdepend.c.html#LN493"><span class='Ref_to_Typedef'>remoteDep</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>dep</span><span class='Delimiter'>; 
</span><a name="LN618"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>stored</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * XXX this info is kept on a simple List.  Maybe it's not good 
             * for performance, but using a hash table seems needlessly 
             * complex.  The expected number of databases is not high anyway, 
             * I suppose. 
             */ 
</span>            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN532"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN531"><span class='Ref_To_Local'>remDeps</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN532"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN495"><span class='Ref_to_Member'>dbOid</span></a> <span class='Operator'>== </span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid<span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN496"><span class='Ref_to_Member'>count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="pg_shdepend.c.html#LN618"><span class='Ref_To_Local'>stored</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_shdepend.c.html#LN618"><span class='Ref_To_Local'>stored</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN493"><span class='Ref_to_Typedef'>remoteDep</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN493"><span class='Ref_to_Typedef'>remoteDep</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN495"><span class='Ref_to_Member'>dbOid</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN563"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid<span class='Delimiter'>; 
</span>                <a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN496"><span class='Ref_to_Member'>count</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="pg_shdepend.c.html#LN531"><span class='Ref_To_Local'>remDeps</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN531"><span class='Ref_To_Local'>remDeps</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN617"><span class='Ref_To_Local'>dep</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while HeapTupleIsValid(tup=... &raquo; </span> 
 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN526"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN524"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Summarize dependencies in remote databases. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN532"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN531"><span class='Ref_To_Local'>remDeps</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN655"></a>        <a href="pg_shdepend.c.html#LN493"><span class='Ref_to_Typedef'>remoteDep</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>dep</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN532"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN655"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN495"><span class='Ref_to_Member'>dbOid</span></a><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN528"><span class='Ref_To_Local'>numReportedDeps</span></a> <span class='Operator'>&LT; </span><a href="pg_shdepend.c.html#LN542"><span class='Ref_to_Const'>MAX_REPORTED_DEPS</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_shdepend.c.html#LN528"><span class='Ref_To_Local'>numReportedDeps</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN92"><span class='Ref_to_Proto'>storeObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN74"><span class='Ref_to_EnumConst'>REMOTE_OBJECT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/catalog/dependency.h.html#LN118"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_INVALID</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN655"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN496"><span class='Ref_to_Member'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="pg_shdepend.c.html#LN530"><span class='Ref_To_Local'>numNotReportedDbs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN92"><span class='Ref_to_Proto'>storeObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN535"><span class='Ref_To_Local'>alldescs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN74"><span class='Ref_to_EnumConst'>REMOTE_OBJECT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN533"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/dependency.h.html#LN118"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_INVALID</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN655"><span class='Ref_To_Local'>dep</span></a><span class='Operator'>-&GT;</span><a href="pg_shdepend.c.html#LN496"><span class='Ref_to_Member'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN266"><span class='Ref_to_Proto'>list_free_deep</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN531"><span class='Ref_To_Local'>remDeps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN535"><span class='Ref_To_Local'>alldescs</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="pg_shdepend.c.html#LN522"><span class='Ref_to_Parameter'>detail_msg</span></a> <span class='Operator'>= *</span><a href="pg_shdepend.c.html#LN522"><span class='Ref_to_Parameter'>detail_log_msg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN529"><span class='Ref_To_Local'>numNotReportedDeps</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"\nand %d other object "</span> 
                                          <span class='String'>"(see server log for list)"</span><span class='Delimiter'>, 
</span>                                          <span class='String'>"\nand %d other objects "</span> 
                                          <span class='String'>"(see server log for list)"</span><span class='Delimiter'>, 
</span>                                          <a href="pg_shdepend.c.html#LN529"><span class='Ref_To_Local'>numNotReportedDeps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="pg_shdepend.c.html#LN529"><span class='Ref_To_Local'>numNotReportedDeps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN530"><span class='Ref_To_Local'>numNotReportedDbs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"\nand objects in %d other database "</span> 
                                          <span class='String'>"(see server log for list)"</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"\nand objects in %d other databases "</span> 
                                          <span class='String'>"(see server log for list)"</span><span class='Delimiter'>, 
</span>                                          <a href="pg_shdepend.c.html#LN530"><span class='Ref_To_Local'>numNotReportedDbs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="pg_shdepend.c.html#LN530"><span class='Ref_To_Local'>numNotReportedDbs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="pg_shdepend.c.html#LN522"><span class='Ref_to_Parameter'>detail_msg</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN534"><span class='Ref_To_Local'>descs</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="pg_shdepend.c.html#LN522"><span class='Ref_to_Parameter'>detail_log_msg</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN535"><span class='Ref_To_Local'>alldescs</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end checkSharedDependencies &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * copyTemplateDependencies 
 * 
 * Routine to create the initial shared dependencies of a new database. 
 * We simply copy the dependencies from the template database. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN710"></a><span class='Declare_Function'>copyTemplateDependencies</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>templateDbId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newDbId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN712"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span><a name="LN713"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>sdepDesc</span><span class='Delimiter'>; 
</span><a name="LN714"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN715"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN716"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN717"></a>    <a href="../../include/catalog/indexing.h.html#LN25"><span class='Ref_to_Typedef'>CatalogIndexState</span></a> <span class='Declare_Local'>indstate</span><span class='Delimiter'>; 
</span><a name="LN718"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span><a name="LN719"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span><a name="LN720"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replace</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span> 
    <a href="pg_shdepend.c.html#LN712"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN713"><span class='Ref_To_Local'>sdepDesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN712"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN717"><span class='Ref_To_Local'>indstate</span></a> <span class='Operator'>= </span><a href="../../include/catalog/indexing.h.html#LN30"><span class='Ref_to_Proto'>CatalogOpenIndexes</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN712"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan all entries with dbid = templateDbId */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN714"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN710"><span class='Ref_to_Parameter'>templateDbId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN715"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN712"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN228"><span class='Ref_to_Const'>SharedDependDependerIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN714"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up to copy the tuples except for inserting newDbId */ 
</span>    memset<span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN718"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN718"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN719"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN719"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN720"><span class='Ref_To_Local'>replace</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN720"><span class='Ref_To_Local'>replace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN720"><span class='Ref_To_Local'>replace</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN718"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN710"><span class='Ref_to_Parameter'>newDbId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy the entries of the original database, changing the database Id to 
     * that of the new database.  Note that because we are not copying rows 
     * with dbId == 0 (ie, rows describing dependent shared objects) we won't 
     * copy the ownership dependency of the template database itself; this is 
     * what we want. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN716"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN715"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN753"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN753"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN716"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN713"><span class='Ref_To_Local'>sdepDesc</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN718"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN719"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN720"><span class='Ref_To_Local'>replace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN33"><span class='Ref_to_Proto'>CatalogTupleInsertWithInfo</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN712"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN753"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN717"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN753"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN715"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN31"><span class='Ref_to_Proto'>CatalogCloseIndexes</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN717"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN712"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end copyTemplateDependencies &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * dropDatabaseDependencies 
 * 
 * Delete pg_shdepend entries corresponding to a database that's being 
 * dropped. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN774"></a><span class='Declare_Function'>dropDatabaseDependencies</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN776"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span><a name="LN777"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN778"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN779"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN776"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, delete all the entries that have the database Oid in the dbid 
     * field. 
     */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN777"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN774"><span class='Ref_to_Parameter'>databaseId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We leave the other index fields unspecified */ 
</span> 
    <a href="pg_shdepend.c.html#LN778"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN776"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN228"><span class='Ref_to_Const'>SharedDependDependerIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN777"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN779"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN778"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN776"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN779"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN778"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now delete all entries corresponding to the database itself */ 
</span>    <a href="pg_shdepend.c.html#LN87"><span class='Ref_to_Proto'>shdepDropDependency</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN776"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN774"><span class='Ref_to_Parameter'>databaseId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                        <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/catalog/dependency.h.html#LN118"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_INVALID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN776"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dropDatabaseDependencies &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * deleteSharedDependencyRecordsFor 
 * 
 * Delete all pg_shdepend entries corresponding to an object that's being 
 * dropped or modified.  The object is assumed to be either a shared object 
 * or local to the current database (the classId tells us which). 
 * 
 * If objectSubId is zero, we are deleting a whole object, so get rid of 
 * pg_shdepend entries for subobjects as well. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN822"></a><span class='Declare_Function'>deleteSharedDependencyRecordsFor</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objectSubId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN824"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN824"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN87"><span class='Ref_to_Proto'>shdepDropDependency</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN824"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN822"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN822"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN822"><span class='Ref_to_Parameter'>objectSubId</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN822"><span class='Ref_to_Parameter'>objectSubId</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/catalog/dependency.h.html#LN118"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_INVALID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN824"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * shdepAddDependency 
 *      Internal workhorse for inserting into pg_shdepend 
 * 
 * sdepRel must be the pg_shdepend relation, already opened and suitably 
 * locked. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN844"></a><span class='Declare_Function'>shdepAddDependency</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Delimiter'>, 
</span><a name="LN845"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubId</span><span class='Delimiter'>, 
</span><a name="LN846"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refclassId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refobjId</span><span class='Delimiter'>, 
</span><a name="LN847"></a>                   <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN849"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN850"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span><a name="LN851"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN69"><span class='Ref_to_Const'>Natts_pg_shdepend</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure the object doesn't go away while we record the dependency on 
     * it.  DROP routines should lock the object exclusively before they check 
     * shared dependencies. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN270"><span class='Ref_to_Proto'>shdepLockAndCheckObject</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN846"><span class='Ref_to_Parameter'>refclassId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN846"><span class='Ref_to_Parameter'>refobjId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN851"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN851"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Form the new tuple and record the dependency. 
     */ 
</span>    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN78"><span class='Ref_to_Proto'>classIdGetDbId</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN845"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_shdepend_classid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN845"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN72"><span class='Ref_to_Const'>Anum_pg_shdepend_objid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN845"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN73"><span class='Ref_to_Const'>Anum_pg_shdepend_objsubid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN845"><span class='Ref_to_Parameter'>objsubId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_shdepend_refclassid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN846"><span class='Ref_to_Parameter'>refclassId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_shdepend_refobjid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN846"><span class='Ref_to_Parameter'>refobjId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_shdepend.h.html#LN76"><span class='Ref_to_Const'>Anum_pg_shdepend_deptype</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN847"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN849"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN844"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN850"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN851"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN844"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN849"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* clean up */ 
</span>    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN849"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shdepAddDependency &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * shdepDropDependency 
 *      Internal workhorse for deleting entries from pg_shdepend. 
 * 
 * We drop entries having the following properties: 
 *  dependent object is the one identified by classId/objectId/objsubId 
 *  if refclassId isn't InvalidOid, it must match the entry's refclassid 
 *  if refobjId isn't InvalidOid, it must match the entry's refobjid 
 *  if deptype isn't SHARED_DEPENDENCY_INVALID, it must match entry's deptype 
 * 
 * If drop_subobjects is true, we ignore objsubId and consider all entries 
 * matching classId/objectId. 
 * 
 * sdepRel must be the pg_shdepend relation, already opened and suitably 
 * locked. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN899"></a><span class='Declare_Function'>shdepDropDependency</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Delimiter'>, 
</span><a name="LN900"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>objsubId</span><span class='Delimiter'>, 
</span><a name="LN901"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>drop_subobjects</span><span class='Delimiter'>, 
</span><a name="LN902"></a>                    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refclassId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>refobjId</span><span class='Delimiter'>, 
</span><a name="LN903"></a>                    <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN905"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span><a name="LN906"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nkeys</span><span class='Delimiter'>; 
</span><a name="LN907"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN908"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan for entries matching the dependent object */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN905"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_shdepend_dbid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN78"><span class='Ref_to_Proto'>classIdGetDbId</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN900"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN905"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_shdepend_classid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN900"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN905"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN72"><span class='Ref_to_Const'>Anum_pg_shdepend_objid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN900"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN901"><span class='Ref_to_Parameter'>drop_subobjects</span></a><span class='Parentheses'>) 
</span>        <a href="pg_shdepend.c.html#LN906"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>= </span><span class='Number'>3</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN905"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_shdepend.h.html#LN73"><span class='Ref_to_Const'>Anum_pg_shdepend_objsubid</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4EQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN900"><span class='Ref_to_Parameter'>objsubId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_shdepend.c.html#LN906"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>= </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_shdepend.c.html#LN907"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN899"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN228"><span class='Ref_to_Const'>SharedDependDependerIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN906"><span class='Ref_To_Local'>nkeys</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN905"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN908"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN907"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN939"></a>        <a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a> <span class='Declare_Local'>shdepForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN908"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Filter entries according to additional parameters */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN902"><span class='Ref_to_Parameter'>refclassId</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="pg_shdepend.c.html#LN939"><span class='Ref_To_Local'>shdepForm</span></a><span class='Operator'>-&GT;</span>refclassid <span class='Operator'>!= </span><a href="pg_shdepend.c.html#LN902"><span class='Ref_to_Parameter'>refclassId</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN902"><span class='Ref_to_Parameter'>refobjId</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="pg_shdepend.c.html#LN939"><span class='Ref_To_Local'>shdepForm</span></a><span class='Operator'>-&GT;</span>refobjid <span class='Operator'>!= </span><a href="pg_shdepend.c.html#LN902"><span class='Ref_to_Parameter'>refobjId</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN903"><span class='Ref_to_Parameter'>deptype</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/dependency.h.html#LN118"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_INVALID</span></a> <span class='Operator'>&& 
</span>            <a href="pg_shdepend.c.html#LN939"><span class='Ref_To_Local'>shdepForm</span></a><span class='Operator'>-&GT;</span>deptype <span class='Operator'>!= </span><a href="pg_shdepend.c.html#LN903"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* OK, delete it */ 
</span>        <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN899"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN908"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN907"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shdepDropDependency &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * classIdGetDbId 
 * 
 * Get the database Id that should be used in pg_shdepend, given the OID 
 * of the catalog containing the object.  For shared objects, it's 0 
 * (InvalidOid); for all other objects, it's the current database Id. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN965"></a><span class='Declare_Function'>classIdGetDbId</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN967"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbId</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/catalog/catalog.h.html#LN42"><span class='Ref_to_Proto'>IsSharedRelation</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN965"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>))</span> 
        <a href="pg_shdepend.c.html#LN967"><span class='Ref_To_Local'>dbId</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_shdepend.c.html#LN967"><span class='Ref_To_Local'>dbId</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_shdepend.c.html#LN967"><span class='Ref_To_Local'>dbId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * shdepLockAndCheckObject 
 * 
 * Lock the object that we are about to record a dependency on. 
 * After it's locked, verify that it hasn't been dropped while we 
 * weren't looking.  If the object has been dropped, this function 
 * does not return! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN986"></a><span class='Declare_Function'>shdepLockAndCheckObject</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* AccessShareLock should be OK, since we are not modifying the object */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN93"><span class='Ref_to_Proto'>LockSharedObject</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>classId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/syscache.h.html#LN173"><span class='Ref_to_Macro'>SearchSysCacheExists1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN44"><span class='Ref_to_EnumConst'>AUTHOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"role %u was concurrently dropped"</span><span class='Delimiter'>, 
</span>                                <a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Currently, this routine need not support any other shared 
             * object types besides roles.  If we wanted to record explicit 
             * dependencies on databases or tablespaces, we'd need code along 
             * these lines: 
             */ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
        <span class='Control'>case</span> <a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* For lack of a syscache on pg_tablespace, do this: */ 
</span><a name="LN1011"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tablespace</span> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN56"><span class='Ref_to_Proto'>get_tablespace_name</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1011"><span class='Ref_To_Local'>tablespace</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace %u was concurrently dropped"</span><span class='Delimiter'>, 
</span>                                    <a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1011"><span class='Ref_To_Local'>tablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>case</span> <a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* For lack of a syscache on pg_database, do this: */ 
</span><a name="LN1026"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>database</span> <span class='Operator'>= </span><a href="../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1026"><span class='Ref_To_Local'>database</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database %u was concurrently dropped"</span><span class='Delimiter'>, 
</span>                                    <a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1026"><span class='Ref_To_Local'>database</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized shared classId: %u"</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN986"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch classId &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end shdepLockAndCheckObject &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * storeObjectDescription 
 *      Append the description of a dependent object to "descs" 
 * 
 * While searching for dependencies of a shared object, we stash the 
 * descriptions of dependent objects we find in a single string, which we 
 * later pass to ereport() in the DETAIL field when somebody attempts to 
 * drop a referenced shared object. 
 * 
 * When type is LOCAL_OBJECT or SHARED_OBJECT, we expect object to be the 
 * dependent object, deptype is the dependency type, and count is not used. 
 * When type is REMOTE_OBJECT, we expect object to be the database object, 
 * and count to be nonzero; deptype is not used in this case. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1059"></a><span class='Declare_Function'>storeObjectDescription</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>descs</span><span class='Delimiter'>, 
</span><a name="LN1060"></a>                       <a href="pg_shdepend.c.html#LN70"><span class='Ref_to_Typedef'>SharedDependencyObjectType</span></a> <span class='Declare_Parameter'>type</span><span class='Delimiter'>, 
</span><a name="LN1061"></a>                       <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>object</span><span class='Delimiter'>, 
</span><a name="LN1062"></a>                       <a href="../../include/catalog/dependency.h.html#LN112"><span class='Ref_to_Enum'>SharedDependencyType</span></a> <span class='Declare_Parameter'>deptype</span><span class='Delimiter'>, 
</span><a name="LN1063"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>count</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1065"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>objdesc</span> <span class='Operator'>= </span><a href="../../include/catalog/objectaddress.h.html#LN70"><span class='Ref_to_Proto'>getObjectDescription</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1061"><span class='Ref_to_Parameter'>object</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* separate entries with a newline */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1059"><span class='Ref_to_Parameter'>descs</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1059"><span class='Ref_to_Parameter'>descs</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1060"><span class='Ref_to_Parameter'>type</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="pg_shdepend.c.html#LN72"><span class='Ref_to_EnumConst'>LOCAL_OBJECT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="pg_shdepend.c.html#LN73"><span class='Ref_to_EnumConst'>SHARED_OBJECT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1062"><span class='Ref_to_Parameter'>deptype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/dependency.h.html#LN115"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_OWNER</span></a><span class='Parentheses'>) 
</span>                <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1059"><span class='Ref_to_Parameter'>descs</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"owner of %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1065"><span class='Ref_To_Local'>objdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1062"><span class='Ref_to_Parameter'>deptype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/dependency.h.html#LN116"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_ACL</span></a><span class='Parentheses'>) 
</span>                <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1059"><span class='Ref_to_Parameter'>descs</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"privileges for %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1065"><span class='Ref_To_Local'>objdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1062"><span class='Ref_to_Parameter'>deptype</span></a> <span class='Operator'>== </span><a href="../../include/catalog/dependency.h.html#LN117"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_POLICY</span></a><span class='Parentheses'>) 
</span>                <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1059"><span class='Ref_to_Parameter'>descs</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"target of %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1065"><span class='Ref_To_Local'>objdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized dependency type: %d"</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pg_shdepend.c.html#LN1062"><span class='Ref_to_Parameter'>deptype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="pg_shdepend.c.html#LN74"><span class='Ref_to_EnumConst'>REMOTE_OBJECT</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* translator: %s will always be "database %s" */ 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1059"><span class='Ref_to_Parameter'>descs</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"%d object in %s"</span><span class='Delimiter'>, 
</span>                                             <span class='String'>"%d objects in %s"</span><span class='Delimiter'>, 
</span>                                             <a href="pg_shdepend.c.html#LN1063"><span class='Ref_to_Parameter'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="pg_shdepend.c.html#LN1063"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1065"><span class='Ref_To_Local'>objdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized object type: %d"</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1060"><span class='Ref_to_Parameter'>type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1065"><span class='Ref_To_Local'>objdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end storeObjectDescription &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * isSharedObjectPinned 
 *      Return whether a given shared object has a SHARED_DEPENDENCY_PIN entry. 
 * 
 * sdepRel must be the pg_shdepend relation, already opened and suitably 
 * locked. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1110"></a><span class='Declare_Function'>isSharedObjectPinned</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objectId</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>sdepRel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1112"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1113"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1114"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1115"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1113"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_shdepend_refclassid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1110"><span class='Ref_to_Parameter'>classId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1113"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_shdepend.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_shdepend_refobjid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1110"><span class='Ref_to_Parameter'>objectId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN1114"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1110"><span class='Ref_to_Parameter'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN230"><span class='Ref_to_Const'>SharedDependReferenceIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1113"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we won't generate additional pg_shdepend entries for pinned 
     * objects, there can be at most one entry referencing a pinned object. 
     * Hence, it's sufficient to look at the first returned tuple; we don't 
     * need to loop. 
     */ 
</span>    <a href="pg_shdepend.c.html#LN1115"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1114"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1115"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1138"></a>        <a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a> <span class='Declare_Local'>shdepForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1115"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1138"><span class='Ref_To_Local'>shdepForm</span></a><span class='Operator'>-&GT;</span>deptype <span class='Operator'>== </span><a href="../../include/catalog/dependency.h.html#LN114"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_PIN</span></a><span class='Parentheses'>) 
</span>            <a href="pg_shdepend.c.html#LN1112"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1114"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_shdepend.c.html#LN1112"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end isSharedObjectPinned &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * shdepDropOwned 
 * 
 * Drop the objects owned by any one of the given RoleIds.  If a role has 
 * access to an object, the grant will be removed as well (but the object 
 * will not, of course). 
 * 
 * We can revoke grants immediately while doing the scan, but drops are 
 * saved up and done all at once with performMultipleDeletions.  This 
 * is necessary so that we don't get failures from trying to delete 
 * interdependent objects in the wrong order. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1162"></a><span class='Declare_Function'>shdepDropOwned</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>roleids</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN1652"><span class='Ref_to_Enum'>DropBehavior</span></a> <span class='Declare_Parameter'>behavior</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1164"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span><a name="LN1165"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN1166"></a>    <a href="dependency.c.html#LN108"><span class='Ref_to_Struct'>ObjectAddresses</span></a> <span class='Operator'>*</span><span class='Declare_Local'>deleteobjs</span><span class='Delimiter'>; 
</span> 
    <a href="pg_shdepend.c.html#LN1166"><span class='Ref_To_Local'>deleteobjs</span></a> <span class='Operator'>= </span><a href="../../include/catalog/dependency.h.html#LN200"><span class='Ref_to_Proto'>new_object_addresses</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't need this strong a lock here, but we'll call routines that 
     * acquire RowExclusiveLock.  Better get that right now to avoid potential 
     * deadlock failures. 
     */ 
</span>    <a href="pg_shdepend.c.html#LN1164"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For each role, find the dependent objects and drop them using the 
     * regular (non-shared) dependency management. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1165"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1162"><span class='Ref_to_Parameter'>roleids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1183"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>roleid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1165"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1184"></a>        <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1185"></a>        <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1186"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Doesn't work for pinned objects */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN97"><span class='Ref_to_Proto'>isSharedObjectPinned</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1183"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1164"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1191"></a>            <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>obj</span><span class='Delimiter'>; 
</span> 
            <a href="pg_shdepend.c.html#LN1191"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN1191"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1183"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN1191"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DEPENDENT_OBJECTS_STILL_EXIST<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot drop objects owned by %s because they are "</span> 
                          <span class='String'>"required by the database system"</span><span class='Delimiter'>, 
</span>                          <a href="../../include/catalog/objectaddress.h.html#LN70"><span class='Ref_to_Proto'>getObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1191"><span class='Ref_To_Local'>obj</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1184"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_shdepend.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_shdepend_refclassid</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1184"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_shdepend.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_shdepend_refobjid</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1183"><span class='Ref_To_Local'>roleid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN1185"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1164"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN230"><span class='Ref_to_Const'>SharedDependReferenceIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1184"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_shdepend.c.html#LN1186"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1185"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1218"></a>            <a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a> <span class='Declare_Local'>sdepForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1186"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1219"></a>            <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>obj</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We only operate on shared objects and objects in the current 
             * database 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>!= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>&& 
</span>                <a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Shouldn't happen */ 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/dependency.h.html#LN114"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_PIN</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/dependency.h.html#LN118"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_INVALID</span></a><span class='Operator'>: 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected dependency type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/dependency.h.html#LN116"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_ACL</span></a><span class='Operator'>: 
</span>                    <a href="../../include/utils/acl.h.html#LN253"><span class='Ref_to_Proto'>RemoveRoleFromObjectACL</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1183"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, 
</span>                                            <a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Delimiter'>, 
</span>                                            <a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/dependency.h.html#LN117"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_POLICY</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* If unable to remove role from policy, remove policy. */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/commands/policy.h.html#LN25"><span class='Ref_to_Proto'>RemoveRoleFromObjectPolicy</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1183"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, 
</span>                                                    <a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Delimiter'>, 
</span>                                                    <a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Delimiter'>; 
</span>                        <a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>; 
</span>                        <a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objsubid<span class='Delimiter'>; 
</span>                        <a href="../../include/catalog/dependency.h.html#LN202"><span class='Ref_to_Proto'>add_exact_object_address</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1166"><span class='Ref_To_Local'>deleteobjs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/dependency.h.html#LN115"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_OWNER</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* If a local object, save it for deletion below */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Delimiter'>; 
</span>                        <a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>; 
</span>                        <a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1218"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objsubid<span class='Delimiter'>; 
</span>                        <a href="../../include/catalog/dependency.h.html#LN202"><span class='Ref_to_Proto'>add_exact_object_address</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1219"><span class='Ref_To_Local'>obj</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1166"><span class='Ref_To_Local'>deleteobjs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch sdepForm-&GT;deptype &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=systable_getne... &raquo; </span> 
 
        <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1185"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* the dependency mechanism does the actual work */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN185"><span class='Ref_to_Proto'>performMultipleDeletions</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1166"><span class='Ref_To_Local'>deleteobjs</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1162"><span class='Ref_to_Parameter'>behavior</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1164"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/dependency.h.html#LN212"><span class='Ref_to_Proto'>free_object_addresses</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1166"><span class='Ref_To_Local'>deleteobjs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shdepDropOwned &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * shdepReassignOwned 
 * 
 * Change the owner of objects owned by any of the roles in roleids to 
 * newrole.  Grants are not touched. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1284"></a><span class='Declare_Function'>shdepReassignOwned</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>roleids</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newrole</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1286"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>sdepRel</span><span class='Delimiter'>; 
</span><a name="LN1287"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't need this strong a lock here, but we'll call routines that 
     * acquire RowExclusiveLock.  Better get that right now to avoid potential 
     * deadlock problems. 
     */ 
</span>    <a href="pg_shdepend.c.html#LN1286"><span class='Ref_To_Local'>sdepRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN28"><span class='Ref_to_Const'>SharedDependRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1287"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>roleids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1298"></a>        <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1299"></a>        <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1300"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1301"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>roleid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1287"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Refuse to work on pinned roles */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN97"><span class='Ref_to_Proto'>isSharedObjectPinned</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1301"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1286"><span class='Ref_To_Local'>sdepRel</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1306"></a>            <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>obj</span><span class='Delimiter'>; 
</span> 
            <a href="pg_shdepend.c.html#LN1306"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN1306"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1301"><span class='Ref_To_Local'>roleid</span></a><span class='Delimiter'>; 
</span>            <a href="pg_shdepend.c.html#LN1306"><span class='Ref_To_Local'>obj</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DEPENDENT_OBJECTS_STILL_EXIST<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot reassign ownership of objects owned by %s because they are required by the database system"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/catalog/objectaddress.h.html#LN70"><span class='Ref_to_Proto'>getObjectDescription</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1306"><span class='Ref_To_Local'>obj</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * There's no need to tell the whole truth, which is that we 
             * didn't track these dependencies at all ... 
             */ 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1299"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_shdepend.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_shdepend_refclassid</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_shdepend.c.html#LN1299"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_shdepend.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_shdepend_refobjid</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1301"><span class='Ref_To_Local'>roleid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="pg_shdepend.c.html#LN1298"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1286"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN230"><span class='Ref_to_Const'>SharedDependReferenceIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1299"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_shdepend.c.html#LN1300"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1298"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1337"></a>            <a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a> <span class='Declare_Local'>sdepForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_shdepend.h.html#LN63"><span class='Ref_to_Typedef'>Form_pg_shdepend</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1300"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We only operate on shared objects and objects in the current 
             * database 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>!= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>&& 
</span>                <a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>dbid <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Unexpected because we checked for pins above */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype <span class='Operator'>== </span><a href="../../include/catalog/dependency.h.html#LN114"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_PIN</span></a><span class='Parentheses'>) 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected shared pin"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* We leave non-owner dependencies alone */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>deptype <span class='Operator'>!= </span><a href="../../include/catalog/dependency.h.html#LN115"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_OWNER</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Issue the appropriate ALTER OWNER call */ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_type.h.html#LN33"><span class='Ref_to_Const'>TypeRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/typecmds.h.html#LN45"><span class='Ref_to_Proto'>AlterTypeOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_namespace.h.html#LN33"><span class='Ref_to_Const'>NamespaceRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/schemacmds.h.html#LN28"><span class='Ref_to_Proto'>AlterSchemaOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Pass recursing = true so that we don't fail on indexes, 
                     * owned sequences, etc when we happen to visit them 
                     * before their parent table. 
                     */ 
</span>                    <a href="../../include/commands/tablecmds.h.html#LN35"><span class='Ref_to_Proto'>ATExecChangeOwner</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_default_acl.h.html#LN27"><span class='Ref_to_Const'>DefaultAclRelationId</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Ignore default ACLs; they should be handled by DROP 
                     * OWNED, not REASSIGN OWNED. 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_user_mapping.h.html#LN26"><span class='Ref_to_Const'>UserMappingRelationId</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* ditto */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_foreign_server.h.html#LN26"><span class='Ref_to_Const'>ForeignServerRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/defrem.h.html#LN127"><span class='Ref_to_Proto'>AlterForeignServerOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_foreign_data_wrapper.h.html#LN28"><span class='Ref_to_Const'>ForeignDataWrapperRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/defrem.h.html#LN129"><span class='Ref_to_Proto'>AlterForeignDataWrapperOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_event_trigger.h.html#LN28"><span class='Ref_to_Const'>EventTriggerRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/event_trigger.h.html#LN48"><span class='Ref_to_Proto'>AlterEventTriggerOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_publication.h.html#LN28"><span class='Ref_to_Const'>PublicationRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/publicationcmds.h.html#LN26"><span class='Ref_to_Proto'>AlterPublicationOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/catalog/pg_subscription.h.html#LN21"><span class='Ref_to_Const'>SubscriptionRelationId</span></a><span class='Operator'>: 
</span>                    <a href="../../include/commands/subscriptioncmds.h.html#LN26"><span class='Ref_to_Proto'>AlterSubscriptionOwner_oid</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Generic alter owner cases */ 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_collation.h.html#LN29"><span class='Ref_to_Const'>CollationRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_conversion.h.html#LN37"><span class='Ref_to_Const'>ConversionRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_operator.h.html#LN31"><span class='Ref_to_Const'>OperatorRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_proc.h.html#LN32"><span class='Ref_to_Const'>ProcedureRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_language.h.html#LN28"><span class='Ref_to_Const'>LanguageRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_largeobject.h.html#LN28"><span class='Ref_to_Const'>LargeObjectRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_opfamily.h.html#LN28"><span class='Ref_to_Const'>OperatorFamilyRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_opclass.h.html#LN48"><span class='Ref_to_Const'>OperatorClassRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_extension.h.html#LN28"><span class='Ref_to_Const'>ExtensionRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_statistic_ext.h.html#LN28"><span class='Ref_to_Const'>StatisticExtRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_ts_config.h.html#LN30"><span class='Ref_to_Const'>TSConfigRelationId</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../include/catalog/pg_ts_dict.h.html#LN30"><span class='Ref_to_Const'>TSDictionaryRelationId</span></a><span class='Operator'>: 
</span>                    <span class='Delimiter'>{ 
</span><a name="LN1424"></a>                        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>classId</span> <span class='Operator'>= </span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Delimiter'>; 
</span><a name="LN1425"></a>                        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>catalog</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1424"><span class='Ref_To_Local'>classId</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_largeobject.h.html#LN28"><span class='Ref_to_Const'>LargeObjectRelationId</span></a><span class='Parentheses'>) 
</span>                            <a href="pg_shdepend.c.html#LN1424"><span class='Ref_To_Local'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_largeobject_metadata.h.html#LN28"><span class='Ref_to_Const'>LargeObjectMetadataRelationId</span></a><span class='Delimiter'>; 
</span> 
                        <a href="pg_shdepend.c.html#LN1425"><span class='Ref_To_Local'>catalog</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1424"><span class='Ref_To_Local'>classId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="../../include/commands/alter.h.html#LN31"><span class='Ref_to_Proto'>AlterObjectOwner_internal</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1425"><span class='Ref_To_Local'>catalog</span></a><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>objid<span class='Delimiter'>, 
</span>                                                  <a href="pg_shdepend.c.html#LN1284"><span class='Ref_to_Parameter'>newrole</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1425"><span class='Ref_To_Local'>catalog</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected classid %u"</span><span class='Delimiter'>, </span><a href="pg_shdepend.c.html#LN1337"><span class='Ref_To_Local'>sdepForm</span></a><span class='Operator'>-&GT;</span>classid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch sdepForm-&GT;classid &raquo; </span> 
            <span class='Comment_Multi_Line'>/* Make sure the next iteration will see my changes */ 
</span>            <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=systable_getne... &raquo; </span> 
 
        <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1298"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pg_shdepend.c.html#LN1286"><span class='Ref_To_Local'>sdepRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shdepReassignOwned &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>