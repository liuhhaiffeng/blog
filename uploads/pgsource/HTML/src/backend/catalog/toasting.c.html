<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\catalog\toasting.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\catalog\toasting.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:33 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * toasting.c 
 *    This file contains routines to support creation of toast tables 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/catalog/toasting.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/tuptoaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/binary_upgrade.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/heap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_am.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opclass.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/toasting.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/makefuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lock.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
<span class='Comment_Multi_Line'>/* Potentially set by pg_upgrade_support functions */ 
</span><a name="LN36"></a><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Var'>binary_upgrade_next_toast_pg_type_oid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
<a name="LN38"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CheckAndCreateToastTable</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relOid</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, 
</span><a name="LN39"></a>                         <a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>check</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN40"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>create_toast_table</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastIndexOid</span><span class='Delimiter'>, 
</span><a name="LN41"></a>                   <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>check</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN42"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>needs_toast_table</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CreateToastTable variants 
 *      If the table needs a toast table, and doesn't already have one, 
 *      then create a toast table for it. 
 * 
 * reloptions for the toast table can be passed, too.  Pass (Datum) 0 
 * for default reloptions. 
 * 
 * We expect the caller to have verified that the relation is a table and have 
 * already done any necessary permission checks.  Callers expect this function 
 * to end with CommandCounterIncrement if it makes any changes. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN58"></a><span class='Declare_Function'>AlterTableCreateToastTable</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relOid</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="toasting.c.html#LN38"><span class='Ref_to_Proto'>CheckAndCreateToastTable</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN58"><span class='Ref_to_Parameter'>relOid</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN58"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN58"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN64"></a><span class='Declare_Function'>NewHeapCreateToastTable</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relOid</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="toasting.c.html#LN38"><span class='Ref_to_Proto'>CheckAndCreateToastTable</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN64"><span class='Ref_to_Parameter'>relOid</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN64"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN64"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN70"></a><span class='Declare_Function'>NewRelationCreateToastTable</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relOid</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="toasting.c.html#LN38"><span class='Ref_to_Proto'>CheckAndCreateToastTable</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN70"><span class='Ref_to_Parameter'>relOid</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN70"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN76"></a><span class='Declare_Function'>CheckAndCreateToastTable</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relOid</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>check</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN78"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN78"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN76"><span class='Ref_to_Parameter'>relOid</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN76"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create_toast_table does all the work */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="toasting.c.html#LN40"><span class='Ref_to_Proto'>create_toast_table</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN78"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN76"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN76"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN76"><span class='Ref_to_Parameter'>check</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN78"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a toast table during bootstrap 
 * 
 * Here we need to prespecify the OIDs of the toast table and its index 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN94"></a><span class='Declare_Function'>BootstrapToastTable</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relName</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastIndexOid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN96"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN96"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN92"><span class='Ref_to_Proto'>heap_openrv</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/makefuncs.h.html#LN68"><span class='Ref_to_Proto'>makeRangeVar</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="toasting.c.html#LN94"><span class='Ref_to_Parameter'>relName</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN96"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="toasting.c.html#LN96"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table or materialized view"</span><span class='Delimiter'>, 
</span>                        <a href="toasting.c.html#LN94"><span class='Ref_to_Parameter'>relName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create_toast_table does all the work */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="toasting.c.html#LN40"><span class='Ref_to_Proto'>create_toast_table</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN96"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN94"><span class='Ref_to_Parameter'>toastOid</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN94"><span class='Ref_to_Parameter'>toastIndexOid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                            <a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"\"%s\" does not require a toast table"</span><span class='Delimiter'>, 
</span>             <a href="toasting.c.html#LN94"><span class='Ref_to_Parameter'>relName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN96"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BootstrapToastTable &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * create_toast_table --- internal workhorse 
 * 
 * rel is already opened and locked 
 * toastOid and toastIndexOid are normally InvalidOid, but during 
 * bootstrap they can be nonzero to specify hand-assigned OIDs 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN125"></a><span class='Declare_Function'>create_toast_table</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>toastIndexOid</span><span class='Delimiter'>, 
</span><a name="LN126"></a>                   <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>reloptions</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>check</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN128"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relOid</span> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN129"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>reltup</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN131"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>shared_relation</span><span class='Delimiter'>; 
</span><a name="LN132"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>mapped_relation</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toast_rel</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>class_rel</span><span class='Delimiter'>; 
</span><a name="LN135"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>toast_relid</span><span class='Delimiter'>; 
</span><a name="LN136"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>toast_typid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN137"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>namespaceid</span><span class='Delimiter'>; 
</span><a name="LN138"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>toast_relname</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span><a name="LN139"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>toast_idxname</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span><a name="LN140"></a>    <a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indexInfo</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>collationObjectId</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN142"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>classObjectId</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN143"></a>    <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>coloptions</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN144"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>baseobject</span><span class='Delimiter'>, 
</span><a name="LN145"></a>                <span class='Declare_Local'>toastobject</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Toast table is shared if and only if its parent is. 
     * 
     * We cannot allow toasting a shared relation after initdb (because 
     * there's no way to mark it toasted in other databases' pg_class). 
     */ 
</span>    <a href="toasting.c.html#LN131"><span class='Ref_To_Local'>shared_relation</span></a> <span class='Operator'>= </span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN131"><span class='Ref_To_Local'>shared_relation</span></a> <span class='Operator'>&& !</span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"shared tables cannot be toasted after initdb"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* It's mapped if and only if its parent is, too */ 
</span>    <a href="toasting.c.html#LN132"><span class='Ref_To_Local'>mapped_relation</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN453"><span class='Ref_to_Macro'>RelationIsMapped</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Is it already toasted? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to see whether the table actually needs a TOAST table. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Normal mode, normal check */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="toasting.c.html#LN42"><span class='Ref_to_Proto'>needs_toast_table</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * In binary-upgrade mode, create a TOAST table if and only if 
         * pg_upgrade told us to (ie, a TOAST table OID has been provided). 
         * 
         * This indicates that the old cluster had a TOAST table for the 
         * current table.  We must create a TOAST table to receive the old 
         * TOAST file, even if the table seems not to need one. 
         * 
         * Contrariwise, if the old cluster did not have a TOAST table, we 
         * should be able to get along without one even if the new version's 
         * needs_toast_table rules suggest we should have one.  There is a lot 
         * of daylight between where we will create a TOAST table and where 
         * one is really necessary to avoid failures, so small cross-version 
         * differences in the when-to-create heuristic shouldn't be a problem. 
         * If we tried to create a TOAST table anyway, we would have the 
         * problem that it might take up an OID that will conflict with some 
         * old-cluster table we haven't seen yet. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="heap.c.html#LN86"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_class_oid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN36"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_type_oid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If requested check lockmode is sufficient. This is a cross check in 
     * case of errors or conflicting decisions in earlier code. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN126"><span class='Ref_to_Parameter'>check</span></a> <span class='Operator'>&& </span><a href="toasting.c.html#LN126"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"AccessExclusiveLock required to add toast table."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the toast table and its index 
     */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN138"><span class='Ref_To_Local'>toast_relname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="toasting.c.html#LN138"><span class='Ref_To_Local'>toast_relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <span class='String'>"pg_toast_%u"</span><span class='Delimiter'>, </span><a href="toasting.c.html#LN128"><span class='Ref_To_Local'>relOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN139"><span class='Ref_To_Local'>toast_idxname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="toasting.c.html#LN139"><span class='Ref_To_Local'>toast_idxname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <span class='String'>"pg_toast_%u_index"</span><span class='Delimiter'>, </span><a href="toasting.c.html#LN128"><span class='Ref_To_Local'>relOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* this is pretty painful...  need a tuple descriptor */ 
</span>    <a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                       <span class='String'>"chunk_id"</span><span class='Delimiter'>, 
</span>                       <a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                       <span class='String'>"chunk_seq"</span><span class='Delimiter'>, 
</span>                       <a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>                       <span class='String'>"chunk_data"</span><span class='Delimiter'>, 
</span>                       <a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN18"><span class='Ref_to_Const'>BYTEAOID</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that the toast table doesn't itself get toasted, or we'll be 
     * toast :-(.  This is essential for chunk_data because type bytea is 
     * toastable; hit the other two just to be sure. 
     */ 
</span>    <a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Toast tables for regular relations go in pg_toast; those for temp 
     * relations go into the per-backend temp-toast-table namespace. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/catalog/namespace.h.html#LN125"><span class='Ref_to_Proto'>isTempOrTempToastNamespace</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>))</span> 
        <a href="toasting.c.html#LN137"><span class='Ref_To_Local'>namespaceid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN129"><span class='Ref_to_Proto'>GetTempToastNamespace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="toasting.c.html#LN137"><span class='Ref_To_Local'>namespaceid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_namespace.h.html#LN73"><span class='Ref_to_Const'>PG_TOAST_NAMESPACE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use binary-upgrade override for pg_type.oid, if supplied.  We might be 
     * in the post-schema-restore phase where we are doing ALTER TABLE to 
     * create TOAST tables that didn't exist in the old cluster. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>&& </span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN36"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_type_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="toasting.c.html#LN136"><span class='Ref_To_Local'>toast_typid</span></a> <span class='Operator'>= </span><a href="toasting.c.html#LN36"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_type_oid</span></a><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN36"><span class='Ref_to_Global_Var'>binary_upgrade_next_toast_pg_type_oid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="toasting.c.html#LN135"><span class='Ref_To_Local'>toast_relid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/heap.h.html#LN53"><span class='Ref_to_Proto'>heap_create_with_catalog</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN138"><span class='Ref_To_Local'>toast_relname</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN137"><span class='Ref_To_Local'>namespaceid</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltablespace<span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>toastOid</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN136"><span class='Ref_To_Local'>toast_typid</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relowner<span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN130"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence<span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN131"><span class='Ref_To_Local'>shared_relation</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN132"><span class='Ref_To_Local'>mapped_relation</span></a><span class='Delimiter'>, 
</span>                                           <span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                           <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                           <a href="../../include/nodes/primnodes.h.html#LN48"><span class='Ref_to_EnumConst'>ONCOMMIT_NOOP</span></a><span class='Delimiter'>, 
</span>                                           <a href="toasting.c.html#LN126"><span class='Ref_to_Parameter'>reloptions</span></a><span class='Delimiter'>, 
</span>                                           <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                           <span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                           <span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                           <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="toasting.c.html#LN135"><span class='Ref_To_Local'>toast_relid</span></a> <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* make the toast relation visible, else heap_open will fail */ 
</span>    <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ShareLock is not really needed here, but take it anyway */ 
</span>    <a href="toasting.c.html#LN133"><span class='Ref_To_Local'>toast_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN135"><span class='Ref_To_Local'>toast_relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create unique index on chunk_id, chunk_seq. 
     * 
     * NOTE: the normal TOAST access routines could actually function with a 
     * single-column index on chunk_id only. However, the slice access 
     * routines use both columns for faster access to an individual chunk. In 
     * addition, we want it to be unique as a check against the possibility of 
     * duplicate TOAST chunk OIDs. The index might also be a little more 
     * efficient this way, since btree isn't all that happy with large numbers 
     * of equal keys. 
     */ 
</span> 
    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN133"><span class='Ref_to_Member'>ii_NumIndexAttrs</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN134"><span class='Ref_to_Member'>ii_KeyAttrNumbers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN134"><span class='Ref_to_Member'>ii_KeyAttrNumbers</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN136"><span class='Ref_to_Member'>ii_ExpressionsState</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN137"><span class='Ref_to_Member'>ii_Predicate</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN138"><span class='Ref_to_Member'>ii_PredicateState</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN140"><span class='Ref_to_Member'>ii_ExclusionProcs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN141"><span class='Ref_to_Member'>ii_ExclusionStrats</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN145"><span class='Ref_to_Member'>ii_Unique</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN146"><span class='Ref_to_Member'>ii_ReadyForInserts</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN147"><span class='Ref_to_Member'>ii_Concurrent</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN148"><span class='Ref_to_Member'>ii_BrokenHotChain</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN150"><span class='Ref_to_Member'>ii_Context</span></a> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN141"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN141"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN142"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/catalog/pg_opclass.h.html#LN144"><span class='Ref_to_Const'>OID_BTREE_OPS_OID</span></a><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN142"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/catalog/pg_opclass.h.html#LN120"><span class='Ref_to_Const'>INT4_BTREE_OPS_OID</span></a><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN143"><span class='Ref_To_Local'>coloptions</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN143"><span class='Ref_To_Local'>coloptions</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/index.h.html#LN44"><span class='Ref_to_Proto'>index_create</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN133"><span class='Ref_To_Local'>toast_rel</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN139"><span class='Ref_To_Local'>toast_idxname</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>toastIndexOid</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                 <a href="toasting.c.html#LN140"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, 
</span>                 <a href="../../include/nodes/pg_list.h.html#LN139"><span class='Ref_to_Macro'>list_make2</span></a><span class='Parentheses'>(</span><span class='String'>"chunk_id"</span><span class='Delimiter'>, </span><span class='String'>"chunk_seq"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../include/catalog/pg_am.h.html#LN69"><span class='Ref_to_Const'>BTREE_AM_OID</span></a><span class='Delimiter'>, 
</span>                 <a href="toasting.c.html#LN125"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltablespace<span class='Delimiter'>, 
</span>                 <a href="toasting.c.html#LN141"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN142"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN143"><span class='Ref_To_Local'>coloptions</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                 <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                 <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN133"><span class='Ref_To_Local'>toast_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store the toast table's OID in the parent relation's pg_class row 
     */ 
</span>    <a href="toasting.c.html#LN134"><span class='Ref_To_Local'>class_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN128"><span class='Ref_To_Local'>relOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, </span><a href="toasting.c.html#LN128"><span class='Ref_To_Local'>relOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>reltoastrelid <span class='Operator'>= </span><a href="toasting.c.html#LN135"><span class='Ref_To_Local'>toast_relid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* normal case, use a transactional update */ 
</span>        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN134"><span class='Ref_To_Local'>class_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* While bootstrapping, we cannot UPDATE, so overwrite in-place */ 
</span>        <a href="../../include/access/heapam.h.html#LN168"><span class='Ref_to_Proto'>heap_inplace_update</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN134"><span class='Ref_To_Local'>class_rel</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN129"><span class='Ref_To_Local'>reltup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN134"><span class='Ref_To_Local'>class_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Register dependency from the toast table to the master, so that the 
     * toast table will be deleted if the master is.  Skip this in bootstrap 
     * mode. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="toasting.c.html#LN144"><span class='Ref_To_Local'>baseobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN144"><span class='Ref_To_Local'>baseobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="toasting.c.html#LN128"><span class='Ref_To_Local'>relOid</span></a><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN144"><span class='Ref_To_Local'>baseobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN145"><span class='Ref_To_Local'>toastobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN145"><span class='Ref_To_Local'>toastobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="toasting.c.html#LN135"><span class='Ref_To_Local'>toast_relid</span></a><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN145"><span class='Ref_To_Local'>toastobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="toasting.c.html#LN145"><span class='Ref_To_Local'>toastobject</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="toasting.c.html#LN144"><span class='Ref_To_Local'>baseobject</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN76"><span class='Ref_to_EnumConst'>DEPENDENCY_INTERNAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make changes visible 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end create_toast_table &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check to see whether the table needs a TOAST table.  It does only if 
 * (1) there are any toastable attributes, and (2) the maximum length 
 * of a tuple could exceed TOAST_TUPLE_THRESHOLD.  (We don't want to 
 * create a toast table for something like "f1 varchar(20)".) 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN398"></a><span class='Declare_Function'>needs_toast_table</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN400"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>data_length</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN401"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>maxlength_unknown</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN402"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_toastable_attrs</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN403"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN404"></a>    <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>att</span><span class='Delimiter'>; 
</span><a name="LN405"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>tuple_length</span><span class='Delimiter'>; 
</span><a name="LN406"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="toasting.c.html#LN403"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="toasting.c.html#LN398"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a> <span class='Operator'>= </span><a href="toasting.c.html#LN403"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="toasting.c.html#LN403"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <a href="toasting.c.html#LN400"><span class='Ref_To_Local'>data_length</span></a> <span class='Operator'>= </span><a href="../../include/access/tupmacs.h.html#LN143"><span class='Ref_to_Macro'>att_align_nominal</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN400"><span class='Ref_To_Local'>data_length</span></a><span class='Delimiter'>, </span><a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attalign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Fixed-length types are never toastable */ 
</span>            <a href="toasting.c.html#LN400"><span class='Ref_To_Local'>data_length</span></a> <span class='Operator'>+= </span><a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attlen<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN423"></a>            <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>maxlen</span> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN118"><span class='Ref_to_Proto'>type_maximum_size</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                   <a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN423"><span class='Ref_To_Local'>maxlen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="toasting.c.html#LN401"><span class='Ref_To_Local'>maxlength_unknown</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="toasting.c.html#LN400"><span class='Ref_To_Local'>data_length</span></a> <span class='Operator'>+= </span><a href="toasting.c.html#LN423"><span class='Ref_To_Local'>maxlen</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN404"><span class='Ref_To_Local'>att</span></a><span class='Delimiter'>[</span><a href="toasting.c.html#LN406"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attstorage <span class='Operator'>!= </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>                <a href="toasting.c.html#LN402"><span class='Ref_To_Local'>has_toastable_attrs</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;tupdesc-&GT;natts;... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="toasting.c.html#LN402"><span class='Ref_To_Local'>has_toastable_attrs</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* nothing to toast? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN401"><span class='Ref_To_Local'>maxlength_unknown</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* any unlimited-length attrs? */ 
</span>    <a href="toasting.c.html#LN405"><span class='Ref_To_Local'>tuple_length</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a> <span class='Operator'>+ 
</span>                            <a href="../../include/access/htup_details.h.html#LN547"><span class='Ref_to_Macro'>BITMAPLEN</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN403"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>        <a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="toasting.c.html#LN400"><span class='Ref_To_Local'>data_length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="toasting.c.html#LN405"><span class='Ref_To_Local'>tuple_length</span></a> <span class='Operator'>&GT; </span><a href="../../include/access/tuptoaster.h.html#LN54"><span class='Ref_to_Const'>TOAST_TUPLE_THRESHOLD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end needs_toast_table &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>