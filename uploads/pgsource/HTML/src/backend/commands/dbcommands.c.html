<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\commands\dbcommands.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\commands\dbcommands.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:34 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * dbcommands.c 
 *      Database management commands (create/drop database). 
 * 
 * Note: database creation/destruction commands use exclusive locks on 
 * the database objects (as expressed by LockSharedObject()) to avoid 
 * stepping on each others' toes.  Formerly we used table-level locks 
 * on pg_database, but that's too coarse-grained. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/commands/dbcommands.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlogutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_authid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_database.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_db_role_setting.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_subscription.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/comment.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/defrem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/seclabel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgwriter.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/slot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/copydir.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/pg_locale.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN68"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>src_dboid</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* source (template) DB */ 
</span><a name="LN69"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>dest_dboid</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* DB we are trying to create */ 
</span><a name="LN70"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>createdb_failure_params</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN74"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>dest_dboid</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* DB we are trying to move */ 
</span><a name="LN75"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>dest_tsoid</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* tablespace we are trying to move to */ 
</span><a name="LN76"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>movedb_failure_params</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* non-export function prototypes */ 
</span><a name="LN79"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>createdb_failure_callback</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN80"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>movedb</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tblspcname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN81"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>movedb_failure_callback</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>get_db_info</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN83"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbIdP</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ownerIdP</span><span class='Delimiter'>, 
</span><a name="LN84"></a>            <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>encodingP</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbIsTemplateP</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbAllowConnP</span><span class='Delimiter'>, 
</span><a name="LN85"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbLastSysOidP</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbFrozenXidP</span><span class='Delimiter'>, 
</span><a name="LN86"></a>            <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbMinMultiP</span><span class='Delimiter'>, 
</span><a name="LN87"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbTablespace</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>dbCollate</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>dbCtype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>have_createdb_privilege</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN89"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>remove_dbtablespaces</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>db_id</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN90"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>check_db_file_conflict</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>db_id</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN91"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>errdetail_busy_db</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>notherbackends</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>npreparedxacts</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CREATE DATABASE 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN98"></a><span class='Declare_Function'>createdb</span><span class='Parentheses'>(</span><a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../include/nodes/parsenodes.h.html#LN2994"><span class='Ref_to_Struct'>CreatedbStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN100"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN101"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN102"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>src_dboid</span><span class='Delimiter'>; 
</span><a name="LN103"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>src_owner</span><span class='Delimiter'>; 
</span><a name="LN104"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>src_encoding</span><span class='Delimiter'>; 
</span><a name="LN105"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>src_collate</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>src_ctype</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>src_istemplate</span><span class='Delimiter'>; 
</span><a name="LN108"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>src_allowconn</span><span class='Delimiter'>; 
</span><a name="LN109"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>src_lastsysoid</span><span class='Delimiter'>; 
</span><a name="LN110"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>src_frozenxid</span><span class='Delimiter'>; 
</span><a name="LN111"></a>    <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>src_minmxid</span><span class='Delimiter'>; 
</span><a name="LN112"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>src_deftablespace</span><span class='Delimiter'>; 
</span><a name="LN113"></a>    <span class='Keyword'>volatile </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Local'>dst_deftablespace</span><span class='Delimiter'>; 
</span><a name="LN114"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_database_rel</span><span class='Delimiter'>; 
</span><a name="LN115"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN116"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_record</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN117"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_record_nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN118"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dboid</span><span class='Delimiter'>; 
</span><a name="LN119"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>datdba</span><span class='Delimiter'>; 
</span><a name="LN120"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>option</span><span class='Delimiter'>; 
</span><a name="LN121"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dtablespacename</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>downer</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dtemplate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN124"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dencoding</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN125"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dcollate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN126"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dctype</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN127"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>distemplate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN128"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dallowconnections</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN129"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dconnlimit</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dbname</span> <span class='Operator'>= </span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2997"><span class='Ref_to_Member'>dbname</span></a><span class='Delimiter'>; 
</span><a name="LN131"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dbowner</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN132"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>dbtemplate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dbcollate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dbctype</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN135"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>canonname</span><span class='Delimiter'>; 
</span><a name="LN136"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>encoding</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN137"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>dbistemplate</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN138"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>dballowconnections</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN139"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>dbconnlimit</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN140"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>notherbackends</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>npreparedxacts</span><span class='Delimiter'>; 
</span><a name="LN142"></a>    <a href="dbcommands.c.html#LN66"><span class='Ref_to_Typedef'>createdb_failure_params</span></a> <span class='Declare_Local'>fparms</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Extract options from the statement node tree */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN120"><span class='Ref_To_Local'>option</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2998"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN147"></a>        <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>defel</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN120"><span class='Ref_To_Local'>option</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"tablespace"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN121"><span class='Ref_To_Local'>dtablespacename</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN121"><span class='Ref_To_Local'>dtablespacename</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"owner"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN122"><span class='Ref_To_Local'>downer</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN122"><span class='Ref_To_Local'>downer</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"template"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN123"><span class='Ref_To_Local'>dtemplate</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN123"><span class='Ref_To_Local'>dtemplate</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"encoding"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"lc_collate"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN125"><span class='Ref_To_Local'>dcollate</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN125"><span class='Ref_To_Local'>dcollate</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"lc_ctype"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN126"><span class='Ref_To_Local'>dctype</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN126"><span class='Ref_To_Local'>dctype</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"is_template"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN127"><span class='Ref_To_Local'>distemplate</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN127"><span class='Ref_To_Local'>distemplate</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"allow_connections"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN128"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN128"><span class='Ref_To_Local'>dallowconnections</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"connection_limit"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN129"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN129"><span class='Ref_To_Local'>dconnlimit</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"location"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"LOCATION is not supported anymore"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Consider using tablespaces instead."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"option \"%s\" not recognized"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN147"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN122"><span class='Ref_To_Local'>downer</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN122"><span class='Ref_To_Local'>downer</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN131"><span class='Ref_To_Local'>dbowner</span></a> <span class='Operator'>= </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN122"><span class='Ref_To_Local'>downer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN123"><span class='Ref_To_Local'>dtemplate</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN123"><span class='Ref_To_Local'>dtemplate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a> <span class='Operator'>= </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN123"><span class='Ref_To_Local'>dtemplate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN251"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>encoding_name</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>, </span>Integer<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN159"><span class='Ref_to_Proto'>defGetInt32</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN251"><span class='Ref_To_Local'>encoding_name</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN251"><span class='Ref_To_Local'>encoding_name</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                <a href="../utils/mb/encnames.c.html#LN499"><span class='Ref_to_Func'>pg_valid_server_encoding</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN251"><span class='Ref_To_Local'>encoding_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%d is not a valid encoding code"</span><span class='Delimiter'>, 
</span>                                <a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dbcommands.c.html#LN251"><span class='Ref_To_Local'>encoding_name</span></a> <span class='Operator'>= </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>= </span><a href="../utils/mb/encnames.c.html#LN499"><span class='Ref_to_Func'>pg_valid_server_encoding</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN251"><span class='Ref_To_Local'>encoding_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s is not a valid encoding name"</span><span class='Delimiter'>, 
</span>                                <a href="dbcommands.c.html#LN251"><span class='Ref_To_Local'>encoding_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN98"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN124"><span class='Ref_To_Local'>dencoding</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dencoding&&dencoding-... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN125"><span class='Ref_To_Local'>dcollate</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN125"><span class='Ref_To_Local'>dcollate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a> <span class='Operator'>= </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN125"><span class='Ref_To_Local'>dcollate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN126"><span class='Ref_To_Local'>dctype</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN126"><span class='Ref_To_Local'>dctype</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a> <span class='Operator'>= </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN126"><span class='Ref_To_Local'>dctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN127"><span class='Ref_To_Local'>distemplate</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN127"><span class='Ref_To_Local'>distemplate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN137"><span class='Ref_To_Local'>dbistemplate</span></a> <span class='Operator'>= </span><a href="define.c.html#LN109"><span class='Ref_to_Func'>defGetBoolean</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN127"><span class='Ref_To_Local'>distemplate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN128"><span class='Ref_To_Local'>dallowconnections</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN128"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN138"><span class='Ref_To_Local'>dballowconnections</span></a> <span class='Operator'>= </span><a href="define.c.html#LN109"><span class='Ref_to_Func'>defGetBoolean</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN128"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN129"><span class='Ref_To_Local'>dconnlimit</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN129"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN139"><span class='Ref_To_Local'>dbconnlimit</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN159"><span class='Ref_to_Proto'>defGetInt32</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN129"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN139"><span class='Ref_To_Local'>dbconnlimit</span></a> <span class='Operator'>&LT; -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid connection limit: %d"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN139"><span class='Ref_To_Local'>dbconnlimit</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* obtain OID of proposed owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN131"><span class='Ref_To_Local'>dbowner</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN119"><span class='Ref_To_Local'>datdba</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN234"><span class='Ref_to_Proto'>get_role_oid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN131"><span class='Ref_To_Local'>dbowner</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dbcommands.c.html#LN119"><span class='Ref_To_Local'>datdba</span></a> <span class='Operator'>= </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To create a database, must have createdb privilege and must be able to 
     * become the target role (this does not imply that the target role itself 
     * must have createdb privilege).  The latter provision guards against 
     * "giveaway" attacks.  Note that a superuser will always have both of 
     * these privileges a fortiori. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN88"><span class='Ref_to_Proto'>have_createdb_privilege</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to create database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/acl.h.html#LN233"><span class='Ref_to_Proto'>check_is_member_of_role</span></a><span class='Parentheses'>(</span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN119"><span class='Ref_To_Local'>datdba</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup database (template) to be cloned, and obtain share lock on it. 
     * ShareLock allows two CREATE DATABASEs to work from the same template 
     * concurrently, while ensuring no one is busy dropping it in parallel 
     * (which would be Very Bad since we'd likely get an incomplete copy 
     * without knowing it).  This also prevents any new connections from being 
     * made to the source until we finish copying it, so we can be sure it 
     * won't change underneath us. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a> <span class='Operator'>= </span><span class='String'>"template1"</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Default template database name */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN82"><span class='Ref_to_Proto'>get_db_info</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN103"><span class='Ref_To_Local'>src_owner</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN104"><span class='Ref_To_Local'>src_encoding</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="dbcommands.c.html#LN107"><span class='Ref_To_Local'>src_istemplate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN108"><span class='Ref_To_Local'>src_allowconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN109"><span class='Ref_To_Local'>src_lastsysoid</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="dbcommands.c.html#LN110"><span class='Ref_To_Local'>src_frozenxid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN111"><span class='Ref_To_Local'>src_minmxid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN112"><span class='Ref_To_Local'>src_deftablespace</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="dbcommands.c.html#LN105"><span class='Ref_To_Local'>src_collate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN106"><span class='Ref_To_Local'>src_ctype</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"template database \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Permission check: to copy a DB that's not marked datistemplate, you 
     * must be superuser or the owner thereof. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN107"><span class='Ref_To_Local'>src_istemplate</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to copy database \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If encoding or locales are defaulted, use source's setting */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN104"><span class='Ref_To_Local'>src_encoding</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN105"><span class='Ref_To_Local'>src_collate</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN106"><span class='Ref_To_Local'>src_ctype</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Some encodings are client only */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/mb/pg_wchar.h.html#LN292"><span class='Ref_to_Macro'>PG_VALID_BE_ENCODING</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid server encoding %d"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that the chosen locales are valid, and get canonical spellings */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/pg_locale.h.html#LN46"><span class='Ref_to_Proto'>check_locale</span></a><span class='Parentheses'>(</span>LC_COLLATE<span class='Delimiter'>, </span><a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN135"><span class='Ref_To_Local'>canonname</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid locale name: \"%s\""</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN135"><span class='Ref_To_Local'>canonname</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/pg_locale.h.html#LN46"><span class='Ref_to_Proto'>check_locale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN135"><span class='Ref_To_Local'>canonname</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid locale name: \"%s\""</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN135"><span class='Ref_To_Local'>canonname</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/commands/dbcommands.h.html#LN31"><span class='Ref_to_Proto'>check_encoding_locale_matches</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the new encoding and locale settings match the source 
     * database.  We insist on this because we simply copy the source data --- 
     * any non-ASCII data would be wrongly encoded, and any indexes sorted 
     * according to the source locale would be wrong. 
     * 
     * However, we assume that template0 doesn't contain any non-ASCII data 
     * nor any indexes that depend on collation or ctype, so template0 can be 
     * used as template for creating a database with any encoding or locale. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Delimiter'>, </span><span class='String'>"template0"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>!= </span><a href="dbcommands.c.html#LN104"><span class='Ref_To_Local'>src_encoding</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"new encoding (%s) is incompatible with the encoding of the template database (%s)"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN104"><span class='Ref_To_Local'>src_encoding</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use the same encoding as in the template database, or use template0 as template."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN105"><span class='Ref_To_Local'>src_collate</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"new collation (%s) is incompatible with the collation of the template database (%s)"</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN105"><span class='Ref_To_Local'>src_collate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use the same collation as in the template database, or use template0 as template."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN106"><span class='Ref_To_Local'>src_ctype</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"new LC_CTYPE (%s) is incompatible with the LC_CTYPE of the template database (%s)"</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN106"><span class='Ref_To_Local'>src_ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use the same LC_CTYPE as in the template database, or use template0 as template."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(dbtemplate,"te... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Resolve default tablespace for new database */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN121"><span class='Ref_To_Local'>dtablespacename</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN121"><span class='Ref_To_Local'>dtablespacename</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN415"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tablespacename</span><span class='Delimiter'>; 
</span><a name="LN416"></a>        <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN415"><span class='Ref_To_Local'>tablespacename</span></a> <span class='Operator'>= </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN121"><span class='Ref_To_Local'>dtablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN415"><span class='Ref_To_Local'>tablespacename</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* check permissions */ 
</span>        <a href="dbcommands.c.html#LN416"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN290"><span class='Ref_to_Proto'>pg_tablespace_aclcheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                           <a href="../../include/nodes/parsenodes.h.html#LN81"><span class='Ref_to_Const'>ACL_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN416"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN416"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, 
</span>                           <a href="dbcommands.c.html#LN415"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* pg_global must never be the default tablespace */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_global cannot be used as default tablespace"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we are trying to change the default tablespace of the template, 
         * we require that the template not have any files in the new default 
         * tablespace.  This is necessary because otherwise the copied 
         * database would contain pg_class rows that refer to its default 
         * tablespace both explicitly (by OID) and implicitly (as zero), which 
         * would cause problems.  For example another CREATE DATABASE using 
         * the copied database as template, and trying to change its default 
         * tablespace again, would yield outright incorrect results (it would 
         * improperly move tables to the new default tablespace that should 
         * stay in the same tablespace). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a> <span class='Operator'>!= </span><a href="dbcommands.c.html#LN112"><span class='Ref_To_Local'>src_deftablespace</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN447"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>srcpath</span><span class='Delimiter'>; 
</span><a name="LN448"></a>            <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
            <a href="dbcommands.c.html#LN447"><span class='Ref_To_Local'>srcpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN447"><span class='Ref_To_Local'>srcpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN448"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                <a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN448"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <span class='Operator'>!</span><a href="../../include/commands/tablespace.h.html#LN58"><span class='Ref_to_Proto'>directory_is_empty</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN447"><span class='Ref_To_Local'>srcpath</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot assign new default tablespace \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="dbcommands.c.html#LN415"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"There is a conflict because database \"%s\" already has some tables in this tablespace."</span><span class='Delimiter'>, 
</span>                                   <a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN447"><span class='Ref_To_Local'>srcpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dtablespacename&&dtab... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Use template database's default tablespace */ 
</span>        <a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN112"><span class='Ref_To_Local'>src_deftablespace</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Note there is no additional permission check in this path */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for db name conflict.  This is just to give a more friendly error 
     * message than "unique index violation".  There's a race condition but 
     * we're willing to accept the less friendly message in that case. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands.h.html#LN28"><span class='Ref_to_Proto'>get_database_oid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN130"><span class='Ref_To_Local'>dbname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" already exists"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN130"><span class='Ref_To_Local'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The source DB can't have any active backends, except this one 
     * (exception is to allow CREATE DB while connected to template1). 
     * Otherwise we might copy inconsistent data. 
     * 
     * This should be last among the basic error checks, because it involves 
     * potential waiting; we may as well throw an error first if we're gonna 
     * throw one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/procarray.h.html#LN114"><span class='Ref_to_Proto'>CountOtherDBBackends</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN140"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN141"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"source database \"%s\" is being accessed by other users"</span><span class='Delimiter'>, 
</span>                   <a href="dbcommands.c.html#LN132"><span class='Ref_To_Local'>dbtemplate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="dbcommands.c.html#LN91"><span class='Ref_to_Proto'>errdetail_busy_db</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN140"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN141"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select an OID for the new database, checking that it doesn't have a 
     * filename conflict with anything already existing in the tablespace 
     * directories. 
     */ 
</span>    <a href="dbcommands.c.html#LN114"><span class='Ref_To_Local'>pg_database_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/catalog.h.html#LN44"><span class='Ref_to_Proto'>GetNewOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN114"><span class='Ref_To_Local'>pg_database_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN90"><span class='Ref_to_Proto'>check_db_file_conflict</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insert a new tuple into pg_database.  This establishes our ownership of 
     * the new database name (anyone else trying to insert the same name will 
     * block on the unique index, and fail after we commit). 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Form tuple */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN117"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN117"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_database_datname</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>        <a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../utils/adt/name.c.html#LN44"><span class='Ref_to_Func'>namein</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN130"><span class='Ref_To_Local'>dbname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN64"><span class='Ref_to_Const'>Anum_pg_database_datdba</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN119"><span class='Ref_To_Local'>datdba</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN65"><span class='Ref_to_Const'>Anum_pg_database_encoding</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN136"><span class='Ref_To_Local'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN66"><span class='Ref_to_Const'>Anum_pg_database_datcollate</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>        <a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../utils/adt/name.c.html#LN44"><span class='Ref_to_Func'>namein</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN133"><span class='Ref_To_Local'>dbcollate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN67"><span class='Ref_to_Const'>Anum_pg_database_datctype</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>        <a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../utils/adt/name.c.html#LN44"><span class='Ref_to_Func'>namein</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN134"><span class='Ref_To_Local'>dbctype</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN68"><span class='Ref_to_Const'>Anum_pg_database_datistemplate</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN137"><span class='Ref_To_Local'>dbistemplate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN69"><span class='Ref_to_Const'>Anum_pg_database_datallowconn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN138"><span class='Ref_To_Local'>dballowconnections</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_database_datconnlimit</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN139"><span class='Ref_To_Local'>dbconnlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN71"><span class='Ref_to_Const'>Anum_pg_database_datlastsysoid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN109"><span class='Ref_To_Local'>src_lastsysoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN72"><span class='Ref_to_Const'>Anum_pg_database_datfrozenxid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN526"><span class='Ref_to_Macro'>TransactionIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN110"><span class='Ref_To_Local'>src_frozenxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN73"><span class='Ref_to_Const'>Anum_pg_database_datminmxid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN526"><span class='Ref_to_Macro'>TransactionIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN111"><span class='Ref_To_Local'>src_minmxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_database_dattablespace</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We deliberately set datacl to default (NULL), rather than copying it 
     * from the template database.  Copying it would be a bad idea when the 
     * owner is not the same as the template's owner. 
     */ 
</span>    <a href="dbcommands.c.html#LN117"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_database_datacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN115"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN114"><span class='Ref_To_Local'>pg_database_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN116"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN117"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN697"><span class='Ref_to_Macro'>HeapTupleSetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN115"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN114"><span class='Ref_To_Local'>pg_database_rel</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN115"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now generate additional catalog entries associated with the new DB 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Register owner dependency */ 
</span>    <a href="../catalog/pg_shdepend.c.html#LN157"><span class='Ref_to_Func'>recordDependencyOnOwner</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN119"><span class='Ref_To_Local'>datdba</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create pg_shdepend entries for objects within database */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN272"><span class='Ref_to_Proto'>copyTemplateDependencies</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Post creation hook for new database */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN144"><span class='Ref_to_Macro'>InvokeObjectPostCreateHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force a checkpoint before starting the copy. This will force all dirty 
     * buffers, including those of unlogged tables, out to disk, to ensure 
     * source database is up-to-date on disk for the copy. 
     * FlushDatabaseBuffers() would suffice for that, but we also want to 
     * process any pending unlink requests. Otherwise, if a checkpoint 
     * happened while we're copying files, a file might be deleted just when 
     * we're about to copy it, causing the lstat() call in copydir() to fail 
     * with ENOENT. 
     */ 
</span>    <a href="../../include/postmaster/bgwriter.h.html#LN30"><span class='Ref_to_Proto'>RequestCheckpoint</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN178"><span class='Ref_to_Const'>CHECKPOINT_IMMEDIATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN179"><span class='Ref_to_Const'>CHECKPOINT_FORCE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN183"><span class='Ref_to_Const'>CHECKPOINT_WAIT</span></a> 
                      <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN180"><span class='Ref_to_Const'>CHECKPOINT_FLUSH_ALL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Once we start copying subdirectories, we need to be able to clean 'em 
     * up if we fail.  Use an ENSURE block to make sure this happens.  (This 
     * is not a 100% solution, because of the possibility of failure during 
     * transaction commit after we leave this routine, but it should handle 
     * most scenarios.) 
     */ 
</span>    <a href="dbcommands.c.html#LN142"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>.</span><a href="dbcommands.c.html#LN68"><span class='Ref_to_Member'>src_dboid</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN142"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>.</span><a href="dbcommands.c.html#LN69"><span class='Ref_to_Member'>dest_dboid</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/storage/ipc.h.html#LN46"><span class='Ref_to_Macro'>PG_ENSURE_ERROR_CLEANUP</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN79"><span class='Ref_to_Proto'>createdb_failure_callback</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN142"><span class='Ref_To_Local'>fparms</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Iterate through all tablespaces of the template database, and copy 
         * each one to the new database. 
         */ 
</span>        <a href="dbcommands.c.html#LN101"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN100"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN101"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dbcommands.c.html#LN115"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN100"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN595"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>srctablespace</span> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN115"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN596"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dsttablespace</span><span class='Delimiter'>; 
</span><a name="LN597"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>srcpath</span><span class='Delimiter'>; 
</span><a name="LN598"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dstpath</span><span class='Delimiter'>; 
</span><a name="LN599"></a>            <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* No need to copy global tablespace */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN595"><span class='Ref_To_Local'>srctablespace</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="dbcommands.c.html#LN597"><span class='Ref_To_Local'>srcpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN595"><span class='Ref_To_Local'>srctablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN597"><span class='Ref_To_Local'>srcpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN599"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| !</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN599"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                <a href="../../include/commands/tablespace.h.html#LN58"><span class='Ref_to_Proto'>directory_is_empty</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN597"><span class='Ref_To_Local'>srcpath</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Assume we can ignore it */ 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN597"><span class='Ref_To_Local'>srcpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN595"><span class='Ref_To_Local'>srctablespace</span></a> <span class='Operator'>== </span><a href="dbcommands.c.html#LN112"><span class='Ref_To_Local'>src_deftablespace</span></a><span class='Parentheses'>) 
</span>                <a href="dbcommands.c.html#LN596"><span class='Ref_To_Local'>dsttablespace</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN113"><span class='Ref_To_Local'>dst_deftablespace</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="dbcommands.c.html#LN596"><span class='Ref_To_Local'>dsttablespace</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN595"><span class='Ref_To_Local'>srctablespace</span></a><span class='Delimiter'>; 
</span> 
            <a href="dbcommands.c.html#LN598"><span class='Ref_To_Local'>dstpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN596"><span class='Ref_To_Local'>dsttablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Copy this subdirectory to the new location 
             * 
             * We don't need to copy subdirectories 
             */ 
</span>            <a href="../../include/storage/copydir.h.html#LN15"><span class='Ref_to_Proto'>copydir</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN597"><span class='Ref_To_Local'>srcpath</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN598"><span class='Ref_To_Local'>dstpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Record the filesystem change in XLOG */ 
</span>            <span class='Delimiter'>{ 
</span><a name="LN631"></a>                <a href="../../include/commands/dbcommands_xlog.h.html#LN23"><span class='Ref_to_Struct'>xl_dbase_create_rec</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
                <a href="dbcommands.c.html#LN631"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN26"><span class='Ref_to_Member'>db_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>; 
</span>                <a href="dbcommands.c.html#LN631"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN27"><span class='Ref_to_Member'>tablespace_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN596"><span class='Ref_To_Local'>dsttablespace</span></a><span class='Delimiter'>; 
</span>                <a href="dbcommands.c.html#LN631"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN28"><span class='Ref_to_Member'>src_db_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN102"><span class='Ref_To_Local'>src_dboid</span></a><span class='Delimiter'>; 
</span>                <a href="dbcommands.c.html#LN631"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN29"><span class='Ref_to_Member'>src_tablespace_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN595"><span class='Ref_To_Local'>srctablespace</span></a><span class='Delimiter'>; 
</span> 
                <a href="../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN631"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands_xlog.h.html#LN23"><span class='Ref_to_Struct'>xl_dbase_create_rec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_DBASE_ID<span class='Delimiter'>, 
</span>                                  <a href="../../include/commands/dbcommands_xlog.h.html#LN20"><span class='Ref_to_Const'>XLOG_DBASE_CREATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogrecord.h.html#LN70"><span class='Ref_to_Const'>XLR_SPECIAL_REL_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=heap_getnext(s... &raquo; </span> 
        <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN100"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN101"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We force a checkpoint before committing.  This effectively means 
         * that committed XLOG_DBASE_CREATE operations will never need to be 
         * replayed (at least not in ordinary crash recovery; we still have to 
         * make the XLOG entry for the benefit of PITR operations). This 
         * avoids two nasty scenarios: 
         * 
         * #1: When PITR is off, we don't XLOG the contents of newly created 
         * indexes; therefore the drop-and-recreate-whole-directory behavior 
         * of DBASE_CREATE replay would lose such indexes. 
         * 
         * #2: Since we have to recopy the source database during DBASE_CREATE 
         * replay, we run the risk of copying changes in it that were 
         * committed after the original CREATE DATABASE command but before the 
         * system crash that led to the replay.  This is at least unexpected 
         * and at worst could lead to inconsistencies, eg duplicate table 
         * names. 
         * 
         * (Both of these were real bugs in releases 8.0 through 8.0.3.) 
         * 
         * In PITR replay, the first of these isn't an issue, and the second 
         * is only a risk if the CREATE DATABASE and subsequent template 
         * database change both occur while a base backup is being taken. 
         * There doesn't seem to be much we can do about that except document 
         * it as a limitation. 
         * 
         * Perhaps if we ever implement CREATE DATABASE in a less cheesy way, 
         * we can avoid this. 
         */ 
</span>        <a href="../../include/postmaster/bgwriter.h.html#LN30"><span class='Ref_to_Proto'>RequestCheckpoint</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN178"><span class='Ref_to_Const'>CHECKPOINT_IMMEDIATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN179"><span class='Ref_to_Const'>CHECKPOINT_FORCE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN183"><span class='Ref_to_Const'>CHECKPOINT_WAIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Close pg_database, but keep lock till commit. 
         */ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN114"><span class='Ref_To_Local'>pg_database_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Force synchronous commit, thus minimizing the window between 
         * creation of the database files and committal of the transaction. If 
         * we crash before committing, we'll have a DB that's taking up disk 
         * space but is not in pg_database, which is not good. 
         */ 
</span>        <a href="../../include/access/xact.h.html#LN347"><span class='Ref_to_Proto'>ForceSyncCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/ipc.h.html#LN51"><span class='Ref_to_Macro'>PG_END_ENSURE_ERROR_CLEANUP</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN79"><span class='Ref_to_Proto'>createdb_failure_callback</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN142"><span class='Ref_To_Local'>fparms</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN118"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end createdb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check whether chosen encoding matches chosen locale settings.  This 
 * restriction is necessary because libc's locale-specific code usually 
 * fails when presented with data in an encoding it's not expecting. We 
 * allow mismatch in four cases: 
 * 
 * 1. locale encoding = SQL_ASCII, which means that the locale is C/POSIX 
 * which works with any encoding. 
 * 
 * 2. locale encoding = -1, which means that we couldn't determine the 
 * locale's encoding and have to trust the user to get it right. 
 * 
 * 3. selected encoding is UTF8 and platform is win32. This is because 
 * UTF8 is a pseudo codepage that is supported in all locales since it's 
 * converted to UTF16 before being used. 
 * 
 * 4. selected encoding is SQL_ASCII, but only if you're a superuser. This 
 * is risky but we have historically allowed it --- notably, the 
 * regression tests require it. 
 * 
 * Note: if you change this policy, fix initdb to match. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN721"></a><span class='Declare_Function'>check_encoding_locale_matches</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>encoding</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>collate</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ctype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN723"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ctype_encoding</span> <span class='Operator'>= </span><a href="../../port/chklocale.c.html#LN309"><span class='Ref_to_Func'>pg_get_encoding_from_locale</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>ctype</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN724"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>collate_encoding</span> <span class='Operator'>= </span><a href="../../port/chklocale.c.html#LN309"><span class='Ref_to_Func'>pg_get_encoding_from_locale</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>collate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN723"><span class='Ref_To_Local'>ctype_encoding</span></a> <span class='Operator'>== </span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a> <span class='Operator'>|| 
</span>          <a href="dbcommands.c.html#LN723"><span class='Ref_To_Local'>ctype_encoding</span></a> <span class='Operator'>== </span><a href="../../include/mb/pg_wchar.h.html#LN237"><span class='Ref_to_EnumConst'>PG_SQL_ASCII</span></a> <span class='Operator'>|| 
</span>          <a href="dbcommands.c.html#LN723"><span class='Ref_To_Local'>ctype_encoding</span></a> <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>|| 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
          <a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a> <span class='Operator'>== </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a> <span class='Operator'>|| 
</span><span class='Directive'>#endif</span> 
          <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a> <span class='Operator'>== </span><a href="../../include/mb/pg_wchar.h.html#LN237"><span class='Ref_to_EnumConst'>PG_SQL_ASCII</span></a> <span class='Operator'>&& </span><a href="../utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>())))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"encoding \"%s\" does not match locale \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The chosen LC_CTYPE setting requires encoding \"%s\"."</span><span class='Delimiter'>, 
</span>                     <a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN723"><span class='Ref_To_Local'>ctype_encoding</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN724"><span class='Ref_To_Local'>collate_encoding</span></a> <span class='Operator'>== </span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a> <span class='Operator'>|| 
</span>          <a href="dbcommands.c.html#LN724"><span class='Ref_To_Local'>collate_encoding</span></a> <span class='Operator'>== </span><a href="../../include/mb/pg_wchar.h.html#LN237"><span class='Ref_to_EnumConst'>PG_SQL_ASCII</span></a> <span class='Operator'>|| 
</span>          <a href="dbcommands.c.html#LN724"><span class='Ref_To_Local'>collate_encoding</span></a> <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>|| 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
          <a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a> <span class='Operator'>== </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a> <span class='Operator'>|| 
</span><span class='Directive'>#endif</span> 
          <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a> <span class='Operator'>== </span><a href="../../include/mb/pg_wchar.h.html#LN237"><span class='Ref_to_EnumConst'>PG_SQL_ASCII</span></a> <span class='Operator'>&& </span><a href="../utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>())))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"encoding \"%s\" does not match locale \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN721"><span class='Ref_to_Parameter'>collate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The chosen LC_COLLATE setting requires encoding \"%s\"."</span><span class='Delimiter'>, 
</span>                   <a href="../../include/mb/pg_wchar.h.html#LN502"><span class='Ref_to_Proto'>pg_encoding_to_char</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN724"><span class='Ref_To_Local'>collate_encoding</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_encoding_locale_matches &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Error cleanup callback for createdb */ 
</span><span class='Keyword'>static void 
</span><a name="LN759"></a><span class='Declare_Function'>createdb_failure_callback</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN761"></a>    <a href="dbcommands.c.html#LN66"><span class='Ref_to_Typedef'>createdb_failure_params</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fparms</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN66"><span class='Ref_to_Typedef'>createdb_failure_params</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN759"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release lock on source database before doing recursive remove. This is 
     * not essential but it seems desirable to release the lock as soon as 
     * possible. 
     */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN95"><span class='Ref_to_Proto'>UnlockSharedObject</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN761"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>-&GT;</span><a href="dbcommands.c.html#LN68"><span class='Ref_to_Member'>src_dboid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Throw away any successfully copied subdirectories */ 
</span>    <a href="dbcommands.c.html#LN89"><span class='Ref_to_Proto'>remove_dbtablespaces</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN761"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>-&GT;</span><a href="dbcommands.c.html#LN69"><span class='Ref_to_Member'>dest_dboid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * DROP DATABASE 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN779"></a><span class='Declare_Function'>dropdb</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN781"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>db_id</span><span class='Delimiter'>; 
</span><a name="LN782"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>db_istemplate</span><span class='Delimiter'>; 
</span><a name="LN783"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pgdbrel</span><span class='Delimiter'>; 
</span><a name="LN784"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN785"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>notherbackends</span><span class='Delimiter'>; 
</span><a name="LN786"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>npreparedxacts</span><span class='Delimiter'>; 
</span><a name="LN787"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nslots</span><span class='Delimiter'>, 
</span><a name="LN788"></a>                <span class='Declare_Local'>nslots_active</span><span class='Delimiter'>; 
</span><a name="LN789"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nsubscriptions</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up the target database's OID, and get exclusive lock on it. We 
     * need this to ensure that no new backend starts up in the target 
     * database while we are deleting it (see postinit.c), and that no one is 
     * using it as a CREATE DATABASE template or trying to delete it for 
     * themselves. 
     */ 
</span>    <a href="dbcommands.c.html#LN783"><span class='Ref_To_Local'>pgdbrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN82"><span class='Ref_to_Proto'>get_db_info</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                   <span class='Operator'>&</span><a href="dbcommands.c.html#LN782"><span class='Ref_To_Local'>db_istemplate</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Close pg_database, release the lock, since we changed nothing */ 
</span>            <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN783"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist, skipping"</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Permission checks 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                       <a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* DROP hook for the database being removed */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN153"><span class='Ref_to_Macro'>InvokeObjectDropHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Disallow dropping a DB that is marked istemplate.  This is just to 
     * prevent people from accidentally dropping template0 or template1; they 
     * can do so if they're really determined ... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN782"><span class='Ref_To_Local'>db_istemplate</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot drop a template database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Obviously can't drop my own database */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot drop the currently open database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check whether there are active logical slots that refer to the 
     * to-be-dropped database. The database lock we are holding prevents the 
     * creation of new slots using the database or existing slots becoming 
     * active. 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/replication/slot.h.html#LN178"><span class='Ref_to_Proto'>ReplicationSlotsCountDBSlots</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN787"><span class='Ref_To_Local'>nslots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN788"><span class='Ref_To_Local'>nslots_active</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN788"><span class='Ref_To_Local'>nslots_active</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" is used by an active logical replication slot"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../include/utils/elog.h.html#LN150"><span class='Ref_to_Func'>errdetail_plural</span></a><span class='Parentheses'>(</span><span class='String'>"There is %d active slot"</span><span class='Delimiter'>, 
</span>                                  <span class='String'>"There are %d active slots"</span><span class='Delimiter'>, 
</span>                                  <a href="dbcommands.c.html#LN788"><span class='Ref_To_Local'>nslots_active</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN788"><span class='Ref_To_Local'>nslots_active</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for other backends in the target database.  (Because we hold the 
     * database lock, no new ones can start after this.) 
     * 
     * As in CREATE DATABASE, check this after other error conditions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/procarray.h.html#LN114"><span class='Ref_to_Proto'>CountOtherDBBackends</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN785"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN786"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" is being accessed by other users"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="dbcommands.c.html#LN91"><span class='Ref_to_Proto'>errdetail_busy_db</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN785"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN786"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if there are subscriptions defined in the target database. 
     * 
     * We can't drop them automatically because they might be holding 
     * resources in other databases/instances. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dbcommands.c.html#LN789"><span class='Ref_To_Local'>nsubscriptions</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_subscription.h.html#LN93"><span class='Ref_to_Proto'>CountDBSubscriptions</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" is being used by logical replication subscription"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN779"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../include/utils/elog.h.html#LN150"><span class='Ref_to_Func'>errdetail_plural</span></a><span class='Parentheses'>(</span><span class='String'>"There is %d subscription."</span><span class='Delimiter'>, 
</span>                                  <span class='String'>"There are %d subscriptions."</span><span class='Delimiter'>, 
</span>                                  <a href="dbcommands.c.html#LN789"><span class='Ref_To_Local'>nsubscriptions</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN789"><span class='Ref_To_Local'>nsubscriptions</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove the database's tuple from pg_database. 
     */ 
</span>    <a href="dbcommands.c.html#LN784"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN54"><span class='Ref_to_EnumConst'>DATABASEOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN784"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for database %u"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN783"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN784"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN784"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete any comments or security labels associated with the database. 
     */ 
</span>    <a href="../../include/commands/comment.h.html#LN38"><span class='Ref_to_Proto'>DeleteSharedComments</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/commands/seclabel.h.html#LN21"><span class='Ref_to_Proto'>DeleteSharedSecurityLabel</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove settings associated with this database 
     */ 
</span>    <a href="../../include/catalog/pg_db_role_setting.h.html#LN64"><span class='Ref_to_Proto'>DropSetting</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove shared dependency references for the database. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN274"><span class='Ref_to_Proto'>dropDatabaseDependencies</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Drop db-specific replication slots. 
     */ 
</span>    <a href="../../include/replication/slot.h.html#LN179"><span class='Ref_to_Proto'>ReplicationSlotsDropDBSlots</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Drop pages for this database that are in the shared buffer cache. This 
     * is important to ensure that no remaining backend tries to write out a 
     * dirty buffer to the dead database later... 
     */ 
</span>    <a href="../../include/storage/bufmgr.h.html#LN196"><span class='Ref_to_Proto'>DropDatabaseBuffers</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Tell the stats collector to forget it immediately, too. 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN1148"><span class='Ref_to_Proto'>pgstat_drop_database</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Tell checkpointer to forget any pending fsync and unlink requests for 
     * files in the database; else the fsyncs will fail at next checkpoint, or 
     * worse, it will delete files that belong to a newly created database 
     * with the same OID. 
     */ 
</span>    <a href="../../include/storage/smgr.h.html#LN144"><span class='Ref_to_Proto'>ForgetDatabaseFsyncRequests</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force a checkpoint to make sure the checkpointer has received the 
     * message sent by ForgetDatabaseFsyncRequests. On Windows, this also 
     * ensures that background procs don't hold any open files, which would 
     * cause rmdir() to fail. 
     */ 
</span>    <a href="../../include/postmaster/bgwriter.h.html#LN30"><span class='Ref_to_Proto'>RequestCheckpoint</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN178"><span class='Ref_to_Const'>CHECKPOINT_IMMEDIATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN179"><span class='Ref_to_Const'>CHECKPOINT_FORCE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN183"><span class='Ref_to_Const'>CHECKPOINT_WAIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove all tablespace subdirs belonging to the database. 
     */ 
</span>    <a href="dbcommands.c.html#LN89"><span class='Ref_to_Proto'>remove_dbtablespaces</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN781"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close pg_database, but keep lock till commit. 
     */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN783"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force synchronous commit, thus minimizing the window between removal of 
     * the database files and committal of the transaction. If we crash before 
     * committing, we'll have a DB that's gone on disk but still there 
     * according to pg_database, which is not good. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN347"><span class='Ref_to_Proto'>ForceSyncCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dropdb &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Rename database 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN976"></a><span class='Declare_Function'>RenameDatabase</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>oldname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN978"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>db_id</span><span class='Delimiter'>; 
</span><a name="LN979"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN980"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN981"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>notherbackends</span><span class='Delimiter'>; 
</span><a name="LN982"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>npreparedxacts</span><span class='Delimiter'>; 
</span><a name="LN983"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up the target database's OID, and get exclusive lock on it. We 
     * need this for the same reasons as DROP DATABASE. 
     */ 
</span>    <a href="dbcommands.c.html#LN980"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN82"><span class='Ref_to_Proto'>get_db_info</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>oldname</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>oldname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* must be owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                       <a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>oldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* must have createdb rights */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN88"><span class='Ref_to_Proto'>have_createdb_privilege</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to rename database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure the new name doesn't exist.  See notes for same error in 
     * CREATE DATABASE. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands.h.html#LN28"><span class='Ref_to_Proto'>get_database_oid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>newname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" already exists"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX Client applications probably store the current database somewhere, 
     * so renaming it could cause confusion.  On the other hand, there may not 
     * be an actual problem besides a little confusion, so think about this 
     * and decide. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"current database cannot be renamed"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure the database does not have active sessions.  This is the same 
     * concern as above, but applied to other sessions. 
     * 
     * As in CREATE DATABASE, check this after other error conditions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/procarray.h.html#LN114"><span class='Ref_to_Proto'>CountOtherDBBackends</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN981"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN982"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" is being accessed by other users"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>oldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="dbcommands.c.html#LN91"><span class='Ref_to_Proto'>errdetail_busy_db</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN981"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN982"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* rename */ 
</span>    <a href="dbcommands.c.html#LN979"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN54"><span class='Ref_to_EnumConst'>DATABASEOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN979"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for database %u"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/builtins.h.html#LN40"><span class='Ref_to_Proto'>namestrcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(((</span><a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN979"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>datname<span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN976"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN980"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN979"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN979"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN983"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN978"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close pg_database, but keep lock till commit. 
     */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN980"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN983"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RenameDatabase &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ALTER DATABASE SET TABLESPACE 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1065"></a><span class='Declare_Function'>movedb</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tblspcname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1067"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>db_id</span><span class='Delimiter'>; 
</span><a name="LN1068"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pgdbrel</span><span class='Delimiter'>; 
</span><a name="LN1069"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>notherbackends</span><span class='Delimiter'>; 
</span><a name="LN1070"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>npreparedxacts</span><span class='Delimiter'>; 
</span><a name="LN1071"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>oldtuple</span><span class='Delimiter'>, 
</span><a name="LN1072"></a>                <span class='Declare_Local'>newtuple</span><span class='Delimiter'>; 
</span><a name="LN1073"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>src_tblspcoid</span><span class='Delimiter'>, 
</span><a name="LN1074"></a>                <span class='Declare_Local'>dst_tblspcoid</span><span class='Delimiter'>; 
</span><a name="LN1075"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_record</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1076"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_record_nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1077"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_record_repl</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1078"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scankey</span><span class='Delimiter'>; 
</span><a name="LN1079"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sysscan</span><span class='Delimiter'>; 
</span><a name="LN1080"></a>    <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span><a name="LN1081"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>src_dbpath</span><span class='Delimiter'>; 
</span><a name="LN1082"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dst_dbpath</span><span class='Delimiter'>; 
</span><a name="LN1083"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dstdir</span><span class='Delimiter'>; 
</span><a name="LN1084"></a>    <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlde</span><span class='Delimiter'>; 
</span><a name="LN1085"></a>    <a href="dbcommands.c.html#LN72"><span class='Ref_to_Typedef'>movedb_failure_params</span></a> <span class='Declare_Local'>fparms</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up the target database's OID, and get exclusive lock on it. We 
     * need this to ensure that no new backend starts up in the database while 
     * we are moving it, and that no one is using it as a CREATE DATABASE 
     * template or trying to delete it. 
     */ 
</span>    <a href="dbcommands.c.html#LN1068"><span class='Ref_To_Local'>pgdbrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN82"><span class='Ref_to_Proto'>get_db_info</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                   <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1073"><span class='Ref_To_Local'>src_tblspcoid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We actually need a session lock, so that the lock will persist across 
     * the commit/restart below.  (We could almost get away with letting the 
     * lock be released at commit, except that someone could try to move 
     * relations of the DB back into the old directory while we rmtree() it.) 
     */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN98"><span class='Ref_to_Proto'>LockSharedObjectForSession</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Permission checks 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                       <a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Obviously can't move the tables of my own database 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot change the tablespace of the currently open database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get tablespace's oid 
     */ 
</span>    <a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>tblspcname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Permission checks 
     */ 
</span>    <a href="dbcommands.c.html#LN1080"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN290"><span class='Ref_to_Proto'>pg_tablespace_aclcheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                       <a href="../../include/nodes/parsenodes.h.html#LN81"><span class='Ref_to_Const'>ACL_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1080"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1080"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, 
</span>                       <a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>tblspcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * pg_global must never be the default tablespace 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_global cannot be used as default tablespace"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No-op if same tablespace 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1073"><span class='Ref_To_Local'>src_tblspcoid</span></a> <span class='Operator'>== </span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1068"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lmgr.h.html#LN100"><span class='Ref_to_Proto'>UnlockSharedObjectForSession</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                     <a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for other backends in the target database.  (Because we hold the 
     * database lock, no new ones can start after this.) 
     * 
     * As in CREATE DATABASE, check this after other error conditions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/procarray.h.html#LN114"><span class='Ref_to_Proto'>CountOtherDBBackends</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1069"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1070"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" is being accessed by other users"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="dbcommands.c.html#LN91"><span class='Ref_to_Proto'>errdetail_busy_db</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1069"><span class='Ref_To_Local'>notherbackends</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1070"><span class='Ref_To_Local'>npreparedxacts</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get old and new database paths 
     */ 
</span>    <a href="dbcommands.c.html#LN1081"><span class='Ref_To_Local'>src_dbpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1073"><span class='Ref_To_Local'>src_tblspcoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1082"><span class='Ref_To_Local'>dst_dbpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force a checkpoint before proceeding. This will force all dirty 
     * buffers, including those of unlogged tables, out to disk, to ensure 
     * source database is up-to-date on disk for the copy. 
     * FlushDatabaseBuffers() would suffice for that, but we also want to 
     * process any pending unlink requests. Otherwise, the check for existing 
     * files in the target directory might fail unnecessarily, not to mention 
     * that the copy might fail due to source files getting deleted under it. 
     * On Windows, this also ensures that background procs don't hold any open 
     * files, which would cause rmdir() to fail. 
     */ 
</span>    <a href="../../include/postmaster/bgwriter.h.html#LN30"><span class='Ref_to_Proto'>RequestCheckpoint</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN178"><span class='Ref_to_Const'>CHECKPOINT_IMMEDIATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN179"><span class='Ref_to_Const'>CHECKPOINT_FORCE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN183"><span class='Ref_to_Const'>CHECKPOINT_WAIT</span></a> 
                      <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN180"><span class='Ref_to_Const'>CHECKPOINT_FLUSH_ALL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now drop all buffers holding data of the target database; they should 
     * no longer be dirty so DropDatabaseBuffers is safe. 
     * 
     * It might seem that we could just let these buffers age out of shared 
     * buffers naturally, since they should not get referenced anymore.  The 
     * problem with that is that if the user later moves the database back to 
     * its original tablespace, any still-surviving buffers would appear to 
     * contain valid data again --- but they'd be missing any changes made in 
     * the database while it was in the new tablespace.  In any case, freeing 
     * buffers that should never be used again seems worth the cycles. 
     * 
     * Note: it'd be sufficient to get rid of buffers matching db_id and 
     * src_tblspcoid, but bufmgr.c presently provides no API for that. 
     */ 
</span>    <a href="../../include/storage/bufmgr.h.html#LN196"><span class='Ref_to_Proto'>DropDatabaseBuffers</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for existence of files in the target directory, i.e., objects of 
     * this database that are already in the target tablespace.  We can't 
     * allow the move in such a case, because we would need to change those 
     * relations' pg_class.reltablespace entries to zero, and we don't have 
     * access to the DB's pg_class to do so. 
     */ 
</span>    <a href="dbcommands.c.html#LN1083"><span class='Ref_To_Local'>dstdir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1082"><span class='Ref_To_Local'>dst_dbpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1083"><span class='Ref_To_Local'>dstdir</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dbcommands.c.html#LN1084"><span class='Ref_To_Local'>xlde</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1083"><span class='Ref_To_Local'>dstdir</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1082"><span class='Ref_To_Local'>dst_dbpath</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1084"><span class='Ref_To_Local'>xlde</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1084"><span class='Ref_To_Local'>xlde</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"some relations of database \"%s\" are already in tablespace \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>tblspcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You must move them back to the database's default tablespace before using this command."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1083"><span class='Ref_To_Local'>dstdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The directory exists but is empty. We must remove it before using 
         * the copydir function. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>rmdir<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1082"><span class='Ref_To_Local'>dst_dbpath</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not remove directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="dbcommands.c.html#LN1082"><span class='Ref_To_Local'>dst_dbpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dstdir!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Use an ENSURE block to make sure we remove the debris if the copy fails 
     * (eg, due to out-of-disk-space).  This is not a 100% solution, because 
     * of the possibility of failure during transaction commit, but it should 
     * handle most scenarios. 
     */ 
</span>    <a href="dbcommands.c.html#LN1085"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>.</span><a href="dbcommands.c.html#LN74"><span class='Ref_to_Member'>dest_dboid</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1085"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>.</span><a href="dbcommands.c.html#LN75"><span class='Ref_to_Member'>dest_tsoid</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/storage/ipc.h.html#LN46"><span class='Ref_to_Macro'>PG_ENSURE_ERROR_CLEANUP</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN81"><span class='Ref_to_Proto'>movedb_failure_callback</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1085"><span class='Ref_To_Local'>fparms</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Copy files from the old tablespace to the new one 
         */ 
</span>        <a href="../../include/storage/copydir.h.html#LN15"><span class='Ref_to_Proto'>copydir</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1081"><span class='Ref_To_Local'>src_dbpath</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1082"><span class='Ref_To_Local'>dst_dbpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Record the filesystem change in XLOG 
         */ 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1262"></a>            <a href="../../include/commands/dbcommands_xlog.h.html#LN23"><span class='Ref_to_Struct'>xl_dbase_create_rec</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
            <a href="dbcommands.c.html#LN1262"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN26"><span class='Ref_to_Member'>db_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1262"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN27"><span class='Ref_to_Member'>tablespace_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1262"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN28"><span class='Ref_to_Member'>src_db_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1262"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN29"><span class='Ref_to_Member'>src_tablespace_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1073"><span class='Ref_To_Local'>src_tblspcoid</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1262"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands_xlog.h.html#LN23"><span class='Ref_to_Struct'>xl_dbase_create_rec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_DBASE_ID<span class='Delimiter'>, 
</span>                              <a href="../../include/commands/dbcommands_xlog.h.html#LN20"><span class='Ref_to_Const'>XLOG_DBASE_CREATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogrecord.h.html#LN70"><span class='Ref_to_Const'>XLR_SPECIAL_REL_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update the database's pg_database tuple 
         */ 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1078"><span class='Ref_To_Local'>scankey</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/catalog/pg_database.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_database_datname</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1079"><span class='Ref_To_Local'>sysscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1068"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN139"><span class='Ref_to_Const'>DatabaseNameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1078"><span class='Ref_To_Local'>scankey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1071"><span class='Ref_To_Local'>oldtuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1079"><span class='Ref_To_Local'>sysscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1071"><span class='Ref_To_Local'>oldtuple</span></a><span class='Parentheses'>))</span>        <span class='Comment_Single_Line'>/* shouldn't happen... */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1065"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1075"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1075"><span class='Ref_To_Local'>new_record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1076"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1076"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1077"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1077"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1075"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_database_dattablespace</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1074"><span class='Ref_To_Local'>dst_tblspcoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1077"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_database_dattablespace</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1072"><span class='Ref_To_Local'>newtuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1071"><span class='Ref_To_Local'>oldtuple</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1068"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="dbcommands.c.html#LN1075"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>, 
</span>                                     <a href="dbcommands.c.html#LN1076"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1077"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1068"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1071"><span class='Ref_To_Local'>oldtuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1072"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1072"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1079"><span class='Ref_To_Local'>sysscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Force another checkpoint here.  As in CREATE DATABASE, this is to 
         * ensure that we don't have to replay a committed XLOG_DBASE_CREATE 
         * operation, which would cause us to lose any unlogged operations 
         * done in the new DB tablespace before the next checkpoint. 
         */ 
</span>        <a href="../../include/postmaster/bgwriter.h.html#LN30"><span class='Ref_to_Proto'>RequestCheckpoint</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN178"><span class='Ref_to_Const'>CHECKPOINT_IMMEDIATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN179"><span class='Ref_to_Const'>CHECKPOINT_FORCE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN183"><span class='Ref_to_Const'>CHECKPOINT_WAIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Force synchronous commit, thus minimizing the window between 
         * copying the database files and committal of the transaction. If we 
         * crash before committing, we'll leave an orphaned set of files on 
         * disk, which is not fatal but not good either. 
         */ 
</span>        <a href="../../include/access/xact.h.html#LN347"><span class='Ref_to_Proto'>ForceSyncCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Close pg_database, but keep lock till commit. 
         */ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1068"><span class='Ref_To_Local'>pgdbrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/ipc.h.html#LN51"><span class='Ref_to_Macro'>PG_END_ENSURE_ERROR_CLEANUP</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN81"><span class='Ref_to_Proto'>movedb_failure_callback</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1085"><span class='Ref_To_Local'>fparms</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Commit the transaction so that the pg_database update is committed. If 
     * we crash while removing files, the database won't be corrupt, we'll 
     * just leave some orphaned files in the old directory. 
     * 
     * (This is OK because we know we aren't inside a transaction block.) 
     * 
     * XXX would it be safe/better to do this inside the ensure block?  Not 
     * convinced it's a good idea; consider elog just after the transaction 
     * really commits. 
     */ 
</span>    <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Start new transaction for the remaining work; don't need a snapshot */ 
</span>    <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove files from the old tablespace 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1081"><span class='Ref_To_Local'>src_dbpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"some useless files may be left behind in old database directory \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN1081"><span class='Ref_To_Local'>src_dbpath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Record the filesystem change in XLOG 
     */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1361"></a>        <a href="../../include/commands/dbcommands_xlog.h.html#LN32"><span class='Ref_to_Struct'>xl_dbase_drop_rec</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1361"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1361"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN36"><span class='Ref_to_Member'>tablespace_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1073"><span class='Ref_To_Local'>src_tblspcoid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1361"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands_xlog.h.html#LN32"><span class='Ref_to_Struct'>xl_dbase_drop_rec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_DBASE_ID<span class='Delimiter'>, 
</span>                          <a href="../../include/commands/dbcommands_xlog.h.html#LN21"><span class='Ref_to_Const'>XLOG_DBASE_DROP</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogrecord.h.html#LN70"><span class='Ref_to_Const'>XLR_SPECIAL_REL_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now it's safe to release the database lock */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN100"><span class='Ref_to_Proto'>UnlockSharedObjectForSession</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1067"><span class='Ref_To_Local'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end movedb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Error cleanup callback for movedb */ 
</span><span class='Keyword'>static void 
</span><a name="LN1380"></a><span class='Declare_Function'>movedb_failure_callback</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1382"></a>    <a href="dbcommands.c.html#LN72"><span class='Ref_to_Typedef'>movedb_failure_params</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fparms</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN72"><span class='Ref_to_Typedef'>movedb_failure_params</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1380"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1383"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dstpath</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get rid of anything we managed to copy to the target directory */ 
</span>    <a href="dbcommands.c.html#LN1383"><span class='Ref_To_Local'>dstpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1382"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>-&GT;</span><a href="dbcommands.c.html#LN74"><span class='Ref_to_Member'>dest_dboid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1382"><span class='Ref_To_Local'>fparms</span></a><span class='Operator'>-&GT;</span><a href="dbcommands.c.html#LN75"><span class='Ref_to_Member'>dest_tsoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1383"><span class='Ref_To_Local'>dstpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * ALTER DATABASE name ... 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1396"></a><span class='Declare_Function'>AlterDatabase</span><span class='Parentheses'>(</span><a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN3005"><span class='Ref_to_Struct'>AlterDatabaseStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopLevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1398"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1399"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dboid</span><span class='Delimiter'>; 
</span><a name="LN1400"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>, 
</span><a name="LN1401"></a>                <span class='Declare_Local'>newtuple</span><span class='Delimiter'>; 
</span><a name="LN1402"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scankey</span><span class='Delimiter'>; 
</span><a name="LN1403"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1404"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>option</span><span class='Delimiter'>; 
</span><a name="LN1405"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>dbistemplate</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1406"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>dballowconnections</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN1407"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>dbconnlimit</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1408"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>distemplate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1409"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dallowconnections</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1410"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dconnlimit</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1411"></a>    <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>dtablespace</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1412"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>new_record</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1413"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_record_nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1414"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_record_repl</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Extract options from the statement node tree */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1404"><span class='Ref_To_Local'>option</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3009"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1419"></a>        <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>defel</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1404"><span class='Ref_To_Local'>option</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"is_template"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1408"><span class='Ref_To_Local'>distemplate</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1408"><span class='Ref_To_Local'>distemplate</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"allow_connections"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1409"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1409"><span class='Ref_To_Local'>dallowconnections</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"connection_limit"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1410"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1410"><span class='Ref_To_Local'>dconnlimit</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"tablespace"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1411"><span class='Ref_To_Local'>dtablespace</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conflicting or redundant options"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1411"><span class='Ref_To_Local'>dtablespace</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"option \"%s\" not recognized"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1419"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1411"><span class='Ref_To_Local'>dtablespace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * While the SET TABLESPACE syntax doesn't allow any other options, 
         * somebody could write "WITH TABLESPACE ...".  Forbid any other 
         * options from being specified in that case. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3009"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"option \"%s\" cannot be specified with other options"</span><span class='Delimiter'>, 
</span>                      <a href="dbcommands.c.html#LN1411"><span class='Ref_To_Local'>dtablespace</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../pl/plpgsql/src/pl_gram.y.html#LN55"><span class='Ref_to_Macro'>parser_errposition</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1411"><span class='Ref_To_Local'>dtablespace</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN722"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* this case isn't allowed within a transaction block */ 
</span>        <a href="../../include/access/xact.h.html#LN370"><span class='Ref_to_Proto'>PreventTransactionChain</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>isTopLevel</span></a><span class='Delimiter'>, </span><span class='String'>"ALTER DATABASE SET TABLESPACE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN80"><span class='Ref_to_Proto'>movedb</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3008"><span class='Ref_to_Member'>dbname</span></a><span class='Delimiter'>, </span><a href="define.c.html#LN47"><span class='Ref_to_Func'>defGetString</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1411"><span class='Ref_To_Local'>dtablespace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1408"><span class='Ref_To_Local'>distemplate</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN1408"><span class='Ref_To_Local'>distemplate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN1405"><span class='Ref_To_Local'>dbistemplate</span></a> <span class='Operator'>= </span><a href="define.c.html#LN109"><span class='Ref_to_Func'>defGetBoolean</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1408"><span class='Ref_To_Local'>distemplate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1409"><span class='Ref_To_Local'>dallowconnections</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN1409"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>        <a href="dbcommands.c.html#LN1406"><span class='Ref_To_Local'>dballowconnections</span></a> <span class='Operator'>= </span><a href="define.c.html#LN109"><span class='Ref_to_Func'>defGetBoolean</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1409"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1410"><span class='Ref_To_Local'>dconnlimit</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN1410"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN1407"><span class='Ref_To_Local'>dbconnlimit</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN159"><span class='Ref_to_Proto'>defGetInt32</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1410"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1407"><span class='Ref_To_Local'>dbconnlimit</span></a> <span class='Operator'>&LT; -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid connection limit: %d"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1407"><span class='Ref_To_Local'>dbconnlimit</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the old tuple.  We don't need a lock on the database per se, 
     * because we're not going to do anything that would mess up incoming 
     * connections. 
     */ 
</span>    <a href="dbcommands.c.html#LN1398"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1402"><span class='Ref_To_Local'>scankey</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/catalog/pg_database.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_database_datname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3008"><span class='Ref_to_Member'>dbname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1403"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1398"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN139"><span class='Ref_to_Const'>DatabaseNameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1402"><span class='Ref_To_Local'>scankey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1400"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1403"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1400"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3008"><span class='Ref_to_Member'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN1399"><span class='Ref_To_Local'>dboid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1400"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1400"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                       <a href="dbcommands.c.html#LN1396"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3008"><span class='Ref_to_Member'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In order to avoid getting locked out and having to go through 
     * standalone mode, we refuse to disallow connections to the database 
     * we're currently connected to.  Lockout can still happen with concurrent 
     * sessions but the likeliness of that is not high enough to worry about. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN1406"><span class='Ref_To_Local'>dballowconnections</span></a> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN1399"><span class='Ref_To_Local'>dboid</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot disallow connections for current database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build an updated tuple, perusing the information just obtained 
     */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1412"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1412"><span class='Ref_To_Local'>new_record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1413"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1413"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1414"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1414"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1408"><span class='Ref_To_Local'>distemplate</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN1412"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN68"><span class='Ref_to_Const'>Anum_pg_database_datistemplate</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1405"><span class='Ref_To_Local'>dbistemplate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1414"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN68"><span class='Ref_to_Const'>Anum_pg_database_datistemplate</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1409"><span class='Ref_To_Local'>dallowconnections</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN1412"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN69"><span class='Ref_to_Const'>Anum_pg_database_datallowconn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1406"><span class='Ref_To_Local'>dballowconnections</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1414"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN69"><span class='Ref_to_Const'>Anum_pg_database_datallowconn</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1410"><span class='Ref_To_Local'>dconnlimit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN1412"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_database_datconnlimit</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1407"><span class='Ref_To_Local'>dbconnlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1414"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN70"><span class='Ref_to_Const'>Anum_pg_database_datconnlimit</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="dbcommands.c.html#LN1401"><span class='Ref_To_Local'>newtuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1400"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1398"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1412"><span class='Ref_To_Local'>new_record</span></a><span class='Delimiter'>, 
</span>                                 <a href="dbcommands.c.html#LN1413"><span class='Ref_To_Local'>new_record_nulls</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1414"><span class='Ref_To_Local'>new_record_repl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1398"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1400"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1401"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1401"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1403"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close pg_database, but keep lock till commit */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1398"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN1399"><span class='Ref_To_Local'>dboid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AlterDatabase &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ALTER DATABASE name SET ... 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1574"></a><span class='Declare_Function'>AlterDatabaseSet</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN3012"><span class='Ref_to_Struct'>AlterDatabaseSetStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1576"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>datid</span> <span class='Operator'>= </span><a href="../../include/commands/dbcommands.h.html#LN28"><span class='Ref_to_Proto'>get_database_oid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1574"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3015"><span class='Ref_to_Member'>dbname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Obtain a lock on the database and make sure it didn't go away in the 
     * meantime. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN270"><span class='Ref_to_Proto'>shdepLockAndCheckObject</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1576"><span class='Ref_To_Local'>datid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1576"><span class='Ref_To_Local'>datid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                       <a href="dbcommands.c.html#LN1574"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3015"><span class='Ref_to_Member'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../catalog/pg_db_role_setting.c.html#LN22"><span class='Ref_to_Func'>AlterSetting</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1576"><span class='Ref_To_Local'>datid</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1574"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3016"><span class='Ref_to_Member'>setstmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lmgr.h.html#LN95"><span class='Ref_to_Proto'>UnlockSharedObject</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1576"><span class='Ref_To_Local'>datid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN1576"><span class='Ref_To_Local'>datid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AlterDatabaseSet &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ALTER DATABASE name OWNER TO newowner 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN1600"></a><span class='Declare_Function'>AlterDatabaseOwner</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newOwnerId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1602"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>db_id</span><span class='Delimiter'>; 
</span><a name="LN1603"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1604"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1605"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scankey</span><span class='Delimiter'>; 
</span><a name="LN1606"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1607"></a>    <a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a> <span class='Declare_Local'>datForm</span><span class='Delimiter'>; 
</span><a name="LN1608"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the old tuple.  We don't need a lock on the database per se, 
     * because we're not going to do anything that would mess up incoming 
     * connections. 
     */ 
</span>    <a href="dbcommands.c.html#LN1604"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1605"><span class='Ref_To_Local'>scankey</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/catalog/pg_database.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_database_datname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1606"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1604"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN139"><span class='Ref_to_Const'>DatabaseNameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1605"><span class='Ref_To_Local'>scankey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1606"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN1602"><span class='Ref_To_Local'>db_id</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1607"><span class='Ref_To_Local'>datForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the new owner is the same as the existing owner, consider the 
     * command to have succeeded.  This is to be consistent with other 
     * objects. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1607"><span class='Ref_To_Local'>datForm</span></a><span class='Operator'>-&GT;</span>datdba <span class='Operator'>!= </span><a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1638"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>repl_val</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1639"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>repl_null</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1640"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>repl_repl</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN62"><span class='Ref_to_Const'>Natts_pg_database</span></a><span class='Delimiter'>]; 
</span><a name="LN1641"></a>        <a href="../../include/utils/acl.h.html#LN98"><span class='Ref_to_Typedef'>Acl</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>newAcl</span><span class='Delimiter'>; 
</span><a name="LN1642"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>aclDatum</span><span class='Delimiter'>; 
</span><a name="LN1643"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull</span><span class='Delimiter'>; 
</span><a name="LN1644"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtuple</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Otherwise, must be owner of the existing object */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
            <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                           <a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Must be able to become new owner */ 
</span>        <a href="../../include/utils/acl.h.html#LN233"><span class='Ref_to_Proto'>check_is_member_of_role</span></a><span class='Parentheses'>(</span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * must have createdb rights 
         * 
         * NOTE: This is different from other alter-owner checks in that the 
         * current user is checked for createdb privileges instead of the 
         * destination owner.  This is consistent with the CREATE case for 
         * databases.  Because superusers will always have this right, we need 
         * no special case for them. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN88"><span class='Ref_to_Proto'>have_createdb_privilege</span></a><span class='Parentheses'>())</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to change owner of database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1639"><span class='Ref_To_Local'>repl_null</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1639"><span class='Ref_To_Local'>repl_null</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1640"><span class='Ref_To_Local'>repl_repl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1640"><span class='Ref_To_Local'>repl_repl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1640"><span class='Ref_To_Local'>repl_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN64"><span class='Ref_to_Const'>Anum_pg_database_datdba</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN1638"><span class='Ref_To_Local'>repl_val</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN64"><span class='Ref_to_Const'>Anum_pg_database_datdba</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Determine the modified ACL for the new owner.  This is only 
         * necessary when the ACL is non-null. 
         */ 
</span>        <a href="dbcommands.c.html#LN1642"><span class='Ref_To_Local'>aclDatum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/catalog/pg_database.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_database_datacl</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1604"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="dbcommands.c.html#LN1643"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dbcommands.c.html#LN1643"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dbcommands.c.html#LN1641"><span class='Ref_To_Local'>newAcl</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN217"><span class='Ref_to_Proto'>aclnewowner</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN112"><span class='Ref_to_Macro'>DatumGetAclP</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1642"><span class='Ref_To_Local'>aclDatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="dbcommands.c.html#LN1607"><span class='Ref_To_Local'>datForm</span></a><span class='Operator'>-&GT;</span>datdba<span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1640"><span class='Ref_To_Local'>repl_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_database_datacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1638"><span class='Ref_To_Local'>repl_val</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_database.h.html#LN75"><span class='Ref_to_Const'>Anum_pg_database_datacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1641"><span class='Ref_To_Local'>newAcl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="dbcommands.c.html#LN1644"><span class='Ref_To_Local'>newtuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1604"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1638"><span class='Ref_To_Local'>repl_val</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1639"><span class='Ref_To_Local'>repl_null</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1640"><span class='Ref_To_Local'>repl_repl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1604"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1644"><span class='Ref_To_Local'>newtuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1644"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1644"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update owner dependency reference */ 
</span>        <a href="../../include/catalog/dependency.h.html#LN259"><span class='Ref_to_Proto'>changeDependencyOnOwner</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="dbcommands.c.html#LN1600"><span class='Ref_to_Parameter'>newOwnerId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if datForm-&GT;datdba!=newO... &raquo; </span> 
 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1603"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1608"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1602"><span class='Ref_To_Local'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1606"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close pg_database, but keep lock till commit */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1604"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN1608"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AlterDatabaseOwner &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Helper functions 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Look up info about the database named "name".  If the database exists, 
 * obtain the specified lock type on it, fill in any of the remaining 
 * parameters that aren't NULL, and return TRUE.  If no such database, 
 * return FALSE. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1724"></a><span class='Declare_Function'>get_db_info</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN1725"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbIdP</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ownerIdP</span><span class='Delimiter'>, 
</span><a name="LN1726"></a>            <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>encodingP</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbIsTemplateP</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbAllowConnP</span><span class='Delimiter'>, 
</span><a name="LN1727"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbLastSysOidP</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbFrozenXidP</span><span class='Delimiter'>, 
</span><a name="LN1728"></a>            <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbMinMultiP</span><span class='Delimiter'>, 
</span><a name="LN1729"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbTablespace</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>dbCollate</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>dbCtype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1731"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1732"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>relation</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Caller may wish to grab a better lock on pg_database beforehand... */ 
</span>    <a href="dbcommands.c.html#LN1732"><span class='Ref_To_Local'>relation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop covers the rare case where the database is renamed before we can 
     * lock it.  We try again just in case we can find a new one of the same 
     * name. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1746"></a>        <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scanKey</span><span class='Delimiter'>; 
</span><a name="LN1747"></a>        <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1748"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1749"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbOid</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * there's no syscache for database-indexed-by-name, so must do it the 
         * hard way 
         */ 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1746"><span class='Ref_To_Local'>scanKey</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/catalog/pg_database.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_database_datname</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1747"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1732"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN139"><span class='Ref_to_Const'>DatabaseNameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1746"><span class='Ref_To_Local'>scanKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1747"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* definitely no database of that name */ 
</span>            <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1747"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="dbcommands.c.html#LN1749"><span class='Ref_To_Local'>dbOid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1747"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now that we have a database OID, we can try to lock the DB. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/storage/lmgr.h.html#LN93"><span class='Ref_to_Proto'>LockSharedObject</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1749"><span class='Ref_To_Local'>dbOid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * And now, re-fetch the tuple by OID.  If it's still there and still 
         * the same name, we win; else, drop the lock and loop back to try 
         * again. 
         */ 
</span>        <a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN54"><span class='Ref_to_EnumConst'>DATABASEOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1749"><span class='Ref_To_Local'>dbOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1790"></a>            <a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a> <span class='Declare_Local'>dbform</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datname<span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* oid of the database */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1725"><span class='Ref_to_Parameter'>dbIdP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1725"><span class='Ref_to_Parameter'>dbIdP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1749"><span class='Ref_To_Local'>dbOid</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* oid of the owner */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1725"><span class='Ref_to_Parameter'>ownerIdP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1725"><span class='Ref_to_Parameter'>ownerIdP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datdba<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* character encoding */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1726"><span class='Ref_to_Parameter'>encodingP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1726"><span class='Ref_to_Parameter'>encodingP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>encoding<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* allowed as template? */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1726"><span class='Ref_to_Parameter'>dbIsTemplateP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1726"><span class='Ref_to_Parameter'>dbIsTemplateP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datistemplate<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* allowing connections? */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1726"><span class='Ref_to_Parameter'>dbAllowConnP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1726"><span class='Ref_to_Parameter'>dbAllowConnP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datallowconn<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* last system OID used in database */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1727"><span class='Ref_to_Parameter'>dbLastSysOidP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1727"><span class='Ref_to_Parameter'>dbLastSysOidP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datlastsysoid<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* limit of frozen XIDs */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1727"><span class='Ref_to_Parameter'>dbFrozenXidP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1727"><span class='Ref_to_Parameter'>dbFrozenXidP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datfrozenxid<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* minimum MultixactId */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1728"><span class='Ref_to_Parameter'>dbMinMultiP</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1728"><span class='Ref_to_Parameter'>dbMinMultiP</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datminmxid<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* default tablespace for this database */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1729"><span class='Ref_to_Parameter'>dbTablespace</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1729"><span class='Ref_to_Parameter'>dbTablespace</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>dattablespace<span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* default locale settings for this database */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1729"><span class='Ref_to_Parameter'>dbCollate</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1729"><span class='Ref_to_Parameter'>dbCollate</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datcollate<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1729"><span class='Ref_to_Parameter'>dbCtype</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="dbcommands.c.html#LN1729"><span class='Ref_to_Parameter'>dbCtype</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1790"><span class='Ref_To_Local'>dbform</span></a><span class='Operator'>-&GT;</span>datctype<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dbcommands.c.html#LN1731"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(name,NameStr(d... &raquo; </span> 
            <span class='Comment_Multi_Line'>/* can only get here if it was just renamed */ 
</span>            <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1748"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HeapTupleIsValid(tupl... &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>!= </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/storage/lmgr.h.html#LN95"><span class='Ref_to_Proto'>UnlockSharedObject</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1749"><span class='Ref_To_Local'>dbOid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1724"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1732"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN1731"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_db_info &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Check if current user has createdb privileges */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1845"></a><span class='Declare_Function'>have_createdb_privilege</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1847"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1848"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>utup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Superusers can always do everything */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN1848"><span class='Ref_To_Local'>utup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN44"><span class='Ref_to_EnumConst'>AUTHOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1848"><span class='Ref_To_Local'>utup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN1847"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_authid.h.html#LN71"><span class='Ref_to_Typedef'>Form_pg_authid</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1848"><span class='Ref_To_Local'>utup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>rolcreatedb<span class='Delimiter'>; 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1848"><span class='Ref_To_Local'>utup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="dbcommands.c.html#LN1847"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Remove tablespace directories 
 * 
 * We don't know what tablespaces db_id is using, so iterate through all 
 * tablespaces removing &LT;tablespace&GT;/db_id 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1870"></a><span class='Declare_Function'>remove_dbtablespaces</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>db_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1872"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1873"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1874"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN1872"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1873"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1872"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dbcommands.c.html#LN1874"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1873"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1880"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dsttablespace</span> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1874"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1881"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dstpath</span><span class='Delimiter'>; 
</span><a name="LN1882"></a>        <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Don't mess with the global tablespace */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1880"><span class='Ref_To_Local'>dsttablespace</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1881"><span class='Ref_To_Local'>dstpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1870"><span class='Ref_to_Parameter'>db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1880"><span class='Ref_To_Local'>dsttablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1881"><span class='Ref_To_Local'>dstpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1882"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| !</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1882"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Assume we can ignore it */ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1881"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1881"><span class='Ref_To_Local'>dstpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"some useless files may be left behind in old database directory \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN1881"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Record the filesystem change in XLOG */ 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1904"></a>            <a href="../../include/commands/dbcommands_xlog.h.html#LN32"><span class='Ref_to_Struct'>xl_dbase_drop_rec</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
            <a href="dbcommands.c.html#LN1904"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1870"><span class='Ref_to_Parameter'>db_id</span></a><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1904"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/dbcommands_xlog.h.html#LN36"><span class='Ref_to_Member'>tablespace_id</span></a> <span class='Operator'>= </span><a href="dbcommands.c.html#LN1880"><span class='Ref_To_Local'>dsttablespace</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1904"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands_xlog.h.html#LN32"><span class='Ref_to_Struct'>xl_dbase_drop_rec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_DBASE_ID<span class='Delimiter'>, 
</span>                              <a href="../../include/commands/dbcommands_xlog.h.html#LN21"><span class='Ref_to_Const'>XLOG_DBASE_DROP</span></a> <span class='Operator'>| </span><a href="../../include/access/xlogrecord.h.html#LN70"><span class='Ref_to_Const'>XLR_SPECIAL_REL_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1881"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=heap_getnext(s... &raquo; </span> 
 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1873"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1872"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end remove_dbtablespaces &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check for existing files that conflict with a proposed new DB OID; 
 * return TRUE if there are any 
 * 
 * If there were a subdirectory in any tablespace matching the proposed new 
 * OID, we'd get a create failure due to the duplicate name ... and then we'd 
 * try to remove that already-existing subdirectory during the cleanup in 
 * remove_dbtablespaces.  Nuking existing files seems like a bad idea, so 
 * instead we make this extra check before settling on the OID of the new 
 * database.  This exactly parallels what GetNewRelFileNode() does for table 
 * relfilenode values. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1936"></a><span class='Declare_Function'>check_db_file_conflict</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>db_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1938"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1939"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1940"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1941"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN1939"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN1940"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1939"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dbcommands.c.html#LN1941"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1940"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1947"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dsttablespace</span> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1941"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1948"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dstpath</span><span class='Delimiter'>; 
</span><a name="LN1949"></a>        <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Don't mess with the global tablespace */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1947"><span class='Ref_To_Local'>dsttablespace</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN1948"><span class='Ref_To_Local'>dstpath</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1936"><span class='Ref_to_Parameter'>db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1947"><span class='Ref_To_Local'>dsttablespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1948"><span class='Ref_To_Local'>dstpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN1949"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Found a conflicting file (or directory, whatever) */ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1948"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dbcommands.c.html#LN1938"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1948"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=heap_getnext(s... &raquo; </span> 
 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1940"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1939"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN1938"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_db_file_conflict &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Issue a suitable errdetail message for a busy database 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1978"></a><span class='Declare_Function'>errdetail_busy_db</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>notherbackends</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>npreparedxacts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>notherbackends</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>npreparedxacts</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't deal with singular versus plural here, since gettext 
         * doesn't support multiple plurals in one string. 
         */ 
</span>        <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"There are %d other session(s) and %d prepared transaction(s) using the database."</span><span class='Delimiter'>, 
</span>                  <a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>notherbackends</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>npreparedxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>notherbackends</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN150"><span class='Ref_to_Func'>errdetail_plural</span></a><span class='Parentheses'>(</span><span class='String'>"There is %d other session using the database."</span><span class='Delimiter'>, 
</span>                         <span class='String'>"There are %d other sessions using the database."</span><span class='Delimiter'>, 
</span>                         <a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>notherbackends</span></a><span class='Delimiter'>, 
</span>                         <a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>notherbackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/utils/elog.h.html#LN150"><span class='Ref_to_Func'>errdetail_plural</span></a><span class='Parentheses'>(</span><span class='String'>"There is %d prepared transaction using the database."</span><span class='Delimiter'>, 
</span>                    <span class='String'>"There are %d prepared transactions using the database."</span><span class='Delimiter'>, 
</span>                         <a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>npreparedxacts</span></a><span class='Delimiter'>, 
</span>                         <a href="dbcommands.c.html#LN1978"><span class='Ref_to_Parameter'>npreparedxacts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* just to keep ereport macro happy */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end errdetail_busy_db &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_database_oid - given a database name, look up the OID 
 * 
 * If missing_ok is false, throw an error if database name not found.  If 
 * true, just return InvalidOid. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN2008"></a><span class='Declare_Function'>get_database_oid</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2010"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_database</span><span class='Delimiter'>; 
</span><a name="LN2011"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN2012"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN2013"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>dbtuple</span><span class='Delimiter'>; 
</span><a name="LN2014"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>oid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There's no syscache for pg_database indexed by name, so we must look 
     * the hard way. 
     */ 
</span>    <a href="dbcommands.c.html#LN2010"><span class='Ref_To_Local'>pg_database</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dbcommands.c.html#LN2011"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_database.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_database_datname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2008"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dbcommands.c.html#LN2012"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2010"><span class='Ref_To_Local'>pg_database</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN139"><span class='Ref_to_Const'>DatabaseNameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2011"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN2013"><span class='Ref_To_Local'>dbtuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2012"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We assume that there can be at most one matching tuple */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2013"><span class='Ref_To_Local'>dbtuple</span></a><span class='Parentheses'>))</span> 
        <a href="dbcommands.c.html#LN2014"><span class='Ref_To_Local'>oid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2013"><span class='Ref_To_Local'>dbtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dbcommands.c.html#LN2014"><span class='Ref_To_Local'>oid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2012"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2010"><span class='Ref_To_Local'>pg_database</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2014"><span class='Ref_To_Local'>oid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="dbcommands.c.html#LN2008"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_DATABASE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="dbcommands.c.html#LN2008"><span class='Ref_to_Parameter'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN2014"><span class='Ref_To_Local'>oid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_database_oid &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * get_database_name - given a database OID, look up the name 
 * 
 * Returns a palloc'd string, or NULL if no such database. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN2055"></a><span class='Declare_Function'>get_database_name</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2057"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>dbtuple</span><span class='Delimiter'>; 
</span><a name="LN2058"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="dbcommands.c.html#LN2057"><span class='Ref_To_Local'>dbtuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN54"><span class='Ref_to_EnumConst'>DATABASEOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2055"><span class='Ref_to_Parameter'>dbid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2057"><span class='Ref_To_Local'>dbtuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dbcommands.c.html#LN2058"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(((</span><a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2057"><span class='Ref_To_Local'>dbtuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>datname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2057"><span class='Ref_To_Local'>dbtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="dbcommands.c.html#LN2058"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dbcommands.c.html#LN2058"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * DATABASE resource manager's routines 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2076"></a><span class='Declare_Function'>dbase_redo</span><span class='Parentheses'>(</span><a href="../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2078"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2076"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& ~</span><a href="../../include/access/xlogrecord.h.html#LN61"><span class='Ref_to_Const'>XLR_INFO_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Backup blocks are not used in dbase records */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/xlogreader.h.html#LN221"><span class='Ref_to_Macro'>XLogRecHasAnyBlockRefs</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2076"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2078"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../include/commands/dbcommands_xlog.h.html#LN20"><span class='Ref_to_Const'>XLOG_DBASE_CREATE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2085"></a>        <a href="../../include/commands/dbcommands_xlog.h.html#LN23"><span class='Ref_to_Struct'>xl_dbase_create_rec</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands_xlog.h.html#LN23"><span class='Ref_to_Struct'>xl_dbase_create_rec</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2076"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2086"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>src_path</span><span class='Delimiter'>; 
</span><a name="LN2087"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dst_path</span><span class='Delimiter'>; 
</span><a name="LN2088"></a>        <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN2086"><span class='Ref_To_Local'>src_path</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2085"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN28"><span class='Ref_to_Member'>src_db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2085"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN29"><span class='Ref_to_Member'>src_tablespace_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dbcommands.c.html#LN2087"><span class='Ref_To_Local'>dst_path</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2085"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN26"><span class='Ref_to_Member'>db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2085"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN27"><span class='Ref_to_Member'>tablespace_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Our theory for replaying a CREATE is to forcibly drop the target 
         * subdirectory if present, then re-copy the source data. This may be 
         * more work than needed, but it is simple to implement. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2087"><span class='Ref_To_Local'>dst_path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dbcommands.c.html#LN2088"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2088"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2087"><span class='Ref_To_Local'>dst_path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                <span class='Comment_Multi_Line'>/* If this failed, copydir() below is going to error. */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"some useless files may be left behind in old database directory \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="dbcommands.c.html#LN2087"><span class='Ref_To_Local'>dst_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Force dirty buffers out to disk, to ensure source database is 
         * up-to-date for the copy. 
         */ 
</span>        <a href="../../include/storage/bufmgr.h.html#LN192"><span class='Ref_to_Proto'>FlushDatabaseBuffers</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2085"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN28"><span class='Ref_to_Member'>src_db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Copy this subdirectory to the new location 
         * 
         * We don't need to copy subdirectories 
         */ 
</span>        <a href="../../include/storage/copydir.h.html#LN15"><span class='Ref_to_Proto'>copydir</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2086"><span class='Ref_To_Local'>src_path</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2087"><span class='Ref_To_Local'>dst_path</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_DBASE_CREA... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2078"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../include/commands/dbcommands_xlog.h.html#LN21"><span class='Ref_to_Const'>XLOG_DBASE_DROP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2122"></a>        <a href="../../include/commands/dbcommands_xlog.h.html#LN32"><span class='Ref_to_Struct'>xl_dbase_drop_rec</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/dbcommands_xlog.h.html#LN32"><span class='Ref_to_Struct'>xl_dbase_drop_rec</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2076"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2123"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dst_path</span><span class='Delimiter'>; 
</span> 
        <a href="dbcommands.c.html#LN2123"><span class='Ref_To_Local'>dst_path</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN36"><span class='Ref_to_Member'>tablespace_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Lock database while we resolve conflicts to ensure that 
             * InitPostgres() cannot fully re-execute concurrently. This 
             * avoids backends re-connecting automatically to same database, 
             * which can happen in some cases. 
             * 
             * This will lock out walsenders trying to connect to db-specific 
             * slots for logical decoding too, so it's safe for us to drop 
             * slots. 
             */ 
</span>            <a href="../../include/storage/lmgr.h.html#LN98"><span class='Ref_to_Proto'>LockSharedObjectForSession</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/standby.h.html#LN32"><span class='Ref_to_Proto'>ResolveRecoveryConflictWithDatabase</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Drop any database-specific replication slots */ 
</span>        <a href="../../include/replication/slot.h.html#LN179"><span class='Ref_to_Proto'>ReplicationSlotsDropDBSlots</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Drop pages for this database that are in the shared buffer cache */ 
</span>        <a href="../../include/storage/bufmgr.h.html#LN196"><span class='Ref_to_Proto'>DropDatabaseBuffers</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Also, clean out any fsync requests that might be pending in md.c */ 
</span>        <a href="../../include/storage/smgr.h.html#LN144"><span class='Ref_to_Proto'>ForgetDatabaseFsyncRequests</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Clean out the xlog relcache too */ 
</span>        <a href="../../include/access/xlogutils.h.html#LN21"><span class='Ref_to_Proto'>XLogDropDatabase</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And remove the physical files */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="dbcommands.c.html#LN2123"><span class='Ref_To_Local'>dst_path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"some useless files may be left behind in old database directory \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="dbcommands.c.html#LN2123"><span class='Ref_To_Local'>dst_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Release locks prior to commit. XXX There is a race condition 
             * here that may allow backends to reconnect, but the window for 
             * this is small because the gap between here and commit is mostly 
             * fairly small and it is unlikely that people will be dropping 
             * databases that we are trying to connect to anyway. 
             */ 
</span>            <a href="../../include/storage/lmgr.h.html#LN100"><span class='Ref_to_Proto'>UnlockSharedObjectForSession</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2122"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/dbcommands_xlog.h.html#LN35"><span class='Ref_to_Member'>db_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_DBASE_DROP &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"dbase_redo: unknown op code %u"</span><span class='Delimiter'>, </span><a href="dbcommands.c.html#LN2078"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dbase_redo &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>