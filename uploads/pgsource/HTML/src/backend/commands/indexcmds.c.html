<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\commands\indexcmds.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\commands\indexcmds.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:35 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * indexcmds.c 
 *    POSTGRES define and remove index code. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/commands/indexcmds.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/amapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/index.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_am.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opclass.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_opfamily.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/comment.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/defrem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/nodeFuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/clauses.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/planner.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/var.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_coerce.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_func.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_oper.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/regproc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* non-export function prototypes */ 
</span><a name="LN60"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CheckPredicate</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>predicate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN61"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ComputeIndexAttrs</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Delimiter'>, 
</span><a name="LN62"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typeOidP</span><span class='Delimiter'>, 
</span><a name="LN63"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>collationOidP</span><span class='Delimiter'>, 
</span><a name="LN64"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>classOidP</span><span class='Delimiter'>, 
</span><a name="LN65"></a>                  <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colOptionP</span><span class='Delimiter'>, 
</span><a name="LN66"></a>                  <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attList</span><span class='Delimiter'>, 
</span><a name="LN67"></a>                  <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>exclusionOpNames</span><span class='Delimiter'>, 
</span><a name="LN68"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Delimiter'>, 
</span><a name="LN69"></a>                  <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>accessMethodName</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>accessMethodId</span><span class='Delimiter'>, 
</span><a name="LN70"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>amcanorder</span><span class='Delimiter'>, 
</span><a name="LN71"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>isconstraint</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN72"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>ChooseIndexName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tabname</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>namespaceId</span><span class='Delimiter'>, 
</span><a name="LN73"></a>                <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colnames</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>exclusionOpNames</span><span class='Delimiter'>, 
</span><a name="LN74"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>primary</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isconstraint</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN75"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>ChooseIndexNameAddition</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colnames</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN76"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ChooseIndexColumnNames</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexElems</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN77"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RangeVarCallbackForReindexIndex</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN78"></a>                                <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldRelId</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CheckIndexCompatible 
 *      Determine whether an existing index definition is compatible with a 
 *      prospective index definition, such that the existing index storage 
 *      could become the storage of the new index, avoiding a rebuild. 
 * 
 * 'heapRelation': the relation the index would apply to. 
 * 'accessMethodName': name of the AM to use. 
 * 'attributeList': a list of IndexElem specifying columns and expressions 
 *      to index on. 
 * 'exclusionOpNames': list of names of exclusion-constraint operators, 
 *      or NIL if not an exclusion constraint. 
 * 
 * This is tailored to the needs of ALTER TABLE ALTER TYPE, which recreates 
 * any indexes that depended on a changing column from their pg_get_indexdef 
 * or pg_get_constraintdef definitions.  We omit some of the sanity checks of 
 * DefineIndex.  We assume that the old and new indexes have the same number 
 * of columns and that if one has an expression column or predicate, both do. 
 * Errors arising from the attribute list still apply. 
 * 
 * Most column type changes that can skip a table rewrite do not invalidate 
 * indexes.  We acknowledge this when all operator classes, collations and 
 * exclusion operators match.  Though we could further permit intra-opfamily 
 * changes for btree and hash indexes, that adds subtle complexity with no 
 * concrete benefit for core types. 
 
 * When a comparison or exclusion operator has a polymorphic input type, the 
 * actual input types must also match.  This defends against the possibility 
 * that operators could vary behavior in response to get_fn_expr_argtype(). 
 * At present, this hazard is theoretical: check_exclusion_constraint() and 
 * all core index access methods decline to set fn_expr for such calls. 
 * 
 * We do not yet implement a test to verify compatibility of expression 
 * columns or predicates, so assume any such index is incompatible. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN116"></a><span class='Declare_Function'>CheckIndexCompatible</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldId</span><span class='Delimiter'>, 
</span><a name="LN117"></a>                     <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>accessMethodName</span><span class='Delimiter'>, 
</span><a name="LN118"></a>                     <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attributeList</span><span class='Delimiter'>, 
</span><a name="LN119"></a>                     <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>exclusionOpNames</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN121"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isconstraint</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>typeObjectId</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>collationObjectId</span><span class='Delimiter'>; 
</span><a name="LN124"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>classObjectId</span><span class='Delimiter'>; 
</span><a name="LN125"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>accessMethodId</span><span class='Delimiter'>; 
</span><a name="LN126"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relationId</span><span class='Delimiter'>; 
</span><a name="LN127"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN128"></a>    <a href="../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a> <span class='Declare_Local'>indexForm</span><span class='Delimiter'>; 
</span><a name="LN129"></a>    <a href="../../include/catalog/pg_am.h.html#LN45"><span class='Ref_to_Typedef'>Form_pg_am</span></a>  <span class='Declare_Local'>accessMethodForm</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <a href="../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amRoutine</span><span class='Delimiter'>; 
</span><a name="LN131"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>amcanorder</span><span class='Delimiter'>; 
</span><a name="LN132"></a>    <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>coloptions</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indexInfo</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numberOfAttributes</span><span class='Delimiter'>; 
</span><a name="LN135"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>old_natts</span><span class='Delimiter'>; 
</span><a name="LN136"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN137"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN138"></a>    <a href="../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>old_indclass</span><span class='Delimiter'>; 
</span><a name="LN139"></a>    <a href="../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>old_indcollation</span><span class='Delimiter'>; 
</span><a name="LN140"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>irel</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN142"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>d</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Caller should already have the relation locked in some way. */ 
</span>    <a href="indexcmds.c.html#LN126"><span class='Ref_To_Local'>relationId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN116"><span class='Ref_to_Parameter'>oldId</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can pretend isconstraint = false unconditionally.  It only serves to 
     * decide the text of an error message that should never happen for us. 
     */ 
</span>    <a href="indexcmds.c.html#LN121"><span class='Ref_To_Local'>isconstraint</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN118"><span class='Ref_to_Parameter'>attributeList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>&LT;= </span><a href="../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* look up the access method */ 
</span>    <a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN34"><span class='Ref_to_EnumConst'>AMNAME</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN117"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="indexcmds.c.html#LN117"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN125"><span class='Ref_To_Local'>accessMethodId</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN129"><span class='Ref_To_Local'>accessMethodForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_am.h.html#LN45"><span class='Ref_to_Typedef'>Form_pg_am</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN130"><span class='Ref_To_Local'>amRoutine</span></a> <span class='Operator'>= </span><a href="../access/index/amapi.c.html#LN31"><span class='Ref_to_Func'>GetIndexAmRoutine</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN129"><span class='Ref_To_Local'>accessMethodForm</span></a><span class='Operator'>-&GT;</span>amhandler<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN131"><span class='Ref_To_Local'>amcanorder</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN130"><span class='Ref_To_Local'>amRoutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the operator classes, collations, and exclusion operators for 
     * the new index, so we can test whether it's compatible with the existing 
     * one.  Note that ComputeIndexAttrs might fail here, but that's OK: 
     * DefineIndex would have called this function with the same arguments 
     * later on, and it would have failed then anyway. 
     */ 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN136"><span class='Ref_to_Member'>ii_ExpressionsState</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN138"><span class='Ref_to_Member'>ii_PredicateState</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN140"><span class='Ref_to_Member'>ii_ExclusionProcs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN141"><span class='Ref_to_Member'>ii_ExclusionStrats</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN150"><span class='Ref_to_Member'>ii_Context</span></a> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN122"><span class='Ref_To_Local'>typeObjectId</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN123"><span class='Ref_To_Local'>collationObjectId</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN124"><span class='Ref_To_Local'>classObjectId</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN132"><span class='Ref_To_Local'>coloptions</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN61"><span class='Ref_to_Proto'>ComputeIndexAttrs</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN122"><span class='Ref_To_Local'>typeObjectId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN123"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN124"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN132"><span class='Ref_To_Local'>coloptions</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN118"><span class='Ref_to_Parameter'>attributeList</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN119"><span class='Ref_to_Parameter'>exclusionOpNames</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN126"><span class='Ref_To_Local'>relationId</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN117"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN125"><span class='Ref_To_Local'>accessMethodId</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN131"><span class='Ref_To_Local'>amcanorder</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN121"><span class='Ref_To_Local'>isconstraint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* Get the soon-obsolete pg_index tuple. */ 
</span>    <a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN65"><span class='Ref_to_EnumConst'>INDEXRELID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN116"><span class='Ref_to_Parameter'>oldId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for index %u"</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN116"><span class='Ref_to_Parameter'>oldId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN128"><span class='Ref_To_Local'>indexForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't assess expressions or predicates; assume incompatibility. 
     * Also, if the index is invalid for any reason, treat it as incompatible. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../access/common/heaptuple.c.html#LN295"><span class='Ref_to_Func'>heap_attisnull</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_index.h.html#LN91"><span class='Ref_to_Const'>Anum_pg_index_indpred</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>          <a href="../access/common/heaptuple.c.html#LN295"><span class='Ref_to_Func'>heap_attisnull</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_index.h.html#LN90"><span class='Ref_to_Const'>Anum_pg_index_indexprs</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>          <a href="../../include/catalog/pg_index.h.html#LN106"><span class='Ref_to_Macro'>IndexIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN128"><span class='Ref_To_Local'>indexForm</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Any change in operator class or collation breaks compatibility. */ 
</span>    <a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN128"><span class='Ref_To_Local'>indexForm</span></a><span class='Operator'>-&GT;</span>indnatts<span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a> <span class='Operator'>== </span><a href="indexcmds.c.html#LN134"><span class='Ref_To_Local'>numberOfAttributes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN142"><span class='Ref_To_Local'>d</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN65"><span class='Ref_to_EnumConst'>INDEXRELID</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_index.h.html#LN87"><span class='Ref_to_Const'>Anum_pg_index_indcollation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN136"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN136"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN139"><span class='Ref_To_Local'>old_indcollation</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN142"><span class='Ref_To_Local'>d</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN142"><span class='Ref_To_Local'>d</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN65"><span class='Ref_to_EnumConst'>INDEXRELID</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_index.h.html#LN88"><span class='Ref_to_Const'>Anum_pg_index_indclass</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN136"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN136"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN138"><span class='Ref_To_Local'>old_indclass</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN477"><span class='Ref_to_Typedef'>oidvector</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN142"><span class='Ref_To_Local'>d</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN138"><span class='Ref_To_Local'>old_indclass</span></a><span class='Operator'>-&GT;</span><a href="../../include/c.h.html#LN485"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN124"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>, 
</span>                  <a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>           memcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN139"><span class='Ref_To_Local'>old_indcollation</span></a><span class='Operator'>-&GT;</span><a href="../../include/c.h.html#LN485"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN123"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>, 
</span>                  <a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN127"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* For polymorphic opcintype, column type changes break compatibility. */ 
</span>    <a href="indexcmds.c.html#LN140"><span class='Ref_To_Local'>irel</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN116"><span class='Ref_to_Parameter'>oldId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* caller probably has a lock */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/catalog/pg_type.h.html#LN744"><span class='Ref_to_Macro'>IsPolymorphicType</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN97"><span class='Ref_to_Proto'>get_opclass_input_type</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN124"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <a href="indexcmds.c.html#LN140"><span class='Ref_To_Local'>irel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="indexcmds.c.html#LN122"><span class='Ref_To_Local'>typeObjectId</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Any change in exclusion operator selections breaks compatibility. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&& </span><a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN254"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>old_operators</span><span class='Delimiter'>, 
</span><a name="LN255"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>old_procs</span><span class='Delimiter'>; 
</span><a name="LN256"></a>        <a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>old_strats</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/relcache.h.html#LN59"><span class='Ref_to_Proto'>RelationGetExclusionInfo</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN140"><span class='Ref_To_Local'>irel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN254"><span class='Ref_To_Local'>old_operators</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN255"><span class='Ref_To_Local'>old_procs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN256"><span class='Ref_To_Local'>old_strats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span>memcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN254"><span class='Ref_To_Local'>old_operators</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Require an exact input type match for polymorphic operators. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="indexcmds.c.html#LN135"><span class='Ref_To_Local'>old_natts</span></a> <span class='Operator'>&& </span><a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN267"></a>                <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>left</span><span class='Delimiter'>, 
</span><a name="LN268"></a>                            <span class='Declare_Local'>right</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/utils/lsyscache.h.html#LN101"><span class='Ref_to_Proto'>op_input_types</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN133"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN267"><span class='Ref_To_Local'>left</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN268"><span class='Ref_To_Local'>right</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../include/catalog/pg_type.h.html#LN744"><span class='Ref_to_Macro'>IsPolymorphicType</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN267"><span class='Ref_To_Local'>left</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../include/catalog/pg_type.h.html#LN744"><span class='Ref_to_Macro'>IsPolymorphicType</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN268"><span class='Ref_To_Local'>right</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>                    <a href="indexcmds.c.html#LN140"><span class='Ref_To_Local'>irel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="indexcmds.c.html#LN122"><span class='Ref_To_Local'>typeObjectId</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ret&&indexInfo-&GT;ii_Ex... &raquo; </span> 
 
    <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN140"><span class='Ref_To_Local'>irel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="indexcmds.c.html#LN137"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckIndexCompatible &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DefineIndex 
 *      Creates a new index. 
 * 
 * 'relationId': the OID of the heap relation on which the index is to be 
 *      created 
 * 'stmt': IndexStmt describing the properties of the new index. 
 * 'indexRelationId': normally InvalidOid, but during bootstrap can be 
 *      nonzero to specify a preselected OID for the index. 
 * 'is_alter_table': this is due to an ALTER rather than a CREATE operation. 
 * 'check_rights': check for CREATE rights in namespace and tablespace.  (This 
 *      should be true except when ALTER is deleting/recreating an index.) 
 * 'check_not_in_use': check for table not already in use in current session. 
 *      This should be true unless caller is holding the table open, in which 
 *      case the caller had better have checked it earlier. 
 * 'skip_build': make the catalog entries but leave the index file empty; 
 *      it will be filled later. 
 * 'quiet': suppress the NOTICE chatter ordinarily provided for constraints. 
 * 
 * Returns the object address of the created index. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN307"></a><span class='Declare_Function'>DefineIndex</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relationId</span><span class='Delimiter'>, 
</span><a name="LN308"></a>            <a href="../../include/nodes/parsenodes.h.html#LN2667"><span class='Ref_to_Struct'>IndexStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Delimiter'>, 
</span><a name="LN309"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>indexRelationId</span><span class='Delimiter'>, 
</span><a name="LN310"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_alter_table</span><span class='Delimiter'>, 
</span><a name="LN311"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>check_rights</span><span class='Delimiter'>, 
</span><a name="LN312"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>check_not_in_use</span><span class='Delimiter'>, 
</span><a name="LN313"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>skip_build</span><span class='Delimiter'>, 
</span><a name="LN314"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>quiet</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN316"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>indexRelationName</span><span class='Delimiter'>; 
</span><a name="LN317"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>accessMethodName</span><span class='Delimiter'>; 
</span><a name="LN318"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>typeObjectId</span><span class='Delimiter'>; 
</span><a name="LN319"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>collationObjectId</span><span class='Delimiter'>; 
</span><a name="LN320"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>classObjectId</span><span class='Delimiter'>; 
</span><a name="LN321"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>accessMethodId</span><span class='Delimiter'>; 
</span><a name="LN322"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>namespaceId</span><span class='Delimiter'>; 
</span><a name="LN323"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tablespaceId</span><span class='Delimiter'>; 
</span><a name="LN324"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>indexColNames</span><span class='Delimiter'>; 
</span><a name="LN325"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN326"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRelation</span><span class='Delimiter'>; 
</span><a name="LN327"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN328"></a>    <a href="../../include/catalog/pg_am.h.html#LN45"><span class='Ref_to_Typedef'>Form_pg_am</span></a>  <span class='Declare_Local'>accessMethodForm</span><span class='Delimiter'>; 
</span><a name="LN329"></a>    <a href="../../include/access/amapi.h.html#LN158"><span class='Ref_to_Struct'>IndexAmRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>amRoutine</span><span class='Delimiter'>; 
</span><a name="LN330"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>amcanorder</span><span class='Delimiter'>; 
</span><a name="LN331"></a>    <a href="../../include/access/amapi.h.html#LN101"><span class='Ref_to_Typedef'>amoptions_function</span></a> <span class='Declare_Local'>amoptions</span><span class='Delimiter'>; 
</span><a name="LN332"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>reloptions</span><span class='Delimiter'>; 
</span><a name="LN333"></a>    <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>coloptions</span><span class='Delimiter'>; 
</span><a name="LN334"></a>    <a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indexInfo</span><span class='Delimiter'>; 
</span><a name="LN335"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numberOfAttributes</span><span class='Delimiter'>; 
</span><a name="LN336"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>limitXmin</span><span class='Delimiter'>; 
</span><a name="LN337"></a>    <a href="../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>old_snapshots</span><span class='Delimiter'>; 
</span><a name="LN338"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span><a name="LN339"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>n_old_snapshots</span><span class='Delimiter'>; 
</span><a name="LN340"></a>    <a href="../../include/utils/rel.h.html#LN35"><span class='Ref_to_Struct'>LockRelId</span></a>   <span class='Declare_Local'>heaprelid</span><span class='Delimiter'>; 
</span><a name="LN341"></a>    <a href="../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>heaplocktag</span><span class='Delimiter'>; 
</span><a name="LN342"></a>    <a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN343"></a>    <a href="../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * count attributes in index 
     */ 
</span>    <a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2674"><span class='Ref_to_Member'>indexParams</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"must specify at least one column"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>&GT; </span><a href="../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_TOO_MANY_COLUMNS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot use more than %d columns in an index"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Only SELECT ... FOR UPDATE/SHARE are allowed while doing a standard 
     * index build; but for concurrent builds we allow INSERT/UPDATE/DELETE 
     * (but not VACUUM). 
     * 
     * NB: Caller is responsible for making sure that relationId refers to the 
     * relation on which the index should be built; except in bootstrap mode, 
     * this will typically require the caller to have already locked the 
     * relation.  To avoid lock upgrade hazards, that lock should be at least 
     * as strong as the one we take here. 
     */ 
</span>    <a href="indexcmds.c.html#LN342"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a> <span class='Operator'>? </span><a href="../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a> <span class='Operator'>: </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN307"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN342"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN307"><span class='Ref_to_Parameter'>relationId</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN322"><span class='Ref_To_Local'>namespaceId</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a><span class='Parentheses'>) 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Custom error message for FOREIGN TABLE since the term is close 
             * to a regular table and can confuse the user. 
             */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot create index on foreign table \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot create index on partitioned table \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table or materialized view"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rel-&GT;rd_rel-&GT;relkind!... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Don't try to CREATE INDEX on temp tables of other backends. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN533"><span class='Ref_to_Macro'>RELATION_IS_OTHER_TEMP</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot create indexes on temporary tables of other sessions"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unless our caller vouches for having checked this already, insist that 
     * the table not be in use by our own session, either.  Otherwise we might 
     * fail to make entries in the new index (for instance, if an INSERT or 
     * UPDATE is in progress and has already made its list of target indexes). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN312"><span class='Ref_to_Parameter'>check_not_in_use</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/commands/tablecmds.h.html#LN52"><span class='Ref_to_Proto'>CheckTableNotInUse</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='String'>"CREATE INDEX"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify we (still) have CREATE rights in the rel's namespace. 
     * (Presumably we did when the rel was created, but maybe not anymore.) 
     * Skip check if caller doesn't want it.  Also skip check if 
     * bootstrapping, since permissions machinery may not be working yet. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN311"><span class='Ref_to_Parameter'>check_rights</span></a> <span class='Operator'>&& !</span><a href="../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN427"></a>        <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span> 
        <a href="indexcmds.c.html#LN427"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN289"><span class='Ref_to_Proto'>pg_namespace_aclcheck</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN322"><span class='Ref_To_Local'>namespaceId</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/nodes/parsenodes.h.html#LN81"><span class='Ref_to_Const'>ACL_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN427"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN427"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN189"><span class='Ref_to_EnumConst'>ACL_KIND_NAMESPACE</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN322"><span class='Ref_To_Local'>namespaceId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select tablespace to use.  If not specified, use default tablespace 
     * (which may in turn default to database's default). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2673"><span class='Ref_to_Member'>tableSpace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2673"><span class='Ref_to_Member'>tableSpace</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN51"><span class='Ref_to_Proto'>GetDefaultTablespace</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* note InvalidOid is OK in this case */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check tablespace permissions */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN311"><span class='Ref_to_Parameter'>check_rights</span></a> <span class='Operator'>&& 
</span>        <a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a> <span class='Operator'>!= </span><a href="../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN454"></a>        <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span> 
        <a href="indexcmds.c.html#LN454"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN290"><span class='Ref_to_Proto'>pg_tablespace_aclcheck</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                           <a href="../../include/nodes/parsenodes.h.html#LN81"><span class='Ref_to_Const'>ACL_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN454"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN454"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/commands/tablespace.h.html#LN56"><span class='Ref_to_Proto'>get_tablespace_name</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force shared indexes into the pg_global tablespace.  This is a bit of a 
     * hack but seems simpler than marking them in the BKI commands.  On the 
     * other hand, if it's not shared, don't allow it to be placed there. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>) 
</span>        <a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"only shared relations can be placed in pg_global tablespace"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Choose the index column names. 
     */ 
</span>    <a href="indexcmds.c.html#LN324"><span class='Ref_To_Local'>indexColNames</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN76"><span class='Ref_to_Proto'>ChooseIndexColumnNames</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2674"><span class='Ref_to_Member'>indexParams</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select name for index if caller didn't specify 
     */ 
</span>    <a href="indexcmds.c.html#LN316"><span class='Ref_To_Local'>indexRelationName</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2670"><span class='Ref_to_Member'>idxname</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN316"><span class='Ref_To_Local'>indexRelationName</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="indexcmds.c.html#LN316"><span class='Ref_To_Local'>indexRelationName</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN72"><span class='Ref_to_Proto'>ChooseIndexName</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                            <a href="indexcmds.c.html#LN322"><span class='Ref_To_Local'>namespaceId</span></a><span class='Delimiter'>, 
</span>                                            <a href="indexcmds.c.html#LN324"><span class='Ref_To_Local'>indexColNames</span></a><span class='Delimiter'>, 
</span>                                            <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2677"><span class='Ref_to_Member'>excludeOpNames</span></a><span class='Delimiter'>, 
</span>                                            <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2682"><span class='Ref_to_Member'>primary</span></a><span class='Delimiter'>, 
</span>                                            <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2683"><span class='Ref_to_Member'>isconstraint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * look up the access method, verify it can handle the requested features 
     */ 
</span>    <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2672"><span class='Ref_to_Member'>accessMethod</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN34"><span class='Ref_to_EnumConst'>AMNAME</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Hack to provide more-or-less-transparent updating of old RTREE 
         * indexes to GiST: if RTREE is requested and not found, use GIST. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Delimiter'>, </span><span class='String'>"rtree"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"substituting access method \"gist\" for obsolete method \"rtree\""</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a> <span class='Operator'>= </span><span class='String'>"gist"</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN34"><span class='Ref_to_EnumConst'>AMNAME</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                            <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !HeapTupleIsValid(tup... &raquo; </span> 
    <a href="indexcmds.c.html#LN321"><span class='Ref_To_Local'>accessMethodId</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN328"><span class='Ref_To_Local'>accessMethodForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_am.h.html#LN45"><span class='Ref_to_Typedef'>Form_pg_am</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a> <span class='Operator'>= </span><a href="../access/index/amapi.c.html#LN31"><span class='Ref_to_Func'>GetIndexAmRoutine</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN328"><span class='Ref_To_Local'>accessMethodForm</span></a><span class='Operator'>-&GT;</span>amhandler<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2681"><span class='Ref_to_Member'>unique</span></a> <span class='Operator'>&& !</span><a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/amapi.h.html#LN176"><span class='Ref_to_Member'>amcanunique</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not support unique indexes"</span><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>&& !</span><a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/amapi.h.html#LN178"><span class='Ref_to_Member'>amcanmulticol</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not support multicolumn indexes"</span><span class='Delimiter'>, 
</span>                 <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2677"><span class='Ref_to_Member'>excludeOpNames</span></a> <span class='Operator'>&& </span><a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/amapi.h.html#LN209"><span class='Ref_to_Member'>amgettuple</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not support exclusion constraints"</span><span class='Delimiter'>, 
</span>               <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN330"><span class='Ref_To_Local'>amcanorder</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/amapi.h.html#LN170"><span class='Ref_to_Member'>amcanorder</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN331"><span class='Ref_To_Local'>amoptions</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/amapi.h.html#LN204"><span class='Ref_to_Member'>amoptions</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN329"><span class='Ref_To_Local'>amRoutine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN327"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Validate predicate, if given 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2676"><span class='Ref_to_Member'>whereClause</span></a><span class='Parentheses'>) 
</span>        <a href="indexcmds.c.html#LN60"><span class='Ref_to_Proto'>CheckPredicate</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2676"><span class='Ref_to_Member'>whereClause</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Parse AM-specific options, convert to text array form, validate. 
     */ 
</span>    <a href="indexcmds.c.html#LN332"><span class='Ref_To_Local'>reloptions</span></a> <span class='Operator'>= </span><a href="../../include/access/reloptions.h.html#LN257"><span class='Ref_to_Proto'>transformRelOptions</span></a><span class='Parentheses'>((</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2675"><span class='Ref_to_Member'>options</span></a><span class='Delimiter'>, 
</span>                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/reloptions.h.html#LN276"><span class='Ref_to_Proto'>index_reloptions</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN331"><span class='Ref_To_Local'>amoptions</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN332"><span class='Ref_To_Local'>reloptions</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare arguments for index_create, primarily an IndexInfo structure. 
     * Note that ii_Predicate must be in implicit-AND format. 
     */ 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN133"><span class='Ref_to_Member'>ii_NumIndexAttrs</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* for now */ 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN136"><span class='Ref_to_Member'>ii_ExpressionsState</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN137"><span class='Ref_to_Member'>ii_Predicate</span></a> <span class='Operator'>= </span><a href="../../include/optimizer/clauses.h.html#LN46"><span class='Ref_to_Proto'>make_ands_implicit</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2676"><span class='Ref_to_Member'>whereClause</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN138"><span class='Ref_to_Member'>ii_PredicateState</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN140"><span class='Ref_to_Member'>ii_ExclusionProcs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN141"><span class='Ref_to_Member'>ii_ExclusionStrats</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN145"><span class='Ref_to_Member'>ii_Unique</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2681"><span class='Ref_to_Member'>unique</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* In a concurrent build, mark it not-ready-for-inserts */ 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN146"><span class='Ref_to_Member'>ii_ReadyForInserts</span></a> <span class='Operator'>= !</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN147"><span class='Ref_to_Member'>ii_Concurrent</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN148"><span class='Ref_to_Member'>ii_BrokenHotChain</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN149"><span class='Ref_to_Member'>ii_AmCache</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN150"><span class='Ref_to_Member'>ii_Context</span></a> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN318"><span class='Ref_To_Local'>typeObjectId</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN319"><span class='Ref_To_Local'>collationObjectId</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN320"><span class='Ref_To_Local'>classObjectId</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN333"><span class='Ref_To_Local'>coloptions</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN335"><span class='Ref_To_Local'>numberOfAttributes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN61"><span class='Ref_to_Proto'>ComputeIndexAttrs</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN318"><span class='Ref_To_Local'>typeObjectId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN319"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN320"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN333"><span class='Ref_To_Local'>coloptions</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2674"><span class='Ref_to_Member'>indexParams</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2677"><span class='Ref_to_Member'>excludeOpNames</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN307"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN317"><span class='Ref_To_Local'>accessMethodName</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN321"><span class='Ref_To_Local'>accessMethodId</span></a><span class='Delimiter'>, 
</span>                      <a href="indexcmds.c.html#LN330"><span class='Ref_To_Local'>amcanorder</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2683"><span class='Ref_to_Member'>isconstraint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Extra checks when creating a PRIMARY KEY index. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2682"><span class='Ref_to_Member'>primary</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/catalog/index.h.html#LN40"><span class='Ref_to_Proto'>index_check_primary_key</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN310"><span class='Ref_to_Parameter'>is_alter_table</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We disallow indexes on system columns other than OID.  They would not 
     * necessarily get updated correctly, and they don't seem useful anyway. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN133"><span class='Ref_to_Member'>ii_NumIndexAttrs</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN601"></a>        <a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a>  <span class='Declare_Local'>attno</span> <span class='Operator'>= </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN134"><span class='Ref_to_Member'>ii_KeyAttrNumbers</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN601"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="indexcmds.c.html#LN601"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>!= </span><a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index creation on system columns is not supported"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also check for system columns used in expressions or predicates. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a> <span class='Operator'>|| </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN137"><span class='Ref_to_Member'>ii_Predicate</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN614"></a>        <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>indexattrs</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/optimizer/var.h.html#LN31"><span class='Ref_to_Proto'>pull_varattnos</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN614"><span class='Ref_To_Local'>indexattrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/optimizer/var.h.html#LN31"><span class='Ref_to_Proto'>pull_varattnos</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN137"><span class='Ref_to_Member'>ii_Predicate</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN614"><span class='Ref_To_Local'>indexattrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a> <span class='Operator'>&& 
</span>                <a href="../../include/nodes/bitmapset.h.html#LN75"><span class='Ref_to_Proto'>bms_is_member</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Delimiter'>, 
</span>                              <a href="indexcmds.c.html#LN614"><span class='Ref_To_Local'>indexattrs</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index creation on system columns is not supported"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report index creation if appropriate (delay this till after most of the 
     * error checks) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2683"><span class='Ref_to_Member'>isconstraint</span></a> <span class='Operator'>&& !</span><a href="indexcmds.c.html#LN314"><span class='Ref_to_Parameter'>quiet</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN636"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>constraint_type</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2682"><span class='Ref_to_Member'>primary</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN636"><span class='Ref_To_Local'>constraint_type</span></a> <span class='Operator'>= </span><span class='String'>"PRIMARY KEY"</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2681"><span class='Ref_to_Member'>unique</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN636"><span class='Ref_To_Local'>constraint_type</span></a> <span class='Operator'>= </span><span class='String'>"UNIQUE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2677"><span class='Ref_to_Member'>excludeOpNames</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN636"><span class='Ref_To_Local'>constraint_type</span></a> <span class='Operator'>= </span><span class='String'>"EXCLUDE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unknown constraint type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN636"><span class='Ref_To_Local'>constraint_type</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>          <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s %s will create implicit index \"%s\" for table \"%s\""</span><span class='Delimiter'>, 
</span>                  <a href="indexcmds.c.html#LN310"><span class='Ref_to_Parameter'>is_alter_table</span></a> <span class='Operator'>? </span><span class='String'>"ALTER TABLE / ADD"</span> <span class='Operator'>: </span><span class='String'>"CREATE TABLE /"</span><span class='Delimiter'>, 
</span>                  <a href="indexcmds.c.html#LN636"><span class='Ref_To_Local'>constraint_type</span></a><span class='Delimiter'>, 
</span>                  <a href="indexcmds.c.html#LN316"><span class='Ref_To_Local'>indexRelationName</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stmt-&GT;isconstraint&&!... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * A valid stmt-&GT;oldNode implies that we already have a built form of the 
     * index.  The caller should also decline any index build. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2680"><span class='Ref_to_Member'>oldNode</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN313"><span class='Ref_to_Parameter'>skip_build</span></a> <span class='Operator'>&& !</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make the catalog entries for the index, including constraints. Then, if 
     * not skip_build || concurrent, actually build the index. 
     */ 
</span>    <a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a> <span class='Operator'>= 
</span>        <a href="../../include/catalog/index.h.html#LN44"><span class='Ref_to_Proto'>index_create</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN316"><span class='Ref_To_Local'>indexRelationName</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2680"><span class='Ref_to_Member'>oldNode</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN324"><span class='Ref_To_Local'>indexColNames</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN321"><span class='Ref_To_Local'>accessMethodId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN323"><span class='Ref_To_Local'>tablespaceId</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN319"><span class='Ref_To_Local'>collationObjectId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN320"><span class='Ref_To_Local'>classObjectId</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN333"><span class='Ref_To_Local'>coloptions</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN332"><span class='Ref_To_Local'>reloptions</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2682"><span class='Ref_to_Member'>primary</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2683"><span class='Ref_to_Member'>isconstraint</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2684"><span class='Ref_to_Member'>deferrable</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2685"><span class='Ref_to_Member'>initdeferred</span></a><span class='Delimiter'>, 
</span>                     <a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN313"><span class='Ref_to_Parameter'>skip_build</span></a> <span class='Operator'>|| </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a><span class='Delimiter'>, </span><span class='Operator'>!</span><a href="indexcmds.c.html#LN311"><span class='Ref_to_Parameter'>check_rights</span></a><span class='Delimiter'>, 
</span>                     <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2688"><span class='Ref_to_Member'>if_not_exists</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN338"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="indexcmds.c.html#LN338"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Add any requested comment */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2678"><span class='Ref_to_Member'>idxcomment</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/commands/comment.h.html#LN36"><span class='Ref_to_Proto'>CreateComments</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                       <a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2678"><span class='Ref_to_Member'>idxcomment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2687"><span class='Ref_to_Member'>concurrent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Close the heap and we're done, in the non-concurrent case */ 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="indexcmds.c.html#LN338"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* save lockrelid and locktag for below, then close rel */ 
</span>    <a href="indexcmds.c.html#LN340"><span class='Ref_To_Local'>heaprelid</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN341"><span class='Ref_To_Local'>heaplocktag</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN340"><span class='Ref_To_Local'>heaprelid</span></a><span class='Operator'>.</span><a href="../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN340"><span class='Ref_To_Local'>heaprelid</span></a><span class='Operator'>.</span><a href="../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For a concurrent build, it's important to make the catalog entries 
     * visible to other transactions before we start to build the index. That 
     * will prevent them from making incompatible HOT updates.  The new index 
     * will be marked not indisready and not indisvalid, so that no one else 
     * tries to either insert into it or use it for queries. 
     * 
     * We must commit our current transaction so that the index becomes 
     * visible; then start another.  Note that all the data structures we just 
     * built are lost in the commit.  The only data we keep past here are the 
     * relation IDs. 
     * 
     * Before committing, get a session-level lock on the table, to ensure 
     * that neither it nor the index can be dropped before we finish. This 
     * cannot block, even if someone else is waiting for access, because we 
     * already have the same lock within our transaction. 
     * 
     * Note: we don't currently bother with a session lock on the index, 
     * because there are no operations that could change its state while we 
     * hold lock on the parent table.  This might need to change later. 
     */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN49"><span class='Ref_to_Proto'>LockRelationIdForSession</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="indexcmds.c.html#LN340"><span class='Ref_To_Local'>heaprelid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Phase 2 of concurrent index build (see comments for validate_index() 
     * for an overview of how this works) 
     * 
     * Now we must wait until no running transaction could have the table open 
     * with the old list of indexes.  Use ShareLock to consider running 
     * transactions that hold locks that permit writing to the table.  Note we 
     * do not need to worry about xacts that open the table for writing after 
     * this point; they will see the new index when they open it. 
     * 
     * Note: the reason we use actual lock acquisition here, rather than just 
     * checking the ProcArray and sleeping, is that deadlock is possible if 
     * one of the transactions in question is blocked trying to acquire an 
     * exclusive lock on our table.  The lock code will detect deadlock and 
     * error out properly. 
     */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN78"><span class='Ref_to_Proto'>WaitForLockers</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN341"><span class='Ref_To_Local'>heaplocktag</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * At this moment we are sure that there are no transactions with the 
     * table open for write that don't have this new index in their list of 
     * indexes.  We have waited out all the existing transactions and any new 
     * transaction will have the new index in its list, but the index is still 
     * marked as "not-ready-for-inserts".  The index is consulted while 
     * deciding HOT-safety though.  This arrangement ensures that no new HOT 
     * chains can be created where the new tuple and the old tuple in the 
     * chain have different index keys. 
     * 
     * We now take a new snapshot, and build the index using all tuples that 
     * are visible in this snapshot.  We can be sure that any HOT updates to 
     * these tuples will be compatible with the index, since any updates made 
     * by transactions that didn't know about the index are now committed or 
     * rolled back.  Thus, each visible tuple is either the end of its 
     * HOT-chain or the extension of the chain is HOT-safe for this index. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Open and lock the parent heap relation */ 
</span>    <a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN92"><span class='Ref_to_Proto'>heap_openrv</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2671"><span class='Ref_to_Member'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And the target index relation */ 
</span>    <a href="indexcmds.c.html#LN326"><span class='Ref_To_Local'>indexRelation</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set ActiveSnapshot since functions in the indexes may need it */ 
</span>    <a href="../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We have to re-build the IndexInfo struct, since it was lost in commit */ 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a> <span class='Operator'>= </span><a href="../../include/catalog/index.h.html#LN81"><span class='Ref_to_Proto'>BuildIndexInfo</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN326"><span class='Ref_To_Local'>indexRelation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN146"><span class='Ref_to_Member'>ii_ReadyForInserts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN147"><span class='Ref_to_Member'>ii_Concurrent</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN148"><span class='Ref_to_Member'>ii_BrokenHotChain</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now build the index */ 
</span>    <a href="../../include/catalog/index.h.html#LN91"><span class='Ref_to_Proto'>index_build</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN326"><span class='Ref_To_Local'>indexRelation</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN334"><span class='Ref_To_Local'>indexInfo</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN308"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2682"><span class='Ref_to_Member'>primary</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close both the relations, but keep the locks */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN325"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN326"><span class='Ref_To_Local'>indexRelation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update the pg_index row to mark the index as ready for inserts. Once we 
     * commit this transaction, any new transactions that open the table must 
     * insert new entries into the index for insertions and non-HOT updates. 
     */ 
</span>    <a href="../../include/catalog/index.h.html#LN115"><span class='Ref_to_Proto'>index_set_state_flags</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/index.h.html#LN33"><span class='Ref_to_EnumConst'>INDEX_CREATE_SET_READY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we can do away with our snapshot */ 
</span>    <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Commit this transaction to make the indisready update visible. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Phase 3 of concurrent index build 
     * 
     * We once again wait until no transaction can have the table open with 
     * the index marked as read-only for updates. 
     */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN78"><span class='Ref_to_Proto'>WaitForLockers</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN341"><span class='Ref_To_Local'>heaplocktag</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now take the "reference snapshot" that will be used by validate_index() 
     * to filter candidate tuples.  Beware!  There might still be snapshots in 
     * use that treat some transaction as in-progress that our reference 
     * snapshot treats as committed.  If such a recently-committed transaction 
     * deleted tuples in the table, we will not include them in the index; yet 
     * those transactions which see the deleting one as still-in-progress will 
     * expect such tuples to be there once we mark the index as valid. 
     * 
     * We solve this by waiting for all endangered transactions to exit before 
     * we mark the index as valid. 
     * 
     * We also set ActiveSnapshot to this snap, since functions in indexes may 
     * need a snapshot. 
     */ 
</span>    <a href="indexcmds.c.html#LN343"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../include/utils/snapmgr.h.html#LN80"><span class='Ref_to_Proto'>RegisterSnapshot</span></a><span class='Parentheses'>(</span><a href="../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN343"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the index and the heap, insert any missing index entries. 
     */ 
</span>    <a href="../../include/catalog/index.h.html#LN113"><span class='Ref_to_Proto'>validate_index</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN307"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN343"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Drop the reference snapshot.  We must do this before waiting out other 
     * snapshot holders, else we will deadlock against other processes also 
     * doing CREATE INDEX CONCURRENTLY, which would see our snapshot as one 
     * they must wait for.  But first, save the snapshot's xmin to use as 
     * limitXmin for GetCurrentVirtualXIDs(). 
     */ 
</span>    <a href="indexcmds.c.html#LN336"><span class='Ref_To_Local'>limitXmin</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN343"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/snapmgr.h.html#LN81"><span class='Ref_to_Proto'>UnregisterSnapshot</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN343"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The index is now valid in the sense that it contains all currently 
     * interesting tuples.  But since it might not contain tuples deleted just 
     * before the reference snap was taken, we have to wait out any 
     * transactions that might have older snapshots.  Obtain a list of VXIDs 
     * of such transactions, and wait for them individually. 
     * 
     * We can exclude any running transactions that have xmin &GT; the xmin of 
     * our reference snapshot; their oldest snapshot must be newer than ours. 
     * We can also exclude any transactions that have xmin = zero, since they 
     * evidently have no live snapshot at all (and any one they might be in 
     * process of taking is certainly newer than ours).  Transactions in other 
     * DBs can be ignored too, since they'll never even be able to see this 
     * index. 
     * 
     * We can also exclude autovacuum processes and processes running manual 
     * lazy VACUUMs, because they won't be fazed by missing index entries 
     * either.  (Manual ANALYZEs, however, can't be excluded because they 
     * might be within transactions that are going to do arbitrary operations 
     * later.) 
     * 
     * Also, GetCurrentVirtualXIDs never reports our own vxid, so we need not 
     * check for that. 
     * 
     * If a process goes idle-in-transaction with xmin zero, we do not need to 
     * wait for it anymore, per the above argument.  We do not have the 
     * infrastructure right now to stop waiting if that happens, but we can at 
     * least avoid the folly of waiting when it is idle at the time we would 
     * begin to wait.  We do this by repeatedly rechecking the output of 
     * GetCurrentVirtualXIDs.  If, during any iteration, a particular vxid 
     * doesn't show up in the output, we know we can forget about it. 
     */ 
</span>    <a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a> <span class='Operator'>= </span><a href="../../include/storage/procarray.h.html#LN103"><span class='Ref_to_Proto'>GetCurrentVirtualXIDs</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN336"><span class='Ref_To_Local'>limitXmin</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/storage/proc.h.html#LN51"><span class='Ref_to_Const'>PROC_IS_AUTOVACUUM</span></a> <span class='Operator'>| </span><a href="../../include/storage/proc.h.html#LN52"><span class='Ref_to_Const'>PROC_IN_VACUUM</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="indexcmds.c.html#LN339"><span class='Ref_To_Local'>n_old_snapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="indexcmds.c.html#LN339"><span class='Ref_To_Local'>n_old_snapshots</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* found uninteresting in previous cycle */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* see if anything's changed ... */ 
</span><a name="LN892"></a>            <a href="../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newer_snapshots</span><span class='Delimiter'>; 
</span><a name="LN893"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>n_newer_snapshots</span><span class='Delimiter'>; 
</span><a name="LN894"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN895"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>k</span><span class='Delimiter'>; 
</span> 
            <a href="indexcmds.c.html#LN892"><span class='Ref_To_Local'>newer_snapshots</span></a> <span class='Operator'>= </span><a href="../../include/storage/procarray.h.html#LN103"><span class='Ref_to_Proto'>GetCurrentVirtualXIDs</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN336"><span class='Ref_To_Local'>limitXmin</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                         <a href="../../include/storage/proc.h.html#LN51"><span class='Ref_to_Const'>PROC_IS_AUTOVACUUM</span></a> <span class='Operator'>| </span><a href="../../include/storage/proc.h.html#LN52"><span class='Ref_to_Const'>PROC_IN_VACUUM</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Operator'>&</span><a href="indexcmds.c.html#LN893"><span class='Ref_To_Local'>n_newer_snapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN894"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN894"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="indexcmds.c.html#LN339"><span class='Ref_To_Local'>n_old_snapshots</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN894"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN894"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
                    <span class='Control'>continue</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* found uninteresting in previous cycle */ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN895"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN895"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&LT; </span><a href="indexcmds.c.html#LN893"><span class='Ref_To_Local'>n_newer_snapshots</span></a><span class='Delimiter'>; </span><a href="indexcmds.c.html#LN895"><span class='Ref_To_Local'>k</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/lock.h.html#LN74"><span class='Ref_to_Macro'>VirtualTransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN894"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>], 
</span>                                                   <a href="indexcmds.c.html#LN892"><span class='Ref_To_Local'>newer_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN895"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN895"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&GT;= </span><a href="indexcmds.c.html#LN893"><span class='Ref_To_Local'>n_newer_snapshots</span></a><span class='Parentheses'>)</span>     <span class='Comment_Single_Line'>/* not there anymore */ 
</span>                    <a href="../../include/storage/lock.h.html#LN77"><span class='Ref_to_Macro'>SetInvalidVirtualTransactionId</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN894"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN892"><span class='Ref_To_Local'>newer_snapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if i&GT;0 &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <a href="../../include/storage/lock.h.html#LN586"><span class='Ref_to_Proto'>VirtualXactLock</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN337"><span class='Ref_To_Local'>old_snapshots</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN344"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;n_old_snapshots... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Index can now be marked valid -- update its pg_index entry 
     */ 
</span>    <a href="../../include/catalog/index.h.html#LN115"><span class='Ref_to_Proto'>index_set_state_flags</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN309"><span class='Ref_to_Parameter'>indexRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/index.h.html#LN34"><span class='Ref_to_EnumConst'>INDEX_CREATE_SET_VALID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The pg_index update will cause backends (including this one) to update 
     * relcache entries for the index itself, but we should also send a 
     * relcache inval on the parent table to force replanning of cached plans. 
     * Otherwise existing sessions might fail to use the new index where it 
     * would be useful.  (Note that our earlier commits did not create reasons 
     * to replan; so relcache flush on the index itself was sufficient.) 
     */ 
</span>    <a href="../../include/utils/inval.h.html#LN49"><span class='Ref_to_Proto'>CacheInvalidateRelcacheByRelid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN340"><span class='Ref_To_Local'>heaprelid</span></a><span class='Operator'>.</span><a href="../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Last thing to do is release the session-level lock on the parent table. 
     */ 
</span>    <a href="../../include/storage/lmgr.h.html#LN50"><span class='Ref_to_Proto'>UnlockRelationIdForSession</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="indexcmds.c.html#LN340"><span class='Ref_To_Local'>heaprelid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN338"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DefineIndex &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * CheckMutability 
 *      Test whether given expression is mutable 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN950"></a><span class='Declare_Function'>CheckMutability</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>expr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * First run the expression through the planner.  This has a couple of 
     * important consequences.  First, function default arguments will get 
     * inserted, which may affect volatility (consider "default now()"). 
     * Second, inline-able functions will get inlined, which may allow us to 
     * conclude that the function is really less volatile than it's marked. As 
     * an example, polymorphic functions must be marked with the most volatile 
     * behavior that they have for any input type, but once we inline the 
     * function we may be able to conclude that it's not so volatile for the 
     * particular input type we're dealing with. 
     * 
     * We assume here that expression_planner() won't scribble on its input. 
     */ 
</span>    <a href="indexcmds.c.html#LN950"><span class='Ref_to_Parameter'>expr</span></a> <span class='Operator'>= </span><a href="../../include/optimizer/planner.h.html#LN53"><span class='Ref_to_Proto'>expression_planner</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN950"><span class='Ref_to_Parameter'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can search for non-immutable functions */ 
</span>    <span class='Control'>return</span> <a href="../../include/optimizer/clauses.h.html#LN59"><span class='Ref_to_Proto'>contain_mutable_functions</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN950"><span class='Ref_to_Parameter'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckMutability &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * CheckPredicate 
 *      Checks that the given partial-index predicate is valid. 
 * 
 * This used to also constrain the form of the predicate to forms that 
 * indxpath.c could do something with.  However, that seems overly 
 * restrictive.  One useful application of partial indexes is to apply 
 * a UNIQUE constraint across a subset of a table, and in that scenario 
 * any evaluable predicate will work.  So accept any predicate here 
 * (except ones requiring a plan), and let indxpath.c fend for itself. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN984"></a><span class='Declare_Function'>CheckPredicate</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>predicate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * transformExpr() should have already rejected subqueries, aggregates, 
     * and window functions, based on the EXPR_KIND_ for a predicate. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * A predicate using mutable functions is probably wrong, for the same 
     * reasons that we don't allow an index expression to use one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN949"><span class='Ref_to_Func'>CheckMutability</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN984"><span class='Ref_to_Parameter'>predicate</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"functions in index predicate must be marked IMMUTABLE"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Compute per-index-column information, including indexed column numbers 
 * or index expressions, opclasses, and indoptions. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1006"></a><span class='Declare_Function'>ComputeIndexAttrs</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN130"><span class='Ref_to_Struct'>IndexInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexInfo</span><span class='Delimiter'>, 
</span><a name="LN1007"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typeOidP</span><span class='Delimiter'>, 
</span><a name="LN1008"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>collationOidP</span><span class='Delimiter'>, 
</span><a name="LN1009"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>classOidP</span><span class='Delimiter'>, 
</span><a name="LN1010"></a>                  <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colOptionP</span><span class='Delimiter'>, 
</span><a name="LN1011"></a>                  <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attList</span><span class='Delimiter'>,</span>    <span class='Comment_Single_Line'>/* list of IndexElem's */ 
</span><a name="LN1012"></a>                  <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>exclusionOpNames</span><span class='Delimiter'>, 
</span><a name="LN1013"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Delimiter'>, 
</span><a name="LN1014"></a>                  <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>accessMethodName</span><span class='Delimiter'>, 
</span><a name="LN1015"></a>                  <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>accessMethodId</span><span class='Delimiter'>, 
</span><a name="LN1016"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>amcanorder</span><span class='Delimiter'>, 
</span><a name="LN1017"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>isconstraint</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1019"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>nextExclOp</span><span class='Delimiter'>; 
</span><a name="LN1020"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN1021"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>attn</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate space for exclusion operator info, if needed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1012"><span class='Ref_to_Parameter'>exclusionOpNames</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1026"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ncols</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1011"><span class='Ref_to_Parameter'>attList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1012"><span class='Ref_to_Parameter'>exclusionOpNames</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="indexcmds.c.html#LN1026"><span class='Ref_To_Local'>ncols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="indexcmds.c.html#LN1026"><span class='Ref_To_Local'>ncols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN140"><span class='Ref_to_Member'>ii_ExclusionProcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="indexcmds.c.html#LN1026"><span class='Ref_To_Local'>ncols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN141"><span class='Ref_to_Member'>ii_ExclusionStrats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="indexcmds.c.html#LN1026"><span class='Ref_To_Local'>ncols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1019"><span class='Ref_To_Local'>nextExclOp</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1012"><span class='Ref_to_Parameter'>exclusionOpNames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="indexcmds.c.html#LN1019"><span class='Ref_To_Local'>nextExclOp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * process attributeList 
     */ 
</span>    <a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1020"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1011"><span class='Ref_to_Parameter'>attList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1043"></a>        <a href="../../include/nodes/parsenodes.h.html#LN685"><span class='Ref_to_Struct'>IndexElem</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>attribute</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN685"><span class='Ref_to_Struct'>IndexElem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1020"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1044"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>atttype</span><span class='Delimiter'>; 
</span><a name="LN1045"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>attcollation</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Process the column-or-expression to be indexed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN688"><span class='Ref_to_Member'>name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Simple index attribute */ 
</span><a name="LN1053"></a>            <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>atttuple</span><span class='Delimiter'>; 
</span><a name="LN1054"></a>            <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attform</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN689"><span class='Ref_to_Member'>expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1053"><span class='Ref_To_Local'>atttuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN129"><span class='Ref_to_Proto'>SearchSysCacheAttName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1013"><span class='Ref_to_Parameter'>relId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN688"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1053"><span class='Ref_To_Local'>atttuple</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* difference in error message spellings is historical */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1017"><span class='Ref_to_Parameter'>isconstraint</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column \"%s\" named in key does not exist"</span><span class='Delimiter'>, 
</span>                                 <a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN688"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_COLUMN<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                                    <a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN688"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="indexcmds.c.html#LN1054"><span class='Ref_To_Local'>attform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1053"><span class='Ref_To_Local'>atttuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN134"><span class='Ref_to_Member'>ii_KeyAttrNumbers</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="indexcmds.c.html#LN1054"><span class='Ref_To_Local'>attform</span></a><span class='Operator'>-&GT;</span>attnum<span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1054"><span class='Ref_To_Local'>attform</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1045"><span class='Ref_To_Local'>attcollation</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1054"><span class='Ref_To_Local'>attform</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>; 
</span>            <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1053"><span class='Ref_To_Local'>atttuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if attribute-&GT;name!=NULL &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Index expression */ 
</span><a name="LN1081"></a>            <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>expr</span> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN689"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1045"><span class='Ref_To_Local'>attcollation</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodeFuncs.h.html#LN38"><span class='Ref_to_Proto'>exprCollation</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Strip any top-level COLLATE clause.  This ensures that we treat 
             * "x COLLATE y" and "(x COLLATE y)" alike. 
             */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN871"><span class='Ref_to_Struct'>CollateExpr</span></a><span class='Parentheses'>))</span> 
                <a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) ((</span><a href="../../include/nodes/primnodes.h.html#LN871"><span class='Ref_to_Struct'>CollateExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>arg<span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                <span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>varattno <span class='Operator'>!= </span><a href="../../include/access/attnum.h.html#LN22"><span class='Ref_to_Const'>InvalidAttrNumber</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * User wrote "(column)" or "(column COLLATE something)". 
                 * Treat it like simple attribute anyway. 
                 */ 
</span>                <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN134"><span class='Ref_to_Member'>ii_KeyAttrNumbers</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>varattno<span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN134"><span class='Ref_to_Member'>ii_KeyAttrNumbers</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* marks expression */ 
</span>                <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN135"><span class='Ref_to_Member'>ii_Expressions</span></a><span class='Delimiter'>, 
</span>                                                    <a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * transformExpr() should have already rejected subqueries, 
                 * aggregates, and window functions, based on the EXPR_KIND_ 
                 * for an index expression. 
                 */ 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * An expression using mutable functions is probably wrong, 
                 * since if you aren't going to get the same result for the 
                 * same data every time, it's not clear what the index entries 
                 * mean at all. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN949"><span class='Ref_to_Func'>CheckMutability</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN1081"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>))</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"functions in index expression must be marked IMMUTABLE"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <a href="indexcmds.c.html#LN1007"><span class='Ref_to_Parameter'>typeOidP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Apply collation override if any 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN691"><span class='Ref_to_Member'>collation</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN1045"><span class='Ref_To_Local'>attcollation</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN142"><span class='Ref_to_Proto'>get_collation_oid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN691"><span class='Ref_to_Member'>collation</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check we have a collation iff it's a collatable type.  The only 
         * expected failures here are (1) COLLATE applied to a noncollatable 
         * type, or (2) index expression had an unresolved collation.  But we 
         * might as well code this to be a complete consistency check. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN167"><span class='Ref_to_Proto'>type_is_collatable</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1045"><span class='Ref_To_Local'>attcollation</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INDETERMINATE_COLLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine which collation to use for index expression"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use the COLLATE clause to set the collation explicitly."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1045"><span class='Ref_To_Local'>attcollation</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"collations are not supported by type %s"</span><span class='Delimiter'>, 
</span>                                <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="indexcmds.c.html#LN1008"><span class='Ref_to_Parameter'>collationOidP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="indexcmds.c.html#LN1045"><span class='Ref_To_Local'>attcollation</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Identify the opclass to use. 
         */ 
</span>        <a href="indexcmds.c.html#LN1009"><span class='Ref_to_Parameter'>classOidP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN45"><span class='Ref_to_Proto'>ResolveOpClass</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN692"><span class='Ref_to_Member'>opclass</span></a><span class='Delimiter'>, 
</span>                                         <a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a><span class='Delimiter'>, 
</span>                                         <a href="indexcmds.c.html#LN1014"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Delimiter'>, 
</span>                                         <a href="indexcmds.c.html#LN1015"><span class='Ref_to_Parameter'>accessMethodId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Identify the exclusion operator, if any. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1019"><span class='Ref_To_Local'>nextExclOp</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1174"></a>            <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>opname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1019"><span class='Ref_To_Local'>nextExclOp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1175"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>opid</span><span class='Delimiter'>; 
</span><a name="LN1176"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>opfamily</span><span class='Delimiter'>; 
</span><a name="LN1177"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>strat</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Find the operator --- it must accept the column datatype 
             * without runtime coercion (but binary compatibility is OK) 
             */ 
</span>            <a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_oper.h.html#LN53"><span class='Ref_to_Proto'>compatible_oper_opid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1174"><span class='Ref_To_Local'>opname</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1044"><span class='Ref_To_Local'>atttype</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Only allow commutative operators to be used in exclusion 
             * constraints. If X conflicts with Y, but Y does not conflict 
             * with X, bad things will happen. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN106"><span class='Ref_to_Proto'>get_commutator</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"operator %s is not commutative"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/regproc.h.html#LN22"><span class='Ref_to_Proto'>format_operator</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Only commutative operators can be used in exclusion constraints."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Operator must be a member of the right opfamily, too 
             */ 
</span>            <a href="indexcmds.c.html#LN1176"><span class='Ref_To_Local'>opfamily</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN96"><span class='Ref_to_Proto'>get_opclass_family</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1009"><span class='Ref_to_Parameter'>classOidP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1177"><span class='Ref_To_Local'>strat</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN64"><span class='Ref_to_Proto'>get_op_opfamily_strategy</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1176"><span class='Ref_To_Local'>opfamily</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1177"><span class='Ref_To_Local'>strat</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1204"></a>                <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>opftuple</span><span class='Delimiter'>; 
</span><a name="LN1205"></a>                <a href="../../include/catalog/pg_opfamily.h.html#LN43"><span class='Ref_to_Typedef'>Form_pg_opfamily</span></a> <span class='Declare_Local'>opfform</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * attribute-&GT;opclass might not explicitly name the opfamily, 
                 * so fetch the name of the selected opfamily for use in the 
                 * error message. 
                 */ 
</span>                <a href="indexcmds.c.html#LN1204"><span class='Ref_To_Local'>opftuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN73"><span class='Ref_to_EnumConst'>OPFAMILYOID</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1176"><span class='Ref_To_Local'>opfamily</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1204"><span class='Ref_To_Local'>opftuple</span></a><span class='Parentheses'>))</span> 
                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for opfamily %u"</span><span class='Delimiter'>, 
</span>                         <a href="indexcmds.c.html#LN1176"><span class='Ref_To_Local'>opfamily</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="indexcmds.c.html#LN1205"><span class='Ref_To_Local'>opfform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_opfamily.h.html#LN43"><span class='Ref_to_Typedef'>Form_pg_opfamily</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1204"><span class='Ref_To_Local'>opftuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"operator %s is not a member of operator family \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/regproc.h.html#LN22"><span class='Ref_to_Proto'>format_operator</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1205"><span class='Ref_To_Local'>opfform</span></a><span class='Operator'>-&GT;</span>opfname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The exclusion operator must be related to the index operator class for the constraint."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strat==0 &raquo; </span> 
 
            <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN139"><span class='Ref_to_Member'>ii_ExclusionOps</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN140"><span class='Ref_to_Member'>ii_ExclusionProcs</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN98"><span class='Ref_to_Proto'>get_opcode</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1175"><span class='Ref_To_Local'>opid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1006"><span class='Ref_to_Parameter'>indexInfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN141"><span class='Ref_to_Member'>ii_ExclusionStrats</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="indexcmds.c.html#LN1177"><span class='Ref_To_Local'>strat</span></a><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1019"><span class='Ref_To_Local'>nextExclOp</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1019"><span class='Ref_To_Local'>nextExclOp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nextExclOp &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Set up the per-column options (indoption field).  For now, this is 
         * zero for any un-ordered index, while ordered indexes have DESC and 
         * NULLS FIRST/LAST options. 
         */ 
</span>        <a href="indexcmds.c.html#LN1010"><span class='Ref_to_Parameter'>colOptionP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1016"><span class='Ref_to_Parameter'>amcanorder</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* default ordering is ASC */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN693"><span class='Ref_to_Member'>ordering</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN51"><span class='Ref_to_EnumConst'>SORTBY_DESC</span></a><span class='Parentheses'>) 
</span>                <a href="indexcmds.c.html#LN1010"><span class='Ref_to_Parameter'>colOptionP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><a href="../../include/catalog/pg_index.h.html#LN98"><span class='Ref_to_Const'>INDOPTION_DESC</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* default null ordering is LAST for ASC, FIRST for DESC */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN694"><span class='Ref_to_Member'>nulls_ordering</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN57"><span class='Ref_to_EnumConst'>SORTBY_NULLS_DEFAULT</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN693"><span class='Ref_to_Member'>ordering</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN51"><span class='Ref_to_EnumConst'>SORTBY_DESC</span></a><span class='Parentheses'>) 
</span>                    <a href="indexcmds.c.html#LN1010"><span class='Ref_to_Parameter'>colOptionP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><a href="../../include/catalog/pg_index.h.html#LN99"><span class='Ref_to_Const'>INDOPTION_NULLS_FIRST</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN694"><span class='Ref_to_Member'>nulls_ordering</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN58"><span class='Ref_to_EnumConst'>SORTBY_NULLS_FIRST</span></a><span class='Parentheses'>) 
</span>                <a href="indexcmds.c.html#LN1010"><span class='Ref_to_Parameter'>colOptionP</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><a href="../../include/catalog/pg_index.h.html#LN99"><span class='Ref_to_Const'>INDOPTION_NULLS_FIRST</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* index AM does not support ordering */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN693"><span class='Ref_to_Member'>ordering</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN49"><span class='Ref_to_EnumConst'>SORTBY_DEFAULT</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not support ASC/DESC options"</span><span class='Delimiter'>, 
</span>                                <a href="indexcmds.c.html#LN1014"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1043"><span class='Ref_To_Local'>attribute</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN694"><span class='Ref_to_Member'>nulls_ordering</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN57"><span class='Ref_to_EnumConst'>SORTBY_NULLS_DEFAULT</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access method \"%s\" does not support NULLS FIRST/LAST options"</span><span class='Delimiter'>, 
</span>                                <a href="indexcmds.c.html#LN1014"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="indexcmds.c.html#LN1021"><span class='Ref_To_Local'>attn</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ComputeIndexAttrs &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Resolve possibly-defaulted operator class specification 
 * 
 * Note: This is used to resolve operator class specification in index and 
 * partition key definitions. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1279"></a><span class='Declare_Function'>ResolveOpClass</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opclass</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>attrType</span><span class='Delimiter'>, 
</span><a name="LN1280"></a>               <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>accessMethodName</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>accessMethodId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1282"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>schemaname</span><span class='Delimiter'>; 
</span><a name="LN1283"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>opcname</span><span class='Delimiter'>; 
</span><a name="LN1284"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1285"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>opClassId</span><span class='Delimiter'>, 
</span><a name="LN1286"></a>                <span class='Declare_Local'>opInputType</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release 7.0 removed network_ops, timespan_ops, and datetime_ops, so we 
     * ignore those opclass names so the default *_ops is used.  This can be 
     * removed in some later release.  bjm 2000/02/07 
     * 
     * Release 7.1 removes lztext_ops, so suppress that too for a while.  tgl 
     * 2000/07/30 
     * 
     * Release 7.2 renames timestamp_ops to timestamptz_ops, so suppress that 
     * too for awhile.  I'm starting to think we need a better approach. tgl 
     * 2000/10/01 
     * 
     * Release 8.0 removes bigbox_ops (which was dead code for a long while 
     * anyway).  tgl 2003/11/11 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1305"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>claname</span> <span class='Operator'>= </span><a href="../../include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1305"><span class='Ref_To_Local'>claname</span></a><span class='Delimiter'>, </span><span class='String'>"network_ops"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1305"><span class='Ref_To_Local'>claname</span></a><span class='Delimiter'>, </span><span class='String'>"timespan_ops"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1305"><span class='Ref_To_Local'>claname</span></a><span class='Delimiter'>, </span><span class='String'>"datetime_ops"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1305"><span class='Ref_To_Local'>claname</span></a><span class='Delimiter'>, </span><span class='String'>"lztext_ops"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1305"><span class='Ref_To_Local'>claname</span></a><span class='Delimiter'>, </span><span class='String'>"timestamp_ops"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1305"><span class='Ref_To_Local'>claname</span></a><span class='Delimiter'>, </span><span class='String'>"bigbox_ops"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* no operator class specified, so find the default */ 
</span>        <a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN44"><span class='Ref_to_Proto'>GetDefaultOpClass</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>attrType</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1280"><span class='Ref_to_Parameter'>accessMethodId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"data type %s has no default operator class for access method \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>attrType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1280"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You must specify an operator class for the index or define a default operator class for the data type."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Specific opclass name given, so look up the opclass. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* deconstruct the name list */ 
</span>    <a href="../../include/catalog/namespace.h.html#LN109"><span class='Ref_to_Proto'>DeconstructQualifiedName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN1282"><span class='Ref_To_Local'>schemaname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN1283"><span class='Ref_To_Local'>opcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1282"><span class='Ref_To_Local'>schemaname</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Look in specific schema only */ 
</span><a name="LN1339"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>namespaceId</span><span class='Delimiter'>; 
</span> 
        <a href="indexcmds.c.html#LN1339"><span class='Ref_To_Local'>namespaceId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN113"><span class='Ref_to_Proto'>LookupExplicitNamespace</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1282"><span class='Ref_To_Local'>schemaname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1284"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN159"><span class='Ref_to_Macro'>SearchSysCache3</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN46"><span class='Ref_to_EnumConst'>CLAAMNAMENSP</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1280"><span class='Ref_to_Parameter'>accessMethodId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1283"><span class='Ref_To_Local'>opcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1339"><span class='Ref_To_Local'>namespaceId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Unqualified opclass name, so search the search path */ 
</span>        <a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN82"><span class='Ref_to_Proto'>OpclassnameGetOpcid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1280"><span class='Ref_to_Parameter'>accessMethodId</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1283"><span class='Ref_To_Local'>opcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"operator class \"%s\" does not exist for access method \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="indexcmds.c.html#LN1283"><span class='Ref_To_Local'>opcname</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1280"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1284"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN47"><span class='Ref_to_EnumConst'>CLAOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1284"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"operator class \"%s\" does not exist for access method \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../include/catalog/namespace.h.html#LN120"><span class='Ref_to_Proto'>NameListToString</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1280"><span class='Ref_to_Parameter'>accessMethodName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify that the index operator class accepts this datatype.  Note we 
     * will accept binary compatibility. 
     */ 
</span>    <a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1284"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN1286"><span class='Ref_To_Local'>opInputType</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_opclass.h.html#LN67"><span class='Ref_to_Typedef'>Form_pg_opclass</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1284"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>opcintype<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/parser/parse_coerce.h.html#LN33"><span class='Ref_to_Proto'>IsBinaryCoercible</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>attrType</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1286"><span class='Ref_To_Local'>opInputType</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"operator class \"%s\" does not accept data type %s"</span><span class='Delimiter'>, 
</span>                      <a href="../../include/catalog/namespace.h.html#LN120"><span class='Ref_to_Proto'>NameListToString</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>opclass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1279"><span class='Ref_to_Parameter'>attrType</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1284"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1285"><span class='Ref_To_Local'>opClassId</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ResolveOpClass &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetDefaultOpClass 
 * 
 * Given the OIDs of a datatype and an access method, find the default 
 * operator class, if any.  Returns InvalidOid if there is none. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1390"></a><span class='Declare_Function'>GetDefaultOpClass</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>type_id</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>am_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1392"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN1393"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nexact</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1394"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ncompatible</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1395"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ncompatiblepreferred</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1396"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1397"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1398"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1399"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN1400"></a>    <a href="../../include/parser/parse_coerce.h.html#LN20"><span class='Ref_to_Typedef'>TYPCATEGORY</span></a> <span class='Declare_Local'>tcategory</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If it's a domain, look at the base type instead */ 
</span>    <a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>type_id</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN168"><span class='Ref_to_Proto'>getBaseType</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>type_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN1400"><span class='Ref_To_Local'>tcategory</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_coerce.h.html#LN35"><span class='Ref_to_Proto'>TypeCategory</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>type_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We scan through all the opclasses available for the access method, 
     * looking for one that is marked default and matches the target type 
     * (either exactly or binary-compatibly, but prefer an exact match). 
     * 
     * We could find more than one binary-compatible match.  If just one is 
     * for a preferred type, use that one; otherwise we fail, forcing the user 
     * to specify which one he wants.  (The preferred-type special case is a 
     * kluge for varchar: it's binary-compatible to both text and bpchar, so 
     * we need a tiebreaker.)  If we find more than one exact match, then 
     * someone put bogus entries in pg_opclass. 
     */ 
</span>    <a href="indexcmds.c.html#LN1396"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_opclass.h.html#LN48"><span class='Ref_to_Const'>OperatorClassRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="indexcmds.c.html#LN1397"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_opclass.h.html#LN74"><span class='Ref_to_Const'>Anum_pg_opclass_opcmethod</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>am_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN1398"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1396"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN197"><span class='Ref_to_Const'>OpclassAmNameNspIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1397"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1399"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1398"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1431"></a>        <a href="../../include/catalog/pg_opclass.h.html#LN67"><span class='Ref_to_Typedef'>Form_pg_opclass</span></a> <span class='Declare_Local'>opclass</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_opclass.h.html#LN67"><span class='Ref_to_Typedef'>Form_pg_opclass</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1399"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ignore altogether if not a default opclass */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN1431"><span class='Ref_To_Local'>opclass</span></a><span class='Operator'>-&GT;</span>opcdefault<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1431"><span class='Ref_To_Local'>opclass</span></a><span class='Operator'>-&GT;</span>opcintype <span class='Operator'>== </span><a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>type_id</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="indexcmds.c.html#LN1393"><span class='Ref_To_Local'>nexact</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1392"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1399"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1393"><span class='Ref_To_Local'>nexact</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                 <a href="../../include/parser/parse_coerce.h.html#LN33"><span class='Ref_to_Proto'>IsBinaryCoercible</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>type_id</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1431"><span class='Ref_To_Local'>opclass</span></a><span class='Operator'>-&GT;</span>opcintype<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/parser/parse_coerce.h.html#LN34"><span class='Ref_to_Proto'>IsPreferredType</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1400"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1431"><span class='Ref_To_Local'>opclass</span></a><span class='Operator'>-&GT;</span>opcintype<span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="indexcmds.c.html#LN1395"><span class='Ref_To_Local'>ncompatiblepreferred</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="indexcmds.c.html#LN1392"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1399"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1395"><span class='Ref_To_Local'>ncompatiblepreferred</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="indexcmds.c.html#LN1394"><span class='Ref_To_Local'>ncompatible</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="indexcmds.c.html#LN1392"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1399"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while HeapTupleIsValid(tup=... &raquo; </span> 
 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1398"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1396"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* raise error if pg_opclass contains inconsistent data */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1393"><span class='Ref_To_Local'>nexact</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"there are multiple default operator classes for data type %s"</span><span class='Delimiter'>, 
</span>               <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1390"><span class='Ref_to_Parameter'>type_id</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1393"><span class='Ref_To_Local'>nexact</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="indexcmds.c.html#LN1395"><span class='Ref_To_Local'>ncompatiblepreferred</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1395"><span class='Ref_To_Local'>ncompatiblepreferred</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="indexcmds.c.html#LN1394"><span class='Ref_To_Local'>ncompatible</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="indexcmds.c.html#LN1392"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetDefaultOpClass &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  makeObjectName() 
 * 
 *  Create a name for an implicitly created index, sequence, constraint, etc. 
 * 
 *  The parameters are typically: the original table name, the original field 
 *  name, and a "type" string (such as "seq" or "pkey").    The field name 
 *  and/or type can be NULL if not relevant. 
 * 
 *  The result is a palloc'd string. 
 * 
 *  The basic result we want is "name1_name2_label", omitting "_name2" or 
 *  "_label" when those parameters are NULL.  However, we must generate 
 *  a name with less than NAMEDATALEN characters!  So, we truncate one or 
 *  both names if necessary to make a short-enough string.  The label part 
 *  is never truncated (so it had better be reasonably short). 
 * 
 *  The caller is responsible for checking uniqueness of the generated 
 *  name and retrying as needed; retrying will be done by altering the 
 *  "label" string (which is why we never truncate that part). 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1498"></a><span class='Declare_Function'>makeObjectName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name1</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name2</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>label</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1500"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>; 
</span><a name="LN1501"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>overhead</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* chars needed for label and underscores */ 
</span><a name="LN1502"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>availchars</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* chars available for name(s) */ 
</span><a name="LN1503"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>name1chars</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* chars allocated to name1 */ 
</span><a name="LN1504"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>name2chars</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* chars allocated to name2 */ 
</span><a name="LN1505"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndx</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name2</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1501"><span class='Ref_To_Local'>overhead</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* allow for separating underscore */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>label</span></a><span class='Parentheses'>) 
</span>        <a href="indexcmds.c.html#LN1501"><span class='Ref_To_Local'>overhead</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>label</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN1502"><span class='Ref_To_Local'>availchars</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span> <span class='Operator'>- </span><a href="indexcmds.c.html#LN1501"><span class='Ref_To_Local'>overhead</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1502"><span class='Ref_To_Local'>availchars</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* else caller chose a bad label */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we must truncate,  preferentially truncate the longer name. This 
     * logic could be expressed without a loop, but it's simple and obvious as 
     * a loop. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a> <span class='Operator'>&GT; </span><a href="indexcmds.c.html#LN1502"><span class='Ref_To_Local'>availchars</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a> <span class='Operator'>&GT; </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN530"><span class='Ref_to_Proto'>pg_mbcliplen</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name1</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name2</span></a><span class='Parentheses'>) 
</span>        <a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN530"><span class='Ref_to_Proto'>pg_mbcliplen</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name2</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now construct the string using the chosen lengths */ 
</span>    <a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1501"><span class='Ref_To_Local'>overhead</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name1</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1503"><span class='Ref_To_Local'>name1chars</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name2</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'_'</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>name2</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a> <span class='Operator'>+= </span><a href="indexcmds.c.html#LN1504"><span class='Ref_To_Local'>name2chars</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>label</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'_'</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1498"><span class='Ref_to_Parameter'>label</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1505"><span class='Ref_To_Local'>ndx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1500"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end makeObjectName &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Select a nonconflicting name for a new relation.  This is ordinarily 
 * used to choose index names (which is why it's here) but it can also 
 * be used for sequences, or any autogenerated relation kind. 
 * 
 * name1, name2, and label are used the same way as for makeObjectName(), 
 * except that the label can't be NULL; digits will be appended to the label 
 * if needed to create a name that is unique within the specified namespace. 
 * 
 * Note: it is theoretically possible to get a collision anyway, if someone 
 * else chooses the same name concurrently.  This is fairly unlikely to be 
 * a problem in practice, especially if one is holding an exclusive lock on 
 * the relation identified by name1.  However, if choosing multiple names 
 * within a single command, you'd better create the new object and do 
 * CommandCounterIncrement before choosing the next one! 
 * 
 * Returns a palloc'd string. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1578"></a><span class='Declare_Function'>ChooseRelationName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name1</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name2</span><span class='Delimiter'>, 
</span><a name="LN1579"></a>                   <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>label</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>namespaceid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1581"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pass</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1582"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1583"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>modlabel</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* try the unmodified label first */ 
</span>    <a href="../../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1583"><span class='Ref_To_Local'>modlabel</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1579"><span class='Ref_to_Parameter'>label</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1583"><span class='Ref_To_Local'>modlabel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1582"><span class='Ref_To_Local'>relname</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN36"><span class='Ref_to_Proto'>makeObjectName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1578"><span class='Ref_to_Parameter'>name1</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1578"><span class='Ref_to_Parameter'>name2</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1583"><span class='Ref_To_Local'>modlabel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN123"><span class='Ref_to_Proto'>get_relname_relid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1582"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1579"><span class='Ref_to_Parameter'>namespaceid</span></a><span class='Parentheses'>)))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* found a conflict, so try a new name component */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1582"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1583"><span class='Ref_To_Local'>modlabel</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1583"><span class='Ref_To_Local'>modlabel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s%d"</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1579"><span class='Ref_to_Parameter'>label</span></a><span class='Delimiter'>, </span><span class='Operator'>++</span><a href="indexcmds.c.html#LN1581"><span class='Ref_To_Local'>pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1582"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ChooseRelationName &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Select the name to be used for an index. 
 * 
 * The argument list is pretty ad-hoc :-( 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1609"></a><span class='Declare_Function'>ChooseIndexName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tabname</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>namespaceId</span><span class='Delimiter'>, 
</span><a name="LN1610"></a>                <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colnames</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>exclusionOpNames</span><span class='Delimiter'>, 
</span><a name="LN1611"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>primary</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isconstraint</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1613"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>indexname</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1611"><span class='Ref_to_Parameter'>primary</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* the primary key's name does not depend on the specific column(s) */ 
</span>        <a href="indexcmds.c.html#LN1613"><span class='Ref_To_Local'>indexname</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN38"><span class='Ref_to_Proto'>ChooseRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>tabname</span></a><span class='Delimiter'>, 
</span>                                       <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"pkey"</span><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>namespaceId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1610"><span class='Ref_to_Parameter'>exclusionOpNames</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1613"><span class='Ref_To_Local'>indexname</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN38"><span class='Ref_to_Proto'>ChooseRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>tabname</span></a><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN75"><span class='Ref_to_Proto'>ChooseIndexNameAddition</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1610"><span class='Ref_to_Parameter'>colnames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"excl"</span><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>namespaceId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1611"><span class='Ref_to_Parameter'>isconstraint</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1613"><span class='Ref_To_Local'>indexname</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN38"><span class='Ref_to_Proto'>ChooseRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>tabname</span></a><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN75"><span class='Ref_to_Proto'>ChooseIndexNameAddition</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1610"><span class='Ref_to_Parameter'>colnames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"key"</span><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>namespaceId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1613"><span class='Ref_To_Local'>indexname</span></a> <span class='Operator'>= </span><a href="../../include/commands/defrem.h.html#LN38"><span class='Ref_to_Proto'>ChooseRelationName</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>tabname</span></a><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN75"><span class='Ref_to_Proto'>ChooseIndexNameAddition</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1610"><span class='Ref_to_Parameter'>colnames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <span class='String'>"idx"</span><span class='Delimiter'>, 
</span>                                       <a href="indexcmds.c.html#LN1609"><span class='Ref_to_Parameter'>namespaceId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1613"><span class='Ref_To_Local'>indexname</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ChooseIndexName &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Generate "name2" for a new index given the list of column names for it 
 * (as produced by ChooseIndexColumnNames).  This will be passed to 
 * ChooseRelationName along with the parent table name and a suitable label. 
 * 
 * We know that less than NAMEDATALEN characters will actually be used, 
 * so we can truncate the result once we've generated that many. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1657"></a><span class='Declare_Function'>ChooseIndexNameAddition</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>colnames</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1659"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1660"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>buflen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1661"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="indexcmds.c.html#LN1659"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1661"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1657"><span class='Ref_to_Parameter'>colnames</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1666"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>name</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1661"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1660"><span class='Ref_To_Local'>buflen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN1659"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><a href="indexcmds.c.html#LN1660"><span class='Ref_To_Local'>buflen</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'_'</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* insert _ between names */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * At this point we have buflen &LT;= NAMEDATALEN.  name should be less 
         * than NAMEDATALEN already, but use strlcpy for paranoia. 
         */ 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1659"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1660"><span class='Ref_To_Local'>buflen</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1666"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="indexcmds.c.html#LN1660"><span class='Ref_To_Local'>buflen</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1659"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1660"><span class='Ref_To_Local'>buflen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1660"><span class='Ref_To_Local'>buflen</span></a> <span class='Operator'>&GT;= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1659"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ChooseIndexNameAddition &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Select the actual names to be used for the columns of an index, given the 
 * list of IndexElems for the columns.  This is mostly about ensuring the 
 * names are unique so we don't get a conflicting-attribute-names error. 
 * 
 * Returns a List of plain strings (char *, not String nodes). 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN1691"></a><span class='Declare_Function'>ChooseIndexColumnNames</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexElems</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1693"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1694"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1694"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1691"><span class='Ref_to_Parameter'>indexElems</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1698"></a>        <a href="../../include/nodes/parsenodes.h.html#LN685"><span class='Ref_to_Struct'>IndexElem</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>ielem</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN685"><span class='Ref_to_Struct'>IndexElem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1694"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1699"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>origname</span><span class='Delimiter'>; 
</span><a name="LN1700"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>curname</span><span class='Delimiter'>; 
</span><a name="LN1701"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1702"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the preliminary name from the IndexElem */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1698"><span class='Ref_To_Local'>ielem</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN690"><span class='Ref_to_Member'>indexcolname</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1698"><span class='Ref_To_Local'>ielem</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN690"><span class='Ref_to_Member'>indexcolname</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* caller-specified name */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1698"><span class='Ref_To_Local'>ielem</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN688"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1698"><span class='Ref_To_Local'>ielem</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN688"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* simple column reference */ 
</span>        <span class='Control'>else</span> 
            <a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a> <span class='Operator'>= </span><span class='String'>"expr"</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* default name for expression */ 
</span> 
        <span class='Comment_Multi_Line'>/* If it conflicts with any previous column, tweak it */ 
</span>        <a href="indexcmds.c.html#LN1700"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1701"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;; </span><a href="indexcmds.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1716"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc2</span><span class='Delimiter'>; 
</span><a name="LN1717"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>nbuf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN1718"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nlen</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1716"><span class='Ref_To_Local'>lc2</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1693"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1700"><span class='Ref_To_Local'>curname</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1716"><span class='Ref_To_Local'>lc2</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1716"><span class='Ref_To_Local'>lc2</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* found nonconflicting name */ 
</span> 
            <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1717"><span class='Ref_To_Local'>nbuf</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1701"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Ensure generated names are shorter than NAMEDATALEN */ 
</span>            <a href="indexcmds.c.html#LN1718"><span class='Ref_To_Local'>nlen</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN530"><span class='Ref_to_Proto'>pg_mbcliplen</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span> <span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1717"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1702"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1699"><span class='Ref_To_Local'>origname</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1718"><span class='Ref_To_Local'>nlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1702"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span><a href="indexcmds.c.html#LN1718"><span class='Ref_To_Local'>nlen</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1717"><span class='Ref_To_Local'>nbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="indexcmds.c.html#LN1700"><span class='Ref_To_Local'>curname</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1702"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;;i++ &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* And attach to the result list */ 
</span>        <a href="indexcmds.c.html#LN1693"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1693"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1700"><span class='Ref_To_Local'>curname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1693"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ChooseIndexColumnNames &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReindexIndex 
 *      Recreate a specific index. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1749"></a><span class='Declare_Function'>ReindexIndex</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>indexRelation</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1751"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indOid</span><span class='Delimiter'>; 
</span><a name="LN1752"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>heapOid</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN1753"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>irel</span><span class='Delimiter'>; 
</span><a name="LN1754"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>persistence</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find and lock index, and check permissions on table; use callback to 
     * obtain lock on table first, to avoid deadlock hazard.  The lock level 
     * used here must match the index lock obtained in reindex_index(). 
     */ 
</span>    <a href="indexcmds.c.html#LN1751"><span class='Ref_To_Local'>indOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1749"><span class='Ref_to_Parameter'>indexRelation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                      <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                      <a href="indexcmds.c.html#LN77"><span class='Ref_to_Proto'>RangeVarCallbackForReindexIndex</span></a><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="indexcmds.c.html#LN1752"><span class='Ref_To_Local'>heapOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Obtain the current persistence of the existing index.  We already hold 
     * lock on the index. 
     */ 
</span>    <a href="indexcmds.c.html#LN1753"><span class='Ref_To_Local'>irel</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1751"><span class='Ref_To_Local'>indOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN1754"><span class='Ref_To_Local'>persistence</span></a> <span class='Operator'>= </span><a href="indexcmds.c.html#LN1753"><span class='Ref_To_Local'>irel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence<span class='Delimiter'>; 
</span>    <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1753"><span class='Ref_To_Local'>irel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/index.h.html#LN117"><span class='Ref_to_Proto'>reindex_index</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1751"><span class='Ref_To_Local'>indOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1754"><span class='Ref_To_Local'>persistence</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1749"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1751"><span class='Ref_To_Local'>indOid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReindexIndex &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check permissions on table before acquiring relation lock; also lock 
 * the heap before the RangeVarGetRelidExtended takes the index lock, to avoid 
 * deadlocks. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1785"></a><span class='Declare_Function'>RangeVarCallbackForReindexIndex</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN1786"></a>                                <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldRelId</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1788"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>relkind</span><span class='Delimiter'>; 
</span><a name="LN1789"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>heapOid</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we previously locked some other index's heap, and the name we're 
     * looking up no longer refers to that relation, release the now-useless 
     * lock. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>relId</span></a> <span class='Operator'>!= </span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>oldRelId</span></a> <span class='Operator'>&& </span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>oldRelId</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* lock level here should match reindex_index() heap lock */ 
</span>        <a href="../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="indexcmds.c.html#LN1789"><span class='Ref_To_Local'>heapOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="indexcmds.c.html#LN1789"><span class='Ref_To_Local'>heapOid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If the relation does not exist, there's nothing more to do. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>relId</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the relation does exist, check whether it's an index.  But note that 
     * the relation might have been dropped between the time we did the name 
     * lookup and now.  In that case, there's nothing to do. 
     */ 
</span>    <a href="indexcmds.c.html#LN1788"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN127"><span class='Ref_to_Proto'>get_rel_relkind</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="indexcmds.c.html#LN1788"><span class='Ref_To_Local'>relkind</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1788"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not an index"</span><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1785"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check permissions */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>relId</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1785"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lock heap before index to avoid deadlock. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>relId</span></a> <span class='Operator'>!= </span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>oldRelId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Lock level here should match reindex_index() heap lock. If the OID 
         * isn't valid, it means the index as concurrently dropped, which is 
         * not a problem for us; just return normally. 
         */ 
</span>        <span class='Operator'>*</span><a href="indexcmds.c.html#LN1789"><span class='Ref_To_Local'>heapOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/index.h.html#LN131"><span class='Ref_to_Proto'>IndexGetRelation</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1786"><span class='Ref_to_Parameter'>relId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="indexcmds.c.html#LN1789"><span class='Ref_To_Local'>heapOid</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="indexcmds.c.html#LN1789"><span class='Ref_To_Local'>heapOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end RangeVarCallbackForReindexIndex &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReindexTable 
 *      Recreate all indexes of a table (and of its toast table, if any) 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1843"></a><span class='Declare_Function'>ReindexTable</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1845"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>heapOid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The lock level used here should match reindex_relation(). */ 
</span>    <a href="indexcmds.c.html#LN1845"><span class='Ref_To_Local'>heapOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1843"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                       <a href="../../include/commands/tablecmds.h.html#LN84"><span class='Ref_to_Proto'>RangeVarCallbackOwnsTable</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/catalog/index.h.html#LN127"><span class='Ref_to_Proto'>reindex_relation</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1845"><span class='Ref_To_Local'>heapOid</span></a><span class='Delimiter'>, 
</span>                          <a href="../../include/catalog/index.h.html#LN121"><span class='Ref_to_Const'>REINDEX_REL_PROCESS_TOAST</span></a> <span class='Operator'>| 
</span>                          <a href="../../include/catalog/index.h.html#LN123"><span class='Ref_to_Const'>REINDEX_REL_CHECK_CONSTRAINTS</span></a><span class='Delimiter'>, 
</span>                          <a href="indexcmds.c.html#LN1843"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"table \"%s\" has no indexes"</span><span class='Delimiter'>, 
</span>                        <a href="indexcmds.c.html#LN1843"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="indexcmds.c.html#LN1845"><span class='Ref_To_Local'>heapOid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ReindexMultipleTables 
 *      Recreate indexes of tables selected by objectName/objectKind. 
 * 
 * To reduce the probability of deadlocks, each table is reindexed in a 
 * separate transaction, so we can release the lock on it right away. 
 * That means this must not be called within a user transaction block! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1871"></a><span class='Declare_Function'>ReindexMultipleTables</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>objectName</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN3189"><span class='Ref_to_Enum'>ReindexObjectType</span></a> <span class='Declare_Parameter'>objectKind</span><span class='Delimiter'>, 
</span><a name="LN1872"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1874"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>objectOid</span><span class='Delimiter'>; 
</span><a name="LN1875"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>relationRelation</span><span class='Delimiter'>; 
</span><a name="LN1876"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1877"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>scan_keys</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1878"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1879"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>private_context</span><span class='Delimiter'>; 
</span><a name="LN1880"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>old</span><span class='Delimiter'>; 
</span><a name="LN1881"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>relids</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1882"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span><a name="LN1883"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_keys</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectKind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN3193"><span class='Ref_to_EnumConst'>REINDEX_OBJECT_SCHEMA</span></a> <span class='Operator'>|| 
</span>           <a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectKind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN3194"><span class='Ref_to_EnumConst'>REINDEX_OBJECT_SYSTEM</span></a> <span class='Operator'>|| 
</span>           <a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectKind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN3195"><span class='Ref_to_EnumConst'>REINDEX_OBJECT_DATABASE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get OID of object to reindex, being the database currently being used 
     * by session for a database or for system catalogs, or the schema defined 
     * by caller. At the same time do permission checks that need different 
     * processing depending on the object type. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectKind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN3193"><span class='Ref_to_EnumConst'>REINDEX_OBJECT_SCHEMA</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1874"><span class='Ref_To_Local'>objectOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN114"><span class='Ref_to_Proto'>get_namespace_oid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectName</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN314"><span class='Ref_to_Proto'>pg_namespace_ownercheck</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1874"><span class='Ref_To_Local'>objectOid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
            <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN189"><span class='Ref_to_EnumConst'>ACL_KIND_NAMESPACE</span></a><span class='Delimiter'>, 
</span>                           <a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1874"><span class='Ref_To_Local'>objectOid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectName</span></a><span class='Delimiter'>, </span><a href="../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1874"><span class='Ref_To_Local'>objectOid</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"can only reindex the currently open database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN318"><span class='Ref_to_Proto'>pg_database_ownercheck</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1874"><span class='Ref_To_Local'>objectOid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
            <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN183"><span class='Ref_to_EnumConst'>ACL_KIND_DATABASE</span></a><span class='Delimiter'>, 
</span>                           <a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a memory context that will survive forced transaction commits we 
     * do below.  Since it is a child of PortalContext, it will go away 
     * eventually even if we suffer an error; there's no need for special 
     * abort cleanup logic. 
     */ 
</span>    <a href="indexcmds.c.html#LN1879"><span class='Ref_To_Local'>private_context</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN51"><span class='Ref_to_Global_Var'>PortalContext</span></a><span class='Delimiter'>, 
</span>                                            <span class='String'>"ReindexMultipleTables"</span><span class='Delimiter'>, 
</span>                                            <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Define the search keys to find the objects to reindex. For a schema, we 
     * select target relations using relnamespace, something not necessary for 
     * a database-wide operation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectKind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN3193"><span class='Ref_to_EnumConst'>REINDEX_OBJECT_SCHEMA</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="indexcmds.c.html#LN1883"><span class='Ref_To_Local'>num_keys</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="indexcmds.c.html#LN1877"><span class='Ref_To_Local'>scan_keys</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                    <a href="../../include/catalog/pg_class.h.html#LN103"><span class='Ref_to_Const'>Anum_pg_class_relnamespace</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1874"><span class='Ref_To_Local'>objectOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="indexcmds.c.html#LN1883"><span class='Ref_To_Local'>num_keys</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan pg_class to build a list of the relations we need to reindex. 
     * 
     * We only consider plain relations and materialized views here (toast 
     * rels will be processed indirectly by reindex_relation). 
     */ 
</span>    <a href="indexcmds.c.html#LN1875"><span class='Ref_To_Local'>relationRelation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="indexcmds.c.html#LN1876"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1875"><span class='Ref_To_Local'>relationRelation</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1883"><span class='Ref_To_Local'>num_keys</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1877"><span class='Ref_To_Local'>scan_keys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="indexcmds.c.html#LN1878"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1876"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1953"></a>        <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classtuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1878"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1954"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1878"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Only regular tables and matviews can have indexes, so ignore any 
         * other kind of relation. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1953"><span class='Ref_To_Local'>classtuple</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>            <a href="indexcmds.c.html#LN1953"><span class='Ref_To_Local'>classtuple</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip temp tables of other backends; we can't reindex them at all */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1953"><span class='Ref_To_Local'>classtuple</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../include/catalog/namespace.h.html#LN123"><span class='Ref_to_Proto'>isTempNamespace</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1953"><span class='Ref_To_Local'>classtuple</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check user/system classification, and optionally skip */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1871"><span class='Ref_to_Parameter'>objectKind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN3194"><span class='Ref_to_EnumConst'>REINDEX_OBJECT_SYSTEM</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../include/catalog/catalog.h.html#LN33"><span class='Ref_to_Proto'>IsSystemClass</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1954"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1953"><span class='Ref_To_Local'>classtuple</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Save the list of relation OIDs in private context */ 
</span>        <a href="indexcmds.c.html#LN1880"><span class='Ref_To_Local'>old</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1879"><span class='Ref_To_Local'>private_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We always want to reindex pg_class first if it's selected to be 
         * reindexed.  This ensures that if there is any corruption in 
         * pg_class' indexes, they will be fixed before we process any other 
         * tables.  This is critical because reindexing itself will try to 
         * update pg_class. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1954"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Parentheses'>) 
</span>            <a href="indexcmds.c.html#LN1881"><span class='Ref_To_Local'>relids</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN217"><span class='Ref_to_Proto'>lcons_oid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1954"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1881"><span class='Ref_To_Local'>relids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="indexcmds.c.html#LN1881"><span class='Ref_To_Local'>relids</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN162"><span class='Ref_to_Func'>lappend_oid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1881"><span class='Ref_To_Local'>relids</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1954"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1880"><span class='Ref_To_Local'>old</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=heap_getnext(s... &raquo; </span> 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1876"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1875"><span class='Ref_To_Local'>relationRelation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now reindex each rel in a separate transaction */ 
</span>    <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1882"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="indexcmds.c.html#LN1881"><span class='Ref_To_Local'>relids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1999"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1882"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* functions in indexes may want a snapshot set */ 
</span>        <a href="../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/catalog/index.h.html#LN127"><span class='Ref_to_Proto'>reindex_relation</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1999"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/catalog/index.h.html#LN121"><span class='Ref_to_Const'>REINDEX_REL_PROCESS_TOAST</span></a> <span class='Operator'>| 
</span>                             <a href="../../include/catalog/index.h.html#LN123"><span class='Ref_to_Const'>REINDEX_REL_CHECK_CONSTRAINTS</span></a><span class='Delimiter'>, 
</span>                             <a href="indexcmds.c.html#LN1872"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>))</span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1872"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3187"><span class='Ref_to_Const'>REINDEXOPT_VERBOSE</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN32"><span class='Ref_to_Const'>INFO</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"table \"%s.%s\" was reindexed"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN125"><span class='Ref_to_Proto'>get_rel_namespace</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1999"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1999"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="indexcmds.c.html#LN1879"><span class='Ref_To_Local'>private_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReindexMultipleTables &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>