<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\commands\matview.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\commands\matview.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:35 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * matview.c 
 *    materialized view support 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/commands/matview.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_operator.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/cluster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/matview.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/executor.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_relation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteHandler.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN47"></a>    <a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Declare_Member'>pub</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* publicly-known function pointers */ 
</span><a name="LN48"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>transientoid</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* OID of new heap into which to store */ 
</span>    <span class='Comment_Multi_Line'>/* These fields are filled by transientrel_startup: */ 
</span><a name="LN50"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>transientrel</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* relation to write to */ 
</span><a name="LN51"></a>    <a href="../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Member'>output_cid</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* cmin to insert in output tuples */ 
</span><a name="LN52"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>hi_options</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* heap_insert performance options */ 
</span><a name="LN53"></a>    <a href="../../include/access/heapam.h.html#LN32"><span class='Ref_to_Typedef'>BulkInsertState</span></a> <span class='Declare_Member'>bistate</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* bulk insert state */ 
</span><a name="LN54"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>DR_transientrel</span><span class='Delimiter'>; 
</span> 
<a name="LN56"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>matview_maintenance_depth</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN58"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>transientrel_startup</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>operation</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>typeinfo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN59"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>transientrel_receive</span><span class='Parentheses'>(</span><a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN60"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>transientrel_shutdown</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN61"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>transientrel_destroy</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN62"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Prototype'>refresh_matview_datafill</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, 
</span><a name="LN63"></a>                         <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>queryString</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN65"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>make_temptable_name_n</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tempname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN66"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>mv_GenerateOper</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>opoid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN68"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>refresh_by_match_merge</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>matviewOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tempOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relowner</span><span class='Delimiter'>, 
</span><a name="LN69"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>save_sec_context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>refresh_by_heap_swap</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>matviewOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>OIDNewHeap</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Declare_Parameter'>relpersistence</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN72"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>OpenMatViewIncrementalMaintenance</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN73"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CloseMatViewIncrementalMaintenance</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SetMatViewPopulatedState 
 *      Mark a materialized view as populated, or not. 
 * 
 * NOTE: caller must be holding an appropriate lock on the relation. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN82"></a><span class='Declare_Function'>SetMatViewPopulatedState</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>newstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN84"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pgrel</span><span class='Delimiter'>; 
</span><a name="LN85"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="matview.c.html#LN82"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update relation's pg_class entry.  Crucial side-effect: other backends 
     * (and this one too!) are sent SI message to make them rebuild relcache 
     * entries. 
     */ 
</span>    <a href="matview.c.html#LN84"><span class='Ref_To_Local'>pgrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN85"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN82"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN85"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN82"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN85"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>relispopulated <span class='Operator'>= </span><a href="matview.c.html#LN82"><span class='Ref_to_Parameter'>newstate</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN84"><span class='Ref_To_Local'>pgrel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="matview.c.html#LN85"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN85"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN85"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN84"><span class='Ref_To_Local'>pgrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance command counter to make the updated pg_class row locally 
     * visible. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetMatViewPopulatedState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecRefreshMatView -- execute a REFRESH MATERIALIZED VIEW command 
 * 
 * This refreshes the materialized view by creating a new table and swapping 
 * the relfilenodes of the new table and the old materialized view, so the OID 
 * of the original materialized view is preserved. Thus we do not lose GRANT 
 * nor references to this materialized view. 
 * 
 * If WITH NO DATA was specified, this is effectively like a TRUNCATE; 
 * otherwise it is like a TRUNCATE followed by an INSERT using the SELECT 
 * statement associated with the materialized view.  The statement node's 
 * skipData field shows whether the clause was used. 
 * 
 * Indexes are rebuilt too, via REINDEX. Since we are effectively bulk-loading 
 * the new heap, it's better to create the indexes afterwards than to fill them 
 * incrementally while we load. 
 * 
 * The matview's "populated" state is changed based on whether the contents 
 * reflect the result set of the materialized view's query. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN136"></a><span class='Declare_Function'>ExecRefreshMatView</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN3122"><span class='Ref_to_Struct'>RefreshMatViewStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>queryString</span><span class='Delimiter'>, 
</span><a name="LN137"></a>                   <a href="../../include/nodes/params.h.html#LN61"><span class='Ref_to_Typedef'>ParamListInfo</span></a> <span class='Declare_Parameter'>params</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>completionTag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN139"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>matviewOid</span><span class='Delimiter'>; 
</span><a name="LN140"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>matviewRel</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rule</span><span class='Delimiter'>; 
</span><a name="LN142"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>actions</span><span class='Delimiter'>; 
</span><a name="LN143"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>dataQuery</span><span class='Delimiter'>; 
</span><a name="LN144"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tableSpace</span><span class='Delimiter'>; 
</span><a name="LN145"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relowner</span><span class='Delimiter'>; 
</span><a name="LN146"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>OIDNewHeap</span><span class='Delimiter'>; 
</span><a name="LN147"></a>    <a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dest</span><span class='Delimiter'>; 
</span><a name="LN148"></a>    <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>processed</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN149"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>concurrent</span><span class='Delimiter'>; 
</span><a name="LN150"></a>    <a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN151"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>relpersistence</span><span class='Delimiter'>; 
</span><a name="LN152"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>save_userid</span><span class='Delimiter'>; 
</span><a name="LN153"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_sec_context</span><span class='Delimiter'>; 
</span><a name="LN154"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_nestlevel</span><span class='Delimiter'>; 
</span><a name="LN155"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Determine strength of lock needed. */ 
</span>    <a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3125"><span class='Ref_to_Member'>concurrent</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN150"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a> <span class='Operator'>? </span><a href="../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a> <span class='Operator'>: </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get a lock until end of transaction. 
     */ 
</span>    <a href="matview.c.html#LN139"><span class='Ref_To_Local'>matviewOid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3127"><span class='Ref_to_Member'>relation</span></a><span class='Delimiter'>, 
</span>                                          <a href="matview.c.html#LN150"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/commands/tablecmds.h.html#LN84"><span class='Ref_to_Proto'>RangeVarCallbackOwnsTable</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN139"><span class='Ref_To_Local'>matviewOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure it is a materialized view. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a materialized view"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that CONCURRENTLY is not specified if not populated. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a> <span class='Operator'>&& !</span><a href="../../include/utils/rel.h.html#LN552"><span class='Ref_to_Macro'>RelationIsPopulated</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"CONCURRENTLY cannot be used when the materialized view is not populated"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that conflicting options have not been specified. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a> <span class='Operator'>&& </span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3126"><span class='Ref_to_Member'>skipData</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"CONCURRENTLY and WITH NO DATA options cannot be used together"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We don't allow an oid column for a materialized view. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasoids<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that everything is correct for a refresh. Problems at this point 
     * are internal errors, so elog is sufficient. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasrules <span class='Operator'>== </span><span class='Boolean'>false </span><span class='Operator'>|| 
</span>        <a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"materialized view \"%s\" is missing rewrite information"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"materialized view \"%s\" has too many rules"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN141"><span class='Ref_To_Local'>rule</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN141"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a> <span class='Operator'>|| !</span><span class='Parentheses'>(</span><a href="matview.c.html#LN141"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN30"><span class='Ref_to_Member'>isInstead</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"the rule for materialized view \"%s\" is not a SELECT INSTEAD OF rule"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN142"><span class='Ref_To_Local'>actions</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN141"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN28"><span class='Ref_to_Member'>actions</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN142"><span class='Ref_To_Local'>actions</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"the rule for materialized view \"%s\" is not a single action"</span><span class='Delimiter'>, 
</span>             <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that there is a unique index with no WHERE clause on one or more 
     * columns of the materialized view if CONCURRENTLY is specified. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN224"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>indexoidlist</span> <span class='Operator'>= </span><a href="../../include/utils/relcache.h.html#LN40"><span class='Ref_to_Proto'>RelationGetIndexList</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN225"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>indexoidscan</span><span class='Delimiter'>; 
</span><a name="LN226"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>hasUniqueIndex</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN225"><span class='Ref_To_Local'>indexoidscan</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN224"><span class='Ref_To_Local'>indexoidlist</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN230"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indexoid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN225"><span class='Ref_To_Local'>indexoidscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN231"></a>            <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRel</span><span class='Delimiter'>; 
</span><a name="LN232"></a>            <a href="../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a> <span class='Declare_Local'>indexStruct</span><span class='Delimiter'>; 
</span> 
            <a href="matview.c.html#LN231"><span class='Ref_To_Local'>indexRel</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN230"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="matview.c.html#LN232"><span class='Ref_To_Local'>indexStruct</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN231"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN158"><span class='Ref_to_Member'>rd_index</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN232"><span class='Ref_To_Local'>indexStruct</span></a><span class='Operator'>-&GT;</span>indisunique <span class='Operator'>&& 
</span>                <a href="../../include/catalog/pg_index.h.html#LN106"><span class='Ref_to_Macro'>IndexIsValid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN232"><span class='Ref_To_Local'>indexStruct</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <a href="../../include/utils/relcache.h.html#LN45"><span class='Ref_to_Proto'>RelationGetIndexExpressions</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN231"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>&& 
</span>                <a href="../../include/utils/relcache.h.html#LN46"><span class='Ref_to_Proto'>RelationGetIndexPredicate</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN231"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>&& 
</span>                <a href="matview.c.html#LN232"><span class='Ref_To_Local'>indexStruct</span></a><span class='Operator'>-&GT;</span>indnatts <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="matview.c.html#LN226"><span class='Ref_To_Local'>hasUniqueIndex</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN231"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN231"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN224"><span class='Ref_To_Local'>indexoidlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="matview.c.html#LN226"><span class='Ref_To_Local'>hasUniqueIndex</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot refresh materialized view \"%s\" concurrently"</span><span class='Delimiter'>, 
</span>                      <a href="../../include/utils/builtins.h.html#LN78"><span class='Ref_to_Proto'>quote_qualified_identifier</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Create a unique index with no WHERE clause on one or more columns of the materialized view."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if concurrent &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * The stored query was rewritten at the time of the MV definition, but 
     * has not been scribbled on by the planner. 
     */ 
</span>    <a href="matview.c.html#LN143"><span class='Ref_To_Local'>dataQuery</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN142"><span class='Ref_To_Local'>actions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for active uses of the relation in the current transaction, such 
     * as open scans. 
     * 
     * NB: We count on this to protect us against problems with refreshing the 
     * data using HEAP_INSERT_FROZEN. 
     */ 
</span>    <a href="../../include/commands/tablecmds.h.html#LN52"><span class='Ref_to_Proto'>CheckTableNotInUse</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Delimiter'>, </span><span class='String'>"REFRESH MATERIALIZED VIEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Tentatively mark the matview as populated or not (this will roll back 
     * if we fail later). 
     */ 
</span>    <a href="../../include/commands/matview.h.html#LN23"><span class='Ref_to_Proto'>SetMatViewPopulatedState</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Delimiter'>, </span><span class='Operator'>!</span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3126"><span class='Ref_to_Member'>skipData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN145"><span class='Ref_To_Local'>relowner</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relowner<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Switch to the owner's userid, so that any functions are run as that 
     * user.  Also arrange to make GUC variable changes local to this command. 
     * Don't lock it down too tight to create a temporary table just yet.  We 
     * will switch modes when we are about to execute user code. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN312"><span class='Ref_to_Proto'>GetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN152"><span class='Ref_To_Local'>save_userid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="matview.c.html#LN153"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN145"><span class='Ref_To_Local'>relowner</span></a><span class='Delimiter'>, 
</span>                           <a href="matview.c.html#LN153"><span class='Ref_To_Local'>save_sec_context</span></a> <span class='Operator'>| </span><a href="../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN154"><span class='Ref_To_Local'>save_nestlevel</span></a> <span class='Operator'>= </span><a href="../../include/utils/guc.h.html#LN354"><span class='Ref_to_Proto'>NewGUCNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Concurrent refresh builds new data in temp tablespace, and does diff. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="matview.c.html#LN144"><span class='Ref_To_Local'>tableSpace</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN51"><span class='Ref_to_Proto'>GetDefaultTablespace</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="matview.c.html#LN151"><span class='Ref_To_Local'>relpersistence</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="matview.c.html#LN144"><span class='Ref_To_Local'>tableSpace</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltablespace<span class='Delimiter'>; 
</span>        <a href="matview.c.html#LN151"><span class='Ref_To_Local'>relpersistence</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpersistence<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the transient table that will receive the regenerated data. Lock 
     * it against access by any other process until commit (by which time it 
     * will be gone). 
     */ 
</span>    <a href="matview.c.html#LN146"><span class='Ref_To_Local'>OIDNewHeap</span></a> <span class='Operator'>= </span><a href="../../include/commands/cluster.h.html#LN27"><span class='Ref_to_Proto'>make_new_heap</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN139"><span class='Ref_To_Local'>matviewOid</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN144"><span class='Ref_To_Local'>tableSpace</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN151"><span class='Ref_To_Local'>relpersistence</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN146"><span class='Ref_To_Local'>OIDNewHeap</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN147"><span class='Ref_To_Local'>dest</span></a> <span class='Operator'>= </span><a href="../../include/commands/matview.h.html#LN28"><span class='Ref_to_Proto'>CreateTransientRelDestReceiver</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN146"><span class='Ref_To_Local'>OIDNewHeap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now lock down security-restricted operations. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN145"><span class='Ref_To_Local'>relowner</span></a><span class='Delimiter'>, 
</span>                           <a href="matview.c.html#LN153"><span class='Ref_To_Local'>save_sec_context</span></a> <span class='Operator'>| </span><a href="../../include/miscadmin.h.html#LN296"><span class='Ref_to_Const'>SECURITY_RESTRICTED_OPERATION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate the data, if wanted. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3126"><span class='Ref_to_Member'>skipData</span></a><span class='Parentheses'>) 
</span>        <a href="matview.c.html#LN148"><span class='Ref_To_Local'>processed</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN62"><span class='Ref_to_Proto'>refresh_matview_datafill</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN147"><span class='Ref_To_Local'>dest</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN143"><span class='Ref_To_Local'>dataQuery</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>queryString</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make the matview match the newly generated data. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN149"><span class='Ref_To_Local'>concurrent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN331"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>old_depth</span> <span class='Operator'>= </span><a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <a href="matview.c.html#LN68"><span class='Ref_to_Proto'>refresh_by_match_merge</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN139"><span class='Ref_To_Local'>matviewOid</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN146"><span class='Ref_To_Local'>OIDNewHeap</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN145"><span class='Ref_To_Local'>relowner</span></a><span class='Delimiter'>, 
</span>                                   <a href="matview.c.html#LN153"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN331"><span class='Ref_To_Local'>old_depth</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a> <span class='Operator'>== </span><a href="matview.c.html#LN331"><span class='Ref_To_Local'>old_depth</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="matview.c.html#LN70"><span class='Ref_to_Proto'>refresh_by_heap_swap</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN139"><span class='Ref_To_Local'>matviewOid</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN146"><span class='Ref_To_Local'>OIDNewHeap</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN151"><span class='Ref_To_Local'>relpersistence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Inform stats collector about our activity: basically, we truncated 
         * the matview and inserted some new data.  (The concurrent code path 
         * above doesn't need to worry about this because the inserts and 
         * deletes it issues get counted by lower-level code.) 
         */ 
</span>        <a href="../../include/pgstat.h.html#LN1290"><span class='Ref_to_Proto'>pgstat_count_truncate</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="matview.c.html#LN136"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN3126"><span class='Ref_to_Member'>skipData</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/pgstat.h.html#LN1287"><span class='Ref_to_Proto'>pgstat_count_heap_insert</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN148"><span class='Ref_To_Local'>processed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN140"><span class='Ref_To_Local'>matviewRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Roll back any GUC changes */ 
</span>    <a href="../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="matview.c.html#LN154"><span class='Ref_To_Local'>save_nestlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore userid and security context */ 
</span>    <a href="../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN152"><span class='Ref_To_Local'>save_userid</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN153"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN155"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN139"><span class='Ref_To_Local'>matviewOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="matview.c.html#LN155"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecRefreshMatView &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * refresh_matview_datafill 
 * 
 * Execute the given query, sending result rows to "dest" (which will 
 * insert them into the target matview). 
 * 
 * Returns number of rows inserted. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> 
<a name="LN383"></a><span class='Declare_Function'>refresh_matview_datafill</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, 
</span><a name="LN384"></a>                         <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>queryString</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN386"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>rewritten</span><span class='Delimiter'>; 
</span><a name="LN387"></a>    <a href="../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plan</span><span class='Delimiter'>; 
</span><a name="LN388"></a>    <a href="../../include/executor/execdesc.h.html#LN32"><span class='Ref_to_Struct'>QueryDesc</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>queryDesc</span><span class='Delimiter'>; 
</span><a name="LN389"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>copied_query</span><span class='Delimiter'>; 
</span><a name="LN390"></a>    <a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>processed</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lock and rewrite, using a copy to preserve the original query. */ 
</span>    <a href="matview.c.html#LN389"><span class='Ref_To_Local'>copied_query</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN383"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/rewrite/rewriteHandler.h.html#LN20"><span class='Ref_to_Proto'>AcquireRewriteLocks</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN389"><span class='Ref_To_Local'>copied_query</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN386"><span class='Ref_To_Local'>rewritten</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteHandler.h.html#LN19"><span class='Ref_to_Proto'>QueryRewrite</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN389"><span class='Ref_To_Local'>copied_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* SELECT should never rewrite to more or less than one SELECT query */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN386"><span class='Ref_To_Local'>rewritten</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected rewrite result for REFRESH MATERIALIZED VIEW"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN383"><span class='Ref_to_Parameter'>query</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN386"><span class='Ref_To_Local'>rewritten</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for user-requested abort. */ 
</span>    <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Plan the query which will generate data for the refresh. */ 
</span>    <a href="matview.c.html#LN387"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="../../include/tcop/tcopprot.h.html#LN59"><span class='Ref_to_Proto'>pg_plan_query</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN383"><span class='Ref_to_Parameter'>query</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use a snapshot with an updated command ID to ensure this query sees 
     * results of any previously executed queries.  (This could only matter if 
     * the planner executed an allegedly-stable function that changed the 
     * database contents, but let's do it anyway to be safe.) 
     */ 
</span>    <a href="../../include/utils/snapmgr.h.html#LN74"><span class='Ref_to_Proto'>PushCopiedSnapshot</span></a><span class='Parentheses'>(</span><a href="../../include/utils/snapmgr.h.html#LN77"><span class='Ref_to_Proto'>GetActiveSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/snapmgr.h.html#LN75"><span class='Ref_to_Proto'>UpdateActiveSnapshotCommandId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create a QueryDesc, redirecting output to our tuple receiver */ 
</span>    <a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a> <span class='Operator'>= </span><a href="../../include/executor/execdesc.h.html#LN58"><span class='Ref_to_Proto'>CreateQueryDesc</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN387"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN384"><span class='Ref_to_Parameter'>queryString</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/snapmgr.h.html#LN77"><span class='Ref_to_Proto'>GetActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>, 
</span>                                <a href="matview.c.html#LN383"><span class='Ref_to_Parameter'>dest</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* call ExecutorStart to prepare the plan for execution */ 
</span>    <a href="../executor/execMain.c.html#LN144"><span class='Ref_to_Func'>ExecutorStart</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a><span class='Delimiter'>, </span><a href="../../include/executor/executor.h.html#LN63"><span class='Ref_to_Const'>EXEC_FLAG_WITHOUT_OIDS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* run the plan */ 
</span>    <a href="../../include/executor/executor.h.html#LN169"><span class='Ref_to_Proto'>ExecutorRun</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Delimiter'>, </span><span class='Number'>0L</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN390"><span class='Ref_To_Local'>processed</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/execdesc.h.html#LN47"><span class='Ref_to_Member'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN453"><span class='Ref_to_Member'>es_processed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and clean up */ 
</span>    <a href="../../include/executor/executor.h.html#LN173"><span class='Ref_to_Proto'>ExecutorFinish</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/executor/executor.h.html#LN175"><span class='Ref_to_Proto'>ExecutorEnd</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/executor/execdesc.h.html#LN67"><span class='Ref_to_Proto'>FreeQueryDesc</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN388"><span class='Ref_To_Local'>queryDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="matview.c.html#LN390"><span class='Ref_To_Local'>processed</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end refresh_matview_datafill &raquo; </span> 
 
<a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>* 
</span><a name="LN442"></a><span class='Declare_Function'>CreateTransientRelDestReceiver</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>transientoid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN444"></a>    <a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Declare_Local'>self</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN47"><span class='Ref_to_Member'>pub</span></a><span class='Operator'>.</span><a href="../../include/tcop/dest.h.html#LN117"><span class='Ref_to_Member'>receiveSlot</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN59"><span class='Ref_to_Proto'>transientrel_receive</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN47"><span class='Ref_to_Member'>pub</span></a><span class='Operator'>.</span><a href="../../include/tcop/dest.h.html#LN120"><span class='Ref_to_Member'>rStartup</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN58"><span class='Ref_to_Proto'>transientrel_startup</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN47"><span class='Ref_to_Member'>pub</span></a><span class='Operator'>.</span><a href="../../include/tcop/dest.h.html#LN123"><span class='Ref_to_Member'>rShutdown</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN60"><span class='Ref_to_Proto'>transientrel_shutdown</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN47"><span class='Ref_to_Member'>pub</span></a><span class='Operator'>.</span><a href="../../include/tcop/dest.h.html#LN125"><span class='Ref_to_Member'>rDestroy</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN61"><span class='Ref_to_Proto'>transientrel_destroy</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN47"><span class='Ref_to_Member'>pub</span></a><span class='Operator'>.</span><a href="../../include/tcop/dest.h.html#LN127"><span class='Ref_to_Member'>mydest</span></a> <span class='Operator'>= </span><a href="../../include/tcop/dest.h.html#LN97"><span class='Ref_to_EnumConst'>DestTransientRel</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN48"><span class='Ref_to_Member'>transientoid</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN442"><span class='Ref_to_Parameter'>transientoid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="matview.c.html#LN444"><span class='Ref_To_Local'>self</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * transientrel_startup --- executor startup 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN460"></a><span class='Declare_Function'>transientrel_startup</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>operation</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>typeinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN462"></a>    <a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myState</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="matview.c.html#LN460"><span class='Ref_to_Parameter'>self</span></a><span class='Delimiter'>; 
</span><a name="LN463"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>transientrel</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN463"><span class='Ref_To_Local'>transientrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN462"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN48"><span class='Ref_to_Member'>transientoid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fill private fields of myState for use by later routines 
     */ 
</span>    <a href="matview.c.html#LN462"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN50"><span class='Ref_to_Member'>transientrel</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN463"><span class='Ref_To_Local'>transientrel</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN462"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN51"><span class='Ref_to_Member'>output_cid</span></a> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can skip WAL-logging the insertions, unless PITR or streaming 
     * replication is in use. We can skip the FSM in any case. 
     */ 
</span>    <a href="matview.c.html#LN462"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN52"><span class='Ref_to_Member'>hi_options</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN28"><span class='Ref_to_Const'>HEAP_INSERT_SKIP_FSM</span></a> <span class='Operator'>| </span><a href="../../include/access/heapam.h.html#LN29"><span class='Ref_to_Const'>HEAP_INSERT_FROZEN</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/xlog.h.html#LN144"><span class='Ref_to_Macro'>XLogIsNeeded</span></a><span class='Parentheses'>())</span> 
        <a href="matview.c.html#LN462"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN52"><span class='Ref_to_Member'>hi_options</span></a> <span class='Operator'>|= </span><a href="../../include/access/heapam.h.html#LN27"><span class='Ref_to_Const'>HEAP_INSERT_SKIP_WAL</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN462"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN53"><span class='Ref_to_Member'>bistate</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN147"><span class='Ref_to_Proto'>GetBulkInsertState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Not using WAL requires smgr_targblock be initially invalid */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN488"><span class='Ref_to_Macro'>RelationGetTargetBlock</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN463"><span class='Ref_To_Local'>transientrel</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end transientrel_startup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * transientrel_receive --- receive one tuple 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN490"></a><span class='Declare_Function'>transientrel_receive</span><span class='Parentheses'>(</span><a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN492"></a>    <a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myState</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="matview.c.html#LN490"><span class='Ref_to_Parameter'>self</span></a><span class='Delimiter'>; 
</span><a name="LN493"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get the heap tuple out of the tuple table slot, making sure we have a 
     * writable copy 
     */ 
</span>    <a href="matview.c.html#LN493"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/executor/tuptable.h.html#LN162"><span class='Ref_to_Proto'>ExecMaterializeSlot</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN490"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN151"><span class='Ref_to_Proto'>heap_insert</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN492"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN50"><span class='Ref_to_Member'>transientrel</span></a><span class='Delimiter'>, 
</span>                <a href="matview.c.html#LN493"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                <a href="matview.c.html#LN492"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN51"><span class='Ref_to_Member'>output_cid</span></a><span class='Delimiter'>, 
</span>                <a href="matview.c.html#LN492"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN52"><span class='Ref_to_Member'>hi_options</span></a><span class='Delimiter'>, 
</span>                <a href="matview.c.html#LN492"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN53"><span class='Ref_to_Member'>bistate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We know this is a newly created relation, so there are no indexes */ 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end transientrel_receive &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * transientrel_shutdown --- executor end 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN516"></a><span class='Declare_Function'>transientrel_shutdown</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN518"></a>    <a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myState</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="matview.c.html#LN45"><span class='Ref_to_Typedef'>DR_transientrel</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="matview.c.html#LN516"><span class='Ref_to_Parameter'>self</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN148"><span class='Ref_to_Proto'>FreeBulkInsertState</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN518"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN53"><span class='Ref_to_Member'>bistate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we skipped using WAL, must heap_sync before commit */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN518"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN52"><span class='Ref_to_Member'>hi_options</span></a> <span class='Operator'>& </span><a href="../../include/access/heapam.h.html#LN27"><span class='Ref_to_Const'>HEAP_INSERT_SKIP_WAL</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/access/heapam.h.html#LN180"><span class='Ref_to_Proto'>heap_sync</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN518"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN50"><span class='Ref_to_Member'>transientrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* close transientrel, but keep lock until commit */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN518"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN50"><span class='Ref_to_Member'>transientrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN518"><span class='Ref_To_Local'>myState</span></a><span class='Operator'>-&GT;</span><a href="matview.c.html#LN50"><span class='Ref_to_Member'>transientrel</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * transientrel_destroy --- release DestReceiver object 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN535"></a><span class='Declare_Function'>transientrel_destroy</span><span class='Parentheses'>(</span><a href="../../include/tcop/dest.h.html#LN112"><span class='Ref_to_Typedef'>DestReceiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>self</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN535"><span class='Ref_to_Parameter'>self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given a qualified temporary table name, append an underscore followed by 
 * the given integer, to make a new table name based on the old one. 
 * 
 * This leaks memory through palloc(), which won't be cleaned up until the 
 * current memory context is freed. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN549"></a><span class='Declare_Function'>make_temptable_name_n</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tempname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN551"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>namebuf</span><span class='Delimiter'>; 
</span> 
    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN551"><span class='Ref_To_Local'>namebuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN551"><span class='Ref_To_Local'>namebuf</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN549"><span class='Ref_to_Parameter'>tempname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN551"><span class='Ref_To_Local'>namebuf</span></a><span class='Delimiter'>, </span><span class='String'>"_%d"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN549"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="matview.c.html#LN551"><span class='Ref_To_Local'>namebuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN560"></a><span class='Declare_Function'>mv_GenerateOper</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>opoid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN562"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>opertup</span><span class='Delimiter'>; 
</span><a name="LN563"></a>    <a href="../../include/catalog/pg_operator.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_operator</span></a> <span class='Declare_Local'>operform</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN562"><span class='Ref_To_Local'>opertup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN71"><span class='Ref_to_EnumConst'>OPEROID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN560"><span class='Ref_to_Parameter'>opoid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN562"><span class='Ref_To_Local'>opertup</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for operator %u"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN560"><span class='Ref_to_Parameter'>opoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN563"><span class='Ref_To_Local'>operform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_operator.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_operator</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN562"><span class='Ref_To_Local'>opertup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="matview.c.html#LN563"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprkind <span class='Operator'>== </span><span class='String'>'b'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN560"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"OPERATOR(%s.%s)"</span><span class='Delimiter'>, 
</span>                <a href="../../include/utils/builtins.h.html#LN77"><span class='Ref_to_Proto'>quote_identifier</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN563"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprnamespace<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                     <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN563"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN562"><span class='Ref_To_Local'>opertup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * refresh_by_match_merge 
 * 
 * Refresh a materialized view with transactional semantics, while allowing 
 * concurrent reads. 
 * 
 * This is called after a new version of the data has been created in a 
 * temporary table.  It performs a full outer join against the old version of 
 * the data, producing "diff" results.  This join cannot work if there are any 
 * duplicated rows in either the old or new versions, in the sense that every 
 * column would compare as equal between the two rows.  It does work correctly 
 * in the face of rows which have at least one NULL value, with all non-NULL 
 * columns equal.  The behavior of NULLs on equality tests and on UNIQUE 
 * indexes turns out to be quite convenient here; the tests we need to make 
 * are consistent with default behavior.  If there is at least one UNIQUE 
 * index on the materialized view, we have exactly the guarantee we need. 
 * 
 * The temporary table used to hold the diff results contains just the TID of 
 * the old record (if matched) and the ROW from the new table as a single 
 * column of complex record type (if matched). 
 * 
 * Once we have the diff table, we perform set-based DELETE and INSERT 
 * operations against the materialized view, and discard both temporary 
 * tables. 
 * 
 * Everything from the generation of the new data to applying the differences 
 * takes place under cover of an ExclusiveLock, since it seems as though we 
 * would want to prohibit not only concurrent REFRESH operations, but also 
 * incremental maintenance.  It also doesn't seem reasonable or safe to allow 
 * SELECT FOR UPDATE or SELECT FOR SHARE on rows being updated or deleted by 
 * this command. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN611"></a><span class='Declare_Function'>refresh_by_match_merge</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>matviewOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tempOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relowner</span><span class='Delimiter'>, 
</span><a name="LN612"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>save_sec_context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN614"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN615"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>matviewRel</span><span class='Delimiter'>; 
</span><a name="LN616"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>tempRel</span><span class='Delimiter'>; 
</span><a name="LN617"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>matviewname</span><span class='Delimiter'>; 
</span><a name="LN618"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tempname</span><span class='Delimiter'>; 
</span><a name="LN619"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>diffname</span><span class='Delimiter'>; 
</span><a name="LN620"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN621"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>foundUniqueIndex</span><span class='Delimiter'>; 
</span><a name="LN622"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>indexoidlist</span><span class='Delimiter'>; 
</span><a name="LN623"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>indexoidscan</span><span class='Delimiter'>; 
</span><a name="LN624"></a>    <a href="../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>relnatts</span><span class='Delimiter'>; 
</span><a name="LN625"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>usedForQual</span><span class='Delimiter'>; 
</span> 
    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN611"><span class='Ref_to_Parameter'>matviewOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN617"><span class='Ref_To_Local'>matviewname</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN78"><span class='Ref_to_Proto'>quote_qualified_identifier</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN616"><span class='Ref_To_Local'>tempRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN611"><span class='Ref_to_Parameter'>tempOid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN78"><span class='Ref_to_Proto'>quote_qualified_identifier</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN616"><span class='Ref_To_Local'>tempRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN616"><span class='Ref_To_Local'>tempRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN619"><span class='Ref_To_Local'>diffname</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN65"><span class='Ref_to_Proto'>make_temptable_name_n</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN624"><span class='Ref_To_Local'>relnatts</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relnatts<span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN625"><span class='Ref_To_Local'>usedForQual</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="matview.c.html#LN624"><span class='Ref_To_Local'>relnatts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open SPI context. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Analyze the temp table with the new contents. */ 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"ANALYZE %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN52"><span class='Ref_to_Const'>SPI_OK_UTILITY</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to ensure that there are not duplicate rows without NULLs in 
     * the new data set before we can count on the "diff" results.  Check for 
     * that in a way that allows showing the first duplicated row found.  Even 
     * after we pass this test, a unique index on the materialized view may 
     * find a duplicate key problem. 
     */ 
</span>    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"SELECT newdata FROM %s newdata "</span> 
                     <span class='String'>"WHERE newdata IS NOT NULL AND EXISTS "</span> 
                     <span class='String'>"(SELECT * FROM %s newdata2 WHERE newdata2 IS NOT NULL "</span> 
                     <span class='String'>"AND newdata2 OPERATOR(pg_catalog.*=) newdata "</span> 
                     <span class='String'>"AND newdata2.ctid OPERATOR(pg_catalog.&LT;&GT;) "</span> 
                     <span class='String'>"newdata.ctid) LIMIT 1"</span><span class='Delimiter'>, 
</span>                     <a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN81"><span class='Ref_to_Proto'>SPI_execute</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Note that this ereport() is returning data to the user.  Generally, 
         * we would want to make sure that the user has been granted access to 
         * this data.  However, REFRESH MAT VIEW is only able to be run by the 
         * owner of the mat view (or a superuser) and therefore there is no 
         * need to check for access to data in the mat view. 
         */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CARDINALITY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"new data for materialized view \"%s\" contains duplicate rows without any null columns"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Row: %s"</span><span class='Delimiter'>, 
</span>            <a href="../../include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="../executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="../executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN611"><span class='Ref_to_Parameter'>relowner</span></a><span class='Delimiter'>, 
</span>                           <a href="matview.c.html#LN612"><span class='Ref_to_Parameter'>save_sec_context</span></a> <span class='Operator'>| </span><a href="../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Start building the query for creating the diff table. */ 
</span>    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"CREATE TEMP TABLE %s AS "</span> 
                     <span class='String'>"SELECT mv.ctid AS tid, newdata "</span> 
                     <span class='String'>"FROM %s mv FULL JOIN %s newdata ON ("</span><span class='Delimiter'>, 
</span>                     <a href="matview.c.html#LN619"><span class='Ref_To_Local'>diffname</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN617"><span class='Ref_To_Local'>matviewname</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the list of index OIDs for the table from the relcache, and look up 
     * each one in the pg_index syscache.  We will test for equality on all 
     * columns present in all unique indexes which only reference columns and 
     * include all rows. 
     */ 
</span>    <a href="matview.c.html#LN620"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN621"><span class='Ref_To_Local'>foundUniqueIndex</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="matview.c.html#LN622"><span class='Ref_To_Local'>indexoidlist</span></a> <span class='Operator'>= </span><a href="../../include/utils/relcache.h.html#LN40"><span class='Ref_to_Proto'>RelationGetIndexList</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN623"><span class='Ref_To_Local'>indexoidscan</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN622"><span class='Ref_To_Local'>indexoidlist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN706"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>indexoid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN623"><span class='Ref_To_Local'>indexoidscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN707"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>indexRel</span><span class='Delimiter'>; 
</span><a name="LN708"></a>        <a href="../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a> <span class='Declare_Local'>indexStruct</span><span class='Delimiter'>; 
</span> 
        <a href="matview.c.html#LN707"><span class='Ref_To_Local'>indexRel</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN706"><span class='Ref_To_Local'>indexoid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="matview.c.html#LN708"><span class='Ref_To_Local'>indexStruct</span></a> <span class='Operator'>= </span><a href="matview.c.html#LN707"><span class='Ref_To_Local'>indexRel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN158"><span class='Ref_to_Member'>rd_index</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We're only interested if it is unique, valid, contains no 
         * expressions, and is not partial. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN708"><span class='Ref_To_Local'>indexStruct</span></a><span class='Operator'>-&GT;</span>indisunique <span class='Operator'>&& 
</span>            <a href="../../include/catalog/pg_index.h.html#LN106"><span class='Ref_to_Macro'>IndexIsValid</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN708"><span class='Ref_To_Local'>indexStruct</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../include/utils/relcache.h.html#LN45"><span class='Ref_to_Proto'>RelationGetIndexExpressions</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN707"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>&& 
</span>            <a href="../../include/utils/relcache.h.html#LN46"><span class='Ref_to_Proto'>RelationGetIndexPredicate</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN707"><span class='Ref_To_Local'>indexRel</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN722"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>numatts</span> <span class='Operator'>= </span><a href="matview.c.html#LN708"><span class='Ref_To_Local'>indexStruct</span></a><span class='Operator'>-&GT;</span>indnatts<span class='Delimiter'>; 
</span><a name="LN723"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add quals for all columns from this index. */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN723"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="matview.c.html#LN723"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="matview.c.html#LN722"><span class='Ref_To_Local'>numatts</span></a><span class='Delimiter'>; </span><a href="matview.c.html#LN723"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN728"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>attnum</span> <span class='Operator'>= </span><a href="matview.c.html#LN708"><span class='Ref_To_Local'>indexStruct</span></a><span class='Operator'>-&GT;</span>indkey<span class='Operator'>.</span>values<span class='Delimiter'>[</span><a href="matview.c.html#LN723"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN729"></a>                <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>type</span><span class='Delimiter'>; 
</span><a name="LN730"></a>                <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>op</span><span class='Delimiter'>; 
</span><a name="LN731"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>colname</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Only include the column once regardless of how many times 
                 * it shows up in how many indexes. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN625"><span class='Ref_To_Local'>usedForQual</span></a><span class='Delimiter'>[</span><a href="matview.c.html#LN728"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <a href="matview.c.html#LN625"><span class='Ref_To_Local'>usedForQual</span></a><span class='Delimiter'>[</span><a href="matview.c.html#LN728"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Actually add the qual, ANDed with any others. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="matview.c.html#LN621"><span class='Ref_To_Local'>foundUniqueIndex</span></a><span class='Parentheses'>) 
</span>                    <a href="../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>" AND "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="matview.c.html#LN731"><span class='Ref_To_Local'>colname</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN77"><span class='Ref_to_Proto'>quote_identifier</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>((</span><a href="matview.c.html#LN620"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="matview.c.html#LN728"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"newdata.%s "</span><span class='Delimiter'>, </span><a href="matview.c.html#LN731"><span class='Ref_To_Local'>colname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="matview.c.html#LN729"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_relation.h.html#LN127"><span class='Ref_to_Proto'>attnumTypeId</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN728"><span class='Ref_To_Local'>attnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="matview.c.html#LN730"><span class='Ref_To_Local'>op</span></a> <span class='Operator'>= </span><a href="../../include/utils/typcache.h.html#LN142"><span class='Ref_to_Proto'>lookup_type_cache</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN729"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><a href="../../include/utils/typcache.h.html#LN109"><span class='Ref_to_Const'>TYPECACHE_EQ_OPR</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span><a href="../../include/utils/typcache.h.html#LN53"><span class='Ref_to_Member'>eq_opr</span></a><span class='Delimiter'>; 
</span>                <a href="matview.c.html#LN66"><span class='Ref_to_Proto'>mv_GenerateOper</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN730"><span class='Ref_To_Local'>op</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>" mv.%s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN731"><span class='Ref_To_Local'>colname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="matview.c.html#LN621"><span class='Ref_To_Local'>foundUniqueIndex</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;numatts;i++ &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if indexStruct-&GT;indisuni... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Keep the locks, since we're about to run DML which needs them. */ 
</span>        <a href="../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN707"><span class='Ref_To_Local'>indexRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN622"><span class='Ref_To_Local'>indexoidlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There must be at least one unique index on the matview. 
     * 
     * ExecRefreshMatView() checks that after taking the exclusive lock on the 
     * matview. So at least one unique index is guaranteed to exist here 
     * because the lock is still being held. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="matview.c.html#LN621"><span class='Ref_To_Local'>foundUniqueIndex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                           <span class='String'>" AND newdata OPERATOR(pg_catalog.*=) mv) "</span> 
                           <span class='String'>"WHERE newdata IS NULL OR mv IS NULL "</span> 
                           <span class='String'>"ORDER BY tid"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create the temporary "diff" table. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN52"><span class='Ref_to_Const'>SPI_OK_UTILITY</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN611"><span class='Ref_to_Parameter'>relowner</span></a><span class='Delimiter'>, 
</span>                           <a href="matview.c.html#LN612"><span class='Ref_to_Parameter'>save_sec_context</span></a> <span class='Operator'>| </span><a href="../../include/miscadmin.h.html#LN296"><span class='Ref_to_Const'>SECURITY_RESTRICTED_OPERATION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have no further use for data from the "full-data" temp table, but we 
     * must keep it around because its type is referenced from the diff table. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Analyze the diff table. */ 
</span>    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"ANALYZE %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN619"><span class='Ref_To_Local'>diffname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN52"><span class='Ref_to_Const'>SPI_OK_UTILITY</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="matview.c.html#LN72"><span class='Ref_to_Proto'>OpenMatViewIncrementalMaintenance</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Deletes must come before inserts; do them first. */ 
</span>    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"DELETE FROM %s mv WHERE ctid OPERATOR(pg_catalog.=) ANY "</span> 
                     <span class='String'>"(SELECT diff.tid FROM %s diff "</span> 
                     <span class='String'>"WHERE diff.tid IS NOT NULL "</span> 
                     <span class='String'>"AND diff.newdata IS NULL)"</span><span class='Delimiter'>, 
</span>                     <a href="matview.c.html#LN617"><span class='Ref_To_Local'>matviewname</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN619"><span class='Ref_To_Local'>diffname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN56"><span class='Ref_to_Const'>SPI_OK_DELETE</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Inserts go last. */ 
</span>    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"INSERT INTO %s SELECT (diff.newdata).* "</span> 
                     <span class='String'>"FROM %s diff WHERE tid IS NULL"</span><span class='Delimiter'>, 
</span>                     <a href="matview.c.html#LN617"><span class='Ref_To_Local'>matviewname</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN619"><span class='Ref_To_Local'>diffname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN55"><span class='Ref_to_Const'>SPI_OK_INSERT</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We're done maintaining the materialized view. */ 
</span>    <a href="matview.c.html#LN73"><span class='Ref_to_Proto'>CloseMatViewIncrementalMaintenance</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN616"><span class='Ref_To_Local'>tempRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN615"><span class='Ref_To_Local'>matviewRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up temp tables. */ 
</span>    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"DROP TABLE %s, %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN619"><span class='Ref_To_Local'>diffname</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN618"><span class='Ref_To_Local'>tempname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN87"><span class='Ref_to_Proto'>SPI_exec</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN52"><span class='Ref_to_Const'>SPI_OK_UTILITY</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_exec failed: %s"</span><span class='Delimiter'>, </span><a href="matview.c.html#LN614"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close SPI context. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end refresh_by_match_merge &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Swap the physical files of the target and transient tables, then rebuild 
 * the target's indexes and throw away the transient table.  Security context 
 * swapping is handled by the called function, so it is not needed here. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN840"></a><span class='Declare_Function'>refresh_by_heap_swap</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>matviewOid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>OIDNewHeap</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Declare_Parameter'>relpersistence</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/commands/cluster.h.html#LN29"><span class='Ref_to_Proto'>finish_heap_swap</span></a><span class='Parentheses'>(</span><a href="matview.c.html#LN840"><span class='Ref_to_Parameter'>matviewOid</span></a><span class='Delimiter'>, </span><a href="matview.c.html#LN840"><span class='Ref_to_Parameter'>OIDNewHeap</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                     <a href="../utils/time/snapmgr.c.html#LN164"><span class='Ref_to_Global_Var'>RecentXmin</span></a><span class='Delimiter'>, </span><a href="../../include/access/multixact.h.html#LN109"><span class='Ref_to_Proto'>ReadNextMultiXactId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="matview.c.html#LN840"><span class='Ref_to_Parameter'>relpersistence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This should be used to test whether the backend is in a context where it is 
 * OK to allow DML statements to modify materialized views.  We only want to 
 * allow that for internal code driven by the materialized view definition, 
 * not for arbitrary user-supplied code. 
 * 
 * While the function names reflect the fact that their main intended use is 
 * incremental maintenance of materialized views (in response to changes to 
 * the data in referenced relations), they are initially used to allow REFRESH 
 * without blocking concurrent reads. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN859"></a><span class='Declare_Function'>MatViewIncrementalMaintenanceIsEnabled</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN865"></a><span class='Declare_Function'>OpenMatViewIncrementalMaintenance</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN871"></a><span class='Declare_Function'>CloseMatViewIncrementalMaintenance</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="matview.c.html#LN56"><span class='Ref_to_Global_Var'>matview_maintenance_depth</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>