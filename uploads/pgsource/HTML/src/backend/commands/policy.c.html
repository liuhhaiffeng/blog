<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\commands\policy.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\commands\policy.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:36 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * policy.c 
 *    Commands for manipulating policies. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * src/backend/commands/policy.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_authid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_policy.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/policy.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/makefuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/pg_list.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_clause.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_collate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_node.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_relation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteManip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rowsecurity.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lock.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/array.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
<a name="LN48"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RangeVarCallbackForPolicy</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rv</span><span class='Delimiter'>, 
</span><a name="LN49"></a>                          <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldrelid</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN50"></a><span class='Keyword'>static char </span><span class='Declare_Prototype'>parse_policy_command</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmd_name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN51"></a><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>policy_role_list_to_array</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>roles</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>num_roles</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Callback to RangeVarGetRelidExtended(). 
 * 
 * Checks the following: 
 *  - the relation specified is a table. 
 *  - current user owns the table. 
 *  - the table is not a system table. 
 * 
 * If any of these checks fails then an error is raised. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN64"></a><span class='Declare_Function'>RangeVarCallbackForPolicy</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rv</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldrelid</span><span class='Delimiter'>, 
</span><a name="LN65"></a>                          <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN67"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN68"></a>    <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classform</span><span class='Delimiter'>; 
</span><a name="LN69"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>relkind</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN67"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN64"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN67"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN68"><span class='Ref_To_Local'>classform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN67"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN69"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN68"><span class='Ref_To_Local'>classform</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must own relation. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN64"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN64"><span class='Ref_to_Parameter'>rv</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No system table modifications unless explicitly allowed. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN33"><span class='Ref_to_Proto'>IsSystemClass</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN64"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN68"><span class='Ref_To_Local'>classform</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied: \"%s\" is a system catalog"</span><span class='Delimiter'>, 
</span>                        <a href="policy.c.html#LN64"><span class='Ref_to_Parameter'>rv</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Relation type MUST be a table. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN69"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& </span><a href="policy.c.html#LN69"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table"</span><span class='Delimiter'>, </span><a href="policy.c.html#LN64"><span class='Ref_to_Parameter'>rv</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN67"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RangeVarCallbackForPolicy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * parse_policy_command - 
 *   helper function to convert full command strings to their char 
 *   representation. 
 * 
 * cmd_name - full string command name. Valid values are 'all', 'select', 
 *            'insert', 'update' and 'delete'. 
 * 
 */ 
</span><span class='Keyword'>static char 
</span><a name="LN108"></a><span class='Declare_Function'>parse_policy_command</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmd_name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN110"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>polcmd</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN108"><span class='Ref_to_Parameter'>cmd_name</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized policy command"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="policy.c.html#LN108"><span class='Ref_to_Parameter'>cmd_name</span></a><span class='Delimiter'>, </span><span class='String'>"all"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="policy.c.html#LN110"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><span class='String'>'*'</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="policy.c.html#LN108"><span class='Ref_to_Parameter'>cmd_name</span></a><span class='Delimiter'>, </span><span class='String'>"select"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="policy.c.html#LN110"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN130"><span class='Ref_to_Const'>ACL_SELECT_CHR</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="policy.c.html#LN108"><span class='Ref_to_Parameter'>cmd_name</span></a><span class='Delimiter'>, </span><span class='String'>"insert"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="policy.c.html#LN110"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN129"><span class='Ref_to_Const'>ACL_INSERT_CHR</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="policy.c.html#LN108"><span class='Ref_to_Parameter'>cmd_name</span></a><span class='Delimiter'>, </span><span class='String'>"update"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="policy.c.html#LN110"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN131"><span class='Ref_to_Const'>ACL_UPDATE_CHR</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="policy.c.html#LN108"><span class='Ref_to_Parameter'>cmd_name</span></a><span class='Delimiter'>, </span><span class='String'>"delete"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="policy.c.html#LN110"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN132"><span class='Ref_to_Const'>ACL_DELETE_CHR</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized policy command"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN110"><span class='Ref_To_Local'>polcmd</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parse_policy_command &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * policy_role_list_to_array 
 *   helper function to convert a list of RoleSpecs to an array of 
 *   role id Datums. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>* 
</span><a name="LN137"></a><span class='Declare_Function'>policy_role_list_to_array</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>roles</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>num_roles</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN139"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>role_oids</span><span class='Delimiter'>; 
</span><a name="LN140"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN141"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Handle no roles being passed in as being for public */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>roles</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>num_roles</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>num_roles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN38"><span class='Ref_to_Const'>ACL_ID_PUBLIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>num_roles</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>num_roles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN140"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>roles</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN158"></a>        <a href="../../include/nodes/parsenodes.h.html#LN324"><span class='Ref_to_Struct'>RoleSpec</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>spec</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN140"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * PUBLIC covers all roles, so it only makes sense alone. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN158"><span class='Ref_To_Local'>spec</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN327"><span class='Ref_to_Member'>roletype</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN321"><span class='Ref_to_EnumConst'>ROLESPEC_PUBLIC</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>num_roles</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ignoring specified roles other than PUBLIC"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"All roles are members of the PUBLIC role."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="policy.c.html#LN137"><span class='Ref_to_Parameter'>num_roles</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN38"><span class='Ref_to_Const'>ACL_ID_PUBLIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN141"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN236"><span class='Ref_to_Proto'>get_rolespec_oid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN158"><span class='Ref_To_Local'>spec</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN139"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end policy_role_list_to_array &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Load row security policy from the catalog, and store it in 
 * the relation's relcache entry. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN190"></a><span class='Declare_Function'>RelationBuildRowSecurity</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN192"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>rscxt</span><span class='Delimiter'>; 
</span><a name="LN193"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN194"></a>    <a href="../../include/rewrite/rowsecurity.h.html#LN30"><span class='Ref_to_Struct'>RowSecurityDesc</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>rsdesc</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a memory context to hold everything associated with this 
     * relation's row security policy.  This makes it easy to clean up during 
     * a relcache flush. 
     */ 
</span>    <a href="policy.c.html#LN192"><span class='Ref_To_Local'>rscxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN45"><span class='Ref_to_Global_Var'>CacheMemoryContext</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"row security descriptor"</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since rscxt lives under CacheMemoryContext, it is long-lived.  Use a 
     * PG_TRY block to ensure it'll get freed if we fail partway through. 
     */ 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN211"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>catalog</span><span class='Delimiter'>; 
</span><a name="LN212"></a>        <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>; 
</span><a name="LN213"></a>        <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN214"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN194"><span class='Ref_To_Local'>rsdesc</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN192"><span class='Ref_To_Local'>rscxt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/rewrite/rowsecurity.h.html#LN30"><span class='Ref_to_Struct'>RowSecurityDesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN194"><span class='Ref_To_Local'>rsdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN32"><span class='Ref_to_Member'>rscxt</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN192"><span class='Ref_To_Local'>rscxt</span></a><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN212"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN190"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN213"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                   <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN212"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Loop through the row level security policies for this relation, if 
         * any. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN213"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN235"></a>            <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>value_datum</span><span class='Delimiter'>; 
</span><a name="LN236"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>cmd_value</span><span class='Delimiter'>; 
</span><a name="LN237"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>permissive_value</span><span class='Delimiter'>; 
</span><a name="LN238"></a>            <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>roles_datum</span><span class='Delimiter'>; 
</span><a name="LN239"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>qual_value</span><span class='Delimiter'>; 
</span><a name="LN240"></a>            <a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qual_expr</span><span class='Delimiter'>; 
</span><a name="LN241"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_value</span><span class='Delimiter'>; 
</span><a name="LN242"></a>            <a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_qual</span><span class='Delimiter'>; 
</span><a name="LN243"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>policy_name_value</span><span class='Delimiter'>; 
</span><a name="LN244"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN245"></a>            <a href="../../include/rewrite/rowsecurity.h.html#LN19"><span class='Ref_to_Struct'>RowSecurityPolicy</span></a> <span class='Operator'>*</span><span class='Declare_Local'>policy</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Note: all the pass-by-reference data we collect here is either 
             * still stored in the tuple, or constructed in the caller's 
             * short-lived memory context.  We must copy it into rscxt 
             * explicitly below. 
             */ 
</span> 
            <span class='Comment_Multi_Line'>/* Get policy command */ 
</span>            <a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN48"><span class='Ref_to_Const'>Anum_pg_policy_polcmd</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN236"><span class='Ref_To_Local'>cmd_value</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN414"><span class='Ref_to_Macro'>DatumGetChar</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get policy permissive or restrictive */ 
</span>            <a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN49"><span class='Ref_to_Const'>Anum_pg_policy_polpermissive</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN237"><span class='Ref_To_Local'>permissive_value</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get policy name */ 
</span>            <a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN243"><span class='Ref_To_Local'>policy_name_value</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN590"><span class='Ref_to_Macro'>DatumGetName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get policy roles */ 
</span>            <a href="policy.c.html#LN238"><span class='Ref_To_Local'>roles_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* shouldn't be null, but initdb doesn't mark it so, so check */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected null value in pg_policy.polroles"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get policy qual */ 
</span>            <a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="policy.c.html#LN239"><span class='Ref_To_Local'>qual_value</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="policy.c.html#LN240"><span class='Ref_To_Local'>qual_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN239"><span class='Ref_To_Local'>qual_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="policy.c.html#LN240"><span class='Ref_To_Local'>qual_expr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get WITH CHECK qual */ 
</span>            <a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN214"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a><span class='Delimiter'>, 
</span>                                       <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN244"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="policy.c.html#LN241"><span class='Ref_To_Local'>with_check_value</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN235"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="policy.c.html#LN242"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN241"><span class='Ref_To_Local'>with_check_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="policy.c.html#LN242"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Now copy everything into the cache context */ 
</span>            <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN192"><span class='Ref_To_Local'>rscxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/rewrite/rowsecurity.h.html#LN19"><span class='Ref_to_Struct'>RowSecurityPolicy</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN21"><span class='Ref_to_Member'>policy_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN243"><span class='Ref_To_Local'>policy_name_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN22"><span class='Ref_to_Member'>polcmd</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN236"><span class='Ref_To_Local'>cmd_value</span></a><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN24"><span class='Ref_to_Member'>permissive</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN237"><span class='Ref_To_Local'>permissive_value</span></a><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN23"><span class='Ref_to_Member'>roles</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN242"><span class='Ref_to_Macro'>DatumGetArrayTypePCopy</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN238"><span class='Ref_To_Local'>roles_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN25"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN240"><span class='Ref_To_Local'>qual_expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN26"><span class='Ref_to_Member'>with_check_qual</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN242"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN27"><span class='Ref_to_Member'>hassublinks</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="policy.c.html#LN240"><span class='Ref_To_Local'>qual_expr</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="policy.c.html#LN242"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN194"><span class='Ref_To_Local'>rsdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN33"><span class='Ref_to_Member'>policies</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN245"><span class='Ref_To_Local'>policy</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN194"><span class='Ref_To_Local'>rsdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/rowsecurity.h.html#LN33"><span class='Ref_to_Member'>policies</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN193"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* clean up some (not all) of the junk ... */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN240"><span class='Ref_To_Local'>qual_expr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN240"><span class='Ref_To_Local'>qual_expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN242"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN242"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while HeapTupleIsValid(tupl... &raquo; </span> 
 
        <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN213"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN211"><span class='Ref_To_Local'>catalog</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Delete rscxt, first making sure it isn't active */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN193"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN192"><span class='Ref_To_Local'>rscxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Success --- attach the policy descriptor to the relcache entry */ 
</span>    <a href="policy.c.html#LN190"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN121"><span class='Ref_to_Member'>rd_rsdesc</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN194"><span class='Ref_To_Local'>rsdesc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RelationBuildRowSecurity &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RemovePolicyById - 
 *   remove a policy by its OID.  If a policy does not exist with the provided 
 *   oid, then an error is raised. 
 * 
 * policy_id - the oid of the policy. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN349"></a><span class='Declare_Function'>RemovePolicyById</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>policy_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN351"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_policy_rel</span><span class='Delimiter'>; 
</span><a name="LN352"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN353"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN354"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN355"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN356"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN351"><span class='Ref_To_Local'>pg_policy_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find the policy to delete. 
     */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN353"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN349"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN352"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN351"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN326"><span class='Ref_to_Const'>PolicyOidIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="policy.c.html#LN353"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN354"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN352"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the policy exists, then remove it, otherwise raise an error. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN354"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find tuple for policy %u"</span><span class='Delimiter'>, </span><a href="policy.c.html#LN349"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open and exclusive-lock the relation the policy belongs to.  (We need 
     * exclusive lock to lock out queries that might otherwise depend on the 
     * set of policies the rel has; furthermore we've got to hold the lock 
     * till commit.) 
     */ 
</span>    <a href="policy.c.html#LN355"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_policy.h.html#LN39"><span class='Ref_to_Typedef'>Form_pg_policy</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN354"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>polrelid<span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN355"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN29"><span class='Ref_to_Proto'>IsSystemRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied: \"%s\" is a system catalog"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN351"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN354"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN352"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that, unlike some of the other flags in pg_class, relrowsecurity 
     * is not just an indication of if policies exist.  When relrowsecurity is 
     * set by a user, then all access to the relation must be through a 
     * policy.  If no policy is defined for the relation then a default-deny 
     * policy is created and all records are filtered (except for queries from 
     * the owner). 
     */ 
</span>    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN356"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN351"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemovePolicyById &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RemoveRoleFromObjectPolicy - 
 *   remove a role from a policy by its OID.  If the role is not a member of 
 *   the policy then an error is raised.  False is returned to indicate that 
 *   the role could not be removed due to being the only role on the policy 
 *   and therefore the entire policy should be removed. 
 * 
 * Note that a warning will be thrown and true will be returned on a 
 * permission error, as the policy should not be removed in that case. 
 * 
 * roleid - the oid of the role to remove 
 * classid - should always be PolicyRelationId 
 * policy_id - the oid of the policy. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN434"></a><span class='Declare_Function'>RemoveRoleFromObjectPolicy</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>roleid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>policy_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN436"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_policy_rel</span><span class='Delimiter'>; 
</span><a name="LN437"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN438"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN439"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN440"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN441"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN442"></a>    <a href="../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>policy_roles</span><span class='Delimiter'>; 
</span><a name="LN443"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_roles</span><span class='Delimiter'>; 
</span><a name="LN444"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>roles_datum</span><span class='Delimiter'>; 
</span><a name="LN445"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>attr_isnull</span><span class='Delimiter'>; 
</span><a name="LN446"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>noperm</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>classid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find the policy to update. 
     */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN438"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN437"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN326"><span class='Ref_to_Const'>PolicyOidIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="policy.c.html#LN438"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN437"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Raise an error if we don't find the policy. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find tuple for policy %u"</span><span class='Delimiter'>, </span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open and exclusive-lock the relation the policy belongs to. 
     */ 
</span>    <a href="policy.c.html#LN440"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_policy.h.html#LN39"><span class='Ref_to_Typedef'>Form_pg_policy</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>polrelid<span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN440"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN29"><span class='Ref_to_Proto'>IsSystemRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied: \"%s\" is a system catalog"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the current set of roles */ 
</span>    <a href="policy.c.html#LN444"><span class='Ref_To_Local'>roles_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="policy.c.html#LN445"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN445"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN442"><span class='Ref_To_Local'>policy_roles</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN242"><span class='Ref_to_Macro'>DatumGetArrayTypePCopy</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN444"><span class='Ref_To_Local'>roles_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We should be removing exactly one entry from the roles array */ 
</span>    <a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN442"><span class='Ref_To_Local'>policy_roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must own relation. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN440"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="policy.c.html#LN446"><span class='Ref_To_Local'>noperm</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* user is allowed to modify this policy */ 
</span>    <span class='Control'>else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WARNING_PRIVILEGE_NOT_REVOKED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"role \"%s\" could not be removed from policy \"%s\" on \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../include/miscadmin.h.html#LN307"><span class='Ref_to_Proto'>GetUserNameFromId</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>roleid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(((</span><a href="../../include/catalog/pg_policy.h.html#LN39"><span class='Ref_to_Typedef'>Form_pg_policy</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>polname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If multiple roles exist on this policy, then remove the one we were 
     * asked to and leave the rest. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN446"><span class='Ref_To_Local'>noperm</span></a> <span class='Operator'>&& </span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN520"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN521"></a>                    <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN522"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>roles</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN442"><span class='Ref_To_Local'>policy_roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN523"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>role_oids</span><span class='Delimiter'>; 
</span><a name="LN524"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>qual_value</span><span class='Delimiter'>; 
</span><a name="LN525"></a>        <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qual_expr</span><span class='Delimiter'>; 
</span><a name="LN526"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qual_parse_rtable</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN527"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_value</span><span class='Delimiter'>; 
</span><a name="LN528"></a>        <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_qual</span><span class='Delimiter'>; 
</span><a name="LN529"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_parse_rtable</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN530"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN531"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN532"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>replaces</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN533"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>value_datum</span><span class='Delimiter'>; 
</span><a name="LN534"></a>        <a href="../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>role_ids</span><span class='Delimiter'>; 
</span><a name="LN535"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_tuple</span><span class='Delimiter'>; 
</span><a name="LN536"></a>        <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>; 
</span><a name="LN537"></a>        <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* zero-clear */ 
</span>        memset<span class='Parentheses'>(</span><a href="policy.c.html#LN530"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN530"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="policy.c.html#LN532"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN532"><span class='Ref_To_Local'>replaces</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="policy.c.html#LN531"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN531"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * All of the dependencies will be removed from the policy and then 
         * re-added.  In order to get them correct, we need to extract out the 
         * expressions in the policy and construct a parsestate just enough to 
         * build the range table(s) to then pass to recordDependencyOnExpr(). 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* Get policy qual, to update dependencies */ 
</span>        <a href="policy.c.html#LN533"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN445"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN445"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN556"></a>            <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qual_pstate</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* parsestate is built just to build the range table */ 
</span>            <a href="policy.c.html#LN556"><span class='Ref_To_Local'>qual_pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN524"><span class='Ref_To_Local'>qual_value</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN533"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN525"><span class='Ref_To_Local'>qual_expr</span></a> <span class='Operator'>= </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN524"><span class='Ref_To_Local'>qual_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add this rel to the parsestate's rangetable, for dependencies */ 
</span>            <a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN556"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN526"><span class='Ref_To_Local'>qual_parse_rtable</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN556"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>; 
</span>            <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN556"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="policy.c.html#LN525"><span class='Ref_To_Local'>qual_expr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get WITH CHECK qual, to update dependencies */ 
</span>        <a href="policy.c.html#LN533"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN445"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN445"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN578"></a>            <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>with_check_pstate</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* parsestate is built just to build the range table */ 
</span>            <a href="policy.c.html#LN578"><span class='Ref_To_Local'>with_check_pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN527"><span class='Ref_To_Local'>with_check_value</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN533"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN528"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN527"><span class='Ref_To_Local'>with_check_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add this rel to the parsestate's rangetable, for dependencies */ 
</span>            <a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN578"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                          <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN529"><span class='Ref_To_Local'>with_check_parse_rtable</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN578"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>; 
</span>            <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN578"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="policy.c.html#LN528"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Rebuild the roles array to then update the pg_policy tuple with */ 
</span>        <a href="policy.c.html#LN523"><span class='Ref_To_Local'>role_oids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="policy.c.html#LN521"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN442"><span class='Ref_To_Local'>policy_roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; </span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
            <span class='Comment_Multi_Line'>/* Copy over all of the roles which are not the one being removed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN522"><span class='Ref_To_Local'>roles</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>) 
</span>                <a href="policy.c.html#LN523"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN521"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN522"><span class='Ref_To_Local'>roles</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We should have only removed the one role */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="policy.c.html#LN521"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>== </span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* This is the array for the new tuple */ 
</span>        <a href="policy.c.html#LN534"><span class='Ref_To_Local'>role_ids</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN369"><span class='Ref_to_Proto'>construct_array</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN523"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN532"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN530"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN534"><span class='Ref_To_Local'>role_ids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN535"><span class='Ref_To_Local'>new_tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN439"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="policy.c.html#LN530"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN531"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN532"><span class='Ref_To_Local'>replaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN535"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN535"><span class='Ref_To_Local'>new_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remove all old dependencies. */ 
</span>        <a href="../catalog/pg_depend.c.html#LN189"><span class='Ref_to_Func'>deleteDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Record the new set of dependencies */ 
</span>        <a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN440"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../catalog/pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN75"><span class='Ref_to_EnumConst'>DEPENDENCY_AUTO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN525"><span class='Ref_To_Local'>qual_expr</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN525"><span class='Ref_To_Local'>qual_expr</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN526"><span class='Ref_To_Local'>qual_parse_rtable</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN528"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN528"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Delimiter'>, 
</span>                                   <a href="policy.c.html#LN529"><span class='Ref_To_Local'>with_check_parse_rtable</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remove all the old shared dependencies (roles) */ 
</span>        <a href="../../include/catalog/dependency.h.html#LN254"><span class='Ref_to_Proto'>deleteSharedDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Record the new shared dependencies (roles) */ 
</span>        <a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a><span class='Delimiter'>; </span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN505"><span class='Ref_to_Macro'>DatumGetObjectId</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN523"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN520"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* no need for dependency on the public role */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN38"><span class='Ref_to_Const'>ACL_ID_PUBLIC</span></a><span class='Parentheses'>) 
</span>                <a href="../catalog/pg_shdepend.c.html#LN113"><span class='Ref_to_Func'>recordSharedDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN537"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN536"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/catalog/dependency.h.html#LN117"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_POLICY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN434"><span class='Ref_to_Parameter'>policy_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN535"><span class='Ref_To_Local'>new_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Invalidate Relation Cache */ 
</span>        <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !noperm&&num_roles&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Clean up. */ 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN437"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN441"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN436"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN446"><span class='Ref_To_Local'>noperm</span></a> <span class='Operator'>|| </span><a href="policy.c.html#LN443"><span class='Ref_To_Local'>num_roles</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveRoleFromObjectPolicy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CreatePolicy - 
 *   handles the execution of the CREATE POLICY command. 
 * 
 * stmt - the CreatePolicyStmt that describes the policy to create. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN681"></a><span class='Declare_Function'>CreatePolicy</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2280"><span class='Ref_to_Struct'>CreatePolicyStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN683"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_policy_rel</span><span class='Delimiter'>; 
</span><a name="LN684"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>policy_id</span><span class='Delimiter'>; 
</span><a name="LN685"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>target_table</span><span class='Delimiter'>; 
</span><a name="LN686"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>table_id</span><span class='Delimiter'>; 
</span><a name="LN687"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>polcmd</span><span class='Delimiter'>; 
</span><a name="LN688"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>role_oids</span><span class='Delimiter'>; 
</span><a name="LN689"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nitems</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN690"></a>    <a href="../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>role_ids</span><span class='Delimiter'>; 
</span><a name="LN691"></a>    <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qual_pstate</span><span class='Delimiter'>; 
</span><a name="LN692"></a>    <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>with_check_pstate</span><span class='Delimiter'>; 
</span><a name="LN693"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>; 
</span><a name="LN694"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qual</span><span class='Delimiter'>; 
</span><a name="LN695"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_qual</span><span class='Delimiter'>; 
</span><a name="LN696"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN697"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN698"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>policy_tuple</span><span class='Delimiter'>; 
</span><a name="LN699"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN700"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN701"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>; 
</span><a name="LN702"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>; 
</span><a name="LN703"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse command */ 
</span>    <a href="policy.c.html#LN687"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN50"><span class='Ref_to_Proto'>parse_policy_command</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2285"><span class='Ref_to_Member'>cmd_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the command is SELECT or DELETE then WITH CHECK should be NULL. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="policy.c.html#LN687"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>== </span><a href="../../include/utils/acl.h.html#LN130"><span class='Ref_to_Const'>ACL_SELECT_CHR</span></a> <span class='Operator'>|| </span><a href="policy.c.html#LN687"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>== </span><a href="../../include/utils/acl.h.html#LN132"><span class='Ref_to_Const'>ACL_DELETE_CHR</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>&& </span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2289"><span class='Ref_to_Member'>with_check</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"WITH CHECK cannot be applied to SELECT or DELETE"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the command is INSERT then WITH CHECK should be the only expression 
     * provided. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN687"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>== </span><a href="../../include/utils/acl.h.html#LN129"><span class='Ref_to_Const'>ACL_INSERT_CHR</span></a> <span class='Operator'>&& </span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2288"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"only WITH CHECK expression allowed for INSERT"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Collect role ids */ 
</span>    <a href="policy.c.html#LN688"><span class='Ref_To_Local'>role_oids</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN51"><span class='Ref_to_Proto'>policy_role_list_to_array</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2287"><span class='Ref_to_Member'>roles</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN689"><span class='Ref_To_Local'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN690"><span class='Ref_To_Local'>role_ids</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN369"><span class='Ref_to_Proto'>construct_array</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN688"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN689"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse the supplied clause */ 
</span>    <a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* zero-clear */ 
</span>    memset<span class='Parentheses'>(</span><a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="policy.c.html#LN700"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN700"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get id of table.  Also handles permissions checks. */ 
</span>    <a href="policy.c.html#LN686"><span class='Ref_To_Local'>table_id</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2284"><span class='Ref_to_Member'>table</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                        <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                        <a href="policy.c.html#LN48"><span class='Ref_to_Proto'>RangeVarCallbackForPolicy</span></a><span class='Delimiter'>, 
</span>                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open target_table to build quals. No additional lock is necessary. */ 
</span>    <a href="policy.c.html#LN685"><span class='Ref_To_Local'>target_table</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN686"><span class='Ref_To_Local'>table_id</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add for the regular security quals */ 
</span>    <a href="policy.c.html#LN693"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN685"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, 
</span>                                        <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/parser/parse_relation.h.html#LN114"><span class='Ref_to_Proto'>addRTEtoQuery</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN693"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add for the with-check quals */ 
</span>    <a href="policy.c.html#LN693"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN685"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, 
</span>                                        <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/parser/parse_relation.h.html#LN114"><span class='Ref_to_Proto'>addRTEtoQuery</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN693"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN694"><span class='Ref_To_Local'>qual</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_clause.h.html#LN23"><span class='Ref_to_Proto'>transformWhereClause</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2288"><span class='Ref_to_Member'>qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/parser/parse_node.h.html#LN68"><span class='Ref_to_EnumConst'>EXPR_KIND_POLICY</span></a><span class='Delimiter'>, 
</span>                                <span class='String'>"POLICY"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN695"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_clause.h.html#LN23"><span class='Ref_to_Proto'>transformWhereClause</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2289"><span class='Ref_to_Member'>with_check</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                           <a href="../../include/parser/parse_node.h.html#LN68"><span class='Ref_to_EnumConst'>EXPR_KIND_POLICY</span></a><span class='Delimiter'>, 
</span>                                           <span class='String'>"POLICY"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fix up collation information */ 
</span>    <a href="../../include/parser/parse_collate.h.html#LN22"><span class='Ref_to_Proto'>assign_expr_collations</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN694"><span class='Ref_To_Local'>qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/parser/parse_collate.h.html#LN22"><span class='Ref_to_Proto'>assign_expr_collations</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN695"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open pg_policy catalog */ 
</span>    <a href="policy.c.html#LN683"><span class='Ref_To_Local'>pg_policy_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set key - policy's relation id. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN696"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN686"><span class='Ref_To_Local'>table_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set key - policy's name. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN696"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2283"><span class='Ref_to_Member'>policy_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN697"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN683"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                               <a href="policy.c.html#LN696"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN698"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN697"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Complain if the policy name already exists for the table */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN698"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"policy \"%s\" for table \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                 <a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2283"><span class='Ref_to_Member'>policy_name</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN685"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN686"><span class='Ref_To_Local'>table_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../utils/adt/name.c.html#LN44"><span class='Ref_to_Func'>namein</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2283"><span class='Ref_to_Member'>policy_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN48"><span class='Ref_to_Const'>Anum_pg_policy_polcmd</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN687"><span class='Ref_To_Local'>polcmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN49"><span class='Ref_to_Const'>Anum_pg_policy_polpermissive</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN681"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2286"><span class='Ref_to_Member'>permissive</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN690"><span class='Ref_To_Local'>role_ids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add qual if present. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN694"><span class='Ref_To_Local'>qual</span></a><span class='Parentheses'>) 
</span>        <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN694"><span class='Ref_To_Local'>qual</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="policy.c.html#LN700"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add WITH CHECK qual if present */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN695"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>) 
</span>        <a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN695"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="policy.c.html#LN700"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN698"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN683"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="policy.c.html#LN699"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, 
</span>                                   <a href="policy.c.html#LN700"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN684"><span class='Ref_To_Local'>policy_id</span></a> <span class='Operator'>= </span><a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN683"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN698"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Record Dependencies */ 
</span>    <a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN686"><span class='Ref_To_Local'>table_id</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN684"><span class='Ref_To_Local'>policy_id</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../catalog/pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN75"><span class='Ref_to_EnumConst'>DEPENDENCY_AUTO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN694"><span class='Ref_To_Local'>qual</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN695"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Delimiter'>, 
</span>                           <a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Register role dependencies */ 
</span>    <a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN703"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="policy.c.html#LN703"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="policy.c.html#LN689"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>; </span><a href="policy.c.html#LN703"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN505"><span class='Ref_to_Macro'>DatumGetObjectId</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN688"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN703"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* no dependency if public */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN38"><span class='Ref_to_Const'>ACL_ID_PUBLIC</span></a><span class='Parentheses'>) 
</span>            <a href="../catalog/pg_shdepend.c.html#LN113"><span class='Ref_to_Func'>recordSharedDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN701"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/catalog/dependency.h.html#LN117"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_POLICY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN144"><span class='Ref_to_Macro'>InvokeObjectPostCreateHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN684"><span class='Ref_To_Local'>policy_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Invalidate Relation Cache */ 
</span>    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN685"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up. */ 
</span>    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN698"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN691"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN692"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN697"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN685"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN683"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN702"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreatePolicy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AlterPolicy - 
 *   handles the execution of the ALTER POLICY command. 
 * 
 * stmt - the AlterPolicyStmt that describes the policy and how to alter it. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN876"></a><span class='Declare_Function'>AlterPolicy</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2296"><span class='Ref_to_Struct'>AlterPolicyStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN878"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_policy_rel</span><span class='Delimiter'>; 
</span><a name="LN879"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>policy_id</span><span class='Delimiter'>; 
</span><a name="LN880"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>target_table</span><span class='Delimiter'>; 
</span><a name="LN881"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>table_id</span><span class='Delimiter'>; 
</span><a name="LN882"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>role_oids</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN883"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nitems</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN884"></a>    <a href="../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>role_ids</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN885"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qual_parse_rtable</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN886"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_parse_rtable</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN887"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qual</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN888"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_qual</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN889"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN890"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN891"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>policy_tuple</span><span class='Delimiter'>; 
</span><a name="LN892"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_tuple</span><span class='Delimiter'>; 
</span><a name="LN893"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN894"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN895"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replaces</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN45"><span class='Ref_to_Const'>Natts_pg_policy</span></a><span class='Delimiter'>]; 
</span><a name="LN896"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>target</span><span class='Delimiter'>; 
</span><a name="LN897"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>; 
</span><a name="LN898"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>polcmd_datum</span><span class='Delimiter'>; 
</span><a name="LN899"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>polcmd</span><span class='Delimiter'>; 
</span><a name="LN900"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>polcmd_isnull</span><span class='Delimiter'>; 
</span><a name="LN901"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse role_ids */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2301"><span class='Ref_to_Member'>roles</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="policy.c.html#LN882"><span class='Ref_To_Local'>role_oids</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN51"><span class='Ref_to_Proto'>policy_role_list_to_array</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2301"><span class='Ref_to_Member'>roles</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN883"><span class='Ref_To_Local'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN884"><span class='Ref_To_Local'>role_ids</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN369"><span class='Ref_to_Proto'>construct_array</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN882"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN883"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Get id of table.  Also handles permissions checks. */ 
</span>    <a href="policy.c.html#LN881"><span class='Ref_To_Local'>table_id</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2300"><span class='Ref_to_Member'>table</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                        <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                        <a href="policy.c.html#LN48"><span class='Ref_to_Proto'>RangeVarCallbackForPolicy</span></a><span class='Delimiter'>, 
</span>                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN881"><span class='Ref_To_Local'>table_id</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse the using policy clause */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2302"><span class='Ref_to_Member'>qual</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN922"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>; 
</span><a name="LN923"></a>        <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qual_pstate</span> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN922"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN923"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, 
</span>                                            <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/parser/parse_relation.h.html#LN114"><span class='Ref_to_Proto'>addRTEtoQuery</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN923"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN922"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN887"><span class='Ref_To_Local'>qual</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_clause.h.html#LN23"><span class='Ref_to_Proto'>transformWhereClause</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN923"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2302"><span class='Ref_to_Member'>qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="../../include/parser/parse_node.h.html#LN68"><span class='Ref_to_EnumConst'>EXPR_KIND_POLICY</span></a><span class='Delimiter'>, 
</span>                                    <span class='String'>"POLICY"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fix up collation information */ 
</span>        <a href="../../include/parser/parse_collate.h.html#LN22"><span class='Ref_to_Proto'>assign_expr_collations</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN923"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN887"><span class='Ref_To_Local'>qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN885"><span class='Ref_To_Local'>qual_parse_rtable</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN923"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>; 
</span>        <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN923"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stmt-&GT;qual &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Parse the with-check policy clause */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2303"><span class='Ref_to_Member'>with_check</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN944"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>; 
</span><a name="LN945"></a>        <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>with_check_pstate</span> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN944"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN945"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, 
</span>                                            <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/parser/parse_relation.h.html#LN114"><span class='Ref_to_Proto'>addRTEtoQuery</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN945"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN944"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN888"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_clause.h.html#LN23"><span class='Ref_to_Proto'>transformWhereClause</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN945"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, 
</span>                                               <a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2303"><span class='Ref_to_Member'>with_check</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                               <a href="../../include/parser/parse_node.h.html#LN68"><span class='Ref_to_EnumConst'>EXPR_KIND_POLICY</span></a><span class='Delimiter'>, 
</span>                                               <span class='String'>"POLICY"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fix up collation information */ 
</span>        <a href="../../include/parser/parse_collate.h.html#LN22"><span class='Ref_to_Proto'>assign_expr_collations</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN945"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN888"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN886"><span class='Ref_To_Local'>with_check_parse_rtable</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN945"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>; 
</span>        <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN945"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stmt-&GT;with_check &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* zero-clear */ 
</span>    memset<span class='Parentheses'>(</span><a href="policy.c.html#LN893"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN893"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="policy.c.html#LN895"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN895"><span class='Ref_To_Local'>replaces</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="policy.c.html#LN894"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="policy.c.html#LN894"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find policy to update. */ 
</span>    <a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set key - policy's relation id. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN889"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN881"><span class='Ref_To_Local'>table_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set key - policy's name. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN889"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2299"><span class='Ref_to_Member'>policy_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN890"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                               <a href="policy.c.html#LN889"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN890"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check that the policy is found, raise an error if not. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"policy \"%s\" for table \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2299"><span class='Ref_to_Member'>policy_name</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get policy command */ 
</span>    <a href="policy.c.html#LN898"><span class='Ref_To_Local'>polcmd_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN48"><span class='Ref_to_Const'>Anum_pg_policy_polcmd</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="policy.c.html#LN900"><span class='Ref_To_Local'>polcmd_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN900"><span class='Ref_To_Local'>polcmd_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN899"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN414"><span class='Ref_to_Macro'>DatumGetChar</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN898"><span class='Ref_To_Local'>polcmd_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the command is SELECT or DELETE then WITH CHECK should be NULL. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="policy.c.html#LN899"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>== </span><a href="../../include/utils/acl.h.html#LN130"><span class='Ref_to_Const'>ACL_SELECT_CHR</span></a> <span class='Operator'>|| </span><a href="policy.c.html#LN899"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>== </span><a href="../../include/utils/acl.h.html#LN132"><span class='Ref_to_Const'>ACL_DELETE_CHR</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>&& </span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2303"><span class='Ref_to_Member'>with_check</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"only USING expression allowed for SELECT, DELETE"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the command is INSERT then WITH CHECK should be the only expression 
     * provided. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="policy.c.html#LN899"><span class='Ref_To_Local'>polcmd</span></a> <span class='Operator'>== </span><a href="../../include/utils/acl.h.html#LN129"><span class='Ref_to_Const'>ACL_INSERT_CHR</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>&& </span><a href="policy.c.html#LN876"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2302"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"only WITH CHECK expression allowed for INSERT"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN879"><span class='Ref_To_Local'>policy_id</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN884"><span class='Ref_To_Local'>role_ids</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="policy.c.html#LN895"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN893"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN884"><span class='Ref_To_Local'>role_ids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1033"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>roles</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>roles_datum</span><span class='Delimiter'>; 
</span><a name="LN1035"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>attr_isnull</span><span class='Delimiter'>; 
</span><a name="LN1036"></a>        <a href="../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>policy_roles</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We need to pull the set of roles this policy applies to from what's 
         * in the catalog, so that we can recreate the dependencies correctly 
         * for the policy. 
         */ 
</span> 
        <a href="policy.c.html#LN1034"><span class='Ref_To_Local'>roles_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN50"><span class='Ref_to_Const'>Anum_pg_policy_polroles</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="policy.c.html#LN1035"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN1035"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN1036"><span class='Ref_To_Local'>policy_roles</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN242"><span class='Ref_to_Macro'>DatumGetArrayTypePCopy</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1034"><span class='Ref_To_Local'>roles_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN1033"><span class='Ref_To_Local'>roles</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1036"><span class='Ref_To_Local'>policy_roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN883"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>= </span><a href="../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1036"><span class='Ref_To_Local'>policy_roles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span> 
        <a href="policy.c.html#LN882"><span class='Ref_To_Local'>role_oids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN883"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="policy.c.html#LN883"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>; </span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="policy.c.html#LN882"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1033"><span class='Ref_To_Local'>roles</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN887"><span class='Ref_To_Local'>qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="policy.c.html#LN895"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN893"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] 
</span>            <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN887"><span class='Ref_To_Local'>qual</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1069"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>value_datum</span><span class='Delimiter'>; 
</span><a name="LN1070"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>attr_isnull</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We need to pull the USING expression and build the range table for 
         * the policy from what's in the catalog, so that we can recreate the 
         * dependencies correctly for the policy. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* Check if the policy has a USING expr */ 
</span>        <a href="policy.c.html#LN1069"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_policy_polqual</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="policy.c.html#LN1070"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN1070"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1084"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>qual_value</span><span class='Delimiter'>; 
</span><a name="LN1085"></a>            <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qual_pstate</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* parsestate is built just to build the range table */ 
</span>            <a href="policy.c.html#LN1085"><span class='Ref_To_Local'>qual_pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN1084"><span class='Ref_To_Local'>qual_value</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1069"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN887"><span class='Ref_To_Local'>qual</span></a> <span class='Operator'>= </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1084"><span class='Ref_To_Local'>qual_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add this rel to the parsestate's rangetable, for dependencies */ 
</span>            <a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1085"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN885"><span class='Ref_To_Local'>qual_parse_rtable</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN1085"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>; 
</span>            <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1085"><span class='Ref_To_Local'>qual_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN888"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="policy.c.html#LN895"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="policy.c.html#LN893"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] 
</span>            <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN888"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1110"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>value_datum</span><span class='Delimiter'>; 
</span><a name="LN1111"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>attr_isnull</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We need to pull the WITH CHECK expression and build the range table 
         * for the policy from what's in the catalog, so that we can recreate 
         * the dependencies correctly for the policy. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* Check if the policy has a WITH CHECK expr */ 
</span>        <a href="policy.c.html#LN1110"><span class='Ref_To_Local'>value_datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_policy_polwithcheck</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="policy.c.html#LN1111"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN1111"><span class='Ref_To_Local'>attr_isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1125"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>with_check_value</span><span class='Delimiter'>; 
</span><a name="LN1126"></a>            <a href="../../include/parser/parse_node.h.html#LN164"><span class='Ref_to_Struct'>ParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>with_check_pstate</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* parsestate is built just to build the range table */ 
</span>            <a href="policy.c.html#LN1126"><span class='Ref_To_Local'>with_check_pstate</span></a> <span class='Operator'>= </span><a href="../parser/parse_node.c.html#LN42"><span class='Ref_to_Func'>make_parsestate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN1125"><span class='Ref_To_Local'>with_check_value</span></a> <span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1110"><span class='Ref_To_Local'>value_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="policy.c.html#LN888"><span class='Ref_To_Local'>with_check_qual</span></a> <span class='Operator'>= </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1125"><span class='Ref_To_Local'>with_check_value</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Add this rel to the parsestate's rangetable, for dependencies */ 
</span>            <a href="../../include/parser/parse_relation.h.html#LN69"><span class='Ref_to_Proto'>addRangeTableEntryForRelation</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1126"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="policy.c.html#LN886"><span class='Ref_To_Local'>with_check_parse_rtable</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN1126"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/parser/parse_node.h.html#LN168"><span class='Ref_to_Member'>p_rtable</span></a><span class='Delimiter'>; 
</span>            <a href="../parser/parse_node.c.html#LN75"><span class='Ref_to_Func'>free_parsestate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1126"><span class='Ref_To_Local'>with_check_pstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="policy.c.html#LN892"><span class='Ref_To_Local'>new_tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN891"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="policy.c.html#LN893"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN894"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN895"><span class='Ref_To_Local'>replaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN892"><span class='Ref_To_Local'>new_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN892"><span class='Ref_To_Local'>new_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update Dependencies. */ 
</span>    <a href="../catalog/pg_depend.c.html#LN189"><span class='Ref_to_Func'>deleteDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN879"><span class='Ref_To_Local'>policy_id</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Record Dependencies */ 
</span>    <a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN881"><span class='Ref_To_Local'>table_id</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="policy.c.html#LN879"><span class='Ref_To_Local'>policy_id</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../catalog/pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN75"><span class='Ref_to_EnumConst'>DEPENDENCY_AUTO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN887"><span class='Ref_To_Local'>qual</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN885"><span class='Ref_To_Local'>qual_parse_rtable</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN888"><span class='Ref_To_Local'>with_check_qual</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN886"><span class='Ref_To_Local'>with_check_parse_rtable</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Register role dependencies */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN254"><span class='Ref_to_Proto'>deleteSharedDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN879"><span class='Ref_To_Local'>policy_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_authid.h.html#LN41"><span class='Ref_to_Const'>AuthIdRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="policy.c.html#LN883"><span class='Ref_To_Local'>nitems</span></a><span class='Delimiter'>; </span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN505"><span class='Ref_to_Macro'>DatumGetObjectId</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN882"><span class='Ref_To_Local'>role_oids</span></a><span class='Delimiter'>[</span><a href="policy.c.html#LN901"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* no dependency if public */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN38"><span class='Ref_to_Const'>ACL_ID_PUBLIC</span></a><span class='Parentheses'>) 
</span>            <a href="../catalog/pg_shdepend.c.html#LN113"><span class='Ref_to_Func'>recordSharedDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN896"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/catalog/dependency.h.html#LN117"><span class='Ref_to_EnumConst'>SHARED_DEPENDENCY_POLICY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN879"><span class='Ref_To_Local'>policy_id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN892"><span class='Ref_To_Local'>new_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Invalidate Relation Cache */ 
</span>    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up. */ 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN890"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN880"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN878"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN897"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AlterPolicy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * rename_policy - 
 *   change the name of a policy on a relation 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN1200"></a><span class='Declare_Function'>rename_policy</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2770"><span class='Ref_to_Struct'>RenameStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1202"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_policy_rel</span><span class='Delimiter'>; 
</span><a name="LN1203"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>target_table</span><span class='Delimiter'>; 
</span><a name="LN1204"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>table_id</span><span class='Delimiter'>; 
</span><a name="LN1205"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>opoloid</span><span class='Delimiter'>; 
</span><a name="LN1206"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1207"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN1208"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>policy_tuple</span><span class='Delimiter'>; 
</span><a name="LN1209"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get id of table.  Also handles permissions checks. */ 
</span>    <a href="policy.c.html#LN1204"><span class='Ref_To_Local'>table_id</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2775"><span class='Ref_to_Member'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                        <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                        <a href="policy.c.html#LN48"><span class='Ref_to_Proto'>RangeVarCallbackForPolicy</span></a><span class='Delimiter'>, 
</span>                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1203"><span class='Ref_To_Local'>target_table</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1204"><span class='Ref_To_Local'>table_id</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1202"><span class='Ref_To_Local'>pg_policy_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First pass -- check for conflict */ 
</span> 
    <span class='Comment_Multi_Line'>/* Add key - policy's relation id. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1206"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1204"><span class='Ref_To_Local'>table_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add key - policy's name. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1206"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2779"><span class='Ref_to_Member'>newname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1207"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1202"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                               <a href="policy.c.html#LN1206"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1207"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"policy \"%s\" for table \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                     <a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2779"><span class='Ref_to_Member'>newname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1203"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1207"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Second pass -- find existing policy and update */ 
</span>    <span class='Comment_Multi_Line'>/* Add key - policy's relation id. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1206"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1204"><span class='Ref_To_Local'>table_id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add key - policy's name. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1206"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2777"><span class='Ref_to_Member'>subname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1207"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1202"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                               <a href="policy.c.html#LN1206"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1207"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Complain if we did not find the policy */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"policy \"%s\" for table \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                     <a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2777"><span class='Ref_to_Member'>subname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1203"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1205"><span class='Ref_To_Local'>opoloid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN606"><span class='Ref_to_Func'>heap_copytuple</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/builtins.h.html#LN40"><span class='Ref_to_Proto'>namestrcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_policy.h.html#LN39"><span class='Ref_to_Typedef'>Form_pg_policy</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>polname<span class='Delimiter'>, 
</span>               <a href="policy.c.html#LN1200"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2779"><span class='Ref_to_Member'>newname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1202"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1208"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1209"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="policy.c.html#LN1205"><span class='Ref_To_Local'>opoloid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Invalidate relation's relcache entry so that other backends (and this 
     * one too!) are sent SI message to make them rebuild relcache entries. 
     * (Ideally this should happen automatically...) 
     */ 
</span>    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1203"><span class='Ref_To_Local'>target_table</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up. */ 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1207"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1202"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1203"><span class='Ref_To_Local'>target_table</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN1209"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rename_policy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_relation_policy_oid - Look up a policy by name to find its OID 
 * 
 * If missing_ok is false, throw an error if policy not found.  If 
 * true, just return InvalidOid. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1309"></a><span class='Declare_Function'>get_relation_policy_oid</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>policy_name</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1311"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_policy_rel</span><span class='Delimiter'>; 
</span><a name="LN1312"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN1313"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN1314"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>policy_tuple</span><span class='Delimiter'>; 
</span><a name="LN1315"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>policy_oid</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1311"><span class='Ref_To_Local'>pg_policy_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add key - policy's relation id. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1312"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1309"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add key - policy's name. */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1312"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN46"><span class='Ref_to_Const'>Anum_pg_policy_polname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1309"><span class='Ref_to_Parameter'>policy_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1313"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1311"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, 
</span>                               <a href="policy.c.html#LN1312"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1314"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1313"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1314"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="policy.c.html#LN1309"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"policy \"%s\" for table \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                            <a href="policy.c.html#LN1309"><span class='Ref_to_Parameter'>policy_name</span></a><span class='Delimiter'>, </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1309"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <a href="policy.c.html#LN1315"><span class='Ref_To_Local'>policy_oid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="policy.c.html#LN1315"><span class='Ref_To_Local'>policy_oid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1314"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up. */ 
</span>    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1313"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1311"><span class='Ref_To_Local'>pg_policy_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN1315"><span class='Ref_To_Local'>policy_oid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_relation_policy_oid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * relation_has_policies - Determine if relation has any policies 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1361"></a><span class='Declare_Function'>relation_has_policies</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1363"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>catalog</span><span class='Delimiter'>; 
</span><a name="LN1364"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>; 
</span><a name="LN1365"></a>    <a href="../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sscan</span><span class='Delimiter'>; 
</span><a name="LN1366"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>policy_tuple</span><span class='Delimiter'>; 
</span><a name="LN1367"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="policy.c.html#LN1363"><span class='Ref_To_Local'>catalog</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_policy.h.html#LN18"><span class='Ref_to_Const'>PolicyRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="policy.c.html#LN1364"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/catalog/pg_policy.h.html#LN47"><span class='Ref_to_Const'>Anum_pg_policy_polrelid</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1361"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN1365"><span class='Ref_To_Local'>sscan</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1363"><span class='Ref_To_Local'>catalog</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/indexing.h.html#LN329"><span class='Ref_to_Const'>PolicyPolrelidPolnameIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="policy.c.html#LN1364"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="policy.c.html#LN1366"><span class='Ref_To_Local'>policy_tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1365"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1366"><span class='Ref_To_Local'>policy_tuple</span></a><span class='Parentheses'>))</span> 
        <a href="policy.c.html#LN1367"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1365"><span class='Ref_To_Local'>sscan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="policy.c.html#LN1363"><span class='Ref_To_Local'>catalog</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="policy.c.html#LN1367"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end relation_has_policies &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>