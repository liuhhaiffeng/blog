<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\commands\tablespace.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\commands\tablespace.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:37 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * tablespace.c 
 *    Commands to manipulate table spaces 
 * 
 * Tablespaces in PostgreSQL are designed to allow users to determine 
 * where the data file(s) for a given database object reside on the file 
 * system. 
 * 
 * A tablespace represents a directory on the file system. At tablespace 
 * creation time, the directory must be empty. To simplify things and 
 * remove the possibility of having file name conflicts, we isolate 
 * files within a tablespace into database-specific subdirectories. 
 * 
 * To support file access via the information given in RelFileNode, we 
 * maintain a symbolic-link map in $PGDATA/pg_tblspc. The symlinks are 
 * named by tablespace OIDs and point to the actual tablespace directories. 
 * There is also a per-cluster version directory in each tablespace. 
 * Thus the full path to an arbitrary file is 
 *          $PGDATA/pg_tblspc/spcoid/PG_MAJORVER_CATVER/dboid/relfilenode 
 * e.g. 
 *          $PGDATA/pg_tblspc/20981/PG_9.0_201002161/719849/83292814 
 * 
 * There are two tablespaces created at initdb time: pg_global (for shared 
 * tables) and pg_default (for everything else).  For backwards compatibility 
 * and to remain functional on platforms without symlinks, these tablespaces 
 * are accessed specially: they are respectively 
 *          $PGDATA/global/relfilenode 
 *          $PGDATA/base/dboid/relfilenode 
 * 
 * To allow CREATE DATABASE to give a new database a default tablespace 
 * that's different from the template database's default, we make the 
 * provision that a zero in pg_class.reltablespace means the database's 
 * default tablespace.  Without this, CREATE DATABASE would have to go in 
 * and munge the system catalogs of the new database. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/commands/tablespace.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;dirent.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xloginsert.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/comment.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/seclabel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablecmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgwriter.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/standby.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/varlena.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* GUC variables */ 
</span><a name="LN87"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>default_tablespace</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>temp_tablespaces</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<a name="LN91"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>create_tablespace_directories</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>location</span><span class='Delimiter'>, 
</span><a name="LN92"></a>                              <span class='Keyword'>const </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tablespaceoid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN93"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>destroy_tablespace_directories</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tablespaceoid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>redo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Each database using a table space is isolated into its own name space 
 * by a subdirectory named for the database OID.  On first creation of an 
 * object in the tablespace, create the subdirectory.  If the subdirectory 
 * already exists, fall through quietly. 
 * 
 * isRedo indicates that we are creating an object during WAL replay. 
 * In this case we will cope with the possibility of the tablespace 
 * directory not being there either --- this could happen if we are 
 * replaying an operation on a table in a subsequently-dropped tablespace. 
 * We handle this by making a directory in the place where the tablespace 
 * symlink would normally be.  This isn't an exact replay of course, but 
 * it's the best we can do given the available information. 
 * 
 * If tablespaces are not supported, we still need it in case we have to 
 * re-create a database subdirectory (of $PGDATA/base) during WAL replay. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN114"></a><span class='Declare_Function'>TablespaceCreateDbspace</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>spcNode</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbNode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isRedo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN116"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span><a name="LN117"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The global tablespace doesn't have per-database subdirectories, so 
     * nothing to do for it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN114"><span class='Ref_to_Parameter'>spcNode</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN114"><span class='Ref_to_Parameter'>spcNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN114"><span class='Ref_to_Parameter'>dbNode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN114"><span class='Ref_to_Parameter'>dbNode</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN114"><span class='Ref_to_Parameter'>spcNode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Directory does not exist? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Acquire TablespaceCreateLock to ensure that no DROP TABLESPACE 
             * or TablespaceCreateDbspace is running concurrently. 
             */ 
</span>            <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TablespaceCreateLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Recheck to see if someone created the directory while we were 
             * waiting for lock. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Directory was created */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Directory creation failed? */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span><a name="LN155"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>parentdir</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Failure other than not exists or not in WAL replay? */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT <span class='Operator'>|| !</span><a href="tablespace.c.html#LN114"><span class='Ref_to_Parameter'>isRedo</span></a><span class='Parentheses'>) 
</span>                        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                              <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Parent directories are missing during WAL replay, so 
                     * continue by creating simple parent directories rather 
                     * than a symlink. 
                     */ 
</span> 
                    <span class='Comment_Multi_Line'>/* create two parents up if not exist */ 
</span>                    <a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/port.h.html#LN62"><span class='Ref_to_Proto'>get_parent_directory</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/port.h.html#LN62"><span class='Ref_to_Proto'>get_parent_directory</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Can't create parent and it doesn't already exist? */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EEXIST<span class='Parentheses'>)</span> 
                        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                              <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* create one parent up if not exist */ 
</span>                    <a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/port.h.html#LN62"><span class='Ref_to_Proto'>get_parent_directory</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Can't create parent and it doesn't already exist? */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EEXIST<span class='Parentheses'>)</span> 
                        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                              <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN155"><span class='Ref_To_Local'>parentdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Create database directory */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                              <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mkdir(dir,S_IRWXU)&LT;0 &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TablespaceCreateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if errno==ENOENT &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat directory \"%s\": %m"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if stat(dir,&st)&LT;0 &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Is it not a directory? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" exists but is not a directory"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN117"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TablespaceCreateDbspace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a table space 
 * 
 * Only superusers can create a tablespace. This seems a reasonable restriction 
 * since we're determining the system layout and, anyway, we probably have 
 * root if we're doing this kind of activity 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN232"></a><span class='Declare_Function'>CreateTableSpace</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2101"><span class='Ref_to_Struct'>CreateTableSpaceStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_SYMLINK 
<a name="LN235"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN236"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN53"><span class='Ref_to_Const'>Natts_pg_tablespace</span></a><span class='Delimiter'>]; 
</span><a name="LN237"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN53"><span class='Ref_to_Const'>Natts_pg_tablespace</span></a><span class='Delimiter'>]; 
</span><a name="LN238"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN239"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tablespaceoid</span><span class='Delimiter'>; 
</span><a name="LN240"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>location</span><span class='Delimiter'>; 
</span><a name="LN241"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>ownerId</span><span class='Delimiter'>; 
</span><a name="LN242"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>newOptions</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be super user */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to create tablespace \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2104"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Must be superuser to create a tablespace."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* However, the eventual owner of the tablespace need not be */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2105"><span class='Ref_to_Member'>owner</span></a><span class='Parentheses'>) 
</span>        <a href="tablespace.c.html#LN241"><span class='Ref_To_Local'>ownerId</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN236"><span class='Ref_to_Proto'>get_rolespec_oid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2105"><span class='Ref_to_Member'>owner</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tablespace.c.html#LN241"><span class='Ref_To_Local'>ownerId</span></a> <span class='Operator'>= </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Unix-ify the offered path, and strip any trailing slashes */ 
</span>    <a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2106"><span class='Ref_to_Member'>location</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* disallow quotes, else CREATE DATABASE would be at risk */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Delimiter'>, </span><span class='String'>'\''</span><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace location cannot contain single quotes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allowing relative paths seems risky 
     * 
     * this also helps us ensure that location is not empty or whitespace 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace location must be an absolute path"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that location isn't too long. Remember that we're going to append 
     * 'PG_XXX/&LT;dboid&GT;/&LT;relid&GT;_&LT;fork&GT;.&LT;nnn&GT;'.  FYI, we never actually 
     * reference the whole path here, but mkdir() uses the first two parts. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ 
</span>      <a href="../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="../../include/common/relpath.h.html#LN40"><span class='Ref_to_Const'>FORKNAMECHARS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a> <span class='Operator'>&GT; </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace location \"%s\" is too long"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Warn if the tablespace is in the data directory. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN47"><span class='Ref_to_Proto'>path_is_prefix_of_path</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace location should not be inside the data directory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Disallow creation of tablespaces named "pg_xxx"; we reserve this 
     * namespace for system purposes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN40"><span class='Ref_to_Proto'>IsReservedName</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2104"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_RESERVED_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unacceptable tablespace name \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2104"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The prefix \"pg_\" is reserved for system tablespaces."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that there is no other tablespace by this name.  (The unique 
     * index would catch this anyway, but might as well give a friendlier 
     * message.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2104"><span class='Ref_to_Member'>tablespacename</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2104"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Insert tuple into pg_tablespace.  The purpose of doing this first is to 
     * lock the proposed tablename against other would-be creators. The 
     * insertion will roll back if we find problems below. 
     */ 
</span>    <a href="tablespace.c.html#LN235"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN237"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN237"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN236"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_tablespace_spcname</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>        <a href="../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="../utils/adt/name.c.html#LN44"><span class='Ref_to_Func'>namein</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2104"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN236"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN55"><span class='Ref_to_Const'>Anum_pg_tablespace_spcowner</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>        <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN241"><span class='Ref_To_Local'>ownerId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN237"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN56"><span class='Ref_to_Const'>Anum_pg_tablespace_spcacl</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate new proposed spcoptions (text array) */ 
</span>    <a href="tablespace.c.html#LN242"><span class='Ref_To_Local'>newOptions</span></a> <span class='Operator'>= </span><a href="../../include/access/reloptions.h.html#LN257"><span class='Ref_to_Proto'>transformRelOptions</span></a><span class='Parentheses'>((</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN232"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2107"><span class='Ref_to_Member'>options</span></a><span class='Delimiter'>, 
</span>                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/reloptions.h.html#LN279"><span class='Ref_to_Proto'>tablespace_reloptions</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN242"><span class='Ref_To_Local'>newOptions</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN242"><span class='Ref_To_Local'>newOptions</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="tablespace.c.html#LN236"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN57"><span class='Ref_to_Const'>Anum_pg_tablespace_spcoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablespace.c.html#LN242"><span class='Ref_To_Local'>newOptions</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tablespace.c.html#LN237"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN57"><span class='Ref_to_Const'>Anum_pg_tablespace_spcoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN238"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN235"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN236"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN237"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN239"><span class='Ref_To_Local'>tablespaceoid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN235"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN238"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN238"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Record dependency on owner */ 
</span>    <a href="../catalog/pg_shdepend.c.html#LN157"><span class='Ref_to_Func'>recordDependencyOnOwner</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN239"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN241"><span class='Ref_To_Local'>ownerId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Post creation hook for new tablespace */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN144"><span class='Ref_to_Macro'>InvokeObjectPostCreateHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN239"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN91"><span class='Ref_to_Proto'>create_tablespace_directories</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN239"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Record the filesystem change in XLOG */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN359"></a>        <a href="../../include/commands/tablespace.h.html#LN25"><span class='Ref_to_Struct'>xl_tblspc_create_rec</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
        <a href="tablespace.c.html#LN359"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/tablespace.h.html#LN27"><span class='Ref_to_Member'>ts_id</span></a> <span class='Operator'>= </span><a href="tablespace.c.html#LN239"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="tablespace.c.html#LN359"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/commands/tablespace.h.html#LN25"><span class='Ref_to_Struct'>xl_tblspc_create_rec</span></a><span class='Delimiter'>, </span>ts_path<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_TBLSPC_ID<span class='Delimiter'>, </span><a href="../../include/commands/tablespace.h.html#LN22"><span class='Ref_to_Const'>XLOG_TBLSPC_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force synchronous commit, to minimize the window between creating the 
     * symlink on-disk and marking the transaction committed.  It's not great 
     * that there is any window at all, but definitely we don't want to make 
     * it larger than necessary. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN347"><span class='Ref_to_Proto'>ForceSyncCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN240"><span class='Ref_To_Local'>location</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We keep the lock on pg_tablespace until commit */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN235"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablespace.c.html#LN239"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_SYMLINK */ 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespaces are not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_SYMLINK */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CreateTableSpace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Drop a table space 
 * 
 * Be careful to check that the tablespace is empty. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN399"></a><span class='Declare_Function'>DropTableSpace</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2110"><span class='Ref_to_Struct'>DropTableSpaceStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_SYMLINK 
<a name="LN402"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tablespacename</span> <span class='Operator'>= </span><a href="tablespace.c.html#LN399"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2113"><span class='Ref_to_Member'>tablespacename</span></a><span class='Delimiter'>; 
</span><a name="LN403"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scandesc</span><span class='Delimiter'>; 
</span><a name="LN404"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN405"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN406"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN407"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tablespaceoid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find the target tuple 
     */ 
</span>    <a href="tablespace.c.html#LN404"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablespace.c.html#LN406"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_tablespace.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_tablespace_spcname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN402"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN403"><span class='Ref_To_Local'>scandesc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN404"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN406"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN405"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN403"><span class='Ref_To_Local'>scandesc</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN405"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN399"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2114"><span class='Ref_to_Member'>missing_ok</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN402"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist, skipping"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN402"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* XXX I assume I need one or both of these next two calls */ 
</span>            <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN403"><span class='Ref_To_Local'>scandesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN404"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !HeapTupleIsValid(tup... &raquo; </span> 
 
    <a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN405"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be tablespace owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN315"><span class='Ref_to_Proto'>pg_tablespace_ownercheck</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, 
</span>                       <a href="tablespace.c.html#LN402"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Disallow drop of the standard tablespaces, even by superuser */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a> <span class='Operator'>|| 
</span>        <a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_tablespace.h.html#LN62"><span class='Ref_to_Const'>DEFAULTTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN172"><span class='Ref_to_EnumConst'>ACLCHECK_NO_PRIV</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, 
</span>                       <a href="tablespace.c.html#LN402"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* DROP hook for the tablespace being removed */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN153"><span class='Ref_to_Macro'>InvokeObjectDropHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove the pg_tablespace tuple (this will roll back if we fail below) 
     */ 
</span>    <a href="../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN404"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN405"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN403"><span class='Ref_To_Local'>scandesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove any comments or security labels on this tablespace. 
     */ 
</span>    <a href="../../include/commands/comment.h.html#LN38"><span class='Ref_to_Proto'>DeleteSharedComments</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/commands/seclabel.h.html#LN21"><span class='Ref_to_Proto'>DeleteSharedSecurityLabel</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove dependency on owner. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN254"><span class='Ref_to_Proto'>deleteSharedDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Acquire TablespaceCreateLock to ensure that no TablespaceCreateDbspace 
     * is running concurrently. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>TablespaceCreateLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to remove the physical infrastructure. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN93"><span class='Ref_to_Proto'>destroy_tablespace_directories</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Not all files deleted?  However, there can be lingering empty files 
         * in the directories, left behind by for example DROP TABLE, that 
         * have been scheduled for deletion at next checkpoint (see comments 
         * in mdunlink() for details).  We could just delete them immediately, 
         * but we can't tell them apart from important data files that we 
         * mustn't delete.  So instead, we force a checkpoint which will clean 
         * out any lingering files, and try again. 
         * 
         * XXX On Windows, an unlinked file persists in the directory listing 
         * until no process retains an open handle for the file.  The DDL 
         * commands that schedule files for unlink send invalidation messages 
         * directing other PostgreSQL processes to close the files.  DROP 
         * TABLESPACE should not give up on the tablespace becoming empty 
         * until all relevant invalidation processing is complete. 
         */ 
</span>        <a href="../../include/postmaster/bgwriter.h.html#LN30"><span class='Ref_to_Proto'>RequestCheckpoint</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN178"><span class='Ref_to_Const'>CHECKPOINT_IMMEDIATE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN179"><span class='Ref_to_Const'>CHECKPOINT_FORCE</span></a> <span class='Operator'>| </span><a href="../../include/access/xlog.h.html#LN183"><span class='Ref_to_Const'>CHECKPOINT_WAIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN93"><span class='Ref_to_Proto'>destroy_tablespace_directories</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Still not empty, the files must be important then */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" is not empty"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN402"><span class='Ref_To_Local'>tablespacename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !destroy_tablespace_d... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Record the filesystem change in XLOG */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN516"></a>        <a href="../../include/commands/tablespace.h.html#LN31"><span class='Ref_to_Struct'>xl_tblspc_drop_rec</span></a> <span class='Declare_Local'>xlrec</span><span class='Delimiter'>; 
</span> 
        <a href="tablespace.c.html#LN516"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>.</span><a href="../../include/commands/tablespace.h.html#LN33"><span class='Ref_to_Member'>ts_id</span></a> <span class='Operator'>= </span><a href="tablespace.c.html#LN407"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xloginsert.h.html#LN41"><span class='Ref_to_Proto'>XLogBeginInsert</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xloginsert.h.html#LN45"><span class='Ref_to_Proto'>XLogRegisterData</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="tablespace.c.html#LN516"><span class='Ref_To_Local'>xlrec</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/commands/tablespace.h.html#LN31"><span class='Ref_to_Struct'>xl_tblspc_drop_rec</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/xloginsert.h.html#LN43"><span class='Ref_to_Proto'>XLogInsert</span></a><span class='Parentheses'>(</span>RM_TBLSPC_ID<span class='Delimiter'>, </span><a href="../../include/commands/tablespace.h.html#LN23"><span class='Ref_to_Const'>XLOG_TBLSPC_DROP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: because we checked that the tablespace was empty, there should be 
     * no need to worry about flushing shared buffers or free space map 
     * entries for relations in the tablespace. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force synchronous commit, to minimize the window between removing the 
     * files on-disk and marking the transaction committed.  It's not great 
     * that there is any window at all, but definitely we don't want to make 
     * it larger than necessary. 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN347"><span class='Ref_to_Proto'>ForceSyncCommit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow TablespaceCreateDbspace again. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>TablespaceCreateLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We keep the lock on pg_tablespace until commit */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN404"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_SYMLINK */ 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespaces are not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_SYMLINK */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DropTableSpace &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * create_tablespace_directories 
 * 
 *  Attempt to create filesystem infrastructure linking $PGDATA/pg_tblspc/ 
 *  to the specified directory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN562"></a><span class='Declare_Function'>create_tablespace_directories</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>location</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tablespaceoid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN564"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>linkloc</span><span class='Delimiter'>; 
</span><a name="LN565"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>location_with_version_dir</span><span class='Delimiter'>; 
</span><a name="LN566"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN564"><span class='Ref_To_Local'>linkloc</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc/%u"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN562"><span class='Ref_to_Parameter'>tablespaceoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN562"><span class='Ref_to_Parameter'>location</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Attempt to coerce target directory to safe permissions.  If this fails, 
     * it doesn't exist or has the wrong owner. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>chmod<span class='Parentheses'>(</span><a href="tablespace.c.html#LN562"><span class='Ref_to_Parameter'>location</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_FILE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"directory \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN562"><span class='Ref_to_Parameter'>location</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Create this directory for the tablespace before "</span> 
                                          <span class='String'>"restarting the server."</span><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                  <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set permissions on directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                         <a href="tablespace.c.html#LN562"><span class='Ref_to_Parameter'>location</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Our theory for replaying a CREATE is to forcibly drop the target 
         * subdirectory if present, and then recreate it. This may be more 
         * work than needed, but it is simple to implement. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN566"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN566"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                <span class='Comment_Multi_Line'>/* If this failed, mkdir() below is going to error. */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"some useless files may be left behind in old database directory \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The creation of the version directory prevents more than one tablespace 
     * in a single location. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EEXIST<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"directory \"%s\" already in use as a tablespace"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In recovery, remove old symlink, in case it points to the wrong place. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/commands/tablespace.h.html#LN59"><span class='Ref_to_Proto'>remove_tablespace_symlink</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN564"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the symlink under PGDATA 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN255"><span class='Ref_to_Macro'>symlink</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN562"><span class='Ref_to_Parameter'>location</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN564"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create symbolic link \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN564"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN564"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN565"><span class='Ref_To_Local'>location_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end create_tablespace_directories &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * destroy_tablespace_directories 
 * 
 * Attempt to remove filesystem infrastructure for the tablespace. 
 * 
 * 'redo' indicates we are redoing a drop from XLOG; in that case we should 
 * not throw an ERROR for problems, just LOG them.  The worst consequence of 
 * not removing files here would be failure to release some disk space, which 
 * does not justify throwing an error that would require manual intervention 
 * to get the database running again. 
 * 
 * Returns TRUE if successful, FALSE if some subdirectory is not empty 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN660"></a><span class='Declare_Function'>destroy_tablespace_directories</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tablespaceoid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>redo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN662"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>linkloc</span><span class='Delimiter'>; 
</span><a name="LN663"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>linkloc_with_version_dir</span><span class='Delimiter'>; 
</span><a name="LN664"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dirdesc</span><span class='Delimiter'>; 
</span><a name="LN665"></a>    <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN666"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>subfile</span><span class='Delimiter'>; 
</span><a name="LN667"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc/%u/%s"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>tablespaceoid</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if the tablespace still contains any files.  We try to rmdir each 
     * per-database directory we find in it.  rmdir failure implies there are 
     * still files in that subdirectory, so give up.  (We do not have to worry 
     * about undoing any already completed rmdirs, since the next attempt to 
     * use the tablespace from that database will simply recreate the 
     * subdirectory via TablespaceCreateDbspace.) 
     * 
     * Since we hold TablespaceCreateLock, no one else should be creating any 
     * fresh subdirectories in parallel. It is possible that new files are 
     * being created within subdirectories, though, so the rmdir call could 
     * fail.  Worst consequence is a less friendly error message. 
     * 
     * If redo is true then ENOENT is a likely outcome here, and we allow it 
     * to pass without comment.  In normal operation we still allow it, but 
     * with a warning.  This is because even though ProcessUtility disallows 
     * DROP TABLESPACE in a transaction block, it's possible that a previous 
     * DROP failed and rolled back after removing the tablespace directories 
     * and/or symlink.  We want to allow a new DROP attempt to succeed at 
     * removing the catalog entries (and symlink if still present), so we 
     * should not give a hard error here. 
     */ 
</span>    <a href="tablespace.c.html#LN664"><span class='Ref_To_Local'>dirdesc</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN664"><span class='Ref_To_Local'>dirdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* The symlink might still exist, so go try to remove it */ 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="tablespace.c.html#LN770"><span class='Ref_to_Label'>remove_symlink</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* in redo, just log other types of error */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* else let ReadDir report the error */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dirdesc==NULL &raquo; </span> 
 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tablespace.c.html#LN665"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN664"><span class='Ref_To_Local'>dirdesc</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="tablespace.c.html#LN665"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="tablespace.c.html#LN665"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="tablespace.c.html#LN666"><span class='Ref_To_Local'>subfile</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN665"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* This check is just to deliver a friendlier error message */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>&& !</span><a href="../../include/commands/tablespace.h.html#LN58"><span class='Ref_to_Proto'>directory_is_empty</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN666"><span class='Ref_To_Local'>subfile</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN664"><span class='Ref_To_Local'>dirdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN666"><span class='Ref_To_Local'>subfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* remove empty directory */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>rmdir<span class='Parentheses'>(</span><a href="tablespace.c.html#LN666"><span class='Ref_To_Local'>subfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN666"><span class='Ref_To_Local'>subfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN666"><span class='Ref_To_Local'>subfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDir(dirdesc,l... &raquo; </span> 
 
    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN664"><span class='Ref_To_Local'>dirdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* remove version directory */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>rmdir<span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to remove the symlink.  We must however deal with the possibility 
     * that it's a directory instead of a symlink --- this could happen during 
     * WAL replay (see TablespaceCreateDbspace), and it is also the case on 
     * Windows where junction points lstat() as directories. 
     * 
     * Note: in the redo case, we'll return true if this final step fails; 
     * there's no point in retrying it.  Also, ENOENT should provoke no more 
     * than a warning. 
     */ 
</span><a name="LN770"></a><span class='Label'>remove_symlink</span><span class='Operator'>: 
</span>    <a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN62"><span class='Ref_to_Proto'>get_parent_directory</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN667"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN775"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>saved_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN775"><span class='Ref_To_Local'>saved_errno</span></a> <span class='Operator'>== </span>ENOENT <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN667"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>rmdir<span class='Parentheses'>(</span><a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN786"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>saved_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN786"><span class='Ref_To_Local'>saved_errno</span></a> <span class='Operator'>== </span>ENOENT <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> S_ISLNK 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>S_ISLNK<span class='Parentheses'>(</span><a href="tablespace.c.html#LN667"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN799"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>saved_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN799"><span class='Ref_To_Local'>saved_errno</span></a> <span class='Operator'>== </span>ENOENT <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove symbolic link \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Refuse to remove anything that's not a directory or symlink */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN660"><span class='Ref_to_Parameter'>redo</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a directory or symbolic link"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN663"><span class='Ref_To_Local'>linkloc_with_version_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN662"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end destroy_tablespace_directories &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Check if a directory is empty. 
 * 
 * This probably belongs somewhere else, but not sure where... 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN830"></a><span class='Declare_Function'>directory_is_empty</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN832"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dirdesc</span><span class='Delimiter'>; 
</span><a name="LN833"></a>    <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN832"><span class='Ref_To_Local'>dirdesc</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN830"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tablespace.c.html#LN833"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN832"><span class='Ref_To_Local'>dirdesc</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN830"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="tablespace.c.html#LN833"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="tablespace.c.html#LN833"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN832"><span class='Ref_To_Local'>dirdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN832"><span class='Ref_To_Local'>dirdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end directory_is_empty &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  remove_tablespace_symlink 
 * 
 * This function removes symlinks in pg_tblspc.  On Windows, junction points 
 * act like directories so we must be able to apply rmdir.  This function 
 * works like the symlink removal code in destroy_tablespace_directories, 
 * except that failure to remove is always an ERROR.  But if the file doesn't 
 * exist at all, that's OK. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN860"></a><span class='Declare_Function'>remove_tablespace_symlink</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>linkloc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN862"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN862"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN862"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This will fail if the directory isn't empty, but not if it's a 
         * junction point. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>rmdir<span class='Parentheses'>(</span><a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> S_ISLNK 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>S_ISLNK<span class='Parentheses'>(</span><a href="tablespace.c.html#LN862"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove symbolic link \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Refuse to remove anything that's not a directory or symlink */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a directory or symbolic link"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN860"><span class='Ref_to_Parameter'>linkloc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end remove_tablespace_symlink &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Rename a tablespace 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN909"></a><span class='Declare_Function'>RenameTableSpace</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>oldname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN911"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tspId</span><span class='Delimiter'>; 
</span><a name="LN912"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN913"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN914"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN915"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN916"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtuple</span><span class='Delimiter'>; 
</span><a name="LN917"></a>    <a href="../../include/catalog/pg_tablespace.h.html#LN46"><span class='Ref_to_Typedef'>Form_pg_tablespace</span></a> <span class='Declare_Local'>newform</span><span class='Delimiter'>; 
</span><a name="LN918"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search pg_tablespace */ 
</span>    <a href="tablespace.c.html#LN912"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablespace.c.html#LN913"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_tablespace.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_tablespace_spcname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>oldname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN914"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN912"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN913"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN915"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN914"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN915"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>oldname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN911"><span class='Ref_To_Local'>tspId</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN915"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN916"><span class='Ref_To_Local'>newtuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN606"><span class='Ref_to_Func'>heap_copytuple</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN915"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN917"><span class='Ref_To_Local'>newform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN46"><span class='Ref_to_Typedef'>Form_pg_tablespace</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN916"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN914"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN315"><span class='Ref_to_Proto'>pg_tablespace_ownercheck</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN916"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN172"><span class='Ref_to_EnumConst'>ACLCHECK_NO_PRIV</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>oldname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Validate new name */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN40"><span class='Ref_to_Proto'>IsReservedName</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_RESERVED_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unacceptable tablespace name \"%s\""</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The prefix \"pg_\" is reserved for system tablespaces."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure the new name doesn't exist */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablespace.c.html#LN913"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_tablespace.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_tablespace_spcname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN914"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN912"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN913"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN915"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN914"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN915"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN914"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, update the entry */ 
</span>    <a href="../../include/utils/builtins.h.html#LN40"><span class='Ref_to_Proto'>namestrcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN917"><span class='Ref_To_Local'>newform</span></a><span class='Operator'>-&GT;</span>spcname<span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN909"><span class='Ref_to_Parameter'>newname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN912"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN916"><span class='Ref_To_Local'>newtuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN916"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN911"><span class='Ref_To_Local'>tspId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN918"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN911"><span class='Ref_To_Local'>tspId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN912"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablespace.c.html#LN918"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RenameTableSpace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Alter table space options 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN985"></a><span class='Declare_Function'>AlterTableSpaceOptions</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2117"><span class='Ref_to_Struct'>AlterTableSpaceOptionsStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN987"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN988"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN989"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scandesc</span><span class='Delimiter'>; 
</span><a name="LN990"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN991"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tablespaceoid</span><span class='Delimiter'>; 
</span><a name="LN992"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>datum</span><span class='Delimiter'>; 
</span><a name="LN993"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>newOptions</span><span class='Delimiter'>; 
</span><a name="LN994"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>repl_val</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN53"><span class='Ref_to_Const'>Natts_pg_tablespace</span></a><span class='Delimiter'>]; 
</span><a name="LN995"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN996"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>repl_null</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN53"><span class='Ref_to_Const'>Natts_pg_tablespace</span></a><span class='Delimiter'>]; 
</span><a name="LN997"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>repl_repl</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN53"><span class='Ref_to_Const'>Natts_pg_tablespace</span></a><span class='Delimiter'>]; 
</span><a name="LN998"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtuple</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search pg_tablespace */ 
</span>    <a href="tablespace.c.html#LN987"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablespace.c.html#LN988"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_tablespace.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_tablespace_spcname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN985"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2120"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN989"><span class='Ref_To_Local'>scandesc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN987"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN988"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN989"><span class='Ref_To_Local'>scandesc</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN985"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2120"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="tablespace.c.html#LN991"><span class='Ref_To_Local'>tablespaceoid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be owner of the existing object */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN315"><span class='Ref_to_Proto'>pg_tablespace_ownercheck</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, 
</span>                       <a href="tablespace.c.html#LN985"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2120"><span class='Ref_to_Member'>tablespacename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate new proposed spcoptions (text array) */ 
</span>    <a href="tablespace.c.html#LN992"><span class='Ref_To_Local'>datum</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_tablespace.h.html#LN57"><span class='Ref_to_Const'>Anum_pg_tablespace_spcoptions</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN987"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN995"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN993"><span class='Ref_To_Local'>newOptions</span></a> <span class='Operator'>= </span><a href="../../include/access/reloptions.h.html#LN257"><span class='Ref_to_Proto'>transformRelOptions</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN995"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>? </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span> <span class='Operator'>: </span><a href="tablespace.c.html#LN992"><span class='Ref_To_Local'>datum</span></a><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN985"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2121"><span class='Ref_to_Member'>options</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                     <a href="tablespace.c.html#LN985"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2122"><span class='Ref_to_Member'>isReset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/reloptions.h.html#LN279"><span class='Ref_to_Proto'>tablespace_reloptions</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN993"><span class='Ref_To_Local'>newOptions</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build new tuple. */ 
</span>    memset<span class='Parentheses'>(</span><a href="tablespace.c.html#LN996"><span class='Ref_To_Local'>repl_null</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN996"><span class='Ref_To_Local'>repl_null</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="tablespace.c.html#LN997"><span class='Ref_To_Local'>repl_repl</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN997"><span class='Ref_To_Local'>repl_repl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN993"><span class='Ref_To_Local'>newOptions</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="tablespace.c.html#LN994"><span class='Ref_To_Local'>repl_val</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN57"><span class='Ref_to_Const'>Anum_pg_tablespace_spcoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablespace.c.html#LN993"><span class='Ref_To_Local'>newOptions</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tablespace.c.html#LN996"><span class='Ref_To_Local'>repl_null</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN57"><span class='Ref_to_Const'>Anum_pg_tablespace_spcoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN997"><span class='Ref_To_Local'>repl_repl</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_tablespace.h.html#LN57"><span class='Ref_to_Const'>Anum_pg_tablespace_spcoptions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN998"><span class='Ref_To_Local'>newtuple</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN987"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN994"><span class='Ref_To_Local'>repl_val</span></a><span class='Delimiter'>, 
</span>                                 <a href="tablespace.c.html#LN996"><span class='Ref_To_Local'>repl_null</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN997"><span class='Ref_To_Local'>repl_repl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update system catalog. */ 
</span>    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN987"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN998"><span class='Ref_To_Local'>newtuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN998"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN990"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN998"><span class='Ref_To_Local'>newtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Conclude heap scan. */ 
</span>    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN989"><span class='Ref_To_Local'>scandesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN987"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablespace.c.html#LN991"><span class='Ref_To_Local'>tablespaceoid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AlterTableSpaceOptions &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Routines for handling the GUC variable 'default_tablespace'. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* check_hook: validate new default_tablespace */ 
</span><span class='Keyword'>bool 
</span><a name="LN1061"></a><span class='Declare_Function'>check_default_tablespace</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>extra</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN104"><span class='Ref_to_Typedef'>GucSource</span></a> <span class='Declare_Parameter'>source</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If we aren't inside a transaction, we cannot do database access so 
     * cannot verify the name.  Must accept the value on faith. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>**</span><a href="tablespace.c.html#LN1061"><span class='Ref_to_Parameter'>newval</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tablespace.c.html#LN1061"><span class='Ref_to_Parameter'>newval</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * When source == PGC_S_TEST, don't throw a hard error for a 
             * nonexistent tablespace, only a NOTICE.  See comments in guc.h. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1061"><span class='Ref_to_Parameter'>source</span></a> <span class='Operator'>== </span><a href="../../include/utils/guc.h.html#LN118"><span class='Ref_to_EnumConst'>PGC_S_TEST</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                                <span class='Operator'>*</span><a href="tablespace.c.html#LN1061"><span class='Ref_to_Parameter'>newval</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/guc.h.html#LN406"><span class='Ref_to_Const'>GUC_check_errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Tablespace \"%s\" does not exist."</span><span class='Delimiter'>, 
</span>                                    <span class='Operator'>*</span><a href="tablespace.c.html#LN1061"><span class='Ref_to_Parameter'>newval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if **newval!='\0'&&!OidI... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsTransactionState() &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_default_tablespace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetDefaultTablespace -- get the OID of the current default tablespace 
 * 
 * Temporary objects have different default tablespaces, hence the 
 * relpersistence parameter must be specified. 
 * 
 * May return InvalidOid to indicate "use the database's default tablespace". 
 * 
 * Note that caller is expected to check appropriate permissions for any 
 * result other than InvalidOid. 
 * 
 * This exists to hide (and possibly optimize the use of) the 
 * default_tablespace GUC variable. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1110"></a><span class='Declare_Function'>GetDefaultTablespace</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Declare_Parameter'>relpersistence</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1112"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The temp-table case is handled elsewhere */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1110"><span class='Ref_to_Parameter'>relpersistence</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/commands/tablespace.h.html#LN53"><span class='Ref_to_Proto'>PrepareTempTablespaces</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/storage/fd.h.html#LN108"><span class='Ref_to_Proto'>GetNextTempTableSpace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Fast path for default_tablespace == "" */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN87"><span class='Ref_to_Global_Var'>default_tablespace</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="tablespace.c.html#LN87"><span class='Ref_to_Global_Var'>default_tablespace</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It is tempting to cache this lookup for more speed, but then we would 
     * fail to detect the case where the tablespace was dropped since the GUC 
     * variable was set.  Note also that we don't complain if the value fails 
     * to refer to an existing tablespace; we just silently return InvalidOid, 
     * causing the new object to be created in the database's tablespace. 
     */ 
</span>    <a href="tablespace.c.html#LN1112"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN87"><span class='Ref_to_Global_Var'>default_tablespace</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow explicit specification of database's default tablespace in 
     * default_tablespace without triggering permissions checks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1112"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a><span class='Parentheses'>) 
</span>        <a href="tablespace.c.html#LN1112"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="tablespace.c.html#LN1112"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetDefaultTablespace &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Routines for handling the GUC variable 'temp_tablespaces'. 
 */ 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN1150"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>numSpcs</span><span class='Delimiter'>; 
</span><a name="LN1151"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>tblSpcs</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN1152"></a>} <span class='Declare_Typedef'>temp_tablespaces_extra</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* check_hook: validate new temp_tablespaces */ 
</span><span class='Keyword'>bool 
</span><a name="LN1156"></a><span class='Declare_Function'>check_temp_tablespaces</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>extra</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN104"><span class='Ref_to_Typedef'>GucSource</span></a> <span class='Declare_Parameter'>source</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1158"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rawname</span><span class='Delimiter'>; 
</span><a name="LN1159"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>namelist</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Need a modifiable copy of string */ 
</span>    <a href="tablespace.c.html#LN1158"><span class='Ref_To_Local'>rawname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="tablespace.c.html#LN1156"><span class='Ref_to_Parameter'>newval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse string into list of identifiers */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/varlena.h.html#LN29"><span class='Ref_to_Proto'>SplitIdentifierString</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1158"><span class='Ref_To_Local'>rawname</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN1159"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* syntax error in name list */ 
</span>        <a href="../../include/utils/guc.h.html#LN406"><span class='Ref_to_Const'>GUC_check_errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"List syntax is invalid."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1158"><span class='Ref_To_Local'>rawname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1159"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we aren't inside a transaction, we cannot do database access so 
     * cannot verify the individual names.  Must accept the list on faith. 
     * Fortunately, there's then also no need to pass the data to fd.c. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1181"></a>        <a href="tablespace.c.html#LN1148"><span class='Ref_to_Typedef'>temp_tablespaces_extra</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myextra</span><span class='Delimiter'>; 
</span><a name="LN1182"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>tblSpcs</span><span class='Delimiter'>; 
</span><a name="LN1183"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>numSpcs</span><span class='Delimiter'>; 
</span><a name="LN1184"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* temporary workspace until we are done verifying the list */ 
</span>        <a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1159"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1184"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1159"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1191"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1184"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1192"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>curoid</span><span class='Delimiter'>; 
</span><a name="LN1193"></a>            <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Allow an empty string (signifying database default) */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1191"><span class='Ref_To_Local'>curname</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>[</span><a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * In an interactive SET command, we ereport for bad info.  When 
             * source == PGC_S_TEST, don't throw a hard error for a 
             * nonexistent tablespace, only a NOTICE.  See comments in guc.h. 
             */ 
</span>            <a href="tablespace.c.html#LN1192"><span class='Ref_To_Local'>curoid</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1191"><span class='Ref_To_Local'>curname</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1156"><span class='Ref_to_Parameter'>source</span></a> <span class='Operator'>&LT;= </span><a href="../../include/utils/guc.h.html#LN118"><span class='Ref_to_EnumConst'>PGC_S_TEST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1192"><span class='Ref_To_Local'>curoid</span></a> <span class='Operator'>== </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1156"><span class='Ref_to_Parameter'>source</span></a> <span class='Operator'>== </span><a href="../../include/utils/guc.h.html#LN118"><span class='Ref_to_EnumConst'>PGC_S_TEST</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                                    <a href="tablespace.c.html#LN1191"><span class='Ref_To_Local'>curname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Allow explicit specification of database's default tablespace 
             * in temp_tablespaces without triggering permissions checks. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1192"><span class='Ref_To_Local'>curoid</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>[</span><a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Check permissions, similarly complaining only if interactive */ 
</span>            <a href="tablespace.c.html#LN1193"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN290"><span class='Ref_to_Proto'>pg_tablespace_aclcheck</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1192"><span class='Ref_To_Local'>curoid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                               <a href="../../include/nodes/parsenodes.h.html#LN81"><span class='Ref_to_Const'>ACL_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1193"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1156"><span class='Ref_to_Parameter'>source</span></a> <span class='Operator'>&GT;= </span><a href="../../include/utils/guc.h.html#LN117"><span class='Ref_to_EnumConst'>PGC_S_INTERACTIVE</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1193"><span class='Ref_To_Local'>aclresult</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN195"><span class='Ref_to_EnumConst'>ACL_KIND_TABLESPACE</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1191"><span class='Ref_To_Local'>curname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>[</span><a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablespace.c.html#LN1192"><span class='Ref_To_Local'>curoid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Now prepare an "extra" struct for assign_temp_tablespaces */ 
</span>        <a href="tablespace.c.html#LN1181"><span class='Ref_To_Local'>myextra</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1148"><span class='Ref_to_Typedef'>temp_tablespaces_extra</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                         <a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN1181"><span class='Ref_To_Local'>myextra</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="tablespace.c.html#LN1181"><span class='Ref_To_Local'>myextra</span></a><span class='Operator'>-&GT;</span><a href="tablespace.c.html#LN1150"><span class='Ref_to_Member'>numSpcs</span></a> <span class='Operator'>= </span><a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="tablespace.c.html#LN1181"><span class='Ref_To_Local'>myextra</span></a><span class='Operator'>-&GT;</span><a href="tablespace.c.html#LN1151"><span class='Ref_to_Member'>tblSpcs</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1183"><span class='Ref_To_Local'>numSpcs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="tablespace.c.html#LN1156"><span class='Ref_to_Parameter'>extra</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tablespace.c.html#LN1181"><span class='Ref_To_Local'>myextra</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1182"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsTransactionState() &raquo; </span> 
 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1158"><span class='Ref_To_Local'>rawname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1159"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_temp_tablespaces &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* assign_hook: do extra actions as needed */ 
</span><span class='Keyword'>void 
</span><a name="LN1261"></a><span class='Declare_Function'>assign_temp_tablespaces</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>extra</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1263"></a>    <a href="tablespace.c.html#LN1148"><span class='Ref_to_Typedef'>temp_tablespaces_extra</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myextra</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1148"><span class='Ref_to_Typedef'>temp_tablespaces_extra</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tablespace.c.html#LN1261"><span class='Ref_to_Parameter'>extra</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If check_temp_tablespaces was executed inside a transaction, then pass 
     * the list it made to fd.c.  Otherwise, clear fd.c's list; we must be 
     * still outside a transaction, or else restoring during transaction exit, 
     * and in either case we can just let the next PrepareTempTablespaces call 
     * make things sane. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1263"><span class='Ref_To_Local'>myextra</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/storage/fd.h.html#LN106"><span class='Ref_to_Proto'>SetTempTablespaces</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1263"><span class='Ref_To_Local'>myextra</span></a><span class='Operator'>-&GT;</span><a href="tablespace.c.html#LN1151"><span class='Ref_to_Member'>tblSpcs</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1263"><span class='Ref_To_Local'>myextra</span></a><span class='Operator'>-&GT;</span><a href="tablespace.c.html#LN1150"><span class='Ref_to_Member'>numSpcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/storage/fd.h.html#LN106"><span class='Ref_to_Proto'>SetTempTablespaces</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PrepareTempTablespaces -- prepare to use temp tablespaces 
 * 
 * If we have not already done so in the current transaction, parse the 
 * temp_tablespaces GUC variable and tell fd.c which tablespace(s) to use 
 * for temp files. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1286"></a><span class='Declare_Function'>PrepareTempTablespaces</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1288"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rawname</span><span class='Delimiter'>; 
</span><a name="LN1289"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>namelist</span><span class='Delimiter'>; 
</span><a name="LN1290"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>tblSpcs</span><span class='Delimiter'>; 
</span><a name="LN1291"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numSpcs</span><span class='Delimiter'>; 
</span><a name="LN1292"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No work if already done in current transaction */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN107"><span class='Ref_to_Proto'>TempTablespacesAreSet</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Can't do catalog access unless within a transaction.  This is just a 
     * safety check in case this function is called by low-level code that 
     * could conceivably execute outside a transaction.  Note that in such a 
     * scenario, fd.c will fall back to using the current database's default 
     * tablespace, which should always be OK. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Need a modifiable copy of string */ 
</span>    <a href="tablespace.c.html#LN1288"><span class='Ref_To_Local'>rawname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN88"><span class='Ref_to_Global_Var'>temp_tablespaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse string into list of identifiers */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/varlena.h.html#LN29"><span class='Ref_to_Proto'>SplitIdentifierString</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1288"><span class='Ref_To_Local'>rawname</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tablespace.c.html#LN1289"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* syntax error in name list */ 
</span>        <a href="../../include/storage/fd.h.html#LN106"><span class='Ref_to_Proto'>SetTempTablespaces</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1288"><span class='Ref_To_Local'>rawname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1289"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Store tablespace OIDs in an array in TopTransactionContext */ 
</span>    <a href="tablespace.c.html#LN1290"><span class='Ref_To_Local'>tblSpcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1289"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN1291"><span class='Ref_To_Local'>numSpcs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1292"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1289"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1327"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curname</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1292"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1328"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>curoid</span><span class='Delimiter'>; 
</span><a name="LN1329"></a>        <a href="../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Allow an empty string (signifying database default) */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1327"><span class='Ref_To_Local'>curname</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tablespace.c.html#LN1290"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>[</span><a href="tablespace.c.html#LN1291"><span class='Ref_To_Local'>numSpcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Else verify that name is a valid tablespace name */ 
</span>        <a href="tablespace.c.html#LN1328"><span class='Ref_To_Local'>curoid</span></a> <span class='Operator'>= </span><a href="../../include/commands/tablespace.h.html#LN55"><span class='Ref_to_Proto'>get_tablespace_oid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1327"><span class='Ref_To_Local'>curname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1328"><span class='Ref_To_Local'>curoid</span></a> <span class='Operator'>== </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Skip any bad list elements */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allow explicit specification of database's default tablespace in 
         * temp_tablespaces without triggering permissions checks. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1328"><span class='Ref_To_Local'>curoid</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tablespace.c.html#LN1290"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>[</span><a href="tablespace.c.html#LN1291"><span class='Ref_To_Local'>numSpcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Check permissions similarly */ 
</span>        <a href="tablespace.c.html#LN1329"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../include/utils/acl.h.html#LN290"><span class='Ref_to_Proto'>pg_tablespace_aclcheck</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1328"><span class='Ref_To_Local'>curoid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                           <a href="../../include/nodes/parsenodes.h.html#LN81"><span class='Ref_to_Const'>ACL_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1329"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="tablespace.c.html#LN1290"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>[</span><a href="tablespace.c.html#LN1291"><span class='Ref_To_Local'>numSpcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tablespace.c.html#LN1328"><span class='Ref_To_Local'>curoid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/storage/fd.h.html#LN106"><span class='Ref_to_Proto'>SetTempTablespaces</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1290"><span class='Ref_To_Local'>tblSpcs</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1291"><span class='Ref_To_Local'>numSpcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1288"><span class='Ref_To_Local'>rawname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1289"><span class='Ref_To_Local'>namelist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrepareTempTablespaces &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * get_tablespace_oid - given a tablespace name, look up the OID 
 * 
 * If missing_ok is false, throw an error if tablespace name not found.  If 
 * true, just return InvalidOid. 
 */ 
</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1379"></a><span class='Declare_Function'>get_tablespace_oid</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tablespacename</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1381"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1382"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1383"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scandesc</span><span class='Delimiter'>; 
</span><a name="LN1384"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1385"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Search pg_tablespace.  We use a heapscan here even though there is an 
     * index on name, on the theory that pg_tablespace will usually have just 
     * a few entries and so an indexed lookup is a waste of effort. 
     */ 
</span>    <a href="tablespace.c.html#LN1382"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablespace.c.html#LN1385"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/catalog/pg_tablespace.h.html#LN54"><span class='Ref_to_Const'>Anum_pg_tablespace_spcname</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_NAMEEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1379"><span class='Ref_to_Parameter'>tablespacename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN1383"><span class='Ref_To_Local'>scandesc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1382"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1385"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN1384"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1383"><span class='Ref_To_Local'>scandesc</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We assume that there can be at most one matching tuple */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1384"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="tablespace.c.html#LN1381"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1384"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tablespace.c.html#LN1381"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1383"><span class='Ref_To_Local'>scandesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1382"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1381"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="tablespace.c.html#LN1379"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespace \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN1379"><span class='Ref_to_Parameter'>tablespacename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablespace.c.html#LN1381"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_tablespace_oid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_tablespace_name - given a tablespace OID, look up the name 
 * 
 * Returns a palloc'd string, or NULL if no such tablespace. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1425"></a><span class='Declare_Function'>get_tablespace_name</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>spc_oid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1427"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1428"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1429"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scandesc</span><span class='Delimiter'>; 
</span><a name="LN1430"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1431"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>entry</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Search pg_tablespace.  We use a heapscan here even though there is an 
     * index on oid, on the theory that pg_tablespace will usually have just a 
     * few entries and so an indexed lookup is a waste of effort. 
     */ 
</span>    <a href="tablespace.c.html#LN1428"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_tablespace.h.html#LN28"><span class='Ref_to_Const'>TableSpaceRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tablespace.c.html#LN1431"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1425"><span class='Ref_to_Parameter'>spc_oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN1429"><span class='Ref_To_Local'>scandesc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1428"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1431"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tablespace.c.html#LN1430"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1429"><span class='Ref_To_Local'>scandesc</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We assume that there can be at most one matching tuple */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1430"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="tablespace.c.html#LN1427"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(((</span><a href="../../include/catalog/pg_tablespace.h.html#LN46"><span class='Ref_to_Typedef'>Form_pg_tablespace</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1430"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>spcname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="tablespace.c.html#LN1427"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1429"><span class='Ref_To_Local'>scandesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1428"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tablespace.c.html#LN1427"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_tablespace_name &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * TABLESPACE resource manager's routines 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1464"></a><span class='Declare_Function'>tblspc_redo</span><span class='Parentheses'>(</span><a href="../../include/access/xlogreader.h.html#LN68"><span class='Ref_to_Struct'>XLogReaderState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>record</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1466"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>info</span> <span class='Operator'>= </span><a href="../../include/access/xlogreader.h.html#LN215"><span class='Ref_to_Macro'>XLogRecGetInfo</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1464"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>) </span><span class='Operator'>& ~</span><a href="../../include/access/xlogrecord.h.html#LN61"><span class='Ref_to_Const'>XLR_INFO_MASK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Backup blocks are not used in tblspc records */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/xlogreader.h.html#LN221"><span class='Ref_to_Macro'>XLogRecHasAnyBlockRefs</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1464"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1466"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../include/commands/tablespace.h.html#LN22"><span class='Ref_to_Const'>XLOG_TBLSPC_CREATE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1473"></a>        <a href="../../include/commands/tablespace.h.html#LN25"><span class='Ref_to_Struct'>xl_tblspc_create_rec</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/tablespace.h.html#LN25"><span class='Ref_to_Struct'>xl_tblspc_create_rec</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1464"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1474"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>location</span> <span class='Operator'>= </span><a href="tablespace.c.html#LN1473"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/tablespace.h.html#LN28"><span class='Ref_to_Member'>ts_path</span></a><span class='Delimiter'>; 
</span> 
        <a href="tablespace.c.html#LN91"><span class='Ref_to_Proto'>create_tablespace_directories</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1474"><span class='Ref_To_Local'>location</span></a><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1473"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/tablespace.h.html#LN27"><span class='Ref_to_Member'>ts_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tablespace.c.html#LN1466"><span class='Ref_To_Local'>info</span></a> <span class='Operator'>== </span><a href="../../include/commands/tablespace.h.html#LN23"><span class='Ref_to_Const'>XLOG_TBLSPC_DROP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1480"></a>        <a href="../../include/commands/tablespace.h.html#LN31"><span class='Ref_to_Struct'>xl_tblspc_drop_rec</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xlrec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/commands/tablespace.h.html#LN31"><span class='Ref_to_Struct'>xl_tblspc_drop_rec</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/access/xlogreader.h.html#LN219"><span class='Ref_to_Macro'>XLogRecGetData</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1464"><span class='Ref_to_Parameter'>record</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we issued a WAL record for a drop tablespace it implies that 
         * there were no files in it at all when the DROP was done. That means 
         * that no permanent objects can exist in it at this point. 
         * 
         * It is possible for standby users to be using this tablespace as a 
         * location for their temporary files, so if we fail to remove all 
         * files then do conflict processing and try again, if currently 
         * enabled. 
         * 
         * Other possible reasons for failure include bollixed file 
         * permissions on a standby server when they were okay on the primary, 
         * etc etc. There's not much we can do about that, so just remove what 
         * we can and press on. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN93"><span class='Ref_to_Proto'>destroy_tablespace_directories</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1480"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/tablespace.h.html#LN33"><span class='Ref_to_Member'>ts_id</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/standby.h.html#LN31"><span class='Ref_to_Proto'>ResolveRecoveryConflictWithTablespace</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1480"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/tablespace.h.html#LN33"><span class='Ref_to_Member'>ts_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we did recovery processing then hopefully the backends who 
             * wrote temp files should have cleaned up and exited by now.  So 
             * retry before complaining.  If we fail again, this is just a LOG 
             * condition, because it's not worth throwing an ERROR for (as 
             * that would crash the database and require manual intervention 
             * before we could get past this WAL record on restart). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tablespace.c.html#LN93"><span class='Ref_to_Proto'>destroy_tablespace_directories</span></a><span class='Parentheses'>(</span><a href="tablespace.c.html#LN1480"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/tablespace.h.html#LN33"><span class='Ref_to_Member'>ts_id</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"directories for tablespace %u could not be removed"</span><span class='Delimiter'>, 
</span>                        <a href="tablespace.c.html#LN1480"><span class='Ref_To_Local'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/tablespace.h.html#LN33"><span class='Ref_to_Member'>ts_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You can remove the directories manually if necessary."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info==XLOG_TBLSPC_DRO... &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"tblspc_redo: unknown op code %u"</span><span class='Delimiter'>, </span><a href="tablespace.c.html#LN1466"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tblspc_redo &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>