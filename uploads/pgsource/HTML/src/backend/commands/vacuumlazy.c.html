<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\commands\vacuumlazy.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\commands\vacuumlazy.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:38 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * vacuumlazy.c 
 *    Concurrent ("lazy") vacuuming. 
 * 
 * 
 * The major space usage for LAZY VACUUM is storage for the array of dead 
 * tuple TIDs, with the next biggest need being storage for per-disk-page 
 * free space info.  We want to ensure we can vacuum even the very largest 
 * relations with finite memory space usage.  To do that, we set upper bounds 
 * on the number of tuples and pages we will keep track of at once. 
 * 
 * We are willing to use at most maintenance_work_mem (or perhaps 
 * autovacuum_work_mem) memory space to keep track of dead tuples.  We 
 * initially allocate an array of TIDs of that size, with an upper limit that 
 * depends on table size (this limit ensures we don't allocate a huge area 
 * uselessly for vacuuming small tables).  If the array threatens to overflow, 
 * we suspend the heap scan phase and perform a pass of index cleanup and page 
 * compaction, then resume the heap scan with an empty TID array. 
 * 
 * If we're processing a table with no indexes, we can just vacuum each page 
 * as we go; there's no need to save up multiple tuples to minimize the number 
 * of index scans performed.  So we don't use maintenance_work_mem memory for 
 * the TID array, just enough to hold as many heap tuples as fit on one page. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/commands/vacuumlazy.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/visibilitymap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/storage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/progress.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/vacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"portability/instr_time.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/freespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/pg_rusage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Space/time tradeoff parameters: do these need to be user-tunable? 
 * 
 * To consider truncating the relation, we want there to be at least 
 * REL_TRUNCATE_MINIMUM or (relsize / REL_TRUNCATE_FRACTION) (whichever 
 * is less) potentially-freeable pages. 
 */ 
</span><a name="LN73"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>REL_TRUNCATE_MINIMUM</span>    <span class='Number'>1000</span> 
<a name="LN74"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>REL_TRUNCATE_FRACTION</span>   <span class='Number'>16</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Timing parameters for truncate locking heuristics. 
 * 
 * These were not exposed as user tunable GUC values because it didn't seem 
 * that the potential for improvement was great enough to merit the cost of 
 * supporting them. 
 */ 
</span><a name="LN83"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>VACUUM_TRUNCATE_LOCK_CHECK_INTERVAL</span>     <span class='Number'>20</span>      <span class='Comment_Single_Line'>/* ms */ 
</span><a name="LN84"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>VACUUM_TRUNCATE_LOCK_WAIT_INTERVAL</span>      <span class='Number'>50</span>      <span class='Comment_Single_Line'>/* ms */ 
</span><a name="LN85"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>VACUUM_TRUNCATE_LOCK_TIMEOUT</span>            <span class='Number'>5000</span>    <span class='Comment_Single_Line'>/* ms */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Guesstimation of number of dead tuples per page.  This is used to 
 * provide an upper limit to memory allocated when vacuuming small 
 * tables. 
 */ 
</span><a name="LN92"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>LAZY_ALLOC_TUPLES</span>       <a href="../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * Before we consider skipping a page that's marked as clean in 
 * visibility map, we must've seen at least this many clean pages. 
 */ 
</span><a name="LN98"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SKIP_PAGES_THRESHOLD</span>    <span class='Parentheses'>((</span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><span class='Number'>32</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Size of the prefetch window for lazy vacuum backwards truncation scan. 
 * Needs to be a power of 2. 
 */ 
</span><a name="LN104"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PREFETCH_SIZE</span>           <span class='Parentheses'>((</span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><span class='Number'>32</span><span class='Parentheses'>)</span> 
 
<a name="LN106"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>LVRelStats</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* hasindex = true means two-pass strategy; false means one-pass */ 
</span><a name="LN109"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>hasindex</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Overall statistics about rel */ 
</span><a name="LN111"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>old_rel_pages</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* previous value of pg_class.relpages */ 
</span><a name="LN112"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>rel_pages</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* total number of pages */ 
</span><a name="LN113"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>scanned_pages</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* number of pages we examined */ 
</span><a name="LN114"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>pinskipped_pages</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* # of pages we skipped due to a pin */ 
</span><a name="LN115"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>frozenskipped_pages</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* # of frozen pages we skipped */ 
</span><a name="LN116"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>tupcount_pages</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* pages whose tuples we counted */ 
</span><a name="LN117"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>scanned_tuples</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* counts only tuples on tupcount_pages */ 
</span><a name="LN118"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>old_rel_tuples</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* previous value of pg_class.reltuples */ 
</span><a name="LN119"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>new_rel_tuples</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* new estimated total # of tuples */ 
</span><a name="LN120"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>new_dead_tuples</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* new estimated total # of dead tuples */ 
</span><a name="LN121"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>pages_removed</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>tuples_deleted</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>nonempty_pages</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* actually, last nonempty page + 1 */ 
</span>    <span class='Comment_Multi_Line'>/* List of TIDs of tuples we intend to delete */ 
</span>    <span class='Comment_Multi_Line'>/* NB: this list is ordered by TID address */ 
</span><a name="LN126"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>num_dead_tuples</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* current # of entries */ 
</span><a name="LN127"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>max_dead_tuples</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* # slots allocated in array */ 
</span><a name="LN128"></a>    <a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Member'>dead_tuples</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* array of ItemPointerData */ 
</span><a name="LN129"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>num_index_scans</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>latestRemovedXid</span><span class='Delimiter'>; 
</span><a name="LN131"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>lock_waiter_detected</span><span class='Delimiter'>; 
</span><a name="LN132"></a>}<span class='Auto_Annotations'> &laquo; end LVRelStats &raquo; </span> <span class='Declare_Typedef'>LVRelStats</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* A few variables that don't seem worth passing around as parameters */ 
</span><a name="LN136"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>elevel</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<a name="LN138"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>OldestXmin</span><span class='Delimiter'>; 
</span><a name="LN139"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>FreezeLimit</span><span class='Delimiter'>; 
</span><a name="LN140"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Var'>MultiXactCutoff</span><span class='Delimiter'>; 
</span> 
<a name="LN142"></a><span class='Keyword'>static </span><a href="../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Var'>vac_strategy</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* non-export function prototypes */ 
</span><a name="LN146"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_scan_heap</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, 
</span><a name="LN147"></a>               <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>Irel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nindexes</span><span class='Delimiter'>, 
</span><a name="LN148"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>aggressive</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN149"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_vacuum_heap</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN150"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>lazy_check_needs_freeze</span><span class='Parentheses'>(</span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>hastup</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN151"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_vacuum_index</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>indrel</span><span class='Delimiter'>, 
</span><a name="LN152"></a>                  <a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>stats</span><span class='Delimiter'>, 
</span><a name="LN153"></a>                  <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN154"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_cleanup_index</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>indrel</span><span class='Delimiter'>, 
</span><a name="LN155"></a>                   <a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Delimiter'>, 
</span><a name="LN156"></a>                   <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN157"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>lazy_vacuum_page</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN158"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>tupindex</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vmbuffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN159"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>should_attempt_truncation</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN160"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_truncate_heap</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN161"></a><span class='Keyword'>static </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Prototype'>count_nondeletable_pages</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, 
</span><a name="LN162"></a>                         <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN163"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_space_alloc</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>relblocks</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN164"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>lazy_record_dead_tuple</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, 
</span><a name="LN165"></a>                       <a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>itemptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN166"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>lazy_tid_reaped</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>itemptr</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN167"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>vac_cmp_itemptr</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>left</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>right</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN168"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>heap_page_is_all_visible</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN169"></a>                     <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>visibility_cutoff_xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>all_frozen</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  lazy_vacuum_rel() -- perform LAZY VACUUM for one heap relation 
 * 
 *      This routine vacuums a single heap, cleans out its indexes, and 
 *      updates its relpages and reltuples statistics. 
 * 
 *      At entry, we have already established a transaction and opened 
 *      and locked the relation. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN182"></a><span class='Declare_Function'>lazy_vacuum_rel</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><a href="../../include/commands/vacuum.h.html#LN135"><span class='Ref_to_Struct'>VacuumParams</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>params</span><span class='Delimiter'>, 
</span><a name="LN183"></a>                <a href="../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN185"></a>    <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vacrelstats</span><span class='Delimiter'>; 
</span><a name="LN186"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>Irel</span><span class='Delimiter'>; 
</span><a name="LN187"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nindexes</span><span class='Delimiter'>; 
</span><a name="LN188"></a>    <a href="../../include/utils/pg_rusage.h.html#LN26"><span class='Ref_to_Struct'>PGRUsage</span></a>    <span class='Declare_Local'>ru0</span><span class='Delimiter'>; 
</span><a name="LN189"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>starttime</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN190"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>secs</span><span class='Delimiter'>; 
</span><a name="LN191"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>usecs</span><span class='Delimiter'>; 
</span><a name="LN192"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>read_rate</span><span class='Delimiter'>, 
</span><a name="LN193"></a>                <span class='Declare_Local'>write_rate</span><span class='Delimiter'>; 
</span><a name="LN194"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>aggressive</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* should we scan all unfrozen pages? */ 
</span><a name="LN195"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>scanned_all_unfrozen</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* actually scanned all such pages? */ 
</span><a name="LN196"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xidFullScanLimit</span><span class='Delimiter'>; 
</span><a name="LN197"></a>    <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>mxactFullScanLimit</span><span class='Delimiter'>; 
</span><a name="LN198"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>new_rel_pages</span><span class='Delimiter'>; 
</span><a name="LN199"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>new_rel_tuples</span><span class='Delimiter'>; 
</span><a name="LN200"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>new_rel_allvisible</span><span class='Delimiter'>; 
</span><a name="LN201"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>new_live_tuples</span><span class='Delimiter'>; 
</span><a name="LN202"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>new_frozen_xid</span><span class='Delimiter'>; 
</span><a name="LN203"></a>    <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>new_min_multi</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* measure elapsed time iff autovacuum logging requires it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN144"><span class='Ref_to_Member'>log_min_duration</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../utils/misc/pg_rusage.c.html#LN25"><span class='Ref_to_Func'>pg_rusage_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN188"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN189"><span class='Ref_To_Local'>starttime</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3064"><span class='Ref_to_EnumConst'>VACOPT_VERBOSE</span></a><span class='Parentheses'>) 
</span>        <a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN32"><span class='Ref_to_Const'>INFO</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1179"><span class='Ref_to_Proto'>pgstat_progress_start_command</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN914"><span class='Ref_to_EnumConst'>PROGRESS_COMMAND_VACUUM</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="vacuum.c.html#LN65"><span class='Ref_to_Global_Var'>vac_strategy</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN183"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/commands/vacuum.h.html#LN178"><span class='Ref_to_Proto'>vacuum_set_xid_limits</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, 
</span>                          <a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN137"><span class='Ref_to_Member'>freeze_min_age</span></a><span class='Delimiter'>, 
</span>                          <a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN138"><span class='Ref_to_Member'>freeze_table_age</span></a><span class='Delimiter'>, 
</span>                          <a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN139"><span class='Ref_to_Member'>multixact_freeze_min_age</span></a><span class='Delimiter'>, 
</span>                          <a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN141"><span class='Ref_to_Member'>multixact_freeze_table_age</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN139"><span class='Ref_to_Global_Var'>FreezeLimit</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN196"><span class='Ref_To_Local'>xidFullScanLimit</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN140"><span class='Ref_to_Global_Var'>MultiXactCutoff</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN197"><span class='Ref_To_Local'>mxactFullScanLimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We request an aggressive scan if the table's frozen Xid is now older 
     * than or equal to the requested Xid full-table scan limit; or if the 
     * table's minimum MultiXactId is older than or equal to the requested 
     * mxid full-table scan limit; or if DISABLE_PAGE_SKIPPING was specified. 
     */ 
</span>    <a href="vacuumlazy.c.html#LN194"><span class='Ref_To_Local'>aggressive</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN169"><span class='Ref_to_Proto'>TransactionIdPrecedesOrEquals</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relfrozenxid<span class='Delimiter'>, 
</span>                                               <a href="vacuumlazy.c.html#LN196"><span class='Ref_To_Local'>xidFullScanLimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN194"><span class='Ref_To_Local'>aggressive</span></a> <span class='Operator'>|= </span><a href="../../include/access/multixact.h.html#LN115"><span class='Ref_to_Proto'>MultiXactIdPrecedesOrEquals</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relminmxid<span class='Delimiter'>, 
</span>                                              <a href="vacuumlazy.c.html#LN197"><span class='Ref_To_Local'>mxactFullScanLimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3069"><span class='Ref_to_EnumConst'>VACOPT_DISABLE_PAGE_SKIPPING</span></a><span class='Parentheses'>) 
</span>        <a href="vacuumlazy.c.html#LN194"><span class='Ref_To_Local'>aggressive</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN111"><span class='Ref_to_Member'>old_rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relpages<span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN118"><span class='Ref_to_Member'>old_rel_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltuples<span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN129"><span class='Ref_to_Member'>num_index_scans</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN121"><span class='Ref_to_Member'>pages_removed</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN131"><span class='Ref_to_Member'>lock_waiter_detected</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open all indexes of the relation */ 
</span>    <a href="../../include/commands/vacuum.h.html#LN163"><span class='Ref_to_Proto'>vac_open_indexes</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN187"><span class='Ref_To_Local'>nindexes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN186"><span class='Ref_To_Local'>Irel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN109"><span class='Ref_to_Member'>hasindex</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN187"><span class='Ref_To_Local'>nindexes</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do the vacuuming */ 
</span>    <a href="vacuumlazy.c.html#LN146"><span class='Ref_to_Proto'>lazy_scan_heap</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>options</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN186"><span class='Ref_To_Local'>Irel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN187"><span class='Ref_To_Local'>nindexes</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN194"><span class='Ref_To_Local'>aggressive</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Done with indexes */ 
</span>    <a href="../../include/commands/vacuum.h.html#LN165"><span class='Ref_to_Proto'>vac_close_indexes</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN187"><span class='Ref_To_Local'>nindexes</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN186"><span class='Ref_To_Local'>Irel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute whether we actually scanned the all unfrozen pages. If we did, 
     * we can adjust relfrozenxid and relminmxid. 
     * 
     * NB: We need to check this before truncating the relation, because that 
     * will change -&GT;rel_pages. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN113"><span class='Ref_to_Member'>scanned_pages</span></a> <span class='Operator'>+ </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN115"><span class='Ref_to_Member'>frozenskipped_pages</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN194"><span class='Ref_To_Local'>aggressive</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN195"><span class='Ref_To_Local'>scanned_all_unfrozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="vacuumlazy.c.html#LN195"><span class='Ref_To_Local'>scanned_all_unfrozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Optionally truncate the relation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN159"><span class='Ref_to_Proto'>should_attempt_truncation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Parentheses'>))</span> 
        <a href="vacuumlazy.c.html#LN160"><span class='Ref_to_Proto'>lazy_truncate_heap</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report that we are now doing final cleanup */ 
</span>    <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/commands/progress.h.html#LN34"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_FINAL_CLEANUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Vacuum the Free Space Map */ 
</span>    <a href="../../include/storage/freespace.h.html#LN33"><span class='Ref_to_Proto'>FreeSpaceMapVacuum</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update statistics in pg_class. 
     * 
     * A corner case here is that if we scanned no pages at all because every 
     * page is all-visible, we should not update relpages/reltuples, because 
     * we have no new information to contribute.  In particular this keeps us 
     * from replacing relpages=reltuples=0 (which means "unknown tuple 
     * density") with nonzero relpages and reltuples=0 (which means "zero 
     * tuple density") unless there's some actual evidence for the latter. 
     * 
     * It's important that we use tupcount_pages and not scanned_pages for the 
     * check described above; scanned_pages counts pages where we could not 
     * get cleanup lock, and which were processed only for frozenxid purposes. 
     * 
     * We do update relallvisible even in the corner case, since if the table 
     * is all-visible we'd definitely like to know that.  But clamp the value 
     * to be not more than what we're setting relpages to. 
     * 
     * Also, don't change relfrozenxid/relminmxid if we skipped any pages, 
     * since then we don't know for certain that all tuples have a newer xmin. 
     */ 
</span>    <a href="vacuumlazy.c.html#LN198"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN199"><span class='Ref_To_Local'>new_rel_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN119"><span class='Ref_to_Member'>new_rel_tuples</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN116"><span class='Ref_to_Member'>tupcount_pages</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN198"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="vacuumlazy.c.html#LN198"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN111"><span class='Ref_to_Member'>old_rel_pages</span></a><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN199"><span class='Ref_To_Local'>new_rel_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN118"><span class='Ref_to_Member'>old_rel_tuples</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/access/visibilitymap.h.html#LN45"><span class='Ref_to_Proto'>visibilitymap_count</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN200"><span class='Ref_To_Local'>new_rel_allvisible</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN200"><span class='Ref_To_Local'>new_rel_allvisible</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN198"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Parentheses'>) 
</span>        <a href="vacuumlazy.c.html#LN200"><span class='Ref_To_Local'>new_rel_allvisible</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN198"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN202"><span class='Ref_To_Local'>new_frozen_xid</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN195"><span class='Ref_To_Local'>scanned_all_unfrozen</span></a> <span class='Operator'>? </span><a href="vacuumlazy.c.html#LN139"><span class='Ref_to_Global_Var'>FreezeLimit</span></a> <span class='Operator'>: </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN203"><span class='Ref_To_Local'>new_min_multi</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN195"><span class='Ref_To_Local'>scanned_all_unfrozen</span></a> <span class='Operator'>? </span><a href="vacuumlazy.c.html#LN140"><span class='Ref_to_Global_Var'>MultiXactCutoff</span></a> <span class='Operator'>: </span><a href="../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/commands/vacuum.h.html#LN170"><span class='Ref_to_Proto'>vac_update_relstats</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN198"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN199"><span class='Ref_To_Local'>new_rel_tuples</span></a><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN200"><span class='Ref_To_Local'>new_rel_allvisible</span></a><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN109"><span class='Ref_to_Member'>hasindex</span></a><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN202"><span class='Ref_To_Local'>new_frozen_xid</span></a><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN203"><span class='Ref_To_Local'>new_min_multi</span></a><span class='Delimiter'>, 
</span>                        <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* report results to the stats collector, too */ 
</span>    <a href="vacuumlazy.c.html#LN201"><span class='Ref_To_Local'>new_live_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN199"><span class='Ref_To_Local'>new_rel_tuples</span></a> <span class='Operator'>- </span><a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN120"><span class='Ref_to_Member'>new_dead_tuples</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN201"><span class='Ref_To_Local'>new_live_tuples</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="vacuumlazy.c.html#LN201"><span class='Ref_To_Local'>new_live_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* just in case */ 
</span> 
    <a href="../../include/pgstat.h.html#LN1156"><span class='Ref_to_Proto'>pgstat_report_vacuum</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Delimiter'>, 
</span>                         <a href="vacuumlazy.c.html#LN201"><span class='Ref_To_Local'>new_live_tuples</span></a><span class='Delimiter'>, 
</span>                         <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN120"><span class='Ref_to_Member'>new_dead_tuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1184"><span class='Ref_to_Proto'>pgstat_progress_end_command</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and log the action if appropriate */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN144"><span class='Ref_to_Member'>log_min_duration</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN351"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>endtime</span> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN144"><span class='Ref_to_Member'>log_min_duration</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN189"><span class='Ref_To_Local'>starttime</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN351"><span class='Ref_To_Local'>endtime</span></a><span class='Delimiter'>, 
</span>                                       <a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>params</span></a><span class='Operator'>-&GT;</span><a href="../../include/commands/vacuum.h.html#LN144"><span class='Ref_to_Member'>log_min_duration</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN357"></a>            <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/timestamp.h.html#LN72"><span class='Ref_to_Proto'>TimestampDifference</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN189"><span class='Ref_To_Local'>starttime</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN351"><span class='Ref_To_Local'>endtime</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN190"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN191"><span class='Ref_To_Local'>usecs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN192"><span class='Ref_To_Local'>read_rate</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN193"><span class='Ref_To_Local'>write_rate</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN190"><span class='Ref_To_Local'>secs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN191"><span class='Ref_To_Local'>usecs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="vacuumlazy.c.html#LN192"><span class='Ref_To_Local'>read_rate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><a href="../utils/init/globals.c.html#LN135"><span class='Ref_to_Global_Var'>VacuumPageMiss</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Number'>1024</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>) </span><span class='Operator'>/ 
</span>                            <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN190"><span class='Ref_To_Local'>secs</span></a> <span class='Operator'>+ </span><a href="vacuumlazy.c.html#LN191"><span class='Ref_To_Local'>usecs</span></a> <span class='Operator'>/ </span><span class='Number'>1000000</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN193"><span class='Ref_To_Local'>write_rate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><a href="../utils/init/globals.c.html#LN136"><span class='Ref_to_Global_Var'>VacuumPageDirty</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Number'>1024</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>) </span><span class='Operator'>/ 
</span>                            <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN190"><span class='Ref_To_Local'>secs</span></a> <span class='Operator'>+ </span><a href="vacuumlazy.c.html#LN191"><span class='Ref_To_Local'>usecs</span></a> <span class='Operator'>/ </span><span class='Number'>1000000</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * This is pretty messy, but we split it up so that we can skip 
             * emitting individual parts of the message when not applicable. 
             */ 
</span>            <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"automatic vacuum of table \"%s.%s.%s\": index scans: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                             <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN182"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN129"><span class='Ref_to_Member'>num_index_scans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"pages: %u removed, %u remain, %u skipped due to pins, %u skipped frozen\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN121"><span class='Ref_to_Member'>pages_removed</span></a><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN114"><span class='Ref_to_Member'>pinskipped_pages</span></a><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN115"><span class='Ref_to_Member'>frozenskipped_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"tuples: %.0f removed, %.0f remain, %.0f are dead but not yet removable, oldest xmin: %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN122"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN119"><span class='Ref_to_Member'>new_rel_tuples</span></a><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN185"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN120"><span class='Ref_to_Member'>new_dead_tuples</span></a><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>                         _<span class='Parentheses'>(</span><span class='String'>"buffer usage: %d hits, %d misses, %d dirtied\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/init/globals.c.html#LN134"><span class='Ref_to_Global_Var'>VacuumPageHit</span></a><span class='Delimiter'>, 
</span>                             <a href="../utils/init/globals.c.html#LN135"><span class='Ref_to_Global_Var'>VacuumPageMiss</span></a><span class='Delimiter'>, 
</span>                             <a href="../utils/init/globals.c.html#LN136"><span class='Ref_to_Global_Var'>VacuumPageDirty</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"avg read rate: %.3f MB/s, avg write rate: %.3f MB/s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN192"><span class='Ref_To_Local'>read_rate</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN193"><span class='Ref_To_Local'>write_rate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"system usage: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/utils/pg_rusage.h.html#LN34"><span class='Ref_to_Proto'>pg_rusage_show</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN188"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN357"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if params-&GT;log_min_durat... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsAutoVacuumWorkerPro... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end lazy_vacuum_rel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * For Hot Standby we need to know the highest transaction id that will 
 * be removed by any change. VACUUM proceeds in a number of passes so 
 * we need to consider how each pass operates. The first phase runs 
 * heap_page_prune(), which can issue XLOG_HEAP2_CLEAN records as it 
 * progresses - these will have a latestRemovedXid on each record. 
 * In some cases this removes all of the tuples to be removed, though 
 * often we have dead tuples with index pointers so we must remember them 
 * for removal in phase 3. Index records for those rows are removed 
 * in phase 2 and index blocks do not have MVCC information attached. 
 * So before we can allow removal of any index tuples we need to issue 
 * a WAL record containing the latestRemovedXid of rows that will be 
 * removed in phase three. This allows recovery queries to block at the 
 * correct place, i.e. before phase two, rather than during phase three 
 * which would be after the rows have become inaccessible. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN425"></a><span class='Declare_Function'>vacuum_log_cleanup_info</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Skip this for relations for which no WAL is to be written, or if we're 
     * not trying to support archive recovery. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN425"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>) </span><span class='Operator'>|| !</span><a href="../../include/access/xlog.h.html#LN144"><span class='Ref_to_Macro'>XLogIsNeeded</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need to write the record at all unless it contains a valid value 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN425"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN130"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Parentheses'>))</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/access/heapam_xlog.h.html#LN381"><span class='Ref_to_Proto'>log_heap_cleanup_info</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN425"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN84"><span class='Ref_to_Member'>rd_node</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN425"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN130"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  lazy_scan_heap() -- scan an open heap relation 
 * 
 *      This routine prunes each page in the heap, which will among other 
 *      things truncate dead tuples to dead line pointers, defragment the 
 *      page, and set commit status bits (see heap_page_prune).  It also builds 
 *      lists of dead tuples and pages with free space, calculates statistics 
 *      on the number of live tuples in the heap, and marks pages as 
 *      all-visible if appropriate.  When done, or when we run low on space for 
 *      dead-tuple TIDs, invoke vacuuming of indexes and call lazy_vacuum_heap 
 *      to reclaim dead line pointers. 
 * 
 *      If there are no indexes then we can reclaim line pointers on the fly; 
 *      dead line pointers need only be retained until all index pointers that 
 *      reference them have been killed. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN458"></a><span class='Declare_Function'>lazy_scan_heap</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, 
</span><a name="LN459"></a>               <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>Irel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nindexes</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>aggressive</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN461"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblocks</span><span class='Delimiter'>, 
</span><a name="LN462"></a>                <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN463"></a>    <a href="../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN464"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>relname</span><span class='Delimiter'>; 
</span><a name="LN465"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>empty_pages</span><span class='Delimiter'>, 
</span><a name="LN466"></a>                <span class='Declare_Local'>vacuumed_pages</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>num_tuples</span><span class='Delimiter'>, 
</span><a name="LN468"></a>                <span class='Declare_Local'>tups_vacuumed</span><span class='Delimiter'>, 
</span><a name="LN469"></a>                <span class='Declare_Local'>nkeep</span><span class='Delimiter'>, 
</span><a name="LN470"></a>                <span class='Declare_Local'>nunused</span><span class='Delimiter'>; 
</span><a name="LN471"></a>    <a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>**</span><span class='Declare_Local'>indstats</span><span class='Delimiter'>; 
</span><a name="LN472"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN473"></a>    <a href="../../include/utils/pg_rusage.h.html#LN26"><span class='Ref_to_Struct'>PGRUsage</span></a>    <span class='Declare_Local'>ru0</span><span class='Delimiter'>; 
</span><a name="LN474"></a>    <a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span><a name="LN475"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>next_unskippable_block</span><span class='Delimiter'>; 
</span><a name="LN476"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>skipping_blocks</span><span class='Delimiter'>; 
</span><a name="LN477"></a>    <a href="../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a> <span class='Operator'>*</span><span class='Declare_Local'>frozen</span><span class='Delimiter'>; 
</span><a name="LN478"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN479"></a>    <span class='Keyword'>const int</span>   <span class='Declare_Local'>initprog_index</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>        <a href="../../include/commands/progress.h.html#LN21"><span class='Ref_to_Const'>PROGRESS_VACUUM_TOTAL_HEAP_BLKS</span></a><span class='Delimiter'>, 
</span>        <a href="../../include/commands/progress.h.html#LN25"><span class='Ref_to_Const'>PROGRESS_VACUUM_MAX_DEAD_TUPLES</span></a> 
    <span class='Delimiter'>}; 
</span><a name="LN484"></a>    <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>initprog_val</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span> 
    <a href="../utils/misc/pg_rusage.c.html#LN25"><span class='Ref_to_Func'>pg_rusage_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN473"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN464"><span class='Ref_To_Local'>relname</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"vacuuming \"%s.%s\""</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN464"><span class='Ref_To_Local'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN465"><span class='Ref_To_Local'>empty_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN466"><span class='Ref_To_Local'>vacuumed_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN467"><span class='Ref_To_Local'>num_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN468"><span class='Ref_To_Local'>tups_vacuumed</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN469"><span class='Ref_To_Local'>nkeep</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN470"><span class='Ref_To_Local'>nunused</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN471"><span class='Ref_To_Local'>indstats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>nindexes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN113"><span class='Ref_to_Member'>scanned_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN116"><span class='Ref_to_Member'>tupcount_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN130"><span class='Ref_to_Member'>latestRemovedXid</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN163"><span class='Ref_to_Proto'>lazy_space_alloc</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/access/heapam_xlog.h.html#LN295"><span class='Ref_to_Struct'>xl_heap_freeze_tuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report that we're scanning the heap, advertising total # of blocks */ 
</span>    <a href="vacuumlazy.c.html#LN484"><span class='Ref_To_Local'>initprog_val</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/commands/progress.h.html#LN29"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_SCAN_HEAP</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN484"><span class='Ref_To_Local'>initprog_val</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN484"><span class='Ref_To_Local'>initprog_val</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN127"><span class='Ref_to_Member'>max_dead_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1182"><span class='Ref_to_Proto'>pgstat_progress_update_multi_param</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN479"><span class='Ref_To_Local'>initprog_index</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN484"><span class='Ref_To_Local'>initprog_val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Except when aggressive is set, we want to skip pages that are 
     * all-visible according to the visibility map, but only when we can skip 
     * at least SKIP_PAGES_THRESHOLD consecutive pages.  Since we're reading 
     * sequentially, the OS should be doing readahead for us, so there's no 
     * gain in skipping a page now and then; that's likely to disable 
     * readahead and so be counterproductive. Also, skipping even a single 
     * page means that we can't update relfrozenxid, so we only want to do it 
     * if we can skip a goodly number of pages. 
     * 
     * When aggressive is set, we can't skip pages just because they are 
     * all-visible, but we can still skip pages that are all-frozen, since 
     * such pages do not need freezing and do not affect the value that we can 
     * safely set for relfrozenxid or relminmxid. 
     * 
     * Before entering the main loop, establish the invariant that 
     * next_unskippable_block is the next block number &GT;= blkno that's not we 
     * can't skip based on the visibility map, either all-visible for a 
     * regular scan or all-frozen for an aggressive scan.  We set it to 
     * nblocks if there's no such block.  We also set up the skipping_blocks 
     * flag correctly at this stage. 
     * 
     * Note: The value returned by visibilitymap_get_status could be slightly 
     * out-of-date, since we make this test before reading the corresponding 
     * heap page or locking the buffer.  This is OK.  If we mistakenly think 
     * that the page is all-visible or all-frozen when in fact the flag's just 
     * been cleared, we might fail to vacuum the page.  It's easy to see that 
     * skipping a page when aggressive is not set is not a very big deal; we 
     * might leave some dead tuples lying around, but the next vacuum will 
     * find them.  But even when aggressive *is* set, it's still OK if we miss 
     * a page whose all-frozen marking has just been cleared.  Any new XIDs 
     * just added to that page are necessarily newer than the GlobalXmin we 
     * computed, so they'll have no effect on the value to which we can safely 
     * set relfrozenxid.  A similar argument applies for MXIDs and relminmxid. 
     * 
     * We will scan the table's last page, at least to the extent of 
     * determining whether it has tuples or not, even if it should be skipped 
     * according to the above rules; except when we've already determined that 
     * it's not worth trying to truncate the table.  This avoids having 
     * lazy_truncate_heap() take access-exclusive lock on the table to attempt 
     * a truncation that just fails immediately because there are tuples in 
     * the last page.  This is worth avoiding mainly because such a lock must 
     * be replayed on any hot standby, where it can be disruptive. 
     */ 
</span>    <a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3069"><span class='Ref_to_EnumConst'>VACOPT_DISABLE_PAGE_SKIPPING</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN565"></a>            <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>vmstatus</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN565"><span class='Ref_To_Local'>vmstatus</span></a> <span class='Operator'>= </span><a href="../../include/access/visibilitymap.h.html#LN44"><span class='Ref_to_Proto'>visibilitymap_get_status</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>aggressive</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN565"><span class='Ref_To_Local'>vmstatus</span></a> <span class='Operator'>& </span><a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN565"><span class='Ref_To_Local'>vmstatus</span></a> <span class='Operator'>& </span><a href="../../include/access/visibilitymap.h.html#LN25"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_VISIBLE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (options&VACOPT_DISAB... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a> <span class='Operator'>&GT;= </span><a href="vacuumlazy.c.html#LN98"><span class='Ref_to_Const'>SKIP_PAGES_THRESHOLD</span></a><span class='Parentheses'>) 
</span>        <a href="vacuumlazy.c.html#LN476"><span class='Ref_To_Local'>skipping_blocks</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="vacuumlazy.c.html#LN476"><span class='Ref_To_Local'>skipping_blocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN591"></a>        <a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN592"></a>        <a href="../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN593"></a>        <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN594"></a>                    <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN595"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>tupgone</span><span class='Delimiter'>, 
</span><a name="LN596"></a>                    <span class='Declare_Local'>hastup</span><span class='Delimiter'>; 
</span><a name="LN597"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>prev_dead_count</span><span class='Delimiter'>; 
</span><a name="LN598"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nfrozen</span><span class='Delimiter'>; 
</span><a name="LN599"></a>        <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span><span class='Delimiter'>; 
</span><a name="LN600"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible_according_to_vm</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN601"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible</span><span class='Delimiter'>; 
</span><a name="LN602"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_frozen</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* provided all_visible is also true */ 
</span><a name="LN603"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_dead_tuples</span><span class='Delimiter'>; 
</span><a name="LN604"></a>        <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>visibility_cutoff_xid</span> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* see note above about forcing scanning of last page */ 
</span><a name="LN607"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FORCE_CHECK_PAGE</span><span class='Parentheses'>() </span><span class='Operator'>\ 
</span>        <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN159"><span class='Ref_to_Proto'>should_attempt_truncation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>))</span> 
 
        <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN22"><span class='Ref_to_Const'>PROGRESS_VACUUM_HEAP_BLKS_SCANNED</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>== </span><a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Time to advance next_unskippable_block */ 
</span>            <a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>options</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3069"><span class='Ref_to_EnumConst'>VACOPT_DISABLE_PAGE_SKIPPING</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN620"></a>                    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>vmskipflags</span><span class='Delimiter'>; 
</span> 
                    <a href="vacuumlazy.c.html#LN620"><span class='Ref_To_Local'>vmskipflags</span></a> <span class='Operator'>= </span><a href="../../include/access/visibilitymap.h.html#LN44"><span class='Ref_to_Proto'>visibilitymap_get_status</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, 
</span>                                                      <a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a><span class='Delimiter'>, 
</span>                                                           <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>aggressive</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN620"><span class='Ref_To_Local'>vmskipflags</span></a> <span class='Operator'>& </span><a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                            <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN620"><span class='Ref_To_Local'>vmskipflags</span></a> <span class='Operator'>& </span><a href="../../include/access/visibilitymap.h.html#LN25"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_VISIBLE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                            <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <a href="../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while next_unskippable_bloc... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (options&VACOPT_DISAB... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We know we can't skip the current block.  But set up 
             * skipping_all_visible_blocks to do the right thing at the 
             * following blocks. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN475"><span class='Ref_To_Local'>next_unskippable_block</span></a> <span class='Operator'>- </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN98"><span class='Ref_to_Const'>SKIP_PAGES_THRESHOLD</span></a><span class='Parentheses'>) 
</span>                <a href="vacuumlazy.c.html#LN476"><span class='Ref_To_Local'>skipping_blocks</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="vacuumlazy.c.html#LN476"><span class='Ref_To_Local'>skipping_blocks</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Normally, the fact that we can't skip this block must mean that 
             * it's not all-visible.  But in an aggressive vacuum we know only 
             * that it's not all-frozen, so it might still be all-visible. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>aggressive</span></a> <span class='Operator'>&& </span><a href="../../include/access/visibilitymap.h.html#LN31"><span class='Ref_to_Macro'>VM_ALL_VISIBLE</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
                <a href="vacuumlazy.c.html#LN600"><span class='Ref_To_Local'>all_visible_according_to_vm</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if blkno==next_unskippab... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The current block is potentially skippable; if we've seen a 
             * long enough run of skippable blocks to justify skipping it, and 
             * we're not forced to check it, then go ahead and skip. 
             * Otherwise, the page must be at least all-visible if not 
             * all-frozen, so we can set all_visible_according_to_vm = true. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN476"><span class='Ref_To_Local'>skipping_blocks</span></a> <span class='Operator'>&& !</span><a href="vacuumlazy.c.html#LN607"><span class='Ref_to_Macro'>FORCE_CHECK_PAGE</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Tricky, tricky.  If this is in aggressive vacuum, the page 
                 * must have been all-frozen at the time we checked whether it 
                 * was skippable, but it might not be any more.  We must be 
                 * careful to count it as a skipped all-frozen page in that 
                 * case, or else we'll think we can't update relfrozenxid and 
                 * relminmxid.  If it's not an aggressive vacuum, we don't 
                 * know whether it was all-frozen, so we have to recheck; but 
                 * in this case an approximate answer is OK. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>aggressive</span></a> <span class='Operator'>|| </span><a href="../../include/access/visibilitymap.h.html#LN33"><span class='Ref_to_Macro'>VM_ALL_FROZEN</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
                    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN115"><span class='Ref_to_Member'>frozenskipped_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="vacuumlazy.c.html#LN600"><span class='Ref_To_Local'>all_visible_according_to_vm</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <a href="../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we are close to overrunning the available space for dead-tuple 
         * TIDs, pause and do a cycle of vacuuming before we tackle this page. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN127"><span class='Ref_to_Member'>max_dead_tuples</span></a> <span class='Operator'>- </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a> <span class='Operator'>&& 
</span>            <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN695"></a>            <span class='Keyword'>const int</span>   <span class='Declare_Local'>hvp_index</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>                <a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/commands/progress.h.html#LN24"><span class='Ref_to_Const'>PROGRESS_VACUUM_NUM_INDEX_VACUUMS</span></a> 
            <span class='Delimiter'>}; 
</span><a name="LN699"></a>            <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>hvp_val</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Before beginning index vacuuming, we release any pin we may 
             * hold on the visibility map page.  This isn't necessary for 
             * correctness, but we do it anyway to avoid holding the pin 
             * across a lengthy, unrelated operation. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>= </span><a href="../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Log cleanup info before we touch indexes */ 
</span>            <a href="vacuumlazy.c.html#LN424"><span class='Ref_to_Func'>vacuum_log_cleanup_info</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Report that we are now vacuuming indexes */ 
</span>            <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/commands/progress.h.html#LN30"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_VACUUM_INDEX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Remove index entries */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>nindexes</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="vacuumlazy.c.html#LN151"><span class='Ref_to_Proto'>lazy_vacuum_index</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>Irel</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                  <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN471"><span class='Ref_To_Local'>indstats</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                  <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Report that we are now vacuuming the heap.  We also increase 
             * the number of index scans here; note that by using 
             * pgstat_progress_update_multi_param we can update both 
             * parameters atomically. 
             */ 
</span>            <a href="vacuumlazy.c.html#LN699"><span class='Ref_To_Local'>hvp_val</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/commands/progress.h.html#LN31"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_VACUUM_HEAP</span></a><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN699"><span class='Ref_To_Local'>hvp_val</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN129"><span class='Ref_to_Member'>num_index_scans</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="../../include/pgstat.h.html#LN1182"><span class='Ref_to_Proto'>pgstat_progress_update_multi_param</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN695"><span class='Ref_To_Local'>hvp_index</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN699"><span class='Ref_To_Local'>hvp_val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Remove tuples from heap */ 
</span>            <a href="vacuumlazy.c.html#LN149"><span class='Ref_to_Proto'>lazy_vacuum_heap</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Forget the now-vacuumed tuples, and press on, but be careful 
             * not to reset latestRemovedXid since we want that value to be 
             * valid. 
             */ 
</span>            <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN129"><span class='Ref_to_Member'>num_index_scans</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Report that we are once again scanning the heap */ 
</span>            <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../include/commands/progress.h.html#LN29"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_SCAN_HEAP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (vacrelstats-&GT;max_dea... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Pin the visibility map page in case we need to mark the page 
         * all-visible.  In most cases this will be very cheap, because we'll 
         * already have the correct page pinned anyway.  However, it's 
         * possible that (a) next_unskippable_block is covered by a different 
         * VM page than the current block or (b) we released our pin and did a 
         * cycle of index vacuuming. 
         * 
         */ 
</span>        <a href="../../include/access/visibilitymap.h.html#LN38"><span class='Ref_to_Proto'>visibilitymap_pin</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><a href="vacuum.c.html#LN65"><span class='Ref_to_Global_Var'>vac_strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We need buffer cleanup lock so that we can prune HOT chains. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/bufmgr.h.html#LN217"><span class='Ref_to_Proto'>ConditionalLockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we're not performing an aggressive scan to guard against XID 
             * wraparound, and we don't want to forcibly check the page, then 
             * it's OK to skip vacuuming pages we get a lock conflict on. They 
             * will be dealt with in some future vacuum. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>aggressive</span></a> <span class='Operator'>&& !</span><a href="vacuumlazy.c.html#LN607"><span class='Ref_to_Macro'>FORCE_CHECK_PAGE</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN114"><span class='Ref_to_Member'>pinskipped_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Read the page with share lock to see if any xids on it need to 
             * be frozen.  If not we just skip the page, after updating our 
             * scan statistics.  If there are some, we wait for cleanup lock. 
             * 
             * We could defer the lock request further by remembering the page 
             * and coming back to it later, or we could even register 
             * ourselves for multiple buffers and then service whichever one 
             * is received first.  For now, this seems good enough. 
             * 
             * If we get here with aggressive false, then we're just forcibly 
             * checking the page, and so we don't want to insist on getting 
             * the lock; we only need to know if the page contains tuples, so 
             * that we can update nonempty_pages correctly.  It's convenient 
             * to use lazy_check_needs_freeze() for both situations, though. 
             */ 
</span>            <a href="../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN150"><span class='Ref_to_Proto'>lazy_check_needs_freeze</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN113"><span class='Ref_to_Member'>scanned_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN114"><span class='Ref_to_Member'>pinskipped_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a><span class='Parentheses'>) 
</span>                    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>aggressive</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Here, we must not advance scanned_pages; that would amount 
                 * to claiming that the page contains no freezable tuples. 
                 */ 
</span>                <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN114"><span class='Ref_to_Member'>pinskipped_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a><span class='Parentheses'>) 
</span>                    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufmgr.h.html#LN216"><span class='Ref_to_Proto'>LockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* drop through to normal processing */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !ConditionalLockBuffe... &raquo; </span> 
 
        <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN113"><span class='Ref_to_Member'>scanned_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN116"><span class='Ref_to_Member'>tupcount_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * An all-zeroes page could be left over if a backend extends the 
             * relation but crashes before initializing the page. Reclaim such 
             * pages for use. 
             * 
             * We have to be careful here because we could be looking at a 
             * page that someone has just added to the relation and not yet 
             * been able to initialize (see RelationGetBufferForTuple). To 
             * protect against that, release the buffer lock, grab the 
             * relation extension lock momentarily, and re-lock the buffer. If 
             * the page is still uninitialized by then, it must be left over 
             * from a crashed backend, and we can initialize it. 
             * 
             * We don't really need the relation lock when this is a new or 
             * temp relation, but it's probably not worth the code space to 
             * check that, since this surely isn't a critical path. 
             * 
             * Note: the comparable code in vacuum.c need not worry because 
             * it's got exclusive lock on the whole relation. 
             */ 
</span>            <a href="../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/lmgr.h.html#LN53"><span class='Ref_to_Proto'>LockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/lmgr.h.html#LN54"><span class='Ref_to_Proto'>UnlockRelationForExtension</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufmgr.h.html#LN216"><span class='Ref_to_Proto'>LockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"relation \"%s\" page %u is uninitialized --- fixing"</span><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN464"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../storage/page/bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="../../include/storage/bufmgr.h.html#LN146"><span class='Ref_to_Macro'>BufferGetPageSize</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN465"><span class='Ref_To_Local'>empty_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="vacuumlazy.c.html#LN599"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN599"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PageIsNew(page) &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="vacuumlazy.c.html#LN465"><span class='Ref_To_Local'>empty_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN599"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* empty pages are always all-visible and all-frozen */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* mark buffer dirty before writing a WAL record */ 
</span>                <a href="../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * It's possible that another backend has extended the heap, 
                 * initialized the page, and then failed to WAL-log the page 
                 * due to an ERROR.  Since heap extension is not WAL-logged, 
                 * recovery might try to replay our record setting the page 
                 * all-visible and find that the page isn't initialized, which 
                 * will cause a PANIC.  To prevent that, check whether the 
                 * page has been previously WAL-logged, and if not, do that 
                 * now. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <a href="../../include/storage/bufpage.h.html#LN362"><span class='Ref_to_Macro'>PageGetLSN</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span> 
                    <a href="../../include/access/xloginsert.h.html#LN56"><span class='Ref_to_Proto'>log_newpage_buffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/storage/bufpage.h.html#LN383"><span class='Ref_to_Macro'>PageSetAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/access/visibilitymap.h.html#LN41"><span class='Ref_to_Proto'>visibilitymap_set</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                  <a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/access/visibilitymap.h.html#LN25"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_VISIBLE</span></a> <span class='Operator'>| </span><a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !PageIsAllVisible(pag... &raquo; </span> 
 
            <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN599"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PageIsEmpty(page) &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Prune all HOT-update chains in this page. 
         * 
         * We count tuples removed by the pruning step as removed by VACUUM. 
         */ 
</span>        <a href="vacuumlazy.c.html#LN468"><span class='Ref_To_Local'>tups_vacuumed</span></a> <span class='Operator'>+= </span><a href="../access/heap/pruneheap.c.html#LN180"><span class='Ref_to_Func'>heap_page_prune</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN130"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now scan the page to collect vacuumable items and check for tuples 
         * requiring freezing. 
         */ 
</span>        <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN603"><span class='Ref_To_Local'>has_dead_tuples</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN598"><span class='Ref_To_Local'>nfrozen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN597"><span class='Ref_To_Local'>prev_dead_count</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN594"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note: If you change anything in the loop below, also look at 
         * heap_page_is_all_visible to see if that needs to be changed. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>             <a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="vacuumlazy.c.html#LN594"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>             <a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN938"></a>            <a href="../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Unused items require no processing, but we count 'em */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="vacuumlazy.c.html#LN470"><span class='Ref_To_Local'>nunused</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Redirect items mustn't be touched */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN104"><span class='Ref_to_Macro'>ItemIdIsRedirected</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* this page won't be truncatable */ 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * DEAD item pointers are to be vacuumed normally; but we don't 
             * count them in tups_vacuumed, else we'd be double-counting (at 
             * least in the common case where heap_page_prune() just freed up 
             * a non-HOT tuple). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="vacuumlazy.c.html#LN164"><span class='Ref_to_Proto'>lazy_record_dead_tuple</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN938"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN595"><span class='Ref_To_Local'>tupgone</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../include/utils/tqual.h.html#LN74"><span class='Ref_to_Proto'>HeapTupleSatisfiesVacuum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN50"><span class='Ref_to_EnumConst'>HEAPTUPLE_DEAD</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Ordinarily, DEAD tuples would have been removed by 
                     * heap_page_prune(), but it's possible that the tuple 
                     * state changed since heap_page_prune() looked.  In 
                     * particular an INSERT_IN_PROGRESS tuple could have 
                     * changed to DEAD if the inserter aborted.  So this 
                     * cannot be considered an error condition. 
                     * 
                     * If the tuple is HOT-updated then it must only be 
                     * removed by a prune operation; so we keep it just as if 
                     * it were RECENTLY_DEAD.  Also, if it's a heap-only 
                     * tuple, we choose to keep it, because it'll be a lot 
                     * cheaper to get rid of it in the next pruning pass than 
                     * to treat it like an indexed tuple. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN676"><span class='Ref_to_Macro'>HeapTupleIsHotUpdated</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                        <a href="../../include/access/htup_details.h.html#LN685"><span class='Ref_to_Macro'>HeapTupleIsHeapOnly</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
                        <a href="vacuumlazy.c.html#LN469"><span class='Ref_To_Local'>nkeep</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="vacuumlazy.c.html#LN595"><span class='Ref_To_Local'>tupgone</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* we can delete the tuple */ 
</span>                    <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN51"><span class='Ref_to_EnumConst'>HEAPTUPLE_LIVE</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* Tuple is good --- but let's do some validity checks */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasoids <span class='Operator'>&& 
</span>                        <span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)))</span> 
                        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"relation \"%s\" TID %u/%u: OID is invalid"</span><span class='Delimiter'>, 
</span>                             <a href="vacuumlazy.c.html#LN464"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Is the tuple definitely visible to all transactions? 
                     * 
                     * NB: Like with per-tuple hint bits, we can't set the 
                     * PD_ALL_VISIBLE flag if the inserter committed 
                     * asynchronously. See SetHintBits for more info. Check 
                     * that the tuple is hinted xmin-committed because of 
                     * that. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span><a name="LN1023"></a>                        <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmin</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup_details.h.html#LN317"><span class='Ref_to_Macro'>HeapTupleHeaderXminCommitted</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                            <span class='Control'>break</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * The inserter definitely committed. But is it old 
                         * enough that everyone sees it as committed? 
                         */ 
</span>                        <a href="vacuumlazy.c.html#LN1023"><span class='Ref_To_Local'>xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1023"><span class='Ref_To_Local'>xmin</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                            <span class='Control'>break</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span> 
                        <span class='Comment_Multi_Line'>/* Track newest xmin on page. */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1023"><span class='Ref_To_Local'>xmin</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN604"><span class='Ref_To_Local'>visibility_cutoff_xid</span></a><span class='Parentheses'>))</span> 
                            <a href="vacuumlazy.c.html#LN604"><span class='Ref_To_Local'>visibility_cutoff_xid</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1023"><span class='Ref_To_Local'>xmin</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if all_visible &raquo; </span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN52"><span class='Ref_to_EnumConst'>HEAPTUPLE_RECENTLY_DEAD</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * If tuple is recently deleted then we must not remove it 
                     * from relation. 
                     */ 
</span>                    <a href="vacuumlazy.c.html#LN469"><span class='Ref_To_Local'>nkeep</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                    <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN53"><span class='Ref_to_EnumConst'>HEAPTUPLE_INSERT_IN_PROGRESS</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* This is an expected case during concurrent vacuum */ 
</span>                    <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN54"><span class='Ref_to_EnumConst'>HEAPTUPLE_DELETE_IN_PROGRESS</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* This is an expected case during concurrent vacuum */ 
</span>                    <a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected HeapTupleSatisfiesVacuum result"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch HeapTupleSatisfiesVac... &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN595"><span class='Ref_To_Local'>tupgone</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="vacuumlazy.c.html#LN164"><span class='Ref_to_Proto'>lazy_record_dead_tuple</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../include/access/heapam_xlog.h.html#LN369"><span class='Ref_to_Proto'>HeapTupleHeaderAdvanceLatestRemovedXid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, 
</span>                                             <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN130"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN468"><span class='Ref_To_Local'>tups_vacuumed</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN603"><span class='Ref_To_Local'>has_dead_tuples</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1079"></a>                <span class='Keyword'>bool</span>        <span class='Declare_Local'>tuple_totally_frozen</span><span class='Delimiter'>; 
</span> 
                <a href="vacuumlazy.c.html#LN467"><span class='Ref_To_Local'>num_tuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Each non-removable tuple must be checked to see if it needs 
                 * freezing.  Note we already have exclusive buffer lock. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/heapam_xlog.h.html#LN391"><span class='Ref_to_Proto'>heap_prepare_freeze_tuple</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN463"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN139"><span class='Ref_to_Global_Var'>FreezeLimit</span></a><span class='Delimiter'>, 
</span>                                           <a href="vacuumlazy.c.html#LN140"><span class='Ref_to_Global_Var'>MultiXactCutoff</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN598"><span class='Ref_To_Local'>nfrozen</span></a><span class='Delimiter'>], 
</span>                                              <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1079"><span class='Ref_To_Local'>tuple_totally_frozen</span></a><span class='Parentheses'>))</span> 
                    <a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN598"><span class='Ref_To_Local'>nfrozen</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/heapam_xlog.h.html#LN298"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN593"><span class='Ref_To_Local'>offnum</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN1079"><span class='Ref_To_Local'>tuple_totally_frozen</span></a><span class='Parentheses'>) 
</span>                    <a href="vacuumlazy.c.html#LN602"><span class='Ref_To_Local'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offnum=FirstOffsetNum... &raquo; </span>                       <span class='Comment_Single_Line'>/* scan along page */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we froze any tuples, mark the buffer dirty, and write a WAL 
         * record recording the changes.  We must log the changes to be 
         * crash-safe against future truncation of CLOG. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN598"><span class='Ref_To_Local'>nfrozen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* execute collected freezes */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN598"><span class='Ref_To_Local'>nfrozen</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1112"></a>                <a href="../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN1113"></a>                <a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>htup</span><span class='Delimiter'>; 
</span> 
                <a href="vacuumlazy.c.html#LN1112"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/heapam_xlog.h.html#LN298"><span class='Ref_to_Member'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="vacuumlazy.c.html#LN1113"><span class='Ref_To_Local'>htup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1112"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/access/heapam_xlog.h.html#LN396"><span class='Ref_to_Proto'>heap_execute_freeze_tuple</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1113"><span class='Ref_To_Local'>htup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Now WAL-log freezing if necessary */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1124"></a>                <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
                <a href="vacuumlazy.c.html#LN1124"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam_xlog.h.html#LN388"><span class='Ref_to_Proto'>log_heap_freeze</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN139"><span class='Ref_to_Global_Var'>FreezeLimit</span></a><span class='Delimiter'>, 
</span>                                         <a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN598"><span class='Ref_To_Local'>nfrozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1124"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nfrozen&GT;0 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If there are no indexes then we can vacuum the page right now 
         * instead of doing a second scan. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>nindexes</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Remove tuples from heap */ 
</span>            <a href="vacuumlazy.c.html#LN157"><span class='Ref_to_Proto'>lazy_vacuum_page</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN603"><span class='Ref_To_Local'>has_dead_tuples</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Forget the now-vacuumed tuples, and press on, but be careful 
             * not to reset latestRemovedXid since we want that value to be 
             * valid. 
             */ 
</span>            <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN466"><span class='Ref_To_Local'>vacuumed_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="vacuumlazy.c.html#LN599"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* mark page all-visible, if appropriate */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>&& !</span><a href="vacuumlazy.c.html#LN600"><span class='Ref_To_Local'>all_visible_according_to_vm</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1159"></a>            <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>flags</span> <span class='Operator'>= </span><a href="../../include/access/visibilitymap.h.html#LN25"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_VISIBLE</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN602"><span class='Ref_To_Local'>all_frozen</span></a><span class='Parentheses'>) 
</span>                <a href="vacuumlazy.c.html#LN1159"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * It should never be the case that the visibility map page is set 
             * while the page-level bit is clear, but the reverse is allowed 
             * (if checksums are not enabled).  Regardless, set the both bits 
             * so that we get back in sync. 
             * 
             * NB: If the heap page is all-visible but the VM bit is not set, 
             * we don't need to dirty the heap page.  However, if checksums 
             * are enabled, we do need to make sure that the heap page is 
             * dirtied before passing it to visibilitymap_set(), because it 
             * may be logged.  Given that this situation should only happen in 
             * rare cases after a crash, it is not worth optimizing. 
             */ 
</span>            <a href="../../include/storage/bufpage.h.html#LN383"><span class='Ref_to_Macro'>PageSetAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/visibilitymap.h.html#LN41"><span class='Ref_to_Proto'>visibilitymap_set</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                              <a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN604"><span class='Ref_To_Local'>visibility_cutoff_xid</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1159"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if all_visible&&!all_vis... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * As of PostgreSQL 9.2, the visibility map bit should never be set if 
         * the page-level bit is clear.  However, it's possible that the bit 
         * got cleared after we checked it and before we took the buffer 
         * content lock, so we must recheck before jumping to the conclusion 
         * that something bad has happened. 
         */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN600"><span class='Ref_To_Local'>all_visible_according_to_vm</span></a> <span class='Operator'>&& !</span><a href="../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) 
</span>                 <span class='Operator'>&& </span><a href="../../include/access/visibilitymap.h.html#LN31"><span class='Ref_to_Macro'>VM_ALL_VISIBLE</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"page is not marked all-visible but visibility map bit is set in relation \"%s\" page %u"</span><span class='Delimiter'>, 
</span>                 <a href="vacuumlazy.c.html#LN464"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * It's possible for the value returned by GetOldestXmin() to move 
         * backwards, so it's not wrong for us to see tuples that appear to 
         * not be visible to everyone yet, while PD_ALL_VISIBLE is already 
         * set. The real safe xmin value never moves backwards, but 
         * GetOldestXmin() is conservative and sometimes returns a value 
         * that's unnecessarily small, so if we see that contradiction it just 
         * means that the tuples that we think are not visible to everyone yet 
         * actually are, and the PD_ALL_VISIBLE flag is correct. 
         * 
         * There should never be dead tuples on a page with PD_ALL_VISIBLE 
         * set, however. 
         */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN603"><span class='Ref_To_Local'>has_dead_tuples</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"page containing dead tuples is marked as all-visible in relation \"%s\" page %u"</span><span class='Delimiter'>, 
</span>                 <a href="vacuumlazy.c.html#LN464"><span class='Ref_To_Local'>relname</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufpage.h.html#LN385"><span class='Ref_to_Macro'>PageClearAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN592"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/visibilitymap.h.html#LN36"><span class='Ref_to_Proto'>visibilitymap_clear</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/access/visibilitymap.h.html#LN27"><span class='Ref_to_Const'>VISIBILITYMAP_VALID_BITS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the all-visible page is turned out to be all-frozen but not 
         * marked, we should so mark it.  Note that all_frozen is only valid 
         * if all_visible is true, so we must check both. 
         */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN600"><span class='Ref_To_Local'>all_visible_according_to_vm</span></a> <span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN601"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN602"><span class='Ref_To_Local'>all_frozen</span></a> <span class='Operator'>&& 
</span>                 <span class='Operator'>!</span><a href="../../include/access/visibilitymap.h.html#LN33"><span class='Ref_to_Macro'>VM_ALL_FROZEN</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We can pass InvalidTransactionId as the cutoff XID here, 
             * because setting the all-frozen bit doesn't cause recovery 
             * conflicts. 
             */ 
</span>            <a href="../../include/access/visibilitymap.h.html#LN41"><span class='Ref_to_Proto'>visibilitymap_set</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                              <a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN591"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remember the location of the last page with nonremovable tuples */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN596"><span class='Ref_To_Local'>hastup</span></a><span class='Parentheses'>) 
</span>            <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we remembered any tuples for deletion, then the page will be 
         * visited again by lazy_vacuum_heap, which will compute and record 
         * its post-compaction free space.  If not, then we're done with this 
         * page, so remember its free space as-is.  (This path will always be 
         * taken if there are no indexes.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>== </span><a href="vacuumlazy.c.html#LN597"><span class='Ref_To_Local'>prev_dead_count</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN599"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for blkno=0;blkno&LT;nblocks... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* report that everything is scanned and vacuumed */ 
</span>    <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN22"><span class='Ref_to_Const'>PROGRESS_VACUUM_HEAP_BLKS_SCANNED</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN477"><span class='Ref_To_Local'>frozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* save stats for use later */ 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN117"><span class='Ref_to_Member'>scanned_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN467"><span class='Ref_To_Local'>num_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN122"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN468"><span class='Ref_To_Local'>tups_vacuumed</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN120"><span class='Ref_to_Member'>new_dead_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN469"><span class='Ref_To_Local'>nkeep</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now we can compute the new value for pg_class.reltuples */ 
</span>    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN119"><span class='Ref_to_Member'>new_rel_tuples</span></a> <span class='Operator'>= </span><a href="../../include/commands/vacuum.h.html#LN166"><span class='Ref_to_Proto'>vac_estimate_reltuples</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                                         <a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>, 
</span>                                                 <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN116"><span class='Ref_to_Member'>tupcount_pages</span></a><span class='Delimiter'>, 
</span>                                                         <a href="vacuumlazy.c.html#LN467"><span class='Ref_To_Local'>num_tuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release any remaining pin on visibility map page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN474"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>= </span><a href="../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If any tuples need to be deleted, perform final vacuum cycle */ 
</span>    <span class='Comment_Multi_Line'>/* XXX put a threshold on min number of tuples here? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1286"></a>        <span class='Keyword'>const int</span>   <span class='Declare_Local'>hvp_index</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>            <a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>            <a href="../../include/commands/progress.h.html#LN24"><span class='Ref_to_Const'>PROGRESS_VACUUM_NUM_INDEX_VACUUMS</span></a> 
        <span class='Delimiter'>}; 
</span><a name="LN1290"></a>        <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>hvp_val</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Log cleanup info before we touch indexes */ 
</span>        <a href="vacuumlazy.c.html#LN424"><span class='Ref_to_Func'>vacuum_log_cleanup_info</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Report that we are now vacuuming indexes */ 
</span>        <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/commands/progress.h.html#LN30"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_VACUUM_INDEX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remove index entries */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>nindexes</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="vacuumlazy.c.html#LN151"><span class='Ref_to_Proto'>lazy_vacuum_index</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>Irel</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                              <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN471"><span class='Ref_To_Local'>indstats</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                              <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Report that we are now vacuuming the heap */ 
</span>        <a href="vacuumlazy.c.html#LN1290"><span class='Ref_To_Local'>hvp_val</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/commands/progress.h.html#LN31"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_VACUUM_HEAP</span></a><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1290"><span class='Ref_To_Local'>hvp_val</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN129"><span class='Ref_to_Member'>num_index_scans</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="../../include/pgstat.h.html#LN1182"><span class='Ref_to_Proto'>pgstat_progress_update_multi_param</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1286"><span class='Ref_To_Local'>hvp_index</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1290"><span class='Ref_To_Local'>hvp_val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remove tuples from heap */ 
</span>        <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/commands/progress.h.html#LN31"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_VACUUM_HEAP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN149"><span class='Ref_to_Proto'>lazy_vacuum_heap</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN129"><span class='Ref_to_Member'>num_index_scans</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if vacrelstats-&GT;num_dead... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* report all blocks vacuumed; and that we're cleaning up */ 
</span>    <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN23"><span class='Ref_to_Const'>PROGRESS_VACUUM_HEAP_BLKS_VACUUMED</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN462"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/commands/progress.h.html#LN32"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_INDEX_CLEANUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do post-vacuum cleanup and statistics update for each index */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>nindexes</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="vacuumlazy.c.html#LN154"><span class='Ref_to_Proto'>lazy_cleanup_index</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN459"><span class='Ref_to_Parameter'>Irel</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="vacuumlazy.c.html#LN471"><span class='Ref_To_Local'>indstats</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN472"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If no indexes, make log report that lazy_vacuum_heap would've made */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN466"><span class='Ref_To_Local'>vacuumed_pages</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\": removed %.0f row versions in %u pages"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN468"><span class='Ref_To_Local'>tups_vacuumed</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN466"><span class='Ref_To_Local'>vacuumed_pages</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is pretty messy, but we split it up so that we can skip emitting 
     * individual parts of the message when not applicable. 
     */ 
</span>    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, 
</span>        _<span class='Parentheses'>(</span><span class='String'>"%.0f dead row versions cannot be removed yet, oldest xmin: %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="vacuumlazy.c.html#LN469"><span class='Ref_To_Local'>nkeep</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"There were %.0f unused item pointers.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="vacuumlazy.c.html#LN470"><span class='Ref_To_Local'>nunused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"Skipped %u page due to buffer pins, "</span><span class='Delimiter'>, 
</span>                                    <span class='String'>"Skipped %u pages due to buffer pins, "</span><span class='Delimiter'>, 
</span>                                    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN114"><span class='Ref_to_Member'>pinskipped_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN114"><span class='Ref_to_Member'>pinskipped_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"%u frozen page.\n"</span><span class='Delimiter'>, 
</span>                                    <span class='String'>"%u frozen pages.\n"</span><span class='Delimiter'>, 
</span>                                    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN115"><span class='Ref_to_Member'>frozenskipped_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN115"><span class='Ref_to_Member'>frozenskipped_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"%u page is entirely empty.\n"</span><span class='Delimiter'>, 
</span>                                    <span class='String'>"%u pages are entirely empty.\n"</span><span class='Delimiter'>, 
</span>                                    <a href="vacuumlazy.c.html#LN465"><span class='Ref_To_Local'>empty_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="vacuumlazy.c.html#LN465"><span class='Ref_To_Local'>empty_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s."</span><span class='Delimiter'>, </span><a href="../../include/utils/pg_rusage.h.html#LN34"><span class='Ref_to_Proto'>pg_rusage_show</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN473"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\": found %.0f removable, %.0f nonremovable row versions in %u out of %u pages"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN468"><span class='Ref_To_Local'>tups_vacuumed</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN467"><span class='Ref_To_Local'>num_tuples</span></a><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN458"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN113"><span class='Ref_to_Member'>scanned_pages</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN461"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN478"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_scan_heap &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  lazy_vacuum_heap() -- second pass over the heap 
 * 
 *      This routine marks dead tuples as unused and compacts out free 
 *      space on their pages.  Pages not having dead tuples recorded from 
 *      lazy_scan_heap are not visited at all. 
 * 
 * Note: the reason for doing this as a second pass is we cannot remove 
 * the tuples until we've removed their index entries, and we want to 
 * process index entry removal in batches as large as possible. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1379"></a><span class='Declare_Function'>lazy_vacuum_heap</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1381"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tupindex</span><span class='Delimiter'>; 
</span><a name="LN1382"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>npages</span><span class='Delimiter'>; 
</span><a name="LN1383"></a>    <a href="../../include/utils/pg_rusage.h.html#LN26"><span class='Ref_to_Struct'>PGRUsage</span></a>    <span class='Declare_Local'>ru0</span><span class='Delimiter'>; 
</span><a name="LN1384"></a>    <a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>vmbuffer</span> <span class='Operator'>= </span><a href="../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span> 
    <a href="../utils/misc/pg_rusage.c.html#LN25"><span class='Ref_to_Func'>pg_rusage_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1383"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1382"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1392"></a>        <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>tblk</span><span class='Delimiter'>; 
</span><a name="LN1393"></a>        <a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1394"></a>        <a href="../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1395"></a>        <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/commands/vacuum.h.html#LN188"><span class='Ref_to_Proto'>vacuum_delay_point</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1392"><span class='Ref_To_Local'>tblk</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN128"><span class='Ref_to_Member'>dead_tuples</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1393"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1392"><span class='Ref_To_Local'>tblk</span></a><span class='Delimiter'>, </span><a href="../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, 
</span>                                 <a href="vacuum.c.html#LN65"><span class='Ref_to_Global_Var'>vac_strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/bufmgr.h.html#LN217"><span class='Ref_to_Proto'>ConditionalLockBufferForCleanup</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1393"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1393"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>++</span><a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN157"><span class='Ref_to_Proto'>lazy_vacuum_page</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1392"><span class='Ref_To_Local'>tblk</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1393"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1384"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Now that we've compacted the page, record its available space */ 
</span>        <a href="vacuumlazy.c.html#LN1394"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1393"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1395"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN429"><span class='Ref_to_Proto'>PageGetHeapFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1394"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1393"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/freespace.h.html#LN27"><span class='Ref_to_Proto'>RecordPageWithFreeSpace</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1392"><span class='Ref_To_Local'>tblk</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1395"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1382"><span class='Ref_To_Local'>npages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while tupindex&LT;vacrelstats-... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1384"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/bufmgr.h.html#LN174"><span class='Ref_to_Proto'>ReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1384"><span class='Ref_To_Local'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1384"><span class='Ref_To_Local'>vmbuffer</span></a> <span class='Operator'>= </span><a href="../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\": removed %d row versions in %d pages"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1379"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN1381"><span class='Ref_To_Local'>tupindex</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1382"><span class='Ref_To_Local'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="../../include/utils/pg_rusage.h.html#LN34"><span class='Ref_to_Proto'>pg_rusage_show</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1383"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_vacuum_heap &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  lazy_vacuum_page() -- free dead tuples on a page 
 *                   and repair its fragmentation. 
 * 
 * Caller must hold pin and buffer cleanup lock on the buffer. 
 * 
 * tupindex is the index in vacrelstats-&GT;dead_tuples of the first dead 
 * tuple for this page.  We assume the rest follow sequentially. 
 * The return value is the first tupindex after the tuples of this page. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1444"></a><span class='Declare_Function'>lazy_vacuum_page</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN1445"></a>                 <span class='Keyword'>int </span><span class='Declare_Parameter'>tupindex</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vmbuffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1447"></a>    <a href="../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1448"></a>    <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>unused</span><span class='Delimiter'>[</span><a href="../../include/storage/off.h.html#LN27"><span class='Ref_to_Const'>MaxOffsetNumber</span></a><span class='Delimiter'>]; 
</span><a name="LN1449"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>uncnt</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1450"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>visibility_cutoff_xid</span><span class='Delimiter'>; 
</span><a name="LN1451"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_frozen</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN23"><span class='Ref_to_Const'>PROGRESS_VACUUM_HEAP_BLKS_VACUUMED</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>tupindex</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>tupindex</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1459"></a>        <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>tblk</span><span class='Delimiter'>; 
</span><a name="LN1460"></a>        <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>toff</span><span class='Delimiter'>; 
</span><a name="LN1461"></a>        <a href="../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1459"><span class='Ref_To_Local'>tblk</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN128"><span class='Ref_to_Member'>dead_tuples</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>tupindex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1459"><span class='Ref_To_Local'>tblk</span></a> <span class='Operator'>!= </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* past end of tuples for this block */ 
</span>        <a href="vacuumlazy.c.html#LN1460"><span class='Ref_To_Local'>toff</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN128"><span class='Ref_to_Member'>dead_tuples</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>tupindex</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1461"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1447"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1460"><span class='Ref_To_Local'>toff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/itemid.h.html#LN126"><span class='Ref_to_Macro'>ItemIdSetUnused</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1461"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1448"><span class='Ref_To_Local'>unused</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN1449"><span class='Ref_To_Local'>uncnt</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1460"><span class='Ref_To_Local'>toff</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/storage/bufpage.h.html#LN425"><span class='Ref_to_Proto'>PageRepairFragmentation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1447"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark buffer dirty before we write WAL. 
     */ 
</span>    <a href="../../include/storage/bufmgr.h.html#LN176"><span class='Ref_to_Proto'>MarkBufferDirty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XLOG stuff */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN505"><span class='Ref_to_Macro'>RelationNeedsWAL</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1482"></a>        <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1482"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam_xlog.h.html#LN383"><span class='Ref_to_Proto'>log_heap_clean</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, 
</span>                                <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                <a href="vacuumlazy.c.html#LN1448"><span class='Ref_To_Local'>unused</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1449"><span class='Ref_To_Local'>uncnt</span></a><span class='Delimiter'>, 
</span>                                <a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN130"><span class='Ref_to_Member'>latestRemovedXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/bufpage.h.html#LN364"><span class='Ref_to_Macro'>PageSetLSN</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1447"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1482"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * End critical section, so we safely can do visibility tests (which 
     * possibly need to perform IO and allocate memory!). If we crash now the 
     * page (including the corresponding vm bit) might not be marked all 
     * visible, but that's fine. A later vacuum will fix that. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have removed the dead tuples from the page, once again 
     * check if the page has become all-visible.  The page is already marked 
     * dirty, exclusively locked, and, if needed, a full page image has been 
     * emitted in the log_heap_clean() above. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN168"><span class='Ref_to_Proto'>heap_page_is_all_visible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1450"><span class='Ref_To_Local'>visibility_cutoff_xid</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1451"><span class='Ref_To_Local'>all_frozen</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/storage/bufpage.h.html#LN383"><span class='Ref_to_Macro'>PageSetAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1447"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * All the changes to the heap page have been done. If the all-visible 
     * flag is now set, also set the VM all-visible bit (and, if possible, the 
     * all-frozen bit) unless this has already been done previously. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN381"><span class='Ref_to_Macro'>PageIsAllVisible</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1447"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1516"></a>        <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>vm_status</span> <span class='Operator'>= </span><a href="../../include/access/visibilitymap.h.html#LN44"><span class='Ref_to_Proto'>visibilitymap_get_status</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vmbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1517"></a>        <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>flags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Set the VM all-frozen bit to flag, if needed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN1516"><span class='Ref_To_Local'>vm_status</span></a> <span class='Operator'>& </span><a href="../../include/access/visibilitymap.h.html#LN25"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_VISIBLE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="vacuumlazy.c.html#LN1517"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../include/access/visibilitymap.h.html#LN25"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_VISIBLE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN1516"><span class='Ref_To_Local'>vm_status</span></a> <span class='Operator'>& </span><a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN1451"><span class='Ref_To_Local'>all_frozen</span></a><span class='Parentheses'>)</span> 
            <a href="vacuumlazy.c.html#LN1517"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span><a href="../../include/access/visibilitymap.h.html#LN26"><span class='Ref_to_Const'>VISIBILITYMAP_ALL_FROZEN</span></a><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/storage/bufmgr.h.html#LN113"><span class='Ref_to_Macro'>BufferIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vmbuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1517"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/access/visibilitymap.h.html#LN41"><span class='Ref_to_Proto'>visibilitymap_set</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1444"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>vmbuffer</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1450"><span class='Ref_To_Local'>visibility_cutoff_xid</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1517"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="vacuumlazy.c.html#LN1445"><span class='Ref_to_Parameter'>tupindex</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_vacuum_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  lazy_check_needs_freeze() -- scan page to see if any tuples 
 *                   need to be cleaned to avoid wraparound 
 * 
 * Returns true if the page needs to be vacuumed using cleanup lock. 
 * Also returns a flag indicating whether page contains any tuples at all. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1542"></a><span class='Declare_Function'>lazy_check_needs_freeze</span><span class='Parentheses'>(</span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>hastup</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1544"></a>    <a href="../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1542"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1545"></a>    <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN1546"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN1547"></a>    <a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>tupleheader</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN1542"><span class='Ref_to_Parameter'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we hit an uninitialized page, we want to force vacuuming it. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1544"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Quick out for ordinary empty page. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1544"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN1546"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1544"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1545"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>         <a href="vacuumlazy.c.html#LN1545"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="vacuumlazy.c.html#LN1546"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>         <a href="vacuumlazy.c.html#LN1545"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1545"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1564"></a>        <a href="../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1564"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1544"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1545"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* this should match hastup test in count_nondeletable_pages() */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1564"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN1542"><span class='Ref_to_Parameter'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* dead and redirect items never need freezing */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1564"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1547"><span class='Ref_To_Local'>tupleheader</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1544"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1564"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/heapam.h.html#LN171"><span class='Ref_to_Proto'>heap_tuple_needs_freeze</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1547"><span class='Ref_To_Local'>tupleheader</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN139"><span class='Ref_to_Global_Var'>FreezeLimit</span></a><span class='Delimiter'>, 
</span>                                    <a href="vacuumlazy.c.html#LN140"><span class='Ref_to_Global_Var'>MultiXactCutoff</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1542"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offnum=FirstOffsetNum... &raquo; </span>                           <span class='Comment_Single_Line'>/* scan along page */ 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_check_needs_freeze &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  lazy_vacuum_index() -- vacuum one index relation. 
 * 
 *      Delete all the index entries pointing to tuples listed in 
 *      vacrelstats-&GT;dead_tuples, and update running statistics. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1594"></a><span class='Declare_Function'>lazy_vacuum_index</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>indrel</span><span class='Delimiter'>, 
</span><a name="LN1595"></a>                  <a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>stats</span><span class='Delimiter'>, 
</span><a name="LN1596"></a>                  <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1598"></a>    <a href="../../include/access/genam.h.html#LN43"><span class='Ref_to_Struct'>IndexVacuumInfo</span></a> <span class='Declare_Local'>ivinfo</span><span class='Delimiter'>; 
</span><a name="LN1599"></a>    <a href="../../include/utils/pg_rusage.h.html#LN26"><span class='Ref_to_Struct'>PGRUsage</span></a>    <span class='Declare_Local'>ru0</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/misc/pg_rusage.c.html#LN25"><span class='Ref_to_Func'>pg_rusage_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1599"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1594"><span class='Ref_to_Parameter'>indrel</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN46"><span class='Ref_to_Member'>analyze_only</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN47"><span class='Ref_to_Member'>estimated_count</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN48"><span class='Ref_to_Member'>message_level</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN49"><span class='Ref_to_Member'>num_heap_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1596"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN118"><span class='Ref_to_Member'>old_rel_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN50"><span class='Ref_to_Member'>strategy</span></a> <span class='Operator'>= </span><a href="vacuum.c.html#LN65"><span class='Ref_to_Global_Var'>vac_strategy</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do bulk deletion */ 
</span>    <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN1595"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN165"><span class='Ref_to_Proto'>index_bulk_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1598"><span class='Ref_To_Local'>ivinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="vacuumlazy.c.html#LN1595"><span class='Ref_to_Parameter'>stats</span></a><span class='Delimiter'>, 
</span>                               <a href="vacuumlazy.c.html#LN166"><span class='Ref_to_Proto'>lazy_tid_reaped</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN1596"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"scanned index \"%s\" to remove %d row versions"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1594"><span class='Ref_to_Parameter'>indrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN1596"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="../../include/utils/pg_rusage.h.html#LN34"><span class='Ref_to_Proto'>pg_rusage_show</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1599"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_vacuum_index &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  lazy_cleanup_index() -- do post-vacuum cleanup for one index relation. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1625"></a><span class='Declare_Function'>lazy_cleanup_index</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>indrel</span><span class='Delimiter'>, 
</span><a name="LN1626"></a>                   <a href="../../include/access/genam.h.html#LN70"><span class='Ref_to_Struct'>IndexBulkDeleteResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stats</span><span class='Delimiter'>, 
</span><a name="LN1627"></a>                   <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1629"></a>    <a href="../../include/access/genam.h.html#LN43"><span class='Ref_to_Struct'>IndexVacuumInfo</span></a> <span class='Declare_Local'>ivinfo</span><span class='Delimiter'>; 
</span><a name="LN1630"></a>    <a href="../../include/utils/pg_rusage.h.html#LN26"><span class='Ref_to_Struct'>PGRUsage</span></a>    <span class='Declare_Local'>ru0</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/misc/pg_rusage.c.html#LN25"><span class='Ref_to_Func'>pg_rusage_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1630"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN45"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1625"><span class='Ref_to_Parameter'>indrel</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN46"><span class='Ref_to_Member'>analyze_only</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN47"><span class='Ref_to_Member'>estimated_count</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1627"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN116"><span class='Ref_to_Member'>tupcount_pages</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN1627"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN48"><span class='Ref_to_Member'>message_level</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN49"><span class='Ref_to_Member'>num_heap_tuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1627"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN119"><span class='Ref_to_Member'>new_rel_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Operator'>.</span><a href="../../include/access/genam.h.html#LN50"><span class='Ref_to_Member'>strategy</span></a> <span class='Operator'>= </span><a href="vacuum.c.html#LN65"><span class='Ref_to_Global_Var'>vac_strategy</span></a><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a> <span class='Operator'>= </span><a href="../../include/access/genam.h.html#LN169"><span class='Ref_to_Proto'>index_vacuum_cleanup</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1629"><span class='Ref_To_Local'>ivinfo</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now update statistics in pg_class, but only if the index says the count 
     * is accurate. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN74"><span class='Ref_to_Member'>estimated_count</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/commands/vacuum.h.html#LN170"><span class='Ref_to_Proto'>vac_update_relstats</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1625"><span class='Ref_to_Parameter'>indrel</span></a><span class='Delimiter'>, 
</span>                            <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN72"><span class='Ref_to_Member'>num_pages</span></a><span class='Delimiter'>, 
</span>                            <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN75"><span class='Ref_to_Member'>num_index_tuples</span></a><span class='Delimiter'>, 
</span>                            <span class='Number'>0</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                            <a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>, 
</span>                            <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"index \"%s\" now contains %.0f row versions in %u pages"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1625"><span class='Ref_to_Parameter'>indrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN75"><span class='Ref_to_Member'>num_index_tuples</span></a><span class='Delimiter'>, 
</span>                    <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN72"><span class='Ref_to_Member'>num_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"%.0f index row versions were removed.\n"</span> 
             <span class='String'>"%u index pages have been deleted, %u are currently reusable.\n"</span> 
                       <span class='String'>"%s."</span><span class='Delimiter'>, 
</span>                       <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN76"><span class='Ref_to_Member'>tuples_removed</span></a><span class='Delimiter'>, 
</span>                       <a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN77"><span class='Ref_to_Member'>pages_deleted</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/genam.h.html#LN78"><span class='Ref_to_Member'>pages_free</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/utils/pg_rusage.h.html#LN34"><span class='Ref_to_Proto'>pg_rusage_show</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1630"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1626"><span class='Ref_to_Parameter'>stats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_cleanup_index &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * should_attempt_truncation - should we attempt to truncate the heap? 
 * 
 * Don't even think about it unless we have a shot at releasing a goodly 
 * number of pages.  Otherwise, the time taken isn't worth it. 
 * 
 * Also don't attempt it if we are doing early pruning/vacuuming, because a 
 * scan which cannot find a truncated heap page cannot determine that the 
 * snapshot is too old to read that page.  We might be able to get away with 
 * truncating all except one of the pages, setting its LSN to (at least) the 
 * maximum of the truncated range if we also treated an index leaf tuple 
 * pointing to a missing heap page as something to trigger the "snapshot too 
 * old" error, but that seems fragile and seems like it deserves its own patch 
 * if we consider it. 
 * 
 * This is split out so that we can test whether truncation is going to be 
 * called for before we actually do it.  If you change the logic here, be 
 * careful to depend only on fields that lazy_scan_heap updates on-the-fly. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1695"></a><span class='Declare_Function'>should_attempt_truncation</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1697"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>possibly_freeable</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN1697"><span class='Ref_To_Local'>possibly_freeable</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1695"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a> <span class='Operator'>- </span><a href="vacuumlazy.c.html#LN1695"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1697"><span class='Ref_To_Local'>possibly_freeable</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1697"><span class='Ref_To_Local'>possibly_freeable</span></a> <span class='Operator'>&GT;= </span><a href="vacuumlazy.c.html#LN73"><span class='Ref_to_Const'>REL_TRUNCATE_MINIMUM</span></a> <span class='Operator'>|| 
</span>      <a href="vacuumlazy.c.html#LN1697"><span class='Ref_To_Local'>possibly_freeable</span></a> <span class='Operator'>&GT;= </span><a href="vacuumlazy.c.html#LN1695"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a> <span class='Operator'>/ </span><a href="vacuumlazy.c.html#LN74"><span class='Ref_to_Const'>REL_TRUNCATE_FRACTION</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../utils/time/snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * lazy_truncate_heap - try to truncate off any empty pages at the end 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1713"></a><span class='Declare_Function'>lazy_truncate_heap</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1715"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>old_rel_pages</span> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a><span class='Delimiter'>; 
</span><a name="LN1716"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>new_rel_pages</span><span class='Delimiter'>; 
</span><a name="LN1717"></a>    <a href="../../include/utils/pg_rusage.h.html#LN26"><span class='Ref_to_Struct'>PGRUsage</span></a>    <span class='Declare_Local'>ru0</span><span class='Delimiter'>; 
</span><a name="LN1718"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lock_retry</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/misc/pg_rusage.c.html#LN25"><span class='Ref_to_Func'>pg_rusage_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1717"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report that we are now truncating */ 
</span>    <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN20"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/commands/progress.h.html#LN33"><span class='Ref_to_Const'>PROGRESS_VACUUM_PHASE_TRUNCATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop until no more truncating can be done. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We need full exclusive lock on the relation in order to do 
         * truncation. If we can't get it, give up rather than waiting --- we 
         * don't want to block other backends, and we don't want to deadlock 
         * (which is quite possible considering we already hold a lower-grade 
         * lock). 
         */ 
</span>        <a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN131"><span class='Ref_to_Member'>lock_waiter_detected</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1718"><span class='Ref_To_Local'>lock_retry</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/lmgr.h.html#LN45"><span class='Ref_to_Proto'>ConditionalLockRelation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check for interrupts while trying to (re-)acquire the exclusive 
             * lock. 
             */ 
</span>            <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="vacuumlazy.c.html#LN1718"><span class='Ref_To_Local'>lock_retry</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN85"><span class='Ref_to_Const'>VACUUM_TRUNCATE_LOCK_TIMEOUT</span></a> <span class='Operator'>/ 
</span>                                <a href="vacuumlazy.c.html#LN84"><span class='Ref_to_Const'>VACUUM_TRUNCATE_LOCK_WAIT_INTERVAL</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * We failed to establish the lock in the specified number of 
                 * retries. This means we give up truncating. 
                 */ 
</span>                <a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN131"><span class='Ref_to_Member'>lock_waiter_detected</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\": stopping truncate due to conflicting lock request"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN84"><span class='Ref_to_Const'>VACUUM_TRUNCATE_LOCK_WAIT_INTERVAL</span></a> <span class='Operator'>* </span><span class='Number'>1000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Now that we have exclusive lock, look to see if the rel has grown 
         * whilst we were vacuuming with non-exclusive lock.  If so, give up; 
         * the newly added pages presumably contain non-deletable tuples. 
         */ 
</span>        <a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN198"><span class='Ref_to_Macro'>RelationGetNumberOfBlocks</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>!= </span><a href="vacuumlazy.c.html#LN1715"><span class='Ref_To_Local'>old_rel_pages</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Note: we intentionally don't update vacrelstats-&GT;rel_pages with 
             * the new rel size here.  If we did, it would amount to assuming 
             * that the new pages are empty, which is unlikely. Leaving the 
             * numbers alone amounts to assuming that the new pages have the 
             * same tuple density as existing ones, which is less unlikely. 
             */ 
</span>            <a href="../../include/storage/lmgr.h.html#LN46"><span class='Ref_to_Proto'>UnlockRelation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Scan backwards from the end to verify that the end pages actually 
         * contain no tuples.  This is *necessary*, not optional, because 
         * other backends could have added tuples to these pages whilst we 
         * were vacuuming. 
         */ 
</span>        <a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN161"><span class='Ref_to_Proto'>count_nondeletable_pages</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>&GT;= </span><a href="vacuumlazy.c.html#LN1715"><span class='Ref_To_Local'>old_rel_pages</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* can't do anything after all */ 
</span>            <a href="../../include/storage/lmgr.h.html#LN46"><span class='Ref_to_Proto'>UnlockRelation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Okay to truncate. 
         */ 
</span>        <a href="../../include/catalog/storage.h.html#LN23"><span class='Ref_to_Proto'>RelationTruncate</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can release the exclusive lock as soon as we have truncated. 
         * Other backends can't safely access the relation until they have 
         * processed the smgr invalidation that smgrtruncate sent out ... but 
         * that should happen as part of standard invalidation processing once 
         * they acquire lock on the relation. 
         */ 
</span>        <a href="../../include/storage/lmgr.h.html#LN46"><span class='Ref_to_Proto'>UnlockRelation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update statistics.  Here, it *is* correct to adjust rel_pages 
         * without also touching reltuples, since the tuple count wasn't 
         * changed by the truncation. 
         */ 
</span>        <a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN121"><span class='Ref_to_Member'>pages_removed</span></a> <span class='Operator'>+= </span><a href="vacuumlazy.c.html#LN1715"><span class='Ref_To_Local'>old_rel_pages</span></a> <span class='Operator'>- </span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\": truncated %u to %u pages"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="vacuumlazy.c.html#LN1715"><span class='Ref_To_Local'>old_rel_pages</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, 
</span>                                    <a href="../../include/utils/pg_rusage.h.html#LN34"><span class='Ref_to_Proto'>pg_rusage_show</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN1717"><span class='Ref_To_Local'>ru0</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1715"><span class='Ref_To_Local'>old_rel_pages</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1716"><span class='Ref_To_Local'>new_rel_pages</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a> <span class='Operator'>&& 
</span>             <a href="vacuumlazy.c.html#LN1713"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN131"><span class='Ref_to_Member'>lock_waiter_detected</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_truncate_heap &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Rescan end pages to verify that they are (still) empty of tuples. 
 * 
 * Returns number of nondeletable pages (last nonempty page + 1). 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN1841"></a><span class='Declare_Function'>count_nondeletable_pages</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>onerel</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1843"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blkno</span><span class='Delimiter'>; 
</span><a name="LN1844"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>prefetchedUntil</span><span class='Delimiter'>; 
</span><a name="LN1845"></a>    <a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>starttime</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the starttime if we check for conflicting lock requests */ 
</span>    <a href="../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1845"><span class='Ref_To_Local'>starttime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start checking blocks at what we believe relation end to be and move 
     * backwards.  (Strange coding of loop control is needed because blkno is 
     * unsigned.)  To make the scan faster, we prefetch a few blocks at a time 
     * in forward direction, so that OS-level readahead can kick in. 
     */ 
</span>    <a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN112"><span class='Ref_to_Member'>rel_pages</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN104"><span class='Ref_to_Const'>PREFETCH_SIZE</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN104"><span class='Ref_to_Const'>PREFETCH_SIZE</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                     <span class='String'>"prefetch size must be power of 2"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1844"><span class='Ref_To_Local'>prefetchedUntil</span></a> <span class='Operator'>= </span><a href="../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1862"></a>        <a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1863"></a>        <a href="../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1864"></a>        <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN1865"></a>                    <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN1866"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>hastup</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check if another process requests a lock on our relation. We are 
         * holding an AccessExclusiveLock here, so they will be waiting. We 
         * only do this once per VACUUM_TRUNCATE_LOCK_CHECK_INTERVAL, and we 
         * only check if that interval has elapsed once every 32 blocks to 
         * keep the number of system calls and actual shared lock table 
         * lookups to a minimum. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>% </span><span class='Number'>32</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1878"></a>            <a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>currenttime</span><span class='Delimiter'>; 
</span><a name="LN1879"></a>            <a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>elapsed</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1878"><span class='Ref_To_Local'>currenttime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="vacuumlazy.c.html#LN1879"><span class='Ref_To_Local'>elapsed</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1878"><span class='Ref_To_Local'>currenttime</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/portability/instr_time.h.html#LN102"><span class='Ref_to_Macro'>INSTR_TIME_SUBTRACT</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1879"><span class='Ref_To_Local'>elapsed</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1845"><span class='Ref_To_Local'>starttime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../include/portability/instr_time.h.html#LN137"><span class='Ref_to_Macro'>INSTR_TIME_GET_MICROSEC</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1879"><span class='Ref_To_Local'>elapsed</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>1000</span><span class='Parentheses'>)</span> 
                <span class='Operator'>&GT;= </span><a href="vacuumlazy.c.html#LN83"><span class='Ref_to_Const'>VACUUM_TRUNCATE_LOCK_CHECK_INTERVAL</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/lmgr.h.html#LN47"><span class='Ref_to_Proto'>LockHasWaitersRelation</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN136"><span class='Ref_to_Global_Var'>elevel</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\": suspending truncate due to conflicting lock request"</span><span class='Delimiter'>, 
</span>                                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>onerel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
                    <a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN131"><span class='Ref_to_Member'>lock_waiter_detected</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="vacuumlazy.c.html#LN1845"><span class='Ref_To_Local'>starttime</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1878"><span class='Ref_To_Local'>currenttime</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (blkno%32)==0 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * We don't insert a vacuum delay point here, because we have an 
         * exclusive lock on the table which we want to hold for as short a 
         * time as possible.  We still need to check for interrupts however. 
         */ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we haven't prefetched this lot yet, do so now. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1844"><span class='Ref_To_Local'>prefetchedUntil</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1912"></a>            <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>prefetchStart</span><span class='Delimiter'>; 
</span><a name="LN1913"></a>            <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pblkno</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN1912"><span class='Ref_To_Local'>prefetchStart</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>& ~</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN104"><span class='Ref_to_Const'>PREFETCH_SIZE</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1913"><span class='Ref_To_Local'>pblkno</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1912"><span class='Ref_To_Local'>prefetchStart</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN1913"><span class='Ref_To_Local'>pblkno</span></a> <span class='Operator'>&LT;= </span><a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>; </span><a href="vacuumlazy.c.html#LN1913"><span class='Ref_To_Local'>pblkno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/storage/bufmgr.h.html#LN165"><span class='Ref_to_Proto'>PrefetchBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1913"><span class='Ref_To_Local'>pblkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="vacuumlazy.c.html#LN1844"><span class='Ref_To_Local'>prefetchedUntil</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1912"><span class='Ref_To_Local'>prefetchStart</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="vacuumlazy.c.html#LN1862"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN168"><span class='Ref_to_Proto'>ReadBufferExtended</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>onerel</span></a><span class='Delimiter'>, </span><a href="../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/storage/bufmgr.h.html#LN39"><span class='Ref_to_EnumConst'>RBM_NORMAL</span></a><span class='Delimiter'>, </span><a href="vacuum.c.html#LN65"><span class='Ref_to_Global_Var'>vac_strategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* In this phase we only need shared access to the buffer */ 
</span>        <a href="../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1862"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN1863"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1862"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1863"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1863"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* PageIsNew probably shouldn't happen... */ 
</span>            <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1862"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="vacuumlazy.c.html#LN1866"><span class='Ref_To_Local'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1865"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1863"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1864"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>             <a href="vacuumlazy.c.html#LN1864"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="vacuumlazy.c.html#LN1865"><span class='Ref_To_Local'>maxoff</span></a><span class='Delimiter'>; 
</span>             <a href="vacuumlazy.c.html#LN1864"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1864"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1945"></a>            <a href="../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span> 
            <a href="vacuumlazy.c.html#LN1945"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1863"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN1864"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Note: any non-unused item should be taken as a reason to keep 
             * this page.  We formerly thought that DEAD tuples could be 
             * thrown away, but that's not so, because we'd not have cleaned 
             * out their index entries. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1945"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="vacuumlazy.c.html#LN1866"><span class='Ref_To_Local'>hastup</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* can stop scanning */ 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offnum=FirstOffsetNum... &raquo; </span>                       <span class='Comment_Single_Line'>/* scan along page */ 
</span> 
        <a href="../../include/storage/bufmgr.h.html#LN175"><span class='Ref_to_Proto'>UnlockReleaseBuffer</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1862"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Done scanning if we found a tuple here */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1866"><span class='Ref_To_Local'>hastup</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="vacuumlazy.c.html#LN1843"><span class='Ref_To_Local'>blkno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while blkno&GT;vacrelstats-&GT;no... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we fall out of the loop, all the previously-thought-to-be-empty 
     * pages still are; we need not bother to look at the last known-nonempty 
     * page. 
     */ 
</span>    <span class='Control'>return</span> <a href="vacuumlazy.c.html#LN1841"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN123"><span class='Ref_to_Member'>nonempty_pages</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end count_nondeletable_pages &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * lazy_space_alloc - space allocation decisions for lazy vacuum 
 * 
 * See the comments at the head of this file for rationale. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1983"></a><span class='Declare_Function'>lazy_space_alloc</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>relblocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1985"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>maxtuples</span><span class='Delimiter'>; 
</span><a name="LN1986"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>vac_work_mem</span> <span class='Operator'>= </span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>() </span><span class='Operator'>&& 
</span>    <a href="../postmaster/autovacuum.c.html#LN113"><span class='Ref_to_Global_Var'>autovacuum_work_mem</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span> <span class='Operator'>? 
</span>    <a href="../postmaster/autovacuum.c.html#LN113"><span class='Ref_to_Global_Var'>autovacuum_work_mem</span></a> <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN113"><span class='Ref_to_Global_Var'>maintenance_work_mem</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1983"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN109"><span class='Ref_to_Member'>hasindex</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1986"><span class='Ref_To_Local'>vac_work_mem</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a><span class='Delimiter'>, </span>INT_MAX<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a><span class='Delimiter'>, </span><a href="../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* curious coding here to ensure the multiplication can't overflow */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) (</span><a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>/ </span><a href="vacuumlazy.c.html#LN92"><span class='Ref_to_Const'>LAZY_ALLOC_TUPLES</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN1983"><span class='Ref_to_Parameter'>relblocks</span></a><span class='Parentheses'>)</span> 
            <a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN1983"><span class='Ref_to_Parameter'>relblocks</span></a> <span class='Operator'>* </span><a href="vacuumlazy.c.html#LN92"><span class='Ref_to_Const'>LAZY_ALLOC_TUPLES</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* stay sane if small maintenance_work_mem */ 
</span>        <a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a><span class='Delimiter'>, </span><a href="../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="vacuumlazy.c.html#LN1983"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1983"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN127"><span class='Ref_to_Member'>max_dead_tuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN1983"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN128"><span class='Ref_to_Member'>dead_tuples</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN1985"><span class='Ref_To_Local'>maxtuples</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lazy_space_alloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * lazy_record_dead_tuple - remember one deletable tuple 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2018"></a><span class='Declare_Function'>lazy_record_dead_tuple</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vacrelstats</span><span class='Delimiter'>, 
</span><a name="LN2019"></a>                       <a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>itemptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * The array shouldn't overflow under normal behavior, but perhaps it 
     * could if we are given a really small maintenance_work_mem. In that 
     * case, just forget the last few tuples (we'll get 'em next time). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2018"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN2018"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN127"><span class='Ref_to_Member'>max_dead_tuples</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="vacuumlazy.c.html#LN2018"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN128"><span class='Ref_to_Member'>dead_tuples</span></a><span class='Delimiter'>[</span><a href="vacuumlazy.c.html#LN2018"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="vacuumlazy.c.html#LN2019"><span class='Ref_to_Parameter'>itemptr</span></a><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN2018"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../include/pgstat.h.html#LN1181"><span class='Ref_to_Proto'>pgstat_progress_update_param</span></a><span class='Parentheses'>(</span><a href="../../include/commands/progress.h.html#LN26"><span class='Ref_to_Const'>PROGRESS_VACUUM_NUM_DEAD_TUPLES</span></a><span class='Delimiter'>, 
</span>                                     <a href="vacuumlazy.c.html#LN2018"><span class='Ref_to_Parameter'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  lazy_tid_reaped() -- is a particular tid deletable? 
 * 
 *      This has the right signature to be an IndexBulkDeleteCallback. 
 * 
 *      Assumes dead_tuples array is in sorted order. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2043"></a><span class='Declare_Function'>lazy_tid_reaped</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>itemptr</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2045"></a>    <a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vacrelstats</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN106"><span class='Ref_to_Struct'>LVRelStats</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2043"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; 
</span><a name="LN2046"></a>    <a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN2046"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span>bsearch<span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2043"><span class='Ref_to_Parameter'>itemptr</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2045"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN128"><span class='Ref_to_Member'>dead_tuples</span></a><span class='Delimiter'>, 
</span>                                <a href="vacuumlazy.c.html#LN2045"><span class='Ref_To_Local'>vacrelstats</span></a><span class='Operator'>-&GT;</span><a href="vacuumlazy.c.html#LN126"><span class='Ref_to_Member'>num_dead_tuples</span></a><span class='Delimiter'>, 
</span>                                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="vacuumlazy.c.html#LN167"><span class='Ref_to_Proto'>vac_cmp_itemptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2046"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Comparator routines for use with qsort() and bsearch(). 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2061"></a><span class='Declare_Function'>vac_cmp_itemptr</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>left</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>right</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2063"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>lblk</span><span class='Delimiter'>, 
</span><a name="LN2064"></a>                <span class='Declare_Local'>rblk</span><span class='Delimiter'>; 
</span><a name="LN2065"></a>    <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>loff</span><span class='Delimiter'>, 
</span><a name="LN2066"></a>                <span class='Declare_Local'>roff</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN2063"><span class='Ref_To_Local'>lblk</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>((</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2061"><span class='Ref_to_Parameter'>left</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN2064"><span class='Ref_To_Local'>rblk</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>((</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2061"><span class='Ref_to_Parameter'>right</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2063"><span class='Ref_To_Local'>lblk</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN2064"><span class='Ref_To_Local'>rblk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2063"><span class='Ref_To_Local'>lblk</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN2064"><span class='Ref_To_Local'>rblk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="vacuumlazy.c.html#LN2065"><span class='Ref_To_Local'>loff</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>((</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2061"><span class='Ref_to_Parameter'>left</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="vacuumlazy.c.html#LN2066"><span class='Ref_To_Local'>roff</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>((</span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a><span class='Parentheses'>) </span><a href="vacuumlazy.c.html#LN2061"><span class='Ref_to_Parameter'>right</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2065"><span class='Ref_To_Local'>loff</span></a> <span class='Operator'>&LT; </span><a href="vacuumlazy.c.html#LN2066"><span class='Ref_To_Local'>roff</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2065"><span class='Ref_To_Local'>loff</span></a> <span class='Operator'>&GT; </span><a href="vacuumlazy.c.html#LN2066"><span class='Ref_To_Local'>roff</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end vac_cmp_itemptr &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if every tuple in the given page is visible to all current and future 
 * transactions. Also return the visibility_cutoff_xid which is the highest 
 * xmin amongst the visible tuples.  Set *all_frozen to true if every tuple 
 * on this page is frozen. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2094"></a><span class='Declare_Function'>heap_page_is_all_visible</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN2095"></a>                         <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>visibility_cutoff_xid</span><span class='Delimiter'>, 
</span><a name="LN2096"></a>                         <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>all_frozen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2098"></a>    <a href="../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2094"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2099"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blockno</span> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN187"><span class='Ref_to_Proto'>BufferGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2094"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2100"></a>    <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN2101"></a>                <span class='Declare_Local'>maxoff</span><span class='Delimiter'>; 
</span><a name="LN2102"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_visible</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2095"><span class='Ref_to_Parameter'>visibility_cutoff_xid</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is a stripped down version of the line pointer scan in 
     * lazy_scan_heap(). So if you change anything here, also check that code. 
     */ 
</span>    <a href="vacuumlazy.c.html#LN2101"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2098"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2100"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; 
</span>         <a href="vacuumlazy.c.html#LN2100"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="vacuumlazy.c.html#LN2101"><span class='Ref_To_Local'>maxoff</span></a> <span class='Operator'>&& </span><a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a><span class='Delimiter'>; 
</span>         <a href="vacuumlazy.c.html#LN2100"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2100"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2116"></a>        <a href="../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemid</span><span class='Delimiter'>; 
</span><a name="LN2117"></a>        <a href="../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2098"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN2100"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Unused or redirect line pointers are of no interest */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../include/storage/itemid.h.html#LN104"><span class='Ref_to_Macro'>ItemIdIsRedirected</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/itemptr.h.html#LN103"><span class='Ref_to_Macro'>ItemPointerSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN2099"><span class='Ref_To_Local'>blockno</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN2100"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Dead line pointers can have index pointers pointing to them. So 
         * they can't be treated as visible 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN111"><span class='Ref_to_Macro'>ItemIdIsDead</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/storage/itemid.h.html#LN97"><span class='Ref_to_Macro'>ItemIdIsNormal</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a><span class='Parentheses'>) </span><a href="../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2098"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2116"><span class='Ref_To_Local'>itemid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2094"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../include/utils/tqual.h.html#LN74"><span class='Ref_to_Proto'>HeapTupleSatisfiesVacuum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN2094"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN51"><span class='Ref_to_EnumConst'>HEAPTUPLE_LIVE</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN2148"></a>                    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmin</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Check comments in lazy_scan_heap. */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup_details.h.html#LN317"><span class='Ref_to_Macro'>HeapTupleHeaderXminCommitted</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * The inserter definitely committed. But is it old enough 
                     * that everyone sees it as committed? 
                     */ 
</span>                    <a href="vacuumlazy.c.html#LN2148"><span class='Ref_To_Local'>xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2148"><span class='Ref_To_Local'>xmin</span></a><span class='Delimiter'>, </span><a href="vacuumlazy.c.html#LN138"><span class='Ref_to_Global_Var'>OldestXmin</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* Track newest xmin on page. */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2148"><span class='Ref_To_Local'>xmin</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2095"><span class='Ref_to_Parameter'>visibility_cutoff_xid</span></a><span class='Parentheses'>))</span> 
                        <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2095"><span class='Ref_to_Parameter'>visibility_cutoff_xid</span></a> <span class='Operator'>= </span><a href="vacuumlazy.c.html#LN2148"><span class='Ref_To_Local'>xmin</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Check whether this tuple is already frozen or not */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>&& *</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>&& 
</span>                        <a href="../../include/access/heapam.h.html#LN173"><span class='Ref_to_Proto'>heap_tuple_needs_eventual_freeze</span></a><span class='Parentheses'>(</span><a href="vacuumlazy.c.html#LN2117"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>.</span><a href="../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>))</span> 
                        <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN50"><span class='Ref_to_EnumConst'>HEAPTUPLE_DEAD</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN52"><span class='Ref_to_EnumConst'>HEAPTUPLE_RECENTLY_DEAD</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN53"><span class='Ref_to_EnumConst'>HEAPTUPLE_INSERT_IN_PROGRESS</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../include/utils/tqual.h.html#LN54"><span class='Ref_to_EnumConst'>HEAPTUPLE_DELETE_IN_PROGRESS</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Operator'>*</span><a href="vacuumlazy.c.html#LN2096"><span class='Ref_to_Parameter'>all_frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected HeapTupleSatisfiesVacuum result"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch HeapTupleSatisfiesVac... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offnum=FirstOffsetNum... &raquo; </span>                           <span class='Comment_Single_Line'>/* scan along page */ 
</span> 
    <span class='Control'>return</span> <a href="vacuumlazy.c.html#LN2102"><span class='Ref_To_Local'>all_visible</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end heap_page_is_all_visible &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>