<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\executor\nodeHash.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\executor\nodeHash.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:39 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * nodeHash.c 
 *    Routines to hash relations for hashjoin 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/executor/nodeHash.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
/* 
 * INTERFACE ROUTINES 
 *      MultiExecHash   - generate an in-memory hash table of the relation 
 *      ExecInitHash    - initialize node and subnodes 
 *      ExecEndHash     - shutdown node and subnodes 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_statistic.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/execdebug.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/hashjoin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/nodeHash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/nodeHashjoin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dynahash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
 
<a name="LN40"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExecHashIncreaseNumBatches</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN41"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExecHashIncreaseNumBuckets</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN42"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExecHashBuildSkewHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, </span><a href="../../include/nodes/plannodes.h.html#LN863"><span class='Ref_to_Struct'>Hash</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, 
</span><a name="LN43"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>mcvsToUse</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN44"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExecHashSkewTableInsert</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, 
</span><a name="LN45"></a>                        <a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, 
</span><a name="LN46"></a>                        <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Delimiter'>, 
</span><a name="LN47"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>bucketNumber</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN48"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ExecHashRemoveNextSkewBucket</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN50"></a><span class='Keyword'>static void </span><span class='Operator'>*</span><span class='Declare_Prototype'>dense_alloc</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      ExecHash 
 * 
 *      stub for pro forma compliance 
 * ---------------------------------------------------------------- 
 */ 
</span><a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>* 
</span><a name="LN59"></a><span class='Declare_Function'>ExecHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"Hash node does not support ExecProcNode call convention"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      MultiExecHash 
 * 
 *      build hash table for hashjoin, doing partitioning if more 
 *      than one batch is required. 
 * ---------------------------------------------------------------- 
 */ 
</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>* 
</span><a name="LN73"></a><span class='Declare_Function'>MultiExecHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN75"></a>    <a href="../../include/nodes/execnodes.h.html#LN808"><span class='Ref_to_Struct'>PlanState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>outerNode</span><span class='Delimiter'>; 
</span><a name="LN76"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>hashkeys</span><span class='Delimiter'>; 
</span><a name="LN77"></a>    <a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Local'>hashtable</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span><span class='Delimiter'>; 
</span><a name="LN79"></a>    <a href="../../include/nodes/execnodes.h.html#LN191"><span class='Ref_to_Struct'>ExprContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>econtext</span><span class='Delimiter'>; 
</span><a name="LN80"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashvalue</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* must provide our own instrumentation support */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN818"><span class='Ref_to_Member'>instrument</span></a><span class='Parentheses'>) 
</span>        <a href="instrument.c.html#LN61"><span class='Ref_to_Func'>InstrStartNode</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN818"><span class='Ref_to_Member'>instrument</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get state info from node 
     */ 
</span>    <a href="nodeHash.c.html#LN75"><span class='Ref_To_Local'>outerNode</span></a> <span class='Operator'>= </span><a href="../../include/nodes/execnodes.h.html#LN854"><span class='Ref_to_Macro'>outerPlanState</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1923"><span class='Ref_to_Member'>hashtable</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * set expression context 
     */ 
</span>    <a href="nodeHash.c.html#LN76"><span class='Ref_To_Local'>hashkeys</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1924"><span class='Ref_to_Member'>hashkeys</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN79"><span class='Ref_To_Local'>econtext</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN842"><span class='Ref_to_Member'>ps_ExprContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get all inner tuples and insert into the hash table (or temp files) 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nodeHash.c.html#LN78"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="../../include/executor/executor.h.html#LN229"><span class='Ref_to_Proto'>ExecProcNode</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN75"><span class='Ref_To_Local'>outerNode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/tuptable.h.html#LN137"><span class='Ref_to_Macro'>TupIsNull</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN78"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* We have to compute the hash value */ 
</span>        <a href="nodeHash.c.html#LN79"><span class='Ref_To_Local'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN197"><span class='Ref_to_Member'>ecxt_innertuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN78"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/nodeHash.h.html#LN30"><span class='Ref_to_Proto'>ExecHashGetHashValue</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN79"><span class='Ref_To_Local'>econtext</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN76"><span class='Ref_To_Local'>hashkeys</span></a><span class='Delimiter'>, 
</span>                                 <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN139"><span class='Ref_to_Member'>keepNulls</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="nodeHash.c.html#LN80"><span class='Ref_To_Local'>hashvalue</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN112"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bucketNumber</span><span class='Delimiter'>; 
</span> 
            <a href="nodeHash.c.html#LN112"><span class='Ref_To_Local'>bucketNumber</span></a> <span class='Operator'>= </span><a href="../../include/executor/nodeHash.h.html#LN50"><span class='Ref_to_Proto'>ExecHashGetSkewBucket</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN80"><span class='Ref_To_Local'>hashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN112"><span class='Ref_To_Local'>bucketNumber</span></a> <span class='Operator'>!= </span><a href="../../include/executor/hashjoin.h.html#LN100"><span class='Ref_to_Const'>INVALID_SKEW_BUCKET_NO</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* It's a skew tuple, so put it into that hash table */ 
</span>                <a href="nodeHash.c.html#LN44"><span class='Ref_to_Proto'>ExecHashSkewTableInsert</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN78"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN80"><span class='Ref_To_Local'>hashvalue</span></a><span class='Delimiter'>, 
</span>                                        <a href="nodeHash.c.html#LN112"><span class='Ref_To_Local'>bucketNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN156"><span class='Ref_to_Member'>skewTuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Not subject to skew optimization, so insert normally */ 
</span>                <a href="../../include/executor/nodeHash.h.html#LN27"><span class='Ref_to_Proto'>ExecHashTableInsert</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN78"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN80"><span class='Ref_To_Local'>hashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN155"><span class='Ref_to_Member'>totalTuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ExecHashGetHashValue(... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* resize the hash table if needed (NTUP_PER_BUCKET exceeded) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>!= </span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN41"><span class='Ref_to_Proto'>ExecHashIncreaseNumBuckets</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Account for the buckets in spaceUsed (reported in EXPLAIN ANALYZE) */ 
</span>    <a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* must provide our own instrumentation support */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN818"><span class='Ref_to_Member'>instrument</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/executor/instrument.h.html#LN76"><span class='Ref_to_Proto'>InstrStopNode</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN73"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN818"><span class='Ref_to_Member'>instrument</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN77"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN155"><span class='Ref_to_Member'>totalTuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do not return the hash table directly because it's not a subtype of 
     * Node, and so would violate the MultiExecProcNode API.  Instead, our 
     * parent Hashjoin node is expected to know how to fish it out of our node 
     * state.  Ugly but not really worth cleaning up, since Hashjoin knows 
     * quite a bit more about Hash besides that. 
     */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MultiExecHash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      ExecInitHash 
 * 
 *      Init routine for Hash node 
 * ---------------------------------------------------------------- 
 */ 
</span><a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a> <span class='Operator'>* 
</span><a name="LN161"></a><span class='Declare_Function'>ExecInitHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/plannodes.h.html#LN863"><span class='Ref_to_Struct'>Hash</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>estate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>eflags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN163"></a>    <a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>hashstate</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check for unsupported flags */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>eflags</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../include/executor/executor.h.html#LN59"><span class='Ref_to_Const'>EXEC_FLAG_BACKWARD</span></a> <span class='Operator'>| </span><a href="../../include/executor/executor.h.html#LN60"><span class='Ref_to_Const'>EXEC_FLAG_MARK</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * create state structure 
     */ 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN812"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/plannodes.h.html#LN117"><span class='Ref_to_Struct'>Plan</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN814"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>estate</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1923"><span class='Ref_to_Member'>hashtable</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1924"><span class='Ref_to_Member'>hashkeys</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* will be set by parent HashJoin */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Miscellaneous initialization 
     * 
     * create expression context for node 
     */ 
</span>    <a href="execUtils.c.html#LN416"><span class='Ref_to_Func'>ExecAssignExprContext</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>estate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize our result slot 
     */ 
</span>    <a href="../../include/executor/executor.h.html#LN400"><span class='Ref_to_Proto'>ExecInitResultTupleSlot</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>estate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize child expressions 
     */ 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN826"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>= 
</span>        <a href="execExpr.c.html#LN158"><span class='Ref_to_Func'>ExecInitQual</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN865"><span class='Ref_to_Member'>plan</span></a><span class='Operator'>.</span><a href="../../include/nodes/plannodes.h.html#LN144"><span class='Ref_to_Member'>qual</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN808"><span class='Ref_to_Struct'>PlanState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize child nodes 
     */ 
</span>    <a href="../../include/nodes/execnodes.h.html#LN854"><span class='Ref_to_Macro'>outerPlanState</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="execProcnode.c.html#LN138"><span class='Ref_to_Func'>ExecInitNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/plannodes.h.html#LN173"><span class='Ref_to_Macro'>outerPlan</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>estate</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN161"><span class='Ref_to_Parameter'>eflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize tuple type. no need to initialize projection info because 
     * this node doesn't do projections 
     */ 
</span>    <a href="execUtils.c.html#LN438"><span class='Ref_to_Func'>ExecAssignResultTypeFromTL</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN843"><span class='Ref_to_Member'>ps_ProjInfo</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nodeHash.c.html#LN163"><span class='Ref_To_Local'>hashstate</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecInitHash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* --------------------------------------------------------------- 
 *      ExecEndHash 
 * 
 *      clean up routine for Hash node 
 * ---------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN217"></a><span class='Declare_Function'>ExecEndHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN219"></a>    <a href="../../include/nodes/execnodes.h.html#LN808"><span class='Ref_to_Struct'>PlanState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>outerPlan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * free exprcontext 
     */ 
</span>    <a href="../../include/executor/executor.h.html#LN476"><span class='Ref_to_Proto'>ExecFreeExprContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN217"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * shut down the subplan 
     */ 
</span>    <a href="nodeHash.c.html#LN219"><span class='Ref_To_Local'>outerPlan</span></a> <span class='Operator'>= </span><a href="../../include/nodes/execnodes.h.html#LN854"><span class='Ref_to_Macro'>outerPlanState</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN217"><span class='Ref_to_Parameter'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/executor/executor.h.html#LN231"><span class='Ref_to_Proto'>ExecEndNode</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN219"><span class='Ref_To_Local'>outerPlan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      ExecHashTableCreate 
 * 
 *      create an empty hashtable data structure for hashjoin. 
 * ---------------------------------------------------------------- 
 */ 
</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> 
<a name="LN241"></a><span class='Declare_Function'>ExecHashTableCreate</span><span class='Parentheses'>(</span><a href="../../include/nodes/plannodes.h.html#LN863"><span class='Ref_to_Struct'>Hash</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashOperators</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>keepNulls</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN243"></a>    <a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Local'>hashtable</span><span class='Delimiter'>; 
</span><a name="LN244"></a>    <a href="../../include/nodes/plannodes.h.html#LN117"><span class='Ref_to_Struct'>Plan</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>outerNode</span><span class='Delimiter'>; 
</span><a name="LN245"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbuckets</span><span class='Delimiter'>; 
</span><a name="LN246"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbatch</span><span class='Delimiter'>; 
</span><a name="LN247"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_skew_mcvs</span><span class='Delimiter'>; 
</span><a name="LN248"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>log2_nbuckets</span><span class='Delimiter'>; 
</span><a name="LN249"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nkeys</span><span class='Delimiter'>; 
</span><a name="LN250"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN251"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>ho</span><span class='Delimiter'>; 
</span><a name="LN252"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get information about the size of the relation to be hashed (it's the 
     * "outer" subtree of this node, but the inner relation of the hashjoin). 
     * Compute the appropriate size of the hash table. 
     */ 
</span>    <a href="nodeHash.c.html#LN244"><span class='Ref_To_Local'>outerNode</span></a> <span class='Operator'>= </span><a href="../../include/nodes/plannodes.h.html#LN173"><span class='Ref_to_Macro'>outerPlan</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN241"><span class='Ref_to_Parameter'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/executor/nodeHash.h.html#LN46"><span class='Ref_to_Proto'>ExecChooseHashTableSize</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN244"><span class='Ref_To_Local'>outerNode</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN130"><span class='Ref_to_Member'>plan_rows</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN244"><span class='Ref_To_Local'>outerNode</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN131"><span class='Ref_to_Member'>plan_width</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN241"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN866"><span class='Ref_to_Member'>skewTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <span class='Operator'>&</span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN247"><span class='Ref_To_Local'>num_skew_mcvs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* nbuckets must be a power of 2 */ 
</span>    <a href="nodeHash.c.html#LN248"><span class='Ref_To_Local'>log2_nbuckets</span></a> <span class='Operator'>= </span><a href="../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="nodeHash.c.html#LN248"><span class='Ref_To_Local'>log2_nbuckets</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the hash table control block. 
     * 
     * The hashtable control block is just palloc'd from the executor's 
     * per-query memory context. 
     */ 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN125"><span class='Ref_to_Struct'>HashJoinTableData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN130"><span class='Ref_to_Member'>nbuckets_original</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN128"><span class='Ref_to_Member'>log2_nbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN248"><span class='Ref_To_Local'>log2_nbuckets</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN133"><span class='Ref_to_Member'>log2_nbuckets_optimal</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN248"><span class='Ref_To_Local'>log2_nbuckets</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN139"><span class='Ref_to_Member'>keepNulls</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN241"><span class='Ref_to_Parameter'>keepNulls</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN141"><span class='Ref_to_Member'>skewEnabled</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN143"><span class='Ref_to_Member'>skewBucketLen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN147"><span class='Ref_to_Member'>nbatch</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN148"><span class='Ref_to_Member'>curbatch</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN150"><span class='Ref_to_Member'>nbatch_original</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN151"><span class='Ref_to_Member'>nbatch_outstart</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN153"><span class='Ref_to_Member'>growEnabled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN155"><span class='Ref_to_Member'>totalTuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN156"><span class='Ref_to_Member'>skewTuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN178"><span class='Ref_to_Member'>spaceAllowed</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN181"><span class='Ref_to_Member'>spaceAllowedSkew</span></a> <span class='Operator'>= 
</span>        <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN178"><span class='Ref_to_Member'>spaceAllowed</span></a> <span class='Operator'>* </span><a href="../../include/executor/hashjoin.h.html#LN101"><span class='Ref_to_Const'>SKEW_WORK_MEM_PERCENT</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HJDEBUG 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Hashjoin %p: initial nbatch = %d, nbuckets = %d\n"</span><span class='Delimiter'>, 
</span>           <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Get info about the hash functions to be used for each hash key. Also 
     * remember whether the join operators are strict. 
     */ 
</span>    <a href="nodeHash.c.html#LN249"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN241"><span class='Ref_to_Parameter'>hashOperators</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN173"><span class='Ref_to_Member'>outer_hashfunctions</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN249"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN174"><span class='Ref_to_Member'>inner_hashfunctions</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN249"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN175"><span class='Ref_to_Member'>hashStrict</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN249"><span class='Ref_To_Local'>nkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN250"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN251"><span class='Ref_To_Local'>ho</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN241"><span class='Ref_to_Parameter'>hashOperators</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN323"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>hashop</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN251"><span class='Ref_To_Local'>ho</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN324"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>left_hashfn</span><span class='Delimiter'>; 
</span><a name="LN325"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>right_hashfn</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/lsyscache.h.html#LN79"><span class='Ref_to_Proto'>get_op_hash_functions</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN323"><span class='Ref_To_Local'>hashop</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN324"><span class='Ref_To_Local'>left_hashfn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN325"><span class='Ref_To_Local'>right_hashfn</span></a><span class='Parentheses'>))</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find hash function for hash operator %u"</span><span class='Delimiter'>, 
</span>                 <a href="nodeHash.c.html#LN323"><span class='Ref_To_Local'>hashop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/fmgr.h.html#LN92"><span class='Ref_to_Proto'>fmgr_info</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN324"><span class='Ref_To_Local'>left_hashfn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN173"><span class='Ref_to_Member'>outer_hashfunctions</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN250"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/fmgr.h.html#LN92"><span class='Ref_to_Proto'>fmgr_info</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN325"><span class='Ref_To_Local'>right_hashfn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN174"><span class='Ref_to_Member'>inner_hashfunctions</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN250"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN175"><span class='Ref_to_Member'>hashStrict</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN250"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN104"><span class='Ref_to_Proto'>op_strict</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN323"><span class='Ref_To_Local'>hashop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN250"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create temporary memory contexts in which to keep the hashtable working 
     * storage.  See notes in executor/hashjoin.h. 
     */ 
</span>    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN183"><span class='Ref_to_Member'>hashCxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                               <span class='String'>"HashTableContext"</span><span class='Delimiter'>, 
</span>                                               <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN183"><span class='Ref_to_Member'>hashCxt</span></a><span class='Delimiter'>, 
</span>                                                <span class='String'>"HashBatchContext"</span><span class='Delimiter'>, 
</span>                                                <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate data that will live for the life of the hashjoin */ 
</span> 
    <a href="nodeHash.c.html#LN252"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN183"><span class='Ref_to_Member'>hashCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * allocate and initialize the file arrays in hashCxt 
         */ 
</span>        <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* The files will not be opened until needed... */ 
</span>        <span class='Comment_Multi_Line'>/* ... but make sure we have temp tablespaces established for them */ 
</span>        <a href="../../include/commands/tablespace.h.html#LN53"><span class='Ref_to_Proto'>PrepareTempTablespaces</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare context for the first-scan space allocations; allocate the 
     * hashbucket array therein, and set each bucket "empty". 
     */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN245"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up for skew optimization, if possible and there's a need for more 
     * than one batch.  (In a one-batch join, there's no point in it.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN246"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN42"><span class='Ref_to_Proto'>ExecHashBuildSkewHash</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN241"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN247"><span class='Ref_To_Local'>num_skew_mcvs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN252"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="nodeHash.c.html#LN243"><span class='Ref_To_Local'>hashtable</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashTableCreate &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Compute appropriate size for hashtable given the estimated size of the 
 * relation to be hashed (number of rows and average row width). 
 * 
 * This is exported so that the planner's costsize.c can use it. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* Target bucket loading (tuples per bucket) */ 
</span><a name="LN396"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NTUP_PER_BUCKET</span>         <span class='Number'>1</span> 
 
<span class='Keyword'>void 
</span><a name="LN399"></a><span class='Declare_Function'>ExecChooseHashTableSize</span><span class='Parentheses'>(</span><span class='Keyword'>double </span><span class='Declare_Parameter'>ntuples</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tupwidth</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>useskew</span><span class='Delimiter'>, 
</span><a name="LN400"></a>                        <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>numbuckets</span><span class='Delimiter'>, 
</span><a name="LN401"></a>                        <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>numbatches</span><span class='Delimiter'>, 
</span><a name="LN402"></a>                        <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>num_skew_mcvs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN404"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tupsize</span><span class='Delimiter'>; 
</span><a name="LN405"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>inner_rel_bytes</span><span class='Delimiter'>; 
</span><a name="LN406"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>bucket_bytes</span><span class='Delimiter'>; 
</span><a name="LN407"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>hash_table_bytes</span><span class='Delimiter'>; 
</span><a name="LN408"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>skew_table_bytes</span><span class='Delimiter'>; 
</span><a name="LN409"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>max_pointers</span><span class='Delimiter'>; 
</span><a name="LN410"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>mppow2</span><span class='Delimiter'>; 
</span><a name="LN411"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbatch</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN412"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbuckets</span><span class='Delimiter'>; 
</span><a name="LN413"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>dbuckets</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Force a plausible relation size if no info */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN399"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN399"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>= </span><span class='Number'>1000</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Estimate tupsize based on footprint of tuple in hashtable... note this 
     * does not allow for any palloc overhead.  The manipulations of spaceUsed 
     * don't count palloc overhead either. 
     */ 
</span>    <a href="nodeHash.c.html#LN404"><span class='Ref_To_Local'>tupsize</span></a> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN70"><span class='Ref_to_Const'>HJTUPLE_OVERHEAD</span></a> <span class='Operator'>+ 
</span>        <a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../include/access/htup_details.h.html#LN649"><span class='Ref_to_Const'>SizeofMinimalTupleHeader</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN399"><span class='Ref_to_Parameter'>tupwidth</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN405"><span class='Ref_To_Local'>inner_rel_bytes</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN399"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>* </span><a href="nodeHash.c.html#LN404"><span class='Ref_To_Local'>tupsize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Target in-memory hashtable size is work_mem kilobytes. 
     */ 
</span>    <a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If skew optimization is possible, estimate the number of skew buckets 
     * that will fit in the memory allowed, and decrement the assumed space 
     * available for the main hash table accordingly. 
     * 
     * We make the optimistic assumption that each skew bucket will contain 
     * one inner-relation tuple.  If that turns out to be low, we will recover 
     * at runtime by reducing the number of skew buckets. 
     * 
     * hashtable-&GT;skewBucket will have up to 8 times as many HashSkewBucket 
     * pointers as the number of MCVs we allow, since ExecHashBuildSkewHash 
     * will round up to the next power of 2 and then multiply by 4 to reduce 
     * collisions. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN399"><span class='Ref_to_Parameter'>useskew</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nodeHash.c.html#LN408"><span class='Ref_To_Local'>skew_table_bytes</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a> <span class='Operator'>* </span><a href="../../include/executor/hashjoin.h.html#LN101"><span class='Ref_to_Const'>SKEW_WORK_MEM_PERCENT</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/*---------- 
         * Divisor is: 
         * size of a hash tuple + 
         * worst-case size of skewBucket[] per MCV + 
         * size of skewBucketNums[] entry + 
         * size of skew bucket struct itself 
         *---------- 
         */ 
</span>        <span class='Operator'>*</span><a href="nodeHash.c.html#LN402"><span class='Ref_to_Parameter'>num_skew_mcvs</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN408"><span class='Ref_To_Local'>skew_table_bytes</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN404"><span class='Ref_To_Local'>tupsize</span></a> <span class='Operator'>+ 
</span>                                             <span class='Parentheses'>(</span><span class='Number'>8</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>                                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Operator'>+ 
</span>                                             <a href="../../include/executor/hashjoin.h.html#LN99"><span class='Ref_to_Const'>SKEW_BUCKET_OVERHEAD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="nodeHash.c.html#LN402"><span class='Ref_to_Parameter'>num_skew_mcvs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a> <span class='Operator'>-= </span><a href="nodeHash.c.html#LN408"><span class='Ref_To_Local'>skew_table_bytes</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Operator'>*</span><a href="nodeHash.c.html#LN402"><span class='Ref_to_Parameter'>num_skew_mcvs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set nbuckets to achieve an average bucket load of NTUP_PER_BUCKET when 
     * memory is filled, assuming a single batch; but limit the value so that 
     * the pointer arrays we'll try to allocate do not exceed work_mem nor 
     * MaxAllocSize. 
     * 
     * Note that both nbuckets and nbatch must be powers of 2 to make 
     * ExecHashGetBucketAndBatch fast. 
     */ 
</span>    <a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a><span class='Delimiter'>, </span><a href="../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* If max_pointers isn't a power of 2, must round it down to one */ 
</span>    <a href="nodeHash.c.html#LN410"><span class='Ref_To_Local'>mppow2</span></a> <span class='Operator'>= </span><span class='Number'>1L</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a> <span class='Operator'>!= </span><a href="nodeHash.c.html#LN410"><span class='Ref_To_Local'>mppow2</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN410"><span class='Ref_To_Local'>mppow2</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Also ensure we avoid integer overflow in nbatch and nbuckets */ 
</span>    <span class='Comment_Multi_Line'>/* (this step is redundant given the current value of MaxAllocSize) */ 
</span>    <a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a><span class='Delimiter'>, </span>INT_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN413"><span class='Ref_To_Local'>dbuckets</span></a> <span class='Operator'>= </span>ceil<span class='Parentheses'>(</span><a href="nodeHash.c.html#LN399"><span class='Ref_to_Parameter'>ntuples</span></a> <span class='Operator'>/ </span><a href="nodeHash.c.html#LN396"><span class='Ref_to_Const'>NTUP_PER_BUCKET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN413"><span class='Ref_To_Local'>dbuckets</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN413"><span class='Ref_To_Local'>dbuckets</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN413"><span class='Ref_To_Local'>dbuckets</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* don't let nbuckets be really small, though ... */ 
</span>    <a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>, </span><span class='Number'>1024</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ... and force it to be a power of 2. */ 
</span>    <a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's not enough space to store the projected number of tuples and 
     * the required bucket headers, we will need multiple batches. 
     */ 
</span>    <a href="nodeHash.c.html#LN406"><span class='Ref_To_Local'>bucket_bytes</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN405"><span class='Ref_To_Local'>inner_rel_bytes</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN406"><span class='Ref_To_Local'>bucket_bytes</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We'll need multiple batches */ 
</span><a name="LN506"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>lbuckets</span><span class='Delimiter'>; 
</span><a name="LN507"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>dbatch</span><span class='Delimiter'>; 
</span><a name="LN508"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>minbatch</span><span class='Delimiter'>; 
</span><a name="LN509"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>bucket_size</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Estimate the number of buckets we'll want to have when work_mem is 
         * entirely full.  Each bucket will contain a bucket pointer plus 
         * NTUP_PER_BUCKET tuples, whose projected size already includes 
         * overhead for the hash code, pointer to the next tuple, etc. 
         */ 
</span>        <a href="nodeHash.c.html#LN509"><span class='Ref_To_Local'>bucket_size</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN404"><span class='Ref_To_Local'>tupsize</span></a> <span class='Operator'>* </span><a href="nodeHash.c.html#LN396"><span class='Ref_to_Const'>NTUP_PER_BUCKET</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN506"><span class='Ref_To_Local'>lbuckets</span></a> <span class='Operator'>= </span><span class='Number'>1L</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a> <span class='Operator'>/ </span><a href="nodeHash.c.html#LN509"><span class='Ref_To_Local'>bucket_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN506"><span class='Ref_To_Local'>lbuckets</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN506"><span class='Ref_To_Local'>lbuckets</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN506"><span class='Ref_To_Local'>lbuckets</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN406"><span class='Ref_To_Local'>bucket_bytes</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Buckets are simple pointers to hashjoin tuples, while tupsize 
         * includes the pointer, hash code, and MinimalTupleData.  So buckets 
         * should never really exceed 25% of work_mem (even for 
         * NTUP_PER_BUCKET=1); except maybe for work_mem values that are not 
         * 2^N bytes, where we might get more because of doubling. So let's 
         * look for 50% here. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN406"><span class='Ref_To_Local'>bucket_bytes</span></a> <span class='Operator'>&LT;= </span><a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Calculate required number of batches. */ 
</span>        <a href="nodeHash.c.html#LN507"><span class='Ref_To_Local'>dbatch</span></a> <span class='Operator'>= </span>ceil<span class='Parentheses'>(</span><a href="nodeHash.c.html#LN405"><span class='Ref_To_Local'>inner_rel_bytes</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN407"><span class='Ref_To_Local'>hash_table_bytes</span></a> <span class='Operator'>- </span><a href="nodeHash.c.html#LN406"><span class='Ref_To_Local'>bucket_bytes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN507"><span class='Ref_To_Local'>dbatch</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN507"><span class='Ref_To_Local'>dbatch</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN409"><span class='Ref_To_Local'>max_pointers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN508"><span class='Ref_To_Local'>minbatch</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN507"><span class='Ref_To_Local'>dbatch</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN411"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN411"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN508"><span class='Ref_To_Local'>minbatch</span></a><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN411"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if inner_rel_bytes+bucke... &raquo; </span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN411"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="nodeHash.c.html#LN400"><span class='Ref_to_Parameter'>numbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN412"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="nodeHash.c.html#LN401"><span class='Ref_to_Parameter'>numbatches</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN411"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecChooseHashTableSize &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      ExecHashTableDestroy 
 * 
 *      destroy a hash table 
 * ---------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN558"></a><span class='Declare_Function'>ExecHashTableDestroy</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN560"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure all the temp files are closed.  We skip batch 0, since it 
     * can't have any temp files (and the arrays might not even exist if 
     * nbatch is only 1). 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN147"><span class='Ref_to_Member'>nbatch</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../include/storage/buffile.h.html#LN37"><span class='Ref_to_Proto'>BufFileClose</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../include/storage/buffile.h.html#LN37"><span class='Ref_to_Proto'>BufFileClose</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN560"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Release working memory (batchCxt is a child, so it goes away too) */ 
</span>    <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN183"><span class='Ref_to_Member'>hashCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And drop the control block */ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN558"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashTableDestroy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashIncreaseNumBatches 
 *      increase the original number of batches in order to reduce 
 *      current memory consumption 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN588"></a><span class='Declare_Function'>ExecHashIncreaseNumBatches</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN590"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>oldnbatch</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN147"><span class='Ref_to_Member'>nbatch</span></a><span class='Delimiter'>; 
</span><a name="LN591"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>curbatch</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN148"><span class='Ref_to_Member'>curbatch</span></a><span class='Delimiter'>; 
</span><a name="LN592"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbatch</span><span class='Delimiter'>; 
</span><a name="LN593"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN594"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>ninmemory</span><span class='Delimiter'>; 
</span><a name="LN595"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>nfreed</span><span class='Delimiter'>; 
</span><a name="LN596"></a>    <a href="../../include/executor/hashjoin.h.html#LN120"><span class='Ref_to_Typedef'>HashMemoryChunk</span></a> <span class='Declare_Local'>oldchunks</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* do nothing if we've decided to shut off growth */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN153"><span class='Ref_to_Member'>growEnabled</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* safety check to avoid overflow */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN590"><span class='Ref_To_Local'>oldnbatch</span></a> <span class='Operator'>&GT; </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span>INT_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>2</span><span class='Parentheses'>)))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN590"><span class='Ref_To_Local'>oldnbatch</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HJDEBUG 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Hashjoin %p: increasing nbatch to %d because space = %zu\n"</span><span class='Delimiter'>, 
</span>           <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="nodeHash.c.html#LN593"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN183"><span class='Ref_to_Member'>hashCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we had no file arrays before */ 
</span>        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* time to establish the temp tablespaces, too */ 
</span>        <a href="../../include/commands/tablespace.h.html#LN53"><span class='Ref_to_Proto'>PrepareTempTablespaces</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* enlarge arrays and zero out added entries */ 
</span>        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN590"><span class='Ref_To_Local'>oldnbatch</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>- </span><a href="nodeHash.c.html#LN590"><span class='Ref_To_Local'>oldnbatch</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN166"><span class='Ref_to_Member'>outerBatchFile</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN590"><span class='Ref_To_Local'>oldnbatch</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>- </span><a href="nodeHash.c.html#LN590"><span class='Ref_To_Local'>oldnbatch</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN593"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN147"><span class='Ref_to_Member'>nbatch</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN592"><span class='Ref_To_Local'>nbatch</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan through the existing hash table entries and dump out any that are 
     * no longer of the current batch. 
     */ 
</span>    <a href="nodeHash.c.html#LN594"><span class='Ref_To_Local'>ninmemory</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN595"><span class='Ref_To_Local'>nfreed</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If know we need to resize nbuckets, we can do it while rebatching. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>!= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we never decrease the number of buckets */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN128"><span class='Ref_to_Member'>log2_nbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN133"><span class='Ref_to_Member'>log2_nbuckets_optimal</span></a><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>, 
</span>                                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We will scan through the chunks directly, so that we can reset the 
     * buckets now and not have to keep track which tuples in the buckets have 
     * already been processed. We will free the old chunks as we go. 
     */ 
</span>    memset<span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* so, let's scan through the old chunks, and all tuples in each chunk */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN674"></a>        <a href="../../include/executor/hashjoin.h.html#LN120"><span class='Ref_to_Typedef'>HashMemoryChunk</span></a> <span class='Declare_Local'>nextchunk</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* position within the buffer (up to oldchunks-&GT;used) */ 
</span><a name="LN677"></a>        size_t      <span class='Declare_Local'>idx</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* process all tuples stored in this chunk (and then free it) */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN677"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN682"></a>            <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) (</span><a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN117"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN677"><span class='Ref_To_Local'>idx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN683"></a>            <a href="../../include/access/htup.h.html#LN26"><span class='Ref_to_Typedef'>MinimalTuple</span></a> <span class='Declare_Local'>tuple</span> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN682"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN684"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>hashTupleSize</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN70"><span class='Ref_to_Const'>HJTUPLE_OVERHEAD</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN683"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup_details.h.html#LN628"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN685"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bucketno</span><span class='Delimiter'>; 
</span><a name="LN686"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>batchno</span><span class='Delimiter'>; 
</span> 
            <a href="nodeHash.c.html#LN594"><span class='Ref_To_Local'>ninmemory</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="../../include/executor/nodeHash.h.html#LN36"><span class='Ref_to_Proto'>ExecHashGetBucketAndBatch</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN682"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN66"><span class='Ref_to_Member'>hashvalue</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="nodeHash.c.html#LN685"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN686"><span class='Ref_To_Local'>batchno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN686"><span class='Ref_To_Local'>batchno</span></a> <span class='Operator'>== </span><a href="nodeHash.c.html#LN591"><span class='Ref_To_Local'>curbatch</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* keep tuple in memory - copy it into the new chunk */ 
</span><a name="LN695"></a>                <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>copyTuple</span><span class='Delimiter'>; 
</span> 
                <a href="nodeHash.c.html#LN695"><span class='Ref_To_Local'>copyTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN50"><span class='Ref_to_Proto'>dense_alloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN684"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="nodeHash.c.html#LN695"><span class='Ref_To_Local'>copyTuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN682"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN684"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* and add it back to the appropriate bucket */ 
</span>                <a href="nodeHash.c.html#LN695"><span class='Ref_To_Local'>copyTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN685"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>]; 
</span>                <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN685"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="nodeHash.c.html#LN695"><span class='Ref_To_Local'>copyTuple</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* dump it out */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN686"><span class='Ref_To_Local'>batchno</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN591"><span class='Ref_To_Local'>curbatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/executor/nodeHashjoin.h.html#LN24"><span class='Ref_to_Proto'>ExecHashJoinSaveTuple</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN682"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="nodeHash.c.html#LN682"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN66"><span class='Ref_to_Member'>hashvalue</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN686"><span class='Ref_To_Local'>batchno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>-= </span><a href="nodeHash.c.html#LN684"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Delimiter'>; 
</span>                <a href="nodeHash.c.html#LN595"><span class='Ref_To_Local'>nfreed</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* next tuple in this chunk */ 
</span>            <a href="nodeHash.c.html#LN677"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>+= </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN684"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* allow this loop to be cancellable */ 
</span>            <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while idx&LT;oldchunks-&GT;used &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* we're done with this chunk - free it and proceed to the next one */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN596"><span class='Ref_To_Local'>oldchunks</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN674"><span class='Ref_To_Local'>nextchunk</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while oldchunks!=NULL &raquo; </span> 
 
<span class='Directive'>#ifdef</span> HJDEBUG 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Hashjoin %p: freed %ld of %ld tuples, space now %zu\n"</span><span class='Delimiter'>, 
</span>           <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN595"><span class='Ref_To_Local'>nfreed</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN594"><span class='Ref_To_Local'>ninmemory</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we dumped out either all or none of the tuples in the table, disable 
     * further expansion of nbatch.  This situation implies that we have 
     * enough tuples of identical hashvalues to overflow spaceAllowed. 
     * Increasing nbatch will not fix it since there's no way to subdivide the 
     * group any more finely. We have to just gut it out and hope the server 
     * has enough RAM. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN595"><span class='Ref_To_Local'>nfreed</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="nodeHash.c.html#LN595"><span class='Ref_To_Local'>nfreed</span></a> <span class='Operator'>== </span><a href="nodeHash.c.html#LN594"><span class='Ref_To_Local'>ninmemory</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN153"><span class='Ref_to_Member'>growEnabled</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HJDEBUG 
        <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Hashjoin %p: disabling further increase of nbatch\n"</span><span class='Delimiter'>, 
</span>               <a href="nodeHash.c.html#LN588"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashIncreaseNumBatches &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashIncreaseNumBuckets 
 *      increase the original number of buckets in order to reduce 
 *      number of tuples per bucket 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN757"></a><span class='Declare_Function'>ExecHashIncreaseNumBuckets</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN759"></a>    <a href="../../include/executor/hashjoin.h.html#LN120"><span class='Ref_to_Typedef'>HashMemoryChunk</span></a> <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* do nothing if not an increase (it's called increase for a reason) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>&GT;= </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HJDEBUG 
    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"Hashjoin %p: increasing nbuckets %d =&GT; %d\n"</span><span class='Delimiter'>, 
</span>           <a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN128"><span class='Ref_to_Member'>log2_nbuckets</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN133"><span class='Ref_to_Member'>log2_nbuckets_optimal</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span>INT_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN128"><span class='Ref_to_Member'>log2_nbuckets</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Just reallocate the proper number of buckets - we don't need to walk 
     * through them - we can walk the dense-allocated chunks (just like in 
     * ExecHashIncreaseNumBatches, but without all the copying into new 
     * chunks) 
     */ 
</span>    <a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>, 
</span>                                <a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* scan through all tuples in all chunks to rebuild the hash table */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN759"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN759"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN759"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN759"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* process all tuples stored in this chunk */ 
</span><a name="LN793"></a>        size_t      <span class='Declare_Local'>idx</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN793"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN759"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN797"></a>            <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) (</span><a href="nodeHash.c.html#LN759"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN117"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN793"><span class='Ref_To_Local'>idx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN798"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bucketno</span><span class='Delimiter'>; 
</span><a name="LN799"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>batchno</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/executor/nodeHash.h.html#LN36"><span class='Ref_to_Proto'>ExecHashGetBucketAndBatch</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN797"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN66"><span class='Ref_to_Member'>hashvalue</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="nodeHash.c.html#LN798"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN799"><span class='Ref_To_Local'>batchno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* add the tuple to the proper bucket */ 
</span>            <a href="nodeHash.c.html#LN797"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN798"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>]; 
</span>            <a href="nodeHash.c.html#LN757"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN798"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="nodeHash.c.html#LN797"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* advance index past the tuple */ 
</span>            <a href="nodeHash.c.html#LN793"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>+= </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN70"><span class='Ref_to_Const'>HJTUPLE_OVERHEAD</span></a> <span class='Operator'>+ 
</span>                            <a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN797"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>t_len<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for chunk=hashtable-&GT;chun... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ExecHashIncreaseNumBuckets &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashTableInsert 
 *      insert a tuple into the hash table depending on the hash value 
 *      it may just go to a temp file for later batches 
 * 
 * Note: the passed TupleTableSlot may contain a regular, minimal, or virtual 
 * tuple; the minimal case in particular is certain to happen while reloading 
 * tuples from batch files.  We could save some cycles in the regular-tuple 
 * case by not forcing the slot contents into minimal form; not clear if it's 
 * worth the messiness required. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN828"></a><span class='Declare_Function'>ExecHashTableInsert</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, 
</span><a name="LN829"></a>                    <a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, 
</span><a name="LN830"></a>                    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN832"></a>    <a href="../../include/access/htup.h.html#LN26"><span class='Ref_to_Typedef'>MinimalTuple</span></a> <span class='Declare_Local'>tuple</span> <span class='Operator'>= </span><a href="../../include/executor/tuptable.h.html#LN160"><span class='Ref_to_Proto'>ExecFetchSlotMinimalTuple</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN829"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN833"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bucketno</span><span class='Delimiter'>; 
</span><a name="LN834"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>batchno</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/executor/nodeHash.h.html#LN36"><span class='Ref_to_Proto'>ExecHashGetBucketAndBatch</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN830"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="nodeHash.c.html#LN833"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN834"><span class='Ref_To_Local'>batchno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * decide whether to put the tuple in the hash table or a temp file 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN834"><span class='Ref_To_Local'>batchno</span></a> <span class='Operator'>== </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN148"><span class='Ref_to_Member'>curbatch</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * put the tuple in hash table 
         */ 
</span><a name="LN847"></a>        <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span><span class='Delimiter'>; 
</span><a name="LN848"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>hashTupleSize</span><span class='Delimiter'>; 
</span><a name="LN849"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>ntuples</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN155"><span class='Ref_to_Member'>totalTuples</span></a> <span class='Operator'>- </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN156"><span class='Ref_to_Member'>skewTuples</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Create the HashJoinTuple */ 
</span>        <a href="nodeHash.c.html#LN848"><span class='Ref_To_Local'>hashTupleSize</span></a> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN70"><span class='Ref_to_Const'>HJTUPLE_OVERHEAD</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN832"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup_details.h.html#LN628"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN847"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN50"><span class='Ref_to_Proto'>dense_alloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN848"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN847"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN66"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN830"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN847"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN832"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN832"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup_details.h.html#LN628"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We always reset the tuple-matched flag on insertion.  This is okay 
         * even when reloading a tuple from a batch file, since the tuple 
         * could not possibly have been matched to an outer tuple before it 
         * went into the batch file. 
         */ 
</span>        <a href="../../include/access/htup_details.h.html#LN526"><span class='Ref_to_Macro'>HeapTupleHeaderClearMatch</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN847"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Push it onto the front of the bucket's list */ 
</span>        <a href="nodeHash.c.html#LN847"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN833"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>]; 
</span>        <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN833"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="nodeHash.c.html#LN847"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Increase the (optimal) number of buckets if we just exceeded the 
         * NTUP_PER_BUCKET threshold, but only when there's still a single 
         * batch. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN147"><span class='Ref_to_Member'>nbatch</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>&& 
</span>            <a href="nodeHash.c.html#LN849"><span class='Ref_To_Local'>ntuples</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>* </span><a href="nodeHash.c.html#LN396"><span class='Ref_to_Const'>NTUP_PER_BUCKET</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Guard against integer overflow and alloc size overflow */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>&LT;= </span>INT_MAX <span class='Operator'>/ </span><span class='Number'>2</span> <span class='Operator'>&& 
</span>                <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>&LT;= </span><a href="../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>                <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN133"><span class='Ref_to_Member'>log2_nbuckets_optimal</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Account for space used, and back off if we've used too much */ 
</span>        <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN848"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>+ 
</span>            <a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN132"><span class='Ref_to_Member'>nbuckets_optimal</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN178"><span class='Ref_to_Member'>spaceAllowed</span></a><span class='Parentheses'>)</span> 
            <a href="nodeHash.c.html#LN40"><span class='Ref_to_Proto'>ExecHashIncreaseNumBatches</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if batchno==hashtable-&GT;c... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * put the tuple into a temp file for later batches 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN834"><span class='Ref_To_Local'>batchno</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN148"><span class='Ref_to_Member'>curbatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/executor/nodeHashjoin.h.html#LN24"><span class='Ref_to_Proto'>ExecHashJoinSaveTuple</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN832"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, 
</span>                              <a href="nodeHash.c.html#LN830"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="nodeHash.c.html#LN828"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN834"><span class='Ref_To_Local'>batchno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashTableInsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashGetHashValue 
 *      Compute the hash value for a tuple 
 * 
 * The tuple to be tested must be in either econtext-&GT;ecxt_outertuple or 
 * econtext-&GT;ecxt_innertuple.  Vars in the hashkeys expressions should have 
 * varno either OUTER_VAR or INNER_VAR. 
 * 
 * A TRUE result means the tuple's hash value has been successfully computed 
 * and stored at *hashvalue.  A FALSE result means the tuple cannot match 
 * because it contains a null attribute, and hence it should be discarded 
 * immediately.  (If keep_nulls is true then FALSE is never returned.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN922"></a><span class='Declare_Function'>ExecHashGetHashValue</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, 
</span><a name="LN923"></a>                     <a href="../../include/nodes/execnodes.h.html#LN191"><span class='Ref_to_Struct'>ExprContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>econtext</span><span class='Delimiter'>, 
</span><a name="LN924"></a>                     <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashkeys</span><span class='Delimiter'>, 
</span><a name="LN925"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>outer_tuple</span><span class='Delimiter'>, 
</span><a name="LN926"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>keep_nulls</span><span class='Delimiter'>, 
</span><a name="LN927"></a>                     <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN929"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashkey</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN930"></a>    <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>hashfunctions</span><span class='Delimiter'>; 
</span><a name="LN931"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>hk</span><span class='Delimiter'>; 
</span><a name="LN932"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN933"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldContext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We reset the eval context each time to reclaim any memory leaked in the 
     * hashkey expressions. 
     */ 
</span>    <a href="../../include/executor/executor.h.html#LN449"><span class='Ref_to_Macro'>ResetExprContext</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN923"><span class='Ref_to_Parameter'>econtext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN933"><span class='Ref_To_Local'>oldContext</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN923"><span class='Ref_to_Parameter'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN202"><span class='Ref_to_Member'>ecxt_per_tuple_memory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN925"><span class='Ref_to_Parameter'>outer_tuple</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN930"><span class='Ref_To_Local'>hashfunctions</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN922"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN173"><span class='Ref_to_Member'>outer_hashfunctions</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nodeHash.c.html#LN930"><span class='Ref_To_Local'>hashfunctions</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN922"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN174"><span class='Ref_to_Member'>inner_hashfunctions</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN931"><span class='Ref_To_Local'>hk</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN924"><span class='Ref_to_Parameter'>hashkeys</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN950"></a>        <a href="../../include/nodes/execnodes.h.html#LN52"><span class='Ref_to_Struct'>ExprState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>keyexpr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN52"><span class='Ref_to_Struct'>ExprState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN931"><span class='Ref_To_Local'>hk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN951"></a>        <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>keyval</span><span class='Delimiter'>; 
</span><a name="LN952"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* rotate hashkey left 1 bit at each step */ 
</span>        <a href="nodeHash.c.html#LN929"><span class='Ref_To_Local'>hashkey</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN929"><span class='Ref_To_Local'>hashkey</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>| </span><span class='Parentheses'>((</span><a href="nodeHash.c.html#LN929"><span class='Ref_To_Local'>hashkey</span></a> <span class='Operator'>& </span><span class='Number'>0x80000000</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get the join attribute value of the tuple 
         */ 
</span>        <a href="nodeHash.c.html#LN951"><span class='Ref_To_Local'>keyval</span></a> <span class='Operator'>= </span><a href="../../include/executor/executor.h.html#LN264"><span class='Ref_to_Func'>ExecEvalExpr</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN950"><span class='Ref_To_Local'>keyexpr</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN923"><span class='Ref_to_Parameter'>econtext</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN952"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the attribute is NULL, and the join operator is strict, then 
         * this tuple cannot pass the join qual so we can reject it 
         * immediately (unless we're scanning the outside of an outer join, in 
         * which case we must not reject it).  Otherwise we act like the 
         * hashcode of NULL is zero (this will support operators that act like 
         * IS NOT DISTINCT, though not any more-random behavior).  We treat 
         * the hash support function as strict even if the operator is not. 
         * 
         * Note: currently, all hashjoinable operators must be strict since 
         * the hash index AM assumes that.  However, it takes so little extra 
         * code here to allow non-strict that we may as well do it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN952"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN922"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN175"><span class='Ref_to_Member'>hashStrict</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN932"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&& !</span><a href="nodeHash.c.html#LN926"><span class='Ref_to_Parameter'>keep_nulls</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN933"><span class='Ref_To_Local'>oldContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* cannot match */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* else, leave hashkey unmodified, equivalent to hashcode 0 */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Compute the hash function */ 
</span><a name="LN987"></a>            <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hkey</span><span class='Delimiter'>; 
</span> 
            <a href="nodeHash.c.html#LN987"><span class='Ref_To_Local'>hkey</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN491"><span class='Ref_to_Macro'>DatumGetUInt32</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN601"><span class='Ref_to_Macro'>FunctionCall1</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN930"><span class='Ref_To_Local'>hashfunctions</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN932"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="nodeHash.c.html#LN951"><span class='Ref_To_Local'>keyval</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN929"><span class='Ref_To_Local'>hashkey</span></a> <span class='Operator'>^= </span><a href="nodeHash.c.html#LN987"><span class='Ref_To_Local'>hkey</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="nodeHash.c.html#LN932"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN933"><span class='Ref_To_Local'>oldContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="nodeHash.c.html#LN927"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN929"><span class='Ref_To_Local'>hashkey</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashGetHashValue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashGetBucketAndBatch 
 *      Determine the bucket number and batch number for a hash value 
 * 
 * Note: on-the-fly increases of nbatch must not change the bucket number 
 * for a given hash code (since we don't move tuples to different hash 
 * chains), and must only cause the batch number to remain the same or 
 * increase.  Our algorithm is 
 *      bucketno = hashvalue MOD nbuckets 
 *      batchno = (hashvalue DIV nbuckets) MOD nbatch 
 * where nbuckets and nbatch are both expected to be powers of 2, so we can 
 * do the computations by shifting and masking.  (This assumes that all hash 
 * functions are good about randomizing all their output bits, else we are 
 * likely to have very skewed bucket or batch occupancy.) 
 * 
 * nbuckets and log2_nbuckets may change while nbatch == 1 because of dynamic 
 * bucket count growth.  Once we start batching, the value is fixed and does 
 * not change over the course of the join (making it possible to compute batch 
 * number the way we do here). 
 * 
 * nbatch is always a power of 2; we increase it only by doubling it.  This 
 * effectively adds one more bit to the top of the batchno. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1026"></a><span class='Declare_Function'>ExecHashGetBucketAndBatch</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, 
</span><a name="LN1027"></a>                          <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Delimiter'>, 
</span><a name="LN1028"></a>                          <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>bucketno</span><span class='Delimiter'>, 
</span><a name="LN1029"></a>                          <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>batchno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1031"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>nbuckets</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN1026"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Delimiter'>; 
</span><a name="LN1032"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>nbatch</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN1026"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN147"><span class='Ref_to_Member'>nbatch</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1032"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we can do MOD by masking, DIV by shifting */ 
</span>        <span class='Operator'>*</span><a href="nodeHash.c.html#LN1028"><span class='Ref_to_Parameter'>bucketno</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1027"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1031"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="nodeHash.c.html#LN1029"><span class='Ref_to_Parameter'>batchno</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1027"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>&GT;&GT; </span><a href="nodeHash.c.html#LN1026"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN128"><span class='Ref_to_Member'>log2_nbuckets</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1032"><span class='Ref_To_Local'>nbatch</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="nodeHash.c.html#LN1028"><span class='Ref_to_Parameter'>bucketno</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1027"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1031"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="nodeHash.c.html#LN1029"><span class='Ref_to_Parameter'>batchno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashGetBucketAndBatch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecScanHashBucket 
 *      scan a hash bucket for matches to the current outer tuple 
 * 
 * The current outer tuple must be stored in econtext-&GT;ecxt_outertuple. 
 * 
 * On success, the inner tuple is stored into hjstate-&GT;hj_CurTuple and 
 * econtext-&GT;ecxt_innertuple, using hjstate-&GT;hj_HashTupleSlot as the slot 
 * for the latter. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1058"></a><span class='Declare_Function'>ExecScanHashBucket</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1648"><span class='Ref_to_Struct'>HashJoinState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hjstate</span><span class='Delimiter'>, 
</span><a name="LN1059"></a>                   <a href="../../include/nodes/execnodes.h.html#LN191"><span class='Ref_to_Struct'>ExprContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>econtext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1061"></a>    <a href="../../include/nodes/execnodes.h.html#LN52"><span class='Ref_to_Struct'>ExprState</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>hjclauses</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1651"><span class='Ref_to_Member'>hashclauses</span></a><span class='Delimiter'>; 
</span><a name="LN1062"></a>    <a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Local'>hashtable</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1655"><span class='Ref_to_Member'>hj_HashTable</span></a><span class='Delimiter'>; 
</span><a name="LN1063"></a>    <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1659"><span class='Ref_to_Member'>hj_CurTuple</span></a><span class='Delimiter'>; 
</span><a name="LN1064"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashvalue</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1656"><span class='Ref_to_Member'>hj_CurHashValue</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * hj_CurTuple is the address of the tuple last returned from the current 
     * bucket, or NULL if it's time to start scanning a new bucket. 
     * 
     * If the tuple hashed to a skew bucket then scan the skew bucket 
     * otherwise scan the standard hashtable bucket. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1658"><span class='Ref_to_Member'>hj_CurSkewBucketNo</span></a> <span class='Operator'>!= </span><a href="../../include/executor/hashjoin.h.html#LN100"><span class='Ref_to_Const'>INVALID_SKEW_BUCKET_NO</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1062"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1658"><span class='Ref_to_Member'>hj_CurSkewBucketNo</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1062"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1657"><span class='Ref_to_Member'>hj_CurBucketNo</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN66"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>== </span><a href="nodeHash.c.html#LN1064"><span class='Ref_To_Local'>hashvalue</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1084"></a>            <a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>inntuple</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* insert hashtable's tuple into exec slot so ExecQual sees it */ 
</span>            <a href="nodeHash.c.html#LN1084"><span class='Ref_To_Local'>inntuple</span></a> <span class='Operator'>= </span><a href="../../include/executor/tuptable.h.html#LN151"><span class='Ref_to_Proto'>ExecStoreMinimalTuple</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1661"><span class='Ref_to_Member'>hj_HashTupleSlot</span></a><span class='Delimiter'>, 
</span>                                             <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* do not pfree */ 
</span>            <a href="nodeHash.c.html#LN1059"><span class='Ref_to_Parameter'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN197"><span class='Ref_to_Member'>ecxt_innertuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1084"><span class='Ref_To_Local'>inntuple</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* reset temp memory each time to avoid leaks from qual expr */ 
</span>            <a href="../../include/executor/executor.h.html#LN449"><span class='Ref_to_Macro'>ResetExprContext</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1059"><span class='Ref_to_Parameter'>econtext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/executor/executor.h.html#LN344"><span class='Ref_to_Func'>ExecQual</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1061"><span class='Ref_To_Local'>hjclauses</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1059"><span class='Ref_to_Parameter'>econtext</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="nodeHash.c.html#LN1058"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1659"><span class='Ref_to_Member'>hj_CurTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1063"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while hashTuple!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * no match 
     */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecScanHashBucket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecPrepHashTableForUnmatched 
 *      set up for a series of ExecScanHashTableForUnmatched calls 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1116"></a><span class='Declare_Function'>ExecPrepHashTableForUnmatched</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1648"><span class='Ref_to_Struct'>HashJoinState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hjstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/*---------- 
     * During this scan we use the HashJoinState fields as follows: 
     * 
     * hj_CurBucketNo: next regular bucket to scan 
     * hj_CurSkewBucketNo: next skew bucket (an index into skewBucketNums) 
     * hj_CurTuple: last tuple returned, or NULL to start next bucket 
     *---------- 
     */ 
</span>    <a href="nodeHash.c.html#LN1116"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1657"><span class='Ref_to_Member'>hj_CurBucketNo</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1116"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1658"><span class='Ref_to_Member'>hj_CurSkewBucketNo</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1116"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1659"><span class='Ref_to_Member'>hj_CurTuple</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ExecScanHashTableForUnmatched 
 *      scan the hash table for unmatched inner tuples 
 * 
 * On success, the inner tuple is stored into hjstate-&GT;hj_CurTuple and 
 * econtext-&GT;ecxt_innertuple, using hjstate-&GT;hj_HashTupleSlot as the slot 
 * for the latter. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1140"></a><span class='Declare_Function'>ExecScanHashTableForUnmatched</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1648"><span class='Ref_to_Struct'>HashJoinState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hjstate</span><span class='Delimiter'>, </span><a href="../../include/nodes/execnodes.h.html#LN191"><span class='Ref_to_Struct'>ExprContext</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>econtext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1142"></a>    <a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Local'>hashtable</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1655"><span class='Ref_to_Member'>hj_HashTable</span></a><span class='Delimiter'>; 
</span><a name="LN1143"></a>    <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1659"><span class='Ref_to_Member'>hj_CurTuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * hj_CurTuple is the address of the tuple last returned from the 
         * current bucket, or NULL if it's time to start scanning a new 
         * bucket. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1657"><span class='Ref_to_Member'>hj_CurBucketNo</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1142"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1142"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1657"><span class='Ref_to_Member'>hj_CurBucketNo</span></a><span class='Delimiter'>]; 
</span>            <a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1657"><span class='Ref_to_Member'>hj_CurBucketNo</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1658"><span class='Ref_to_Member'>hj_CurSkewBucketNo</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1142"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1161"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1142"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1658"><span class='Ref_to_Member'>hj_CurSkewBucketNo</span></a><span class='Delimiter'>]; 
</span> 
            <a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1142"><span class='Ref_To_Local'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1161"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1658"><span class='Ref_to_Member'>hj_CurSkewBucketNo</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* finished all buckets */ 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup_details.h.html#LN516"><span class='Ref_to_Macro'>HeapTupleHeaderHasMatch</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1173"></a>                <a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>inntuple</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* insert hashtable's tuple into exec slot */ 
</span>                <a href="nodeHash.c.html#LN1173"><span class='Ref_To_Local'>inntuple</span></a> <span class='Operator'>= </span><a href="../../include/executor/tuptable.h.html#LN151"><span class='Ref_to_Proto'>ExecStoreMinimalTuple</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                 <a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1661"><span class='Ref_to_Member'>hj_HashTupleSlot</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* do not pfree */ 
</span>                <a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN197"><span class='Ref_to_Member'>ecxt_innertuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1173"><span class='Ref_To_Local'>inntuple</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Reset temp memory each time; although this function doesn't 
                 * do any qual eval, the caller will, so let's keep it 
                 * parallel to ExecScanHashBucket. 
                 */ 
</span>                <a href="../../include/executor/executor.h.html#LN449"><span class='Ref_to_Macro'>ResetExprContext</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>econtext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="nodeHash.c.html#LN1140"><span class='Ref_to_Parameter'>hjstate</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1659"><span class='Ref_to_Member'>hj_CurTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !HeapTupleHeaderHasMa... &raquo; </span> 
 
            <a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1143"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while hashTuple!=NULL &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * no more unmatched tuples 
     */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecScanHashTableForUnmatched &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashTableReset 
 * 
 *      reset hash table header for new batch 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1208"></a><span class='Declare_Function'>ExecHashTableReset</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1210"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN1211"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbuckets</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1208"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release all the hash buckets and tuples acquired in the prior pass, and 
     * reinitialize the context for a new pass. 
     */ 
</span>    <a href="../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1208"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1210"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1208"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reallocate and reinitialize the hash bucket headers. */ 
</span>    <a href="nodeHash.c.html#LN1208"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1211"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="nodeHash.c.html#LN1208"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1210"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Forget the chunks (the memory was freed by the context reset above). */ 
</span>    <a href="nodeHash.c.html#LN1208"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashTableReset &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashTableResetMatchFlags 
 *      Clear all the HeapTupleHeaderHasMatch flags in the table 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1237"></a><span class='Declare_Function'>ExecHashTableResetMatchFlags</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1239"></a>    <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1240"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset all flags in the main table ... */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1237"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN127"><span class='Ref_to_Member'>nbuckets</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1237"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; </span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/access/htup_details.h.html#LN526"><span class='Ref_to_Macro'>HeapTupleHeaderClearMatch</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* ... and the same for the skew buckets, if any */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1237"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1252"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1237"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1240"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1253"></a>        <a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Declare_Local'>skewBucket</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1237"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1252"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1253"><span class='Ref_To_Local'>skewBucket</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/access/htup_details.h.html#LN526"><span class='Ref_to_Macro'>HeapTupleHeaderClearMatch</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1239"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashTableResetMatchFlags &raquo; </span> 
 
 
<span class='Keyword'>void 
</span><a name="LN1262"></a><span class='Declare_Function'>ExecReScanHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1920"><span class='Ref_to_Struct'>HashState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * if chgParam of subnode is not null then plan will be re-scanned by 
     * first ExecProcNode. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1262"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN827"><span class='Ref_to_Member'>lefttree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN836"><span class='Ref_to_Member'>chgParam</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="execAmi.c.html#LN73"><span class='Ref_to_Func'>ExecReScan</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1262"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/execnodes.h.html#LN1922"><span class='Ref_to_Member'>ps</span></a><span class='Operator'>.</span><a href="../../include/nodes/execnodes.h.html#LN827"><span class='Ref_to_Member'>lefttree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashBuildSkewHash 
 * 
 *      Set up for skew optimization if we can identify the most common values 
 *      (MCVs) of the outer relation's join key.  We make a skew hash bucket 
 *      for the hash value of each MCV, up to the number of slots allowed 
 *      based on available memory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1282"></a><span class='Declare_Function'>ExecHashBuildSkewHash</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, </span><a href="../../include/nodes/plannodes.h.html#LN863"><span class='Ref_to_Struct'>Hash</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>mcvsToUse</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1284"></a>    <a href="../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>statsTuple</span><span class='Delimiter'>; 
</span><a name="LN1285"></a>    <a href="../../include/utils/lsyscache.h.html#LN42"><span class='Ref_to_Struct'>AttStatsSlot</span></a> <span class='Declare_Local'>sslot</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do nothing if planner didn't identify the outer relation's join key */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN866"><span class='Ref_to_Member'>skewTable</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Also, do nothing if we don't have room for at least one skew bucket */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to find the MCV statistics for the outer relation's join key. 
     */ 
</span>    <a href="nodeHash.c.html#LN1284"><span class='Ref_To_Local'>statsTuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN159"><span class='Ref_to_Macro'>SearchSysCache3</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN90"><span class='Ref_to_EnumConst'>STATRELATTINH</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN866"><span class='Ref_to_Member'>skewTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/postgres.h.html#LN456"><span class='Ref_to_Macro'>Int16GetDatum</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN867"><span class='Ref_to_Member'>skewColumn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>node</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/plannodes.h.html#LN868"><span class='Ref_to_Member'>skewInherit</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1284"><span class='Ref_To_Local'>statsTuple</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN172"><span class='Ref_to_Proto'>get_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1284"><span class='Ref_To_Local'>statsTuple</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/catalog/pg_statistic.h.html#LN203"><span class='Ref_to_Const'>STATISTIC_KIND_MCV</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/utils/lsyscache.h.html#LN38"><span class='Ref_to_Const'>ATTSTATSSLOT_VALUES</span></a> <span class='Operator'>| </span><a href="../../include/utils/lsyscache.h.html#LN39"><span class='Ref_to_Const'>ATTSTATSSLOT_NUMBERS</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1308"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>frac</span><span class='Delimiter'>; 
</span><a name="LN1309"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nbuckets</span><span class='Delimiter'>; 
</span><a name="LN1310"></a>        <a href="../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>hashfunctions</span><span class='Delimiter'>; 
</span><a name="LN1311"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../include/utils/lsyscache.h.html#LN49"><span class='Ref_to_Member'>nvalues</span></a><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../include/utils/lsyscache.h.html#LN49"><span class='Ref_to_Member'>nvalues</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate the expected fraction of outer relation that will 
         * participate in the skew optimization.  If this isn't at least 
         * SKEW_MIN_OUTER_FRACTION, don't use skew optimization. 
         */ 
</span>        <a href="nodeHash.c.html#LN1308"><span class='Ref_To_Local'>frac</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN1308"><span class='Ref_To_Local'>frac</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../include/utils/lsyscache.h.html#LN51"><span class='Ref_to_Member'>numbers</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1308"><span class='Ref_To_Local'>frac</span></a> <span class='Operator'>&LT; </span><a href="../../include/executor/hashjoin.h.html#LN102"><span class='Ref_to_Const'>SKEW_MIN_OUTER_FRACTION</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/lsyscache.h.html#LN174"><span class='Ref_to_Proto'>free_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1284"><span class='Ref_To_Local'>statsTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Okay, set up the skew hashtable. 
         * 
         * skewBucket[] is an open addressing hashtable with a power of 2 size 
         * that is greater than the number of MCV values.  (This ensures there 
         * will be at least one null entry, so searches will always 
         * terminate.) 
         * 
         * Note: this code could fail if mcvsToUse exceeds INT_MAX/8 or 
         * MaxAllocSize/sizeof(void *)/8, but that is not currently possible 
         * since we limit pg_statistic entries to much less than that. 
         */ 
</span>        <a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&LT;= </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* use two more bits just to help avoid collisions */ 
</span>        <a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN141"><span class='Ref_to_Member'>skewEnabled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN143"><span class='Ref_to_Member'>skewBucketLen</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We allocate the bucket memory in the hashtable's batch context. It 
         * is only needed during the first batch, and this ensures it will be 
         * automatically removed once the first batch is done. 
         */ 
</span>        <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Delimiter'>, 
</span>                                   <a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Delimiter'>, 
</span>                                   <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Operator'>+ </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Operator'>+ </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a><span class='Parentheses'>) 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create a skew bucket for each MCV hash value. 
         * 
         * Note: it is very important that we create the buckets in order of 
         * decreasing MCV frequency.  If we have to remove some buckets, they 
         * must be removed in reverse order of creation (see notes in 
         * ExecHashRemoveNextSkewBucket) and we want the least common MCVs to 
         * be removed first. 
         */ 
</span>        <a href="nodeHash.c.html#LN1310"><span class='Ref_To_Local'>hashfunctions</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN173"><span class='Ref_to_Member'>outer_hashfunctions</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>mcvsToUse</span></a><span class='Delimiter'>; </span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1384"></a>            <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashvalue</span><span class='Delimiter'>; 
</span><a name="LN1385"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span> 
            <a href="nodeHash.c.html#LN1384"><span class='Ref_To_Local'>hashvalue</span></a> <span class='Operator'>= </span><a href="../../include/postgres.h.html#LN491"><span class='Ref_to_Macro'>DatumGetUInt32</span></a><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN601"><span class='Ref_to_Macro'>FunctionCall1</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN1310"><span class='Ref_To_Local'>hashfunctions</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                                                     <a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../include/utils/lsyscache.h.html#LN48"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1311"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * While we have not hit a hole in the hashtable and have not hit 
             * the desired bucket, we have collided with some previous hash 
             * value, so try the next bucket location.  NB: this code must 
             * match ExecHashGetSkewBucket. 
             */ 
</span>            <a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1384"><span class='Ref_To_Local'>hashvalue</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                   <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN95"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>!= </span><a href="nodeHash.c.html#LN1384"><span class='Ref_To_Local'>hashvalue</span></a><span class='Parentheses'>) 
</span>                <a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1309"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we found an existing bucket with the same hashvalue, leave 
             * it alone.  It's okay for two MCVs to share a hashvalue. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Okay, create a new skew bucket for this hashvalue. */ 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN95"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1384"><span class='Ref_To_Local'>hashvalue</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="nodeHash.c.html#LN1385"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>+= </span><a href="../../include/executor/hashjoin.h.html#LN99"><span class='Ref_to_Const'>SKEW_BUCKET_OVERHEAD</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>+= </span><a href="../../include/executor/hashjoin.h.html#LN99"><span class='Ref_to_Const'>SKEW_BUCKET_OVERHEAD</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a><span class='Parentheses'>) 
</span>                <a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1282"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;mcvsToUse;i++ &raquo; </span> 
 
        <a href="../../include/utils/lsyscache.h.html#LN174"><span class='Ref_to_Proto'>free_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="nodeHash.c.html#LN1285"><span class='Ref_To_Local'>sslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if get_attstatsslot(&ssl... &raquo; </span> 
 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1284"><span class='Ref_To_Local'>statsTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashBuildSkewHash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashGetSkewBucket 
 * 
 *      Returns the index of the skew bucket for this hashvalue, 
 *      or INVALID_SKEW_BUCKET_NO if the hashvalue is not 
 *      associated with any active skew bucket. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1436"></a><span class='Declare_Function'>ExecHashGetSkewBucket</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1438"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Always return INVALID_SKEW_BUCKET_NO if not doing skew optimization (in 
     * particular, this happens after the initial batch is done). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN141"><span class='Ref_to_Member'>skewEnabled</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/executor/hashjoin.h.html#LN100"><span class='Ref_to_Const'>INVALID_SKEW_BUCKET_NO</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since skewBucketLen is a power of 2, we can do a modulo by ANDing. 
     */ 
</span>    <a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN143"><span class='Ref_to_Member'>skewBucketLen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * While we have not hit a hole in the hashtable and have not hit the 
     * desired bucket, we have collided with some other hash value, so try the 
     * next bucket location. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>           <a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN95"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>!= </span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>& </span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN143"><span class='Ref_to_Member'>skewBucketLen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Found the desired bucket? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1436"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="nodeHash.c.html#LN1438"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There must not be any hashtable entry for this hash value. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../include/executor/hashjoin.h.html#LN100"><span class='Ref_to_Const'>INVALID_SKEW_BUCKET_NO</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashGetSkewBucket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExecHashSkewTableInsert 
 * 
 *      Insert a tuple into the skew hashtable. 
 * 
 * This should generally match up with the current-batch case in 
 * ExecHashTableInsert. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1482"></a><span class='Declare_Function'>ExecHashSkewTableInsert</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, 
</span><a name="LN1483"></a>                        <a href="../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, 
</span><a name="LN1484"></a>                        <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Delimiter'>, 
</span><a name="LN1485"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>bucketNumber</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1487"></a>    <a href="../../include/access/htup.h.html#LN26"><span class='Ref_to_Typedef'>MinimalTuple</span></a> <span class='Declare_Local'>tuple</span> <span class='Operator'>= </span><a href="../../include/executor/tuptable.h.html#LN160"><span class='Ref_to_Proto'>ExecFetchSlotMinimalTuple</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1483"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1488"></a>    <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span><span class='Delimiter'>; 
</span><a name="LN1489"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>hashTupleSize</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create the HashJoinTuple */ 
</span>    <a href="nodeHash.c.html#LN1489"><span class='Ref_To_Local'>hashTupleSize</span></a> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN70"><span class='Ref_to_Const'>HJTUPLE_OVERHEAD</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN1487"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup_details.h.html#LN628"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1488"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Delimiter'>, 
</span>                                                   <a href="nodeHash.c.html#LN1489"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1488"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN66"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1484"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1488"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1487"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1487"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup_details.h.html#LN628"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/htup_details.h.html#LN526"><span class='Ref_to_Macro'>HeapTupleHeaderClearMatch</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1488"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Push it onto the front of the skew bucket's list */ 
</span>    <a href="nodeHash.c.html#LN1488"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1485"><span class='Ref_to_Parameter'>bucketNumber</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1485"><span class='Ref_to_Parameter'>bucketNumber</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1488"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Account for space used, and back off if we've used too much */ 
</span>    <a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1489"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1489"><span class='Ref_To_Local'>hashTupleSize</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN179"><span class='Ref_to_Member'>spacePeak</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN181"><span class='Ref_to_Member'>spaceAllowedSkew</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN48"><span class='Ref_to_Proto'>ExecHashRemoveNextSkewBucket</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we are not over the total spaceAllowed, either */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN178"><span class='Ref_to_Member'>spaceAllowed</span></a><span class='Parentheses'>) 
</span>        <a href="nodeHash.c.html#LN40"><span class='Ref_to_Proto'>ExecHashIncreaseNumBatches</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1482"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashSkewTableInsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      ExecHashRemoveNextSkewBucket 
 * 
 *      Remove the least valuable skew bucket by pushing its tuples into 
 *      the main hash table. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1523"></a><span class='Declare_Function'>ExecHashRemoveNextSkewBucket</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1525"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bucketToRemove</span><span class='Delimiter'>; 
</span><a name="LN1526"></a>    <a href="../../include/executor/hashjoin.h.html#LN93"><span class='Ref_to_Struct'>HashSkewBucket</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN1527"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashvalue</span><span class='Delimiter'>; 
</span><a name="LN1528"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bucketno</span><span class='Delimiter'>; 
</span><a name="LN1529"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>batchno</span><span class='Delimiter'>; 
</span><a name="LN1530"></a>    <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>hashTuple</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Locate the bucket to remove */ 
</span>    <a href="nodeHash.c.html#LN1525"><span class='Ref_To_Local'>bucketToRemove</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <a href="nodeHash.c.html#LN1526"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1525"><span class='Ref_To_Local'>bucketToRemove</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate which bucket and batch the tuples belong to in the main 
     * hashtable.  They all have the same hash value, so it's the same for all 
     * of them.  Also note that it's not possible for nbatch to increase while 
     * we are processing the tuples. 
     */ 
</span>    <a href="nodeHash.c.html#LN1527"><span class='Ref_To_Local'>hashvalue</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1526"><span class='Ref_To_Local'>bucket</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN95"><span class='Ref_to_Member'>hashvalue</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/executor/nodeHash.h.html#LN36"><span class='Ref_to_Proto'>ExecHashGetBucketAndBatch</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1527"><span class='Ref_To_Local'>hashvalue</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN1528"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="nodeHash.c.html#LN1529"><span class='Ref_To_Local'>batchno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process all tuples in the bucket */ 
</span>    <a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1526"><span class='Ref_To_Local'>bucket</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN96"><span class='Ref_to_Member'>tuples</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1549"></a>        <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>nextHashTuple</span> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span><a name="LN1550"></a>        <a href="../../include/access/htup.h.html#LN26"><span class='Ref_to_Typedef'>MinimalTuple</span></a> <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1551"></a>        <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>tupleSize</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This code must agree with ExecHashTableInsert.  We do not use 
         * ExecHashTableInsert directly as ExecHashTableInsert expects a 
         * TupleTableSlot while we already have HashJoinTuples. 
         */ 
</span>        <a href="nodeHash.c.html#LN1550"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN71"><span class='Ref_to_Macro'>HJTUPLE_MINTUPLE</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1551"><span class='Ref_To_Local'>tupleSize</span></a> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN70"><span class='Ref_to_Const'>HJTUPLE_OVERHEAD</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN1550"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup_details.h.html#LN628"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Decide whether to put the tuple in the hash table or a temp file */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1529"><span class='Ref_To_Local'>batchno</span></a> <span class='Operator'>== </span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN148"><span class='Ref_to_Member'>curbatch</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Move the tuple to the main hash table */ 
</span><a name="LN1565"></a>            <a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a> <span class='Declare_Local'>copyTuple</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We must copy the tuple into the dense storage, else it will not 
             * be found by, eg, ExecHashIncreaseNumBatches. 
             */ 
</span>            <a href="nodeHash.c.html#LN1565"><span class='Ref_To_Local'>copyTuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1645"><span class='Ref_to_Typedef'>HashJoinTuple</span></a><span class='Parentheses'>) </span><a href="nodeHash.c.html#LN50"><span class='Ref_to_Proto'>dense_alloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1551"><span class='Ref_To_Local'>tupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1565"><span class='Ref_To_Local'>copyTuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1551"><span class='Ref_To_Local'>tupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="nodeHash.c.html#LN1565"><span class='Ref_To_Local'>copyTuple</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN65"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1528"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>]; 
</span>            <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN136"><span class='Ref_to_Member'>buckets</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1528"><span class='Ref_To_Local'>bucketno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="nodeHash.c.html#LN1565"><span class='Ref_To_Local'>copyTuple</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* We have reduced skew space, but overall space doesn't change */ 
</span>            <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>-= </span><a href="nodeHash.c.html#LN1551"><span class='Ref_To_Local'>tupleSize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Put the tuple into a temp file for later batches */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1529"><span class='Ref_To_Local'>batchno</span></a> <span class='Operator'>&GT; </span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN148"><span class='Ref_to_Member'>curbatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/executor/nodeHashjoin.h.html#LN24"><span class='Ref_to_Proto'>ExecHashJoinSaveTuple</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1550"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="nodeHash.c.html#LN1527"><span class='Ref_To_Local'>hashvalue</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN165"><span class='Ref_to_Member'>innerBatchFile</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1529"><span class='Ref_To_Local'>batchno</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>-= </span><a href="nodeHash.c.html#LN1551"><span class='Ref_To_Local'>tupleSize</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>-= </span><a href="nodeHash.c.html#LN1551"><span class='Ref_To_Local'>tupleSize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="nodeHash.c.html#LN1530"><span class='Ref_To_Local'>hashTuple</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1549"><span class='Ref_To_Local'>nextHashTuple</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* allow this loop to be cancellable */ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while hashTuple!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Free the bucket struct itself and reset the hashtable entry to NULL. 
     * 
     * NOTE: this is not nearly as simple as it looks on the surface, because 
     * of the possibility of collisions in the hashtable.  Suppose that hash 
     * values A and B collide at a particular hashtable entry, and that A was 
     * entered first so B gets shifted to a different table entry.  If we were 
     * to remove A first then ExecHashGetSkewBucket would mistakenly start 
     * reporting that B is not in the hashtable, because it would hit the NULL 
     * before finding B.  However, we always remove entries in the reverse 
     * order of creation, so this failure cannot happen. 
     */ 
</span>    <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Delimiter'>[</span><a href="nodeHash.c.html#LN1525"><span class='Ref_To_Local'>bucketToRemove</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1526"><span class='Ref_To_Local'>bucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>-= </span><a href="../../include/executor/hashjoin.h.html#LN99"><span class='Ref_to_Const'>SKEW_BUCKET_OVERHEAD</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>-= </span><a href="../../include/executor/hashjoin.h.html#LN99"><span class='Ref_to_Const'>SKEW_BUCKET_OVERHEAD</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we have removed all skew buckets then give up on skew optimization. 
     * Release the arrays since they aren't useful any more. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN144"><span class='Ref_to_Member'>nSkewBuckets</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN141"><span class='Ref_to_Member'>skewEnabled</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN142"><span class='Ref_to_Member'>skewBucket</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN145"><span class='Ref_to_Member'>skewBucketNums</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN177"><span class='Ref_to_Member'>spaceUsed</span></a> <span class='Operator'>-= </span><a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1523"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN180"><span class='Ref_to_Member'>spaceUsedSkew</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ExecHashRemoveNextSkewBucket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate 'size' bytes from the currently active HashMemoryChunk 
 */ 
</span><span class='Keyword'>static void </span><span class='Operator'>* 
</span><a name="LN1636"></a><span class='Declare_Function'>dense_alloc</span><span class='Parentheses'>(</span><a href="../../include/nodes/execnodes.h.html#LN1646"><span class='Ref_to_Typedef'>HashJoinTable</span></a> <span class='Declare_Parameter'>hashtable</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1638"></a>    <a href="../../include/executor/hashjoin.h.html#LN120"><span class='Ref_to_Typedef'>HashMemoryChunk</span></a> <span class='Declare_Local'>newChunk</span><span class='Delimiter'>; 
</span><a name="LN1639"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* just in case the size is not already aligned properly */ 
</span>    <a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If tuple size is larger than of 1/4 of chunk size, allocate a separate 
     * chunk. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="../../include/executor/hashjoin.h.html#LN123"><span class='Ref_to_Const'>HASH_CHUNK_THRESHOLD</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* allocate new chunk and put it at the beginning of the list */ 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN120"><span class='Ref_to_Typedef'>HashMemoryChunk</span></a><span class='Parentheses'>) </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN108"><span class='Ref_to_Struct'>HashMemoryChunkData</span></a><span class='Delimiter'>, </span>data<span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN111"><span class='Ref_to_Member'>maxlen</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN110"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Add this chunk to the list after the first existing chunk, so that 
         * we don't lose the remaining space in the "current" chunk. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Delimiter'>; 
</span>            <a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN110"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN117"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if size&GT;HASH_CHUNK_THRES... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * See if we have enough space for it in the current chunk (if any). If 
     * not, allocate a fresh chunk. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN111"><span class='Ref_to_Member'>maxlen</span></a> <span class='Operator'>- </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* allocate new chunk and put it at the beginning of the list */ 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN120"><span class='Ref_to_Typedef'>HashMemoryChunk</span></a><span class='Parentheses'>) </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN184"><span class='Ref_to_Member'>batchCxt</span></a><span class='Delimiter'>, 
</span>                      <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/executor/hashjoin.h.html#LN108"><span class='Ref_to_Struct'>HashMemoryChunkData</span></a><span class='Delimiter'>, </span>data<span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../include/executor/hashjoin.h.html#LN122"><span class='Ref_to_Const'>HASH_CHUNK_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN111"><span class='Ref_to_Member'>maxlen</span></a> <span class='Operator'>= </span><a href="../../include/executor/hashjoin.h.html#LN122"><span class='Ref_to_Const'>HASH_CHUNK_SIZE</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN110"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN114"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Delimiter'>; 
</span>        <a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="nodeHash.c.html#LN1638"><span class='Ref_To_Local'>newChunk</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN117"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* There is enough space in the current chunk, let's add the tuple */ 
</span>    <a href="nodeHash.c.html#LN1639"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN117"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>+ </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN112"><span class='Ref_to_Member'>used</span></a> <span class='Operator'>+= </span><a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    <a href="nodeHash.c.html#LN1636"><span class='Ref_to_Parameter'>hashtable</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN187"><span class='Ref_to_Member'>chunks</span></a><span class='Operator'>-&GT;</span><a href="../../include/executor/hashjoin.h.html#LN110"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* return pointer to the start of the tuple memory */ 
</span>    <span class='Control'>return</span> <a href="nodeHash.c.html#LN1639"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dense_alloc &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>