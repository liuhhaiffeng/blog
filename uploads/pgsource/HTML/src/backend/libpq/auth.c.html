<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\libpq\auth.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\libpq\auth.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:40 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * auth.c 
 *    Routines to handle network authentication 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/libpq/auth.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/param.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"commands/user.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/ip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/md5.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/auth.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/crypt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqformat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/scram.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/backend_random.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Global authentication functions 
 *---------------------------------------------------------------- 
 */ 
</span><a name="LN45"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sendAuthRequest</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN178"><span class='Ref_to_Typedef'>AuthRequest</span></a> <span class='Declare_Parameter'>areq</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>extradata</span><span class='Delimiter'>, 
</span><a name="LN46"></a>                <span class='Keyword'>int </span><span class='Declare_Parameter'>extralen</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN47"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>auth_failed</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN48"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>recv_password_packet</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Password-based authentication methods (password, md5, and scram-sha-256) 
 *---------------------------------------------------------------- 
 */ 
</span><a name="LN55"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckPasswordAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN56"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckPWChallengeAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN58"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckMD5Auth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>shadow_pass</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN59"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckSCRAMAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>shadow_pass</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Ident authentication 
 *---------------------------------------------------------------- 
 */ 
/* Max size of username ident server can return */ 
</span><a name="LN67"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>IDENT_USERNAME_MAX</span> <span class='Number'>512</span> 
 
<span class='Comment_Multi_Line'>/* Standard TCP port number for Ident service.  Assigned by IANA */ 
</span><a name="LN70"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>IDENT_PORT</span> <span class='Number'>113</span> 
 
<a name="LN72"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>ident_inet</span><span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN112"><span class='Ref_to_Typedef'>hbaPort</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
<a name="LN75"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>auth_peer</span><span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN112"><span class='Ref_to_Typedef'>hbaPort</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * PAM authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> USE_PAM 
<span class='Directive'>#ifdef</span> HAVE_PAM_PAM_APPL_H 
<span class='Keyword'>#include </span><span class='String'>&LT;pam/pam_appl.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> HAVE_SECURITY_PAM_APPL_H 
<span class='Keyword'>#include </span><span class='String'>&LT;security/pam_appl.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<a name="LN91"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSQL_PAM_SERVICE</span> <span class='String'>"postgresql"</span>  <span class='Comment_Single_Line'>/* Service name passed to PAM */ 
</span> 
<a name="LN93"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckPAMAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>password</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN94"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pam_passwd_conv_proc</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>num_msg</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><span class='Control'>struct</span> pam_message <span class='Operator'>** </span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, 
</span><a name="LN95"></a>                     <span class='Control'>struct</span> pam_response <span class='Operator'>** </span><span class='Declare_Parameter'>resp</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>appdata_ptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN97"></a><span class='Keyword'>static </span><span class='Control'>struct</span> pam_conv <span class='Declare_Var'>pam_passw_conv</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Operator'>&</span><a href="auth.c.html#LN94"><span class='Ref_to_Proto'>pam_passwd_conv_proc</span></a><span class='Delimiter'>, 
</span>    <span class='Null_Value'>NULL 
</span><span class='Delimiter'>}; 
</span> 
<a name="LN102"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>pam_passwd</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* Workaround for Solaris 2.6 brokenness */ 
</span><a name="LN103"></a><span class='Keyword'>static </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pam_port_cludge</span><span class='Delimiter'>;</span>   <span class='Comment_Multi_Line'>/* Workaround for passing "Port *port" into 
                                 * pam_passwd_conv_proc */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_PAM */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * BSD authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> USE_BSD_AUTH 
<span class='Keyword'>#include </span><span class='String'>&LT;bsd_auth.h&GT;</span> 
 
<a name="LN115"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckBSDAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_BSD_AUTH */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * LDAP authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> USE_LDAP 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* We use a deprecated function to keep the codepath the same as win32. */ 
</span><a name="LN126"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>LDAP_DEPRECATED</span> <span class='Number'>1</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;ldap.h&GT;</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;winldap.h&GT;</span> 
 
<span class='Comment_Multi_Line'>/* Correct header from the Platform SDK */ 
</span><span class='Control'>typedef</span> 
<a name="LN133"></a>ULONG       <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Typedef'>__ldap_start_tls_sA</span><span class='Parentheses'>) ( 
</span>                                                IN PLDAP ExternalHandle<span class='Delimiter'>, 
</span>                                                OUT PULONG ServerReturnValue<span class='Delimiter'>, 
</span>                                                OUT LDAPMessage <span class='Operator'>**</span><a href="../../bin/pgbench/exprparse.y.html#LN62"><span class='Ref_to_Label'>result</span></a><span class='Delimiter'>, 
</span>                                           IN PLDAPControlA <span class='Operator'>* </span>ServerControls<span class='Delimiter'>, 
</span>                                            IN PLDAPControlA <span class='Operator'>* </span>ClientControls 
<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN142"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckLDAPAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_LDAP */ 
</span> 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Cert authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
<a name="LN150"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckCertAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Kerberos and GSSAPI GUCs 
 *---------------------------------------------------------------- 
 */ 
</span><a name="LN158"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>pg_krb_server_keyfile</span><span class='Delimiter'>; 
</span><a name="LN159"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>pg_krb_caseins_users</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * GSSAPI Authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> ENABLE_GSS 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>HAVE_GSSAPI_H<span class='Parentheses'>) 
</span><span class='Keyword'>#include </span><span class='String'>&LT;gssapi.h&GT;</span> 
<span class='Directive'>#else</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;gssapi/gssapi.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<a name="LN173"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>pg_GSS_recvauth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_GSS */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * SSPI Authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a> 
<span class='Control'>typedef</span> SECURITY_STATUS 
<a name="LN183"></a>            <span class='Parentheses'>(</span>WINAPI <span class='Operator'>* </span><span class='Declare_Typedef'>QUERY_SECURITY_CONTEXT_TOKEN_FN</span><span class='Parentheses'>) ( 
</span>                                                       PCtxtHandle<span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN185"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>pg_SSPI_recvauth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN186"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>pg_SSPI_make_upn</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>accountname</span><span class='Delimiter'>, 
</span><a name="LN187"></a>                 size_t <span class='Declare_Parameter'>accountnamesize</span><span class='Delimiter'>, 
</span><a name="LN188"></a>                 <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>domainname</span><span class='Delimiter'>, 
</span><a name="LN189"></a>                 size_t <span class='Declare_Parameter'>domainnamesize</span><span class='Delimiter'>, 
</span><a name="LN190"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>update_accountname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * RADIUS Authentication 
 *---------------------------------------------------------------- 
 */ 
</span><a name="LN197"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CheckRADIUSAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN198"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>PerformRadiusTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>server</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>secret</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>portstr</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>identifier</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user_name</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>passwd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Maximum accepted size of GSS and SSPI authentication tokens. 
 * 
 * Kerberos tickets are usually quite small, but the TGTs issued by Windows 
 * domain controllers include an authorization field known as the Privilege 
 * Attribute Certificate (PAC), which contains the user's Windows permissions 
 * (group memberships etc.). The PAC is copied into all tickets obtained on 
 * the basis of this TGT (even those issued by Unix realms which the Windows 
 * realm trusts), and can be several kB in size. The maximum token size 
 * accepted by Windows systems is determined by the MaxAuthToken Windows 
 * registry setting. Microsoft recommends that it is not set higher than 
 * 65535 bytes, so that seems like a reasonable limit for us as well. 
 */ 
</span><a name="LN214"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_MAX_AUTH_TOKEN_LENGTH</span>    <span class='Number'>65535</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Maximum accepted size of SASL messages. 
 * 
 * The messages that the server or libpq generate are much smaller than this, 
 * but have some headroom. 
 */ 
</span><a name="LN222"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_MAX_SASL_MESSAGE_LENGTH</span>  <span class='Number'>1024</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Global authentication functions 
 *---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This hook allows plugins to get control following client authentication, 
 * but before the user has been informed about the results.  It could be used 
 * to record login events, insert a delay after failed authentication, etc. 
 */ 
</span><a name="LN234"></a><a href="../../include/libpq/auth.h.html#LN25"><span class='Ref_to_Typedef'>ClientAuthentication_hook_type</span></a> <span class='Declare_Var'>ClientAuthentication_hook</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Tell the user the authentication failed, but not (much about) why. 
 * 
 * There is a tradeoff here between security concerns and making life 
 * unnecessarily difficult for legitimate users.  We would not, for example, 
 * want to report the password we were expecting to receive... 
 * But it seems useful to report the username and authorization method 
 * in use, and these are items that must be presumed known to an attacker 
 * anyway. 
 * Note that many sorts of failure report additional information in the 
 * postmaster log, which we hope is only readable by good guys.  In 
 * particular, if logdetail isn't NULL, we send that string to the log. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN250"></a><span class='Declare_Function'>auth_failed</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN252"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>errstr</span><span class='Delimiter'>; 
</span><a name="LN253"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cdetail</span><span class='Delimiter'>; 
</span><a name="LN254"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>errcode_return</span> <span class='Operator'>= </span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we failed due to EOF from client, just quit; there's no point in 
     * trying to send a message to the client, and not much point in logging 
     * the failure in the postmaster log.  (Logging the failure might be 
     * desirable, were it not for the fact that libpq closes the connection 
     * unceremoniously if challenged for a password when it hasn't got one to 
     * send.  We'll get a useless log entry for every psql connection under 
     * password auth, even if it's perfectly successful, if we log STATUS_EOF 
     * events.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>status</span></a> <span class='Operator'>== </span><a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Parentheses'>) 
</span>        <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN71"><span class='Ref_to_Member'>auth_method</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN26"><span class='Ref_to_EnumConst'>uaReject</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN27"><span class='Ref_to_EnumConst'>uaImplicitReject</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"authentication failed for user \"%s\": host rejected"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN28"><span class='Ref_to_EnumConst'>uaTrust</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"\"trust\" authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN29"><span class='Ref_to_EnumConst'>uaIdent</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Ident authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN40"><span class='Ref_to_EnumConst'>uaPeer</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Peer authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN30"><span class='Ref_to_EnumConst'>uaPassword</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN31"><span class='Ref_to_EnumConst'>uaMD5</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN32"><span class='Ref_to_EnumConst'>uaSCRAM</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"password authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* We use it to indicate if a .pgpass password failed. */ 
</span>            <a href="auth.c.html#LN254"><span class='Ref_To_Local'>errcode_return</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/fe-connect.c.html#LN92"><span class='Ref_to_Const'>ERRCODE_INVALID_PASSWORD</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN33"><span class='Ref_to_EnumConst'>uaGSS</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"GSSAPI authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN34"><span class='Ref_to_EnumConst'>uaSSPI</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"SSPI authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN35"><span class='Ref_to_EnumConst'>uaPAM</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"PAM authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN36"><span class='Ref_to_EnumConst'>uaBSD</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"BSD authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN37"><span class='Ref_to_EnumConst'>uaLDAP</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN38"><span class='Ref_to_EnumConst'>uaCert</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"certificate authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN39"><span class='Ref_to_EnumConst'>uaRADIUS</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS authentication failed for user \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"authentication failed for user \"%s\": invalid authentication method"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch port-&GT;hba-&GT;auth_metho... &raquo; </span> 
 
    <a href="auth.c.html#LN253"><span class='Ref_To_Local'>cdetail</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Connection matched pg_hba.conf line %d: \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN62"><span class='Ref_to_Member'>linenumber</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN63"><span class='Ref_to_Member'>rawline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>logdetail</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s\n%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN253"><span class='Ref_To_Local'>cdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>logdetail</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN253"><span class='Ref_To_Local'>cdetail</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN254"><span class='Ref_To_Local'>errcode_return</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN252"><span class='Ref_To_Local'>errstr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>logdetail</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN250"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* doesn't return */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end auth_failed &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Client authentication starts here.  If there is an error, this 
 * function does not return and the backend process is terminated. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN338"></a><span class='Declare_Function'>ClientAuthentication</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN340"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span> <span class='Operator'>= </span><a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span><a name="LN341"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>logdetail</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the authentication method to use for this frontend/database 
     * combination.  Note: we do not parse the file at this point; this has 
     * already been done elsewhere.  hba.c dropped an error message into the 
     * server logfile if parsing the hba config file failed. 
     */ 
</span>    <a href="../../include/libpq/hba.h.html#LN116"><span class='Ref_to_Proto'>hba_getauthmethod</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is the first point where we have access to the hba record for the 
     * current connection, so perform any verifications based on the hba 
     * options field that should be done *before* the authentication here. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN86"><span class='Ref_to_Member'>clientcert</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If we haven't loaded a root certificate store, fail */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/libpq/libpq.h.html#LN83"><span class='Ref_to_Proto'>secure_loaded_verify_locations</span></a><span class='Parentheses'>())</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"client certificates can only be checked if a root certificate store is available"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we loaded a root certificate store, and if a certificate is 
         * present on the client, then it has been verified against our root 
         * certificate store, and the connection would have been aborted 
         * already if it didn't verify ok. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN182"><span class='Ref_to_Member'>peer_cert_valid</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"connection requires a valid client certificate"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now proceed to do the actual authentication check 
     */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN71"><span class='Ref_to_Member'>auth_method</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN26"><span class='Ref_to_EnumConst'>uaReject</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * An explicit "reject" entry in pg_hba.conf.  This report exposes 
             * the fact that there's an explicit reject entry, which is 
             * perhaps not so desirable from a security standpoint; but the 
             * message for an implicit reject could confuse the DBA a lot when 
             * the true situation is a match to an explicit reject.  And we 
             * don't want to change the message for an implicit reject.  As 
             * noted below, the additional information shown here doesn't 
             * expose anything not known to an attacker. 
             */ 
</span>            <span class='Delimiter'>{ 
</span><a name="LN396"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>hostinfo</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span> 
                <a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Delimiter'>, 
</span>                                   <a href="auth.c.html#LN396"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN396"><span class='Ref_To_Local'>hostinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_hba.conf rejects replication connection for host \"%s\", user \"%s\", %s"</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN396"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>? </span>_<span class='Parentheses'>(</span><span class='String'>"SSL on"</span><span class='Parentheses'>) </span><span class='Operator'>: </span>_<span class='Parentheses'>(</span><span class='String'>"SSL off"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_hba.conf rejects replication connection for host \"%s\", user \"%s\""</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN396"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_hba.conf rejects connection for host \"%s\", user \"%s\", database \"%s\", %s"</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN396"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>? </span>_<span class='Parentheses'>(</span><span class='String'>"SSL on"</span><span class='Parentheses'>) </span><span class='Operator'>: </span>_<span class='Parentheses'>(</span><span class='String'>"SSL off"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_hba.conf rejects connection for host \"%s\", user \"%s\", database \"%s\""</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN396"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN27"><span class='Ref_to_EnumConst'>uaImplicitReject</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No matching entry, so tell the user we fell through. 
             * 
             * NOTE: the extra info reported here is not a security breach, 
             * because all that info is known at the frontend and must be 
             * assumed known to bad guys.  We're merely helping out the less 
             * clueful good guys. 
             */ 
</span>            <span class='Delimiter'>{ 
</span><a name="LN449"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>hostinfo</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span> 
                <a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Delimiter'>, 
</span>                                   <a href="auth.c.html#LN449"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN449"><span class='Ref_To_Local'>hostinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN456"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>HOSTNAME_LOOKUP_DETAIL</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a> <span class='Operator'>? \ 
</span>                 <span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN125"><span class='Ref_to_Member'>remote_hostname_resolv</span></a> <span class='Operator'>== +</span><span class='Number'>1</span> <span class='Operator'>? \ 
</span>                  <a href="../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"Client IP address resolved to \"%s\", forward lookup matches."</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a><span class='Parentheses'>)</span> <span class='Operator'>: \ 
</span>                  <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN125"><span class='Ref_to_Member'>remote_hostname_resolv</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>? \ 
</span>                  <a href="../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"Client IP address resolved to \"%s\", forward lookup not checked."</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a><span class='Parentheses'>)</span> <span class='Operator'>: \ 
</span>                  <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN125"><span class='Ref_to_Member'>remote_hostname_resolv</span></a> <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>? \ 
</span>                  <a href="../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"Client IP address resolved to \"%s\", forward lookup does not match."</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a><span class='Parentheses'>)</span> <span class='Operator'>: \ 
</span>                  <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN125"><span class='Ref_to_Member'>remote_hostname_resolv</span></a> <span class='Operator'>== -</span><span class='Number'>2</span> <span class='Operator'>? \ 
</span>                  <a href="../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"Could not translate client host name \"%s\" to IP address: %s."</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                <a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN126"><span class='Ref_to_Member'>remote_hostname_errcode</span></a><span class='Parentheses'>))</span> <span class='Operator'>: \ 
</span>                  <span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>                 <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN125"><span class='Ref_to_Member'>remote_hostname_resolv</span></a> <span class='Operator'>== -</span><span class='Number'>2</span> <span class='Operator'>? \ 
</span>                    <a href="../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"Could not resolve client IP address to a host name: %s."</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                  <a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN126"><span class='Ref_to_Member'>remote_hostname_errcode</span></a><span class='Parentheses'>))</span> <span class='Operator'>: \ 
</span>                    <span class='Number'>0</span><span class='Parentheses'>))</span> 
 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no pg_hba.conf entry for replication connection from host \"%s\", user \"%s\", %s"</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN449"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>? </span>_<span class='Parentheses'>(</span><span class='String'>"SSL on"</span><span class='Parentheses'>) </span><span class='Operator'>: </span>_<span class='Parentheses'>(</span><span class='String'>"SSL off"</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN456"><span class='Ref_to_Macro'>HOSTNAME_LOOKUP_DETAIL</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no pg_hba.conf entry for replication connection from host \"%s\", user \"%s\""</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN449"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN456"><span class='Ref_to_Macro'>HOSTNAME_LOOKUP_DETAIL</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no pg_hba.conf entry for host \"%s\", user \"%s\", database \"%s\", %s"</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN449"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>? </span>_<span class='Parentheses'>(</span><span class='String'>"SSL on"</span><span class='Parentheses'>) </span><span class='Operator'>: </span>_<span class='Parentheses'>(</span><span class='String'>"SSL off"</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN456"><span class='Ref_to_Macro'>HOSTNAME_LOOKUP_DETAIL</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no pg_hba.conf entry for host \"%s\", user \"%s\", database \"%s\""</span><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN449"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                               <a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN456"><span class='Ref_to_Macro'>HOSTNAME_LOOKUP_DETAIL</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN33"><span class='Ref_to_EnumConst'>uaGSS</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> ENABLE_GSS 
            <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN171"><span class='Ref_to_Const'>AUTH_REQ_GSS</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN173"><span class='Ref_to_Proto'>pg_GSS_recvauth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN34"><span class='Ref_to_EnumConst'>uaSSPI</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a> 
            <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN173"><span class='Ref_to_Const'>AUTH_REQ_SSPI</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN185"><span class='Ref_to_Proto'>pg_SSPI_recvauth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN40"><span class='Ref_to_EnumConst'>uaPeer</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN75"><span class='Ref_to_Proto'>auth_peer</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN29"><span class='Ref_to_EnumConst'>uaIdent</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN72"><span class='Ref_to_Proto'>ident_inet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN31"><span class='Ref_to_EnumConst'>uaMD5</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN32"><span class='Ref_to_EnumConst'>uaSCRAM</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN56"><span class='Ref_to_Proto'>CheckPWChallengeAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN341"><span class='Ref_To_Local'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN30"><span class='Ref_to_EnumConst'>uaPassword</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN55"><span class='Ref_to_Proto'>CheckPasswordAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN341"><span class='Ref_To_Local'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN35"><span class='Ref_to_EnumConst'>uaPAM</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> USE_PAM 
            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN93"><span class='Ref_to_Proto'>CheckPAMAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_PAM */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN36"><span class='Ref_to_EnumConst'>uaBSD</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> USE_BSD_AUTH 
            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN115"><span class='Ref_to_Proto'>CheckBSDAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_BSD_AUTH */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN37"><span class='Ref_to_EnumConst'>uaLDAP</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> USE_LDAP 
            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN142"><span class='Ref_to_Proto'>CheckLDAPAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN38"><span class='Ref_to_EnumConst'>uaCert</span></a><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN150"><span class='Ref_to_Proto'>CheckCertAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN39"><span class='Ref_to_EnumConst'>uaRADIUS</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN197"><span class='Ref_to_Proto'>CheckRADIUSAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/hba.h.html#LN28"><span class='Ref_to_EnumConst'>uaTrust</span></a><span class='Operator'>: 
</span>            <a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch port-&GT;hba-&GT;auth_metho... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN234"><span class='Ref_to_Global_Var'>ClientAuthentication_hook</span></a><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN234"><span class='Ref_to_Global_Var'>ClientAuthentication_hook</span></a><span class='Parentheses'>) (</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN164"><span class='Ref_to_Const'>AUTH_REQ_OK</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN47"><span class='Ref_to_Proto'>auth_failed</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN338"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN340"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN341"><span class='Ref_To_Local'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ClientAuthentication &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Send an authentication request packet to the frontend. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN608"></a><span class='Declare_Function'>sendAuthRequest</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN178"><span class='Ref_to_Typedef'>AuthRequest</span></a> <span class='Declare_Parameter'>areq</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>extradata</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>extralen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN610"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN610"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'R'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN610"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><a href="auth.c.html#LN608"><span class='Ref_to_Parameter'>areq</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN608"><span class='Ref_to_Parameter'>extralen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/libpq/pqformat.h.html#LN19"><span class='Ref_to_Proto'>pq_sendbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN610"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN608"><span class='Ref_to_Parameter'>extradata</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN608"><span class='Ref_to_Parameter'>extralen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN610"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flush message so client will see it, except for AUTH_REQ_OK and 
     * AUTH_REQ_SASL_FIN, which need not be sent until we are ready for 
     * queries. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN608"><span class='Ref_to_Parameter'>areq</span></a> <span class='Operator'>!= </span><a href="../../include/libpq/pqcomm.h.html#LN164"><span class='Ref_to_Const'>AUTH_REQ_OK</span></a> <span class='Operator'>&& </span><a href="auth.c.html#LN608"><span class='Ref_to_Parameter'>areq</span></a> <span class='Operator'>!= </span><a href="../../include/libpq/pqcomm.h.html#LN176"><span class='Ref_to_Const'>AUTH_REQ_SASL_FIN</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/libpq/libpq.h.html#LN38"><span class='Ref_to_Macro'>pq_flush</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sendAuthRequest &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Collect password response packet from frontend. 
 * 
 * Returns NULL if couldn't get password, else palloc'd string. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN638"></a><span class='Declare_Function'>recv_password_packet</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN640"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/libpq.h.html#LN65"><span class='Ref_to_Proto'>pq_startmsgread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN638"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN119"><span class='Ref_to_Member'>proto</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Expect 'p' message type */ 
</span><a name="LN646"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>mtype</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN646"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN69"><span class='Ref_to_Proto'>pq_getbyte</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN646"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If the client just disconnects without offering a password, 
             * don't make a log entry.  This is legal per protocol spec and in 
             * fact commonly done by psql, so complaining just clutters the 
             * log. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN646"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span>EOF<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"expected password response, got message type %d"</span><span class='Delimiter'>, 
</span>                           <a href="auth.c.html#LN646"><span class='Ref_To_Local'>mtype</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* EOF or bad message type */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PG_PROTOCOL_MAJOR(por... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* For pre-3.0 clients, avoid log entry if they just disconnect */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN70"><span class='Ref_to_Proto'>pq_peekbyte</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span>EOF<span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* EOF */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN640"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN68"><span class='Ref_to_Proto'>pq_getmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN640"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>1000</span><span class='Parentheses'>))</span>      <span class='Comment_Single_Line'>/* receive password */ 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* EOF - pq_getmessage already logged a suitable message */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN640"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Apply sanity check: password packet length should agree with length of 
     * contained string.  Note it is safe to use strlen here because 
     * StringInfo is guaranteed to have an appended '\0'. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN640"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>!= </span><a href="auth.c.html#LN640"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid password packet size"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do not echo password to logs, for security. */ 
</span>    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN19"><span class='Ref_to_Const'>DEBUG5</span></a><span class='Delimiter'>, </span><span class='String'>"received password packet"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return the received string.  Note we do not attempt to do any 
     * character-set conversion on it; since we don't yet know the client's 
     * encoding, there wouldn't be much point. 
     */ 
</span>    <span class='Control'>return</span> <a href="auth.c.html#LN640"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end recv_password_packet &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Password-based authentication mechanisms 
 *---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Plaintext password authentication. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN711"></a><span class='Declare_Function'>CheckPasswordAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN713"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>passwd</span><span class='Delimiter'>; 
</span><a name="LN714"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN715"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>shadow_pass</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN711"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN713"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN48"><span class='Ref_to_Proto'>recv_password_packet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN711"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN713"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* client wouldn't send password */ 
</span> 
    <a href="auth.c.html#LN715"><span class='Ref_To_Local'>shadow_pass</span></a> <span class='Operator'>= </span><a href="crypt.c.html#LN37"><span class='Ref_to_Func'>get_role_password</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN711"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN711"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN715"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="auth.c.html#LN714"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/libpq/crypt.h.html#LN42"><span class='Ref_to_Proto'>plain_crypt_verify</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN711"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN715"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN713"><span class='Ref_To_Local'>passwd</span></a><span class='Delimiter'>, 
</span>                                    <a href="auth.c.html#LN711"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN714"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN715"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN715"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN713"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="auth.c.html#LN714"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckPasswordAuth &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MD5 and SCRAM authentication. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN743"></a><span class='Declare_Function'>CheckPWChallengeAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN745"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>auth_result</span><span class='Delimiter'>; 
</span><a name="LN746"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>shadow_pass</span><span class='Delimiter'>; 
</span><a name="LN747"></a>    <a href="../../include/libpq/crypt.h.html#LN26"><span class='Ref_to_Enum'>PasswordType</span></a> <span class='Declare_Local'>pwtype</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN71"><span class='Ref_to_Member'>auth_method</span></a> <span class='Operator'>== </span><a href="../../include/libpq/hba.h.html#LN32"><span class='Ref_to_EnumConst'>uaSCRAM</span></a> <span class='Operator'>|| 
</span>           <a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN71"><span class='Ref_to_Member'>auth_method</span></a> <span class='Operator'>== </span><a href="../../include/libpq/hba.h.html#LN31"><span class='Ref_to_EnumConst'>uaMD5</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First look up the user's password. */ 
</span>    <a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a> <span class='Operator'>= </span><a href="crypt.c.html#LN37"><span class='Ref_to_Func'>get_role_password</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the user does not exist, or has no password or it's expired, we 
     * still go through the motions of authentication, to avoid revealing to 
     * the client that the user didn't exist.  If 'md5' is allowed, we choose 
     * whether to use 'md5' or 'scram-sha-256' authentication based on current 
     * password_encryption setting.  The idea is that most genuine users 
     * probably have a password of that type, and if we pretend that this user 
     * had a password of that type, too, it "blends in" best. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN747"><span class='Ref_To_Local'>pwtype</span></a> <span class='Operator'>= </span><a href="../commands/user.c.html#LN46"><span class='Ref_to_Global_Var'>Password_encryption</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN747"><span class='Ref_To_Local'>pwtype</span></a> <span class='Operator'>= </span><a href="../../include/libpq/crypt.h.html#LN33"><span class='Ref_to_Proto'>get_password_type</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If 'md5' authentication is allowed, decide whether to perform 'md5' or 
     * 'scram-sha-256' authentication based on the type of password the user 
     * has.  If it's an MD5 hash, we must do MD5 authentication, and if it's a 
     * SCRAM verifier, we must do SCRAM authentication. 
     * 
     * If MD5 authentication is not allowed, always use SCRAM.  If the user 
     * had an MD5 password, CheckSCRAMAuth() will fail. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN71"><span class='Ref_to_Member'>auth_method</span></a> <span class='Operator'>== </span><a href="../../include/libpq/hba.h.html#LN31"><span class='Ref_to_EnumConst'>uaMD5</span></a> <span class='Operator'>&& </span><a href="auth.c.html#LN747"><span class='Ref_To_Local'>pwtype</span></a> <span class='Operator'>== </span><a href="../../include/libpq/crypt.h.html#LN29"><span class='Ref_to_EnumConst'>PASSWORD_TYPE_MD5</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN745"><span class='Ref_To_Local'>auth_result</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN58"><span class='Ref_to_Proto'>CheckMD5Auth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN745"><span class='Ref_To_Local'>auth_result</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN59"><span class='Ref_to_Proto'>CheckSCRAMAuth</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN743"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If get_role_password() returned error, return error, even if the 
     * authentication succeeded. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN746"><span class='Ref_To_Local'>shadow_pass</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="auth.c.html#LN745"><span class='Ref_To_Local'>auth_result</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="auth.c.html#LN745"><span class='Ref_To_Local'>auth_result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckPWChallengeAuth &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN799"></a><span class='Declare_Function'>CheckMD5Auth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>shadow_pass</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN801"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>md5Salt</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>];</span>     <span class='Comment_Single_Line'>/* Password salt */ 
</span><a name="LN802"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>passwd</span><span class='Delimiter'>; 
</span><a name="LN803"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../postmaster/postmaster.c.html#LN239"><span class='Ref_to_Global_Var'>Db_user_namespace</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MD5 authentication is not supported when \"db_user_namespace\" is enabled"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* include the salt to use for computing the response */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/backend_random.h.html#LN16"><span class='Ref_to_Proto'>pg_backend_random</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN801"><span class='Ref_To_Local'>md5Salt</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not generate random MD5 salt"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN799"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN169"><span class='Ref_to_Const'>AUTH_REQ_MD5</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN801"><span class='Ref_To_Local'>md5Salt</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN802"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN48"><span class='Ref_to_Proto'>recv_password_packet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN799"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN802"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* client wouldn't send password */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN799"><span class='Ref_to_Parameter'>shadow_pass</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN803"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/libpq/crypt.h.html#LN39"><span class='Ref_to_Proto'>md5_crypt_verify</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN799"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN799"><span class='Ref_to_Parameter'>shadow_pass</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN802"><span class='Ref_To_Local'>passwd</span></a><span class='Delimiter'>, 
</span>                                  <a href="auth.c.html#LN801"><span class='Ref_To_Local'>md5Salt</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="auth.c.html#LN799"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN803"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN802"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="auth.c.html#LN803"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckMD5Auth &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN836"></a><span class='Declare_Function'>CheckSCRAMAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>shadow_pass</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>logdetail</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN838"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mtype</span><span class='Delimiter'>; 
</span><a name="LN839"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN840"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>scram_opaq</span><span class='Delimiter'>; 
</span><a name="LN841"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>output</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN842"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>outputlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN843"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>input</span><span class='Delimiter'>; 
</span><a name="LN844"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>inputlen</span><span class='Delimiter'>; 
</span><a name="LN845"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN846"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>initial</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SASL auth is not supported for protocol versions before 3, because it 
     * relies on the overall message length word to determine the SASL payload 
     * size in AuthenticationSASLContinue and PasswordMessage messages.  (We 
     * used to have a hard rule that protocol messages must be parsable 
     * without relying on the length word, but we hardly care about older 
     * protocol version anymore.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN26"><span class='Ref_to_Global_Var'>FrontendProtocol</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SASL authentication is not supported in protocol version 2"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Send the SASL authentication request to user.  It includes the list of 
     * authentication mechanisms (which is trivial, because we only support 
     * SCRAM-SHA-256 at the moment).  The extra "\0" is for an empty string to 
     * terminate the list. 
     */ 
</span>    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN836"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN174"><span class='Ref_to_Const'>AUTH_REQ_SASL</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/scram.h.html#LN16"><span class='Ref_to_Const'>SCRAM_SHA256_NAME</span></a> <span class='String'>"\0"</span><span class='Delimiter'>, 
</span>                    strlen<span class='Parentheses'>(</span><a href="../../include/libpq/scram.h.html#LN16"><span class='Ref_to_Const'>SCRAM_SHA256_NAME</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the status tracker for message exchanges. 
     * 
     * If the user doesn't exist, or doesn't have a valid password, or it's 
     * expired, we still go through the motions of SASL authentication, but 
     * tell the authentication method that the authentication is "doomed". 
     * That is, it's going to fail, no matter what. 
     * 
     * This is because we don't want to reveal to an attacker what usernames 
     * are valid, nor which users have a valid password. 
     */ 
</span>    <a href="auth.c.html#LN840"><span class='Ref_To_Local'>scram_opaq</span></a> <span class='Operator'>= </span><a href="../../include/libpq/scram.h.html#LN24"><span class='Ref_to_Proto'>pg_be_scram_init</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN836"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN836"><span class='Ref_to_Parameter'>shadow_pass</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop through SASL message exchange.  This exchange can consist of 
     * multiple messages sent in both directions.  First message is always 
     * from the client.  All messages from client to server are password 
     * packets (type 'p'). 
     */ 
</span>    <a href="auth.c.html#LN846"><span class='Ref_To_Local'>initial</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/libpq/libpq.h.html#LN65"><span class='Ref_to_Proto'>pq_startmsgread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN838"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN69"><span class='Ref_to_Proto'>pq_getbyte</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN838"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Only log error if client didn't disconnect. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN838"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span>EOF<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"expected SASL response, got message type %d"</span><span class='Delimiter'>, 
</span>                                <a href="auth.c.html#LN838"><span class='Ref_To_Local'>mtype</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Get the actual SASL message */ 
</span>        <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN68"><span class='Ref_to_Proto'>pq_getmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN222"><span class='Ref_to_Const'>PG_MAX_SASL_MESSAGE_LENGTH</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* EOF - pq_getmessage already logged error */ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"Processing received SASL response of length %d"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The first SASLInitialResponse message is different from the others. 
         * It indicates which SASL mechanism the client selected, and contains 
         * an optional Initial Client Response payload.  The subsequent 
         * SASLResponse messages contain just the SASL payload. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN846"><span class='Ref_To_Local'>initial</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN927"></a>            <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>selected_mech</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We only support SCRAM-SHA-256 at the moment, so anything else 
             * is an error. 
             */ 
</span>            <a href="auth.c.html#LN927"><span class='Ref_To_Local'>selected_mech</span></a> <span class='Operator'>= </span><a href="../../include/libpq/pqformat.h.html#LN46"><span class='Ref_to_Proto'>pq_getmsgrawstring</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="auth.c.html#LN927"><span class='Ref_To_Local'>selected_mech</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/scram.h.html#LN16"><span class='Ref_to_Const'>SCRAM_SHA256_NAME</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"client selected an invalid SASL authentication mechanism"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="auth.c.html#LN844"><span class='Ref_To_Local'>inputlen</span></a> <span class='Operator'>= </span><a href="../../include/libpq/pqformat.h.html#LN38"><span class='Ref_to_Proto'>pq_getmsgint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN844"><span class='Ref_To_Local'>inputlen</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="auth.c.html#LN843"><span class='Ref_To_Local'>input</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="auth.c.html#LN843"><span class='Ref_To_Local'>input</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/libpq/pqformat.h.html#LN42"><span class='Ref_to_Proto'>pq_getmsgbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN844"><span class='Ref_To_Local'>inputlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="auth.c.html#LN846"><span class='Ref_To_Local'>initial</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if initial &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="auth.c.html#LN844"><span class='Ref_To_Local'>inputlen</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span>            <a href="auth.c.html#LN843"><span class='Ref_To_Local'>input</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/libpq/pqformat.h.html#LN42"><span class='Ref_to_Proto'>pq_getmsgbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/libpq/pqformat.h.html#LN47"><span class='Ref_to_Proto'>pq_getmsgend</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The StringInfo guarantees that there's a \0 byte after the 
         * response. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="auth.c.html#LN843"><span class='Ref_To_Local'>input</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="auth.c.html#LN843"><span class='Ref_To_Local'>input</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN844"><span class='Ref_To_Local'>inputlen</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * we pass 'logdetail' as NULL when doing a mock authentication, 
         * because we should already have a better error message in that case 
         */ 
</span>        <a href="auth.c.html#LN845"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/libpq/scram.h.html#LN25"><span class='Ref_to_Proto'>pg_be_scram_exchange</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN840"><span class='Ref_To_Local'>scram_opaq</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN843"><span class='Ref_To_Local'>input</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN844"><span class='Ref_To_Local'>inputlen</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="auth.c.html#LN841"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN842"><span class='Ref_To_Local'>outputlen</span></a><span class='Delimiter'>, 
</span>                                      <a href="auth.c.html#LN836"><span class='Ref_to_Parameter'>logdetail</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* input buffer no longer used */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN839"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN841"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Negotiation generated data to be sent to the client. 
             */ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"sending SASL challenge of length %u"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN842"><span class='Ref_To_Local'>outputlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN845"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../include/libpq/scram.h.html#LN20"><span class='Ref_to_Const'>SASL_EXCHANGE_SUCCESS</span></a><span class='Parentheses'>) 
</span>                <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN836"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN176"><span class='Ref_to_Const'>AUTH_REQ_SASL_FIN</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN841"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN842"><span class='Ref_To_Local'>outputlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN836"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN175"><span class='Ref_to_Const'>AUTH_REQ_SASL_CONT</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN841"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN842"><span class='Ref_To_Local'>outputlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN841"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN845"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../include/libpq/scram.h.html#LN19"><span class='Ref_to_Const'>SASL_EXCHANGE_CONTINUE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Oops, Something bad happened */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN845"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><a href="../../include/libpq/scram.h.html#LN20"><span class='Ref_to_Const'>SASL_EXCHANGE_SUCCESS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckSCRAMAuth &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * GSSAPI authentication system 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> ENABLE_GSS 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>_MSC_VER<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 * MIT Kerberos GSSAPI DLL doesn't properly export the symbols for MingW 
 * that contain the OIDs required. Redefine here, values copied 
 * from src/athena/auth/krb5/src/lib/gssapi/generic/gssapi_generic.c 
 */ 
</span><a name="LN1011"></a><span class='Keyword'>static const </span>gss_OID_desc <span class='Declare_Var'>GSS_C_NT_USER_NAME_desc</span> <span class='Operator'>= 
</span><span class='Delimiter'>{</span><span class='Number'>10</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='String'>"\x2a\x86\x48\x86\xf7\x12\x01\x02\x01\x02"</span><span class='Delimiter'>}; 
</span><a name="LN1013"></a><span class='Keyword'>static </span>GSS_DLLIMP gss_OID <span class='Declare_Var'>GSS_C_NT_USER_NAME</span> <span class='Operator'>= &</span><a href="auth.c.html#LN1011"><span class='Ref_to_Global_Var'>GSS_C_NT_USER_NAME_desc</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN1018"></a><span class='Declare_Function'>pg_GSS_error</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>severity</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>errmsg</span><span class='Delimiter'>, </span>OM_uint32 <span class='Declare_Parameter'>maj_stat</span><span class='Delimiter'>, </span>OM_uint32 <span class='Declare_Parameter'>min_stat</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1020"></a>    <a href="../../interfaces/libpq/libpq-int.h.html#LN65"><span class='Ref_to_Typedef'>gss_buffer_desc</span></a> <span class='Declare_Local'>gmsg</span><span class='Delimiter'>; 
</span><a name="LN1021"></a>    OM_uint32   <span class='Declare_Local'>lmin_s</span><span class='Delimiter'>, 
</span><a name="LN1022"></a>                <span class='Declare_Local'>msg_ctx</span><span class='Delimiter'>; 
</span><a name="LN1023"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>msg_major</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>], 
</span><a name="LN1024"></a>                <span class='Declare_Local'>msg_minor</span><span class='Delimiter'>[</span><span class='Number'>128</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch major status message */ 
</span>    <a href="auth.c.html#LN1022"><span class='Ref_To_Local'>msg_ctx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    gss_display_status<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1021"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1018"><span class='Ref_to_Parameter'>maj_stat</span></a><span class='Delimiter'>, </span>GSS_C_GSS_CODE<span class='Delimiter'>, 
</span>                       GSS_C_NO_OID<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1022"><span class='Ref_To_Local'>msg_ctx</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1020"><span class='Ref_To_Local'>gmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1023"><span class='Ref_To_Local'>msg_major</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1020"><span class='Ref_To_Local'>gmsg</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1023"><span class='Ref_To_Local'>msg_major</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1021"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1020"><span class='Ref_To_Local'>gmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1022"><span class='Ref_To_Local'>msg_ctx</span></a><span class='Parentheses'>) 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * More than one message available. XXX: Should we loop and read all 
         * messages? (same below) 
         */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"incomplete GSS error report"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch mechanism minor status message */ 
</span>    <a href="auth.c.html#LN1022"><span class='Ref_To_Local'>msg_ctx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    gss_display_status<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1021"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1018"><span class='Ref_to_Parameter'>min_stat</span></a><span class='Delimiter'>, </span>GSS_C_MECH_CODE<span class='Delimiter'>, 
</span>                       GSS_C_NO_OID<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1022"><span class='Ref_To_Local'>msg_ctx</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1020"><span class='Ref_To_Local'>gmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1024"><span class='Ref_To_Local'>msg_minor</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1020"><span class='Ref_To_Local'>gmsg</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1024"><span class='Ref_To_Local'>msg_minor</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1021"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1020"><span class='Ref_To_Local'>gmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1022"><span class='Ref_To_Local'>msg_ctx</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"incomplete GSS minor error report"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * errmsg_internal, since translation of the first part must be done 
     * before calling this function anyway. 
     */ 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1018"><span class='Ref_to_Parameter'>severity</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1018"><span class='Ref_to_Parameter'>errmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s: %s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1023"><span class='Ref_To_Local'>msg_major</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1024"><span class='Ref_To_Local'>msg_minor</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_GSS_error &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN1063"></a><span class='Declare_Function'>pg_GSS_recvauth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1065"></a>    OM_uint32   <span class='Declare_Local'>maj_stat</span><span class='Delimiter'>, 
</span><a name="LN1066"></a>                <span class='Declare_Local'>min_stat</span><span class='Delimiter'>, 
</span><a name="LN1067"></a>                <span class='Declare_Local'>lmin_s</span><span class='Delimiter'>, 
</span><a name="LN1068"></a>                <span class='Declare_Local'>gflags</span><span class='Delimiter'>; 
</span><a name="LN1069"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mtype</span><span class='Delimiter'>; 
</span><a name="LN1070"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1071"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1072"></a>    <a href="../../interfaces/libpq/libpq-int.h.html#LN65"><span class='Ref_to_Typedef'>gss_buffer_desc</span></a> <span class='Declare_Local'>gbuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * GSS auth is not supported for protocol versions before 3, because it 
     * relies on the overall message length word to determine the GSS payload 
     * size in AuthenticationGSSContinue and PasswordMessage messages. (This 
     * is, in fact, a design error in our GSS support, because protocol 
     * messages are supposed to be parsable without relying on the length 
     * word; but it's not worth changing it now.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN26"><span class='Ref_to_Global_Var'>FrontendProtocol</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"GSSAPI is not supported in protocol version 2"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN158"><span class='Ref_to_Global_Var'>pg_krb_server_keyfile</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN158"><span class='Ref_to_Global_Var'>pg_krb_server_keyfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Set default Kerberos keytab file for the Krb5 mechanism. 
         * 
         * setenv("KRB5_KTNAME", pg_krb_server_keyfile, 0); except setenv() 
         * not always available. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>getenv<span class='Parentheses'>(</span><span class='String'>"KRB5_KTNAME"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1097"></a>            size_t      <span class='Declare_Local'>kt_len</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN158"><span class='Ref_to_Global_Var'>pg_krb_server_keyfile</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>14</span><span class='Delimiter'>; 
</span><a name="LN1098"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>kt_path</span> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1097"><span class='Ref_To_Local'>kt_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN1098"><span class='Ref_To_Local'>kt_path</span></a> <span class='Operator'>|| 
</span>                <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1098"><span class='Ref_To_Local'>kt_path</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1097"><span class='Ref_To_Local'>kt_len</span></a><span class='Delimiter'>, </span><span class='String'>"KRB5_KTNAME=%s"</span><span class='Delimiter'>, 
</span>                         <a href="auth.c.html#LN158"><span class='Ref_to_Global_Var'>pg_krb_server_keyfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="auth.c.html#LN1097"><span class='Ref_To_Local'>kt_len</span></a> <span class='Operator'>- </span><span class='Number'>2</span> <span class='Operator'>|| 
</span>                <a href="../../include/port/win32.h.html#LN410"><span class='Ref_to_Macro'>putenv</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1098"><span class='Ref_To_Local'>kt_path</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pg_krb_server_keyfile... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We accept any service principal that's present in our keytab. This 
     * increases interoperability between kerberos implementations that see 
     * for example case sensitivity differently, while not really opening up 
     * any vector of attack. 
     */ 
</span>    <a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN85"><span class='Ref_to_Member'>cred</span></a> <span class='Operator'>= </span>GSS_C_NO_CREDENTIAL<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize sequence with an empty context 
     */ 
</span>    <a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN86"><span class='Ref_to_Member'>ctx</span></a> <span class='Operator'>= </span>GSS_C_NO_CONTEXT<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop through GSSAPI message exchange. This exchange can consist of 
     * multiple messages sent in both directions. First message is always from 
     * the client. All messages from client to server are password packets 
     * (type 'p'). 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/libpq/libpq.h.html#LN65"><span class='Ref_to_Proto'>pq_startmsgread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN1069"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN69"><span class='Ref_to_Proto'>pq_getbyte</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1069"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Only log error if client didn't disconnect. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1069"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span>EOF<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"expected GSS response, got message type %d"</span><span class='Delimiter'>, 
</span>                                <a href="auth.c.html#LN1069"><span class='Ref_To_Local'>mtype</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Get the actual GSS token */ 
</span>        <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1071"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN68"><span class='Ref_to_Proto'>pq_getmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1071"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN214"><span class='Ref_to_Const'>PG_MAX_AUTH_TOKEN_LENGTH</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* EOF - pq_getmessage already logged error */ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1071"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Map to GSSAPI style buffer */ 
</span>        <a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN1071"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value </span><span class='Operator'>= </span><a href="auth.c.html#LN1071"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"Processing received GSS token of length %u"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>= </span>gss_accept_sec_context<span class='Parentheses'>( 
</span>                                          <span class='Operator'>&</span><a href="auth.c.html#LN1066"><span class='Ref_To_Local'>min_stat</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN86"><span class='Ref_to_Member'>ctx</span></a><span class='Delimiter'>, 
</span>                                          <a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN85"><span class='Ref_to_Member'>cred</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Delimiter'>, 
</span>                                          GSS_C_NO_CHANNEL_BINDINGS<span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN87"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, 
</span>                                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>, 
</span>                                          <span class='Operator'>&</span><a href="auth.c.html#LN1068"><span class='Ref_To_Local'>gflags</span></a><span class='Delimiter'>, 
</span>                                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* gbuf no longer used */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1071"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN19"><span class='Ref_to_Const'>DEBUG5</span></a><span class='Delimiter'>, </span><span class='String'>"gss_accept_sec_context major: %d, "</span> 
             <span class='String'>"minor: %d, outlen: %u, outflags: %x"</span><span class='Delimiter'>, 
</span>             <a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1066"><span class='Ref_To_Local'>min_stat</span></a><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1068"><span class='Ref_To_Local'>gflags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Negotiation generated data to be sent to the client. 
             */ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"sending GSS response token of length %u"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN172"><span class='Ref_to_Const'>AUTH_REQ_GSS_CONT</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1067"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>!= </span>GSS_S_COMPLETE <span class='Operator'>&& </span><a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>!= </span>GSS_S_CONTINUE_NEEDED<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            gss_delete_sec_context<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1067"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN86"><span class='Ref_to_Member'>ctx</span></a><span class='Delimiter'>, </span>GSS_C_NO_BUFFER<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/fe-auth.c.html#LN85"><span class='Ref_to_Func'>pg_GSS_error</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"accepting GSS security context failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1066"><span class='Ref_To_Local'>min_stat</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>== </span>GSS_S_CONTINUE_NEEDED<span class='Parentheses'>) 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"GSS continue needed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>== </span>GSS_S_CONTINUE_NEEDED<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN85"><span class='Ref_to_Member'>cred</span></a> <span class='Operator'>!= </span>GSS_C_NO_CREDENTIAL<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Release service principal credentials 
         */ 
</span>        gss_release_cred<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1066"><span class='Ref_To_Local'>min_stat</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN85"><span class='Ref_to_Member'>cred</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * GSS_S_COMPLETE indicates that authentication is now complete. 
     * 
     * Get the name of the user that authenticated, and compare it to the pg 
     * username that was specified for the connection. 
     */ 
</span>    <a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>= </span>gss_display_name<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1066"><span class='Ref_To_Local'>min_stat</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN87"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a> <span class='Operator'>!= </span>GSS_S_COMPLETE<span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/fe-auth.c.html#LN85"><span class='Ref_to_Func'>pg_GSS_error</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                     <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"retrieving GSS user name failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="auth.c.html#LN1065"><span class='Ref_To_Local'>maj_stat</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1066"><span class='Ref_To_Local'>min_stat</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Split the username at the realm separator 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='String'>'@'</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1241"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cp</span> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><span class='String'>'@'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we are not going to include the realm in the username that is 
         * passed to the ident map, destructively modify it here to remove the 
         * realm. Then advance past the separator to check the realm. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN88"><span class='Ref_to_Member'>include_realm</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="auth.c.html#LN1241"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1241"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Match the realm part of the name first 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN159"><span class='Ref_to_Global_Var'>pg_krb_caseins_users</span></a><span class='Parentheses'>) 
</span>                <a href="auth.c.html#LN1070"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1241"><span class='Ref_To_Local'>cp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="auth.c.html#LN1070"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span>strcmp<span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1241"><span class='Ref_To_Local'>cp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1070"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* GSS realm does not match */ 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"GSSAPI realm (%s) and configured realm (%s) don't match"</span><span class='Delimiter'>, 
</span>                     <a href="auth.c.html#LN1241"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1067"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if port-&GT;hba-&GT;krb_realm!... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strchr(gbuf.value,'@'... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"GSSAPI did not return realm but realm matching was requested"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1067"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN1070"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/libpq/hba.h.html#LN117"><span class='Ref_to_Proto'>check_usermap</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN73"><span class='Ref_to_Member'>usermap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1063"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN159"><span class='Ref_to_Global_Var'>pg_krb_caseins_users</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    gss_release_buffer<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1067"><span class='Ref_To_Local'>lmin_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1072"><span class='Ref_To_Local'>gbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="auth.c.html#LN1070"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_GSS_recvauth &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_GSS */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * SSPI authentication system 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a> 
<span class='Keyword'>static void 
</span><a name="LN1298"></a><span class='Declare_Function'>pg_SSPI_error</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>severity</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>errmsg</span><span class='Delimiter'>, </span>SECURITY_STATUS <span class='Declare_Parameter'>r</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1300"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>sysmsg</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>FormatMessage<span class='Parentheses'>(</span>FORMAT_MESSAGE_IGNORE_INSERTS <span class='Operator'>| 
</span>                      FORMAT_MESSAGE_FROM_SYSTEM<span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                      <a href="auth.c.html#LN1300"><span class='Ref_To_Local'>sysmsg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1300"><span class='Ref_To_Local'>sysmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>severity</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>errmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSPI error %x"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>severity</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>errmsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s (%x)"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1300"><span class='Ref_To_Local'>sysmsg</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1298"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN1316"></a><span class='Declare_Function'>pg_SSPI_recvauth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1318"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mtype</span><span class='Delimiter'>; 
</span><a name="LN1319"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1320"></a>    SECURITY_STATUS <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN1321"></a>    CredHandle  <span class='Declare_Local'>sspicred</span><span class='Delimiter'>; 
</span><a name="LN1322"></a>    CtxtHandle <span class='Operator'>*</span><span class='Declare_Local'>sspictx</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN1323"></a>                <span class='Declare_Local'>newctx</span><span class='Delimiter'>; 
</span><a name="LN1324"></a>    TimeStamp   <span class='Declare_Local'>expiry</span><span class='Delimiter'>; 
</span><a name="LN1325"></a>    ULONG       <span class='Declare_Local'>contextattr</span><span class='Delimiter'>; 
</span><a name="LN1326"></a>    SecBufferDesc <span class='Declare_Local'>inbuf</span><span class='Delimiter'>; 
</span><a name="LN1327"></a>    SecBufferDesc <span class='Declare_Local'>outbuf</span><span class='Delimiter'>; 
</span><a name="LN1328"></a>    SecBuffer   <span class='Declare_Local'>OutBuffers</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1329"></a>    SecBuffer   <span class='Declare_Local'>InBuffers</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1330"></a>    HANDLE      <span class='Declare_Local'>token</span><span class='Delimiter'>; 
</span><a name="LN1331"></a>    TOKEN_USER <span class='Operator'>*</span><span class='Declare_Local'>tokenuser</span><span class='Delimiter'>; 
</span><a name="LN1332"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>retlen</span><span class='Delimiter'>; 
</span><a name="LN1333"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>accountname</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1334"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>domainname</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1335"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>accountnamesize</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1333"><span class='Ref_To_Local'>accountname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1336"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>domainnamesize</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1337"></a>    SID_NAME_USE <span class='Declare_Local'>accountnameuse</span><span class='Delimiter'>; 
</span><a name="LN1338"></a>    HMODULE     <span class='Declare_Local'>secur32</span><span class='Delimiter'>; 
</span><a name="LN1339"></a>    <a href="auth.c.html#LN182"><span class='Ref_to_Typedef'>QUERY_SECURITY_CONTEXT_TOKEN_FN</span></a> <span class='Declare_Local'>_QuerySecurityContextToken</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SSPI auth is not supported for protocol versions before 3, because it 
     * relies on the overall message length word to determine the SSPI payload 
     * size in AuthenticationGSSContinue and PasswordMessage messages. (This 
     * is, in fact, a design error in our SSPI support, because protocol 
     * messages are supposed to be parsable without relying on the length 
     * word; but it's not worth changing it now.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN26"><span class='Ref_to_Global_Var'>FrontendProtocol</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSPI is not supported in protocol version 2"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Acquire a handle to the server credentials. 
     */ 
</span>    <a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>AcquireCredentialsHandle<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='String'>"negotiate"</span><span class='Delimiter'>, 
</span>                                 SECPKG_CRED_INBOUND<span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="auth.c.html#LN1321"><span class='Ref_To_Local'>sspicred</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="auth.c.html#LN1324"><span class='Ref_To_Local'>expiry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_E_OK<span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/fe-auth.c.html#LN261"><span class='Ref_to_Func'>pg_SSPI_error</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"could not acquire SSPI credentials"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop through SSPI message exchange. This exchange can consist of 
     * multiple messages sent in both directions. First message is always from 
     * the client. All messages from client to server are password packets 
     * (type 'p'). 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/libpq/libpq.h.html#LN65"><span class='Ref_to_Proto'>pq_startmsgread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1318"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN69"><span class='Ref_to_Proto'>pq_getbyte</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1318"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Only log error if client didn't disconnect. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1318"><span class='Ref_To_Local'>mtype</span></a> <span class='Operator'>!= </span>EOF<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"expected SSPI response, got message type %d"</span><span class='Delimiter'>, 
</span>                                <a href="auth.c.html#LN1318"><span class='Ref_To_Local'>mtype</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Get the actual SSPI token */ 
</span>        <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN68"><span class='Ref_to_Proto'>pq_getmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN214"><span class='Ref_to_Const'>PG_MAX_AUTH_TOKEN_LENGTH</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* EOF - pq_getmessage already logged error */ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Map to SSPI style buffer */ 
</span>        <a href="auth.c.html#LN1326"><span class='Ref_To_Local'>inbuf</span></a><span class='Operator'>.</span>ulVersion <span class='Operator'>= </span>SECBUFFER_VERSION<span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1326"><span class='Ref_To_Local'>inbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1326"><span class='Ref_To_Local'>inbuf</span></a><span class='Operator'>.</span>pBuffers <span class='Operator'>= </span><a href="auth.c.html#LN1329"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1329"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer <span class='Operator'>= </span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1329"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer <span class='Operator'>= </span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1329"><span class='Ref_To_Local'>InBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>BufferType <span class='Operator'>= </span>SECBUFFER_TOKEN<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prepare output buffer */ 
</span>        <a href="auth.c.html#LN1328"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1328"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>BufferType <span class='Operator'>= </span>SECBUFFER_TOKEN<span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1328"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers <span class='Operator'>= </span><a href="auth.c.html#LN1328"><span class='Ref_To_Local'>OutBuffers</span></a><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>ulVersion <span class='Operator'>= </span>SECBUFFER_VERSION<span class='Delimiter'>; 
</span> 
 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"Processing received SSPI token of length %u"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>AcceptSecurityContext<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1321"><span class='Ref_To_Local'>sspicred</span></a><span class='Delimiter'>, 
</span>                                  <a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="auth.c.html#LN1326"><span class='Ref_To_Local'>inbuf</span></a><span class='Delimiter'>, 
</span>                                  ASC_REQ_ALLOCATE_MEMORY<span class='Delimiter'>, 
</span>                                  SECURITY_NETWORK_DREP<span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="auth.c.html#LN1323"><span class='Ref_To_Local'>newctx</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="auth.c.html#LN1325"><span class='Ref_To_Local'>contextattr</span></a><span class='Delimiter'>, 
</span>                                  <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* input buffer no longer used */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1319"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>cBuffers <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Negotiation generated data to be sent to the client. 
             */ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"sending SSPI response token of length %u"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>cbBuffer<span class='Delimiter'>; 
</span>            <a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value </span><span class='Operator'>= </span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer<span class='Delimiter'>; 
</span> 
            <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN172"><span class='Ref_to_Const'>AUTH_REQ_GSS_CONT</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN83"><span class='Ref_to_Member'>outbuf</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN60"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            FreeContextBuffer<span class='Parentheses'>(</span><a href="auth.c.html#LN1327"><span class='Ref_To_Local'>outbuf</span></a><span class='Operator'>.</span>pBuffers<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span>pvBuffer<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_E_OK <span class='Operator'>&& </span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_I_CONTINUE_NEEDED<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                DeleteSecurityContext<span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            FreeCredentialsHandle<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1321"><span class='Ref_To_Local'>sspicred</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/fe-auth.c.html#LN261"><span class='Ref_to_Func'>pg_SSPI_error</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                          _<span class='Parentheses'>(</span><span class='String'>"could not accept SSPI security context"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Overwrite the current context with the one we just received. If 
         * sspictx is NULL it was the first loop and we need to allocate a 
         * buffer for it. On subsequent runs, we can just overwrite the buffer 
         * contents since the size does not change. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>CtxtHandle<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1323"><span class='Ref_To_Local'>newctx</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>CtxtHandle<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span>SEC_I_CONTINUE_NEEDED<span class='Parentheses'>) 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, </span><span class='String'>"SSPI continue needed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span>SEC_I_CONTINUE_NEEDED<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Release service principal credentials 
     */ 
</span>    FreeCredentialsHandle<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1321"><span class='Ref_To_Local'>sspicred</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * SEC_E_OK indicates that authentication is now complete. 
     * 
     * Get the name of the user that authenticated, and compare it to the pg 
     * username that was specified for the connection. 
     * 
     * MingW is missing the export for QuerySecurityContextToken in the 
     * secur32 library, so we have to load it dynamically. 
     */ 
</span> 
    <a href="auth.c.html#LN1338"><span class='Ref_To_Local'>secur32</span></a> <span class='Operator'>= </span>LoadLibrary<span class='Parentheses'>(</span><span class='String'>"SECUR32.DLL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1338"><span class='Ref_To_Local'>secur32</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not load secur32.dll: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN1339"><span class='Ref_To_Local'>_QuerySecurityContextToken</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="auth.c.html#LN182"><span class='Ref_to_Typedef'>QUERY_SECURITY_CONTEXT_TOKEN_FN</span></a><span class='Parentheses'>) 
</span>        GetProcAddress<span class='Parentheses'>(</span><a href="auth.c.html#LN1338"><span class='Ref_To_Local'>secur32</span></a><span class='Delimiter'>, </span><span class='String'>"QuerySecurityContextToken"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1339"><span class='Ref_To_Local'>_QuerySecurityContextToken</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        FreeLibrary<span class='Parentheses'>(</span><a href="auth.c.html#LN1338"><span class='Ref_To_Local'>secur32</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not locate QuerySecurityContextToken in secur32.dll: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="auth.c.html#LN1339"><span class='Ref_To_Local'>_QuerySecurityContextToken</span></a><span class='Parentheses'>) (</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1330"><span class='Ref_To_Local'>token</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>SEC_E_OK<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        FreeLibrary<span class='Parentheses'>(</span><a href="auth.c.html#LN1338"><span class='Ref_To_Local'>secur32</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/fe-auth.c.html#LN261"><span class='Ref_to_Func'>pg_SSPI_error</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                      _<span class='Parentheses'>(</span><span class='String'>"could not get token from SSPI security context"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1320"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    FreeLibrary<span class='Parentheses'>(</span><a href="auth.c.html#LN1338"><span class='Ref_To_Local'>secur32</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No longer need the security context, everything from here on uses the 
     * token instead. 
     */ 
</span>    DeleteSecurityContext<span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1322"><span class='Ref_To_Local'>sspictx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetTokenInformation<span class='Parentheses'>(</span><a href="auth.c.html#LN1330"><span class='Ref_To_Local'>token</span></a><span class='Delimiter'>, </span>TokenUser<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1332"><span class='Ref_To_Local'>retlen</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>GetLastError<span class='Parentheses'>() </span><span class='Operator'>!= </span><span class='Number'>122</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not get token information buffer size: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN1331"><span class='Ref_To_Local'>tokenuser</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1332"><span class='Ref_To_Local'>retlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1331"><span class='Ref_To_Local'>tokenuser</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetTokenInformation<span class='Parentheses'>(</span><a href="auth.c.html#LN1330"><span class='Ref_To_Local'>token</span></a><span class='Delimiter'>, </span>TokenUser<span class='Delimiter'>, </span><a href="auth.c.html#LN1331"><span class='Ref_To_Local'>tokenuser</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1332"><span class='Ref_To_Local'>retlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1332"><span class='Ref_To_Local'>retlen</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>          <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not get token information: error code %lu"</span><span class='Delimiter'>, 
</span>                           GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span> 
    CloseHandle<span class='Parentheses'>(</span><a href="auth.c.html#LN1330"><span class='Ref_To_Local'>token</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>LookupAccountSid<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1331"><span class='Ref_To_Local'>tokenuser</span></a><span class='Operator'>-&GT;</span>User<span class='Operator'>.</span>Sid<span class='Delimiter'>, </span><a href="auth.c.html#LN1333"><span class='Ref_To_Local'>accountname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1335"><span class='Ref_To_Local'>accountnamesize</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1336"><span class='Ref_To_Local'>domainnamesize</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1337"><span class='Ref_To_Local'>accountnameuse</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not look up account SID: error code %lu"</span><span class='Delimiter'>, 
</span>                             GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1331"><span class='Ref_To_Local'>tokenuser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN89"><span class='Ref_to_Member'>compat_realm</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1559"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span> <span class='Operator'>= </span><a href="auth.c.html#LN186"><span class='Ref_to_Proto'>pg_SSPI_make_upn</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1333"><span class='Ref_To_Local'>accountname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1333"><span class='Ref_To_Local'>accountname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                              <a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                              <a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN90"><span class='Ref_to_Member'>upn_username</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1559"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Comment_Multi_Line'>/* Error already reported from pg_SSPI_make_upn */ 
</span>            <span class='Control'>return</span> <a href="auth.c.html#LN1559"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compare realm/domain if requested. In SSPI, always compare case 
     * insensitive. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a> <span class='Operator'>&& </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"SSPI domain (%s) and configured domain (%s) don't match"</span><span class='Delimiter'>, 
</span>                 <a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN87"><span class='Ref_to_Member'>krb_realm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have the username (without domain/realm) in accountname, compare to 
     * the supplied value. In SSPI, always compare case insensitive. 
     * 
     * If set to include realm, append it in &LT;username&GT;@&LT;realm&GT; format. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN88"><span class='Ref_to_Member'>include_realm</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1592"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>namebuf</span><span class='Delimiter'>; 
</span><a name="LN1593"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN1592"><span class='Ref_To_Local'>namebuf</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s@%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1333"><span class='Ref_To_Local'>accountname</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1334"><span class='Ref_To_Local'>domainname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1593"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/libpq/hba.h.html#LN117"><span class='Ref_to_Proto'>check_usermap</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN73"><span class='Ref_to_Member'>usermap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1592"><span class='Ref_To_Local'>namebuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1592"><span class='Ref_To_Local'>namebuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="auth.c.html#LN1593"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../include/libpq/hba.h.html#LN117"><span class='Ref_to_Proto'>check_usermap</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN73"><span class='Ref_to_Member'>usermap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1316"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1333"><span class='Ref_To_Local'>accountname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_SSPI_recvauth &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Replaces the domainname with the Kerberos realm name, 
 * and optionally the accountname with the Kerberos user name. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1609"></a><span class='Declare_Function'>pg_SSPI_make_upn</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>accountname</span><span class='Delimiter'>, 
</span><a name="LN1610"></a>                 size_t <span class='Declare_Parameter'>accountnamesize</span><span class='Delimiter'>, 
</span><a name="LN1611"></a>                 <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>domainname</span><span class='Delimiter'>, 
</span><a name="LN1612"></a>                 size_t <span class='Declare_Parameter'>domainnamesize</span><span class='Delimiter'>, 
</span><a name="LN1613"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>update_accountname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1615"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>samname</span><span class='Delimiter'>; 
</span><a name="LN1616"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>upname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1617"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>p</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1618"></a>    ULONG       <span class='Declare_Local'>upnamesize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1619"></a>    size_t      <span class='Declare_Local'>upnamerealmsize</span><span class='Delimiter'>; 
</span><a name="LN1620"></a>    BOOLEAN     <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build SAM name (DOMAIN\user), then translate to UPN 
     * (user@kerberos.realm). The realm name is returned in lower case, but 
     * that is fine because in SSPI auth, string comparisons are always 
     * case-insensitive. 
     */ 
</span> 
    <a href="auth.c.html#LN1615"><span class='Ref_To_Local'>samname</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s\\%s"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN1611"><span class='Ref_to_Parameter'>domainname</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1609"><span class='Ref_to_Parameter'>accountname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1620"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span>TranslateName<span class='Parentheses'>(</span><a href="auth.c.html#LN1615"><span class='Ref_To_Local'>samname</span></a><span class='Delimiter'>, </span>NameSamCompatible<span class='Delimiter'>, </span>NameUserPrincipal<span class='Delimiter'>, 
</span>                        <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1618"><span class='Ref_To_Local'>upnamesize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Operator'>!</span><a href="auth.c.html#LN1620"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&& </span>GetLastError<span class='Parentheses'>() </span><span class='Operator'>!= </span>ERROR_INSUFFICIENT_BUFFER<span class='Parentheses'>)</span> 
        <span class='Operator'>|| </span><a href="auth.c.html#LN1618"><span class='Ref_To_Local'>upnamesize</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1615"><span class='Ref_To_Local'>samname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_ROLE_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not translate name"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* upnamesize includes the terminating NUL. */ 
</span>    <a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1618"><span class='Ref_To_Local'>upnamesize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN1620"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span>TranslateName<span class='Parentheses'>(</span><a href="auth.c.html#LN1615"><span class='Ref_To_Local'>samname</span></a><span class='Delimiter'>, </span>NameSamCompatible<span class='Delimiter'>, </span>NameUserPrincipal<span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1618"><span class='Ref_To_Local'>upnamesize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1615"><span class='Ref_To_Local'>samname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1620"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN1617"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Delimiter'>, </span><span class='String'>'@'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN1620"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>|| </span><a href="auth.c.html#LN1617"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_ROLE_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not translate name"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Length of realm name after the '@', including the NUL. */ 
</span>    <a href="auth.c.html#LN1619"><span class='Ref_To_Local'>upnamerealmsize</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN1618"><span class='Ref_To_Local'>upnamesize</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="auth.c.html#LN1617"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>- </span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Replace domainname with realm name. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1619"><span class='Ref_To_Local'>upnamerealmsize</span></a> <span class='Operator'>&GT; </span><a href="auth.c.html#LN1612"><span class='Ref_to_Parameter'>domainnamesize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_ROLE_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"realm name too long"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Length is now safe. */ 
</span>    <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1611"><span class='Ref_to_Parameter'>domainname</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1617"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Replace account name as well (in case UPN != SAM)? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1613"><span class='Ref_to_Parameter'>update_accountname</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN1617"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>- </span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="auth.c.html#LN1610"><span class='Ref_to_Parameter'>accountnamesize</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_ROLE_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"translated account name too long"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Operator'>*</span><a href="auth.c.html#LN1617"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1609"><span class='Ref_to_Parameter'>accountname</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1616"><span class='Ref_To_Local'>upname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_SSPI_make_upn &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_SSPI */ 
</span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * Ident authentication system 
 *---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Parse the string "*ident_response" as a response from a query to an Ident 
 *  server.  If it's a normal response indicating a user name, return true 
 *  and store the user name at *ident_user. If it's anything else, 
 *  return false. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1713"></a><span class='Declare_Function'>interpret_ident_response</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ident_response</span><span class='Delimiter'>, 
</span><a name="LN1714"></a>                         <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ident_user</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1716"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>cursor</span> <span class='Operator'>= </span><a href="auth.c.html#LN1713"><span class='Ref_to_Parameter'>ident_response</span></a><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Cursor into *ident_response */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ident's response, in the telnet tradition, should end in crlf (\r\n). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN1713"><span class='Ref_to_Parameter'>ident_response</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1713"><span class='Ref_to_Parameter'>ident_response</span></a><span class='Delimiter'>[</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN1713"><span class='Ref_to_Parameter'>ident_response</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\r'</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>':'</span> <span class='Operator'>&& *</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>'\r'</span><span class='Parentheses'>) 
</span>            <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* skip port field */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>':'</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We're positioned to colon before response type field */ 
</span><a name="LN1735"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>response_type</span><span class='Delimiter'>[</span><span class='Number'>80</span><span class='Delimiter'>]; 
</span><a name="LN1736"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Index into *response_type */ 
</span> 
            <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Go over colon */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN120"><span class='Ref_to_Proto'>pg_isblank</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Parentheses'>))</span> 
                <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* skip blanks */ 
</span>            <a href="auth.c.html#LN1736"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>':'</span> <span class='Operator'>&& *</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>'\r'</span> <span class='Operator'>&& !</span><a href="../../include/libpq/hba.h.html#LN120"><span class='Ref_to_Proto'>pg_isblank</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                   <a href="auth.c.html#LN1736"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1735"><span class='Ref_To_Local'>response_type</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
                <a href="auth.c.html#LN1735"><span class='Ref_To_Local'>response_type</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN1736"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="auth.c.html#LN1735"><span class='Ref_To_Local'>response_type</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN1736"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN120"><span class='Ref_to_Proto'>pg_isblank</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Parentheses'>))</span> 
                <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* skip blanks */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="auth.c.html#LN1735"><span class='Ref_To_Local'>response_type</span></a><span class='Delimiter'>, </span><span class='String'>"USERID"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * It's a USERID response.  Good.  "cursor" should be pointing 
                 * to the colon that precedes the operating system type. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>':'</span><span class='Parentheses'>) 
</span>                    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Go over colon */ 
</span>                    <span class='Comment_Multi_Line'>/* Skip over operating system field. */ 
</span>                    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>':'</span> <span class='Operator'>&& *</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>'\r'</span><span class='Parentheses'>) 
</span>                        <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>':'</span><span class='Parentheses'>) 
</span>                        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span><a name="LN1768"></a>                        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* Index into *ident_user */ 
</span> 
                        <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Go over colon */ 
</span>                        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN120"><span class='Ref_to_Proto'>pg_isblank</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Parentheses'>))</span> 
                            <a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* skip blanks */ 
</span>                        <span class='Comment_Multi_Line'>/* Rest of line is user name.  Copy it over. */ 
</span>                        <a href="auth.c.html#LN1768"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><span class='String'>'\r'</span> <span class='Operator'>&& </span><a href="auth.c.html#LN1768"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="auth.c.html#LN67"><span class='Ref_to_Const'>IDENT_USERNAME_MAX</span></a><span class='Parentheses'>) 
</span>                            <a href="auth.c.html#LN1714"><span class='Ref_to_Parameter'>ident_user</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN1768"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="auth.c.html#LN1716"><span class='Ref_To_Local'>cursor</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                        <a href="auth.c.html#LN1714"><span class='Ref_to_Parameter'>ident_user</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN1768"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>                        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end interpret_ident_response &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  Talk to the ident server on host "remote_ip_addr" and find out who 
 *  owns the tcp connection from his port "remote_port" to port 
 *  "local_port_addr" on host "local_ip_addr".  Return the user name the 
 *  ident server gives as "*ident_user". 
 * 
 *  IP addresses and port numbers are in network byte order. 
 * 
 *  But iff we're unable to get the information from ident, return false. 
 * 
 *  XXX: Using WaitLatchOrSocket() and doing a CHECK_FOR_INTERRUPTS() if the 
 *  latch was set would improve the responsiveness to timeouts/cancellations. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1801"></a><span class='Declare_Function'>ident_inet</span><span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN112"><span class='Ref_to_Typedef'>hbaPort</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1803"></a>    <span class='Keyword'>const </span><a href="../../include/libpq/pqcomm.h.html#LN61"><span class='Ref_to_Typedef'>SockAddr</span></a> <span class='Declare_Local'>remote_addr</span> <span class='Operator'>= </span><a href="auth.c.html#LN1801"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Delimiter'>; 
</span><a name="LN1804"></a>    <span class='Keyword'>const </span><a href="../../include/libpq/pqcomm.h.html#LN61"><span class='Ref_to_Typedef'>SockAddr</span></a> <span class='Declare_Local'>local_addr</span> <span class='Operator'>= </span><a href="auth.c.html#LN1801"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Delimiter'>; 
</span><a name="LN1805"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>ident_user</span><span class='Delimiter'>[</span><a href="auth.c.html#LN67"><span class='Ref_to_Const'>IDENT_USERNAME_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1806"></a>    <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a>    <span class='Declare_Local'>sock_fd</span> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* for talking to Ident server */ 
</span><a name="LN1807"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* Return code from a locally called function */ 
</span><a name="LN1808"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>ident_return</span><span class='Delimiter'>; 
</span><a name="LN1809"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>remote_addr_s</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span><a name="LN1810"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>remote_port</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN90"><span class='Ref_to_Const'>NI_MAXSERV</span></a><span class='Delimiter'>]; 
</span><a name="LN1811"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>local_addr_s</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span><a name="LN1812"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>local_port</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN90"><span class='Ref_to_Const'>NI_MAXSERV</span></a><span class='Delimiter'>]; 
</span><a name="LN1813"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>ident_port</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN90"><span class='Ref_to_Const'>NI_MAXSERV</span></a><span class='Delimiter'>]; 
</span><a name="LN1814"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>ident_query</span><span class='Delimiter'>[</span><span class='Number'>80</span><span class='Delimiter'>]; 
</span><a name="LN1815"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>ident_response</span><span class='Delimiter'>[</span><span class='Number'>80</span> <span class='Operator'>+ </span><a href="auth.c.html#LN67"><span class='Ref_to_Const'>IDENT_USERNAME_MAX</span></a><span class='Delimiter'>]; 
</span><a name="LN1816"></a>    <span class='Control'>struct</span> <a href="../../include/getaddrinfo.h.html#LN114"><span class='Ref_to_Struct'>addrinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ident_serv</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN1817"></a>               <span class='Operator'>*</span><span class='Declare_Local'>la</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN1818"></a>                <span class='Declare_Local'>hints</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Might look a little weird to first convert it to text and then back to 
     * sockaddr, but it's protocol independent. 
     */ 
</span>    <a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1803"><span class='Ref_To_Local'>remote_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1803"><span class='Ref_To_Local'>remote_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN1809"><span class='Ref_To_Local'>remote_addr_s</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1809"><span class='Ref_To_Local'>remote_addr_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN1810"><span class='Ref_To_Local'>remote_port</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1810"><span class='Ref_To_Local'>remote_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a> <span class='Operator'>| </span><a href="../../include/getaddrinfo.h.html#LN80"><span class='Ref_to_Const'>NI_NUMERICSERV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN1804"><span class='Ref_To_Local'>local_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1804"><span class='Ref_To_Local'>local_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN1811"><span class='Ref_To_Local'>local_addr_s</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1811"><span class='Ref_To_Local'>local_addr_s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN1812"><span class='Ref_To_Local'>local_port</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1812"><span class='Ref_To_Local'>local_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a> <span class='Operator'>| </span><a href="../../include/getaddrinfo.h.html#LN80"><span class='Ref_to_Const'>NI_NUMERICSERV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1813"><span class='Ref_To_Local'>ident_port</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1813"><span class='Ref_To_Local'>ident_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN70"><span class='Ref_to_Const'>IDENT_PORT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN99"><span class='Ref_to_Member'>ai_flags</span></a> <span class='Operator'>= </span><a href="../../include/getaddrinfo.h.html#LN70"><span class='Ref_to_Const'>AI_NUMERICHOST</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN1803"><span class='Ref_To_Local'>remote_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN101"><span class='Ref_to_Member'>ai_socktype</span></a> <span class='Operator'>= </span>SOCK_STREAM<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN102"><span class='Ref_to_Member'>ai_protocol</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN105"><span class='Ref_to_Member'>ai_canonname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN106"><span class='Ref_to_Member'>ai_next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN26"><span class='Ref_to_Proto'>pg_getaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1809"><span class='Ref_To_Local'>remote_addr_s</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1813"><span class='Ref_To_Local'>ident_port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>|| !</span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we don't expect this to happen */ 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN99"><span class='Ref_to_Member'>ai_flags</span></a> <span class='Operator'>= </span><a href="../../include/getaddrinfo.h.html#LN70"><span class='Ref_to_Const'>AI_NUMERICHOST</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN1804"><span class='Ref_To_Local'>local_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN101"><span class='Ref_to_Member'>ai_socktype</span></a> <span class='Operator'>= </span>SOCK_STREAM<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN102"><span class='Ref_to_Member'>ai_protocol</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN105"><span class='Ref_to_Member'>ai_canonname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN106"><span class='Ref_to_Member'>ai_next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN26"><span class='Ref_to_Proto'>pg_getaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1811"><span class='Ref_To_Local'>local_addr_s</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1818"><span class='Ref_To_Local'>hints</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1817"><span class='Ref_To_Local'>la</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>|| !</span><a href="auth.c.html#LN1817"><span class='Ref_To_Local'>la</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we don't expect this to happen */ 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN368"><span class='Ref_to_Macro'>socket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN101"><span class='Ref_to_Member'>ai_socktype</span></a><span class='Delimiter'>, 
</span>                     <a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN102"><span class='Ref_to_Member'>ai_protocol</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create socket for Ident connection: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Bind to the address which the client originally contacted, otherwise 
     * the ident server won't be able to match up the right connection. This 
     * is necessary if the PostgreSQL server is running on an IP alias. 
     */ 
</span>    <a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN369"><span class='Ref_to_Macro'>bind</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1817"><span class='Ref_To_Local'>la</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1817"><span class='Ref_To_Local'>la</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not bind to local address \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN1811"><span class='Ref_To_Local'>local_addr_s</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN372"><span class='Ref_to_Macro'>connect</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a><span class='Delimiter'>, 
</span>                 <a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not connect to Ident server at address \"%s\", port %s: %m"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN1809"><span class='Ref_To_Local'>remote_addr_s</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1813"><span class='Ref_To_Local'>ident_port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* The query we send to the Ident server */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1814"><span class='Ref_To_Local'>ident_query</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1814"><span class='Ref_To_Local'>ident_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s,%s\r\n"</span><span class='Delimiter'>, 
</span>             <a href="auth.c.html#LN1810"><span class='Ref_To_Local'>remote_port</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1812"><span class='Ref_To_Local'>local_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* loop in case send is interrupted */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1814"><span class='Ref_To_Local'>ident_query</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN1814"><span class='Ref_To_Local'>ident_query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not send query to Ident server at address \"%s\", port %s: %m"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN1809"><span class='Ref_To_Local'>remote_addr_s</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1813"><span class='Ref_To_Local'>ident_port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN374"><span class='Ref_to_Macro'>recv</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1815"><span class='Ref_To_Local'>ident_response</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN1815"><span class='Ref_To_Local'>ident_response</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive response from Ident server at address \"%s\", port %s: %m"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN1809"><span class='Ref_To_Local'>remote_addr_s</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1813"><span class='Ref_To_Local'>ident_port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN1951"><span class='Ref_to_Label'>ident_inet_done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN1815"><span class='Ref_To_Local'>ident_response</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN1807"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN1712"><span class='Ref_to_Func'>interpret_ident_response</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1815"><span class='Ref_To_Local'>ident_response</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1805"><span class='Ref_To_Local'>ident_user</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalidly formatted response from Ident server: \"%s\""</span><span class='Delimiter'>, 
</span>                    <a href="auth.c.html#LN1815"><span class='Ref_To_Local'>ident_response</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<a name="LN1951"></a><span class='Label'>ident_inet_done</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a> <span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1806"><span class='Ref_To_Local'>sock_fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1803"><span class='Ref_To_Local'>remote_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Delimiter'>, </span><a href="auth.c.html#LN1816"><span class='Ref_To_Local'>ident_serv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1817"><span class='Ref_To_Local'>la</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1804"><span class='Ref_To_Local'>local_addr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Delimiter'>, </span><a href="auth.c.html#LN1817"><span class='Ref_To_Local'>la</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN1808"><span class='Ref_To_Local'>ident_return</span></a><span class='Parentheses'>) 
</span>        <span class='Comment_Multi_Line'>/* Success! Check the usermap */ 
</span>        <span class='Control'>return</span> <a href="../../include/libpq/hba.h.html#LN117"><span class='Ref_to_Proto'>check_usermap</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1801"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN73"><span class='Ref_to_Member'>usermap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1801"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1805"><span class='Ref_To_Local'>ident_user</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ident_inet &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Ask kernel about the credentials of the connecting process, 
 *  determine the symbolic name of the corresponding user, and check 
 *  if valid per the usermap. 
 * 
 *  Iff authorized, return STATUS_OK, otherwise return STATUS_ERROR. 
 */ 
</span><span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
 
<span class='Keyword'>static int 
</span><a name="LN1975"></a><span class='Declare_Function'>auth_peer</span><span class='Parentheses'>(</span><a href="../../include/libpq/hba.h.html#LN112"><span class='Ref_to_Typedef'>hbaPort</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1977"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>ident_user</span><span class='Delimiter'>[</span><a href="auth.c.html#LN67"><span class='Ref_to_Const'>IDENT_USERNAME_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1978"></a>    <a href="../../include/port/win32.h.html#LN249"><span class='Ref_to_Typedef'>uid_t</span></a>       <span class='Declare_Local'>uid</span><span class='Delimiter'>; 
</span><a name="LN1979"></a>    <a href="../../include/port/win32.h.html#LN250"><span class='Ref_to_Typedef'>gid_t</span></a>       <span class='Declare_Local'>gid</span><span class='Delimiter'>; 
</span><a name="LN1980"></a>    <span class='Control'>struct</span> passwd <span class='Operator'>*</span><span class='Declare_Local'>pw</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/getpeereid.c.html#LN33"><span class='Ref_to_Func'>getpeereid</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1975"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1978"><span class='Ref_To_Local'>uid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN1979"><span class='Ref_To_Local'>gid</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Provide special error message if getpeereid is a stub */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOSYS<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"peer authentication is not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not get peer credentials: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* clear errno before call */ 
</span>    <a href="auth.c.html#LN1980"><span class='Ref_To_Local'>pw</span></a> <span class='Operator'>= </span>getpwuid<span class='Parentheses'>(</span><a href="auth.c.html#LN1978"><span class='Ref_To_Local'>uid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN1980"><span class='Ref_To_Local'>pw</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not look up local user ID %ld: %s"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="auth.c.html#LN1978"><span class='Ref_To_Local'>uid</span></a><span class='Delimiter'>, 
</span>                        errno <span class='Operator'>? </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>) </span><span class='Operator'>: </span>_<span class='Parentheses'>(</span><span class='String'>"user does not exist"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1977"><span class='Ref_To_Local'>ident_user</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1980"><span class='Ref_To_Local'>pw</span></a><span class='Operator'>-&GT;</span>pw_name<span class='Delimiter'>, </span><a href="auth.c.html#LN67"><span class='Ref_to_Const'>IDENT_USERNAME_MAX</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/libpq/hba.h.html#LN117"><span class='Ref_to_Proto'>check_usermap</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN1975"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN73"><span class='Ref_to_Member'>usermap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1975"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN1977"><span class='Ref_To_Local'>ident_user</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end auth_peer &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UNIX_SOCKETS */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * PAM authentication system 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> USE_PAM 
 
<span class='Comment_Multi_Line'>/* 
 * PAM conversation function 
 */ 
</span> 
<span class='Keyword'>static int 
</span><a name="LN2025"></a><span class='Declare_Function'>pam_passwd_conv_proc</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>num_msg</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><span class='Control'>struct</span> pam_message <span class='Operator'>** </span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, 
</span><a name="LN2026"></a>                     <span class='Control'>struct</span> pam_response <span class='Operator'>** </span><span class='Declare_Parameter'>resp</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>appdata_ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2028"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>passwd</span><span class='Delimiter'>; 
</span><a name="LN2029"></a>    <span class='Control'>struct</span> pam_response <span class='Operator'>*</span><span class='Declare_Local'>reply</span><span class='Delimiter'>; 
</span><a name="LN2030"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2026"><span class='Ref_to_Parameter'>appdata_ptr</span></a><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="auth.c.html#LN2026"><span class='Ref_to_Parameter'>appdata_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Workaround for Solaris 2.6 where the PAM library is broken and does 
         * not pass appdata_ptr to the conversation routine 
         */ 
</span>        <a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="auth.c.html#LN2026"><span class='Ref_to_Parameter'>resp</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* in case of error exit */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>num_msg</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>num_msg</span></a> <span class='Operator'>&GT; </span>PAM_MAX_NUM_MSG<span class='Parentheses'>) 
</span>        <span class='Control'>return</span> PAM_CONV_ERR<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Explicitly not using palloc here - PAM will free this memory in 
     * pam_end() 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>num_msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> pam_response<span class='Parentheses'>)))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> PAM_CONV_ERR<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>num_msg</span></a><span class='Delimiter'>; </span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>msg_style<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> PAM_PROMPT_ECHO_OFF<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Password wasn't passed to PAM the first time around - 
                     * let's go ask the client to send a password, which we 
                     * then stuff into PAM. 
                     */ 
</span>                    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN103"><span class='Ref_to_Global_Var'>pam_port_cludge</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN48"><span class='Ref_to_Proto'>recv_password_packet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN103"><span class='Ref_to_Global_Var'>pam_port_cludge</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * Client didn't want to send password.  We 
                         * intentionally do not log anything about this. 
                         */ 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN2115"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                              <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"empty password returned by client"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN2115"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strlen(passwd)==0 &raquo; </span> 
                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>resp <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="auth.c.html#LN2028"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN2115"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>                <a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>resp_retcode <span class='Operator'>= </span>PAM_SUCCESS<span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> PAM_ERROR_MSG<span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"error from underlying PAM layer: %s"</span><span class='Delimiter'>, 
</span>                                <a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>msg<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* FALL THROUGH */ 
</span>            <span class='Control'>case</span> PAM_TEXT_INFO<span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* we don't bother to log TEXT_INFO messages */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>resp <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><span class='String'>""</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN2115"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>                <a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>resp_retcode <span class='Operator'>= </span>PAM_SUCCESS<span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"unsupported PAM conversation %d/\"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>msg_style<span class='Delimiter'>, 
</span>                     <a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>msg <span class='Operator'>? </span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>msg <span class='Operator'>: </span><span class='String'>"(none)"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="auth.c.html#LN2115"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch msg[i]-&GT;msg_style &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;num_msg;i++ &raquo; </span> 
 
    <span class='Operator'>*</span><a href="auth.c.html#LN2026"><span class='Ref_to_Parameter'>resp</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> PAM_SUCCESS<span class='Delimiter'>; 
</span> 
<a name="LN2115"></a><span class='Label'>fail</span><span class='Operator'>: 
</span>    <span class='Comment_Multi_Line'>/* free up whatever we allocated */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="auth.c.html#LN2025"><span class='Ref_to_Parameter'>num_msg</span></a><span class='Delimiter'>; </span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>resp <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2030"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>resp<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2029"><span class='Ref_To_Local'>reply</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> PAM_CONV_ERR<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pam_passwd_conv_proc &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Check authentication against PAM. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2132"></a><span class='Declare_Function'>CheckPAMAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>password</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2134"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN2135"></a>    pam_handle_t <span class='Operator'>*</span><span class='Declare_Local'>pamh</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2136"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>hostinfo</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Delimiter'>, 
</span>                                <a href="auth.c.html#LN2136"><span class='Ref_To_Local'>hostinfo</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2136"><span class='Ref_To_Local'>hostinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>          <a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN75"><span class='Ref_to_Member'>pam_use_hostname</span></a> <span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a> <span class='Operator'>| </span><a href="../../include/getaddrinfo.h.html#LN80"><span class='Ref_to_Const'>NI_NUMERICSERV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"pg_getnameinfo_all() failed: %s"</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We can't entirely rely on PAM to pass through appdata --- it appears 
     * not to work on at least Solaris 2.6.  So use these ugly static 
     * variables instead. 
     */ 
</span>    <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>password</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN103"><span class='Ref_to_Global_Var'>pam_port_cludge</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the application data portion of the conversation struct.  This is 
     * later used inside the PAM conversation to pass the password to the 
     * authentication module. 
     */ 
</span>    <a href="auth.c.html#LN97"><span class='Ref_to_Global_Var'>pam_passw_conv</span></a><span class='Operator'>.</span>appdata_ptr <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>password</span></a><span class='Delimiter'>;</span>     <span class='Comment_Multi_Line'>/* from password above, 
                                                         * not allocated */ 
</span> 
    <span class='Comment_Multi_Line'>/* Optionally, one can set the service name in pg_hba.conf */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN74"><span class='Ref_to_Member'>pamservice</span></a> <span class='Operator'>&& </span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN74"><span class='Ref_to_Member'>pamservice</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_start<span class='Parentheses'>(</span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN74"><span class='Ref_to_Member'>pamservice</span></a><span class='Delimiter'>, </span><span class='String'>"pgsql@"</span><span class='Delimiter'>, 
</span>                           <span class='Operator'>&</span><a href="auth.c.html#LN97"><span class='Ref_to_Global_Var'>pam_passw_conv</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_start<span class='Parentheses'>(</span><a href="auth.c.html#LN91"><span class='Ref_to_Const'>PGSQL_PAM_SERVICE</span></a><span class='Delimiter'>, </span><span class='String'>"pgsql@"</span><span class='Delimiter'>, 
</span>                           <span class='Operator'>&</span><a href="auth.c.html#LN97"><span class='Ref_to_Global_Var'>pam_passw_conv</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create PAM authenticator: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Unset pam_passwd */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_set_item<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span>PAM_USER<span class='Delimiter'>, </span><a href="auth.c.html#LN2132"><span class='Ref_to_Parameter'>user</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pam_set_item(PAM_USER) failed: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Unset pam_passwd */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_set_item<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span>PAM_RHOST<span class='Delimiter'>, </span><a href="auth.c.html#LN2136"><span class='Ref_To_Local'>hostinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pam_set_item(PAM_RHOST) failed: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_set_item<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span>PAM_CONV<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN97"><span class='Ref_to_Global_Var'>pam_passw_conv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pam_set_item(PAM_CONV) failed: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Unset pam_passwd */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_authenticate<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pam_authenticate failed: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Unset pam_passwd */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_acct_mgmt<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pam_acct_mgmt failed: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Unset pam_passwd */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>pam_end<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>!= </span>PAM_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not release PAM authenticator: %s"</span><span class='Delimiter'>, 
</span>                        pam_strerror<span class='Parentheses'>(</span><a href="auth.c.html#LN2135"><span class='Ref_To_Local'>pamh</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN102"><span class='Ref_to_Global_Var'>pam_passwd</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Unset pam_passwd */ 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2134"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>== </span>PAM_SUCCESS <span class='Operator'>? </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a> <span class='Operator'>: </span><a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckPAMAuth &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_PAM */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * BSD authentication system 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> USE_BSD_AUTH 
<span class='Keyword'>static int 
</span><a name="LN2259"></a><span class='Declare_Function'>CheckBSDAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2261"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>passwd</span><span class='Delimiter'>; 
</span><a name="LN2262"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Send regular password request to client, and get the response */ 
</span>    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2259"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2261"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN48"><span class='Ref_to_Proto'>recv_password_packet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2259"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2261"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ask the BSD auth system to verify password.  Note that auth_userokay 
     * will overwrite the password string with zeroes, but it's just a 
     * temporary string so we don't care. 
     */ 
</span>    <a href="auth.c.html#LN2262"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span>auth_userokay<span class='Parentheses'>(</span><a href="auth.c.html#LN2259"><span class='Ref_to_Parameter'>user</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"auth-postgresql"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2261"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN2262"><span class='Ref_To_Local'>retval</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckBSDAuth &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_BSD_AUTH */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * LDAP authentication system 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> USE_LDAP 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a connection to the LDAP server, including setting up 
 * TLS if requested. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2297"></a><span class='Declare_Function'>InitializeLDAPConnection</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span>LDAP <span class='Operator'>**</span><span class='Declare_Parameter'>ldap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2299"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ldapversion</span> <span class='Operator'>= </span>LDAP_VERSION3<span class='Delimiter'>; 
</span><a name="LN2300"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a> <span class='Operator'>= </span>ldap_init<span class='Parentheses'>(</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN78"><span class='Ref_to_Member'>ldapport</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not initialize LDAP: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not initialize LDAP: error code %d"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>LdapGetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN2300"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>ldap_set_option<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Delimiter'>, </span>LDAP_OPT_PROTOCOL_VERSION<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2299"><span class='Ref_To_Local'>ldapversion</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        ldap_unbind<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set LDAP protocol version: %s"</span><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2300"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN76"><span class='Ref_to_Member'>ldaptls</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN2300"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>ldap_start_tls_s<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
<a name="LN2329"></a>        <span class='Keyword'>static </span><a href="auth.c.html#LN132"><span class='Ref_to_Typedef'>__ldap_start_tls_sA</span></a> <span class='Declare_Local'>_ldap_start_tls_sA</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2329"><span class='Ref_To_Local'>_ldap_start_tls_sA</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Need to load this function dynamically because it does not 
             * exist on Windows 2000, and causes a load error for the whole 
             * exe if referenced. 
             */ 
</span><a name="LN2338"></a>            HANDLE      <span class='Declare_Local'>ldaphandle</span><span class='Delimiter'>; 
</span> 
            <a href="auth.c.html#LN2338"><span class='Ref_To_Local'>ldaphandle</span></a> <span class='Operator'>= </span>LoadLibrary<span class='Parentheses'>(</span><span class='String'>"WLDAP32.DLL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2338"><span class='Ref_To_Local'>ldaphandle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * should never happen since we import other files from 
                 * wldap32, but check anyway 
                 */ 
</span>                ldap_unbind<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load wldap32.dll"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="auth.c.html#LN2329"><span class='Ref_To_Local'>_ldap_start_tls_sA</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="auth.c.html#LN132"><span class='Ref_to_Typedef'>__ldap_start_tls_sA</span></a><span class='Parentheses'>) </span>GetProcAddress<span class='Parentheses'>(</span><a href="auth.c.html#LN2338"><span class='Ref_To_Local'>ldaphandle</span></a><span class='Delimiter'>, </span><span class='String'>"ldap_start_tls_sA"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2329"><span class='Ref_To_Local'>_ldap_start_tls_sA</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                ldap_unbind<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load function _ldap_start_tls_sA in wldap32.dll"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP over SSL is not supported on this platform."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Leak LDAP handle on purpose, because we need the library to 
             * stay open. This is ok because it will only ever be leaked once 
             * per process and is automatically cleaned up on process exit. 
             */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if _ldap_start_tls_sA==N... &raquo; </span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="auth.c.html#LN2300"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2329"><span class='Ref_To_Local'>_ldap_start_tls_sA</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span> 
        <span class='Delimiter'>{ 
</span>            ldap_unbind<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2297"><span class='Ref_to_Parameter'>ldap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not start LDAP TLS session: %s"</span><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2300"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if port-&GT;hba-&GT;ldaptls &raquo; </span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitializeLDAPConnection &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform LDAP authentication 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2385"></a><span class='Declare_Function'>CheckLDAPAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2387"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>passwd</span><span class='Delimiter'>; 
</span><a name="LN2388"></a>    LDAP       <span class='Operator'>*</span><span class='Declare_Local'>ldap</span><span class='Delimiter'>; 
</span><a name="LN2389"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN2390"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fulluser</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a> <span class='Operator'>|| </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP server not specified"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN78"><span class='Ref_to_Member'>ldapport</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN78"><span class='Ref_to_Member'>ldapport</span></a> <span class='Operator'>= </span>LDAP_PORT<span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2387"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN48"><span class='Ref_to_Proto'>recv_password_packet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2387"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* client wouldn't send password */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2387"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"empty password returned by client"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2296"><span class='Ref_to_Func'>InitializeLDAPConnection</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Parentheses'>)</span> 
        <span class='Comment_Multi_Line'>/* Error message already sent */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN82"><span class='Ref_to_Member'>ldapbasedn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * First perform an LDAP search to find the DN for the user we are 
         * trying to log in as. 
         */ 
</span><a name="LN2425"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filter</span><span class='Delimiter'>; 
</span><a name="LN2426"></a>        LDAPMessage <span class='Operator'>*</span><span class='Declare_Local'>search_message</span><span class='Delimiter'>; 
</span><a name="LN2427"></a>        LDAPMessage <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN2428"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>attributes</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN2429"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dn</span><span class='Delimiter'>; 
</span><a name="LN2430"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN2431"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Disallow any characters that we would otherwise need to escape, 
         * since they aren't really reasonable in a username anyway. Allowing 
         * them would make it possible to inject any kind of custom filters in 
         * the LDAP filter. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>; </span><span class='Operator'>*</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>; </span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>'*'</span> <span class='Operator'>|| 
</span>                <span class='Operator'>*</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>'('</span> <span class='Operator'>|| 
</span>                <span class='Operator'>*</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>')'</span> <span class='Operator'>|| 
</span>                <span class='Operator'>*</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>'\\'</span> <span class='Operator'>|| 
</span>                <span class='Operator'>*</span><a href="auth.c.html#LN2430"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>'/'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid character in user name for LDAP authentication"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Bind with a pre-defined username/password (if available) for 
         * searching. If none is specified, this turns into an anonymous bind. 
         */ 
</span>        <a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>ldap_simple_bind_s<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN79"><span class='Ref_to_Member'>ldapbinddn</span></a> <span class='Operator'>? </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN79"><span class='Ref_to_Member'>ldapbinddn</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                 <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN80"><span class='Ref_to_Member'>ldapbindpasswd</span></a> <span class='Operator'>? </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN80"><span class='Ref_to_Member'>ldapbindpasswd</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not perform initial LDAP bind for ldapbinddn \"%s\" on server \"%s\": %s"</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN79"><span class='Ref_to_Member'>ldapbinddn</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch just one attribute, else *all* attributes are returned */ 
</span>        <a href="auth.c.html#LN2428"><span class='Ref_To_Local'>attributes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN81"><span class='Ref_to_Member'>ldapsearchattribute</span></a> <span class='Operator'>? </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN81"><span class='Ref_to_Member'>ldapsearchattribute</span></a> <span class='Operator'>: </span><span class='String'>"uid"</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN2428"><span class='Ref_To_Local'>attributes</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"(%s=%s)"</span><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2428"><span class='Ref_To_Local'>attributes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                          <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>ldap_search_s<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN82"><span class='Ref_to_Member'>ldapbasedn</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN83"><span class='Ref_to_Member'>ldapscope</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2428"><span class='Ref_To_Local'>attributes</span></a><span class='Delimiter'>, 
</span>                          <span class='Number'>0</span><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="auth.c.html#LN2426"><span class='Ref_To_Local'>search_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not search LDAP for filter \"%s\" on server \"%s\": %s"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="auth.c.html#LN2431"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span>ldap_count_entries<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2426"><span class='Ref_To_Local'>search_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2431"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2431"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP user \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP search for filter \"%s\" on server \"%s\" returned no entries."</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP user \"%s\" is not unique"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../include/utils/elog.h.html#LN150"><span class='Ref_to_Func'>errdetail_plural</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP search for filter \"%s\" on server \"%s\" returned %d entry."</span><span class='Delimiter'>, 
</span>                                    <span class='String'>"LDAP search for filter \"%s\" on server \"%s\" returned %d entries."</span><span class='Delimiter'>, 
</span>                                    <a href="auth.c.html#LN2431"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>, 
</span>                                    <a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2431"><span class='Ref_To_Local'>count</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            ldap_msgfree<span class='Parentheses'>(</span><a href="auth.c.html#LN2426"><span class='Ref_To_Local'>search_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="auth.c.html#LN2427"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span>ldap_first_entry<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2426"><span class='Ref_To_Local'>search_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN2429"><span class='Ref_To_Local'>dn</span></a> <span class='Operator'>= </span>ldap_get_dn<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2427"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2429"><span class='Ref_To_Local'>dn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2518"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>error</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>ldap_get_option<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, </span>LDAP_OPT_ERROR_NUMBER<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2518"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not get dn for the first entry matching \"%s\" on server \"%s\": %s"</span><span class='Delimiter'>, 
</span>                    <a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2518"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            ldap_msgfree<span class='Parentheses'>(</span><a href="auth.c.html#LN2426"><span class='Ref_To_Local'>search_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2429"><span class='Ref_To_Local'>dn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2425"><span class='Ref_To_Local'>filter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        ldap_memfree<span class='Parentheses'>(</span><a href="auth.c.html#LN2429"><span class='Ref_To_Local'>dn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        ldap_msgfree<span class='Parentheses'>(</span><a href="auth.c.html#LN2426"><span class='Ref_To_Local'>search_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Unbind and disconnect from the LDAP server */ 
</span>        <a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>ldap_unbind_s<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2538"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>error</span><span class='Delimiter'>; 
</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>ldap_get_option<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, </span>LDAP_OPT_ERROR_NUMBER<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2538"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not unbind after searching for user \"%s\" on server \"%s\": %s"</span><span class='Delimiter'>, 
</span>                  <a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2538"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Need to re-initialize the LDAP connection, so that we can bind to 
         * it with a different username. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2296"><span class='Ref_to_Func'>InitializeLDAPConnection</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Error message already sent */ 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if port-&GT;hba-&GT;ldapbasedn &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s%s%s"</span><span class='Delimiter'>, 
</span>                          <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN84"><span class='Ref_to_Member'>ldapprefix</span></a> <span class='Operator'>? </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN84"><span class='Ref_to_Member'>ldapprefix</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                         <a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN85"><span class='Ref_to_Member'>ldapsuffix</span></a> <span class='Operator'>? </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN85"><span class='Ref_to_Member'>ldapsuffix</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>ldap_simple_bind_s<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2387"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    ldap_unbind<span class='Parentheses'>(</span><a href="auth.c.html#LN2388"><span class='Ref_To_Local'>ldap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span>LDAP_SUCCESS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"LDAP login failed for user \"%s\" on server \"%s\": %s"</span><span class='Delimiter'>, 
</span>                    <a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2385"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN77"><span class='Ref_to_Member'>ldapserver</span></a><span class='Delimiter'>, </span>ldap_err2string<span class='Parentheses'>(</span><a href="auth.c.html#LN2389"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2390"><span class='Ref_To_Local'>fulluser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckLDAPAuth &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_LDAP */ 
</span> 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * SSL client certificate authentication 
 *---------------------------------------------------------------- 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
<span class='Keyword'>static int 
</span><a name="LN2591"></a><span class='Declare_Function'>CheckCertAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we have received a username in the certificate */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>        strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"certificate authentication failed for user \"%s\": client certificate contains no user name"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Just pass the certificate CN to the usermap check */ 
</span>    <span class='Control'>return</span> <a href="../../include/libpq/hba.h.html#LN117"><span class='Ref_to_Proto'>check_usermap</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN73"><span class='Ref_to_Member'>usermap</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2591"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/*---------------------------------------------------------------- 
 * RADIUS authentication 
 *---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RADIUS authentication is described in RFC2865 (and several others). 
 */ 
</span> 
<a name="LN2620"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_VECTOR_LENGTH</span> <span class='Number'>16</span> 
<a name="LN2621"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_HEADER_LENGTH</span> <span class='Number'>20</span> 
<a name="LN2622"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_MAX_PASSWORD_LENGTH</span> <span class='Number'>128</span> 
 
<span class='Comment_Multi_Line'>/* Maximum size of a RADIUS packet we will create or accept */ 
</span><a name="LN2625"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_BUFFER_SIZE</span> <span class='Number'>1024</span> 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN2629"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>attribute</span><span class='Delimiter'>; 
</span><a name="LN2630"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>length</span><span class='Delimiter'>; 
</span><a name="LN2631"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>data</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN2632"></a>} <span class='Declare_Typedef'>radius_attribute</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN2636"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>code</span><span class='Delimiter'>; 
</span><a name="LN2637"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>id</span><span class='Delimiter'>; 
</span><a name="LN2638"></a>    <a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>length</span><span class='Delimiter'>; 
</span><a name="LN2639"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>vector</span><span class='Delimiter'>[</span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Delimiter'>]; 
</span>    <span class='Comment_Multi_Line'>/* this is a bit longer than strictly necessary: */ 
</span><a name="LN2641"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>pad</span><span class='Delimiter'>[</span><a href="auth.c.html#LN2625"><span class='Ref_to_Const'>RADIUS_BUFFER_SIZE</span></a> <span class='Operator'>- </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Delimiter'>]; 
</span><a name="LN2642"></a>} <span class='Declare_Typedef'>radius_packet</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* RADIUS packet types */ 
</span><a name="LN2645"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_ACCESS_REQUEST</span>   <span class='Number'>1</span> 
<a name="LN2646"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_ACCESS_ACCEPT</span>    <span class='Number'>2</span> 
<a name="LN2647"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_ACCESS_REJECT</span>    <span class='Number'>3</span> 
 
<span class='Comment_Multi_Line'>/* RAIDUS attributes */ 
</span><a name="LN2650"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_USER_NAME</span>        <span class='Number'>1</span> 
<a name="LN2651"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_PASSWORD</span>         <span class='Number'>2</span> 
<a name="LN2652"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_SERVICE_TYPE</span>     <span class='Number'>6</span> 
<a name="LN2653"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_NAS_IDENTIFIER</span>   <span class='Number'>32</span> 
 
<span class='Comment_Multi_Line'>/* RADIUS service types */ 
</span><a name="LN2656"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_AUTHENTICATE_ONLY</span>    <span class='Number'>8</span> 
 
<span class='Comment_Multi_Line'>/* Seconds to wait - XXX: should be in a config variable! */ 
</span><a name="LN2659"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RADIUS_TIMEOUT</span> <span class='Number'>3</span> 
 
<span class='Keyword'>static void 
</span><a name="LN2662"></a><span class='Declare_Function'>radius_add_attribute</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2634"><span class='Ref_to_Typedef'>radius_packet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>packet</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>type</span><span class='Delimiter'>, </span><span class='Keyword'>const unsigned char </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2664"></a>    <a href="auth.c.html#LN2627"><span class='Ref_to_Typedef'>radius_attribute</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attr</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><a href="auth.c.html#LN2625"><span class='Ref_to_Const'>RADIUS_BUFFER_SIZE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * With remotely realistic data, this can never happen. But catch it 
         * just to make sure we don't overrun a buffer. We'll just skip adding 
         * the broken attribute, which will in the end cause authentication to 
         * fail. 
         */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"Adding attribute code %d with length %d to radius packet would create oversize packet, ignoring"</span><span class='Delimiter'>, 
</span>             <a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="auth.c.html#LN2664"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="auth.c.html#LN2627"><span class='Ref_to_Typedef'>radius_attribute</span></a> <span class='Operator'>*</span><span class='Parentheses'>) ((</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>packet</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2664"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2629"><span class='Ref_to_Member'>attribute</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2664"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2630"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* total size includes type and length */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2664"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2631"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2662"><span class='Ref_to_Parameter'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>+= </span><a href="auth.c.html#LN2664"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2630"><span class='Ref_to_Member'>length</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end radius_add_attribute &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN2688"></a><span class='Declare_Function'>CheckRADIUSAuth</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2690"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>passwd</span><span class='Delimiter'>; 
</span><a name="LN2691"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>server</span><span class='Delimiter'>, 
</span><a name="LN2692"></a>               <span class='Operator'>*</span><span class='Declare_Local'>secrets</span><span class='Delimiter'>, 
</span><a name="LN2693"></a>               <span class='Operator'>*</span><span class='Declare_Local'>radiusports</span><span class='Delimiter'>, 
</span><a name="LN2694"></a>               <span class='Operator'>*</span><span class='Declare_Local'>identifiers</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure struct alignment is correct */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2634"><span class='Ref_to_Typedef'>radius_packet</span></a><span class='Delimiter'>, </span>vector<span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Verify parameters */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN91"><span class='Ref_to_Member'>radiusservers</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS server not specified"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN93"><span class='Ref_to_Member'>radiussecrets</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS secret not specified"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Send regular password request to client, and get the response */ 
</span>    <a href="auth.c.html#LN45"><span class='Ref_to_Proto'>sendAuthRequest</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN167"><span class='Ref_to_Const'>AUTH_REQ_PASSWORD</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2690"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN48"><span class='Ref_to_Proto'>recv_password_packet</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2690"><span class='Ref_To_Local'>passwd</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* client wouldn't send password */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2690"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"empty password returned by client"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2690"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="auth.c.html#LN2622"><span class='Ref_to_Const'>RADIUS_MAX_PASSWORD_LENGTH</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS authentication does not support passwords longer than %d characters"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2622"><span class='Ref_to_Const'>RADIUS_MAX_PASSWORD_LENGTH</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop over and try each server in order. 
     */ 
</span>    <a href="auth.c.html#LN2692"><span class='Ref_To_Local'>secrets</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN93"><span class='Ref_to_Member'>radiussecrets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2693"><span class='Ref_To_Local'>radiusports</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN97"><span class='Ref_to_Member'>radiusports</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2694"><span class='Ref_To_Local'>identifiers</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN95"><span class='Ref_to_Member'>radiusidentifiers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2691"><span class='Ref_To_Local'>server</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN91"><span class='Ref_to_Member'>radiusservers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2743"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><a href="auth.c.html#LN198"><span class='Ref_to_Proto'>PerformRadiusTransaction</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2691"><span class='Ref_To_Local'>server</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                   <a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2692"><span class='Ref_To_Local'>secrets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="auth.c.html#LN2693"><span class='Ref_To_Local'>radiusports</span></a> <span class='Operator'>? </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2693"><span class='Ref_To_Local'>radiusports</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                    <a href="auth.c.html#LN2694"><span class='Ref_To_Local'>identifiers</span></a> <span class='Operator'>? </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2694"><span class='Ref_To_Local'>identifiers</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                                   <a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, 
</span>                                                   <a href="auth.c.html#LN2690"><span class='Ref_To_Local'>passwd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/*------ 
         * STATUS_OK = Login OK 
         * STATUS_ERROR = Login not OK, but try next server 
         * STATUS_EOF = Login not OK, and don't try next server 
         *------ 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2743"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2743"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * secret, port and identifiers either have length 0 (use default), 
         * length 1 (use the same everywhere) or the same length as servers. 
         * So if the length is &GT;1, we advance one step. In other cases, we 
         * don't and will then reuse the correct value. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN93"><span class='Ref_to_Member'>radiussecrets</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="auth.c.html#LN2692"><span class='Ref_To_Local'>secrets</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2692"><span class='Ref_To_Local'>secrets</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN97"><span class='Ref_to_Member'>radiusports</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="auth.c.html#LN2693"><span class='Ref_To_Local'>radiusports</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2693"><span class='Ref_To_Local'>radiusports</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2688"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN143"><span class='Ref_to_Member'>hba</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/hba.h.html#LN95"><span class='Ref_to_Member'>radiusidentifiers</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="auth.c.html#LN2694"><span class='Ref_To_Local'>identifiers</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2694"><span class='Ref_To_Local'>identifiers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* No servers left to try, so give up */ 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckRADIUSAuth &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN2780"></a><span class='Declare_Function'>PerformRadiusTransaction</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>server</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>secret</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>portstr</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>identifier</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>user_name</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>passwd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2782"></a>    <a href="auth.c.html#LN2634"><span class='Ref_to_Typedef'>radius_packet</span></a> <span class='Declare_Local'>radius_send_pack</span><span class='Delimiter'>; 
</span><a name="LN2783"></a>    <a href="auth.c.html#LN2634"><span class='Ref_to_Typedef'>radius_packet</span></a> <span class='Declare_Local'>radius_recv_pack</span><span class='Delimiter'>; 
</span><a name="LN2784"></a>    <a href="auth.c.html#LN2634"><span class='Ref_to_Typedef'>radius_packet</span></a> <span class='Operator'>*</span><span class='Declare_Local'>packet</span> <span class='Operator'>= &</span><a href="auth.c.html#LN2782"><span class='Ref_To_Local'>radius_send_pack</span></a><span class='Delimiter'>; 
</span><a name="LN2785"></a>    <a href="auth.c.html#LN2634"><span class='Ref_to_Typedef'>radius_packet</span></a> <span class='Operator'>*</span><span class='Declare_Local'>receivepacket</span> <span class='Operator'>= &</span><a href="auth.c.html#LN2783"><span class='Ref_To_Local'>radius_recv_pack</span></a><span class='Delimiter'>; 
</span><a name="LN2786"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>radius_buffer</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="auth.c.html#LN2782"><span class='Ref_To_Local'>radius_send_pack</span></a><span class='Delimiter'>; 
</span><a name="LN2787"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>receive_buffer</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="auth.c.html#LN2783"><span class='Ref_To_Local'>radius_recv_pack</span></a><span class='Delimiter'>; 
</span><a name="LN2788"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>service</span> <span class='Operator'>= </span>htonl<span class='Parentheses'>(</span><a href="auth.c.html#LN2656"><span class='Ref_to_Const'>RADIUS_AUTHENTICATE_ONLY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2789"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>cryptvector</span><span class='Delimiter'>; 
</span><a name="LN2790"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>encryptedpasswordlen</span><span class='Delimiter'>; 
</span><a name="LN2791"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>encryptedpassword</span><span class='Delimiter'>[</span><a href="auth.c.html#LN2622"><span class='Ref_to_Const'>RADIUS_MAX_PASSWORD_LENGTH</span></a><span class='Delimiter'>]; 
</span><a name="LN2792"></a>    <a href="../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>md5trailer</span><span class='Delimiter'>; 
</span><a name="LN2793"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>packetlength</span><span class='Delimiter'>; 
</span><a name="LN2794"></a>    <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a>    <span class='Declare_Local'>sock</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_IPV6 
<a name="LN2797"></a>    <span class='Control'>struct</span> sockaddr_in6 <span class='Declare_Local'>localaddr</span><span class='Delimiter'>; 
</span><a name="LN2798"></a>    <span class='Control'>struct</span> sockaddr_in6 <span class='Declare_Local'>remoteaddr</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN2800"></a>    <span class='Control'>struct</span> sockaddr_in <span class='Declare_Local'>localaddr</span><span class='Delimiter'>; 
</span><a name="LN2801"></a>    <span class='Control'>struct</span> sockaddr_in <span class='Declare_Local'>remoteaddr</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN2803"></a>    <span class='Control'>struct</span> <a href="../../include/getaddrinfo.h.html#LN114"><span class='Ref_to_Struct'>addrinfo</span></a> <span class='Declare_Local'>hint</span><span class='Delimiter'>; 
</span><a name="LN2804"></a>    <span class='Control'>struct</span> <a href="../../include/getaddrinfo.h.html#LN114"><span class='Ref_to_Struct'>addrinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>serveraddrs</span><span class='Delimiter'>; 
</span><a name="LN2805"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>port</span><span class='Delimiter'>; 
</span><a name="LN2806"></a>    ACCEPT_TYPE_ARG3 <span class='Declare_Local'>addrsize</span><span class='Delimiter'>; 
</span><a name="LN2807"></a>    fd_set      <span class='Declare_Local'>fdset</span><span class='Delimiter'>; 
</span><a name="LN2808"></a>    <span class='Control'>struct</span> timeval <span class='Declare_Local'>endtime</span><span class='Delimiter'>; 
</span><a name="LN2809"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN2810"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>, 
</span><a name="LN2811"></a>                <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assign default values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>portstr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>portstr</span></a> <span class='Operator'>= </span><span class='String'>"1812"</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>identifier</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>identifier</span></a> <span class='Operator'>= </span><span class='String'>"postgresql"</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN101"><span class='Ref_to_Member'>ai_socktype</span></a> <span class='Operator'>= </span>SOCK_DGRAM<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>= </span>AF_UNSPEC<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2805"><span class='Ref_To_Local'>port</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>portstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2811"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN26"><span class='Ref_to_Proto'>pg_getaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>portstr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2811"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>|| !</span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not translate RADIUS server name \"%s\" to address: %s"</span><span class='Delimiter'>, 
</span>                        <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span><a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2811"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* XXX: add support for multiple returned addresses? */ 
</span> 
    <span class='Comment_Multi_Line'>/* Construct RADIUS packet */ 
</span>    <a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2636"><span class='Ref_to_Member'>code</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2645"><span class='Ref_to_Const'>RADIUS_ACCESS_REQUEST</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2621"><span class='Ref_to_Const'>RADIUS_HEADER_LENGTH</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/backend_random.h.html#LN16"><span class='Ref_to_Proto'>pg_backend_random</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2639"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not generate random encryption vector"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2637"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2639"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="auth.c.html#LN2661"><span class='Ref_to_Func'>radius_add_attribute</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2652"><span class='Ref_to_Const'>RADIUS_SERVICE_TYPE</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="auth.c.html#LN2788"><span class='Ref_To_Local'>service</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2788"><span class='Ref_To_Local'>service</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2661"><span class='Ref_to_Func'>radius_add_attribute</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2650"><span class='Ref_to_Const'>RADIUS_USER_NAME</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>user_name</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>user_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2661"><span class='Ref_to_Func'>radius_add_attribute</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2653"><span class='Ref_to_Const'>RADIUS_NAS_IDENTIFIER</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>identifier</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>identifier</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * RADIUS password attributes are calculated as: e[0] = p[0] XOR 
     * MD5(secret + Request Authenticator) for the first group of 16 octets, 
     * and then: e[i] = p[i] XOR MD5(secret + e[i-1]) for the following ones 
     * (if necessary) 
     */ 
</span>    <a href="auth.c.html#LN2790"><span class='Ref_To_Local'>encryptedpasswordlen</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>passwd</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>/ </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* for the first iteration, we use the Request Authenticator vector */ 
</span>    <a href="auth.c.html#LN2792"><span class='Ref_To_Local'>md5trailer</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2639"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="auth.c.html#LN2790"><span class='Ref_To_Local'>encryptedpasswordlen</span></a><span class='Delimiter'>; </span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+= </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2792"><span class='Ref_To_Local'>md5trailer</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * .. and for subsequent iterations the result of the previous XOR 
         * (calculated below) 
         */ 
</span>        <a href="auth.c.html#LN2792"><span class='Ref_To_Local'>md5trailer</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/md5.h.html#LN21"><span class='Ref_to_Proto'>pg_md5_binary</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not perform MD5 encryption of password"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; </span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="auth.c.html#LN2809"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Delimiter'>; </span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>passwd</span></a><span class='Parentheses'>))</span> 
                <a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>passwd</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>^ </span><a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>else</span> 
                <a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span> <span class='Operator'>^ </span><a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Delimiter'>[</span><a href="auth.c.html#LN2810"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;encryptedpasswo... &raquo; </span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2661"><span class='Ref_to_Func'>radius_add_attribute</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2651"><span class='Ref_to_Const'>RADIUS_PASSWORD</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2790"><span class='Ref_To_Local'>encryptedpasswordlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Length needs to be in network order on the wire */ 
</span>    <a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>= </span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span>htons<span class='Parentheses'>(</span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN368"><span class='Ref_to_Macro'>socket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span>SOCK_DGRAM<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create RADIUS socket: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_IPV6 
    <a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Operator'>.</span>sin6_family <span class='Operator'>= </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Operator'>.</span>sin6_addr <span class='Operator'>= </span><a href="../port/win32/mingwcompat.c.html#LN21"><span class='Ref_to_Global_Var'>in6addr_any</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Operator'>.</span>sin6_family <span class='Operator'>== </span>AF_INET6<span class='Parentheses'>) 
</span>        <a href="auth.c.html#LN2806"><span class='Ref_To_Local'>addrsize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr_in6<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="auth.c.html#LN2806"><span class='Ref_To_Local'>addrsize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr_in<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Operator'>.</span>sin_family <span class='Operator'>= </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Operator'>.</span>sin_addr<span class='Operator'>.</span>s_addr <span class='Operator'>= </span>INADDR_ANY<span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2806"><span class='Ref_To_Local'>addrsize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr_in<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN369"><span class='Ref_to_Macro'>bind</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="auth.c.html#LN2797"><span class='Ref_To_Local'>localaddr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2806"><span class='Ref_To_Local'>addrsize</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not bind local RADIUS socket: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>sendto<span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2786"><span class='Ref_To_Local'>radius_buffer</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>               <a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not send RADIUS packet: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Don't need the server address anymore */ 
</span>    <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2803"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2804"><span class='Ref_To_Local'>serveraddrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Figure out at what time we should time out. We can't just use a single 
     * call to select() with a timeout, since somebody can be sending invalid 
     * packets to our port thus causing us to retry in a loop and never time 
     * out. 
     * 
     * XXX: Using WaitLatchOrSocket() and doing a CHECK_FOR_INTERRUPTS() if 
     * the latch was set would improve the responsiveness to 
     * timeouts/cancellations. 
     */ 
</span>    <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN2808"><span class='Ref_To_Local'>endtime</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="auth.c.html#LN2808"><span class='Ref_To_Local'>endtime</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>+= </span><a href="auth.c.html#LN2659"><span class='Ref_to_Const'>RADIUS_TIMEOUT</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2958"></a>        <span class='Control'>struct</span> timeval <span class='Declare_Local'>timeout</span><span class='Delimiter'>; 
</span><a name="LN2959"></a>        <span class='Control'>struct</span> timeval <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span><a name="LN2960"></a>        <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>timeoutval</span><span class='Delimiter'>; 
</span> 
        <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN2959"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN2960"><span class='Ref_To_Local'>timeoutval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="auth.c.html#LN2808"><span class='Ref_To_Local'>endtime</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>* </span><span class='Number'>1000000</span> <span class='Operator'>+ </span><a href="auth.c.html#LN2808"><span class='Ref_To_Local'>endtime</span></a><span class='Operator'>.</span>tv_usec<span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Parentheses'>(</span><a href="auth.c.html#LN2959"><span class='Ref_To_Local'>now</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>* </span><span class='Number'>1000000</span> <span class='Operator'>+ </span><a href="auth.c.html#LN2959"><span class='Ref_To_Local'>now</span></a><span class='Operator'>.</span>tv_usec<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2960"><span class='Ref_To_Local'>timeoutval</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"timeout waiting for RADIUS response from %s"</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="auth.c.html#LN2958"><span class='Ref_To_Local'>timeout</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>= </span><a href="auth.c.html#LN2960"><span class='Ref_To_Local'>timeoutval</span></a> <span class='Operator'>/ </span><span class='Number'>1000000</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN2958"><span class='Ref_To_Local'>timeout</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>= </span><a href="auth.c.html#LN2960"><span class='Ref_To_Local'>timeoutval</span></a> <span class='Operator'>% </span><span class='Number'>1000000</span><span class='Delimiter'>; 
</span> 
        FD_ZERO<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="auth.c.html#LN2807"><span class='Ref_To_Local'>fdset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        FD_SET<span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2807"><span class='Ref_To_Local'>fdset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="auth.c.html#LN2811"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2807"><span class='Ref_To_Local'>fdset</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2958"><span class='Ref_To_Local'>timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2811"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Anything else is an actual error */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not check status on RADIUS socket: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2811"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"timeout waiting for RADIUS response from %s"</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Attempt to read the response packet, and verify the contents. 
         * 
         * Any packet that's not actually a RADIUS packet, or otherwise does 
         * not validate as an explicit reject, is just ignored and we retry 
         * for another packet (until we reach the timeout). This is to avoid 
         * the possibility to denial-of-service the login by flooding the 
         * server with invalid packets on the port that we're expecting the 
         * RADIUS response on. 
         */ 
</span> 
        <a href="auth.c.html#LN2806"><span class='Ref_To_Local'>addrsize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="auth.c.html#LN2798"><span class='Ref_To_Local'>remoteaddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>= </span>recvfrom<span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2787"><span class='Ref_To_Local'>receive_buffer</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2625"><span class='Ref_to_Const'>RADIUS_BUFFER_SIZE</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="auth.c.html#LN2798"><span class='Ref_To_Local'>remoteaddr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="auth.c.html#LN2806"><span class='Ref_To_Local'>addrsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read RADIUS response: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> HAVE_IPV6 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2798"><span class='Ref_To_Local'>remoteaddr</span></a><span class='Operator'>.</span>sin6_port <span class='Operator'>!= </span>htons<span class='Parentheses'>(</span><a href="auth.c.html#LN2805"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>))</span> 
<span class='Directive'>#else</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2798"><span class='Ref_To_Local'>remoteaddr</span></a><span class='Operator'>.</span>sin_port <span class='Operator'>!= </span>htons<span class='Parentheses'>(</span><a href="auth.c.html#LN2805"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>))</span> 
<span class='Directive'>#endif</span> 
        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_IPV6 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s was sent from incorrect port: %d"</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span>ntohs<span class='Parentheses'>(</span><a href="auth.c.html#LN2798"><span class='Ref_To_Local'>remoteaddr</span></a><span class='Operator'>.</span>sin6_port<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s was sent from incorrect port: %d"</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span>ntohs<span class='Parentheses'>(</span><a href="auth.c.html#LN2798"><span class='Ref_To_Local'>remoteaddr</span></a><span class='Operator'>.</span>sin_port<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>&LT; </span><a href="auth.c.html#LN2621"><span class='Ref_to_Const'>RADIUS_HEADER_LENGTH</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s too short: %d"</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>!= </span>ntohs<span class='Parentheses'>(</span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s has corrupt length: %d (actual length %d)"</span><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span>ntohs<span class='Parentheses'>(</span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2638"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2637"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>!= </span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2637"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s is to a different request: %d (should be %d)"</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2637"><span class='Ref_to_Member'>id</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2637"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Verify the response authenticator, which is calculated as 
         * MD5(Code+ID+Length+RequestAuthenticator+Attributes+Secret) 
         */ 
</span>        <a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* code+id+length */ 
</span>        memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a> <span class='Operator'>+ </span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="auth.c.html#LN2784"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2639"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Multi_Line'>/* request 
                                                                         * authenticator, from 
                                                                         * original packet */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>&GT; </span><a href="auth.c.html#LN2621"><span class='Ref_to_Const'>RADIUS_HEADER_LENGTH</span></a><span class='Parentheses'>)</span>        <span class='Comment_Multi_Line'>/* there may be no 
                                                         * attributes at all */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2621"><span class='Ref_to_Const'>RADIUS_HEADER_LENGTH</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2787"><span class='Ref_To_Local'>receive_buffer</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2621"><span class='Ref_to_Const'>RADIUS_HEADER_LENGTH</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>- </span><a href="auth.c.html#LN2621"><span class='Ref_to_Const'>RADIUS_HEADER_LENGTH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a> <span class='Operator'>+ </span><a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/md5.h.html#LN21"><span class='Ref_to_Proto'>pg_md5_binary</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Delimiter'>, 
</span>                           <a href="auth.c.html#LN2793"><span class='Ref_To_Local'>packetlength</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>secret</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not perform MD5 encryption of received packet"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2789"><span class='Ref_To_Local'>cryptvector</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2639"><span class='Ref_to_Member'>vector</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2791"><span class='Ref_To_Local'>encryptedpassword</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2620"><span class='Ref_to_Const'>RADIUS_VECTOR_LENGTH</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s has incorrect MD5 signature"</span><span class='Delimiter'>, 
</span>                       <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2636"><span class='Ref_to_Member'>code</span></a> <span class='Operator'>== </span><a href="auth.c.html#LN2646"><span class='Ref_to_Const'>RADIUS_ACCESS_ACCEPT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2636"><span class='Ref_to_Member'>code</span></a> <span class='Operator'>== </span><a href="auth.c.html#LN2647"><span class='Ref_to_Const'>RADIUS_ACCESS_REJECT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="auth.c.html#LN2794"><span class='Ref_To_Local'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN976"><span class='Ref_to_Const'>STATUS_EOF</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RADIUS response from %s has invalid code (%d) for user \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>server</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2785"><span class='Ref_To_Local'>receivepacket</span></a><span class='Operator'>-&GT;</span><a href="auth.c.html#LN2636"><span class='Ref_to_Member'>code</span></a><span class='Delimiter'>, </span><a href="auth.c.html#LN2780"><span class='Ref_to_Parameter'>user_name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span>                           <span class='Comment_Single_Line'>/* while (true) */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PerformRadiusTransaction &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>