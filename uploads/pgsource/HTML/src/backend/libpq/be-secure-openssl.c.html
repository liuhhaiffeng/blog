<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\libpq\be-secure-openssl.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\libpq\be-secure-openssl.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:40 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * be-secure-openssl.c 
 *    functions for OpenSSL support in the backend. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/libpq/be-secure-openssl.c 
 * 
 *    Since the server static private key ($DataDir/server.key) 
 *    will normally be stored unencrypted so that the database 
 *    backend can restart automatically, it is important that 
 *    we select an algorithm that continues to provide confidentiality 
 *    even if the attacker has the server's private key.  Ephemeral 
 *    DH (EDH) keys provide this and more (Perfect Forward Secrecy 
 *    aka PFS). 
 * 
 *    N.B., the static private key should still be protected to 
 *    the largest extent possible, to minimize the risk of 
 *    impersonations. 
 * 
 *    Another benefit of EDH is that it allows the backend and 
 *    clients to use DSA keys.  DSA keys can only provide digital 
 *    signatures, not encryption, and are often acceptable in 
 *    jurisdictions where RSA keys are unacceptable. 
 * 
 *    The downside to EDH is that it makes it impossible to 
 *    use ssldump(1) if there's a problem establishing an SSL 
 *    session.  In this case you'll need to temporarily disable 
 *    EDH by commenting out the callback. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_NETINET_TCP_H 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/tcp.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/ssl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/dh.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/conf.h&GT;</span> 
<span class='Directive'>#ifndef</span> OPENSSL_NO_ECDH 
<span class='Keyword'>#include </span><span class='String'>&LT;openssl/ec.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/latch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
 
<a name="LN68"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>my_sock_read</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>my_sock_write</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static </span>BIO_METHOD <span class='Operator'>*</span><span class='Declare_Prototype'>my_BIO_s_socket</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>my_SSL_set_fd</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN73"></a><span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Prototype'>load_dh_file</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>keylength</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Prototype'>load_dh_buffer</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><span class='Declare_Parameter'>char</span> <span class='Operator'>*</span><span class='Delimiter'>, </span>size_t<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN75"></a><span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Prototype'>generate_dh_parameters</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>prime_len</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>generator</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN76"></a><span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Prototype'>tmp_dh_cb</span><span class='Parentheses'>(</span>SSL <span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>is_export</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>keylength</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN77"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>ssl_passwd_cb</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rwflag</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>userdata</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>verify_cb</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>X509_STORE_CTX</span> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>info_cb</span><span class='Parentheses'>(</span><span class='Keyword'>const </span>SSL <span class='Operator'>*</span><span class='Declare_Parameter'>ssl</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>type</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>args</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN80"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>initialize_ecdh</span><span class='Parentheses'>(</span>SSL_CTX <span class='Operator'>*</span><span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isServerStart</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN81"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>SSLerrmessage</span><span class='Parentheses'>(</span><span class='Keyword'>unsigned long </span><span class='Declare_Parameter'>ecode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN83"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>X509_NAME_to_cstring</span><span class='Parentheses'>(</span>X509_NAME <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN85"></a><span class='Keyword'>static </span>SSL_CTX <span class='Operator'>*</span><span class='Declare_Var'>SSL_context</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN86"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>SSL_initialized</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>ssl_passwd_cb_called</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*                       Hardcoded values                       */ 
/* ------------------------------------------------------------ */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Hardcoded DH parameters, used in ephemeral DH keying. 
 *  As discussed above, EDH protects the confidentiality of 
 *  sessions even if the static private key is compromised, 
 *  so we are *highly* motivated to ensure that we can use 
 *  EDH even if the DBA... or an attacker... deletes the 
 *  $DataDir/dh*.pem files. 
 * 
 *  We could refuse SSL connections unless a good DH parameter 
 *  file exists, but some clients may quietly renegotiate an 
 *  unsecured connection without fully informing the user. 
 *  Very uncool. 
 * 
 *  Alternatively, the backend could attempt to load these files 
 *  on startup if SSL is enabled - and refuse to start if any 
 *  do not exist - but this would tend to piss off DBAs. 
 * 
 *  If you want to create your own hardcoded DH parameters 
 *  for fun and profit, review "Assigned Number for SKIP 
 *  Protocols" (http://www.skip-vpn.org/spec/numbers.html) 
 *  for suggestions. 
 */ 
</span> 
<a name="LN116"></a><span class='Keyword'>static const char </span><span class='Declare_Var'>file_dh512</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='String'>"-----BEGIN DH PARAMETERS-----\n\ 
MEYCQQD1Kv884bEpQBgRjXyEpwpy1obEAxnIByl6ypUM2Zafq9AKUJsCRtMIPWak\n\ 
XUGfnHy9iUsiGSa6q6Jew1XpKgVfAgEC\n\ 
-----END DH PARAMETERS-----\n"</span><span class='Delimiter'>; 
</span> 
<a name="LN122"></a><span class='Keyword'>static const char </span><span class='Declare_Var'>file_dh1024</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='String'>"-----BEGIN DH PARAMETERS-----\n\ 
MIGHAoGBAPSI/VhOSdvNILSd5JEHNmszbDgNRR0PfIizHHxbLY7288kjwEPwpVsY\n\ 
jY67VYy4XTjTNP18F1dDox0YbN4zISy1Kv884bEpQBgRjXyEpwpy1obEAxnIByl6\n\ 
ypUM2Zafq9AKUJsCRtMIPWakXUGfnHy9iUsiGSa6q6Jew1XpL3jHAgEC\n\ 
-----END DH PARAMETERS-----\n"</span><span class='Delimiter'>; 
</span> 
<a name="LN129"></a><span class='Keyword'>static const char </span><span class='Declare_Var'>file_dh2048</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='String'>"-----BEGIN DH PARAMETERS-----\n\ 
MIIBCAKCAQEA9kJXtwh/CBdyorrWqULzBej5UxE5T7bxbrlLOCDaAadWoxTpj0BV\n\ 
89AHxstDqZSt90xkhkn4DIO9ZekX1KHTUPj1WV/cdlJPPT2N286Z4VeSWc39uK50\n\ 
T8X8dryDxUcwYc58yWb/Ffm7/ZFexwGq01uejaClcjrUGvC/RgBYK+X0iP1YTknb\n\ 
zSC0neSRBzZrM2w4DUUdD3yIsxx8Wy2O9vPJI8BD8KVbGI2Ou1WMuF040zT9fBdX\n\ 
Q6MdGGzeMyEstSr/POGxKUAYEY18hKcKctaGxAMZyAcpesqVDNmWn6vQClCbAkbT\n\ 
CD1mpF1Bn5x8vYlLIhkmuquiXsNV6TILOwIBAg==\n\ 
-----END DH PARAMETERS-----\n"</span><span class='Delimiter'>; 
</span> 
<a name="LN139"></a><span class='Keyword'>static const char </span><span class='Declare_Var'>file_dh4096</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='String'>"-----BEGIN DH PARAMETERS-----\n\ 
MIICCAKCAgEA+hRyUsFN4VpJ1O8JLcCo/VWr19k3BCgJ4uk+d+KhehjdRqNDNyOQ\n\ 
l/MOyQNQfWXPeGKmOmIig6Ev/nm6Nf9Z2B1h3R4hExf+zTiHnvVPeRBhjdQi81rt\n\ 
Xeoh6TNrSBIKIHfUJWBh3va0TxxjQIs6IZOLeVNRLMqzeylWqMf49HsIXqbcokUS\n\ 
Vt1BkvLdW48j8PPv5DsKRN3tloTxqDJGo9tKvj1Fuk74A+Xda1kNhB7KFlqMyN98\n\ 
VETEJ6c7KpfOo30mnK30wqw3S8OtaIR/maYX72tGOno2ehFDkq3pnPtEbD2CScxc\n\ 
alJC+EL7RPk5c/tgeTvCngvc1KZn92Y//EI7G9tPZtylj2b56sHtMftIoYJ9+ODM\n\ 
sccD5Piz/rejE3Ome8EOOceUSCYAhXn8b3qvxVI1ddd1pED6FHRhFvLrZxFvBEM9\n\ 
ERRMp5QqOaHJkM+Dxv8Cj6MqrCbfC4u+ZErxodzuusgDgvZiLF22uxMZbobFWyte\n\ 
OvOzKGtwcTqO/1wV5gKkzu1ZVswVUQd5Gg8lJicwqRWyyNRczDDoG9jVDxmogKTH\n\ 
AaqLulO7R8Ifa1SwF2DteSGVtgWEN8gDpN3RBmmPTDngyF2DHb5qmpnznwtFKdTL\n\ 
KWbuHn491xNO25CQWMtem80uKw+pTnisBRF/454n1Jnhub144YRBoN8CAQI=\n\ 
-----END DH PARAMETERS-----\n"</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*                       Public interface                       */ 
/* ------------------------------------------------------------ */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Initialize global SSL context. 
 * 
 * If isServerStart is true, report any errors as FATAL (so we don't return). 
 * Otherwise, log errors at LOG level and return -1 to indicate trouble, 
 * preserving the old SSL state if any.  Returns 0 if OK. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN167"></a><span class='Declare_Function'>be_tls_init</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isServerStart</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN169"></a>    STACK_OF<span class='Parentheses'>(</span>X509_NAME<span class='Parentheses'>) </span><span class='Operator'>*</span><span class='Declare_Local'>root_cert_list</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN170"></a>    SSL_CTX    <span class='Operator'>*</span><span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span><a name="LN171"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This stuff need be done only once. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN86"><span class='Ref_to_Global_Var'>SSL_initialized</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_OPENSSL_INIT_SSL 
        OPENSSL_init_ssl<span class='Parentheses'>(</span>OPENSSL_INIT_LOAD_CONFIG<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        OPENSSL_config<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        SSL_library_init<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        SSL_load_error_strings<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="be-secure-openssl.c.html#LN86"><span class='Ref_to_Global_Var'>SSL_initialized</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We use SSLv23_method() because it can negotiate use of the highest 
     * mutually supported protocol version, while alternatives like 
     * TLSv1_2_method() permit only one specific version.  Note that we don't 
     * actually allow SSL v2 or v3, only TLS protocols (see below). 
     */ 
</span>    <a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a> <span class='Operator'>= </span>SSL_CTX_new<span class='Parentheses'>(</span>SSLv23_method<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create SSL context: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Disable OpenSSL's moving-write-buffer sanity check, because it causes 
     * unnecessary failures in nonblocking send cases. 
     */ 
</span>    SSL_CTX_set_mode<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span>SSL_MODE_ACCEPT_MOVING_WRITE_BUFFER<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If reloading, override OpenSSL's default handling of 
     * passphrase-protected files, because we don't want to prompt for a 
     * passphrase in an already-running server.  (Not that the default 
     * handling is very desirable during server start either, but some people 
     * insist we need to keep it.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a><span class='Parentheses'>) 
</span>        SSL_CTX_set_default_passwd_cb<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN77"><span class='Ref_to_Proto'>ssl_passwd_cb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Load and verify server's certificate and private key 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_use_certificate_chain_file<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure.c.html#LN42"><span class='Ref_to_Global_Var'>ssl_cert_file</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load server certificate file \"%s\": %s"</span><span class='Delimiter'>, 
</span>                        <a href="be-secure.c.html#LN42"><span class='Ref_to_Global_Var'>ssl_cert_file</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not access private key file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"private key file \"%s\" is not a regular file"</span><span class='Delimiter'>, 
</span>                        <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Refuse to load key files owned by users other than us or root. 
     * 
     * XXX surely we can check this on Windows somehow, too. 
     */ 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>__CYGWIN__<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>!= </span>geteuid<span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"private key file \"%s\" must be owned by the database user or root"</span><span class='Delimiter'>, 
</span>                        <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Require no public access to key file. If the file is owned by us, 
     * require mode 0600 or less. If owned by root, require 0640 or less to 
     * allow read access through our gid, or a supplementary gid that allows 
     * to read system-wide certificates. 
     * 
     * XXX temporarily suppress check when on Windows, because there may not 
     * be proper support for Unix-y file permissions.  Need to think of a 
     * reasonable check to apply on Windows.  (See also the data directory 
     * permission check in postmaster.c) 
     */ 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>__CYGWIN__<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>== </span>geteuid<span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN450"><span class='Ref_to_Const'>S_IRWXG</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN454"><span class='Ref_to_Const'>S_IRWXO</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="be-secure-openssl.c.html#LN171"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN448"><span class='Ref_to_Const'>S_IWGRP</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN449"><span class='Ref_to_Const'>S_IXGRP</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN454"><span class='Ref_to_Const'>S_IRWXO</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"private key file \"%s\" has group or world access"</span><span class='Delimiter'>, 
</span>                        <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"File must have permissions u=rw (0600) or less if owned by the database user, or permissions u=rw,g=r (0640) or less if owned by root."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * OK, try to load the private key file. 
     */ 
</span>    <a href="be-secure-openssl.c.html#LN87"><span class='Ref_to_Global_Var'>ssl_passwd_cb_called</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_use_PrivateKey_file<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, 
</span>                                    <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Delimiter'>, 
</span>                                    SSL_FILETYPE_PEM<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN87"><span class='Ref_to_Global_Var'>ssl_passwd_cb_called</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"private key file \"%s\" cannot be reloaded because it requires a passphrase"</span><span class='Delimiter'>, 
</span>                            <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load private key file \"%s\": %s"</span><span class='Delimiter'>, 
</span>                            <a href="be-secure.c.html#LN43"><span class='Ref_to_Global_Var'>ssl_key_file</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_check_private_key<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"check of private key failed: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* set up ephemeral DH keys, and disallow SSL v2/v3 while at it */ 
</span>    SSL_CTX_set_tmp_dh_callback<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN76"><span class='Ref_to_Proto'>tmp_dh_cb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    SSL_CTX_set_options<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, 
</span>                        SSL_OP_SINGLE_DH_USE <span class='Operator'>| 
</span>                        SSL_OP_NO_SSLv2 <span class='Operator'>| </span>SSL_OP_NO_SSLv3<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set up ephemeral ECDH keys */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN80"><span class='Ref_to_Proto'>initialize_ecdh</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set up the allowed cipher list */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_set_cipher_list<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure.c.html#LN52"><span class='Ref_to_Global_Var'>SSLCipherSuites</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set the cipher list (no valid ciphers available)"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Let server choose order */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure.c.html#LN58"><span class='Ref_to_Global_Var'>SSLPreferServerCiphers</span></a><span class='Parentheses'>) 
</span>        SSL_CTX_set_options<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span>SSL_OP_CIPHER_SERVER_PREFERENCE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Load CA store, so we can verify client certificates if needed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure.c.html#LN44"><span class='Ref_to_Global_Var'>ssl_ca_file</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>SSL_CTX_load_verify_locations<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure.c.html#LN44"><span class='Ref_to_Global_Var'>ssl_ca_file</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN169"><span class='Ref_To_Local'>root_cert_list</span></a> <span class='Operator'>= </span>SSL_load_client_CA_file<span class='Parentheses'>(</span><a href="be-secure.c.html#LN44"><span class='Ref_to_Global_Var'>ssl_ca_file</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load root certificate file \"%s\": %s"</span><span class='Delimiter'>, 
</span>                            <a href="be-secure.c.html#LN44"><span class='Ref_to_Global_Var'>ssl_ca_file</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Load the Certificate Revocation List (CRL). 
     * http://searchsecurity.techtarget.com/sDefinition/0,,sid14_gci803160,00.html 
     *---------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure.c.html#LN45"><span class='Ref_to_Global_Var'>ssl_crl_file</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN364"></a>        X509_STORE <span class='Operator'>*</span><span class='Declare_Local'>cvstore</span> <span class='Operator'>= </span>SSL_CTX_get_cert_store<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN364"><span class='Ref_To_Local'>cvstore</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Set the flags to check against the complete CRL chain */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>X509_STORE_load_locations<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN364"><span class='Ref_To_Local'>cvstore</span></a><span class='Delimiter'>, </span><a href="be-secure.c.html#LN45"><span class='Ref_to_Global_Var'>ssl_crl_file</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* OpenSSL 0.96 does not support X509_V_FLAG_CRL_CHECK */ 
</span><span class='Directive'>#ifdef</span> X509_V_FLAG_CRL_CHECK 
                X509_STORE_set_flags<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN364"><span class='Ref_To_Local'>cvstore</span></a><span class='Delimiter'>, 
</span>                          X509_V_FLAG_CRL_CHECK <span class='Operator'>| </span>X509_V_FLAG_CRL_CHECK_ALL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL certificate revocation list file \"%s\" ignored"</span><span class='Delimiter'>, 
</span>                       <a href="be-secure.c.html#LN45"><span class='Ref_to_Global_Var'>ssl_crl_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SSL library does not support certificate revocation lists."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load SSL certificate revocation list file \"%s\": %s"</span><span class='Delimiter'>, 
</span>                             <a href="be-secure.c.html#LN45"><span class='Ref_to_Global_Var'>ssl_crl_file</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN432"><span class='Ref_to_Label'>error</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cvstore &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ssl_crl_file[0] &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure.c.html#LN44"><span class='Ref_to_Global_Var'>ssl_ca_file</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Always ask for SSL client cert, but don't fail if it's not 
         * presented.  We might fail such connections later, depending on what 
         * we find in pg_hba.conf. 
         */ 
</span>        SSL_CTX_set_verify<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, 
</span>                           <span class='Parentheses'>(</span>SSL_VERIFY_PEER <span class='Operator'>| 
</span>                            SSL_VERIFY_CLIENT_ONCE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN63"><span class='Ref_to_Proto'>verify_cb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Tell OpenSSL to send the list of root certs we trust to clients in 
         * CertificateRequests.  This lets a client with a keystore select the 
         * appropriate client certificate to send to us. 
         */ 
</span>        SSL_CTX_set_client_CA_list<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN169"><span class='Ref_To_Local'>root_cert_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Success!  Replace any existing SSL_context. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Parentheses'>) 
</span>        SSL_CTX_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set flag to remember whether CA store has been loaded into SSL_context. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure.c.html#LN44"><span class='Ref_to_Global_Var'>ssl_ca_file</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <a href="be-secure.c.html#LN48"><span class='Ref_to_Global_Var'>ssl_loaded_verify_locations</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="be-secure.c.html#LN48"><span class='Ref_to_Global_Var'>ssl_loaded_verify_locations</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN432"></a><span class='Label'>error</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>) 
</span>        SSL_CTX_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN170"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end be_tls_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Destroy global SSL context, if any. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN442"></a><span class='Declare_Function'>be_tls_destroy</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Parentheses'>) 
</span>        SSL_CTX_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="be-secure.c.html#LN48"><span class='Ref_to_Global_Var'>ssl_loaded_verify_locations</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Attempt to negotiate SSL connection. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN454"></a><span class='Declare_Function'>be_tls_open_server</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN456"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN457"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN458"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>waitfor</span><span class='Delimiter'>; 
</span><a name="LN459"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Local'>ecode</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not initialize SSL connection: SSL context not set up"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>= </span>SSL_new<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not initialize SSL connection: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN71"><span class='Ref_to_Proto'>my_SSL_set_fd</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set SSL socket: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<a name="LN490"></a><span class='Label'>aloop</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare to call SSL_get_error() by clearing thread's OpenSSL error 
     * queue.  In general, the current thread's error queue must be empty 
     * before the TLS/SSL I/O operation is attempted, or SSL_get_error() will 
     * not work reliably.  An extension may have failed to clear the 
     * per-thread error queue following another call to an OpenSSL I/O 
     * routine. 
     */ 
</span>    ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN456"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>SSL_accept<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN456"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="be-secure-openssl.c.html#LN457"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>SSL_get_error<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN456"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Other clients of OpenSSL in the backend may fail to call 
         * ERR_get_error(), but we always do, so as to not cause problems for 
         * OpenSSL clients that don't call ERR_clear_error() defensively.  Be 
         * sure that this happens by calling now. SSL_get_error() relies on 
         * the OpenSSL per-thread error queue being intact, so this is the 
         * earliest possible point ERR_get_error() may be called. 
         */ 
</span>        <a href="be-secure-openssl.c.html#LN459"><span class='Ref_To_Local'>ecode</span></a> <span class='Operator'>= </span>ERR_get_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN457"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> SSL_ERROR_WANT_READ<span class='Operator'>: 
</span>            <span class='Control'>case</span> SSL_ERROR_WANT_WRITE<span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* not allowed during connection establishment */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN118"><span class='Ref_to_Member'>noblock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * No need to care about timeouts/interrupts here. At this 
                 * point authentication_timeout still employs 
                 * StartupPacketTimeoutHandler() which directly exits. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN457"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>== </span>SSL_ERROR_WANT_READ<span class='Parentheses'>) 
</span>                    <a href="be-secure-openssl.c.html#LN458"><span class='Ref_To_Local'>waitfor</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="be-secure-openssl.c.html#LN458"><span class='Ref_To_Local'>waitfor</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span> 
                <a href="../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN458"><span class='Ref_To_Local'>waitfor</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/pgstat.h.html#LN784"><span class='Ref_to_EnumConst'>WAIT_EVENT_SSL_OPEN_SERVER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="be-secure-openssl.c.html#LN490"><span class='Ref_to_Label'>aloop</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SSL_ERROR_SYSCALL<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN456"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not accept SSL connection: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not accept SSL connection: EOF detected"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SSL_ERROR_SSL<span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not accept SSL connection: %s"</span><span class='Delimiter'>, 
</span>                                <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN459"><span class='Ref_To_Local'>ecode</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SSL_ERROR_ZERO_RETURN<span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not accept SSL connection: EOF detected"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized SSL error code: %d"</span><span class='Delimiter'>, 
</span>                                <a href="be-secure-openssl.c.html#LN457"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch err &raquo; </span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r&LT;=0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Get client certificate, if available. */ 
</span>    <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>= </span>SSL_get_peer_certificate<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and extract the Common Name from it. */ 
</span>    <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN182"><span class='Ref_to_Member'>peer_cert_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN574"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>X509_NAME_get_text_by_NID<span class='Parentheses'>(</span>X509_get_subject_name<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        NID_commonName<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN580"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>peer_cn</span><span class='Delimiter'>; 
</span> 
            <a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN456"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>X509_NAME_get_text_by_NID<span class='Parentheses'>(</span>X509_get_subject_name<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                          NID_commonName<span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a><span class='Delimiter'>[</span><a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN456"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* shouldn't happen */ 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Reject embedded NULLs in certificate common name to prevent 
             * attacks like CVE-2009-4034. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN574"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>!= </span>strlen<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL certificate's common name contains embedded null"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN580"><span class='Ref_To_Local'>peer_cn</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if len!=-1 &raquo; </span> 
        <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN182"><span class='Ref_to_Member'>peer_cert_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if port-&GT;peer!=NULL &raquo; </span> 
 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL connection from \"%s\""</span><span class='Delimiter'>, 
</span>                    <a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a> <span class='Operator'>? </span><a href="be-secure-openssl.c.html#LN454"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a> <span class='Operator'>: </span><span class='String'>"(anonymous)"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set up debugging/info callback */ 
</span>    SSL_CTX_set_info_callback<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN85"><span class='Ref_to_Global_Var'>SSL_context</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN79"><span class='Ref_to_Proto'>info_cb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end be_tls_open_server &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Close SSL connection. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN625"></a><span class='Declare_Function'>be_tls_close</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSL_shutdown<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        SSL_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN180"><span class='Ref_to_Member'>ssl_in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        X509_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN625"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN181"><span class='Ref_to_Member'>peer_cn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end be_tls_close &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Read data from a secure connection. 
 */ 
</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN652"></a><span class='Declare_Function'>be_tls_read</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>waitfor</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN654"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN655"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN656"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Local'>ecode</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span>SSL_read<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN652"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN652"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN652"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN655"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>SSL_get_error<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN652"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN656"><span class='Ref_To_Local'>ecode</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN655"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>!= </span>SSL_ERROR_NONE <span class='Operator'>|| </span><a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span>ERR_get_error<span class='Parentheses'>() </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN655"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SSL_ERROR_NONE<span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* a-ok */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_READ<span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="be-secure-openssl.c.html#LN652"><span class='Ref_to_Parameter'>waitfor</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_WRITE<span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="be-secure-openssl.c.html#LN652"><span class='Ref_to_Parameter'>waitfor</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SYSCALL<span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* leave it to caller to ereport the value of errno */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>                <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SSL<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL error: %s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN656"><span class='Ref_To_Local'>ecode</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* fall through */ 
</span>        <span class='Control'>case</span> SSL_ERROR_ZERO_RETURN<span class='Operator'>: 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized SSL error code: %d"</span><span class='Delimiter'>, 
</span>                            <a href="be-secure-openssl.c.html#LN655"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch err &raquo; </span> 
 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN654"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end be_tls_read &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Write data to a secure connection. 
 */ 
</span><a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a> 
<a name="LN712"></a><span class='Declare_Function'>be_tls_write</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>waitfor</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN714"></a>    <a href="../../include/port/win32.h.html#LN419"><span class='Ref_to_Typedef'>ssize_t</span></a>     <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN715"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN716"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Local'>ecode</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    ERR_clear_error<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span>SSL_write<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN712"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN712"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN712"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN715"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>SSL_get_error<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN712"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN716"><span class='Ref_To_Local'>ecode</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN715"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>!= </span>SSL_ERROR_NONE <span class='Operator'>|| </span><a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span>ERR_get_error<span class='Parentheses'>() </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN715"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SSL_ERROR_NONE<span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* a-ok */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_READ<span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="be-secure-openssl.c.html#LN712"><span class='Ref_to_Parameter'>waitfor</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_WANT_WRITE<span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="be-secure-openssl.c.html#LN712"><span class='Ref_to_Parameter'>waitfor</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SYSCALL<span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* leave it to caller to ereport the value of errno */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>                <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_ERROR_SSL<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL error: %s"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN716"><span class='Ref_To_Local'>ecode</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* fall through */ 
</span>        <span class='Control'>case</span> SSL_ERROR_ZERO_RETURN<span class='Operator'>: 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized SSL error code: %d"</span><span class='Delimiter'>, 
</span>                            <a href="be-secure-openssl.c.html#LN715"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN22"><span class='Ref_to_Const'>ECONNRESET</span></a><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch err &raquo; </span> 
 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN714"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end be_tls_write &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ */ 
/*                      Internal functions                      */ 
/* ------------------------------------------------------------ */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Private substitute BIO: this does the sending and receiving using send() and 
 * recv() instead. This is so that we can enable and disable interrupts 
 * just while calling recv(). We cannot have interrupts occurring while 
 * the bulk of openssl runs, because it uses malloc() and possibly other 
 * non-reentrant libc facilities. We also need to call send() and recv() 
 * directly so it gets passed through the socket/signals layer on Win32. 
 * 
 * These functions are closely modelled on the standard socket BIO in OpenSSL; 
 * see sock_read() and sock_write() in OpenSSL's crypto/bio/bss_sock.c. 
 * XXX OpenSSL 1.0.1e considers many more errcodes than just EINTR as reasons 
 * to retry; do we need to adopt their logic for that? 
 */ 
</span> 
<span class='Directive'>#ifndef</span> HAVE_BIO_GET_DATA 
<a name="LN787"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>BIO_get_data</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>bio</span><span class='Parentheses'>) (</span><a href="be-secure-openssl.c.html#LN787"><span class='Ref_to_Parameter'>bio</span></a><span class='Operator'>-&GT;</span>ptr<span class='Parentheses'>) 
</span><a name="LN788"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>BIO_set_data</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>bio</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>data</span><span class='Parentheses'>) (</span><a href="be-secure-openssl.c.html#LN788"><span class='Ref_to_Parameter'>bio</span></a><span class='Operator'>-&GT;</span>ptr <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN788"><span class='Ref_to_Parameter'>data</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<a name="LN791"></a><span class='Keyword'>static </span>BIO_METHOD <span class='Operator'>*</span><span class='Declare_Var'>my_bio_methods</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static int 
</span><a name="LN794"></a><span class='Declare_Function'>my_sock_read</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN796"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN794"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="be-secure-openssl.c.html#LN796"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN89"><span class='Ref_to_Proto'>secure_raw_read</span></a><span class='Parentheses'>(((</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="be-secure-openssl.c.html#LN787"><span class='Ref_to_Macro'>BIO_get_data</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN794"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN794"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN794"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        BIO_clear_retry_flags<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN794"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN796"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* If we were interrupted, tell caller to retry */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                BIO_set_retry_read<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN794"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN796"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_sock_read &raquo; </span> 
 
<span class='Keyword'>static int 
</span><a name="LN816"></a><span class='Declare_Function'>my_sock_write</span><span class='Parentheses'>(</span>BIO <span class='Operator'>*</span><span class='Declare_Parameter'>h</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN818"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="be-secure-openssl.c.html#LN818"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN90"><span class='Ref_to_Proto'>secure_raw_write</span></a><span class='Parentheses'>(((</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="be-secure-openssl.c.html#LN787"><span class='Ref_to_Macro'>BIO_get_data</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN816"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN816"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN816"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    BIO_clear_retry_flags<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN816"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN818"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If we were interrupted, tell caller to retry */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            BIO_set_retry_write<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN816"><span class='Ref_to_Parameter'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN818"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span>BIO_METHOD <span class='Operator'>* 
</span><a name="LN835"></a><span class='Declare_Function'>my_BIO_s_socket</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN839"></a>        BIO_METHOD <span class='Operator'>*</span><span class='Declare_Local'>biom</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>BIO_METHOD <span class='Operator'>*</span><span class='Parentheses'>) </span>BIO_s_socket<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_BIO_METH_NEW 
<a name="LN841"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>my_bio_index</span><span class='Delimiter'>; 
</span> 
        <a href="be-secure-openssl.c.html#LN841"><span class='Ref_To_Local'>my_bio_index</span></a> <span class='Operator'>= </span>BIO_get_new_index<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN841"><span class='Ref_To_Local'>my_bio_index</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a> <span class='Operator'>= </span>BIO_meth_new<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN841"><span class='Ref_To_Local'>my_bio_index</span></a><span class='Delimiter'>, </span><span class='String'>"PostgreSQL backend socket"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>BIO_meth_set_write<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN69"><span class='Ref_to_Proto'>my_sock_write</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_read<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN68"><span class='Ref_to_Proto'>my_sock_read</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_gets<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_gets<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_puts<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_puts<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_ctrl<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_ctrl<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_create<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_create<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>         <span class='Operator'>!</span>BIO_meth_set_destroy<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_destroy<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>            <span class='Operator'>!</span>BIO_meth_set_callback_ctrl<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span>BIO_meth_get_callback_ctrl<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            BIO_meth_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
        <a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>BIO_METHOD<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN839"><span class='Ref_To_Local'>biom</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>BIO_METHOD<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Operator'>-&GT;</span>bread <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN68"><span class='Ref_to_Proto'>my_sock_read</span></a><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Operator'>-&GT;</span>bwrite <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN69"><span class='Ref_to_Proto'>my_sock_write</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !my_bio_methods &raquo; </span> 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN791"><span class='Ref_to_Global_Var'>my_bio_methods</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_BIO_s_socket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* This should exactly match openssl's SSL_set_fd except for using my BIO */ 
</span><span class='Keyword'>static int 
</span><a name="LN876"></a><span class='Declare_Function'>my_SSL_set_fd</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN878"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN879"></a>    BIO        <span class='Operator'>*</span><span class='Declare_Local'>bio</span><span class='Delimiter'>; 
</span><a name="LN880"></a>    BIO_METHOD <span class='Operator'>*</span><span class='Declare_Local'>bio_method</span><span class='Delimiter'>; 
</span> 
    <a href="be-secure-openssl.c.html#LN880"><span class='Ref_To_Local'>bio_method</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>my_BIO_s_socket</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN880"><span class='Ref_To_Local'>bio_method</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSLerr<span class='Parentheses'>(</span>SSL_F_SSL_SET_FD<span class='Delimiter'>, </span>ERR_R_BUF_LIB<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN900"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="be-secure-openssl.c.html#LN879"><span class='Ref_To_Local'>bio</span></a> <span class='Operator'>= </span>BIO_new<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN880"><span class='Ref_To_Local'>bio_method</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN879"><span class='Ref_To_Local'>bio</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSLerr<span class='Parentheses'>(</span>SSL_F_SSL_SET_FD<span class='Delimiter'>, </span>ERR_R_BUF_LIB<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="be-secure-openssl.c.html#LN900"><span class='Ref_to_Label'>err</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="be-secure-openssl.c.html#LN788"><span class='Ref_to_Macro'>BIO_set_data</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN879"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN876"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    BIO_set_fd<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN879"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN876"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span>BIO_NOCLOSE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    SSL_set_bio<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN876"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN879"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN879"><span class='Ref_To_Local'>bio</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN878"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN900"></a><span class='Label'>err</span><span class='Operator'>: 
</span>    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN878"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end my_SSL_set_fd &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Load precomputed DH parameters. 
 * 
 *  To prevent "downgrade" attacks, we perform a number of checks 
 *  to verify that the DBA-generated DH parameters file contains 
 *  what we expect it to contain. 
 */ 
</span><span class='Keyword'>static </span>DH  <span class='Operator'>* 
</span><a name="LN912"></a><span class='Declare_Function'>load_dh_file</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>keylength</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN914"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span><a name="LN915"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fnbuf</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN916"></a>    DH         <span class='Operator'>*</span><span class='Declare_Local'>dh</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN917"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>codes</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* attempt to open file.  It's not an error if it doesn't exist. */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"dh%d.pem"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN912"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="be-secure-openssl.c.html#LN914"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><span class='String'>"r"</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/*  flock(fileno(fp), LOCK_SH); */ 
</span>    <a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>= </span>PEM_read_DHparams<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN914"><span class='Ref_To_Local'>fp</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Comment_Multi_Line'>/*  flock(fileno(fp), LOCK_UN); */ 
</span>    fclose<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN914"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* is the prime the correct size? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><span class='Number'>8</span> <span class='Operator'>* </span>DH_size<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="be-secure-openssl.c.html#LN912"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"DH errors (%s): %d bits expected, %d bits found"</span><span class='Delimiter'>, 
</span>             <a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN912"><span class='Ref_to_Parameter'>keylength</span></a><span class='Delimiter'>, </span><span class='Number'>8</span> <span class='Operator'>* </span>DH_size<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* make sure the DH parameters are usable */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>DH_check<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="be-secure-openssl.c.html#LN917"><span class='Ref_To_Local'>codes</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"DH_check error (%s): %s"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Delimiter'>, 
</span>                 <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN917"><span class='Ref_To_Local'>codes</span></a> <span class='Operator'>& </span>DH_CHECK_P_NOT_PRIME<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"DH error (%s): p is not prime"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="be-secure-openssl.c.html#LN917"><span class='Ref_To_Local'>codes</span></a> <span class='Operator'>& </span>DH_NOT_SUITABLE_GENERATOR<span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN917"><span class='Ref_To_Local'>codes</span></a> <span class='Operator'>& </span>DH_CHECK_P_NOT_SAFE_PRIME<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"DH error (%s): neither suitable generator or safe prime"</span><span class='Delimiter'>, 
</span>                 <a href="be-secure-openssl.c.html#LN915"><span class='Ref_To_Local'>fnbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dh!=NULL &raquo; </span> 
 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN916"><span class='Ref_To_Local'>dh</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end load_dh_file &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Load hardcoded DH parameters. 
 * 
 *  To prevent problems if the DH parameters files don't even 
 *  exist, we can load DH parameters hardcoded into this file. 
 */ 
</span><span class='Keyword'>static </span>DH  <span class='Operator'>* 
</span><a name="LN971"></a><span class='Declare_Function'>load_dh_buffer</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN973"></a>    BIO        <span class='Operator'>*</span><span class='Declare_Local'>bio</span><span class='Delimiter'>; 
</span><a name="LN974"></a>    DH         <span class='Operator'>*</span><span class='Declare_Local'>dh</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="be-secure-openssl.c.html#LN973"><span class='Ref_To_Local'>bio</span></a> <span class='Operator'>= </span>BIO_new_mem_buf<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="be-secure-openssl.c.html#LN971"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN971"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN973"><span class='Ref_To_Local'>bio</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN974"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>= </span>PEM_read_bio_DHparams<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN973"><span class='Ref_To_Local'>bio</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN974"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"DH load buffer: %s"</span><span class='Delimiter'>, 
</span>                                 <a href="../../interfaces/libpq/fe-secure-openssl.c.html#LN70"><span class='Ref_to_Proto'>SSLerrmessage</span></a><span class='Parentheses'>(</span>ERR_get_error<span class='Parentheses'>()))))</span><span class='Delimiter'>; 
</span>    BIO_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN973"><span class='Ref_To_Local'>bio</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN974"><span class='Ref_To_Local'>dh</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Generate DH parameters. 
 * 
 *  Last resort if we can't load precomputed nor hardcoded 
 *  parameters. 
 */ 
</span><span class='Keyword'>static </span>DH  <span class='Operator'>* 
</span><a name="LN996"></a><span class='Declare_Function'>generate_dh_parameters</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>prime_len</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>generator</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN998"></a>    DH         <span class='Operator'>*</span><span class='Declare_Local'>dh</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="be-secure-openssl.c.html#LN998"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>= </span>DH_new<span class='Parentheses'>())</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>DH_generate_parameters_ex<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN998"><span class='Ref_To_Local'>dh</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN996"><span class='Ref_to_Parameter'>prime_len</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN996"><span class='Ref_to_Parameter'>generator</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN998"><span class='Ref_To_Local'>dh</span></a><span class='Delimiter'>; 
</span> 
    DH_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN998"><span class='Ref_To_Local'>dh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Generate an ephemeral DH key.  Because this can take a long 
 *  time to compute, we can use precomputed parameters of the 
 *  common key sizes. 
 * 
 *  Since few sites will bother to precompute these parameter 
 *  files, we also provide a fallback to the parameters provided 
 *  by the OpenSSL project. 
 * 
 *  These values can be static (once loaded or computed) since 
 *  the OpenSSL library can efficiently generate random keys from 
 *  the information provided. 
 */ 
</span><span class='Keyword'>static </span>DH  <span class='Operator'>* 
</span><a name="LN1024"></a><span class='Declare_Function'>tmp_dh_cb</span><span class='Parentheses'>(</span>SSL <span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>is_export</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>keylength</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1026"></a>    DH         <span class='Operator'>*</span><span class='Declare_Local'>r</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1027"></a>    <span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Local'>dh</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1028"></a>    <span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Local'>dh512</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1029"></a>    <span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Local'>dh1024</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1030"></a>    <span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Local'>dh2048</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1031"></a>    <span class='Keyword'>static </span>DH  <span class='Operator'>*</span><span class='Declare_Local'>dh4096</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Number'>512</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1028"><span class='Ref_To_Local'>dh512</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1028"><span class='Ref_To_Local'>dh512</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN73"><span class='Ref_to_Proto'>load_dh_file</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1028"><span class='Ref_To_Local'>dh512</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1028"><span class='Ref_To_Local'>dh512</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN74"><span class='Ref_to_Proto'>load_dh_buffer</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN116"><span class='Ref_to_Global_Var'>file_dh512</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof </span><a href="be-secure-openssl.c.html#LN116"><span class='Ref_to_Global_Var'>file_dh512</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN1028"><span class='Ref_To_Local'>dh512</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <span class='Number'>1024</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1029"><span class='Ref_To_Local'>dh1024</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1029"><span class='Ref_To_Local'>dh1024</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN73"><span class='Ref_to_Proto'>load_dh_file</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1029"><span class='Ref_To_Local'>dh1024</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1029"><span class='Ref_To_Local'>dh1024</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN74"><span class='Ref_to_Proto'>load_dh_buffer</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN122"><span class='Ref_to_Global_Var'>file_dh1024</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof </span><a href="be-secure-openssl.c.html#LN122"><span class='Ref_to_Global_Var'>file_dh1024</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN1029"><span class='Ref_To_Local'>dh1024</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <span class='Number'>2048</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1030"><span class='Ref_To_Local'>dh2048</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1030"><span class='Ref_To_Local'>dh2048</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN73"><span class='Ref_to_Proto'>load_dh_file</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1030"><span class='Ref_To_Local'>dh2048</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1030"><span class='Ref_To_Local'>dh2048</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN74"><span class='Ref_to_Proto'>load_dh_buffer</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN129"><span class='Ref_to_Global_Var'>file_dh2048</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof </span><a href="be-secure-openssl.c.html#LN129"><span class='Ref_to_Global_Var'>file_dh2048</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN1030"><span class='Ref_To_Local'>dh2048</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <span class='Number'>4096</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1031"><span class='Ref_To_Local'>dh4096</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1031"><span class='Ref_To_Local'>dh4096</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN73"><span class='Ref_to_Proto'>load_dh_file</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1031"><span class='Ref_To_Local'>dh4096</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1031"><span class='Ref_To_Local'>dh4096</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN74"><span class='Ref_to_Proto'>load_dh_buffer</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN139"><span class='Ref_to_Global_Var'>file_dh4096</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof </span><a href="be-secure-openssl.c.html#LN139"><span class='Ref_to_Global_Var'>file_dh4096</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN1031"><span class='Ref_To_Local'>dh4096</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1027"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="be-secure-openssl.c.html#LN1027"><span class='Ref_To_Local'>dh</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN73"><span class='Ref_to_Proto'>load_dh_file</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN1027"><span class='Ref_To_Local'>dh</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch keylength &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* this may take a long time, but it may be necessary... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><span class='Number'>8</span> <span class='Operator'>* </span>DH_size<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"DH: generating parameters (%d bits)"</span><span class='Delimiter'>, 
</span>                                 <a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="be-secure-openssl.c.html#LN75"><span class='Ref_to_Proto'>generate_dh_parameters</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1024"><span class='Ref_to_Parameter'>keylength</span></a><span class='Delimiter'>, </span>DH_GENERATOR_2<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN1026"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tmp_dh_cb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Passphrase collection callback 
 * 
 * If OpenSSL is told to use a passphrase-protected server key, by default 
 * it will issue a prompt on /dev/tty and try to read a key from there. 
 * That's no good during a postmaster SIGHUP cycle, not to mention SSL context 
 * reload in an EXEC_BACKEND postmaster child.  So override it with this dummy 
 * function that just returns an empty passphrase, guaranteeing failure. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1095"></a><span class='Declare_Function'>ssl_passwd_cb</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rwflag</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>userdata</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Set flag to change the error message we'll report */ 
</span>    <a href="be-secure-openssl.c.html#LN87"><span class='Ref_to_Global_Var'>ssl_passwd_cb_called</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* And return empty string */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1095"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN1095"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  Certificate verification callback 
 * 
 *  This callback allows us to log intermediate problems during 
 *  verification, but for now we'll see if the final error message 
 *  contains enough information. 
 * 
 *  This callback also allows us to override the default acceptance 
 *  criteria (e.g., accepting self-signed or expired certs), but 
 *  for now we accept the default checks. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1117"></a><span class='Declare_Function'>verify_cb</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>ok</span><span class='Delimiter'>, </span>X509_STORE_CTX <span class='Operator'>*</span><span class='Declare_Parameter'>ctx</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN1117"><span class='Ref_to_Parameter'>ok</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  This callback is used to copy SSL information messages 
 *  into the PostgreSQL log. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1127"></a><span class='Declare_Function'>info_cb</span><span class='Parentheses'>(</span><span class='Keyword'>const </span>SSL <span class='Operator'>*</span><span class='Declare_Parameter'>ssl</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>type</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>args</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1127"><span class='Ref_to_Parameter'>type</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SSL_CB_HANDSHAKE_START<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: handshake start"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_HANDSHAKE_DONE<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: handshake done"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_ACCEPT_LOOP<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: accept loop"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_ACCEPT_EXIT<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: accept exit (%d)"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1127"><span class='Ref_to_Parameter'>args</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_CONNECT_LOOP<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: connect loop"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_CONNECT_EXIT<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: connect exit (%d)"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1127"><span class='Ref_to_Parameter'>args</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_READ_ALERT<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: read alert (0x%04x)"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1127"><span class='Ref_to_Parameter'>args</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SSL_CB_WRITE_ALERT<span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"SSL: write alert (0x%04x)"</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1127"><span class='Ref_to_Parameter'>args</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end info_cb &raquo; </span> 
 
<span class='Keyword'>static bool 
</span><a name="LN1167"></a><span class='Declare_Function'>initialize_ecdh</span><span class='Parentheses'>(</span>SSL_CTX <span class='Operator'>*</span><span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isServerStart</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> OPENSSL_NO_ECDH 
<a name="LN1170"></a>    EC_KEY     <span class='Operator'>*</span><span class='Declare_Local'>ecdh</span><span class='Delimiter'>; 
</span><a name="LN1171"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nid</span><span class='Delimiter'>; 
</span> 
    <a href="be-secure-openssl.c.html#LN1171"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>= </span>OBJ_sn2nid<span class='Parentheses'>(</span><a href="be-secure.c.html#LN55"><span class='Ref_to_Global_Var'>SSLECDHCurve</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN1171"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ECDH: unrecognized curve name: %s"</span><span class='Delimiter'>, </span><a href="be-secure.c.html#LN55"><span class='Ref_to_Global_Var'>SSLECDHCurve</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="be-secure-openssl.c.html#LN1170"><span class='Ref_To_Local'>ecdh</span></a> <span class='Operator'>= </span>EC_KEY_new_by_curve_name<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1171"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN1170"><span class='Ref_To_Local'>ecdh</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1167"><span class='Ref_to_Parameter'>isServerStart</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIG_FILE_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ECDH: could not create key"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    SSL_CTX_set_options<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1167"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>, </span>SSL_OP_SINGLE_ECDH_USE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    SSL_CTX_set_tmp_ecdh<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1167"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1170"><span class='Ref_To_Local'>ecdh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    EC_KEY_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1170"><span class='Ref_To_Local'>ecdh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initialize_ecdh &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Obtain reason string for passed SSL errcode 
 * 
 * ERR_get_error() is used by caller to get errcode to pass here. 
 * 
 * Some caution is needed here since ERR_reason_error_string will 
 * return NULL if it doesn't recognize the error code.  We don't 
 * want to return NULL ever. 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN1209"></a><span class='Declare_Function'>SSLerrmessage</span><span class='Parentheses'>(</span><span class='Keyword'>unsigned long </span><span class='Declare_Parameter'>ecode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1211"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>errreason</span><span class='Delimiter'>; 
</span><a name="LN1212"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>errbuf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1209"><span class='Ref_to_Parameter'>ecode</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> _<span class='Parentheses'>(</span><span class='String'>"no SSL error reported"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN1211"><span class='Ref_To_Local'>errreason</span></a> <span class='Operator'>= </span>ERR_reason_error_string<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1209"><span class='Ref_to_Parameter'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1211"><span class='Ref_To_Local'>errreason</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN1211"><span class='Ref_To_Local'>errreason</span></a><span class='Delimiter'>; 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1212"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1212"><span class='Ref_To_Local'>errbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"SSL error code %lu"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1209"><span class='Ref_to_Parameter'>ecode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN1212"><span class='Ref_To_Local'>errbuf</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return information about the SSL connection 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1227"></a><span class='Declare_Function'>be_tls_get_cipher_bits</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1229"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bits</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1227"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SSL_get_cipher_bits<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1227"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="be-secure-openssl.c.html#LN1229"><span class='Ref_To_Local'>bits</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN1229"><span class='Ref_To_Local'>bits</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN1241"></a><span class='Declare_Function'>be_tls_get_compression</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1241"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN418"><span class='Ref_to_Macro'>SSL_get_current_compression</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1241"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN1250"></a><span class='Declare_Function'>be_tls_get_version</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1250"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1250"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span>SSL_get_version<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1250"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1250"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="be-secure-openssl.c.html#LN1250"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN1259"></a><span class='Declare_Function'>be_tls_get_cipher</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1259"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>) 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1259"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span>SSL_get_cipher<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1259"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1259"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="be-secure-openssl.c.html#LN1259"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN1268"></a><span class='Declare_Function'>be_tls_get_peerdn_name</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1268"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>) 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1268"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN83"><span class='Ref_to_Proto'>X509_NAME_to_cstring</span></a><span class='Parentheses'>(</span>X509_get_subject_name<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1268"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN190"><span class='Ref_to_Member'>peer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1268"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="be-secure-openssl.c.html#LN1268"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Convert an X509 subject name to a cstring. 
 * 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1281"></a><span class='Declare_Function'>X509_NAME_to_cstring</span><span class='Parentheses'>(</span>X509_NAME <span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1283"></a>    BIO        <span class='Operator'>*</span><span class='Declare_Local'>membuf</span> <span class='Operator'>= </span>BIO_new<span class='Parentheses'>(</span>BIO_s_mem<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><a name="LN1284"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1285"></a>                <span class='Declare_Local'>nid</span><span class='Delimiter'>, 
</span><a name="LN1286"></a>                <span class='Declare_Local'>count</span> <span class='Operator'>= </span>X509_NAME_entry_count<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1281"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1287"></a>    X509_NAME_ENTRY <span class='Operator'>*</span><span class='Declare_Local'>e</span><span class='Delimiter'>; 
</span><a name="LN1288"></a>    ASN1_STRING <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1289"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>field_name</span><span class='Delimiter'>; 
</span><a name="LN1290"></a>    size_t      <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN1291"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>nullterm</span><span class='Delimiter'>; 
</span><a name="LN1292"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sp</span><span class='Delimiter'>; 
</span><a name="LN1293"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN1294"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>BIO_set_close<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1283"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span>BIO_CLOSE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1284"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="be-secure-openssl.c.html#LN1284"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="be-secure-openssl.c.html#LN1286"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; </span><a href="be-secure-openssl.c.html#LN1284"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="be-secure-openssl.c.html#LN1287"><span class='Ref_To_Local'>e</span></a> <span class='Operator'>= </span>X509_NAME_get_entry<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1281"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1284"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN1285"><span class='Ref_To_Local'>nid</span></a> <span class='Operator'>= </span>OBJ_obj2nid<span class='Parentheses'>(</span>X509_NAME_ENTRY_get_object<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1287"><span class='Ref_To_Local'>e</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN1288"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span>X509_NAME_ENTRY_get_data<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1287"><span class='Ref_To_Local'>e</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="be-secure-openssl.c.html#LN1289"><span class='Ref_To_Local'>field_name</span></a> <span class='Operator'>= </span>OBJ_nid2sn<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1285"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="be-secure-openssl.c.html#LN1289"><span class='Ref_To_Local'>field_name</span></a><span class='Parentheses'>) 
</span>            <a href="be-secure-openssl.c.html#LN1289"><span class='Ref_To_Local'>field_name</span></a> <span class='Operator'>= </span>OBJ_nid2ln<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1285"><span class='Ref_To_Local'>nid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        BIO_printf<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1283"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='String'>"/%s="</span><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1289"><span class='Ref_To_Local'>field_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        ASN1_STRING_print_ex<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1283"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1288"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>((</span>ASN1_STRFLGS_RFC2253 <span class='Operator'>& ~</span>ASN1_STRFLGS_ESC_MSB<span class='Parentheses'>) 
</span>                              <span class='Operator'>| </span>ASN1_STRFLGS_UTF8_CONVERT<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* ensure null termination of the BIO's content */ 
</span>    <a href="be-secure-openssl.c.html#LN1291"><span class='Ref_To_Local'>nullterm</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    BIO_write<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1283"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="be-secure-openssl.c.html#LN1291"><span class='Ref_To_Local'>nullterm</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN1290"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span>BIO_get_mem_data<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1283"><span class='Ref_To_Local'>membuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="be-secure-openssl.c.html#LN1292"><span class='Ref_To_Local'>sp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="be-secure-openssl.c.html#LN1293"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN566"><span class='Ref_to_Proto'>pg_any_to_server</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1292"><span class='Ref_To_Local'>sp</span></a><span class='Delimiter'>, </span><a href="be-secure-openssl.c.html#LN1290"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="be-secure-openssl.c.html#LN1294"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1293"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1293"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>!= </span><a href="be-secure-openssl.c.html#LN1292"><span class='Ref_To_Local'>sp</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1293"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    BIO_free<span class='Parentheses'>(</span><a href="be-secure-openssl.c.html#LN1283"><span class='Ref_To_Local'>membuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="be-secure-openssl.c.html#LN1294"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end X509_NAME_to_cstring &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>