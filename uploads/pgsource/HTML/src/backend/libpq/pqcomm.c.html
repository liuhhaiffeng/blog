<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\libpq\pqcomm.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\libpq\pqcomm.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:40 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pqcomm.c 
 *    Communication functions between the Frontend and the Backend 
 * 
 * These routines handle the low-level details of communication between 
 * frontend and backend.  They just shove data across the communication 
 * channel, and are ignorant of the semantics of the data --- or would be, 
 * except for major brain damage in the design of the old COPY OUT protocol. 
 * Unfortunately, COPY OUT was designed to commandeer the communication 
 * channel (it just transfers data without wrapping it into messages). 
 * No other messages can be sent while COPY OUT is in progress; and if the 
 * copy is aborted by an ereport(ERROR), we need to close out the copy so that 
 * the frontend gets back into sync.  Therefore, these routines have to be 
 * aware of COPY OUT state.  (New COPY-OUT is message-based and does *not* 
 * set the DoingCopyOut flag.) 
 * 
 * NOTE: generally, it's a bad idea to emit outgoing messages directly with 
 * pq_putbytes(), especially if the message would require multiple calls 
 * to send.  Instead, use the routines in pqformat.c to construct the message 
 * in a buffer and then emit it in one call to pq_putmessage.  This ensures 
 * that the channel will not be clogged by an incomplete message if execution 
 * is aborted by ereport(ERROR) partway through the message.  The only 
 * non-libpq code that should call pq_putbytes directly is old-style COPY OUT. 
 * 
 * At one time, libpq was shared between frontend and backend, but now 
 * the backend's "backend/libpq" is quite separate from "interfaces/libpq". 
 * All that remains is similarities of names to trap the unwary... 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 *  src/backend/libpq/pqcomm.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/*------------------------ 
 * INTERFACE ROUTINES 
 * 
 * setup/teardown: 
 *      StreamServerPort    - Open postmaster's server port 
 *      StreamConnection    - Create new connection with client 
 *      StreamClose         - Close a client/backend connection 
 *      TouchSocketFiles    - Protect socket files against /tmp cleaners 
 *      pq_init         - initialize libpq at backend startup 
 *      pq_comm_reset   - reset libpq during error recovery 
 *      pq_close        - shutdown libpq at backend exit 
 * 
 * low-level I/O: 
 *      pq_getbytes     - get a known number of bytes from connection 
 *      pq_getstring    - get a null terminated string from connection 
 *      pq_getmessage   - get a message with length word from connection 
 *      pq_getbyte      - get next byte from connection 
 *      pq_peekbyte     - peek at next byte from connection 
 *      pq_putbytes     - send bytes to connection (not flushed until pq_flush) 
 *      pq_flush        - flush pending output 
 *      pq_flush_if_writable - flush pending output if writable without blocking 
 *      pq_getbyte_if_available - get a byte if available without blocking 
 * 
 * message-level I/O (and old-style-COPY-OUT cruft): 
 *      pq_putmessage   - send a normal message (suppressed in COPY OUT mode) 
 *      pq_putmessage_noblock - buffer a normal message (suppressed in COPY OUT) 
 *      pq_startcopyout - inform libpq that a COPY OUT transfer is beginning 
 *      pq_endcopyout   - end a COPY OUT transfer 
 * 
 *------------------------ 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;grp.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/file.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_NETINET_TCP_H 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/tcp.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_UTIME_H 
<span class='Keyword'>#include </span><span class='String'>&LT;utime.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> _MSC_VER                 <span class='Comment_Single_Line'>/* mstcpip.h is missing on mingw */ 
</span><span class='Keyword'>#include </span><span class='String'>&LT;mstcpip.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"common/ip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Configuration options 
 */ 
</span><a name="LN101"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Unix_socket_permissions</span><span class='Delimiter'>; 
</span><a name="LN102"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>Unix_socket_group</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Where the Unix socket files are (list of palloc'd strings) */ 
</span><a name="LN105"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Var'>sock_paths</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Buffers for low-level I/O. 
 * 
 * The receive buffer is fixed size. Send buffer is usually 8k, but can be 
 * enlarged by pq_putmessage_noblock() if the message doesn't fit otherwise. 
 */ 
</span> 
<a name="LN114"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PQ_SEND_BUFFER_SIZE</span> <span class='Number'>8192</span> 
<a name="LN115"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PQ_RECV_BUFFER_SIZE</span> <span class='Number'>8192</span> 
 
<a name="LN117"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>PqSendBuffer</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>PqSendBufferSize</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Size send buffer */ 
</span><a name="LN119"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>PqSendPointer</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Next index to store a byte in PqSendBuffer */ 
</span><a name="LN120"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>PqSendStart</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Next index to send a byte in PqSendBuffer */ 
</span> 
<a name="LN122"></a><span class='Keyword'>static char </span><span class='Declare_Var'>PqRecvBuffer</span><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN115"><span class='Ref_to_Const'>PQ_RECV_BUFFER_SIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN123"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>PqRecvPointer</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Next index to read a byte from PqRecvBuffer */ 
</span><a name="LN124"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>PqRecvLength</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* End of data available in PqRecvBuffer */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Message status 
 */ 
</span><a name="LN129"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>PqCommBusy</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* busy sending data to the client */ 
</span><a name="LN130"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>PqCommReadingMsg</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* in the middle of reading a message */ 
</span><a name="LN131"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>DoingCopyOut</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* in old-protocol COPY OUT processing */ 
</span> 
 
<span class='Comment_Multi_Line'>/* Internal functions */ 
</span><a name="LN135"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>socket_comm_reset</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN136"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>socket_close</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN137"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>socket_set_nonblocking</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nonblocking</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN138"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>socket_flush</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN139"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>socket_flush_if_writable</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN140"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>socket_is_send_pending</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN141"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>socket_putmessage</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Declare_Parameter'>msgtype</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN142"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>socket_putmessage_noblock</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Declare_Parameter'>msgtype</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN143"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>socket_startcopyout</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN144"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>socket_endcopyout</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>errorAbort</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN145"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>internal_putbytes</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN146"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>internal_flush</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
<a name="LN149"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>Lock_AF_UNIX</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>unixSocketDir</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>unixSocketPath</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN150"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>Setup_AF_UNIX</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sock_path</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UNIX_SOCKETS */ 
</span> 
<a name="LN153"></a><span class='Keyword'>static </span><a href="../../include/libpq/libpq.h.html#LN23"><span class='Ref_to_Typedef'>PQcommMethods</span></a> <span class='Declare_Var'>PqCommSocketMethods</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="pqcomm.c.html#LN135"><span class='Ref_to_Proto'>socket_comm_reset</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN138"><span class='Ref_to_Proto'>socket_flush</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN139"><span class='Ref_to_Proto'>socket_flush_if_writable</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN140"><span class='Ref_to_Proto'>socket_is_send_pending</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN141"><span class='Ref_to_Proto'>socket_putmessage</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN142"><span class='Ref_to_Proto'>socket_putmessage_noblock</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN143"><span class='Ref_to_Proto'>socket_startcopyout</span></a><span class='Delimiter'>, 
</span>    <a href="pqcomm.c.html#LN144"><span class='Ref_to_Proto'>socket_endcopyout</span></a> 
<span class='Delimiter'>}; 
</span> 
<a name="LN164"></a><a href="../../include/libpq/libpq.h.html#LN23"><span class='Ref_to_Typedef'>PQcommMethods</span></a> <span class='Operator'>*</span><span class='Declare_Var'>PqCommMethods</span> <span class='Operator'>= &</span><a href="pqcomm.c.html#LN153"><span class='Ref_to_Global_Var'>PqCommSocketMethods</span></a><span class='Delimiter'>; 
</span> 
<a name="LN166"></a><a href="../storage/ipc/latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Var'>FeBeWaitSet</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_init - initialize libpq at backend startup 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN174"></a><span class='Declare_Function'>pq_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* initialize state variables */ 
</span>    <a href="pqcomm.c.html#LN118"><span class='Ref_to_Global_Var'>PqSendBufferSize</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN114"><span class='Ref_to_Const'>PQ_SEND_BUFFER_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN117"><span class='Ref_to_Global_Var'>PqSendBuffer</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN118"><span class='Ref_to_Global_Var'>PqSendBufferSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN131"><span class='Ref_to_Global_Var'>DoingCopyOut</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set up process-exit hook to close the socket */ 
</span>    <a href="../../include/storage/ipc.h.html#LN68"><span class='Ref_to_Proto'>on_proc_exit</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN136"><span class='Ref_to_Proto'>socket_close</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In backends (as soon as forked) we operate the underlying socket in 
     * nonblocking mode and use latches to implement blocking semantics if 
     * needed. That allows us to provide safely interruptible reads and 
     * writes. 
     * 
     * Use COMMERROR on failure, because ERROR would try to send the error to 
     * the client, which might require changing the mode again, leading to 
     * infinite recursion. 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../port/noblock.c.html#LN23"><span class='Ref_to_Func'>pg_set_noblock</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set socket to nonblocking mode: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN154"><span class='Ref_to_Proto'>CreateWaitEventSet</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN156"><span class='Ref_to_Proto'>AddWaitEventToSet</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Delimiter'>, </span><a href="../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, 
</span>                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN156"><span class='Ref_to_Proto'>AddWaitEventToSet</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Delimiter'>, </span><a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN156"><span class='Ref_to_Proto'>AddWaitEventToSet</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Delimiter'>, </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      socket_comm_reset - reset libpq during error recovery 
 * 
 * This is called from error recovery at the outer idle loop.  It's 
 * just to get us out of trouble if we somehow manage to elog() from 
 * inside a pqcomm.c routine (which ideally will never happen, but...) 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN219"></a><span class='Declare_Function'>socket_comm_reset</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Do not throw away pending data, but do reset the busy flag */ 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We can abort any old-style COPY OUT, too */ 
</span>    <a href="../../include/libpq/libpq.h.html#LN46"><span class='Ref_to_Macro'>pq_endcopyout</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      socket_close - shutdown libpq at backend exit 
 * 
 * This is the one pg_on_exit_callback in place during BackendInitialize(). 
 * That function's unusual signal handling constrains that this callback be 
 * safe to run at any instant. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN236"></a><span class='Declare_Function'>socket_close</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Nothing to do in a standalone backend, where MyProcPort is NULL. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#ifdef</span> ENABLE_GSS 
<a name="LN243"></a>        OM_uint32   <span class='Declare_Local'>min_s</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Shutdown GSSAPI layer.  This section does nothing when interrupting 
         * BackendInitialize(), because pg_GSS_recvauth() makes first use of 
         * "ctx" and "cred". 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN86"><span class='Ref_to_Member'>ctx</span></a> <span class='Operator'>!= </span>GSS_C_NO_CONTEXT<span class='Parentheses'>) 
</span>            gss_delete_sec_context<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pqcomm.c.html#LN243"><span class='Ref_To_Local'>min_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN86"><span class='Ref_to_Member'>ctx</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN85"><span class='Ref_to_Member'>cred</span></a> <span class='Operator'>!= </span>GSS_C_NO_CREDENTIAL<span class='Parentheses'>) 
</span>            gss_release_cred<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pqcomm.c.html#LN243"><span class='Ref_To_Local'>min_s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN85"><span class='Ref_to_Member'>cred</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_GSS */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * GSS and SSPI share the port-&GT;gss struct.  Since nowhere else does a 
         * postmaster child free this, doing so is safe when interrupting 
         * BackendInitialize(). 
         */ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* ENABLE_GSS || ENABLE_SSPI */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Cleanly shut down SSL layer.  Nowhere else does a postmaster child 
         * call this, so this is safe when interrupting BackendInitialize(). 
         */ 
</span>        <a href="../../include/libpq/libpq.h.html#LN86"><span class='Ref_to_Proto'>secure_close</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Formerly we did an explicit close() here, but it seems better to 
         * leave the socket open until the process dies.  This allows clients 
         * to perform a "synchronous close" if they care --- wait till the 
         * transport layer reports connection closure, and you can be sure the 
         * backend has exited. 
         * 
         * We do set sock to PGINVALID_SOCKET to prevent any further I/O, 
         * though. 
         */ 
</span>        <a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if MyProcPort!=NULL &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end socket_close &raquo; </span> 
 
 
 
<span class='Comment_Multi_Line'>/* 
 * Streams -- wrapper around Unix socket system calls 
 * 
 * 
 *      Stream functions are used for vanilla TCP connection protocol. 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * StreamServerPort -- open a "listening" port to accept connections. 
 * 
 * family should be AF_UNIX or AF_UNSPEC; portNumber is the port number. 
 * For AF_UNIX ports, hostName should be NULL and unixSocketDir must be 
 * specified.  For TCP ports, hostName is either NULL for all interfaces or 
 * the interface to listen on, and unixSocketDir is ignored (can be NULL). 
 * 
 * Successfully opened sockets are added to the ListenSocket[] array (of 
 * length MaxListen), at the first position that isn't PGINVALID_SOCKET. 
 * 
 * RETURNS: STATUS_OK or STATUS_ERROR 
 */ 
</span> 
<span class='Keyword'>int 
</span><a name="LN310"></a><span class='Declare_Function'>StreamServerPort</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>family</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>hostName</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned short </span><span class='Declare_Parameter'>portNumber</span><span class='Delimiter'>, 
</span><a name="LN311"></a>                 <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>unixSocketDir</span><span class='Delimiter'>, 
</span><a name="LN312"></a>                 <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>ListenSocket</span><span class='Delimiter'>[], </span><span class='Keyword'>int </span><span class='Declare_Parameter'>MaxListen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN314"></a>    <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a>    <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN315"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN316"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxconn</span><span class='Delimiter'>; 
</span><a name="LN317"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN318"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>portNumberStr</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN319"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>familyDesc</span><span class='Delimiter'>; 
</span><a name="LN320"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>familyDescBuf</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN321"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>addrDesc</span><span class='Delimiter'>; 
</span><a name="LN322"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>addrBuf</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span><a name="LN323"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>service</span><span class='Delimiter'>; 
</span><a name="LN324"></a>    <span class='Control'>struct</span> <a href="../../include/getaddrinfo.h.html#LN114"><span class='Ref_to_Struct'>addrinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>addrs</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN325"></a>               <span class='Operator'>*</span><span class='Declare_Local'>addr</span><span class='Delimiter'>; 
</span><a name="LN326"></a>    <span class='Control'>struct</span> <a href="../../include/getaddrinfo.h.html#LN114"><span class='Ref_to_Struct'>addrinfo</span></a> <span class='Declare_Local'>hint</span><span class='Delimiter'>; 
</span><a name="LN327"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>listen_index</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN328"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>added</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
<a name="LN331"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>unixSocketPath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span>IPV6_V6ONLY<span class='Parentheses'>) 
</span><a name="LN334"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>one</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Initialize hint structure */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>family</span></a><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN99"><span class='Ref_to_Member'>ai_flags</span></a> <span class='Operator'>= </span><a href="../../include/getaddrinfo.h.html#LN61"><span class='Ref_to_Const'>AI_PASSIVE</span></a><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN101"><span class='Ref_to_Member'>ai_socktype</span></a> <span class='Operator'>= </span>SOCK_STREAM<span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>family</span></a> <span class='Operator'>== </span>AF_UNIX<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Create unixSocketPath from portNumber and unixSocketDir and lock 
         * that file path 
         */ 
</span>        <a href="../../include/libpq/pqcomm.h.html#LN69"><span class='Ref_to_Macro'>UNIXSOCK_PATH</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN331"><span class='Ref_To_Local'>unixSocketPath</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>portNumber</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN311"><span class='Ref_to_Parameter'>unixSocketDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN331"><span class='Ref_To_Local'>unixSocketPath</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../include/libpq/pqcomm.h.html#LN85"><span class='Ref_to_Const'>UNIXSOCK_PATH_BUFLEN</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"Unix-domain socket path \"%s\" is too long (maximum %d bytes)"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN331"><span class='Ref_To_Local'>unixSocketPath</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="../../include/libpq/pqcomm.h.html#LN85"><span class='Ref_to_Const'>UNIXSOCK_PATH_BUFLEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN149"><span class='Ref_to_Proto'>Lock_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN311"><span class='Ref_to_Parameter'>unixSocketDir</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN331"><span class='Ref_To_Local'>unixSocketPath</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN331"><span class='Ref_To_Local'>unixSocketPath</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UNIX_SOCKETS */ 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN318"><span class='Ref_To_Local'>portNumberStr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN318"><span class='Ref_To_Local'>portNumberStr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>portNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN318"><span class='Ref_To_Local'>portNumberStr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pqcomm.c.html#LN317"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN26"><span class='Ref_to_Proto'>pg_getaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>hostName</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN324"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN317"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>|| !</span><a href="pqcomm.c.html#LN324"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>hostName</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not translate host name \"%s\", service \"%s\" to address: %s"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>hostName</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a><span class='Delimiter'>, </span><a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN317"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not translate service \"%s\" to address: %s"</span><span class='Delimiter'>, 
</span>                         <a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a><span class='Delimiter'>, </span><a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN317"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN324"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN324"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN324"><span class='Ref_To_Local'>addrs</span></a><span class='Delimiter'>; </span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Delimiter'>; </span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN106"><span class='Ref_to_Member'>ai_next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>family</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Only set up a unix domain socket when they really asked for it. 
             * The service/port is different in that case. 
             */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* See if there is still room to add 1 more socket. */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="pqcomm.c.html#LN327"><span class='Ref_To_Local'>listen_index</span></a> <span class='Operator'>&LT; </span><a href="pqcomm.c.html#LN312"><span class='Ref_to_Parameter'>MaxListen</span></a><span class='Delimiter'>; </span><a href="pqcomm.c.html#LN327"><span class='Ref_To_Local'>listen_index</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN312"><span class='Ref_to_Parameter'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN327"><span class='Ref_To_Local'>listen_index</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN327"><span class='Ref_To_Local'>listen_index</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN312"><span class='Ref_to_Parameter'>MaxListen</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not bind to all requested addresses: MAXLISTEN (%d) exceeded"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN312"><span class='Ref_to_Parameter'>MaxListen</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* set up address family name for log messages */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> AF_INET<span class='Operator'>: 
</span>                <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a> <span class='Operator'>= </span>_<span class='Parentheses'>(</span><span class='String'>"IPv4"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_IPV6 
            <span class='Control'>case</span> AF_INET6<span class='Operator'>: 
</span>                <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a> <span class='Operator'>= </span>_<span class='Parentheses'>(</span><span class='String'>"IPv6"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
            <span class='Control'>case</span> AF_UNIX<span class='Operator'>: 
</span>                <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a> <span class='Operator'>= </span>_<span class='Parentheses'>(</span><span class='String'>"Unix"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN320"><span class='Ref_To_Local'>familyDescBuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN320"><span class='Ref_To_Local'>familyDescBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         _<span class='Parentheses'>(</span><span class='String'>"unrecognized address family %d"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN320"><span class='Ref_To_Local'>familyDescBuf</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch addr-&GT;ai_family &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* set up text form of address for log messages */ 
</span><span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>== </span>AF_UNIX<span class='Parentheses'>) 
</span>            <a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN331"><span class='Ref_To_Local'>unixSocketPath</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>((</span><span class='Keyword'>const </span><span class='Control'>struct</span> <a href="../../include/libpq/pqcomm.h.html#LN43"><span class='Ref_to_Struct'>sockaddr_storage</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a><span class='Delimiter'>, 
</span>                               <a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a><span class='Delimiter'>, 
</span>                               <a href="pqcomm.c.html#LN322"><span class='Ref_To_Local'>addrBuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN322"><span class='Ref_To_Local'>addrBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN322"><span class='Ref_To_Local'>addrBuf</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN368"><span class='Ref_to_Macro'>socket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span>SOCK_STREAM<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* translator: first %s is IPv4, IPv6, or Unix */ 
</span>                  <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create %s socket for address \"%s\": %m"</span><span class='Delimiter'>, 
</span>                         <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
        <span class='Comment_Multi_Line'>/* 
         * Without the SO_REUSEADDR flag, a new postmaster can't be started 
         * right away after a stop or crash, giving "address already in use" 
         * error on TCP ports. 
         * 
         * On win32, however, this behavior only happens if the 
         * SO_EXLUSIVEADDRUSE is set. With SO_REUSEADDR, win32 allows multiple 
         * servers to listen on the same address, resulting in unpredictable 
         * behavior. With no flags at all, win32 behaves as Unix with 
         * SO_REUSEADDR. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span>SOL_SOCKET<span class='Delimiter'>, </span>SO_REUSEADDR<span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN334"><span class='Ref_To_Local'>one</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN334"><span class='Ref_To_Local'>one</span></a><span class='Parentheses'>)))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                <span class='Comment_Multi_Line'>/* translator: first %s is IPv4, IPv6, or Unix */ 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"setsockopt(SO_REUSEADDR) failed for %s address \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> IPV6_V6ONLY 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>== </span>AF_INET6<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span>IPPROTO_IPV6<span class='Delimiter'>, </span>IPV6_V6ONLY<span class='Delimiter'>, 
</span>                           <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN334"><span class='Ref_To_Local'>one</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN334"><span class='Ref_To_Local'>one</span></a><span class='Parentheses'>))</span> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                <span class='Comment_Multi_Line'>/* translator: first %s is IPv4, IPv6, or Unix */ 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"setsockopt(IPV6_V6ONLY) failed for %s address \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Note: This might fail on some OS's, like Linux older than 
         * 2.4.21-pre3, that don't have the IPV6_V6ONLY socket option, and map 
         * ipv4 addresses to ipv6.  It will show ::ffff:ipv4 for all ipv4 
         * connections. 
         */ 
</span>        <a href="pqcomm.c.html#LN315"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN369"><span class='Ref_to_Macro'>bind</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN315"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* translator: first %s is IPv4, IPv6, or Unix */ 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not bind %s address \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Parentheses'>))</span> <span class='Operator'>? 
</span>                  <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Is another postmaster already running on port %d?"</span> 
                          <span class='String'>" If not, remove socket file \"%s\" and retry."</span><span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>portNumber</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a><span class='Parentheses'>)</span> <span class='Operator'>: 
</span>                  <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Is another postmaster already running on port %d?"</span> 
                          <span class='String'>" If not, wait a few seconds and retry."</span><span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>portNumber</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>== </span>AF_UNIX<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN150"><span class='Ref_to_Proto'>Setup_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN323"><span class='Ref_To_Local'>service</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Select appropriate accept-queue length limit.  PG_SOMAXCONN is only 
         * intended to provide a clamp on the request on platforms where an 
         * overly large request provokes a kernel error (are there any?). 
         */ 
</span>        <a href="pqcomm.c.html#LN316"><span class='Ref_To_Local'>maxconn</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN316"><span class='Ref_To_Local'>maxconn</span></a> <span class='Operator'>&GT; </span><a href="../../include/pg_config_manual.h.html#LN99"><span class='Ref_to_Const'>PG_SOMAXCONN</span></a><span class='Parentheses'>) 
</span>            <a href="pqcomm.c.html#LN316"><span class='Ref_To_Local'>maxconn</span></a> <span class='Operator'>= </span><a href="../../include/pg_config_manual.h.html#LN99"><span class='Ref_to_Const'>PG_SOMAXCONN</span></a><span class='Delimiter'>; 
</span> 
        <a href="pqcomm.c.html#LN315"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN370"><span class='Ref_to_Macro'>listen</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN316"><span class='Ref_To_Local'>maxconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN315"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* translator: first %s is IPv4, IPv6, or Unix */ 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not listen on %s address \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN325"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>== </span>AF_UNIX<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"listening on Unix socket \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* translator: first %s is IPv4 or IPv6 */ 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"listening on %s address \"%s\", port %d"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN319"><span class='Ref_To_Local'>familyDesc</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN321"><span class='Ref_To_Local'>addrDesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pqcomm.c.html#LN310"><span class='Ref_to_Parameter'>portNumber</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="pqcomm.c.html#LN312"><span class='Ref_to_Parameter'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN327"><span class='Ref_To_Local'>listen_index</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pqcomm.c.html#LN314"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN328"><span class='Ref_To_Local'>added</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for addr=addrs;addr;addr=... &raquo; </span> 
 
    <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN326"><span class='Ref_To_Local'>hint</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN324"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pqcomm.c.html#LN328"><span class='Ref_To_Local'>added</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StreamServerPort &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
 
<span class='Comment_Multi_Line'>/* 
 * Lock_AF_UNIX -- configure unix socket file path 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN594"></a><span class='Declare_Function'>Lock_AF_UNIX</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>unixSocketDir</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>unixSocketPath</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Grab an interlock file associated with the socket file. 
     * 
     * Note: there are two reasons for using a socket lock file, rather than 
     * trying to interlock directly on the socket itself.  First, it's a lot 
     * more portable, and second, it lets us remove any pre-existing socket 
     * file without race conditions. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN459"><span class='Ref_to_Proto'>CreateSocketLockFile</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN594"><span class='Ref_to_Parameter'>unixSocketPath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN594"><span class='Ref_to_Parameter'>unixSocketDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Once we have the interlock, we can safely delete any pre-existing 
     * socket file to avoid failure at bind() time. 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN594"><span class='Ref_to_Parameter'>unixSocketPath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remember socket file pathnames for later maintenance. 
     */ 
</span>    <a href="pqcomm.c.html#LN105"><span class='Ref_to_Global_Var'>sock_paths</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN105"><span class='Ref_to_Global_Var'>sock_paths</span></a><span class='Delimiter'>, </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN594"><span class='Ref_to_Parameter'>unixSocketPath</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end Lock_AF_UNIX &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Setup_AF_UNIX -- configure unix socket permissions 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN625"></a><span class='Declare_Function'>Setup_AF_UNIX</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sock_path</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Fix socket ownership/permission if requested.  Note we must do this 
     * before we listen() to avoid a window where unwanted connections could 
     * get accepted. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN102"><span class='Ref_to_Global_Var'>Unix_socket_group</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN102"><span class='Ref_to_Global_Var'>Unix_socket_group</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"configuration item unix_socket_group is not supported on this platform"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN638"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>endptr</span><span class='Delimiter'>; 
</span><a name="LN639"></a>        <span class='Keyword'>unsigned long </span><span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN640"></a>        <a href="../../include/port/win32.h.html#LN250"><span class='Ref_to_Typedef'>gid_t</span></a>       <span class='Declare_Local'>gid</span><span class='Delimiter'>; 
</span> 
        <a href="pqcomm.c.html#LN639"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span>strtoul<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN102"><span class='Ref_to_Global_Var'>Unix_socket_group</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN638"><span class='Ref_To_Local'>endptr</span></a><span class='Delimiter'>, </span><span class='Number'>10</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pqcomm.c.html#LN638"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{</span>                       <span class='Comment_Single_Line'>/* numeric group id */ 
</span>            <a href="pqcomm.c.html#LN640"><span class='Ref_To_Local'>gid</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN639"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{</span>                       <span class='Comment_Single_Line'>/* convert group name to id */ 
</span><a name="LN649"></a>            <span class='Control'>struct</span> group <span class='Operator'>*</span><span class='Declare_Local'>gr</span><span class='Delimiter'>; 
</span> 
            <a href="pqcomm.c.html#LN649"><span class='Ref_To_Local'>gr</span></a> <span class='Operator'>= </span>getgrnam<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN102"><span class='Ref_to_Global_Var'>Unix_socket_group</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pqcomm.c.html#LN649"><span class='Ref_To_Local'>gr</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"group \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                                <a href="pqcomm.c.html#LN102"><span class='Ref_to_Global_Var'>Unix_socket_group</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="pqcomm.c.html#LN640"><span class='Ref_To_Local'>gid</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN649"><span class='Ref_To_Local'>gr</span></a><span class='Operator'>-&GT;</span>gr_gid<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>chown<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN625"><span class='Ref_to_Parameter'>sock_path</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN640"><span class='Ref_To_Local'>gid</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set group of file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="pqcomm.c.html#LN625"><span class='Ref_to_Parameter'>sock_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if Unix_socket_group[0]!... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>chmod<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN625"><span class='Ref_to_Parameter'>sock_path</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN101"><span class='Ref_to_Global_Var'>Unix_socket_permissions</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set permissions of file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="pqcomm.c.html#LN625"><span class='Ref_to_Parameter'>sock_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end Setup_AF_UNIX &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UNIX_SOCKETS */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * StreamConnection -- create a new connection with client using 
 *      server port.  Set port-&GT;sock to the FD of the new connection. 
 * 
 * ASSUME: that this doesn't need to be non-blocking because 
 *      the Postmaster uses select() to tell when the server master 
 *      socket is ready for accept(). 
 * 
 * RETURNS: STATUS_OK or STATUS_ERROR 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN696"></a><span class='Declare_Function'>StreamConnection</span><span class='Parentheses'>(</span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>server_fd</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* accept connection and fill in the client (remote) address */ 
</span>    <a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN371"><span class='Ref_to_Macro'>accept</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>server_fd</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not accept new connection: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If accept() fails then postmaster.c will still see the server 
         * socket as read-ready, and will immediately try again.  To avoid 
         * uselessly sucking lots of CPU, delay a bit before trying again. 
         * (The most likely reason for failure is being out of kernel file 
         * table slots; we can do little except hope some will get freed up.) 
         */ 
</span>        <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>100000L</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* wait 0.1 sec */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* fill in the server (local) address */ 
</span>    <a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockname<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, 
</span>                    <span class='Operator'>&</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockname() failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* select NODELAY and KEEPALIVE options if it's a TCP connection */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN732"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>on</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN734"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>oldopt</span><span class='Delimiter'>; 
</span><a name="LN735"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>optlen</span><span class='Delimiter'>; 
</span><a name="LN736"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>newopt</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span>  TCP_NODELAY 
        <a href="pqcomm.c.html#LN732"><span class='Ref_To_Local'>on</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_NODELAY<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN732"><span class='Ref_To_Local'>on</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN732"><span class='Ref_To_Local'>on</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_NODELAY) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
        <a href="pqcomm.c.html#LN732"><span class='Ref_To_Local'>on</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>SOL_SOCKET<span class='Delimiter'>, </span>SO_KEEPALIVE<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN732"><span class='Ref_To_Local'>on</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN732"><span class='Ref_To_Local'>on</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(SO_KEEPALIVE) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
        <span class='Comment_Multi_Line'>/* 
         * This is a Win32 socket optimization.  The OS send buffer should be 
         * large enough to send the whole Postgres send buffer in one go, or 
         * performance suffers.  The Postgres send buffer can be enlarged if a 
         * very large message needs to be sent, but we won't attempt to 
         * enlarge the OS buffer if that happens, so somewhat arbitrarily 
         * ensure that the OS buffer is at least PQ_SEND_BUFFER_SIZE * 4. 
         * (That's 32kB with the current default). 
         * 
         * The default OS buffer size used to be 8kB in earlier Windows 
         * versions, but was raised to 64kB in Windows 2012.  So it shouldn't 
         * be necessary to change it in later versions anymore.  Changing it 
         * unnecessarily can even reduce performance, because setting 
         * SO_SNDBUF in the application disables the "dynamic send buffering" 
         * feature that was introduced in Windows 7.  So before fiddling with 
         * SO_SNDBUF, check if the current buffer size is already large enough 
         * and only increase it if necessary. 
         * 
         * See https://support.microsoft.com/kb/823764/EN-US/ and 
         * https://msdn.microsoft.com/en-us/library/bb736549%28v=vs.85%29.aspx 
         */ 
</span>        <a href="pqcomm.c.html#LN735"><span class='Ref_To_Local'>optlen</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN734"><span class='Ref_To_Local'>oldopt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>SOL_SOCKET<span class='Delimiter'>, </span>SO_SNDBUF<span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN734"><span class='Ref_To_Local'>oldopt</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pqcomm.c.html#LN735"><span class='Ref_To_Local'>optlen</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockopt(SO_SNDBUF) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pqcomm.c.html#LN736"><span class='Ref_To_Local'>newopt</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN114"><span class='Ref_to_Const'>PQ_SEND_BUFFER_SIZE</span></a> <span class='Operator'>* </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN734"><span class='Ref_To_Local'>oldopt</span></a> <span class='Operator'>&LT; </span><a href="pqcomm.c.html#LN736"><span class='Ref_To_Local'>newopt</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>SOL_SOCKET<span class='Delimiter'>, </span>SO_SNDBUF<span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN736"><span class='Ref_To_Local'>newopt</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN736"><span class='Ref_To_Local'>newopt</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(SO_SNDBUF) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Also apply the current keepalive parameters.  If we fail to set a 
         * parameter, don't error out, because these aren't universally 
         * supported.  (Note: you might think we need to reset the GUC 
         * variables to 0 in such a case, but it's not necessary because the 
         * show hooks for these variables report the truth anyway.) 
         */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/libpq/libpq-be.h.html#LN221"><span class='Ref_to_Proto'>pq_setkeepalivesidle</span></a><span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN470"><span class='Ref_to_Global_Var'>tcp_keepalives_idle</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/libpq/libpq-be.h.html#LN222"><span class='Ref_to_Proto'>pq_setkeepalivesinterval</span></a><span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN471"><span class='Ref_to_Global_Var'>tcp_keepalives_interval</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/libpq/libpq-be.h.html#LN223"><span class='Ref_to_Proto'>pq_setkeepalivescount</span></a><span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN472"><span class='Ref_to_Global_Var'>tcp_keepalives_count</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN696"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !IS_AF_UNIX(port-&GT;lad... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StreamConnection &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * StreamClose -- close a client/backend connection 
 * 
 * NOTE: this is NOT used to terminate a session; it is just used to release 
 * the file descriptor in a process that should no longer have the socket 
 * open.  (For example, the postmaster calls this after passing ownership 
 * of the connection to a child process.)  It is expected that someone else 
 * still has the socket open.  So, we only want to close the descriptor, 
 * we do NOT want to send anything to the far end. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN824"></a><span class='Declare_Function'>StreamClose</span><span class='Parentheses'>(</span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>sock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN824"><span class='Ref_to_Parameter'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * TouchSocketFiles -- mark socket files as recently accessed 
 * 
 * This routine should be called every so often to ensure that the socket 
 * files have a recent mod date (ordinary operations on sockets usually won't 
 * change the mod date).  That saves them from being removed by 
 * overenthusiastic /tmp-directory-cleaner daemons.  (Another reason we should 
 * never have put the socket file in /tmp...) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN839"></a><span class='Declare_Function'>TouchSocketFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN841"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Loop through all created sockets... */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN841"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN105"><span class='Ref_to_Global_Var'>sock_paths</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN846"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sock_path</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN841"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * utime() is POSIX standard, utimes() is a common alternative. If we 
         * have neither, there's no way to affect the mod or access time of 
         * the socket :-( 
         * 
         * In either path, we ignore errors; there's no point in complaining. 
         */ 
</span><span class='Directive'>#ifdef</span> HAVE_UTIME 
        utime<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN846"><span class='Ref_To_Local'>sock_path</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_UTIME */ 
</span><span class='Directive'>#ifdef</span> HAVE_UTIMES 
        utimes<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN846"><span class='Ref_To_Local'>sock_path</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UTIMES */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UTIME */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end TouchSocketFiles &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RemoveSocketFiles -- unlink socket files at postmaster shutdown 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN869"></a><span class='Declare_Function'>RemoveSocketFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN871"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Loop through all created sockets... */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN871"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN105"><span class='Ref_to_Global_Var'>sock_paths</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN876"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sock_path</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN871"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore any error. */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN876"><span class='Ref_To_Local'>sock_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* Since we're about to exit, no need to reclaim storage */ 
</span>    <a href="pqcomm.c.html#LN105"><span class='Ref_to_Global_Var'>sock_paths</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 * Low-level I/O routines begin here. 
 * 
 * These routines communicate with a frontend client across a connection 
 * already established by the preceding routines. 
 * -------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *            socket_set_nonblocking - set socket blocking/non-blocking 
 * 
 * Sets the socket non-blocking if nonblocking is TRUE, or sets it 
 * blocking otherwise. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN902"></a><span class='Declare_Function'>socket_set_nonblocking</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nonblocking</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONNECTION_DOES_NOT_EXIST<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"there is no client connection"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN118"><span class='Ref_to_Member'>noblock</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN902"><span class='Ref_to_Parameter'>nonblocking</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_recvbuf - load some bytes into the input buffer 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN919"></a><span class='Declare_Function'>pq_recvbuf</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>&GT; </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* still some unread data, left-justify it in the buffer */ 
</span>            <a href="../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>, 
</span>                    <a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>-= </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Ensure that we're in blocking mode */ 
</span>    <a href="pqcomm.c.html#LN137"><span class='Ref_to_Proto'>socket_set_nonblocking</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can fill buffer from PqRecvLength and upwards */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN941"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <a href="pqcomm.c.html#LN941"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN87"><span class='Ref_to_Proto'>secure_read</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Delimiter'>, 
</span>                        <a href="pqcomm.c.html#LN115"><span class='Ref_to_Const'>PQ_RECV_BUFFER_SIZE</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN941"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Ok if interrupted */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Careful: an ereport() that tries to write to the client would 
             * cause recursion to here, leading to stack overflow and core 
             * dump!  This message must go *only* to the postmaster log. 
             */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive data from client: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN941"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * EOF detected.  We used to write a log message here, but it's 
             * better to expect the ultimate caller to do that. 
             */ 
</span>            <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* r contains number of bytes read, so just incr length */ 
</span>        <a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN941"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pq_recvbuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_getbyte  - get a single byte from connection, or return EOF 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN980"></a><span class='Declare_Function'>pq_getbyte</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN918"><span class='Ref_to_Func'>pq_recvbuf</span></a><span class='Parentheses'>())</span>       <span class='Comment_Single_Line'>/* If nothing in buffer, then recv some */ 
</span>            <span class='Control'>return</span> EOF<span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* Failed to recv data */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_peekbyte     - peek at next byte from connection 
 * 
 *   Same as pq_getbyte() except we don't advance the pointer. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN999"></a><span class='Declare_Function'>pq_peekbyte</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN918"><span class='Ref_to_Func'>pq_recvbuf</span></a><span class='Parentheses'>())</span>       <span class='Comment_Single_Line'>/* If nothing in buffer, then recv some */ 
</span>            <span class='Control'>return</span> EOF<span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* Failed to recv data */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_getbyte_if_available - get a single byte from connection, 
 *          if available 
 * 
 * The received byte is stored in *c. Returns 1 if a byte was read, 
 * 0 if no data was available, or EOF if trouble. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1020"></a><span class='Declare_Function'>pq_getbyte_if_available</span><span class='Parentheses'>(</span><span class='Keyword'>unsigned char </span><span class='Operator'>*</span><span class='Declare_Parameter'>c</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1022"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&LT; </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="pqcomm.c.html#LN1020"><span class='Ref_to_Parameter'>c</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Put the socket into non-blocking mode */ 
</span>    <a href="pqcomm.c.html#LN137"><span class='Ref_to_Proto'>socket_set_nonblocking</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN87"><span class='Ref_to_Proto'>secure_read</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1020"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Ok if no data available without blocking or interrupted (though 
         * EINTR really shouldn't happen with a non-blocking socket). Report 
         * other errors. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Careful: an ereport() that tries to write to the client would 
             * cause recursion to here, leading to stack overflow and core 
             * dump!  This message must go *only* to the postmaster log. 
             */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive data from client: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>EOF<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r&LT;0 &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* EOF detected */ 
</span>        <a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>EOF<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1022"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_getbyte_if_available &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_getbytes     - get a known number of bytes from connection 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1074"></a><span class='Declare_Function'>pq_getbytes</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1076"></a>    size_t      <span class='Declare_Local'>amount</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1074"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN918"><span class='Ref_to_Func'>pq_recvbuf</span></a><span class='Parentheses'>())</span>   <span class='Comment_Single_Line'>/* If nothing in buffer, then recv some */ 
</span>                <span class='Control'>return</span> EOF<span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Failed to recv data */ 
</span>        <span class='Delimiter'>} 
</span>        <a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>&GT; </span><a href="pqcomm.c.html#LN1074"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) 
</span>            <a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1074"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1074"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN1074"><span class='Ref_to_Parameter'>s</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN1074"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>-= </span><a href="pqcomm.c.html#LN1076"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_getbytes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_discardbytes     - throw away a known number of bytes 
 * 
 *      same as pq_getbytes except we do not copy the data to anyplace. 
 *      this is used for resynchronizing after read errors. 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1108"></a><span class='Declare_Function'>pq_discardbytes</span><span class='Parentheses'>(</span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1110"></a>    size_t      <span class='Declare_Local'>amount</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1108"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN918"><span class='Ref_to_Func'>pq_recvbuf</span></a><span class='Parentheses'>())</span>   <span class='Comment_Single_Line'>/* If nothing in buffer, then recv some */ 
</span>                <span class='Control'>return</span> EOF<span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Failed to recv data */ 
</span>        <span class='Delimiter'>} 
</span>        <a href="pqcomm.c.html#LN1110"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1110"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>&GT; </span><a href="pqcomm.c.html#LN1108"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) 
</span>            <a href="pqcomm.c.html#LN1110"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1108"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1110"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN1108"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>-= </span><a href="pqcomm.c.html#LN1110"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_discardbytes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_getstring    - get a null terminated string from connection 
 * 
 *      The return value is placed in an expansible StringInfo, which has 
 *      already been initialized by the caller. 
 * 
 *      This is used only for dealing with old-protocol clients.  The idea 
 *      is to produce a StringInfo that looks the same as we would get from 
 *      pq_getmessage() with a newer client; we will then process it with 
 *      pq_getmsgstring.  Therefore, no character set conversion is done here, 
 *      even though this is presumably useful only for text. 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1146"></a><span class='Declare_Function'>pq_getstring</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1148"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1146"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read until we get the terminating '\0' */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN918"><span class='Ref_to_Func'>pq_recvbuf</span></a><span class='Parentheses'>())</span>   <span class='Comment_Single_Line'>/* If nothing in buffer, then recv some */ 
</span>                <span class='Control'>return</span> EOF<span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Failed to recv data */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1148"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>; </span><a href="pqcomm.c.html#LN1148"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Delimiter'>; </span><a href="pqcomm.c.html#LN1148"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN1148"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* include the '\0' in the copy */ 
</span>                <a href="../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1146"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>, 
</span>                                       <a href="pqcomm.c.html#LN1148"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1148"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* advance past \0 */ 
</span>                <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If we're here we haven't got the \0 in the buffer yet. */ 
</span>        <a href="../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1146"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN122"><span class='Ref_to_Global_Var'>PqRecvBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Delimiter'>, 
</span>                               <a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN123"><span class='Ref_to_Global_Var'>PqRecvPointer</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN124"><span class='Ref_to_Global_Var'>PqRecvLength</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pq_getstring &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_startmsgread - begin reading a message from the client. 
 * 
 *      This must be called before any of the pq_get* functions. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1190"></a><span class='Declare_Function'>pq_startmsgread</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * There shouldn't be a read active already, but let's check just to be 
     * sure. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"terminating connection because protocol synchronization was lost"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_endmsgread   - finish reading message. 
 * 
 *      This must be called after reading a V2 protocol message with 
 *      pq_getstring() and friends, to indicate that we have read the whole 
 *      message. In V3 protocol, pq_getmessage() does this implicitly. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1214"></a><span class='Declare_Function'>pq_endmsgread</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_is_reading_msg - are we currently reading a message? 
 * 
 * This is used in error recovery at the outer idle loop to detect if we have 
 * lost protocol sync, and need to terminate the connection. pq_startmsgread() 
 * will check for that too, but it's nicer to detect it earlier. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1230"></a><span class='Declare_Function'>pq_is_reading_msg</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_getmessage   - get a message with length word from connection 
 * 
 *      The return value is placed in an expansible StringInfo, which has 
 *      already been initialized by the caller. 
 *      Only the message body is placed in the StringInfo; the length word 
 *      is removed.  Also, s-&GT;cursor is initialized to zero for convenience 
 *      in scanning the message contents. 
 * 
 *      If maxlen is not zero, it is an upper limit on the length of the 
 *      message we are willing to accept.  We abort the connection (by 
 *      returning EOF) if client tries to send more than that. 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1252"></a><span class='Declare_Function'>pq_getmessage</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxlen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1254"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read message length word */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN63"><span class='Ref_to_Proto'>pq_getbytes</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>== </span>EOF<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected EOF within message length word"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>ntohl<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>4</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>maxlen</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>maxlen</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid message length"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>-= </span><span class='Number'>4</span><span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* discount length itself */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Allocate space for message.  If we run out of room (ridiculously 
         * large message), we will elog(ERROR), but we want to discard the 
         * message body so as not to lose communication sync. 
         */ 
</span>        <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/lib/stringinfo.h.html#LN149"><span class='Ref_to_Proto'>enlargeStringInfo</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1107"><span class='Ref_to_Func'>pq_discardbytes</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>EOF<span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incomplete message from client"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* we discarded the rest of the message so we're back in sync. */ 
</span>            <a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And grab the message */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN63"><span class='Ref_to_Proto'>pq_getbytes</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>EOF<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incomplete message from client"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Place a trailing null per StringInfo convention */ 
</span>        <a href="pqcomm.c.html#LN1252"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>[</span><a href="pqcomm.c.html#LN1254"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if len&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* finished reading the message. */ 
</span>    <a href="pqcomm.c.html#LN130"><span class='Ref_to_Global_Var'>PqCommReadingMsg</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_getmessage &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_putbytes     - send bytes to connection (not flushed until pq_flush) 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1333"></a><span class='Declare_Function'>pq_putbytes</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1335"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Should only be called by old-style COPY OUT */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN131"><span class='Ref_to_Global_Var'>DoingCopyOut</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* No-op if reentrant call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN1335"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN145"><span class='Ref_to_Proto'>internal_putbytes</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1333"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1333"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1335"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static int 
</span><a name="LN1349"></a><span class='Declare_Function'>internal_putbytes</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1351"></a>    size_t      <span class='Declare_Local'>amount</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1349"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If buffer is full, then flush it out */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>&GT;= </span><a href="pqcomm.c.html#LN118"><span class='Ref_to_Global_Var'>PqSendBufferSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pqcomm.c.html#LN137"><span class='Ref_to_Proto'>socket_set_nonblocking</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN146"><span class='Ref_to_Proto'>internal_flush</span></a><span class='Parentheses'>())</span> 
                <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN118"><span class='Ref_to_Global_Var'>PqSendBufferSize</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>&GT; </span><a href="pqcomm.c.html#LN1349"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) 
</span>            <a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1349"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN117"><span class='Ref_to_Global_Var'>PqSendBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1349"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN1349"><span class='Ref_to_Parameter'>s</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN1349"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>-= </span><a href="pqcomm.c.html#LN1351"><span class='Ref_To_Local'>amount</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end internal_putbytes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      socket_flush        - flush pending output 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1380"></a><span class='Declare_Function'>socket_flush</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1382"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No-op if reentrant call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN137"><span class='Ref_to_Proto'>socket_set_nonblocking</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN1382"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN146"><span class='Ref_to_Proto'>internal_flush</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1382"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      internal_flush - flush pending output 
 * 
 * Returns 0 if OK (meaning everything was sent, or operation would block 
 * and the socket is in non-blocking mode), or EOF if trouble. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1402"></a><span class='Declare_Function'>internal_flush</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1404"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>last_reported_send_errno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN1406"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bufptr</span> <span class='Operator'>= </span><a href="pqcomm.c.html#LN117"><span class='Ref_to_Global_Var'>PqSendBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a><span class='Delimiter'>; 
</span><a name="LN1407"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bufend</span> <span class='Operator'>= </span><a href="pqcomm.c.html#LN117"><span class='Ref_to_Global_Var'>PqSendBuffer</span></a> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1406"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>&LT; </span><a href="pqcomm.c.html#LN1407"><span class='Ref_To_Local'>bufend</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1411"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <a href="pqcomm.c.html#LN1411"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN88"><span class='Ref_to_Proto'>secure_write</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1406"><span class='Ref_To_Local'>bufptr</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1407"><span class='Ref_To_Local'>bufend</span></a> <span class='Operator'>- </span><a href="pqcomm.c.html#LN1406"><span class='Ref_To_Local'>bufptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1411"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Ok if we were interrupted */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Ok if no data writable without blocking, and the socket is in 
             * non-blocking mode. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| 
</span>                errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Careful: an ereport() that tries to write to the client would 
             * cause recursion to here, leading to stack overflow and core 
             * dump!  This message must go *only* to the postmaster log. 
             * 
             * If a client disconnects while we're in the midst of output, we 
             * might write quite a bit of data before we get to a safe query 
             * abort point.  So, suppress duplicate log messages. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span><a href="pqcomm.c.html#LN1404"><span class='Ref_To_Local'>last_reported_send_errno</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pqcomm.c.html#LN1404"><span class='Ref_To_Local'>last_reported_send_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not send data to client: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We drop the buffered data anyway so that processing can 
             * continue, even though we'll probably quit soon. We also set a 
             * flag that'll cause the next CHECK_FOR_INTERRUPTS to terminate 
             * the connection. 
             */ 
</span>            <a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../utils/init/globals.c.html#LN31"><span class='Ref_to_Global_Var'>ClientConnectionLost</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="../utils/init/globals.c.html#LN28"><span class='Ref_to_Global_Var'>InterruptPending</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> EOF<span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r&LT;=0 &raquo; </span> 
 
        <a href="pqcomm.c.html#LN1404"><span class='Ref_To_Local'>last_reported_send_errno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* reset after any successful send */ 
</span>        <a href="pqcomm.c.html#LN1406"><span class='Ref_To_Local'>bufptr</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1411"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a> <span class='Operator'>+= </span><a href="pqcomm.c.html#LN1411"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while bufptr&LT;bufend &raquo; </span> 
 
    <a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end internal_flush &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_flush_if_writable - flush pending output if writable without blocking 
 * 
 * Returns 0 if OK, or EOF if trouble. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1475"></a><span class='Declare_Function'>socket_flush_if_writable</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1477"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Quick exit if nothing to do */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>== </span><a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No-op if reentrant call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Temporarily put the socket into non-blocking mode */ 
</span>    <a href="pqcomm.c.html#LN137"><span class='Ref_to_Proto'>socket_set_nonblocking</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN1477"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN146"><span class='Ref_to_Proto'>internal_flush</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1477"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end socket_flush_if_writable &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *  socket_is_send_pending  - is there any pending data in the output buffer? 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1501"></a><span class='Declare_Function'>socket_is_send_pending</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN120"><span class='Ref_to_Global_Var'>PqSendStart</span></a> <span class='Operator'>&LT; </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 * Message-level I/O routines begin here. 
 * 
 * These routines understand about the old-style COPY OUT protocol. 
 * -------------------------------- 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      socket_putmessage - send a normal message (suppressed in COPY OUT mode) 
 * 
 *      If msgtype is not '\0', it is a message type code to place before 
 *      the message body.  If msgtype is '\0', then the message has no type 
 *      code (this is only valid in pre-3.0 protocols). 
 * 
 *      len is the length of the message body data at *s.  In protocol 3.0 
 *      and later, a message length word (equal to len+4 because it counts 
 *      itself too) is inserted by this routine. 
 * 
 *      All normal messages are suppressed while old-style COPY OUT is in 
 *      progress.  (In practice only a few notice messages might get emitted 
 *      then; dropping them is annoying, but at least they will still appear 
 *      in the postmaster log.) 
 * 
 *      We also suppress messages generated while pqcomm.c is busy.  This 
 *      avoids any possibility of messages being inserted within other 
 *      messages.  The only known trouble case arises if SIGQUIT occurs 
 *      during a pqcomm.c routine --- quickdie() will try to send a warning 
 *      message, and the most reasonable approach seems to be to drop it. 
 * 
 *      returns 0 if OK, EOF if trouble 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1540"></a><span class='Declare_Function'>socket_putmessage</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Declare_Parameter'>msgtype</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN131"><span class='Ref_to_Global_Var'>DoingCopyOut</span></a> <span class='Operator'>|| </span><a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1540"><span class='Ref_to_Parameter'>msgtype</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN145"><span class='Ref_to_Proto'>internal_putbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1540"><span class='Ref_to_Parameter'>msgtype</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pqcomm.c.html#LN1561"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN26"><span class='Ref_to_Global_Var'>FrontendProtocol</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1550"></a>        <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>n32</span><span class='Delimiter'>; 
</span> 
        <a href="pqcomm.c.html#LN1550"><span class='Ref_To_Local'>n32</span></a> <span class='Operator'>= </span>htonl<span class='Parentheses'>((</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pqcomm.c.html#LN1540"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>+ </span><span class='Number'>4</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN145"><span class='Ref_to_Proto'>internal_putbytes</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1550"><span class='Ref_To_Local'>n32</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>))</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pqcomm.c.html#LN1561"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN145"><span class='Ref_to_Proto'>internal_putbytes</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1540"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1540"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pqcomm.c.html#LN1561"><span class='Ref_to_Label'>fail</span></a><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN1561"></a><span class='Label'>fail</span><span class='Operator'>: 
</span>    <a href="pqcomm.c.html#LN129"><span class='Ref_to_Global_Var'>PqCommBusy</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> EOF<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end socket_putmessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pq_putmessage_noblock   - like pq_putmessage, but never blocks 
 * 
 *      If the output buffer is too small to hold the message, the buffer 
 *      is enlarged. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1573"></a><span class='Declare_Function'>socket_putmessage_noblock</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Declare_Parameter'>msgtype</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1575"></a>    <span class='Keyword'>int </span>res     <span class='Declare_Local'>PG_USED_FOR_ASSERTS_ONLY</span><span class='Delimiter'>; 
</span><a name="LN1576"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>required</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure we have enough space in the output buffer for the message header 
     * as well as the message itself. 
     */ 
</span>    <a href="pqcomm.c.html#LN1576"><span class='Ref_To_Local'>required</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN119"><span class='Ref_to_Global_Var'>PqSendPointer</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><span class='Number'>4</span> <span class='Operator'>+ </span><a href="pqcomm.c.html#LN1573"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1576"><span class='Ref_To_Local'>required</span></a> <span class='Operator'>&GT; </span><a href="pqcomm.c.html#LN118"><span class='Ref_to_Global_Var'>PqSendBufferSize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pqcomm.c.html#LN117"><span class='Ref_to_Global_Var'>PqSendBuffer</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN117"><span class='Ref_to_Global_Var'>PqSendBuffer</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1576"><span class='Ref_To_Local'>required</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pqcomm.c.html#LN118"><span class='Ref_to_Global_Var'>PqSendBufferSize</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1576"><span class='Ref_To_Local'>required</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    res <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1573"><span class='Ref_to_Parameter'>msgtype</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1573"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1573"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span>res <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>           <span class='Comment_Multi_Line'>/* should not fail when the message fits in 
                                 * buffer */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end socket_putmessage_noblock &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      socket_startcopyout - inform libpq that an old-style COPY OUT transfer 
 *          is beginning 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1600"></a><span class='Declare_Function'>socket_startcopyout</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pqcomm.c.html#LN131"><span class='Ref_to_Global_Var'>DoingCopyOut</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      socket_endcopyout   - end an old-style COPY OUT transfer 
 * 
 *      If errorAbort is indicated, we are aborting a COPY OUT due to an error, 
 *      and must send a terminator line.  Since a partial data line might have 
 *      been emitted, send a couple of newlines first (the first one could 
 *      get absorbed by a backslash...)  Note that old-style COPY OUT does 
 *      not allow binary transfers, so a textual terminator is always correct. 
 * -------------------------------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1616"></a><span class='Declare_Function'>socket_endcopyout</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>errorAbort</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pqcomm.c.html#LN131"><span class='Ref_to_Global_Var'>DoingCopyOut</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1616"><span class='Ref_to_Parameter'>errorAbort</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/libpq/libpq.h.html#LN72"><span class='Ref_to_Proto'>pq_putbytes</span></a><span class='Parentheses'>(</span><span class='String'>"\n\n\\.\n"</span><span class='Delimiter'>, </span><span class='Number'>5</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* in non-error case, copy.c will have emitted the terminator line */ 
</span>    <a href="pqcomm.c.html#LN131"><span class='Ref_to_Global_Var'>DoingCopyOut</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Support for TCP Keepalive parameters 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * On Windows, we need to set both idle and interval at the same time. 
 * We also cannot reset them to the default (setting to zero will 
 * actually set them to zero, not default), therefore we fallback to 
 * the out-of-the-box default instead. 
 */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>SIO_KEEPALIVE_VALS<span class='Parentheses'>) 
</span><span class='Keyword'>static int 
</span><a name="LN1638"></a><span class='Declare_Function'>pq_setkeepaliveswin32</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>idle</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>interval</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1640"></a>    <span class='Control'>struct</span> tcp_keepalive <span class='Declare_Local'>ka</span><span class='Delimiter'>; 
</span><a name="LN1641"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>retsize</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>= </span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Number'>60</span> <span class='Operator'>* </span><span class='Number'>60</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* default = 2 hours */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* default = 1 second */ 
</span> 
    <a href="pqcomm.c.html#LN1640"><span class='Ref_To_Local'>ka</span></a><span class='Operator'>.</span>onoff <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN1640"><span class='Ref_To_Local'>ka</span></a><span class='Operator'>.</span>keepalivetime <span class='Operator'>= </span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>    <a href="pqcomm.c.html#LN1640"><span class='Ref_To_Local'>ka</span></a><span class='Operator'>.</span>keepaliveinterval <span class='Operator'>= </span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>WSAIoctl<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, 
</span>                 SIO_KEEPALIVE_VALS<span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span>LPVOID<span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1640"><span class='Ref_To_Local'>ka</span></a><span class='Delimiter'>, 
</span>                 <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1640"><span class='Ref_To_Local'>ka</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                 <span class='Number'>0</span><span class='Delimiter'>, 
</span>                 <span class='Operator'>&</span><a href="pqcomm.c.html#LN1641"><span class='Ref_To_Local'>retsize</span></a><span class='Delimiter'>, 
</span>                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                 <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"WSAIoctl(SIO_KEEPALIVE_VALS) failed: %ui"</span><span class='Delimiter'>, 
</span>             WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a> <span class='Operator'>!= </span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>idle</span></a><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>idle</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a> <span class='Operator'>!= </span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>interval</span></a><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1638"><span class='Ref_to_Parameter'>interval</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_setkeepaliveswin32 &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>int 
</span><a name="LN1676"></a><span class='Declare_Function'>pq_getkeepalivesidle</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>TCP_KEEPIDLE<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span>TCP_KEEPALIVE<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN1688"></a>        ACCEPT_TYPE_ARG3 <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TCP_KEEPIDLE 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPIDLE<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pqcomm.c.html#LN1688"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockopt(TCP_KEEPIDLE) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* don't know */ 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPALIVE<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pqcomm.c.html#LN1688"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockopt(TCP_KEEPALIVE) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* don't know */ 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* TCP_KEEPIDLE */ 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>        <span class='Comment_Multi_Line'>/* We can't get the defaults on Windows, so return "don't know" */ 
</span>        <a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if port-&GT;default_keepali... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1676"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pq_getkeepalivesidle &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1720"></a><span class='Declare_Function'>pq_setkeepalivesidle</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>idle</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>TCP_KEEPIDLE<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span>TCP_KEEPALIVE<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span>SIO_KEEPALIVE_VALS<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>== </span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN217"><span class='Ref_to_Proto'>pq_getkeepalivesidle</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* default is set but unknown */ 
</span>            <span class='Control'>else</span> 
                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN159"><span class='Ref_to_Member'>default_keepalives_idle</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TCP_KEEPIDLE 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPIDLE<span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_KEEPIDLE) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPALIVE<span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_KEEPALIVE) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1637"><span class='Ref_to_Func'>pq_setkeepaliveswin32</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* TCP_KEEPIDLE || SIO_KEEPALIVE_VALS */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1720"><span class='Ref_to_Parameter'>idle</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setting the keepalive idle time is not supported"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_setkeepalivesidle &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1775"></a><span class='Declare_Function'>pq_getkeepalivesinterval</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>TCP_KEEPINTVL<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span>SIO_KEEPALIVE_VALS<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN1787"></a>        ACCEPT_TYPE_ARG3 <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPINTVL<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pqcomm.c.html#LN1787"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockopt(TCP_KEEPINTVL) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* don't know */ 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
        <span class='Comment_Multi_Line'>/* We can't get the defaults on Windows, so return "don't know" */ 
</span>        <a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1775"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pq_getkeepalivesinterval &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1809"></a><span class='Declare_Function'>pq_setkeepalivesinterval</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>interval</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>TCP_KEEPINTVL<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined <span class='Parentheses'>(</span>SIO_KEEPALIVE_VALS<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>== </span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN218"><span class='Ref_to_Proto'>pq_getkeepalivesinterval</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* default is set but unknown */ 
</span>            <span class='Control'>else</span> 
                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN160"><span class='Ref_to_Member'>default_keepalives_interval</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPINTVL<span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_KEEPINTVL) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN163"><span class='Ref_to_Member'>keepalives_interval</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1637"><span class='Ref_to_Func'>pq_setkeepaliveswin32</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN162"><span class='Ref_to_Member'>keepalives_idle</span></a><span class='Delimiter'>, </span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1809"><span class='Ref_to_Parameter'>interval</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_KEEPINTVL) not supported"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_setkeepalivesinterval &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1856"></a><span class='Declare_Function'>pq_getkeepalivescount</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> TCP_KEEPCNT 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN164"><span class='Ref_to_Member'>keepalives_count</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN164"><span class='Ref_to_Member'>keepalives_count</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1867"></a>        ACCEPT_TYPE_ARG3 <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPCNT<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pqcomm.c.html#LN1867"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockopt(TCP_KEEPCNT) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* don't know */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pqcomm.c.html#LN1856"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pq_getkeepalivescount &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1885"></a><span class='Declare_Function'>pq_setkeepalivescount</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>count</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> TCP_KEEPCNT 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a> <span class='Operator'>== </span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN164"><span class='Ref_to_Member'>keepalives_count</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN219"><span class='Ref_to_Proto'>pq_getkeepalivescount</span></a><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* default is set but unknown */ 
</span>            <span class='Control'>else</span> 
                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN161"><span class='Ref_to_Member'>default_keepalives_count</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>IPPROTO_TCP<span class='Delimiter'>, </span>TCP_KEEPCNT<span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_KEEPCNT) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN164"><span class='Ref_to_Member'>keepalives_count</span></a> <span class='Operator'>= </span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pqcomm.c.html#LN1885"><span class='Ref_to_Parameter'>count</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(TCP_KEEPCNT) not supported"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pq_setkeepalivescount &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>