<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\nodes\tidbitmap.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\nodes\tidbitmap.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:41 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * tidbitmap.c 
 *    PostgreSQL tuple-id (TID) bitmap package 
 * 
 * This module provides bitmap data structures that are spiritually 
 * similar to Bitmapsets, but are specially adapted to store sets of 
 * tuple identifiers (TIDs), or ItemPointers.  In particular, the division 
 * of an ItemPointer into BlockNumber and OffsetNumber is catered for. 
 * Also, since we wish to be able to store very large tuple sets in 
 * memory with this data structure, we support "lossy" storage, in which 
 * we no longer remember individual tuple offsets on a page but only the 
 * fact that a particular page needs to be visited. 
 * 
 * The "lossy" storage uses one bit per disk page, so at the standard 8K 
 * BLCKSZ, we can represent all pages in 64Gb of disk space in about 1Mb 
 * of memory.  People pushing around tables of that size should have a 
 * couple of Mb to spare, so we don't worry about providing a second level 
 * of lossiness.  In theory we could fall back to page ranges at some 
 * point, but for now that seems useless complexity. 
 * 
 * We also support the notion of candidate matches, or rechecking.  This 
 * means we know that a search need visit only some tuples on a page, 
 * but we are not certain that all of those tuples are real matches. 
 * So the eventual heap scan must recheck the quals for these tuples only, 
 * rather than rechecking the quals for all tuples on the page as in the 
 * lossy-bitmap case.  Rechecking can be specified when TIDs are inserted 
 * into a bitmap, and it can also happen internally when we AND a lossy 
 * and a non-lossy page. 
 * 
 * 
 * Copyright (c) 2003-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/backend/nodes/tidbitmap.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/bitmapset.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/tidbitmap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lwlock.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dsa.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The maximum number of tuples per page is not large (typically 256 with 
 * 8K pages, or 1024 with 32K pages).  So there's not much point in making 
 * the per-page bitmaps variable size.  We just legislate that the size 
 * is this: 
 */ 
</span><a name="LN54"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_TUPLES_PER_PAGE</span>  <a href="../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * When we have to switch over to lossy storage, we use a data structure 
 * with one bit per page, where all pages having the same number DIV 
 * PAGES_PER_CHUNK are aggregated into one chunk.  When a chunk is present 
 * and has the bit set for a given page, there must not be a per-page entry 
 * for that page in the page table. 
 * 
 * We actually store both exact pages and lossy chunks in the same hash 
 * table, using identical data structures.  (This is because the memory 
 * management for hashtables doesn't easily/efficiently allow space to be 
 * transferred easily from one hashtable to another.)  Therefore it's best 
 * if PAGES_PER_CHUNK is the same as MAX_TUPLES_PER_PAGE, or at least not 
 * too different.  But we also want PAGES_PER_CHUNK to be a power of 2 to 
 * avoid expensive integer remainder operations.  So, define it like this: 
 */ 
</span><a name="LN71"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PAGES_PER_CHUNK</span>  <span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>/ </span><span class='Number'>32</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* We use BITS_PER_BITMAPWORD and typedef bitmapword from nodes/bitmapset.h */ 
</span> 
<a name="LN75"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>WORDNUM</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN75"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a><span class='Parentheses'>)</span> 
<a name="LN76"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>BITNUM</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>)</span>   <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN76"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* number of active words for an exact page: */ 
</span><a name="LN79"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WORDS_PER_PAGE</span>  <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN54"><span class='Ref_to_Const'>MAX_TUPLES_PER_PAGE</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
<span class='Comment_Multi_Line'>/* number of active words for a lossy chunk: */ 
</span><a name="LN81"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WORDS_PER_CHUNK</span>  <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The hashtable entries are represented by this data structure.  For 
 * an exact page, blockno is the page number and bit k of the bitmap 
 * represents tuple offset k+1.  For a lossy chunk, blockno is the first 
 * page in the chunk (this must be a multiple of PAGES_PER_CHUNK) and 
 * bit k represents page blockno+k.  Note that it is not possible to 
 * have exact storage for the first page of a chunk if we are using 
 * lossy storage for any page in the chunk's range, since the same 
 * hashtable entry has to serve both purposes. 
 * 
 * recheck is used only on exact pages --- it indicates that although 
 * only the stated tuples need be checked, the full index qual condition 
 * must be checked for each (ie, these are candidate matches). 
 */ 
</span><a name="LN97"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PagetableEntry</span> 
<span class='Delimiter'>{ 
</span><a name="LN99"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>blockno</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* page number (hashtable key) */ 
</span><a name="LN100"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>status</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* hash entry status */ 
</span><a name="LN101"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>ischunk</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* T = lossy storage, F = exact */ 
</span><a name="LN102"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>recheck</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* should the tuples be rechecked? */ 
</span><a name="LN103"></a>    <a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a>  <span class='Declare_Member'>words</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN79"><span class='Ref_to_Const'>WORDS_PER_PAGE</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN81"><span class='Ref_to_Const'>WORDS_PER_CHUNK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]; 
</span><a name="LN104"></a>} <span class='Declare_Typedef'>PagetableEntry</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Holds array of pagetable entries. 
 */ 
</span><a name="LN109"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PTEntryArray</span> 
<span class='Delimiter'>{ 
</span><a name="LN111"></a>    <a href="../../include/port/atomics/arch-x86.h.html#LN62"><span class='Ref_to_Struct'>pg_atomic_uint32</span></a> <span class='Declare_Member'>refcount</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* no. of iterator attached */ 
</span><a name="LN112"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Declare_Member'>ptentry</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN113"></a>} <span class='Declare_Typedef'>PTEntryArray</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We want to avoid the overhead of creating the hashtable, which is 
 * comparatively large, when not necessary. Particularly when we are using a 
 * bitmap scan on the inside of a nestloop join: a bitmap may well live only 
 * long enough to accumulate one entry in such cases.  We therefore avoid 
 * creating an actual hashtable until we need two pagetable entries.  When 
 * just one pagetable entry is needed, we store it in a fixed field of 
 * TIDBitMap.  (NOTE: we don't get rid of the hashtable if the bitmap later 
 * shrinks down to zero or one page again.  So, status can be TBM_HASH even 
 * when nentries is zero or one.) 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN128"></a>    <span class='Declare_Enum_Const'>TBM_EMPTY</span><span class='Delimiter'>,</span>                  <span class='Comment_Single_Line'>/* no hashtable, nentries == 0 */ 
</span><a name="LN129"></a>    <span class='Declare_Enum_Const'>TBM_ONE_PAGE</span><span class='Delimiter'>,</span>               <span class='Comment_Single_Line'>/* entry1 contains the single entry */ 
</span><a name="LN130"></a>    <span class='Declare_Enum_Const'>TBM_HASH</span>                    <span class='Comment_Single_Line'>/* pagetable is valid, entry1 is not */ 
</span><a name="LN131"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TBMStatus</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Current iterating state of the TBM. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN138"></a>    <span class='Declare_Enum_Const'>TBM_NOT_ITERATING</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* not yet converted to page and chunk array */ 
</span><a name="LN139"></a>    <span class='Declare_Enum_Const'>TBM_ITERATING_PRIVATE</span><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* converted to local page and chunk array */ 
</span><a name="LN140"></a>    <span class='Declare_Enum_Const'>TBM_ITERATING_SHARED</span>        <span class='Comment_Single_Line'>/* converted to shared page and chunk array */ 
</span><a name="LN141"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TBMIteratingState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Here is the representation for a whole TIDBitMap: 
 */ 
</span><a name="LN146"></a><span class='Control'>struct</span> <span class='Declare_Struct'>TIDBitmap</span> 
<span class='Delimiter'>{ 
</span><a name="LN148"></a>    <a href="../../include/nodes/nodes.h.html#LN25"><span class='Ref_to_Enum'>NodeTag</span></a>     <span class='Declare_Member'>type</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* to make it a valid Node */ 
</span><a name="LN149"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>mcxt</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* memory context containing me */ 
</span><a name="LN150"></a>    <a href="tidbitmap.c.html#LN126"><span class='Ref_to_Typedef'>TBMStatus</span></a>   <span class='Declare_Member'>status</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* see codes above */ 
</span><a name="LN151"></a>    <span class='Control'>struct</span> pagetable_hash <span class='Operator'>*</span><span class='Declare_Member'>pagetable</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* hash table of PagetableEntry's */ 
</span><a name="LN152"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nentries</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* number of entries in pagetable */ 
</span><a name="LN153"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>maxentries</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* limit on same to meet maxbytes */ 
</span><a name="LN154"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>npages</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* number of exact entries in pagetable */ 
</span><a name="LN155"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nchunks</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* number of lossy entries in pagetable */ 
</span><a name="LN156"></a>    <a href="tidbitmap.c.html#LN136"><span class='Ref_to_Typedef'>TBMIteratingState</span></a> <span class='Declare_Member'>iterating</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* tbm_begin_iterate called? */ 
</span><a name="LN157"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>lossify_start</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* offset to start lossifying hashtable at */ 
</span><a name="LN158"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Declare_Member'>entry1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* used when status == TBM_ONE_PAGE */ 
</span>    <span class='Comment_Multi_Line'>/* these are valid when iterating is true: */ 
</span><a name="LN160"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>**</span><span class='Declare_Member'>spages</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* sorted exact-page list, or NULL */ 
</span><a name="LN161"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>**</span><span class='Declare_Member'>schunks</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* sorted lossy-chunk list, or NULL */ 
</span><a name="LN162"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>dsapagetable</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* dsa_pointer to the element array */ 
</span><a name="LN163"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>dsapagetableold</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* dsa_pointer to the old element array */ 
</span><a name="LN164"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>ptpages</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* dsa_pointer to the page array */ 
</span><a name="LN165"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>ptchunks</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* dsa_pointer to the chunk array */ 
</span><a name="LN166"></a>    <a href="../utils/mmgr/dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>dsa</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* reference to per-query dsa area */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end TIDBitmap &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * When iterating over a bitmap in sorted order, a TBMIterator is used to 
 * track our progress.  There can be several iterators scanning the same 
 * bitmap concurrently.  Note that the bitmap becomes read-only as soon as 
 * any iterator is created. 
 */ 
</span><a name="LN175"></a><span class='Control'>struct</span> <span class='Declare_Struct'>TBMIterator</span> 
<span class='Delimiter'>{ 
</span><a name="LN177"></a>    <a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>tbm</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* TIDBitmap we're iterating over */ 
</span><a name="LN178"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>spageptr</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* next spages index */ 
</span><a name="LN179"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>schunkptr</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* next schunks index */ 
</span><a name="LN180"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>schunkbit</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* next bit to check in current schunk */ 
</span><a name="LN181"></a>    <a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Declare_Member'>output</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* MUST BE LAST (because variable-size) */ 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Holds the shared members of the iterator so that multiple processes 
 * can jointly iterate. 
 */ 
</span><a name="LN188"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TBMSharedIteratorState</span> 
<span class='Delimiter'>{ 
</span><a name="LN190"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nentries</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* number of entries in pagetable */ 
</span><a name="LN191"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>maxentries</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* limit on same to meet maxbytes */ 
</span><a name="LN192"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>npages</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* number of exact entries in pagetable */ 
</span><a name="LN193"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nchunks</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* number of lossy entries in pagetable */ 
</span><a name="LN194"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>pagetable</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* dsa pointers to head of pagetable data */ 
</span><a name="LN195"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>spages</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* dsa pointer to page array */ 
</span><a name="LN196"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>schunks</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* dsa pointer to chunk array */ 
</span><a name="LN197"></a>    <a href="../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>      <span class='Declare_Member'>lock</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* lock to protect below members */ 
</span><a name="LN198"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>spageptr</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* next spages index */ 
</span><a name="LN199"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>schunkptr</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* next schunks index */ 
</span><a name="LN200"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>schunkbit</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* next bit to check in current schunk */ 
</span><a name="LN201"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TBMSharedIteratorState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pagetable iteration array. 
 */ 
</span><a name="LN206"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PTIterationArray</span> 
<span class='Delimiter'>{ 
</span><a name="LN208"></a>    <a href="../../include/port/atomics/arch-x86.h.html#LN62"><span class='Ref_to_Struct'>pg_atomic_uint32</span></a> <span class='Declare_Member'>refcount</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* no. of iterator attached */ 
</span><a name="LN209"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>index</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>];</span>   <span class='Comment_Single_Line'>/* index array */ 
</span><a name="LN210"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>PTIterationArray</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * same as TBMIterator, but it is used for joint iteration, therefore this 
 * also holds a reference to the shared state. 
 */ 
</span><a name="LN216"></a><span class='Control'>struct</span> <span class='Declare_Struct'>TBMSharedIterator</span> 
<span class='Delimiter'>{ 
</span><a name="LN218"></a>    <a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>state</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* shared state */ 
</span><a name="LN219"></a>    <a href="tidbitmap.c.html#LN109"><span class='Ref_to_Struct'>PTEntryArray</span></a> <span class='Operator'>*</span><span class='Declare_Member'>ptbase</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* pagetable element array */ 
</span><a name="LN220"></a>    <a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a> <span class='Operator'>*</span><span class='Declare_Member'>ptpages</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* sorted exact page index list */ 
</span><a name="LN221"></a>    <a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a> <span class='Operator'>*</span><span class='Declare_Member'>ptchunks</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* sorted lossy page index list */ 
</span><a name="LN222"></a>    <a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Declare_Member'>output</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* MUST BE LAST (because variable-size) */ 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* Local function prototypes */ 
</span><a name="LN226"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>tbm_union_page</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bpage</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN227"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>tbm_intersect_page</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>apage</span><span class='Delimiter'>, 
</span><a name="LN228"></a>                   <span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN229"></a><span class='Keyword'>static const </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>tbm_find_pageentry</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, 
</span><a name="LN230"></a>                   <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN231"></a><span class='Keyword'>static </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>tbm_get_pageentry</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN232"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>tbm_page_is_lossy</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN233"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>tbm_mark_page_lossy</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN234"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>tbm_lossify</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN235"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>tbm_comparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>left</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>right</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN236"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>tbm_shared_comparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>left</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>right</span><span class='Delimiter'>, 
</span><a name="LN237"></a>                      <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Simple inline murmur hash implementation for the exact width required, for 
 * performance. 
 */ 
</span><span class='Keyword'>static inline </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN244"></a><span class='Declare_Function'>hash_blockno</span><span class='Parentheses'>(</span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN246"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>h</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN244"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>^= </span><a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>*= </span><span class='Number'>0x85ebca6b</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>^= </span><a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>13</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>*= </span><span class='Number'>0xc2b2ae35</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>^= </span><a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN246"><span class='Ref_To_Local'>h</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* define hashtable mapping block numbers to PagetableEntry's */ 
</span><a name="LN257"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_USE_NONDEFAULT_ALLOCATOR</span> 
<a name="LN258"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_PREFIX</span> pagetable 
<a name="LN259"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_ELEMENT_TYPE</span> <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> 
<a name="LN260"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_KEY_TYPE</span> <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN261"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_KEY</span> blockno 
<a name="LN262"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SH_HASH_KEY</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>tb</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN243"><span class='Ref_to_Func'>hash_blockno</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN262"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>) 
</span><a name="LN263"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SH_EQUAL</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>tb</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN263"><span class='Ref_to_Parameter'>a</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN263"><span class='Ref_to_Parameter'>b</span></a> 
<a name="LN264"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_SCOPE</span> <span class='Keyword'>static inline 
</span><a name="LN265"></a>#define <span class='Declare_Constant'>SH_DEFINE</span> 
<a name="LN266"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SH_DECLARE</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/simplehash.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_create - create an initially-empty bitmap 
 * 
 * The bitmap will live in the memory context that is CurrentMemoryContext 
 * at the time of this call.  It will be limited to (approximately) maxbytes 
 * total memory consumption.  If the DSA passed to this function is not NULL 
 * then the memory for storing elements of the underlying page table will 
 * be allocated from the DSA. 
 */ 
</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>* 
</span><a name="LN280"></a><span class='Declare_Function'>tbm_create</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>maxbytes</span><span class='Delimiter'>, </span><a href="../utils/mmgr/dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dsa</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN282"></a>    <a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tbm</span><span class='Delimiter'>; 
</span><a name="LN283"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>nbuckets</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create the TIDBitmap struct and zero all its fields */ 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN149"><span class='Ref_to_Member'>mcxt</span></a> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN128"><span class='Ref_to_EnumConst'>TBM_EMPTY</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Estimate number of hashtable entries we can have within maxbytes. This 
     * estimates the hash cost as sizeof(PagetableEntry), which is good enough 
     * for our purpose.  Also count an extra Pointer per entry for the arrays 
     * created during iteration readout. 
     */ 
</span>    <a href="tidbitmap.c.html#LN283"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN280"><span class='Ref_to_Parameter'>maxbytes</span></a> <span class='Operator'>/ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN283"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN283"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>, </span>INT_MAX <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* safety limit */ 
</span>    <a href="tidbitmap.c.html#LN283"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN283"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* sanity limit */ 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN283"><span class='Ref_To_Local'>nbuckets</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN157"><span class='Ref_to_Member'>lossify_start</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN280"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN163"><span class='Ref_to_Member'>dsapagetableold</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN164"><span class='Ref_to_Member'>ptpages</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN165"><span class='Ref_to_Member'>ptchunks</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN282"><span class='Ref_To_Local'>tbm</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_create &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Actually create the hashtable.  Since this is a moderately expensive 
 * proposition, we don't do it until we have to. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN317"></a><span class='Declare_Function'>tbm_create_pagetable</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>!= </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a> <span class='Operator'>= </span>pagetable_create<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN149"><span class='Ref_to_Member'>mcxt</span></a><span class='Delimiter'>, </span><span class='Number'>128</span><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If entry1 is valid, push it into the hashtable */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN327"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN328"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN329"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>oldstatus</span><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN327"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_insert<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, 
</span>                                <a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Operator'>.</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="tidbitmap.c.html#LN328"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN328"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN329"><span class='Ref_To_Local'>oldstatus</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN327"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN327"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN327"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN329"><span class='Ref_To_Local'>oldstatus</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="tidbitmap.c.html#LN317"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_create_pagetable &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_free - free a TIDBitmap 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN347"></a><span class='Declare_Function'>tbm_free</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Parentheses'>) 
</span>        pagetable_destroy<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN347"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * tbm_free_shared_area - free shared state 
 * 
 * Free shared iterator state, Also free shared pagetable and iterator arrays 
 * memory if they are not referred by any of the shared iterator i.e recount 
 * is becomes 0. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN366"></a><span class='Declare_Function'>tbm_free_shared_area</span><span class='Parentheses'>(</span><a href="../utils/mmgr/dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dsa</span><span class='Delimiter'>, </span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>dp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN368"></a>    <a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>istate</span> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN369"></a>    <a href="tidbitmap.c.html#LN109"><span class='Ref_to_Struct'>PTEntryArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptbase</span><span class='Delimiter'>; 
</span><a name="LN370"></a>    <a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptpages</span><span class='Delimiter'>; 
</span><a name="LN371"></a>    <a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptchunks</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN194"><span class='Ref_to_Member'>pagetable</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tidbitmap.c.html#LN369"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN194"><span class='Ref_to_Member'>pagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/atomics.h.html#LN410"><span class='Ref_to_Func'>pg_atomic_sub_fetch_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN369"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN111"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN194"><span class='Ref_to_Member'>pagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN195"><span class='Ref_to_Member'>spages</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tidbitmap.c.html#LN370"><span class='Ref_To_Local'>ptpages</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN195"><span class='Ref_to_Member'>spages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/atomics.h.html#LN410"><span class='Ref_to_Func'>pg_atomic_sub_fetch_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN370"><span class='Ref_To_Local'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN208"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN195"><span class='Ref_to_Member'>spages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN196"><span class='Ref_to_Member'>schunks</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tidbitmap.c.html#LN371"><span class='Ref_To_Local'>ptchunks</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN196"><span class='Ref_to_Member'>schunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/atomics.h.html#LN410"><span class='Ref_to_Func'>pg_atomic_sub_fetch_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN371"><span class='Ref_To_Local'>ptchunks</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN208"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN368"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN196"><span class='Ref_to_Member'>schunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN366"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_free_shared_area &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_add_tuples - add some tuple IDs to a TIDBitmap 
 * 
 * If recheck is true, then the recheck flag will be set in the 
 * TBMIterateResult when any of these tuples are reported out. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN402"></a><span class='Declare_Function'>tbm_add_tuples</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tids</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntids</span><span class='Delimiter'>, 
</span><a name="LN403"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>recheck</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN405"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>currblk</span> <span class='Operator'>= </span><a href="../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span><a name="LN406"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* only valid when currblk is valid */ 
</span><a name="LN407"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN138"><span class='Ref_to_EnumConst'>TBM_NOT_ITERATING</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN407"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN407"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>ntids</span></a><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN407"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN412"></a>        <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blk</span> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tids</span></a> <span class='Operator'>+ </span><a href="tidbitmap.c.html#LN407"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN413"></a>        <a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>off</span> <span class='Operator'>= </span><a href="../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tids</span></a> <span class='Operator'>+ </span><a href="tidbitmap.c.html#LN407"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN414"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span><span class='Delimiter'>, 
</span><a name="LN415"></a>                    <span class='Declare_Local'>bitnum</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* safety check to ensure we don't overrun bit array bounds */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN413"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="tidbitmap.c.html#LN413"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN54"><span class='Ref_to_Const'>MAX_TUPLES_PER_PAGE</span></a><span class='Parentheses'>) 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"tuple offset out of range: %u"</span><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN413"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Look up target page unless we already did.  This saves cycles when 
         * the input includes consecutive tuples on the same page, which is 
         * common enough to justify an extra test here. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN412"><span class='Ref_To_Local'>blk</span></a> <span class='Operator'>!= </span><a href="tidbitmap.c.html#LN405"><span class='Ref_To_Local'>currblk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN232"><span class='Ref_to_Proto'>tbm_page_is_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN412"><span class='Ref_To_Local'>blk</span></a><span class='Parentheses'>))</span> 
                <a href="tidbitmap.c.html#LN406"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* remember page is lossy */ 
</span>            <span class='Control'>else</span> 
                <a href="tidbitmap.c.html#LN406"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN231"><span class='Ref_to_Proto'>tbm_get_pageentry</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN412"><span class='Ref_To_Local'>blk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN405"><span class='Ref_To_Local'>currblk</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN412"><span class='Ref_To_Local'>blk</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN406"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* whole page is already marked */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN406"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* The page is a lossy chunk header, set bit for itself */ 
</span>            <a href="tidbitmap.c.html#LN414"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN415"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Page is exact, so set bit for individual tuple */ 
</span>            <a href="tidbitmap.c.html#LN414"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><a href="bitmapset.c.html#LN26"><span class='Ref_to_Macro'>WORDNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN413"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN415"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>= </span><a href="bitmapset.c.html#LN27"><span class='Ref_to_Macro'>BITNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN413"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="tidbitmap.c.html#LN406"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN414"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="tidbitmap.c.html#LN415"><span class='Ref_To_Local'>bitnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN406"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>|= </span><a href="tidbitmap.c.html#LN403"><span class='Ref_to_Parameter'>recheck</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN234"><span class='Ref_to_Proto'>tbm_lossify</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN402"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Page could have been converted to lossy, so force new lookup */ 
</span>            <a href="tidbitmap.c.html#LN405"><span class='Ref_To_Local'>currblk</span></a> <span class='Operator'>= </span><a href="../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ntids;i++ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end tbm_add_tuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_add_page - add a whole page to a TIDBitmap 
 * 
 * This causes the whole page to be reported (with the recheck flag) 
 * when the TIDBitmap is scanned. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN468"></a><span class='Declare_Function'>tbm_add_page</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Enter the page in the bitmap, or mark it lossy if already present */ 
</span>    <a href="tidbitmap.c.html#LN233"><span class='Ref_to_Proto'>tbm_mark_page_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN468"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN468"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* If we went over the memory limit, lossify some more pages */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN468"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN468"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN234"><span class='Ref_to_Proto'>tbm_lossify</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN468"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * tbm_union - set union 
 * 
 * a is modified in-place, b is not changed 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN483"></a><span class='Declare_Function'>tbm_union</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Nothing to do if b is empty */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>b</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Scan through chunks and pages in b, merge into a */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>b</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN226"><span class='Ref_to_Proto'>tbm_union_page</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>b</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN494"></a>        pagetable_iterator <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN495"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bpage</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>b</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        pagetable_start_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>b</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN494"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN495"><span class='Ref_To_Local'>bpage</span></a> <span class='Operator'>= </span>pagetable_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>b</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN494"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="tidbitmap.c.html#LN226"><span class='Ref_to_Proto'>tbm_union_page</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN483"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN495"><span class='Ref_To_Local'>bpage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end tbm_union &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Process one page of b during a union op */ 
</span><span class='Keyword'>static void 
</span><a name="LN506"></a><span class='Declare_Function'>tbm_union_page</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bpage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN508"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>apage</span><span class='Delimiter'>; 
</span><a name="LN509"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Scan b's chunk, mark each indicated page lossy in a */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN81"><span class='Ref_to_Const'>WORDS_PER_CHUNK</span></a><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN516"></a>            <a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a>  <span class='Declare_Local'>w</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN516"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN520"></a>                <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pg</span><span class='Delimiter'>; 
</span> 
                <a href="tidbitmap.c.html#LN520"><span class='Ref_To_Local'>pg</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>* </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN516"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN516"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                        <a href="tidbitmap.c.html#LN233"><span class='Ref_to_Proto'>tbm_mark_page_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN520"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="tidbitmap.c.html#LN520"><span class='Ref_To_Local'>pg</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="tidbitmap.c.html#LN516"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if bpage-&GT;ischunk &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN232"><span class='Ref_to_Proto'>tbm_page_is_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* page is already lossy in a, nothing to do */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="tidbitmap.c.html#LN508"><span class='Ref_To_Local'>apage</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN231"><span class='Ref_to_Proto'>tbm_get_pageentry</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN508"><span class='Ref_To_Local'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* The page is a lossy chunk header, set bit for itself */ 
</span>            <a href="tidbitmap.c.html#LN508"><span class='Ref_To_Local'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>|= </span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Both pages are exact, merge at the bit level */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN79"><span class='Ref_to_Const'>WORDS_PER_PAGE</span></a><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="tidbitmap.c.html#LN508"><span class='Ref_To_Local'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN509"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>]; 
</span>            <a href="tidbitmap.c.html#LN508"><span class='Ref_To_Local'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>|= </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN234"><span class='Ref_to_Proto'>tbm_lossify</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN506"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_union_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_intersect - set intersection 
 * 
 * a is modified in-place, b is not changed 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN565"></a><span class='Declare_Function'>tbm_intersect</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Nothing to do if a is empty */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Scan through chunks and pages in a, try to match to b */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN227"><span class='Ref_to_Proto'>tbm_intersect_page</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Page is now empty, remove it from a */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Operator'>.</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN128"><span class='Ref_to_EnumConst'>TBM_EMPTY</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN586"></a>        pagetable_iterator <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN587"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>apage</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        pagetable_start_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN586"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN587"><span class='Ref_To_Local'>apage</span></a> <span class='Operator'>= </span>pagetable_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN586"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN227"><span class='Ref_to_Proto'>tbm_intersect_page</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN587"><span class='Ref_To_Local'>apage</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Page or chunk is now empty, remove it from a */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN587"><span class='Ref_To_Local'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>                    <a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>pagetable_delete<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN565"><span class='Ref_to_Parameter'>a</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN587"><span class='Ref_To_Local'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>))</span> 
                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end tbm_intersect &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process one page of a during an intersection op 
 * 
 * Returns TRUE if apage is now empty and should be deleted from a 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN614"></a><span class='Declare_Function'>tbm_intersect_page</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>apage</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN616"></a>    <span class='Keyword'>const </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bpage</span><span class='Delimiter'>; 
</span><a name="LN617"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Scan each bit in chunk, try to clear */ 
</span><a name="LN622"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>candelete</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN81"><span class='Ref_to_Const'>WORDS_PER_CHUNK</span></a><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN626"></a>            <a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a>  <span class='Declare_Local'>w</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN626"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN630"></a>                <a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a>  <span class='Declare_Local'>neww</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN626"><span class='Ref_To_Local'>w</span></a><span class='Delimiter'>; 
</span><a name="LN631"></a>                <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>pg</span><span class='Delimiter'>; 
</span><a name="LN632"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>bitnum</span><span class='Delimiter'>; 
</span> 
                <a href="tidbitmap.c.html#LN631"><span class='Ref_To_Local'>pg</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>* </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="tidbitmap.c.html#LN632"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN626"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN626"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN232"><span class='Ref_to_Proto'>tbm_page_is_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN631"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                            <a href="tidbitmap.c.html#LN229"><span class='Ref_to_Proto'>tbm_find_pageentry</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN631"><span class='Ref_To_Local'>pg</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                        <span class='Delimiter'>{ 
</span>                            <span class='Comment_Multi_Line'>/* Page is not in b at all, lose lossy bit */ 
</span>                            <a href="tidbitmap.c.html#LN630"><span class='Ref_To_Local'>neww</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="tidbitmap.c.html#LN632"><span class='Ref_To_Local'>bitnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                    <span class='Delimiter'>} 
</span>                    <a href="tidbitmap.c.html#LN631"><span class='Ref_To_Local'>pg</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="tidbitmap.c.html#LN632"><span class='Ref_To_Local'>bitnum</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="tidbitmap.c.html#LN626"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tidbitmap.c.html#LN630"><span class='Ref_To_Local'>neww</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN630"><span class='Ref_To_Local'>neww</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="tidbitmap.c.html#LN622"><span class='Ref_To_Local'>candelete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if w!=0 &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for wordnum=0;wordnum&LT;WOR... &raquo; </span> 
        <span class='Control'>return</span> <a href="tidbitmap.c.html#LN622"><span class='Ref_To_Local'>candelete</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if apage-&GT;ischunk &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN232"><span class='Ref_to_Proto'>tbm_page_is_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Some of the tuples in 'a' might not satisfy the quals for 'b', but 
         * because the page 'b' is lossy, we don't know which ones. Therefore 
         * we mark 'a' as requiring rechecks, to indicate that at most those 
         * tuples set in 'a' are matches. 
         */ 
</span>        <a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN671"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>candelete</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN616"><span class='Ref_To_Local'>bpage</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN229"><span class='Ref_to_Proto'>tbm_find_pageentry</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN616"><span class='Ref_To_Local'>bpage</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Both pages are exact, merge at the bit level */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN616"><span class='Ref_To_Local'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN79"><span class='Ref_to_Const'>WORDS_PER_PAGE</span></a><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>&= </span><a href="tidbitmap.c.html#LN616"><span class='Ref_To_Local'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN617"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="tidbitmap.c.html#LN671"><span class='Ref_To_Local'>candelete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="tidbitmap.c.html#LN614"><span class='Ref_to_Parameter'>apage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>|= </span><a href="tidbitmap.c.html#LN616"><span class='Ref_To_Local'>bpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* If there is no matching b page, we can just delete the a page */ 
</span>        <span class='Control'>return</span> <a href="tidbitmap.c.html#LN671"><span class='Ref_To_Local'>candelete</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end tbm_intersect_page &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_is_empty - is a TIDBitmap completely empty? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN695"></a><span class='Declare_Function'>tbm_is_empty</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN695"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * tbm_begin_iterate - prepare to iterate through a TIDBitmap 
 * 
 * The TBMIterator struct is created in the caller's memory context. 
 * For a clean shutdown of the iteration, call tbm_end_iterate; but it's 
 * okay to just allow the memory context to be released, too.  It is caller's 
 * responsibility not to touch the TBMIterator anymore once the TIDBitmap 
 * is freed. 
 * 
 * NB: after this is called, it is no longer allowed to modify the contents 
 * of the bitmap.  However, you can call this multiple times to scan the 
 * contents repeatedly, including parallel scans. 
 */ 
</span><a href="tidbitmap.c.html#LN175"><span class='Ref_to_Struct'>TBMIterator</span></a> <span class='Operator'>* 
</span><a name="LN714"></a><span class='Declare_Function'>tbm_begin_iterate</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN716"></a>    <a href="tidbitmap.c.html#LN175"><span class='Ref_to_Struct'>TBMIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>iterator</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>!= </span><a href="tidbitmap.c.html#LN140"><span class='Ref_to_EnumConst'>TBM_ITERATING_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the TBMIterator struct, with enough trailing space to serve the 
     * needs of the TBMIterateResult sub-struct. 
     */ 
</span>    <a href="tidbitmap.c.html#LN716"><span class='Ref_To_Local'>iterator</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN175"><span class='Ref_to_Struct'>TBMIterator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN175"><span class='Ref_to_Struct'>TBMIterator</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                 <a href="tidbitmap.c.html#LN54"><span class='Ref_to_Const'>MAX_TUPLES_PER_PAGE</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN716"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN177"><span class='Ref_to_Member'>tbm</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize iteration pointers. 
     */ 
</span>    <a href="tidbitmap.c.html#LN716"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN178"><span class='Ref_to_Member'>spageptr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN716"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN179"><span class='Ref_to_Member'>schunkptr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN716"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN180"><span class='Ref_to_Member'>schunkbit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we have a hashtable, create and fill the sorted page lists, unless 
     * we already did that for a previous iterator.  Note that the lists are 
     * attached to the bitmap not the iterator, so they can be used by more 
     * than one iterator. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a> <span class='Operator'>&& </span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN138"><span class='Ref_to_EnumConst'>TBM_NOT_ITERATING</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN743"></a>        pagetable_iterator <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN744"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN745"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>npages</span><span class='Delimiter'>; 
</span><a name="LN746"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nchunks</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a> <span class='Operator'>&& </span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN149"><span class='Ref_to_Member'>mcxt</span></a><span class='Delimiter'>, 
</span>                                   <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a> <span class='Operator'>&& </span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>**</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN149"><span class='Ref_to_Member'>mcxt</span></a><span class='Delimiter'>, 
</span>                                   <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN745"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN746"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        pagetable_start_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN743"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN744"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN743"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN744"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>                <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN746"><span class='Ref_To_Local'>nchunks</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tidbitmap.c.html#LN744"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN745"><span class='Ref_To_Local'>npages</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tidbitmap.c.html#LN744"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN745"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN746"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN745"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN745"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="tidbitmap.c.html#LN235"><span class='Ref_to_Proto'>tbm_comparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN746"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN746"><span class='Ref_To_Local'>nchunks</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="tidbitmap.c.html#LN235"><span class='Ref_to_Proto'>tbm_comparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tbm-&GT;status==TBM_HASH... &raquo; </span> 
 
    <a href="tidbitmap.c.html#LN714"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN139"><span class='Ref_to_EnumConst'>TBM_ITERATING_PRIVATE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN716"><span class='Ref_To_Local'>iterator</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_begin_iterate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_prepare_shared_iterate - prepare shared iteration state for a TIDBitmap. 
 * 
 * The necessary shared state will be allocated from the DSA passed to 
 * tbm_create, so that multiple processes can attach to it and iterate jointly. 
 * 
 * This will convert the pagetable hash into page and chunk array of the index 
 * into pagetable array. 
 */ 
</span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> 
<a name="LN791"></a><span class='Declare_Function'>tbm_prepare_shared_iterate</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN793"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>dp</span><span class='Delimiter'>; 
</span><a name="LN794"></a>    <a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>istate</span><span class='Delimiter'>; 
</span><a name="LN795"></a>    <a href="tidbitmap.c.html#LN109"><span class='Ref_to_Struct'>PTEntryArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptbase</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN796"></a>    <a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptpages</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN797"></a>    <a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptchunks</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>!= </span><a href="tidbitmap.c.html#LN139"><span class='Ref_to_EnumConst'>TBM_ITERATING_PRIVATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate TBMSharedIteratorState from DSA to hold the shared members and 
     * lock, this will also be used by multiple worker for shared iterate. 
     */ 
</span>    <a href="tidbitmap.c.html#LN793"><span class='Ref_To_Local'>dp</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN87"><span class='Ref_to_Macro'>dsa_allocate0</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN793"><span class='Ref_To_Local'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're not already iterating, create and fill the sorted page lists. 
     * (If we are, the sorted page lists are already stored in the TIDBitmap, 
     * and we can just reuse them.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN138"><span class='Ref_to_EnumConst'>TBM_NOT_ITERATING</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN816"></a>        pagetable_iterator <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN817"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN818"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span><span class='Delimiter'>; 
</span><a name="LN819"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>npages</span><span class='Delimiter'>; 
</span><a name="LN820"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nchunks</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allocate the page and chunk array memory from the DSA to share 
         * across multiple processes. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN164"><span class='Ref_to_Member'>ptpages</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN83"><span class='Ref_to_Macro'>dsa_allocate</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                        <a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN164"><span class='Ref_to_Member'>ptpages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/port/atomics.h.html#LN232"><span class='Ref_to_Func'>pg_atomic_init_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN208"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN165"><span class='Ref_to_Member'>ptchunks</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN83"><span class='Ref_to_Macro'>dsa_allocate</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN206"><span class='Ref_to_Struct'>PTIterationArray</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                         <a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN165"><span class='Ref_to_Member'>ptchunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/port/atomics.h.html#LN232"><span class='Ref_to_Func'>pg_atomic_init_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN208"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If TBM status is TBM_HASH then iterate over the pagetable and 
         * convert it to page and chunk arrays.  But if it's in the 
         * TBM_ONE_PAGE mode then directly allocate the space for one entry 
         * from the DSA. 
         */ 
</span>        <a href="tidbitmap.c.html#LN819"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN820"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            pagetable_start_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN816"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN817"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN816"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="tidbitmap.c.html#LN818"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN817"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>- </span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN112"><span class='Ref_to_Member'>ptentry</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN817"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>                    <a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN820"><span class='Ref_To_Local'>nchunks</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tidbitmap.c.html#LN818"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN819"><span class='Ref_To_Local'>npages</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="tidbitmap.c.html#LN818"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN819"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN820"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * In one page mode allocate the space for one pagetable entry, 
             * initialize it, and directly store its index (i.e. 0) in the 
             * page array. 
             */ 
</span>            <a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN83"><span class='Ref_to_Macro'>dsa_allocate</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN109"><span class='Ref_to_Struct'>PTEntryArray</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN112"><span class='Ref_to_Member'>ptentry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/port/atomics.h.html#LN232"><span class='Ref_to_Func'>pg_atomic_init_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN111"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN819"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../port/qsort_arg.c.html#LN111"><span class='Ref_to_Func'>qsort_arg</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN819"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="tidbitmap.c.html#LN236"><span class='Ref_to_Proto'>tbm_shared_comparator</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN112"><span class='Ref_to_Member'>ptentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN820"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../port/qsort_arg.c.html#LN111"><span class='Ref_to_Func'>qsort_arg</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN820"><span class='Ref_To_Local'>nchunks</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="tidbitmap.c.html#LN236"><span class='Ref_to_Proto'>tbm_shared_comparator</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN112"><span class='Ref_to_Member'>ptentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tbm-&GT;iterating==TBM_N... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Store the TBM members in the shared state so that we can share them 
     * across multiple processes. 
     */ 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN190"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN191"><span class='Ref_to_Member'>maxentries</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN192"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN193"><span class='Ref_to_Member'>nchunks</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN194"><span class='Ref_to_Member'>pagetable</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN195"><span class='Ref_to_Member'>spages</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN164"><span class='Ref_to_Member'>ptpages</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN196"><span class='Ref_to_Member'>schunks</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN165"><span class='Ref_to_Member'>ptchunks</span></a><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN164"><span class='Ref_to_Member'>ptpages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN165"><span class='Ref_to_Member'>ptchunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For every shared iterator, referring to pagetable and iterator array, 
     * increase the refcount by 1 so that while freeing the shared iterator we 
     * don't free pagetable and iterator array until its refcount becomes 0. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/port/atomics.h.html#LN395"><span class='Ref_to_Func'>pg_atomic_add_fetch_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN795"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN111"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/port/atomics.h.html#LN395"><span class='Ref_to_Func'>pg_atomic_add_fetch_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN796"><span class='Ref_To_Local'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN208"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/port/atomics.h.html#LN395"><span class='Ref_to_Func'>pg_atomic_add_fetch_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN797"><span class='Ref_To_Local'>ptchunks</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN208"><span class='Ref_to_Member'>refcount</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the iterator lock */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN187"><span class='Ref_to_Proto'>LWLockInitialize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN197"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN214"><span class='Ref_to_EnumConst'>LWTRANCHE_TBM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the shared iterator state */ 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN200"><span class='Ref_to_Member'>schunkbit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN199"><span class='Ref_to_Member'>schunkptr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN794"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN198"><span class='Ref_to_Member'>spageptr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN791"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN140"><span class='Ref_to_EnumConst'>TBM_ITERATING_SHARED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN793"><span class='Ref_To_Local'>dp</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_prepare_shared_iterate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_extract_page_tuple - extract the tuple offsets from a page 
 * 
 * The extracted offsets are stored into TBMIterateResult. 
 */ 
</span><span class='Keyword'>static inline int 
</span><a name="LN936"></a><span class='Declare_Function'>tbm_extract_page_tuple</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>output</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN938"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span><span class='Delimiter'>; 
</span><a name="LN939"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ntuples</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN938"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN938"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN79"><span class='Ref_to_Const'>WORDS_PER_PAGE</span></a><span class='Delimiter'>; </span><a href="tidbitmap.c.html#LN938"><span class='Ref_To_Local'>wordnum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN943"></a>        <a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a>  <span class='Declare_Local'>w</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN936"><span class='Ref_to_Parameter'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN938"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN943"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN947"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>off</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN938"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>* </span><a href="../../include/nodes/bitmapset.h.html#LN32"><span class='Ref_to_Const'>BITS_PER_BITMAPWORD</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN943"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN943"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="tidbitmap.c.html#LN936"><span class='Ref_to_Parameter'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN45"><span class='Ref_to_Member'>offsets</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN939"><span class='Ref_To_Local'>ntuples</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN947"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>                <a href="tidbitmap.c.html#LN947"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="tidbitmap.c.html#LN943"><span class='Ref_To_Local'>w</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN939"><span class='Ref_To_Local'>ntuples</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_extract_page_tuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  tbm_advance_schunkbit - Advance the chunkbit 
 */ 
</span><span class='Keyword'>static inline void 
</span><a name="LN966"></a><span class='Declare_Function'>tbm_advance_schunkbit</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>chunk</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>schunkbitp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN968"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>schunkbit</span> <span class='Operator'>= *</span><a href="tidbitmap.c.html#LN966"><span class='Ref_to_Parameter'>schunkbitp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN968"><span class='Ref_To_Local'>schunkbit</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN972"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span> <span class='Operator'>= </span><a href="bitmapset.c.html#LN26"><span class='Ref_to_Macro'>WORDNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN968"><span class='Ref_To_Local'>schunkbit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN973"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bitnum</span> <span class='Operator'>= </span><a href="bitmapset.c.html#LN27"><span class='Ref_to_Macro'>BITNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN968"><span class='Ref_To_Local'>schunkbit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN966"><span class='Ref_to_Parameter'>chunk</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN972"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="tidbitmap.c.html#LN973"><span class='Ref_To_Local'>bitnum</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN968"><span class='Ref_To_Local'>schunkbit</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="tidbitmap.c.html#LN966"><span class='Ref_to_Parameter'>schunkbitp</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN968"><span class='Ref_To_Local'>schunkbit</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * tbm_iterate - scan through next page of a TIDBitmap 
 * 
 * Returns a TBMIterateResult representing one page, or NULL if there are 
 * no more pages to scan.  Pages are guaranteed to be delivered in numerical 
 * order.  If result-&GT;ntuples &LT; 0, then the bitmap is "lossy" and failed to 
 * remember the exact tuples to look at on this page --- the caller must 
 * examine all tuples on the page and check if they meet the intended 
 * condition.  If result-&GT;recheck is true, only the indicated tuples need 
 * be examined, but the condition must be rechecked anyway.  (For ease of 
 * testing, recheck is always set true when ntuples &LT; 0.) 
 */ 
</span><a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Operator'>* 
</span><a name="LN996"></a><span class='Declare_Function'>tbm_iterate</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN175"><span class='Ref_to_Struct'>TBMIterator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iterator</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN998"></a>    <a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tbm</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN177"><span class='Ref_to_Member'>tbm</span></a><span class='Delimiter'>; 
</span><a name="LN999"></a>    <a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Operator'>*</span><span class='Declare_Local'>output</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN181"><span class='Ref_to_Member'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN139"><span class='Ref_to_EnumConst'>TBM_ITERATING_PRIVATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If lossy chunk pages remain, make sure we've advanced schunkptr/ 
     * schunkbit to the next set bit. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN179"><span class='Ref_to_Member'>schunkptr</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1009"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>chunk</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN179"><span class='Ref_to_Member'>schunkptr</span></a><span class='Delimiter'>]; 
</span><a name="LN1010"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>schunkbit</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN180"><span class='Ref_to_Member'>schunkbit</span></a><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN965"><span class='Ref_to_Func'>tbm_advance_schunkbit</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1009"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1010"><span class='Ref_To_Local'>schunkbit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1010"><span class='Ref_To_Local'>schunkbit</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN180"><span class='Ref_to_Member'>schunkbit</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1010"><span class='Ref_To_Local'>schunkbit</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* advance to next chunk */ 
</span>        <a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN179"><span class='Ref_to_Member'>schunkptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN180"><span class='Ref_to_Member'>schunkbit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If both chunk and per-page data remain, must output the numerically 
     * earlier page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN179"><span class='Ref_to_Member'>schunkptr</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1029"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>chunk</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN161"><span class='Ref_to_Member'>schunks</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN179"><span class='Ref_to_Member'>schunkptr</span></a><span class='Delimiter'>]; 
</span><a name="LN1030"></a>        <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>chunk_blockno</span><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN1030"><span class='Ref_To_Local'>chunk_blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1029"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>+ </span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN180"><span class='Ref_to_Member'>schunkbit</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN178"><span class='Ref_to_Member'>spageptr</span></a> <span class='Operator'>&GT;= </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>|| 
</span>            <a href="tidbitmap.c.html#LN1030"><span class='Ref_To_Local'>chunk_blockno</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN178"><span class='Ref_to_Member'>spageptr</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Return a lossy page indicator from the chunk */ 
</span>            <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN41"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1030"><span class='Ref_To_Local'>chunk_blockno</span></a><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN42"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN43"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN180"><span class='Ref_to_Member'>schunkbit</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN178"><span class='Ref_to_Member'>spageptr</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1047"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1048"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ntuples</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* In ONE_PAGE state, we don't allocate an spages[] array */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>            <a href="tidbitmap.c.html#LN1047"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="tidbitmap.c.html#LN1047"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN998"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN160"><span class='Ref_to_Member'>spages</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN178"><span class='Ref_to_Member'>spageptr</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* scan bitmap to extract individual offset numbers */ 
</span>        <a href="tidbitmap.c.html#LN1048"><span class='Ref_To_Local'>ntuples</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN935"><span class='Ref_to_Func'>tbm_extract_page_tuple</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1047"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN41"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1047"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN42"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1048"><span class='Ref_To_Local'>ntuples</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN43"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1047"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN996"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN178"><span class='Ref_to_Member'>spageptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="tidbitmap.c.html#LN999"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing more in the bitmap */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_iterate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  tbm_shared_iterate - scan through next page of a TIDBitmap 
 * 
 *  As above, but this will iterate using an iterator which is shared 
 *  across multiple processes.  We need to acquire the iterator LWLock, 
 *  before accessing the shared members. 
 */ 
</span><a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Operator'>* 
</span><a name="LN1077"></a><span class='Declare_Function'>tbm_shared_iterate</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN216"><span class='Ref_to_Struct'>TBMSharedIterator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iterator</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1079"></a>    <a href="../../include/nodes/tidbitmap.h.html#LN39"><span class='Ref_to_Typedef'>TBMIterateResult</span></a> <span class='Operator'>*</span><span class='Declare_Local'>output</span> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN222"><span class='Ref_to_Member'>output</span></a><span class='Delimiter'>; 
</span><a name="LN1080"></a>    <a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>istate</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN218"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>; 
</span><a name="LN1081"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptbase</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1082"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>idxpages</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1083"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>idxchunks</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN219"><span class='Ref_to_Member'>ptbase</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN1081"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN219"><span class='Ref_to_Member'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN112"><span class='Ref_to_Member'>ptentry</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN220"><span class='Ref_to_Member'>ptpages</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN1082"><span class='Ref_To_Local'>idxpages</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN220"><span class='Ref_to_Member'>ptpages</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN221"><span class='Ref_to_Member'>ptchunks</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN1083"><span class='Ref_To_Local'>idxchunks</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1077"><span class='Ref_to_Parameter'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN221"><span class='Ref_to_Member'>ptchunks</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN209"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Acquire the LWLock before accessing the shared members */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN197"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If lossy chunk pages remain, make sure we've advanced schunkptr/ 
     * schunkbit to the next set bit. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN199"><span class='Ref_to_Member'>schunkptr</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN193"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1101"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>chunk</span> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1081"><span class='Ref_To_Local'>ptbase</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1083"><span class='Ref_To_Local'>idxchunks</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN199"><span class='Ref_to_Member'>schunkptr</span></a><span class='Delimiter'>]]; 
</span><a name="LN1102"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>schunkbit</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN200"><span class='Ref_to_Member'>schunkbit</span></a><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN965"><span class='Ref_to_Func'>tbm_advance_schunkbit</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1101"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1102"><span class='Ref_To_Local'>schunkbit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1102"><span class='Ref_To_Local'>schunkbit</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN200"><span class='Ref_to_Member'>schunkbit</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1102"><span class='Ref_To_Local'>schunkbit</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* advance to next chunk */ 
</span>        <a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN199"><span class='Ref_to_Member'>schunkptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN200"><span class='Ref_to_Member'>schunkbit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If both chunk and per-page data remain, must output the numerically 
     * earlier page. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN199"><span class='Ref_to_Member'>schunkptr</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN193"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1121"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>chunk</span> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1081"><span class='Ref_To_Local'>ptbase</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1083"><span class='Ref_To_Local'>idxchunks</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN199"><span class='Ref_to_Member'>schunkptr</span></a><span class='Delimiter'>]]; 
</span><a name="LN1122"></a>        <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>chunk_blockno</span><span class='Delimiter'>; 
</span> 
        <a href="tidbitmap.c.html#LN1122"><span class='Ref_To_Local'>chunk_blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1121"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>+ </span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN200"><span class='Ref_to_Member'>schunkbit</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN198"><span class='Ref_to_Member'>spageptr</span></a> <span class='Operator'>&GT;= </span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN192"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>|| 
</span>            <a href="tidbitmap.c.html#LN1122"><span class='Ref_To_Local'>chunk_blockno</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN1081"><span class='Ref_To_Local'>ptbase</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1082"><span class='Ref_To_Local'>idxpages</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN198"><span class='Ref_to_Member'>spageptr</span></a><span class='Delimiter'>]]</span><span class='Operator'>.</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Return a lossy page indicator from the chunk */ 
</span>            <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN41"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1122"><span class='Ref_To_Local'>chunk_blockno</span></a><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN42"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN43"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN200"><span class='Ref_to_Member'>schunkbit</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN197"><span class='Ref_to_Member'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if istate-&GT;schunkptr&LT;ist... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN198"><span class='Ref_to_Member'>spageptr</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN192"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1142"></a>        <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1081"><span class='Ref_To_Local'>ptbase</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1082"><span class='Ref_To_Local'>idxpages</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN198"><span class='Ref_to_Member'>spageptr</span></a><span class='Delimiter'>]]; 
</span><a name="LN1143"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ntuples</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* scan bitmap to extract individual offset numbers */ 
</span>        <a href="tidbitmap.c.html#LN1143"><span class='Ref_To_Local'>ntuples</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN935"><span class='Ref_to_Func'>tbm_extract_page_tuple</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1142"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN41"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1142"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN42"><span class='Ref_to_Member'>ntuples</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1143"><span class='Ref_To_Local'>ntuples</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/tidbitmap.h.html#LN43"><span class='Ref_to_Member'>recheck</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1142"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN102"><span class='Ref_to_Member'>recheck</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN198"><span class='Ref_to_Member'>spageptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN197"><span class='Ref_to_Member'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1079"><span class='Ref_To_Local'>output</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1080"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN197"><span class='Ref_to_Member'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing more in the bitmap */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_shared_iterate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_end_iterate - finish an iteration over a TIDBitmap 
 * 
 * Currently this is just a pfree, but it might do more someday.  (For 
 * instance, it could be useful to count open iterators and allow the 
 * bitmap to return to read/write status when there are no more iterators.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1171"></a><span class='Declare_Function'>tbm_end_iterate</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN175"><span class='Ref_to_Struct'>TBMIterator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iterator</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1171"><span class='Ref_to_Parameter'>iterator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * tbm_end_shared_iterate - finish a shared iteration over a TIDBitmap 
 * 
 * This doesn't free any of the shared state associated with the iterator, 
 * just our backend-private state. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1183"></a><span class='Declare_Function'>tbm_end_shared_iterate</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN216"><span class='Ref_to_Struct'>TBMSharedIterator</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iterator</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1183"><span class='Ref_to_Parameter'>iterator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * tbm_find_pageentry - find a PagetableEntry for the pageno 
 * 
 * Returns NULL if there is no non-lossy entry for the pageno. 
 */ 
</span><span class='Keyword'>static const </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>* 
</span><a name="LN1194"></a><span class='Declare_Function'>tbm_find_pageentry</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1196"></a>    <span class='Keyword'>const </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1194"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span>     <span class='Comment_Single_Line'>/* in case pagetable doesn't exist */ 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1194"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1194"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>!= </span><a href="tidbitmap.c.html#LN1194"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_lookup<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1194"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1194"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* don't want a lossy chunk header */ 
</span>    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1196"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_find_pageentry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_get_pageentry - find or create a PagetableEntry for the pageno 
 * 
 * If new, the entry is marked as an exact (non-chunk) entry. 
 * 
 * This may cause the table to exceed the desired memory size.  It is 
 * up to the caller to call tbm_lossify() at the next safe point if so. 
 */ 
</span><span class='Keyword'>static </span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>* 
</span><a name="LN1227"></a><span class='Declare_Function'>tbm_get_pageentry</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1229"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1230"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN128"><span class='Ref_to_EnumConst'>TBM_EMPTY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Use the fixed slot */ 
</span>        <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1230"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN129"><span class='Ref_to_EnumConst'>TBM_ONE_PAGE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN158"><span class='Ref_to_Member'>entry1</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Time to switch from one page to a hashtable */ 
</span>            <a href="tidbitmap.c.html#LN316"><span class='Ref_to_Func'>tbm_create_pagetable</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Look up or create an entry */ 
</span>        <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_insert<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>pageno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1230"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize it if not present before */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN1230"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1257"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>oldstatus</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1257"><span class='Ref_To_Local'>oldstatus</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>pageno</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* must count it too */ 
</span>        <a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1227"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1229"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_get_pageentry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_page_is_lossy - is the page marked as lossily stored? 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1274"></a><span class='Declare_Function'>tbm_page_is_lossy</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1276"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1277"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>chunk_pageno</span><span class='Delimiter'>; 
</span><a name="LN1278"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bitno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we can skip the lookup if there are no lossy chunks */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1274"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1274"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN1278"><span class='Ref_To_Local'>bitno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1274"><span class='Ref_to_Parameter'>pageno</span></a> <span class='Operator'>% </span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN1277"><span class='Ref_To_Local'>chunk_pageno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1274"><span class='Ref_to_Parameter'>pageno</span></a> <span class='Operator'>- </span><a href="tidbitmap.c.html#LN1278"><span class='Ref_To_Local'>bitno</span></a><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN1276"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_lookup<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1274"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1277"><span class='Ref_To_Local'>chunk_pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1276"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="tidbitmap.c.html#LN1276"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1292"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span> <span class='Operator'>= </span><a href="bitmapset.c.html#LN26"><span class='Ref_to_Macro'>WORDNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1278"><span class='Ref_To_Local'>bitno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1293"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bitnum</span> <span class='Operator'>= </span><a href="bitmapset.c.html#LN27"><span class='Ref_to_Macro'>BITNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1278"><span class='Ref_To_Local'>bitno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN1276"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1292"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="tidbitmap.c.html#LN1293"><span class='Ref_To_Local'>bitnum</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_page_is_lossy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_mark_page_lossy - mark the page number as lossily stored 
 * 
 * This may cause the table to exceed the desired memory size.  It is 
 * up to the caller to call tbm_lossify() at the next safe point if so. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1308"></a><span class='Declare_Function'>tbm_mark_page_lossy</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Delimiter'>, </span><a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1310"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span><a name="LN1311"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN1312"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>chunk_pageno</span><span class='Delimiter'>; 
</span><a name="LN1313"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bitno</span><span class='Delimiter'>; 
</span><a name="LN1314"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>wordnum</span><span class='Delimiter'>; 
</span><a name="LN1315"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bitnum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We force the bitmap into hashtable mode whenever it's lossy */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>!= </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN316"><span class='Ref_to_Func'>tbm_create_pagetable</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN1313"><span class='Ref_To_Local'>bitno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>pageno</span></a> <span class='Operator'>% </span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN1312"><span class='Ref_To_Local'>chunk_pageno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>pageno</span></a> <span class='Operator'>- </span><a href="tidbitmap.c.html#LN1313"><span class='Ref_To_Local'>bitno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove any extant non-lossy entry for the page.  If the page is its own 
     * chunk header, however, we skip this and handle the case below. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1313"><span class='Ref_To_Local'>bitno</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>pagetable_delete<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* It was present, so adjust counts */ 
</span>            <a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Operator'>--</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* assume it must have been non-lossy */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Look up or create entry for chunk-header page */ 
</span>    <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_insert<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1312"><span class='Ref_To_Local'>chunk_pageno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1311"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize it if not present before */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN1311"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1344"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>oldstatus</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1344"><span class='Ref_To_Local'>oldstatus</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1312"><span class='Ref_To_Local'>chunk_pageno</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* must count it too */ 
</span>        <a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1356"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>oldstatus</span> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* chunk header page was formerly non-lossy, make it lossy */ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN100"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1356"><span class='Ref_To_Local'>oldstatus</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1312"><span class='Ref_To_Local'>chunk_pageno</span></a><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* we assume it had some tuple bit(s) set, so mark it lossy */ 
</span>        <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* adjust counts */ 
</span>        <a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN155"><span class='Ref_to_Member'>nchunks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1308"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN154"><span class='Ref_to_Member'>npages</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now set the original target page's bit */ 
</span>    <a href="tidbitmap.c.html#LN1314"><span class='Ref_To_Local'>wordnum</span></a> <span class='Operator'>= </span><a href="bitmapset.c.html#LN26"><span class='Ref_to_Macro'>WORDNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1313"><span class='Ref_To_Local'>bitno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN1315"><span class='Ref_To_Local'>bitnum</span></a> <span class='Operator'>= </span><a href="bitmapset.c.html#LN27"><span class='Ref_to_Macro'>BITNUM</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1313"><span class='Ref_To_Local'>bitno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN1310"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN103"><span class='Ref_to_Member'>words</span></a><span class='Delimiter'>[</span><a href="tidbitmap.c.html#LN1314"><span class='Ref_To_Local'>wordnum</span></a><span class='Delimiter'>] </span><span class='Operator'>|= </span><span class='Parentheses'>((</span><a href="../../include/nodes/bitmapset.h.html#LN33"><span class='Ref_to_Typedef'>bitmapword</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="tidbitmap.c.html#LN1315"><span class='Ref_To_Local'>bitnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_mark_page_lossy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * tbm_lossify - lose some information to get back under the memory limit 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1380"></a><span class='Declare_Function'>tbm_lossify</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tbm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1382"></a>    pagetable_iterator <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1383"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>page</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX Really stupid implementation: this just lossifies pages in 
     * essentially random order.  We should be paying some attention to the 
     * number of bits set in each page, instead. 
     * 
     * Since we are called as soon as nentries exceeds maxentries, we should 
     * push nentries down to significantly less than maxentries, or else we'll 
     * just end up doing this again very soon.  We shoot for maxentries/2. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN156"><span class='Ref_to_Member'>iterating</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN138"><span class='Ref_to_EnumConst'>TBM_NOT_ITERATING</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN150"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="tidbitmap.c.html#LN130"><span class='Ref_to_EnumConst'>TBM_HASH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    pagetable_start_iterate_at<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1382"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN157"><span class='Ref_to_Member'>lossify_start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN1383"><span class='Ref_To_Local'>page</span></a> <span class='Operator'>= </span>pagetable_iterate<span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN151"><span class='Ref_to_Member'>pagetable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="tidbitmap.c.html#LN1382"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1383"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN101"><span class='Ref_to_Member'>ischunk</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* already a chunk header */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the page would become a chunk header, we won't save anything by 
         * converting it to lossy, so skip it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN1383"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>% </span><a href="tidbitmap.c.html#LN71"><span class='Ref_to_Const'>PAGES_PER_CHUNK</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* This does the dirty work ... */ 
</span>        <a href="tidbitmap.c.html#LN233"><span class='Ref_to_Proto'>tbm_mark_page_lossy</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1383"><span class='Ref_To_Local'>page</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&LT;= </span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We have made enough room. Remember where to start lossifying 
             * next round, so we evenly iterate over the hashtable. 
             */ 
</span>            <a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN157"><span class='Ref_to_Member'>lossify_start</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1382"><span class='Ref_To_Local'>i</span></a><span class='Operator'>.</span>cur<span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note: tbm_mark_page_lossy may have inserted a lossy chunk into the 
         * hashtable and may have deleted the non-lossy chunk.  We can 
         * continue the same hash table scan, since failure to visit one 
         * element or visiting the newly inserted element, isn't fatal. 
         */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (page=pagetable_itera... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * With a big bitmap and small work_mem, it's possible that we cannot get 
     * under maxentries.  Again, if that happens, we'd end up uselessly 
     * calling tbm_lossify over and over.  To prevent this from becoming a 
     * performance sink, force maxentries up to at least double the current 
     * number of entries.  (In essence, we're admitting inability to fit 
     * within work_mem when we do this.)  Note that this test will not fire if 
     * we broke out of the loop early; and if we didn't, the current number of 
     * entries is simply not reducible any further. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN153"><span class='Ref_to_Member'>maxentries</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1380"><span class='Ref_to_Parameter'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN152"><span class='Ref_to_Member'>nentries</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>INT_MAX <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_lossify &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * qsort comparator to handle PagetableEntry pointers. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1449"></a><span class='Declare_Function'>tbm_comparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>left</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>right</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1451"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>l</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1449"><span class='Ref_to_Parameter'>left</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Delimiter'>; 
</span><a name="LN1452"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>r</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>((</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Keyword'>const </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1449"><span class='Ref_to_Parameter'>right</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1451"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN1452"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1451"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN1452"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * As above, but this will get index into PagetableEntry array.  Therefore, 
 * it needs to get actual PagetableEntry using the index before comparing the 
 * blockno. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1467"></a><span class='Declare_Function'>tbm_shared_comparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>left</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>right</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1469"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1467"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span><a name="LN1470"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lpage</span> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1469"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1467"><span class='Ref_to_Parameter'>left</span></a><span class='Delimiter'>]; 
</span><a name="LN1471"></a>    <a href="tidbitmap.c.html#LN97"><span class='Ref_to_Struct'>PagetableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rpage</span> <span class='Operator'>= &</span><a href="tidbitmap.c.html#LN1469"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1467"><span class='Ref_to_Parameter'>right</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1470"><span class='Ref_To_Local'>lpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>&LT; </span><a href="tidbitmap.c.html#LN1471"><span class='Ref_To_Local'>rpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1470"><span class='Ref_To_Local'>lpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a> <span class='Operator'>&GT; </span><a href="tidbitmap.c.html#LN1471"><span class='Ref_To_Local'>rpage</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN99"><span class='Ref_to_Member'>blockno</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  tbm_attach_shared_iterate 
 * 
 *  Allocate a backend-private iterator and attach the shared iterator state 
 *  to it so that multiple processed can iterate jointly. 
 * 
 *  We also converts the DSA pointers to local pointers and store them into 
 *  our private iterator. 
 */ 
</span><a href="tidbitmap.c.html#LN216"><span class='Ref_to_Struct'>TBMSharedIterator</span></a> <span class='Operator'>* 
</span><a name="LN1490"></a><span class='Declare_Function'>tbm_attach_shared_iterate</span><span class='Parentheses'>(</span><a href="../utils/mmgr/dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dsa</span><span class='Delimiter'>, </span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>dp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1492"></a>    <a href="tidbitmap.c.html#LN216"><span class='Ref_to_Struct'>TBMSharedIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>iterator</span><span class='Delimiter'>; 
</span><a name="LN1493"></a>    <a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>istate</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the TBMSharedIterator struct, with enough trailing space to 
     * serve the needs of the TBMIterateResult sub-struct. 
     */ 
</span>    <a href="tidbitmap.c.html#LN1492"><span class='Ref_To_Local'>iterator</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN216"><span class='Ref_to_Struct'>TBMSharedIterator</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN216"><span class='Ref_to_Struct'>TBMSharedIterator</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                 <a href="tidbitmap.c.html#LN54"><span class='Ref_to_Const'>MAX_TUPLES_PER_PAGE</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN188"><span class='Ref_to_Struct'>TBMSharedIteratorState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1490"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1490"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN1492"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN218"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a><span class='Delimiter'>; 
</span> 
    <a href="tidbitmap.c.html#LN1492"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN219"><span class='Ref_to_Member'>ptbase</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1490"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN194"><span class='Ref_to_Member'>pagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN192"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN1492"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN220"><span class='Ref_to_Member'>ptpages</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1490"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN195"><span class='Ref_to_Member'>spages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN193"><span class='Ref_to_Member'>nchunks</span></a><span class='Parentheses'>) 
</span>        <a href="tidbitmap.c.html#LN1492"><span class='Ref_To_Local'>iterator</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN221"><span class='Ref_to_Member'>ptchunks</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1490"><span class='Ref_to_Parameter'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1493"><span class='Ref_To_Local'>istate</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN196"><span class='Ref_to_Member'>schunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1492"><span class='Ref_To_Local'>iterator</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tbm_attach_shared_iterate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pagetable_allocate 
 * 
 * Callback function for allocating the memory for hashtable elements. 
 * Allocate memory for hashtable elements, using DSA if available. 
 */ 
</span><span class='Keyword'>static inline void </span><span class='Operator'>* 
</span><a name="LN1523"></a><span class='Declare_Function'>pagetable_allocate</span><span class='Parentheses'>(</span>pagetable_hash <span class='Operator'>*</span><span class='Declare_Parameter'>pagetable</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1525"></a>    <a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tbm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1523"><span class='Ref_to_Parameter'>pagetable</span></a><span class='Operator'>-&GT;</span>private_data<span class='Delimiter'>; 
</span><a name="LN1526"></a>    <a href="tidbitmap.c.html#LN109"><span class='Ref_to_Struct'>PTEntryArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptbase</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/utils/palloc.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextAllocExtended</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1523"><span class='Ref_to_Parameter'>pagetable</span></a><span class='Operator'>-&GT;</span>ctx<span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1523"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../include/common/fe_memutils.h.html#LN15"><span class='Ref_to_Const'>MCXT_ALLOC_HUGE</span></a> <span class='Operator'>| </span><a href="../../include/common/fe_memutils.h.html#LN18"><span class='Ref_to_Const'>MCXT_ALLOC_ZERO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Save the dsapagetable reference in dsapagetableold before allocating 
     * new memory so that pagetable_free can free the old entry. 
     */ 
</span>    <a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN163"><span class='Ref_to_Member'>dsapagetableold</span></a> <span class='Operator'>= </span><a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN118"><span class='Ref_to_Proto'>dsa_allocate_extended</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, 
</span>                                              <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN109"><span class='Ref_to_Struct'>PTEntryArray</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="tidbitmap.c.html#LN1523"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../include/utils/dsa.h.html#LN72"><span class='Ref_to_Const'>DSA_ALLOC_HUGE</span></a> <span class='Operator'>| </span><a href="../../include/utils/dsa.h.html#LN74"><span class='Ref_to_Const'>DSA_ALLOC_ZERO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="tidbitmap.c.html#LN1526"><span class='Ref_To_Local'>ptbase</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1525"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN162"><span class='Ref_to_Member'>dsapagetable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="tidbitmap.c.html#LN1526"><span class='Ref_To_Local'>ptbase</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN112"><span class='Ref_to_Member'>ptentry</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pagetable_allocate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pagetable_free 
 * 
 * Callback function for freeing hash table elements. 
 */ 
</span><span class='Keyword'>static inline void 
</span><a name="LN1551"></a><span class='Declare_Function'>pagetable_free</span><span class='Parentheses'>(</span>pagetable_hash <span class='Operator'>*</span><span class='Declare_Parameter'>pagetable</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1553"></a>    <a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tbm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN146"><span class='Ref_to_Struct'>TIDBitmap</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="tidbitmap.c.html#LN1551"><span class='Ref_to_Parameter'>pagetable</span></a><span class='Operator'>-&GT;</span>private_data<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pfree the input pointer if DSA is not available */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1553"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1551"><span class='Ref_to_Parameter'>pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1553"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN163"><span class='Ref_to_Member'>dsapagetableold</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="tidbitmap.c.html#LN1553"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN166"><span class='Ref_to_Member'>dsa</span></a><span class='Delimiter'>, </span><a href="tidbitmap.c.html#LN1553"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN163"><span class='Ref_to_Member'>dsapagetableold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="tidbitmap.c.html#LN1553"><span class='Ref_To_Local'>tbm</span></a><span class='Operator'>-&GT;</span><a href="tidbitmap.c.html#LN163"><span class='Ref_to_Member'>dsapagetableold</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>