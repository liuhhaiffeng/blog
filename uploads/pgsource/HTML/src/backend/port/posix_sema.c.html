<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\port\posix_sema.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\port\posix_sema.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:45 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * posix_sema.c 
 *    Implement PGSemaphores using POSIX semaphore facilities 
 * 
 * We prefer the unnamed style of POSIX semaphore (the kind made with 
 * sem_init).  We can cope with the kind made with sem_open, however. 
 * 
 * In either implementation, typedef PGSemaphore is equivalent to "sem_t *". 
 * With unnamed semaphores, the sem_t structs live in an array in shared 
 * memory.  With named semaphores, that's not true because we cannot persuade 
 * sem_open to do its allocation there.  Therefore, the named-semaphore code 
 * *does not cope with EXEC_BACKEND*.  The sem_t structs will just be in the 
 * postmaster's private memory, where they are successfully inherited by 
 * forked backends, but they could not be accessed by exec'd backends. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/port/posix_sema.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;semaphore.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_sema.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/shmem.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* see file header comment */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>USE_NAMED_POSIX_SEMAPHORES<span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>EXEC_BACKEND<span class='Parentheses'>) 
</span>#error cannot use named POSIX semaphores with EXEC_BACKEND 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* typedef PGSemaphore is equivalent to pointer to sem_t */ 
</span><a name="LN44"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PGSemaphoreData</span> 
<span class='Delimiter'>{ 
</span><a name="LN46"></a>    sem_t       <span class='Declare_Member'>pgsem</span><span class='Delimiter'>; 
</span><a name="LN47"></a>} <span class='Declare_Typedef'>PGSemaphoreData</span><span class='Delimiter'>; 
</span> 
<a name="LN49"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PG_SEM_REF</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>)</span>   <span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pgsem<span class='Parentheses'>)</span> 
 
<a name="LN51"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>IPCProtection</span>   <span class='Parentheses'>(</span><span class='Number'>0600</span><span class='Parentheses'>)</span>  <span class='Comment_Single_Line'>/* access/modify by user only */ 
</span> 
<span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
<a name="LN54"></a><span class='Keyword'>static </span>sem_t <span class='Operator'>**</span><span class='Declare_Var'>mySemPointers</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* keep track of created semaphores */ 
</span><span class='Directive'>#else</span> 
<a name="LN56"></a><span class='Keyword'>static </span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Declare_Var'>sharedSemas</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* array of PGSemaphoreData in shared memory */ 
</span><span class='Directive'>#endif</span> 
<a name="LN58"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>numSems</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* number of semas acquired so far */ 
</span><a name="LN59"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>maxSems</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* allocated size of above arrays */ 
</span><a name="LN60"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nextSemKey</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* next name to try */ 
</span> 
 
<a name="LN63"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReleaseSemaphores</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
 
<span class='Comment_Multi_Line'>/* 
 * PosixSemaphoreCreate 
 * 
 * Attempt to create a new named semaphore. 
 * 
 * If we fail with a failure code other than collision-with-existing-sema, 
 * print out an error and abort.  Other types of errors suggest nonrecoverable 
 * problems. 
 */ 
</span><span class='Keyword'>static </span>sem_t <span class='Operator'>* 
</span><a name="LN78"></a><span class='Declare_Function'>PosixSemaphoreCreate</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN80"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>semKey</span><span class='Delimiter'>; 
</span><a name="LN81"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>semname</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN82"></a>    sem_t      <span class='Operator'>*</span><span class='Declare_Local'>mySem</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="posix_sema.c.html#LN80"><span class='Ref_To_Local'>semKey</span></a> <span class='Operator'>= </span><a href="posix_sema.c.html#LN60"><span class='Ref_to_Global_Var'>nextSemKey</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN81"><span class='Ref_To_Local'>semname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN81"><span class='Ref_To_Local'>semname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"/pgsql-%d"</span><span class='Delimiter'>, </span><a href="posix_sema.c.html#LN80"><span class='Ref_To_Local'>semKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="posix_sema.c.html#LN82"><span class='Ref_To_Local'>mySem</span></a> <span class='Operator'>= </span>sem_open<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN81"><span class='Ref_To_Local'>semname</span></a><span class='Delimiter'>, </span>O_CREAT <span class='Operator'>| </span>O_EXCL<span class='Delimiter'>, 
</span>                         <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN422"><span class='Ref_to_Typedef'>mode_t</span></a><span class='Parentheses'>) </span><a href="../../include/portability/mem.h.html#LN14"><span class='Ref_to_Const'>IPCProtection</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned</span><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> SEM_FAILED 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN82"><span class='Ref_To_Local'>mySem</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span>sem_t <span class='Operator'>*</span><span class='Parentheses'>) </span>SEM_FAILED<span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN82"><span class='Ref_To_Local'>mySem</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span>sem_t <span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* Loop if error indicates a collision */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EEXIST <span class='Operator'>|| </span>errno <span class='Operator'>== </span>EACCES <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Else complain and abort 
         */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"sem_open(\"%s\") failed: %m"</span><span class='Delimiter'>, </span><a href="posix_sema.c.html#LN81"><span class='Ref_To_Local'>semname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Unlink the semaphore immediately, so it can't be accessed externally. 
     * This also ensures that it will go away if we crash. 
     */ 
</span>    sem_unlink<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN81"><span class='Ref_To_Local'>semname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="posix_sema.c.html#LN82"><span class='Ref_To_Local'>mySem</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PosixSemaphoreCreate &raquo; </span> 
<span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !USE_NAMED_POSIX_SEMAPHORES */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PosixSemaphoreCreate 
 * 
 * Attempt to create a new unnamed semaphore. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN127"></a><span class='Declare_Function'>PosixSemaphoreCreate</span><span class='Parentheses'>(</span>sem_t <span class='Operator'>*</span><span class='Declare_Parameter'>sem</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sem_init<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN127"><span class='Ref_to_Parameter'>sem</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"sem_init failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_NAMED_POSIX_SEMAPHORES */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * PosixSemaphoreKill   - removes a semaphore 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN139"></a><span class='Declare_Function'>PosixSemaphoreKill</span><span class='Parentheses'>(</span>sem_t <span class='Operator'>*</span><span class='Declare_Parameter'>sem</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
    <span class='Comment_Multi_Line'>/* Got to use sem_close for named semaphores */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sem_close<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN139"><span class='Ref_to_Parameter'>sem</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"sem_close failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* Got to use sem_destroy for unnamed semaphores */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sem_destroy<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN139"><span class='Ref_to_Parameter'>sem</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"sem_destroy failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Report amount of shared memory needed for semaphores 
 */ 
</span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN157"></a><span class='Declare_Function'>PGSemaphoreShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxSemas</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
    <span class='Comment_Multi_Line'>/* No shared memory needed in this case */ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* Need a PGSemaphoreData per semaphore */ 
</span>    <span class='Control'>return</span> <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN157"><span class='Ref_to_Parameter'>maxSemas</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="sysv_sema.c.html#LN32"><span class='Ref_to_Struct'>PGSemaphoreData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PGReserveSemaphores --- initialize semaphore support 
 * 
 * This is called during postmaster start or shared memory reinitialization. 
 * It should do whatever is needed to be able to support up to maxSemas 
 * subsequent PGSemaphoreCreate calls.  Also, if any system resources 
 * are acquired here or in PGSemaphoreCreate, register an on_shmem_exit 
 * callback to release them. 
 * 
 * The port number is passed for possible use as a key (for Posix, we use 
 * it to generate the starting semaphore name).  In a standalone backend, 
 * zero will be passed. 
 * 
 * In the Posix implementation, we acquire semaphores on-demand; the 
 * maxSemas parameter is just used to size the arrays.  For unnamed 
 * semaphores, there is an array of PGSemaphoreData structs in shared memory. 
 * For named semaphores, we keep a postmaster-local array of sem_t pointers, 
 * which we use for releasing the semphores when done. 
 * (This design minimizes the dependency of postmaster shutdown on the 
 * contents of shared memory, which a failed backend might have clobbered. 
 * We can't do much about the possibility of sem_destroy() crashing, but 
 * we don't have to expose the counters to other processes.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN192"></a><span class='Declare_Function'>PGReserveSemaphores</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>maxSemas</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
    <a href="posix_sema.c.html#LN54"><span class='Ref_to_Global_Var'>mySemPointers</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>sem_t <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN192"><span class='Ref_to_Parameter'>maxSemas</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>sem_t <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN54"><span class='Ref_to_Global_Var'>mySemPointers</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We must use ShmemAllocUnlocked(), since the spinlock protecting 
     * ShmemAlloc() won't be ready yet.  (This ordering is necessary when we 
     * are emulating spinlocks with semaphores.) 
     */ 
</span>    <a href="posix_sema.c.html#LN56"><span class='Ref_to_Global_Var'>sharedSemas</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN38"><span class='Ref_to_Proto'>ShmemAllocUnlocked</span></a><span class='Parentheses'>(</span><a href="win32_sema.c.html#LN29"><span class='Ref_to_Func'>PGSemaphoreShmemSize</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN192"><span class='Ref_to_Parameter'>maxSemas</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="win32_sema.c.html#LN21"><span class='Ref_to_Global_Var'>maxSems</span></a> <span class='Operator'>= </span><a href="posix_sema.c.html#LN192"><span class='Ref_to_Parameter'>maxSemas</span></a><span class='Delimiter'>; 
</span>    <a href="posix_sema.c.html#LN60"><span class='Ref_to_Global_Var'>nextSemKey</span></a> <span class='Operator'>= </span><a href="posix_sema.c.html#LN192"><span class='Ref_to_Parameter'>port</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/ipc.h.html#LN69"><span class='Ref_to_Proto'>on_shmem_exit</span></a><span class='Parentheses'>(</span><a href="win32_sema.c.html#LN23"><span class='Ref_to_Proto'>ReleaseSemaphores</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PGReserveSemaphores &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Release semaphores at shutdown or shmem reinitialization 
 * 
 * (called as an on_shmem_exit callback, hence funny argument list) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN222"></a><span class='Declare_Function'>ReleaseSemaphores</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN224"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a><span class='Delimiter'>; </span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="posix_sema.c.html#LN138"><span class='Ref_to_Func'>PosixSemaphoreKill</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN54"><span class='Ref_to_Global_Var'>mySemPointers</span></a><span class='Delimiter'>[</span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN54"><span class='Ref_to_Global_Var'>mySemPointers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> USE_UNNAMED_POSIX_SEMAPHORES 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a><span class='Delimiter'>; </span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="posix_sema.c.html#LN138"><span class='Ref_to_Func'>PosixSemaphoreKill</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Macro'>PG_SEM_REF</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN56"><span class='Ref_to_Global_Var'>sharedSemas</span></a> <span class='Operator'>+ </span><a href="posix_sema.c.html#LN224"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PGSemaphoreCreate 
 * 
 * Allocate a PGSemaphore structure with initial count 1 
 */ 
</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> 
<a name="LN244"></a><span class='Declare_Function'>PGSemaphoreCreate</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN246"></a>    <a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Declare_Local'>sema</span><span class='Delimiter'>; 
</span><a name="LN247"></a>    sem_t      <span class='Operator'>*</span><span class='Declare_Local'>newsem</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can't do this in a backend, because static state is postmaster's */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a> <span class='Operator'>&GT;= </span><a href="win32_sema.c.html#LN21"><span class='Ref_to_Global_Var'>maxSems</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"too many semaphores created"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_NAMED_POSIX_SEMAPHORES 
    <a href="posix_sema.c.html#LN247"><span class='Ref_To_Local'>newsem</span></a> <span class='Operator'>= </span><a href="posix_sema.c.html#LN77"><span class='Ref_to_Func'>PosixSemaphoreCreate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Remember new sema for ReleaseSemaphores */ 
</span>    <a href="posix_sema.c.html#LN54"><span class='Ref_to_Global_Var'>mySemPointers</span></a><span class='Delimiter'>[</span><a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="posix_sema.c.html#LN247"><span class='Ref_To_Local'>newsem</span></a><span class='Delimiter'>; 
</span>    <a href="posix_sema.c.html#LN246"><span class='Ref_To_Local'>sema</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a><span class='Parentheses'>) </span><a href="posix_sema.c.html#LN247"><span class='Ref_To_Local'>newsem</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="posix_sema.c.html#LN246"><span class='Ref_To_Local'>sema</span></a> <span class='Operator'>= &</span><a href="posix_sema.c.html#LN56"><span class='Ref_to_Global_Var'>sharedSemas</span></a><span class='Delimiter'>[</span><a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a><span class='Delimiter'>]; 
</span>    <a href="posix_sema.c.html#LN247"><span class='Ref_To_Local'>newsem</span></a> <span class='Operator'>= </span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Macro'>PG_SEM_REF</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN246"><span class='Ref_To_Local'>sema</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="posix_sema.c.html#LN77"><span class='Ref_to_Func'>PosixSemaphoreCreate</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN247"><span class='Ref_To_Local'>newsem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="win32_sema.c.html#LN20"><span class='Ref_to_Global_Var'>numSems</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="posix_sema.c.html#LN246"><span class='Ref_To_Local'>sema</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PGSemaphoreCreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PGSemaphoreReset 
 * 
 * Reset a previously-initialized PGSemaphore to have count 0 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN277"></a><span class='Declare_Function'>PGSemaphoreReset</span><span class='Parentheses'>(</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Declare_Parameter'>sema</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * There's no direct API for this in POSIX, so we have to ratchet the 
     * semaphore down to 0 with repeated trywait's. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>sem_trywait<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Macro'>PG_SEM_REF</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN277"><span class='Ref_to_Parameter'>sema</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span>EDEADLK<span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* got it down to 0 */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* can this happen? */ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"sem_trywait failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PGSemaphoreLock 
 * 
 * Lock a semaphore (decrement count), blocking if count would be &LT; 0 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN302"></a><span class='Declare_Function'>PGSemaphoreLock</span><span class='Parentheses'>(</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Declare_Parameter'>sema</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN304"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>errStatus</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See notes in sysv_sema.c's implementation of PGSemaphoreLock. */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="posix_sema.c.html#LN304"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>= </span>sem_wait<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Macro'>PG_SEM_REF</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN302"><span class='Ref_to_Parameter'>sema</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN304"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN304"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"sem_wait failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PGSemaphoreUnlock 
 * 
 * Unlock a semaphore (increment count) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN322"></a><span class='Declare_Function'>PGSemaphoreUnlock</span><span class='Parentheses'>(</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Declare_Parameter'>sema</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN324"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>errStatus</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: if errStatus is -1 and errno == EINTR then it means we returned 
     * from the operation prematurely because we were sent a signal.  So we 
     * try and unlock the semaphore again. Not clear this can really happen, 
     * but might as well cope. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="posix_sema.c.html#LN324"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>= </span>sem_post<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Macro'>PG_SEM_REF</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN322"><span class='Ref_to_Parameter'>sema</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN324"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN324"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"sem_post failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PGSemaphoreTryLock 
 * 
 * Lock a semaphore only if able to do so without blocking 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN347"></a><span class='Declare_Function'>PGSemaphoreTryLock</span><span class='Parentheses'>(</span><a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Declare_Parameter'>sema</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN349"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>errStatus</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: if errStatus is -1 and errno == EINTR then it means we returned 
     * from the operation prematurely because we were sent a signal.  So we 
     * try and lock the semaphore again. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="posix_sema.c.html#LN349"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>= </span>sem_trywait<span class='Parentheses'>(</span><a href="posix_sema.c.html#LN49"><span class='Ref_to_Macro'>PG_SEM_REF</span></a><span class='Parentheses'>(</span><a href="posix_sema.c.html#LN347"><span class='Ref_to_Parameter'>sema</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN349"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="posix_sema.c.html#LN349"><span class='Ref_To_Local'>errStatus</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span>EDEADLK<span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* failed to lock it */ 
</span>        <span class='Comment_Multi_Line'>/* Otherwise we got trouble */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"sem_trywait failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PGSemaphoreTryLock &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>