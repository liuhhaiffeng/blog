<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\port\win32_shmem.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\port\win32_shmem.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:45 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * win32_shmem.c 
 *    Implement shared memory using win32 facilities 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/backend/port/win32_shmem.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/dsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_shmem.h"</span> 
 
<a name="LN19"></a>HANDLE      <span class='Declare_Var'>UsedShmemSegID</span> <span class='Operator'>= </span>INVALID_HANDLE_VALUE<span class='Delimiter'>; 
</span><a name="LN20"></a><span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Var'>UsedShmemSegAddr</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN21"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Var'>UsedShmemSegSize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN23"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgwin32_SharedMemoryDelete</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>shmId</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Generate shared memory segment name. Expand the data directory, to generate 
 * an identifier unique for this data directory. Then replace all backslashes 
 * with forward slashes, since backslashes aren't permitted in global object names. 
 * 
 * Store the shared memory segment in the Global\ namespace (requires NT2 TSE or 
 * 2000, but that's all we support for other reasons as well), to make sure you can't 
 * open two postmasters in different sessions against the same data directory. 
 * 
 * XXX: What happens with junctions? It's only someone breaking things on purpose, 
 *      and this is still better than before, but we might want to do something about 
 *      that sometime in the future. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN39"></a><span class='Declare_Function'>GetSharedMemName</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN41"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>retptr</span><span class='Delimiter'>; 
</span><a name="LN42"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>bufsize</span><span class='Delimiter'>; 
</span><a name="LN43"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><a name="LN44"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cp</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN42"><span class='Ref_To_Local'>bufsize</span></a> <span class='Operator'>= </span>GetFullPathName<span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN42"><span class='Ref_To_Local'>bufsize</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"could not get size for full pathname of datadir %s: error code %lu"</span><span class='Delimiter'>, 
</span>             <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN41"><span class='Ref_To_Local'>retptr</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN42"><span class='Ref_To_Local'>bufsize</span></a> <span class='Operator'>+ </span><span class='Number'>18</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* 18 for Global\PostgreSQL: */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN41"><span class='Ref_To_Local'>retptr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"could not allocate memory for shared memory name"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN41"><span class='Ref_To_Local'>retptr</span></a><span class='Delimiter'>, </span><span class='String'>"Global\\PostgreSQL:"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN43"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>GetFullPathName<span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN42"><span class='Ref_To_Local'>bufsize</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN41"><span class='Ref_To_Local'>retptr</span></a> <span class='Operator'>+ </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN43"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="win32_shmem.c.html#LN43"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&GT; </span><a href="win32_shmem.c.html#LN42"><span class='Ref_To_Local'>bufsize</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"could not generate full pathname for datadir %s: error code %lu"</span><span class='Delimiter'>, 
</span>             <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX: Intentionally overwriting the Global\ part here. This was not the 
     * original approach, but putting it in the actual Global\ namespace 
     * causes permission errors in a lot of cases, so we leave it in the 
     * default namespace for now. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN44"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN41"><span class='Ref_To_Local'>retptr</span></a><span class='Delimiter'>; </span><span class='Operator'>*</span><a href="win32_shmem.c.html#LN44"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>; </span><a href="win32_shmem.c.html#LN44"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="win32_shmem.c.html#LN44"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>== </span><span class='String'>'\\'</span><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="win32_shmem.c.html#LN44"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>= </span><span class='String'>'/'</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="win32_shmem.c.html#LN41"><span class='Ref_To_Local'>retptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetSharedMemName &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PGSharedMemoryIsInUse 
 * 
 * Is a previously-existing shmem segment still existing and in use? 
 * 
 * The point of this exercise is to detect the case where a prior postmaster 
 * crashed, but it left child backends that are still running.  Therefore 
 * we only care about shmem segments that are associated with the intended 
 * DataDir.  This is an important consideration since accidental matches of 
 * shmem segment IDs are reasonably common. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN87"></a><span class='Declare_Function'>PGSharedMemoryIsInUse</span><span class='Parentheses'>(</span><span class='Keyword'>unsigned long </span><span class='Declare_Parameter'>id1</span><span class='Delimiter'>, </span><span class='Keyword'>unsigned long </span><span class='Declare_Parameter'>id2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN89"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>szShareMem</span><span class='Delimiter'>; 
</span><a name="LN90"></a>    HANDLE      <span class='Declare_Local'>hmap</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN89"><span class='Ref_To_Local'>szShareMem</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN38"><span class='Ref_to_Func'>GetSharedMemName</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN90"><span class='Ref_To_Local'>hmap</span></a> <span class='Operator'>= </span>OpenFileMapping<span class='Parentheses'>(</span>FILE_MAP_READ<span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN89"><span class='Ref_To_Local'>szShareMem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN89"><span class='Ref_To_Local'>szShareMem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN90"><span class='Ref_To_Local'>hmap</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    CloseHandle<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN90"><span class='Ref_To_Local'>hmap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * PGSharedMemoryCreate 
 * 
 * Create a shared memory segment of the given size and initialize its 
 * standard header. 
 * 
 * makePrivate means to always create a new segment, rather than attach to 
 * or recycle any existing segment. On win32, we always create a new segment, 
 * since there is no need for recycling (segments go away automatically 
 * when the last backend exits) 
 */ 
</span><a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>* 
</span><a name="LN118"></a><span class='Declare_Function'>PGSharedMemoryCreate</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>makePrivate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, 
</span><a name="LN119"></a>                     <a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>shim</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN121"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>memAddress</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    HANDLE      <span class='Declare_Local'>hmap</span><span class='Delimiter'>, 
</span><a name="LN124"></a>                <span class='Declare_Local'>hmap2</span><span class='Delimiter'>; 
</span><a name="LN125"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>szShareMem</span><span class='Delimiter'>; 
</span><a name="LN126"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN127"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>size_high</span><span class='Delimiter'>; 
</span><a name="LN128"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>size_low</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN486"><span class='Ref_to_Global_Var'>huge_pages</span></a> <span class='Operator'>== </span><a href="../../include/storage/pg_shmem.h.html#LN50"><span class='Ref_to_EnumConst'>HUGE_PAGES_ON</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"huge pages not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Room for a header? */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN118"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN125"><span class='Ref_To_Local'>szShareMem</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN38"><span class='Ref_to_Func'>GetSharedMemName</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> _WIN64 
    <a href="win32_shmem.c.html#LN127"><span class='Ref_To_Local'>size_high</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN118"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="win32_shmem.c.html#LN127"><span class='Ref_To_Local'>size_high</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="win32_shmem.c.html#LN128"><span class='Ref_To_Local'>size_low</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>DWORD</span><span class='Parentheses'>) </span><a href="win32_shmem.c.html#LN118"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When recycling a shared memory segment, it may take a short while 
     * before it gets dropped from the global namespace. So re-try after 
     * sleeping for a second, and continue retrying 10 times. (both the 1 
     * second time and the 10 retries are completely arbitrary) 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN126"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="win32_shmem.c.html#LN126"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>10</span><span class='Delimiter'>; </span><a href="win32_shmem.c.html#LN126"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * In case CreateFileMapping() doesn't set the error code to 0 on 
         * success 
         */ 
</span>        SetLastError<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a> <span class='Operator'>= </span>CreateFileMapping<span class='Parentheses'>(</span>INVALID_HANDLE_VALUE<span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* Use the pagefile */ 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* Default security attrs */ 
</span>                                 PAGE_READWRITE<span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* Memory is Read/Write */ 
</span>                                 <a href="win32_shmem.c.html#LN127"><span class='Ref_To_Local'>size_high</span></a><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* Size Upper 32 Bits   */ 
</span>                                 <a href="win32_shmem.c.html#LN128"><span class='Ref_To_Local'>size_low</span></a><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* Size Lower 32 bits */ 
</span>                                 <a href="win32_shmem.c.html#LN125"><span class='Ref_To_Local'>szShareMem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create shared memory segment: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed system call was CreateFileMapping(size=%zu, name=%s)."</span><span class='Delimiter'>, 
</span>                               <a href="win32_shmem.c.html#LN118"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN125"><span class='Ref_To_Local'>szShareMem</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the segment already existed, CreateFileMapping() will return a 
         * handle to the existing one and set ERROR_ALREADY_EXISTS. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>GetLastError<span class='Parentheses'>() </span><span class='Operator'>== </span>ERROR_ALREADY_EXISTS<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            CloseHandle<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Multi_Line'>/* Close the handle, since we got a valid one 
                                 * to the previous segment. */ 
</span>            <a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            Sleep<span class='Parentheses'>(</span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;10;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If the last call in the loop still returned ERROR_ALREADY_EXISTS, this 
     * shared memory segment exists and we assume it belongs to somebody else. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pre-existing shared memory block is still in use"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Check if there are any old server processes still running, and terminate them."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN125"><span class='Ref_To_Local'>szShareMem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make the handle inheritable 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>DuplicateHandle<span class='Parentheses'>(</span>GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a><span class='Delimiter'>, </span>GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="win32_shmem.c.html#LN124"><span class='Ref_To_Local'>hmap2</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span>DUPLICATE_SAME_ACCESS<span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create shared memory segment: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed system call was DuplicateHandle."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close the old, non-inheritable handle. If this fails we don't really 
     * care. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CloseHandle<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN123"><span class='Ref_To_Local'>hmap</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not close handle to shared memory: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Get a pointer to the new shared memory segment. Map the whole segment 
     * at once, and let the system decide on the initial address. 
     */ 
</span>    <a href="win32_shmem.c.html#LN121"><span class='Ref_To_Local'>memAddress</span></a> <span class='Operator'>= </span>MapViewOfFileEx<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN124"><span class='Ref_To_Local'>hmap2</span></a><span class='Delimiter'>, </span>FILE_MAP_WRITE <span class='Operator'>| </span>FILE_MAP_READ<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="win32_shmem.c.html#LN121"><span class='Ref_To_Local'>memAddress</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create shared memory segment: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed system call was MapViewOfFileEx."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
 
 
    <span class='Comment_Multi_Line'>/* 
     * OK, we created a new segment.  Mark it as created by this process. The 
     * order of assignments here is critical so that another Postgres process 
     * can't see the header as valid but belonging to an invalid PID! 
     */ 
</span>    <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="win32_shmem.c.html#LN121"><span class='Ref_To_Local'>memAddress</span></a><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN32"><span class='Ref_to_Member'>creatorPID</span></a> <span class='Operator'>= </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN30"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="../../include/storage/pg_shmem.h.html#LN31"><span class='Ref_to_Const'>PGShmemMagic</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize space allocation status for segment. 
     */ 
</span>    <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN33"><span class='Ref_to_Member'>totalsize</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN118"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN34"><span class='Ref_to_Member'>freeoffset</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN35"><span class='Ref_to_Member'>dsm_control</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Save info for possible future use */ 
</span>    <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN121"><span class='Ref_To_Local'>memAddress</span></a><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN21"><span class='Ref_to_Global_Var'>UsedShmemSegSize</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN118"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    <a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN124"><span class='Ref_To_Local'>hmap2</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Register on-exit routine to delete the new segment */ 
</span>    <a href="../../include/storage/ipc.h.html#LN69"><span class='Ref_to_Proto'>on_shmem_exit</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN23"><span class='Ref_to_Proto'>pgwin32_SharedMemoryDelete</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN124"><span class='Ref_To_Local'>hmap2</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="win32_shmem.c.html#LN119"><span class='Ref_to_Parameter'>shim</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="win32_shmem.c.html#LN122"><span class='Ref_To_Local'>hdr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PGSharedMemoryCreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PGSharedMemoryReAttach 
 * 
 * This is called during startup of a postmaster child process to re-attach to 
 * an already existing shared memory segment, using the handle inherited from 
 * the postmaster. 
 * 
 * UsedShmemSegID and UsedShmemSegAddr are implicit parameters to this 
 * routine.  The caller must have already restored them to the postmaster's 
 * values. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN270"></a><span class='Declare_Function'>PGSharedMemoryReAttach</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN272"></a>    <a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hdr</span><span class='Delimiter'>; 
</span><a name="LN273"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>origUsedShmemSegAddr</span> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release memory region reservation that was made by the postmaster 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>VirtualFree<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>MEM_RELEASE<span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"failed to release reserved memory region (addr=%p): error code %lu"</span><span class='Delimiter'>, 
</span>             <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>MapViewOfFileEx<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a><span class='Delimiter'>, </span>FILE_MAP_READ <span class='Operator'>| </span>FILE_MAP_WRITE<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"could not reattach to shared memory (key=%p, addr=%p): error code %lu"</span><span class='Delimiter'>, 
</span>             <a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a> <span class='Operator'>!= </span><a href="win32_shmem.c.html#LN273"><span class='Ref_To_Local'>origUsedShmemSegAddr</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"reattaching to shared memory returned unexpected address (got %p, expected %p)"</span><span class='Delimiter'>, 
</span>             <a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN273"><span class='Ref_To_Local'>origUsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN30"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>!= </span><a href="../../include/storage/pg_shmem.h.html#LN31"><span class='Ref_to_Const'>PGShmemMagic</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"reattaching to shared memory returned non-PostgreSQL memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/dsm.h.html#LN32"><span class='Ref_to_Proto'>dsm_set_control_handle</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/pg_shmem.h.html#LN35"><span class='Ref_to_Member'>dsm_control</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><a href="win32_shmem.c.html#LN272"><span class='Ref_To_Local'>hdr</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* probably redundant */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PGSharedMemoryReAttach &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PGSharedMemoryNoReAttach 
 * 
 * This is called during startup of a postmaster child process when we choose 
 * *not* to re-attach to the existing shared memory segment.  We must clean up 
 * to leave things in the appropriate state. 
 * 
 * The child process startup logic might or might not call PGSharedMemoryDetach 
 * after this; make sure that it will be a no-op if called. 
 * 
 * UsedShmemSegID and UsedShmemSegAddr are implicit parameters to this 
 * routine.  The caller must have already restored them to the postmaster's 
 * values. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN314"></a><span class='Declare_Function'>PGSharedMemoryNoReAttach</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Under Windows we will not have mapped the segment, so we don't need to 
     * un-map it.  Just reset UsedShmemSegAddr to show we're not attached. 
     */ 
</span>    <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We *must* close the inherited shmem segment handle, else Windows will 
     * consider the existence of this process to mean it can't release the 
     * shmem segment yet.  We can now use PGSharedMemoryDetach to do that. 
     */ 
</span>    <a href="../../include/storage/pg_shmem.h.html#LN69"><span class='Ref_to_Proto'>PGSharedMemoryDetach</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PGSharedMemoryDetach 
 * 
 * Detach from the shared memory segment, if still attached.  This is not 
 * intended to be called explicitly by the process that originally created the 
 * segment (it will have an on_shmem_exit callback registered to do that). 
 * Rather, this is for subprocesses that have inherited an attachment and want 
 * to get rid of it. 
 * 
 * UsedShmemSegID and UsedShmemSegAddr are implicit parameters to this 
 * routine. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN346"></a><span class='Declare_Function'>PGSharedMemoryDetach</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Unmap the view, if it's mapped */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>UnmapViewOfFile<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>))</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not unmap view of shared memory: error code %lu"</span><span class='Delimiter'>, 
</span>                 GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* And close the shmem handle, if we have one */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a> <span class='Operator'>!= </span>INVALID_HANDLE_VALUE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CloseHandle<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a><span class='Parentheses'>))</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not close handle to shared memory: error code %lu"</span><span class='Delimiter'>, 
</span>                 GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a> <span class='Operator'>= </span>INVALID_HANDLE_VALUE<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PGSharedMemoryDetach &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * pgwin32_SharedMemoryDelete 
 * 
 * Detach from and delete the shared memory segment 
 * (called as an on_shmem_exit callback, hence funny argument list) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN377"></a><span class='Declare_Function'>pgwin32_SharedMemoryDelete</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>shmId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN377"><span class='Ref_to_Parameter'>shmId</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/pg_shmem.h.html#LN69"><span class='Ref_to_Proto'>PGSharedMemoryDetach</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pgwin32_ReserveSharedMemoryRegion(hChild) 
 * 
 * Reserve the memory region that will be used for shared memory in a child 
 * process. It is called before the child process starts, to make sure the 
 * memory is available. 
 * 
 * Once the child starts, DLLs loading in different order or threads getting 
 * scheduled differently may allocate memory which can conflict with the 
 * address space we need for our shared memory. By reserving the shared 
 * memory region before the child starts, and freeing it only just before we 
 * attempt to get access to the shared memory forces these allocations to 
 * be given different address ranges that don't conflict. 
 * 
 * NOTE! This function executes in the postmaster, and should for this 
 * reason not use elog(FATAL) since that would take down the postmaster. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN401"></a><span class='Declare_Function'>pgwin32_ReserveSharedMemoryRegion</span><span class='Parentheses'>(</span>HANDLE <span class='Declare_Parameter'>hChild</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN403"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN21"><span class='Ref_to_Global_Var'>UsedShmemSegSize</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="win32_shmem.c.html#LN403"><span class='Ref_To_Local'>address</span></a> <span class='Operator'>= </span>VirtualAllocEx<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN401"><span class='Ref_to_Parameter'>hChild</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN21"><span class='Ref_to_Global_Var'>UsedShmemSegSize</span></a><span class='Delimiter'>, 
</span>                             MEM_RESERVE<span class='Delimiter'>, </span>PAGE_READWRITE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN403"><span class='Ref_To_Local'>address</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Don't use FATAL since we're running in the postmaster */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not reserve shared memory region (addr=%p) for child %p: error code %lu"</span><span class='Delimiter'>, 
</span>             <a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN401"><span class='Ref_to_Parameter'>hChild</span></a><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN403"><span class='Ref_To_Local'>address</span></a> <span class='Operator'>!= </span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Should never happen - in theory if allocation granularity causes 
         * strange effects it could, so check just in case. 
         * 
         * Don't use FATAL since we're running in the postmaster. 
         */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"reserved shared memory region got incorrect address %p, expected %p"</span><span class='Delimiter'>, 
</span>             <a href="win32_shmem.c.html#LN403"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        VirtualFreeEx<span class='Parentheses'>(</span><a href="win32_shmem.c.html#LN401"><span class='Ref_to_Parameter'>hChild</span></a><span class='Delimiter'>, </span><a href="win32_shmem.c.html#LN403"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>MEM_RELEASE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgwin32_ReserveSharedMemoryRegion &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>