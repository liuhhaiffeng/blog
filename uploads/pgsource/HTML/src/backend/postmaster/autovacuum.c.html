<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\postmaster\autovacuum.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\postmaster\autovacuum.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:45 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * autovacuum.c 
 * 
 * PostgreSQL Integrated Autovacuum Daemon 
 * 
 * The autovacuum system is structured in two different kinds of processes: the 
 * autovacuum launcher and the autovacuum worker.  The launcher is an 
 * always-running process, started by the postmaster when the autovacuum GUC 
 * parameter is set.  The launcher schedules autovacuum workers to be started 
 * when appropriate.  The workers are the processes which execute the actual 
 * vacuuming; they connect to a database as determined in the launcher, and 
 * once connected they examine the catalogs to select the tables to vacuum. 
 * 
 * The autovacuum launcher cannot start the worker processes by itself, 
 * because doing so would cause robustness issues (namely, failure to shut 
 * them down on exceptional conditions, and also, since the launcher is 
 * connected to shared memory and is thus subject to corruption there, it is 
 * not as robust as the postmaster).  So it leaves that task to the postmaster. 
 * 
 * There is an autovacuum shared memory area, where the launcher stores 
 * information about the database it wants vacuumed.  When it wants a new 
 * worker to start, it sets a flag in shared memory and sends a signal to the 
 * postmaster.  Then postmaster knows nothing more than it must start a worker; 
 * so it forks a new child, which turns into a worker.  This new process 
 * connects to shared memory, and there it can inspect the information that the 
 * launcher has set up. 
 * 
 * If the fork() call fails in the postmaster, it sets a flag in the shared 
 * memory area, and sends a signal to the launcher.  The launcher, upon 
 * noticing the flag, can try starting the worker again by resending the 
 * signal.  Note that the failure can only be transient (fork failure due to 
 * high load, memory pressure, too many processes, etc); more permanent 
 * problems, like failure to connect to a database, are detected later in the 
 * worker and dealt with just by having the worker exit normally.  The launcher 
 * will launch a new worker again later, per schedule. 
 * 
 * When the worker is done vacuuming it sends SIGUSR2 to the launcher.  The 
 * launcher then wakes up and is able to launch another worker, if the schedule 
 * is so tight that a new worker is needed immediately.  At this time the 
 * launcher can also balance the settings for the various remaining workers' 
 * cost-based vacuum delay feature. 
 * 
 * Note that there can be more than one worker in a database concurrently. 
 * They will store the table they are currently vacuuming in shared memory, so 
 * that other workers avoid being blocked waiting for the vacuum lock for that 
 * table.  They will also reload the pgstats data just before vacuuming each 
 * table, to avoid vacuuming a table that was just finished being vacuumed by 
 * another worker and thus is no longer noted in shared memory.  However, 
 * there is a window (caused by pgstat delay) on which a worker may choose a 
 * table that was already vacuumed; this is a bug in the current design. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/postmaster/autovacuum.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/reloptions.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_database.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/dbcommands.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/vacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/ilist.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/fork_process.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/latch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pmsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinvaladt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dsa.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgrprotos.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ps_status.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timeout.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * GUC parameters 
 */ 
</span><a name="LN111"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>autovacuum_start_daemon</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN112"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_max_workers</span><span class='Delimiter'>; 
</span><a name="LN113"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_work_mem</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN114"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_naptime</span><span class='Delimiter'>; 
</span><a name="LN115"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_vac_thresh</span><span class='Delimiter'>; 
</span><a name="LN116"></a><span class='Keyword'>double</span>      <span class='Declare_Var'>autovacuum_vac_scale</span><span class='Delimiter'>; 
</span><a name="LN117"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_anl_thresh</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>double</span>      <span class='Declare_Var'>autovacuum_anl_scale</span><span class='Delimiter'>; 
</span><a name="LN119"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_freeze_max_age</span><span class='Delimiter'>; 
</span><a name="LN120"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_multixact_freeze_max_age</span><span class='Delimiter'>; 
</span> 
<a name="LN122"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_vac_cost_delay</span><span class='Delimiter'>; 
</span><a name="LN123"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>autovacuum_vac_cost_limit</span><span class='Delimiter'>; 
</span> 
<a name="LN125"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Log_autovacuum_min_duration</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* how long to keep pgstat data in the launcher, in milliseconds */ 
</span><a name="LN128"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>STATS_READ_DELAY</span> <span class='Number'>1000</span> 
 
<span class='Comment_Multi_Line'>/* the minimum allowed time between two awakenings of the launcher */ 
</span><a name="LN131"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MIN_AUTOVAC_SLEEPTIME</span> <span class='Number'>100</span><span class='Operator'>.</span><span class='Number'>0</span>     <span class='Comment_Single_Line'>/* milliseconds */ 
</span><a name="LN132"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_AUTOVAC_SLEEPTIME</span> <span class='Number'>300</span>       <span class='Comment_Single_Line'>/* seconds */ 
</span> 
<span class='Comment_Multi_Line'>/* Flags to tell if we are in an autovacuum process */ 
</span><a name="LN135"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>am_autovacuum_launcher</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN136"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>am_autovacuum_worker</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Flags set by signal handlers */ 
</span><a name="LN139"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>got_SIGHUP</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN140"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>got_SIGUSR2</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN141"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>got_SIGTERM</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Comparison points for determining whether freeze_max_age is exceeded */ 
</span><a name="LN144"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>recentXid</span><span class='Delimiter'>; 
</span><a name="LN145"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Var'>recentMulti</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Default freeze ages to use for autovacuum (varies by database) */ 
</span><a name="LN148"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>default_freeze_min_age</span><span class='Delimiter'>; 
</span><a name="LN149"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>default_freeze_table_age</span><span class='Delimiter'>; 
</span><a name="LN150"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>default_multixact_freeze_min_age</span><span class='Delimiter'>; 
</span><a name="LN151"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>default_multixact_freeze_table_age</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Memory context for long-lived data */ 
</span><a name="LN154"></a><span class='Keyword'>static </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>AutovacMemCxt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* struct to keep track of databases in launcher */ 
</span><a name="LN157"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>avl_dbase</span> 
<span class='Delimiter'>{ 
</span><a name="LN159"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>adl_datid</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* hash key -- must be first */ 
</span><a name="LN160"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>adl_next_worker</span><span class='Delimiter'>; 
</span><a name="LN161"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>adl_score</span><span class='Delimiter'>; 
</span><a name="LN162"></a>    <a href="../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>adl_node</span><span class='Delimiter'>; 
</span><a name="LN163"></a>} <span class='Declare_Typedef'>avl_dbase</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* struct to keep track of databases in worker */ 
</span><a name="LN166"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>avw_dbase</span> 
<span class='Delimiter'>{ 
</span><a name="LN168"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>adw_datid</span><span class='Delimiter'>; 
</span><a name="LN169"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>adw_name</span><span class='Delimiter'>; 
</span><a name="LN170"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>adw_frozenxid</span><span class='Delimiter'>; 
</span><a name="LN171"></a>    <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Member'>adw_minmulti</span><span class='Delimiter'>; 
</span><a name="LN172"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Member'>adw_entry</span><span class='Delimiter'>; 
</span><a name="LN173"></a>} <span class='Declare_Typedef'>avw_dbase</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* struct to keep track of tables to vacuum and/or analyze, in 1st pass */ 
</span><a name="LN176"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>av_relation</span> 
<span class='Delimiter'>{ 
</span><a name="LN178"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>ar_toastrelid</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* hash key - must be first */ 
</span><a name="LN179"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>ar_relid</span><span class='Delimiter'>; 
</span><a name="LN180"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>ar_hasrelopts</span><span class='Delimiter'>; 
</span><a name="LN181"></a>    <a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Declare_Member'>ar_reloptions</span><span class='Delimiter'>;</span>  <span class='Comment_Multi_Line'>/* copy of AutoVacOpts from the main table's 
                                 * reloptions, or NULL if none */ 
</span><a name="LN183"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>av_relation</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* struct to keep track of tables to vacuum and/or analyze, after rechecking */ 
</span><a name="LN186"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>autovac_table</span> 
<span class='Delimiter'>{ 
</span><a name="LN188"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>at_relid</span><span class='Delimiter'>; 
</span><a name="LN189"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>at_vacoptions</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* bitmask of VacuumOption */ 
</span><a name="LN190"></a>    <a href="../../include/commands/vacuum.h.html#LN135"><span class='Ref_to_Struct'>VacuumParams</span></a> <span class='Declare_Member'>at_params</span><span class='Delimiter'>; 
</span><a name="LN191"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>at_vacuum_cost_delay</span><span class='Delimiter'>; 
</span><a name="LN192"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>at_vacuum_cost_limit</span><span class='Delimiter'>; 
</span><a name="LN193"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>at_dobalance</span><span class='Delimiter'>; 
</span><a name="LN194"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>at_sharedrel</span><span class='Delimiter'>; 
</span><a name="LN195"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>at_relname</span><span class='Delimiter'>; 
</span><a name="LN196"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>at_nspname</span><span class='Delimiter'>; 
</span><a name="LN197"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>at_datname</span><span class='Delimiter'>; 
</span><a name="LN198"></a>} <span class='Declare_Typedef'>autovac_table</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/*------------- 
 * This struct holds information about a single worker's whereabouts.  We keep 
 * an array of these in shared memory, sized according to 
 * autovacuum_max_workers. 
 * 
 * wi_links     entry into free list or running list 
 * wi_dboid     OID of the database this worker is supposed to work on 
 * wi_tableoid  OID of the table currently being vacuumed, if any 
 * wi_sharedrel flag indicating whether table is marked relisshared 
 * wi_proc      pointer to PGPROC of the running worker, NULL if not started 
 * wi_launchtime Time at which this worker was launched 
 * wi_cost_*    Vacuum cost-based delay parameters current in this worker 
 * 
 * All fields are protected by AutovacuumLock, except for wi_tableoid which is 
 * protected by AutovacuumScheduleLock (which is read-only for everyone except 
 * that worker itself). 
 *------------- 
 */ 
</span><a name="LN218"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>WorkerInfoData</span> 
<span class='Delimiter'>{ 
</span><a name="LN220"></a>    <a href="../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>wi_links</span><span class='Delimiter'>; 
</span><a name="LN221"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>wi_dboid</span><span class='Delimiter'>; 
</span><a name="LN222"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>wi_tableoid</span><span class='Delimiter'>; 
</span><a name="LN223"></a>    <a href="../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>wi_proc</span><span class='Delimiter'>; 
</span><a name="LN224"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>wi_launchtime</span><span class='Delimiter'>; 
</span><a name="LN225"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>wi_dobalance</span><span class='Delimiter'>; 
</span><a name="LN226"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>wi_sharedrel</span><span class='Delimiter'>; 
</span><a name="LN227"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>wi_cost_delay</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>wi_cost_limit</span><span class='Delimiter'>; 
</span><a name="LN229"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>wi_cost_limit_base</span><span class='Delimiter'>; 
</span><a name="LN230"></a>} <span class='Declare_Typedef'>WorkerInfoData</span><span class='Delimiter'>; 
</span> 
<a name="LN232"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <a href="autovacuum.c.html#LN218"><span class='Ref_to_Struct'>WorkerInfoData</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>WorkerInfo</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Possible signals received by the launcher from remote processes.  These are 
 * stored atomically in shared memory so that other processes can set them 
 * without locking. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN241"></a>    <span class='Declare_Enum_Const'>AutoVacForkFailed</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* failed trying to start a worker */ 
</span><a name="LN242"></a>    <span class='Declare_Enum_Const'>AutoVacRebalance</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* rebalance the cost limits */ 
</span><a name="LN243"></a>    <span class='Declare_Enum_Const'>AutoVacNumSignals</span>           <span class='Comment_Single_Line'>/* must be last */ 
</span><a name="LN244"></a><span class='Delimiter'>}</span>   <span class='Declare_Typedef'>AutoVacuumSignal</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/*------------- 
 * The main autovacuum shmem struct.  On shared memory we store this main 
 * struct and the array of WorkerInfo structs.  This struct keeps: 
 * 
 * av_signal        set by other processes to indicate various conditions 
 * av_launcherpid   the PID of the autovacuum launcher 
 * av_freeWorkers   the WorkerInfo freelist 
 * av_runningWorkers the WorkerInfo non-free queue 
 * av_startingWorker pointer to WorkerInfo currently being started (cleared by 
 *                  the worker itself as soon as it's up and running) 
 * av_dsa_handle    handle for allocatable shared memory 
 * 
 * This struct is protected by AutovacuumLock, except for av_signal and parts 
 * of the worker list (see above).  av_dsa_handle is readable unlocked. 
 *------------- 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN264"></a>    sig_atomic_t <span class='Declare_Member'>av_signal</span><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN243"><span class='Ref_to_EnumConst'>AutoVacNumSignals</span></a><span class='Delimiter'>]; 
</span><a name="LN265"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Member'>av_launcherpid</span><span class='Delimiter'>; 
</span><a name="LN266"></a>    <a href="../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a>  <span class='Declare_Member'>av_freeWorkers</span><span class='Delimiter'>; 
</span><a name="LN267"></a>    <a href="../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a>  <span class='Declare_Member'>av_runningWorkers</span><span class='Delimiter'>; 
</span><a name="LN268"></a>    <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Member'>av_startingWorker</span><span class='Delimiter'>; 
</span><a name="LN269"></a>    <a href="../../include/utils/dsa.h.html#LN99"><span class='Ref_to_Typedef'>dsa_handle</span></a>  <span class='Declare_Member'>av_dsa_handle</span><span class='Delimiter'>; 
</span><a name="LN270"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>av_workitems</span><span class='Delimiter'>; 
</span><a name="LN271"></a>} <span class='Declare_Typedef'>AutoVacuumShmemStruct</span><span class='Delimiter'>; 
</span> 
<a name="LN273"></a><span class='Keyword'>static </span><a href="autovacuum.c.html#LN262"><span class='Ref_to_Typedef'>AutoVacuumShmemStruct</span></a> <span class='Operator'>*</span><span class='Declare_Var'>AutoVacuumShmem</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * the database list (of avl_dbase elements) in the launcher, and the context 
 * that contains it 
 */ 
</span><a name="LN279"></a><span class='Keyword'>static </span><a href="../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a> <span class='Declare_Var'>DatabaseList</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN247"><span class='Ref_to_Macro'>DLIST_STATIC_INIT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN280"></a><span class='Keyword'>static </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>DatabaseListCxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Pointer to my own WorkerInfo, valid on each worker */ 
</span><a name="LN283"></a><span class='Keyword'>static </span><a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a> <span class='Declare_Var'>MyWorkerInfo</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Autovacuum workitem array, stored in AutoVacuumShmem-&GT;av_workitems.  This 
 * list is mostly protected by AutovacuumLock, except that if it's marked 
 * 'active' other processes must not modify the work-identifying members, 
 * though changing the list pointers is okay. 
 */ 
</span><a name="LN291"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>AutoVacuumWorkItem</span> 
<span class='Delimiter'>{ 
</span><a name="LN293"></a>    <a href="../../include/postmaster/autovacuum.h.html#LN22"><span class='Ref_to_Typedef'>AutoVacuumWorkItemType</span></a> <span class='Declare_Member'>avw_type</span><span class='Delimiter'>; 
</span><a name="LN294"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>avw_database</span><span class='Delimiter'>; 
</span><a name="LN295"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>avw_relation</span><span class='Delimiter'>; 
</span><a name="LN296"></a>    <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>avw_blockNumber</span><span class='Delimiter'>; 
</span><a name="LN297"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>avw_active</span><span class='Delimiter'>; 
</span><a name="LN298"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>avw_next</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* doubly linked list pointers */ 
</span><a name="LN299"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>avw_prev</span><span class='Delimiter'>; 
</span><a name="LN300"></a>} <span class='Declare_Typedef'>AutoVacuumWorkItem</span><span class='Delimiter'>; 
</span> 
<a name="LN302"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NUM_WORKITEMS</span>   <span class='Number'>256</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN305"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>avs_usedItems</span><span class='Delimiter'>; 
</span><a name="LN306"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>avs_freeItems</span><span class='Delimiter'>; 
</span><a name="LN307"></a>} <span class='Declare_Typedef'>AutovacWorkItems</span><span class='Delimiter'>; 
</span> 
<a name="LN309"></a><span class='Keyword'>static </span><a href="../utils/mmgr/dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Var'>AutoVacuumDSA</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* PID of launcher, valid only in worker while shutting down */ 
</span><a name="LN312"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>AutovacuumLauncherPid</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
<a name="LN315"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>avlauncher_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN316"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>avworker_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN318"></a><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void </span><a href="autovacuum.c.html#LN1524"><span class='Ref_to_Func'>AutoVacWorkerMain</span></a><span class='Parentheses'>(</span><span class='Keyword'>int </span>argc<span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span>argv<span class='Delimiter'>[]</span><span class='Parentheses'>) </span><span class='Declare_Var'>pg_attribute_noreturn</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN319"></a><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void </span><a href="autovacuum.c.html#LN440"><span class='Ref_to_Func'>AutoVacLauncherMain</span></a><span class='Parentheses'>(</span><span class='Keyword'>int </span>argc<span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span>argv<span class='Delimiter'>[]</span><span class='Parentheses'>) </span><span class='Declare_Var'>pg_attribute_noreturn</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<a name="LN321"></a><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Declare_Prototype'>do_start_worker</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN322"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>launcher_determine_sleep</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>canlaunch</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>recursing</span><span class='Delimiter'>, 
</span><a name="LN323"></a>                         <span class='Control'>struct</span> timeval <span class='Operator'>* </span><span class='Declare_Parameter'>nap</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN324"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>launch_worker</span><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>now</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN325"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_database_list</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN326"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>rebuild_database_list</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newdb</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN327"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>db_comparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN328"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>autovac_balance_cost</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN330"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>do_autovacuum</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN331"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreeWorkerInfo</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN333"></a><span class='Keyword'>static </span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>table_recheck_autovac</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>table_toast_map</span><span class='Delimiter'>, 
</span><a name="LN334"></a>                      <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Delimiter'>, 
</span><a name="LN335"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>effective_multixact_freeze_max_age</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN336"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>relation_needs_vacanalyze</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relopts</span><span class='Delimiter'>, 
</span><a name="LN337"></a>                          <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Parameter'>classForm</span><span class='Delimiter'>, 
</span><a name="LN338"></a>                          <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tabentry</span><span class='Delimiter'>, 
</span><a name="LN339"></a>                          <span class='Keyword'>int </span><span class='Declare_Parameter'>effective_multixact_freeze_max_age</span><span class='Delimiter'>, 
</span><a name="LN340"></a>                          <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dovacuum</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>doanalyze</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>wraparound</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN342"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>autovacuum_do_vac_analyze</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tab</span><span class='Delimiter'>, 
</span><a name="LN343"></a>                          <a href="../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN344"></a><span class='Keyword'>static </span><a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>extract_autovac_opts</span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN345"></a>                     <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN346"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_pgstat_tabentry_relid</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isshared</span><span class='Delimiter'>, 
</span><a name="LN347"></a>                          <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>shared</span><span class='Delimiter'>, 
</span><a name="LN348"></a>                          <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN349"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>perform_work_item</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workitem</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN350"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>autovac_report_activity</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tab</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN351"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>autovac_report_workitem</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workitem</span><span class='Delimiter'>, 
</span><a name="LN352"></a>                        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>nspname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN353"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>av_sighup_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN354"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>avl_sigusr2_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN355"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>avl_sigterm_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN356"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>autovac_refresh_stats</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN357"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>remove_wi_from_list</span><span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list</span><span class='Delimiter'>, </span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>wi_ptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN358"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>add_wi_to_list</span><span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list</span><span class='Delimiter'>, </span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>wi_ptr</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
 
<span class='Comment_Multi_Line'>/******************************************************************** 
 *                    AUTOVACUUM LAUNCHER CODE 
 ********************************************************************/ 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
<span class='Comment_Multi_Line'>/* 
 * forkexec routine for the autovacuum launcher process. 
 * 
 * Format up the arglist, then fork and exec. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN373"></a><span class='Declare_Function'>avlauncher_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN375"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN376"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN375"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN376"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN375"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN376"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"--forkavlauncher"</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN375"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN376"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by postmaster_forkexec */ 
</span>    <a href="autovacuum.c.html#LN375"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN376"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN376"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN375"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/postmaster/postmaster.h.html#LN57"><span class='Ref_to_Proto'>postmaster_forkexec</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN376"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN375"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We need this set from the outside, before InitProcess is called 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN392"></a><span class='Declare_Function'>AutovacuumLauncherIAm</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="autovacuum.c.html#LN135"><span class='Ref_to_Global_Var'>am_autovacuum_launcher</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Main entry point for autovacuum launcher process, to be called from the 
 * postmaster. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN403"></a><span class='Declare_Function'>StartAutoVacLauncher</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN405"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>AutoVacPID</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN405"><span class='Ref_To_Local'>AutoVacPID</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN315"><span class='Ref_to_Proto'>avlauncher_forkexec</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN405"><span class='Ref_To_Local'>AutoVacPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork autovacuum launcher process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> EXEC_BACKEND 
        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster child ... */ 
</span>            <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>            <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN440"><span class='Ref_to_Func'>AutoVacLauncherMain</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN405"><span class='Ref_To_Local'>AutoVacPID</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch (AutoVacPID=fork_proc... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* shouldn't get here */ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartAutoVacLauncher &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Main loop for the autovacuum launcher process. 
 */ 
</span><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void 
</span><a name="LN441"></a><span class='Declare_Function'>AutoVacLauncherMain</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN443"></a>    <a href="../../include/c.h.html#LN1087"><span class='Ref_to_Const'>sigjmp_buf</span></a>  <span class='Declare_Local'>local_sigjmp_buf</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN135"><span class='Ref_to_Global_Var'>am_autovacuum_launcher</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Identify myself via ps */ 
</span>    <a href="../../include/utils/ps_status.h.html#LN18"><span class='Ref_to_Proto'>init_ps_display</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum launcher process"</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum launcher started"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../tcop/postgres.c.html#LN98"><span class='Ref_to_Global_Var'>PostAuthDelay</span></a><span class='Parentheses'>) 
</span>        <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="../tcop/postgres.c.html#LN98"><span class='Ref_to_Global_Var'>PostAuthDelay</span></a> <span class='Operator'>* </span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN375"><span class='Ref_to_Macro'>SetProcessingMode</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN363"><span class='Ref_to_EnumConst'>InitProcessing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up signal handlers.  We operate on databases much like a regular 
     * backend, so we use the same signal handling.  See equivalent code in 
     * tcop/postgres.c. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN353"><span class='Ref_to_Proto'>av_sighup_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="../../include/tcop/tcopprot.h.html#LN69"><span class='Ref_to_Proto'>StatementCancelHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN355"><span class='Ref_to_Proto'>avl_sigterm_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="../tcop/postgres.c.html#LN2554"><span class='Ref_to_Func'>quickdie</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/timeout.h.html#LN69"><span class='Ref_to_Proto'>InitializeTimeouts</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* establishes SIGALRM handler */ 
</span> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="../../include/storage/procsignal.h.html#LN58"><span class='Ref_to_Proto'>procsignal_sigusr1_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN354"><span class='Ref_to_Proto'>avl_sigusr2_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGFPE<span class='Delimiter'>, </span><a href="../tcop/postgres.c.html#LN2667"><span class='Ref_to_Func'>FloatExceptionHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Early initialization */ 
</span>    <a href="../../include/miscadmin.h.html#LN424"><span class='Ref_to_Proto'>BaseInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a per-backend PGPROC struct in shared memory, except in the 
     * EXEC_BACKEND case where this was done in SubPostmasterMain. We must do 
     * this before we can use LWLocks (and in the EXEC_BACKEND case we already 
     * had to do some stuff with LWLocks). 
     */ 
</span><span class='Directive'>#ifndef</span> EXEC_BACKEND 
    <a href="../storage/lmgr/proc.c.html#LN285"><span class='Ref_to_Func'>InitProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../include/miscadmin.h.html#LN422"><span class='Ref_to_Proto'>InitPostgres</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN375"><span class='Ref_to_Macro'>SetProcessingMode</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN364"><span class='Ref_to_EnumConst'>NormalProcessing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a memory context that we will do all our work in.  We do this so 
     * that we can reset the context during error recovery and thereby avoid 
     * possible memory leaks. 
     */ 
</span>    <a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"Autovacuum Launcher"</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If an exception is encountered, processing resumes here. 
     * 
     * This code is a stripped down version of PostgresMain error recovery. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1088"><span class='Ref_to_Macro'>sigsetjmp</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN443"><span class='Ref_To_Local'>local_sigjmp_buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* since not using PG_TRY, must reset error stack by hand */ 
</span>        <a href="../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prevents interrupts while cleaning up */ 
</span>        <a href="../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Forget any pending QueryCancel or timeout request */ 
</span>        <a href="../../include/utils/timeout.h.html#LN79"><span class='Ref_to_Proto'>disable_all_timeouts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../utils/init/globals.c.html#LN29"><span class='Ref_to_Global_Var'>QueryCancelPending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* second to avoid race condition */ 
</span> 
        <span class='Comment_Multi_Line'>/* Report the error to the server log */ 
</span>        <a href="../../include/utils/elog.h.html#LN362"><span class='Ref_to_Proto'>EmitErrorReport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Abort the current transaction in order to recover */ 
</span>        <a href="../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now return to normal top-level context and clear ErrorContext for 
         * next time. 
         */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Flush any leaked data in the top-level context */ 
</span>        <a href="../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* don't leave dangling pointers to freed memory */ 
</span>        <a href="autovacuum.c.html#LN280"><span class='Ref_to_Global_Var'>DatabaseListCxt</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make sure pgstat also considers our stat data as gone.  Note: we 
         * mustn't use autovac_refresh_stats here. 
         */ 
</span>        <a href="../../include/pgstat.h.html#LN1150"><span class='Ref_to_Proto'>pgstat_clear_snapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Now we can allow interrupts again */ 
</span>        <a href="../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if in shutdown mode, no need for anything further; just go away */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgarch.c.html#LN76"><span class='Ref_to_Global_Var'>got_SIGTERM</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="autovacuum.c.html#LN835"><span class='Ref_to_Label'>shutdown</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sleep at least 1 second after any error.  We don't want to be 
         * filling the error logs as fast as we can. 
         */ 
</span>        <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if sigsetjmp(local_sigjm... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* We can now handle ereport(ERROR) */ 
</span>    <a href="../utils/error/elog.c.html#LN89"><span class='Ref_to_Global_Var'>PG_exception_stack</span></a> <span class='Operator'>= &</span><a href="autovacuum.c.html#LN443"><span class='Ref_To_Local'>local_sigjmp_buf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* must unblock signals before calling rebuild_database_list */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force zero_damaged_pages OFF in the autovac process, even if it is set 
     * in postgresql.conf.  We don't really want such a dangerous option being 
     * applied non-interactively. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"zero_damaged_pages"</span><span class='Delimiter'>, </span><span class='String'>"false"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force settable timeouts off to avoid letting these settings prevent 
     * regular maintenance from being executed. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"statement_timeout"</span><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"lock_timeout"</span><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"idle_in_transaction_session_timeout"</span><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force default_transaction_isolation to READ COMMITTED.  We don't want 
     * to pay the overhead of serializable mode, nor add any risk of causing 
     * deadlocks or delaying other transactions. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"default_transaction_isolation"</span><span class='Delimiter'>, </span><span class='String'>"read committed"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In emergency mode, just start a worker (unless shutdown was requested) 
     * and go away. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/postmaster/autovacuum.h.html#LN48"><span class='Ref_to_Proto'>AutoVacuumingActive</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgarch.c.html#LN76"><span class='Ref_to_Global_Var'>got_SIGTERM</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN321"><span class='Ref_to_Proto'>do_start_worker</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* done */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN265"><span class='Ref_to_Member'>av_launcherpid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the initial database list.  The invariant we want this list to 
     * keep is that it's ordered by decreasing next_time.  As soon as an entry 
     * is updated to a higher time, it will be moved to the front (which is 
     * correct because the only operation is to add autovacuum_naptime to the 
     * entry, and time always increases). 
     */ 
</span>    <a href="autovacuum.c.html#LN326"><span class='Ref_to_Proto'>rebuild_database_list</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up our DSA so that backends can install work-item requests.  It may 
     * already exist as created by a previous launcher. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN103"><span class='Ref_to_Proto'>dsa_create</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Operator'>-&GT;</span>tranche<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* make sure it doesn't go away even if we do */ 
</span>        <a href="../../include/utils/dsa.h.html#LN113"><span class='Ref_to_Proto'>dsa_pin</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/dsa.h.html#LN111"><span class='Ref_to_Proto'>dsa_pin_mapping</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN117"><span class='Ref_to_Proto'>dsa_get_handle</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* delay array allocation until first request */ 
</span>        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN106"><span class='Ref_to_Proto'>dsa_attach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/dsa.h.html#LN111"><span class='Ref_to_Proto'>dsa_pin_mapping</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* loop until shutdown request */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgarch.c.html#LN76"><span class='Ref_to_Global_Var'>got_SIGTERM</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN637"></a>        <span class='Control'>struct</span> timeval <span class='Declare_Local'>nap</span><span class='Delimiter'>; 
</span><a name="LN638"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>current_time</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN639"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>can_launch</span><span class='Delimiter'>; 
</span><a name="LN640"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This loop is a bit different from the normal use of WaitLatch, 
         * because we'd like to sleep before the first launch of a child 
         * process.  So it's WaitLatch, then ResetLatch, then check for 
         * wakening conditions. 
         */ 
</span> 
        <a href="autovacuum.c.html#LN322"><span class='Ref_to_Proto'>launcher_determine_sleep</span></a><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN637"><span class='Ref_To_Local'>nap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Wait until naptime expires or we get some type of signal (all the 
         * signal handlers will wake us by calling SetLatch). 
         */ 
</span>        <a href="autovacuum.c.html#LN640"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN637"><span class='Ref_To_Local'>nap</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>* </span><span class='Number'>1000L</span><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN637"><span class='Ref_To_Local'>nap</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>/ </span><span class='Number'>1000L</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <a href="../../include/pgstat.h.html#LN757"><span class='Ref_to_EnumConst'>WAIT_EVENT_AUTOVACUUM_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Process sinval catchup interrupts that happened while sleeping */ 
</span>        <a href="../../include/storage/sinval.h.html#LN143"><span class='Ref_to_Proto'>ProcessCatchupInterrupt</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Emergency bailout if postmaster has died.  This is to avoid the 
         * necessity for manual cleanup of all postmaster children. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN640"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>            <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* the normal shutdown case */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgarch.c.html#LN76"><span class='Ref_to_Global_Var'>got_SIGTERM</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* shutdown requested in config file? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/postmaster/autovacuum.h.html#LN48"><span class='Ref_to_Proto'>AutoVacuumingActive</span></a><span class='Parentheses'>())</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* rebalance in case the default cost parameters changed */ 
</span>            <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN328"><span class='Ref_to_Proto'>autovac_balance_cost</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* rebuild the list in case the naptime changed */ 
</span>            <a href="autovacuum.c.html#LN326"><span class='Ref_to_Proto'>rebuild_database_list</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * a worker finished, or postmaster signalled failure to start a 
         * worker 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN140"><span class='Ref_to_Global_Var'>got_SIGUSR2</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="autovacuum.c.html#LN140"><span class='Ref_to_Global_Var'>got_SIGUSR2</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* rebalance cost limits, if needed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN264"><span class='Ref_to_Member'>av_signal</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN242"><span class='Ref_to_EnumConst'>AutoVacRebalance</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN264"><span class='Ref_to_Member'>av_signal</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN242"><span class='Ref_to_EnumConst'>AutoVacRebalance</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN328"><span class='Ref_to_Proto'>autovac_balance_cost</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN264"><span class='Ref_to_Member'>av_signal</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN241"><span class='Ref_to_EnumConst'>AutoVacForkFailed</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * If the postmaster failed to start a new worker, we sleep 
                 * for a little while and resend the signal.  The new worker's 
                 * state is still in memory, so this is sufficient.  After 
                 * that, we restart the main loop. 
                 * 
                 * XXX should we put a limit to the number of times we retry? 
                 * I don't think it makes much sense, because a future start 
                 * of a worker will continue to fail in the same way. 
                 */ 
</span>                <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN264"><span class='Ref_to_Member'>av_signal</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN241"><span class='Ref_to_EnumConst'>AutoVacForkFailed</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* 1s */ 
</span>                <a href="../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN29"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_WORKER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if got_SIGUSR2 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * There are some conditions that we need to check before trying to 
         * start a worker.  First, we need to make sure that there is a worker 
         * slot available.  Second, we need to make sure that no other worker 
         * failed while starting up. 
         */ 
</span> 
        <a href="autovacuum.c.html#LN638"><span class='Ref_To_Local'>current_time</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN639"><span class='Ref_To_Local'>can_launch</span></a> <span class='Operator'>= !</span><a href="../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN745"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>waittime</span><span class='Delimiter'>; 
</span><a name="LN746"></a>            <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Local'>worker</span> <span class='Operator'>= </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We can't launch another worker when another one is still 
             * starting up (or failed while doing so), so just sleep for a bit 
             * more; that worker will wake us up again as soon as it's ready. 
             * We will only wait autovacuum_naptime seconds (up to a maximum 
             * of 60 seconds) for this to happen however.  Note that failure 
             * to connect to a particular database is not a problem here, 
             * because the worker removes itself from the startingWorker 
             * pointer before trying to connect.  Problems detected by the 
             * postmaster (like fork() failure) are also reported and handled 
             * differently.  The only problems that may cause this code to 
             * fire are errors in the earlier sections of AutoVacWorkerMain, 
             * before the worker removes the WorkerInfo from the 
             * startingWorker pointer. 
             */ 
</span>            <a href="autovacuum.c.html#LN745"><span class='Ref_To_Local'>waittime</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN114"><span class='Ref_to_Global_Var'>autovacuum_naptime</span></a><span class='Delimiter'>, </span><span class='Number'>60</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_launchtime<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN638"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, 
</span>                                           <a href="autovacuum.c.html#LN745"><span class='Ref_To_Local'>waittime</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * No other process can put a worker in starting mode, so if 
                 * startingWorker is still INVALID after exchanging our lock, 
                 * we assume it's the same one we saw above (so we don't 
                 * recheck the launch time). 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a><span class='Delimiter'>; 
</span>                    <a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dboid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>                    <a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_tableoid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>                    <a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_sharedrel <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_launchtime <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="autovacuum.c.html#LN746"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_links<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"worker took too long to start; canceled"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TimestampDifferenceEx... &raquo; </span> 
            <span class='Control'>else</span> 
                <a href="autovacuum.c.html#LN639"><span class='Ref_To_Local'>can_launch</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if AutoVacuumShmem-&GT;av_s... &raquo; </span> 
        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* either shared or exclusive */ 
</span> 
        <span class='Comment_Multi_Line'>/* if we can't do anything, just go back to sleep */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN639"><span class='Ref_To_Local'>can_launch</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We're OK to start a new worker */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Special case when the list is empty: start a worker right away. 
             * This covers the initial case, when no database is in pgstats 
             * (thus the list is empty).  Note that the constraints in 
             * launcher_determine_sleep keep us from starting workers too 
             * quickly (at most once every autovacuum_naptime when the list is 
             * empty). 
             */ 
</span>            <a href="autovacuum.c.html#LN324"><span class='Ref_to_Proto'>launch_worker</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN638"><span class='Ref_To_Local'>current_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * because rebuild_database_list constructs a list with most 
             * distant adl_next_worker first, we obtain our database from the 
             * tail of the list. 
             */ 
</span><a name="LN820"></a>            <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN820"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN495"><span class='Ref_to_Macro'>dlist_tail_element</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Delimiter'>, </span>adl_node<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * launch a worker if next_worker is right now or it is in the 
             * past 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN820"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN160"><span class='Ref_to_Member'>adl_next_worker</span></a><span class='Delimiter'>, 
</span>                                           <a href="autovacuum.c.html#LN638"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
                <a href="autovacuum.c.html#LN324"><span class='Ref_to_Proto'>launch_worker</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN638"><span class='Ref_To_Local'>current_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while !got_SIGTERM &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Normal exit from the autovac launcher is here */ 
</span><a name="LN835"></a><span class='Label'>shutdown</span><span class='Operator'>: 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum launcher shutting down"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN265"><span class='Ref_to_Member'>av_launcherpid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* done */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AutoVacLauncherMain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine the time to sleep, based on the database list. 
 * 
 * The "canlaunch" parameter indicates whether we can start a worker right now, 
 * for example due to the workers being all busy.  If this is false, we will 
 * cause a long sleep, which will be interrupted when a worker exits. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN851"></a><span class='Declare_Function'>launcher_determine_sleep</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>canlaunch</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>recursing</span><span class='Delimiter'>, </span><span class='Control'>struct</span> timeval <span class='Operator'>* </span><span class='Declare_Parameter'>nap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We sleep until the next scheduled vacuum.  We trust that when the 
     * database list was built, care was taken so that no entries have times 
     * in the past; if the first entry has too close a next_worker value, or a 
     * time in the past, we will sleep a small nominal time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>canlaunch</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="autovacuum.c.html#LN114"><span class='Ref_to_Global_Var'>autovacuum_naptime</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN866"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>current_time</span> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN867"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>next_wakeup</span><span class='Delimiter'>; 
</span><a name="LN868"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span><span class='Delimiter'>; 
</span><a name="LN869"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>secs</span><span class='Delimiter'>; 
</span><a name="LN870"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>usecs</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN868"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN495"><span class='Ref_to_Macro'>dlist_tail_element</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Delimiter'>, </span>adl_node<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN867"><span class='Ref_To_Local'>next_wakeup</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN868"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN160"><span class='Ref_to_Member'>adl_next_worker</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/timestamp.h.html#LN72"><span class='Ref_to_Proto'>TimestampDifference</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN866"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN867"><span class='Ref_To_Local'>next_wakeup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN869"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN870"><span class='Ref_To_Local'>usecs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="autovacuum.c.html#LN869"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><a href="autovacuum.c.html#LN870"><span class='Ref_To_Local'>usecs</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* list is empty, sleep for whole autovacuum_naptime seconds  */ 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="autovacuum.c.html#LN114"><span class='Ref_to_Global_Var'>autovacuum_naptime</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the result is exactly zero, it means a database had an entry with 
     * time in the past.  Rebuild the list so that the databases are evenly 
     * distributed again, and recalculate the time to sleep.  This can happen 
     * if there are more tables needing vacuum than workers, and they all take 
     * longer to vacuum than autovacuum_naptime. 
     * 
     * We only recurse once.  rebuild_database_list should always return times 
     * in the future, but it seems best not to trust too much on that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>recursing</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN326"><span class='Ref_to_Proto'>rebuild_database_list</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN322"><span class='Ref_to_Proto'>launcher_determine_sleep</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>canlaunch</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* The smallest time we'll allow the launcher to sleep. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>&LT;= </span><a href="autovacuum.c.html#LN131"><span class='Ref_to_Const'>MIN_AUTOVAC_SLEEPTIME</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><a href="autovacuum.c.html#LN131"><span class='Ref_to_Const'>MIN_AUTOVAC_SLEEPTIME</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the sleep time is too large, clamp it to an arbitrary maximum (plus 
     * any fractional seconds, for simplicity).  This avoids an essentially 
     * infinite sleep in strange cases like the system clock going backwards a 
     * few years. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>&GT; </span><a href="autovacuum.c.html#LN132"><span class='Ref_to_Const'>MAX_AUTOVAC_SLEEPTIME</span></a><span class='Parentheses'>) 
</span>        <a href="autovacuum.c.html#LN851"><span class='Ref_to_Parameter'>nap</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="autovacuum.c.html#LN132"><span class='Ref_to_Const'>MAX_AUTOVAC_SLEEPTIME</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end launcher_determine_sleep &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build an updated DatabaseList.  It must only contain databases that appear 
 * in pgstats, and must be sorted by next_worker from highest to lowest, 
 * distributed regularly across the next autovacuum_naptime interval. 
 * 
 * Receives the Oid of the database that made this list be generated (we call 
 * this the "new" database, because when the database was already present on 
 * the list, we expect that this function is not called at all).  The 
 * preexisting list, if any, will be used to preserve the order of the 
 * databases in the autovacuum_naptime period.  The new database is put at the 
 * end of the interval.  The actual values are not saved, which should not be 
 * much of a problem. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN935"></a><span class='Declare_Function'>rebuild_database_list</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>newdb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN937"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>dblist</span><span class='Delimiter'>; 
</span><a name="LN938"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN939"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>newcxt</span><span class='Delimiter'>; 
</span><a name="LN940"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN941"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tmpcxt</span><span class='Delimiter'>; 
</span><a name="LN942"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hctl</span><span class='Delimiter'>; 
</span><a name="LN943"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>score</span><span class='Delimiter'>; 
</span><a name="LN944"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nelems</span><span class='Delimiter'>; 
</span><a name="LN945"></a>    <a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>dbhash</span><span class='Delimiter'>; 
</span><a name="LN946"></a>    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* use fresh stats */ 
</span>    <a href="autovacuum.c.html#LN356"><span class='Ref_to_Proto'>autovac_refresh_stats</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN939"><span class='Ref_To_Local'>newcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Delimiter'>, 
</span>                                   <span class='String'>"AV dblist"</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN941"><span class='Ref_To_Local'>tmpcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN939"><span class='Ref_To_Local'>newcxt</span></a><span class='Delimiter'>, 
</span>                                   <span class='String'>"tmp AV dblist"</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN940"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN941"><span class='Ref_To_Local'>tmpcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Implementing this is not as simple as it sounds, because we need to put 
     * the new database at the end of the list; next the databases that were 
     * already on the list, and finally (at the tail of the list) all the 
     * other databases that are not on the existing list. 
     * 
     * To do this, we build an empty hash table of scored databases.  We will 
     * start with the lowest score (zero) for the new database, then 
     * increasing scores for the databases in the existing list, in order, and 
     * lastly increasing scores for all databases gotten via 
     * get_database_list() that are not already on the hash. 
     * 
     * Then we will put all the hash elements into an array, sort the array by 
     * score, and finally put the array elements into the new doubly linked 
     * list. 
     */ 
</span>    <a href="autovacuum.c.html#LN942"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN942"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN942"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN941"><span class='Ref_To_Local'>tmpcxt</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN945"><span class='Ref_To_Local'>dbhash</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"db hash"</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN942"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* magic number here FIXME */ 
</span>                         <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* start by inserting the new database */ 
</span>    <a href="autovacuum.c.html#LN943"><span class='Ref_To_Local'>score</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN935"><span class='Ref_to_Parameter'>newdb</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN985"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>db</span><span class='Delimiter'>; 
</span><a name="LN986"></a>        <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* only consider this database if it has a pgstat entry */ 
</span>        <a href="autovacuum.c.html#LN986"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN935"><span class='Ref_to_Parameter'>newdb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN986"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we assume it isn't found because the hash was just created */ 
</span>            <a href="autovacuum.c.html#LN985"><span class='Ref_To_Local'>db</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN945"><span class='Ref_To_Local'>dbhash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN935"><span class='Ref_to_Parameter'>newdb</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* hash_search already filled in the key */ 
</span>            <a href="autovacuum.c.html#LN985"><span class='Ref_To_Local'>db</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN161"><span class='Ref_to_Member'>adl_score</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN943"><span class='Ref_To_Local'>score</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* next_worker is filled in later */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now insert the databases from the existing list */ 
</span>    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN946"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1004"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Delimiter'>, </span>adl_node<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN946"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1005"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>db</span><span class='Delimiter'>; 
</span><a name="LN1006"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN1007"></a>        <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * skip databases with no stat entries -- in particular, this gets rid 
         * of dropped databases 
         */ 
</span>        <a href="autovacuum.c.html#LN1007"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1004"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN159"><span class='Ref_to_Member'>adl_datid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1007"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1005"><span class='Ref_To_Local'>db</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN945"><span class='Ref_To_Local'>dbhash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1004"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN159"><span class='Ref_to_Member'>adl_datid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1006"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN1006"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* hash_search already filled in the key */ 
</span>            <a href="autovacuum.c.html#LN1005"><span class='Ref_To_Local'>db</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN161"><span class='Ref_to_Member'>adl_score</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN943"><span class='Ref_To_Local'>score</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* next_worker is filled in later */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* finally, insert all qualifying databases not previously inserted */ 
</span>    <a href="autovacuum.c.html#LN937"><span class='Ref_To_Local'>dblist</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN325"><span class='Ref_to_Proto'>get_database_list</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN938"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN937"><span class='Ref_To_Local'>dblist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1031"></a>        <a href="autovacuum.c.html#LN166"><span class='Ref_to_Struct'>avw_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN938"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1032"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>db</span><span class='Delimiter'>; 
</span><a name="LN1033"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN1034"></a>        <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* only consider databases with a pgstat entry */ 
</span>        <a href="autovacuum.c.html#LN1034"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1031"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1034"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1032"><span class='Ref_To_Local'>db</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN945"><span class='Ref_To_Local'>dbhash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1031"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1033"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* only update the score if the database was not already on the hash */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN1033"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* hash_search already filled in the key */ 
</span>            <a href="autovacuum.c.html#LN1032"><span class='Ref_To_Local'>db</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN161"><span class='Ref_to_Member'>adl_score</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN943"><span class='Ref_To_Local'>score</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* next_worker is filled in later */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="autovacuum.c.html#LN944"><span class='Ref_To_Local'>nelems</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN943"><span class='Ref_To_Local'>score</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* from here on, the allocated memory belongs to the new list */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN939"><span class='Ref_To_Local'>newcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN944"><span class='Ref_To_Local'>nelems</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1058"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>current_time</span><span class='Delimiter'>; 
</span><a name="LN1059"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>millis_increment</span><span class='Delimiter'>; 
</span><a name="LN1060"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>dbary</span><span class='Delimiter'>; 
</span><a name="LN1061"></a>        <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>db</span><span class='Delimiter'>; 
</span><a name="LN1062"></a>        <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>seq</span><span class='Delimiter'>; 
</span><a name="LN1063"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* put all the hash elements into an array */ 
</span>        <a href="autovacuum.c.html#LN1060"><span class='Ref_To_Local'>dbary</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN944"><span class='Ref_To_Local'>nelems</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1063"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1062"><span class='Ref_To_Local'>seq</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN945"><span class='Ref_To_Local'>dbhash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN1061"><span class='Ref_To_Local'>db</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1062"><span class='Ref_To_Local'>seq</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1060"><span class='Ref_To_Local'>dbary</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN1063"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1061"><span class='Ref_To_Local'>db</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* sort the array */ 
</span>        <a href="../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1060"><span class='Ref_To_Local'>dbary</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN944"><span class='Ref_To_Local'>nelems</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN327"><span class='Ref_to_Proto'>db_comparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Determine the time interval between databases in the schedule. If 
         * we see that the configured naptime would take us to sleep times 
         * lower than our min sleep time (which launcher_determine_sleep is 
         * coded not to allow), silently use a larger naptime (but don't touch 
         * the GUC variable). 
         */ 
</span>        <a href="autovacuum.c.html#LN1059"><span class='Ref_To_Local'>millis_increment</span></a> <span class='Operator'>= </span><span class='Number'>1000</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>* </span><a href="autovacuum.c.html#LN114"><span class='Ref_to_Global_Var'>autovacuum_naptime</span></a> <span class='Operator'>/ </span><a href="autovacuum.c.html#LN944"><span class='Ref_To_Local'>nelems</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1059"><span class='Ref_To_Local'>millis_increment</span></a> <span class='Operator'>&LT;= </span><a href="autovacuum.c.html#LN131"><span class='Ref_to_Const'>MIN_AUTOVAC_SLEEPTIME</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN1059"><span class='Ref_To_Local'>millis_increment</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN131"><span class='Ref_to_Const'>MIN_AUTOVAC_SLEEPTIME</span></a> <span class='Operator'>* </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1058"><span class='Ref_To_Local'>current_time</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * move the elements from the array into the dllist, setting the 
         * next_worker while walking the array 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1063"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="autovacuum.c.html#LN1063"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="autovacuum.c.html#LN944"><span class='Ref_To_Local'>nelems</span></a><span class='Delimiter'>; </span><a href="autovacuum.c.html#LN1063"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1095"></a>            <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>db</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1060"><span class='Ref_To_Local'>dbary</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN1063"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN1058"><span class='Ref_To_Local'>current_time</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1058"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, 
</span>                                                       <a href="autovacuum.c.html#LN1059"><span class='Ref_To_Local'>millis_increment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN1095"><span class='Ref_To_Local'>db</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN160"><span class='Ref_to_Member'>adl_next_worker</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1058"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* later elements should go closer to the head of the list */ 
</span>            <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1095"><span class='Ref_To_Local'>db</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN162"><span class='Ref_to_Member'>adl_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nelems&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* all done, clean up memory */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN280"><span class='Ref_to_Global_Var'>DatabaseListCxt</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN280"><span class='Ref_to_Global_Var'>DatabaseListCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN941"><span class='Ref_To_Local'>tmpcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN280"><span class='Ref_to_Global_Var'>DatabaseListCxt</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN939"><span class='Ref_To_Local'>newcxt</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN940"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rebuild_database_list &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* qsort comparator for avl_dbase, using adl_score */ 
</span><span class='Keyword'>static int 
</span><a name="LN1116"></a><span class='Declare_Function'>db_comparator</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><span class='Keyword'>const </span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1116"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>adl_score <span class='Operator'>== </span><span class='Parentheses'>((</span><span class='Keyword'>const </span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1116"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>adl_score<span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Parentheses'>(((</span><span class='Keyword'>const </span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1116"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>adl_score <span class='Operator'>&LT; </span><span class='Parentheses'>((</span><span class='Keyword'>const </span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1116"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>adl_score<span class='Parentheses'>)</span> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: -</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * do_start_worker 
 * 
 * Bare-bones procedure for starting an autovacuum worker from the launcher. 
 * It determines what database to work on, sets up shared memory stuff and 
 * signals postmaster to start the worker.  It fails gracefully if invoked when 
 * autovacuum_workers are already active. 
 * 
 * Return value is the OID of the database that the worker is going to process, 
 * or InvalidOid if no worker was actually started. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN1136"></a><span class='Declare_Function'>do_start_worker</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1138"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>dblist</span><span class='Delimiter'>; 
</span><a name="LN1139"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN1140"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xidForceLimit</span><span class='Delimiter'>; 
</span><a name="LN1141"></a>    <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiForceLimit</span><span class='Delimiter'>; 
</span><a name="LN1142"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>for_xid_wrap</span><span class='Delimiter'>; 
</span><a name="LN1143"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>for_multi_wrap</span><span class='Delimiter'>; 
</span><a name="LN1144"></a>    <a href="autovacuum.c.html#LN166"><span class='Ref_to_Struct'>avw_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span><span class='Delimiter'>; 
</span><a name="LN1145"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>current_time</span><span class='Delimiter'>; 
</span><a name="LN1146"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>skipit</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1147"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>retval</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN1148"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tmpcxt</span><span class='Delimiter'>, 
</span><a name="LN1149"></a>                <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* return quickly when there are no free workers */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create and switch to a temporary context to avoid leaking the memory 
     * allocated for the database list. 
     */ 
</span>    <a href="autovacuum.c.html#LN1148"><span class='Ref_To_Local'>tmpcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                   <span class='String'>"Start worker tmp cxt"</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1149"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1148"><span class='Ref_To_Local'>tmpcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* use fresh stats */ 
</span>    <a href="autovacuum.c.html#LN356"><span class='Ref_to_Proto'>autovac_refresh_stats</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get a list of databases */ 
</span>    <a href="autovacuum.c.html#LN1138"><span class='Ref_To_Local'>dblist</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN325"><span class='Ref_to_Proto'>get_database_list</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine the oldest datfrozenxid/relfrozenxid that we will allow to 
     * pass without forcing a vacuum.  (This limit can be tightened for 
     * particular tables, but not loosened.) 
     */ 
</span>    <a href="autovacuum.c.html#LN144"><span class='Ref_to_Global_Var'>recentXid</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN178"><span class='Ref_to_Proto'>ReadNewTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1140"><span class='Ref_To_Local'>xidForceLimit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN144"><span class='Ref_to_Global_Var'>recentXid</span></a> <span class='Operator'>- </span><a href="autovacuum.c.html#LN119"><span class='Ref_to_Global_Var'>autovacuum_freeze_max_age</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ensure it's a "normal" XID, else TransactionIdPrecedes misbehaves */ 
</span>    <span class='Comment_Multi_Line'>/* this can cause the limit to go backwards by 3, but that's OK */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1140"><span class='Ref_To_Local'>xidForceLimit</span></a> <span class='Operator'>&LT; </span><a href="../../include/access/transam.h.html#LN33"><span class='Ref_to_Const'>FirstNormalTransactionId</span></a><span class='Parentheses'>) 
</span>        <a href="autovacuum.c.html#LN1140"><span class='Ref_To_Local'>xidForceLimit</span></a> <span class='Operator'>-= </span><a href="../../include/access/transam.h.html#LN33"><span class='Ref_to_Const'>FirstNormalTransactionId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Also determine the oldest datminmxid we will consider. */ 
</span>    <a href="autovacuum.c.html#LN145"><span class='Ref_to_Global_Var'>recentMulti</span></a> <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN109"><span class='Ref_to_Proto'>ReadNextMultiXactId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1141"><span class='Ref_To_Local'>multiForceLimit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN145"><span class='Ref_to_Global_Var'>recentMulti</span></a> <span class='Operator'>- </span><a href="../../include/access/multixact.h.html#LN144"><span class='Ref_to_Proto'>MultiXactMemberFreezeThreshold</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1141"><span class='Ref_To_Local'>multiForceLimit</span></a> <span class='Operator'>&LT; </span><a href="../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>        <a href="autovacuum.c.html#LN1141"><span class='Ref_To_Local'>multiForceLimit</span></a> <span class='Operator'>-= </span><a href="../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Choose a database to connect to.  We pick the database that was least 
     * recently auto-vacuumed, or one that needs vacuuming to prevent Xid 
     * wraparound-related data loss.  If any db at risk of Xid wraparound is 
     * found, we pick the one with oldest datfrozenxid, independently of 
     * autovacuum times; similarly we pick the one with the oldest datminmxid 
     * if any is in MultiXactId wraparound.  Note that those in Xid wraparound 
     * danger are given more priority than those in multi wraparound danger. 
     * 
     * Note that a database with no stats entry is not considered, except for 
     * Xid wraparound purposes.  The theory is that if no one has ever 
     * connected to it since the stats were last initialized, it doesn't need 
     * vacuuming. 
     * 
     * XXX This could be improved if we had more info about whether it needs 
     * vacuuming before connecting to it.  Perhaps look through the pgstats 
     * data for the database's tables?  One idea is to keep track of the 
     * number of new and dead tuples per database in pgstats.  However it 
     * isn't clear how to construct a metric that measures that and not cause 
     * starvation for less busy databases. 
     */ 
</span>    <a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1142"><span class='Ref_To_Local'>for_xid_wrap</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1143"><span class='Ref_To_Local'>for_multi_wrap</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1145"><span class='Ref_To_Local'>current_time</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1139"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1138"><span class='Ref_To_Local'>dblist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1220"></a>        <a href="autovacuum.c.html#LN166"><span class='Ref_to_Struct'>avw_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1139"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1221"></a>        <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check to see if this one is at risk of wraparound */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN170"><span class='Ref_to_Member'>adw_frozenxid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1140"><span class='Ref_To_Local'>xidForceLimit</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>                <a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN170"><span class='Ref_to_Member'>adw_frozenxid</span></a><span class='Delimiter'>, 
</span>                                      <a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN170"><span class='Ref_to_Member'>adw_frozenxid</span></a><span class='Parentheses'>))</span> 
                <a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN1142"><span class='Ref_To_Local'>for_xid_wrap</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1142"><span class='Ref_To_Local'>for_xid_wrap</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* ignore not-at-risk DBs */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN171"><span class='Ref_to_Member'>adw_minmulti</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1141"><span class='Ref_To_Local'>multiForceLimit</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>                <a href="../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN171"><span class='Ref_to_Member'>adw_minmulti</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN171"><span class='Ref_to_Member'>adw_minmulti</span></a><span class='Parentheses'>))</span> 
                <a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN1143"><span class='Ref_To_Local'>for_multi_wrap</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1143"><span class='Ref_To_Local'>for_multi_wrap</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* ignore not-at-risk DBs */ 
</span> 
        <span class='Comment_Multi_Line'>/* Find pgstat entry if any */ 
</span>        <a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN172"><span class='Ref_to_Member'>adw_entry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Skip a database with no pgstat entry; it means it hasn't seen any 
         * activity. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN172"><span class='Ref_to_Member'>adw_entry</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Also, skip a database that appears on the database list as having 
         * been processed recently (less than autovacuum_naptime seconds ago). 
         * We do this so that we don't select a database which we just 
         * selected, but that pgstat hasn't gotten around to updating the last 
         * autovacuum time yet. 
         */ 
</span>        <a href="autovacuum.c.html#LN1146"><span class='Ref_To_Local'>skipit</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/lib/ilist.h.html#LN537"><span class='Ref_to_Macro'>dlist_reverse_foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1221"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1267"></a>            <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>dbp</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Delimiter'>, </span>adl_node<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1221"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1267"><span class='Ref_To_Local'>dbp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN159"><span class='Ref_to_Member'>adl_datid</span></a> <span class='Operator'>== </span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Skip this database if its next_worker value falls between 
                 * the current time and the current time plus naptime. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1267"><span class='Ref_To_Local'>dbp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN160"><span class='Ref_to_Member'>adl_next_worker</span></a><span class='Delimiter'>, 
</span>                                                <a href="autovacuum.c.html#LN1145"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <span class='Operator'>!</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1145"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, 
</span>                                                <a href="autovacuum.c.html#LN1267"><span class='Ref_To_Local'>dbp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN160"><span class='Ref_to_Member'>adl_next_worker</span></a><span class='Delimiter'>, 
</span>                                                <a href="autovacuum.c.html#LN114"><span class='Ref_to_Global_Var'>autovacuum_naptime</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>))</span> 
                    <a href="autovacuum.c.html#LN1146"><span class='Ref_To_Local'>skipit</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1146"><span class='Ref_To_Local'>skipit</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Remember the db with oldest autovac time.  (If we are here, both 
         * tmp-&GT;entry and db-&GT;entry must be non-null.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN172"><span class='Ref_to_Member'>adw_entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN586"><span class='Ref_to_Member'>last_autovac_time</span></a> <span class='Operator'>&LT; </span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN172"><span class='Ref_to_Member'>adw_entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN586"><span class='Ref_to_Member'>last_autovac_time</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1220"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Found a database -- process it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1300"></a>        <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Local'>worker</span><span class='Delimiter'>; 
</span><a name="LN1301"></a>        <a href="../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>wptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get a worker entry from the freelist.  We checked above, so there 
         * really should be a free slot. 
         */ 
</span>        <a href="autovacuum.c.html#LN1301"><span class='Ref_To_Local'>wptr</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN366"><span class='Ref_to_Func'>dlist_pop_head_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1300"><span class='Ref_To_Local'>worker</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN218"><span class='Ref_to_Struct'>WorkerInfoData</span></a><span class='Delimiter'>, </span>wi_links<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1301"><span class='Ref_To_Local'>wptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1300"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dboid <span class='Operator'>= </span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1300"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1300"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_launchtime <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1300"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/pmsignal.h.html#LN45"><span class='Ref_to_Proto'>SendPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN29"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_WORKER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1147"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1144"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if avdb!=NULL &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1146"><span class='Ref_To_Local'>skipit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we skipped all databases on the list, rebuild it, because it 
         * probably contains a dropped database. 
         */ 
</span>        <a href="autovacuum.c.html#LN326"><span class='Ref_to_Proto'>rebuild_database_list</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1149"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1148"><span class='Ref_To_Local'>tmpcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="autovacuum.c.html#LN1147"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end do_start_worker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * launch_worker 
 * 
 * Wrapper for starting a worker from the launcher.  Besides actually starting 
 * it, update the database list to reflect the next time that another one will 
 * need to be started on the selected database.  The actual database choice is 
 * left to do_start_worker. 
 * 
 * This routine is also expected to insert an entry into the database list if 
 * the selected database was previously absent from the list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1351"></a><span class='Declare_Function'>launch_worker</span><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>now</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1353"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span><span class='Delimiter'>; 
</span><a name="LN1354"></a>    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN1353"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN321"><span class='Ref_to_Proto'>do_start_worker</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1353"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1359"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Walk the database list and update the corresponding entry.  If the 
         * database is not on the list, we'll recreate the list. 
         */ 
</span>        <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1354"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1367"></a>            <a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN157"><span class='Ref_to_Struct'>avl_dbase</span></a><span class='Delimiter'>, </span>adl_node<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1354"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1367"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN159"><span class='Ref_to_Member'>adl_datid</span></a> <span class='Operator'>== </span><a href="autovacuum.c.html#LN1353"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="autovacuum.c.html#LN1359"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * add autovacuum_naptime seconds to the current time, and use 
                 * that as the new "next_worker" field for this database. 
                 */ 
</span>                <a href="autovacuum.c.html#LN1367"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN160"><span class='Ref_to_Member'>adl_next_worker</span></a> <span class='Operator'>= 
</span>                    <a href="../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1351"><span class='Ref_to_Parameter'>now</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN114"><span class='Ref_to_Global_Var'>autovacuum_naptime</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/lib/ilist.h.html#LN383"><span class='Ref_to_Func'>dlist_move_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN279"><span class='Ref_to_Global_Var'>DatabaseList</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1354"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the database was not present in the database list, we rebuild 
         * the list.  It's possible that the database does not get into the 
         * list anyway, for example if it's a database that doesn't have a 
         * pgstat entry, but this is not a problem because we don't want to 
         * schedule workers regularly into those in any case. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN1359"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN326"><span class='Ref_to_Proto'>rebuild_database_list</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1353"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if OidIsValid(dbid) &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end launch_worker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Called from postmaster to signal a failure to fork a process to become 
 * worker.  The postmaster should kill(SIGUSR2) the launcher shortly 
 * after calling this function. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1403"></a><span class='Declare_Function'>AutoVacWorkerFailed</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN264"><span class='Ref_to_Member'>av_signal</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN241"><span class='Ref_to_EnumConst'>AutoVacForkFailed</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGHUP: set flag to re-read config file at next convenient time */ 
</span><span class='Keyword'>static void 
</span><a name="LN1410"></a><span class='Declare_Function'>av_sighup_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1412"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="autovacuum.c.html#LN1412"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGUSR2: a worker is up and running, or just finished, or failed to fork */ 
</span><span class='Keyword'>static void 
</span><a name="LN1422"></a><span class='Declare_Function'>avl_sigusr2_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1424"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN140"><span class='Ref_to_Global_Var'>got_SIGUSR2</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="autovacuum.c.html#LN1424"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGTERM: time to die */ 
</span><span class='Keyword'>static void 
</span><a name="LN1434"></a><span class='Declare_Function'>avl_sigterm_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1436"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="pgarch.c.html#LN76"><span class='Ref_to_Global_Var'>got_SIGTERM</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="autovacuum.c.html#LN1436"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/******************************************************************** 
 *                    AUTOVACUUM WORKER CODE 
 ********************************************************************/ 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
<span class='Comment_Multi_Line'>/* 
 * forkexec routines for the autovacuum worker. 
 * 
 * Format up the arglist, then fork and exec. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN1456"></a><span class='Declare_Function'>avworker_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1458"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN1459"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN1458"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN1459"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1458"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN1459"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"--forkavworker"</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1458"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN1459"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by postmaster_forkexec */ 
</span>    <a href="autovacuum.c.html#LN1458"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN1459"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1459"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1458"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/postmaster/postmaster.h.html#LN57"><span class='Ref_to_Proto'>postmaster_forkexec</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1459"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1458"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We need this set from the outside, before InitProcess is called 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1475"></a><span class='Declare_Function'>AutovacuumWorkerIAm</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="autovacuum.c.html#LN136"><span class='Ref_to_Global_Var'>am_autovacuum_worker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Main entry point for autovacuum worker process. 
 * 
 * This code is heavily based on pgarch.c, q.v. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1487"></a><span class='Declare_Function'>StartAutoVacWorker</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1489"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>worker_pid</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN1489"><span class='Ref_To_Local'>worker_pid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN316"><span class='Ref_to_Proto'>avworker_forkexec</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN1489"><span class='Ref_To_Local'>worker_pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork autovacuum worker process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> EXEC_BACKEND 
        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster child ... */ 
</span>            <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>            <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN1524"><span class='Ref_to_Func'>AutoVacWorkerMain</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1489"><span class='Ref_To_Local'>worker_pid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch (worker_pid=fork_proc... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* shouldn't get here */ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartAutoVacWorker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AutoVacWorkerMain 
 */ 
</span><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void 
</span><a name="LN1525"></a><span class='Declare_Function'>AutoVacWorkerMain</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1527"></a>    <a href="../../include/c.h.html#LN1087"><span class='Ref_to_Const'>sigjmp_buf</span></a>  <span class='Declare_Local'>local_sigjmp_buf</span><span class='Delimiter'>; 
</span><a name="LN1528"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN136"><span class='Ref_to_Global_Var'>am_autovacuum_worker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Identify myself via ps */ 
</span>    <a href="../../include/utils/ps_status.h.html#LN18"><span class='Ref_to_Proto'>init_ps_display</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum worker process"</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN375"><span class='Ref_to_Macro'>SetProcessingMode</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN363"><span class='Ref_to_EnumConst'>InitProcessing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up signal handlers.  We operate on databases much like a regular 
     * backend, so we use the same signal handling.  See equivalent code in 
     * tcop/postgres.c. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN353"><span class='Ref_to_Proto'>av_sighup_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SIGINT is used to signal canceling the current table's vacuum; SIGTERM 
     * means abort and exit cleanly, and SIGQUIT means abandon ship. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="../../include/tcop/tcopprot.h.html#LN69"><span class='Ref_to_Proto'>StatementCancelHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="../tcop/postgres.c.html#LN2554"><span class='Ref_to_Func'>quickdie</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/timeout.h.html#LN69"><span class='Ref_to_Proto'>InitializeTimeouts</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* establishes SIGALRM handler */ 
</span> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="../../include/storage/procsignal.h.html#LN58"><span class='Ref_to_Proto'>procsignal_sigusr1_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGFPE<span class='Delimiter'>, </span><a href="../tcop/postgres.c.html#LN2667"><span class='Ref_to_Func'>FloatExceptionHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Early initialization */ 
</span>    <a href="../../include/miscadmin.h.html#LN424"><span class='Ref_to_Proto'>BaseInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a per-backend PGPROC struct in shared memory, except in the 
     * EXEC_BACKEND case where this was done in SubPostmasterMain. We must do 
     * this before we can use LWLocks (and in the EXEC_BACKEND case we already 
     * had to do some stuff with LWLocks). 
     */ 
</span><span class='Directive'>#ifndef</span> EXEC_BACKEND 
    <a href="../storage/lmgr/proc.c.html#LN285"><span class='Ref_to_Func'>InitProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If an exception is encountered, processing resumes here. 
     * 
     * See notes in postgres.c about the design of this coding. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1088"><span class='Ref_to_Macro'>sigsetjmp</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1527"><span class='Ref_To_Local'>local_sigjmp_buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Prevents interrupts while cleaning up */ 
</span>        <a href="../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Report the error to the server log */ 
</span>        <a href="../../include/utils/elog.h.html#LN362"><span class='Ref_to_Proto'>EmitErrorReport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can now go away.  Note that because we called InitProcess, a 
         * callback was registered to do ProcKill, which will clean up 
         * necessary state. 
         */ 
</span>        <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* We can now handle ereport(ERROR) */ 
</span>    <a href="../utils/error/elog.c.html#LN89"><span class='Ref_to_Global_Var'>PG_exception_stack</span></a> <span class='Operator'>= &</span><a href="autovacuum.c.html#LN1527"><span class='Ref_To_Local'>local_sigjmp_buf</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force zero_damaged_pages OFF in the autovac process, even if it is set 
     * in postgresql.conf.  We don't really want such a dangerous option being 
     * applied non-interactively. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"zero_damaged_pages"</span><span class='Delimiter'>, </span><span class='String'>"false"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force settable timeouts off to avoid letting these settings prevent 
     * regular maintenance from being executed. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"statement_timeout"</span><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"lock_timeout"</span><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"idle_in_transaction_session_timeout"</span><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force default_transaction_isolation to READ COMMITTED.  We don't want 
     * to pay the overhead of serializable mode, nor add any risk of causing 
     * deadlocks or delaying other transactions. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"default_transaction_isolation"</span><span class='Delimiter'>, </span><span class='String'>"read committed"</span><span class='Delimiter'>, 
</span>                    <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force synchronous replication off to allow regular maintenance even if 
     * we are waiting for standbys to connect. This is important to ensure we 
     * aren't blocked from performing anti-wraparound tasks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../access/transam/xact.c.html#LN81"><span class='Ref_to_Global_Var'>synchronous_commit</span></a> <span class='Operator'>&GT; </span><a href="../../include/access/xact.h.html#LN59"><span class='Ref_to_EnumConst'>SYNCHRONOUS_COMMIT_LOCAL_FLUSH</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"synchronous_commit"</span><span class='Delimiter'>, </span><span class='String'>"local"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the info about the database we're going to work on. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * beware of startingWorker being INVALID; this should normally not 
     * happen, but if a worker fails after forking and before this, the 
     * launcher might have decided to remove it from the queue and start 
     * again. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1528"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_dboid<span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>= </span><a href="../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* insert into the running list */ 
</span>        <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN267"><span class='Ref_to_Member'>av_runningWorkers</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_links<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * remove from the "starting" pointer, so that the launcher can start 
         * a new worker if required 
         */ 
</span>        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/ipc.h.html#LN69"><span class='Ref_to_Proto'>on_shmem_exit</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN331"><span class='Ref_to_Proto'>FreeWorkerInfo</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* wake up the launcher */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN265"><span class='Ref_to_Member'>av_launcherpid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN265"><span class='Ref_to_Member'>av_launcherpid</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if AutoVacuumShmem-&GT;av_s... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* no worker entry for me, go away */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"autovacuum worker started without a worker entry"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1528"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1528"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1675"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>dbname</span><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* First use of DSA in this worker, so attach to it */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN106"><span class='Ref_to_Proto'>dsa_attach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/dsa.h.html#LN111"><span class='Ref_to_Proto'>dsa_pin_mapping</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Report autovac startup to the stats collector.  We deliberately do 
         * this before InitPostgres, so that the last_autovac_time will get 
         * updated even if the connection attempt fails.  This is to prevent 
         * autovac from getting "stuck" repeatedly selecting an unopenable 
         * database, rather than making any progress on stuff it can connect 
         * to. 
         */ 
</span>        <a href="../../include/pgstat.h.html#LN1155"><span class='Ref_to_Proto'>pgstat_report_autovac</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1528"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Connect to the selected database 
         * 
         * Note: if we have selected a just-deleted database (due to using 
         * stale stats info), we'll fail and exit here. 
         */ 
</span>        <a href="../../include/miscadmin.h.html#LN422"><span class='Ref_to_Proto'>InitPostgres</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1528"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1675"><span class='Ref_To_Local'>dbname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/miscadmin.h.html#LN375"><span class='Ref_to_Macro'>SetProcessingMode</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN364"><span class='Ref_to_EnumConst'>NormalProcessing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/ps_status.h.html#LN21"><span class='Ref_to_Proto'>set_ps_display</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1675"><span class='Ref_To_Local'>dbname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum: processing database \"%s\""</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1675"><span class='Ref_To_Local'>dbname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../tcop/postgres.c.html#LN98"><span class='Ref_to_Global_Var'>PostAuthDelay</span></a><span class='Parentheses'>) 
</span>            <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="../tcop/postgres.c.html#LN98"><span class='Ref_to_Global_Var'>PostAuthDelay</span></a> <span class='Operator'>* </span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And do an appropriate amount of work */ 
</span>        <a href="autovacuum.c.html#LN144"><span class='Ref_to_Global_Var'>recentXid</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN178"><span class='Ref_to_Proto'>ReadNewTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN145"><span class='Ref_to_Global_Var'>recentMulti</span></a> <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN109"><span class='Ref_to_Proto'>ReadNextMultiXactId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN330"><span class='Ref_to_Proto'>do_autovacuum</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if OidIsValid(dbid) &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * The launcher will be notified of my death in ProcKill, *if* we managed 
     * to get a worker slot at all 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* All done, go away */ 
</span>    <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AutoVacWorkerMain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return a WorkerInfo to the free list 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1729"></a><span class='Declare_Function'>FreeWorkerInfo</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Wake the launcher up so that he can launch a new worker immediately 
         * if required.  We only save the launcher's PID in local memory here; 
         * the actual signal will be sent when the PGPROC is recycled.  Note 
         * that we always do this, so that the launcher can rebalance the cost 
         * limit setting of the remaining workers. 
         * 
         * We somewhat ignore the risk that the launcher changes its PID 
         * between us reading it and the actual kill; we expect ProcKill to be 
         * called shortly after us, and we assume that PIDs are not reused too 
         * quickly after a process exits. 
         */ 
</span>        <a href="autovacuum.c.html#LN312"><span class='Ref_to_Global_Var'>AutovacuumLauncherPid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN265"><span class='Ref_to_Member'>av_launcherpid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_links<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_dboid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_tableoid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_sharedrel <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_launchtime <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_dobalance <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_delay <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_limit <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_links<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* not mine anymore */ 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * now that we're inactive, cause a rebalancing of the surviving 
         * workers 
         */ 
</span>        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN264"><span class='Ref_to_Member'>av_signal</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN242"><span class='Ref_to_EnumConst'>AutoVacRebalance</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if MyWorkerInfo!=NULL &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end FreeWorkerInfo &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update the cost-based delay parameters, so that multiple workers consume 
 * each a fraction of the total available I/O. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1778"></a><span class='Declare_Function'>AutoVacuumUpdateDelay</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../utils/init/globals.c.html#LN132"><span class='Ref_to_Global_Var'>VacuumCostDelay</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_delay<span class='Delimiter'>; 
</span>        <a href="../utils/init/globals.c.html#LN131"><span class='Ref_to_Global_Var'>VacuumCostLimit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_limit<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * autovac_balance_cost 
 *      Recalculate the cost limit setting for each active worker. 
 * 
 * Caller must hold the AutovacuumLock in exclusive mode. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1794"></a><span class='Declare_Function'>autovac_balance_cost</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * The idea here is that we ration out I/O equally.  The amount of I/O 
     * that a worker can consume is determined by cost_limit/cost_delay, so we 
     * try to equalize those ratios rather than the raw limit settings. 
     * 
     * note: in cost_limit, zero also means use value from elsewhere, because 
     * zero is not a valid value. 
     */ 
</span><a name="LN1804"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>vac_cost_limit</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN123"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_limit</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>? 
</span>                                <a href="autovacuum.c.html#LN123"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_limit</span></a> <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN131"><span class='Ref_to_Global_Var'>VacuumCostLimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1806"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>vac_cost_delay</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN122"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_delay</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>? 
</span>                                <a href="autovacuum.c.html#LN122"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_delay</span></a> <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN132"><span class='Ref_to_Global_Var'>VacuumCostDelay</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1808"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>cost_total</span><span class='Delimiter'>; 
</span><a name="LN1809"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>cost_avail</span><span class='Delimiter'>; 
</span><a name="LN1810"></a>    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* not set? nothing to do */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1804"><span class='Ref_To_Local'>vac_cost_limit</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="autovacuum.c.html#LN1806"><span class='Ref_To_Local'>vac_cost_delay</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* calculate the total base cost limit of participating active workers */ 
</span>    <a href="autovacuum.c.html#LN1808"><span class='Ref_To_Local'>cost_total</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1810"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN267"><span class='Ref_to_Member'>av_runningWorkers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1820"></a>        <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Local'>worker</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN218"><span class='Ref_to_Struct'>WorkerInfoData</span></a><span class='Delimiter'>, </span>wi_links<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1810"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1820"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="autovacuum.c.html#LN1820"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dobalance <span class='Operator'>&& 
</span>            <a href="autovacuum.c.html#LN1820"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN1820"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_delay <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN1808"><span class='Ref_To_Local'>cost_total</span></a> <span class='Operator'>+= 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1820"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base <span class='Operator'>/ </span><a href="autovacuum.c.html#LN1820"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_delay<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* there are no cost limits -- nothing to do */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1808"><span class='Ref_To_Local'>cost_total</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Adjust cost limit of each active worker to balance the total of cost 
     * limit to autovacuum_vacuum_cost_limit. 
     */ 
</span>    <a href="autovacuum.c.html#LN1809"><span class='Ref_To_Local'>cost_avail</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN1804"><span class='Ref_To_Local'>vac_cost_limit</span></a> <span class='Operator'>/ </span><a href="autovacuum.c.html#LN1806"><span class='Ref_To_Local'>vac_cost_delay</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1810"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN267"><span class='Ref_to_Member'>av_runningWorkers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1840"></a>        <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Local'>worker</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN218"><span class='Ref_to_Struct'>WorkerInfoData</span></a><span class='Delimiter'>, </span>wi_links<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1810"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dobalance <span class='Operator'>&& 
</span>            <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_delay <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1846"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>limit</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1809"><span class='Ref_To_Local'>cost_avail</span></a> <span class='Operator'>* </span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base <span class='Operator'>/ </span><a href="autovacuum.c.html#LN1808"><span class='Ref_To_Local'>cost_total</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We put a lower bound of 1 on the cost_limit, to avoid division- 
             * by-zero in the vacuum code.  Also, in case of roundoff trouble 
             * in these calculations, let's be sure we don't ever set 
             * cost_limit to more than the base value. 
             */ 
</span>            <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1846"><span class='Ref_To_Local'>limit</span></a><span class='Delimiter'>, 
</span>                                            <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                        <span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_proc <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"autovac_balance_cost(pid=%u db=%u, rel=%u, dobalance=%s cost_limit=%d, cost_limit_base=%d, cost_delay=%d)"</span><span class='Delimiter'>, 
</span>                 <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_proc<span class='Operator'>-&GT;</span>pid<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dboid<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_tableoid<span class='Delimiter'>, 
</span>                 <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dobalance <span class='Operator'>? </span><span class='String'>"yes"</span> <span class='Operator'>: </span><span class='String'>"no"</span><span class='Delimiter'>, 
</span>                 <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base<span class='Delimiter'>, 
</span>                 <a href="autovacuum.c.html#LN1840"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_cost_delay<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end autovac_balance_cost &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_database_list 
 *      Return a list of all databases found in pg_database. 
 * 
 * The list and associated data is allocated in the caller's memory context, 
 * which is in charge of ensuring that it's properly cleaned up afterwards. 
 * 
 * Note: this is the only function in which the autovacuum launcher uses a 
 * transaction.  Although we aren't attached to any particular database and 
 * therefore can't access most catalogs, we do have enough infrastructure 
 * to do a seqscan on pg_database. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN1882"></a><span class='Declare_Function'>get_database_list</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1884"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>dblist</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1885"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1886"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1887"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN1888"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>resultcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This is the context that we will allocate our output data in */ 
</span>    <a href="autovacuum.c.html#LN1888"><span class='Ref_To_Local'>resultcxt</span></a> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start a transaction so we can access pg_database, and get a snapshot. 
     * We don't have a use for the snapshot itself, but we're interested in 
     * the secondary effect that it sets RecentGlobalXmin.  (This is critical 
     * for anything that reads heap pages, because HOT may decide to prune 
     * them even if the process doesn't attempt to modify any tuples.) 
     */ 
</span>    <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN1885"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1886"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1885"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1887"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1886"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1908"></a>        <a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a> <span class='Declare_Local'>pgdatabase</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1887"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1909"></a>        <a href="autovacuum.c.html#LN166"><span class='Ref_to_Struct'>avw_dbase</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>avdb</span><span class='Delimiter'>; 
</span><a name="LN1910"></a>        <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allocate our results in the caller's context, not the 
         * transaction's. We do this inside the loop, and restore the original 
         * context at the end, so that leaky things like heap_getnext() are 
         * not called in a potentially long-lived context. 
         */ 
</span>        <a href="autovacuum.c.html#LN1910"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1888"><span class='Ref_To_Local'>resultcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN166"><span class='Ref_to_Struct'>avw_dbase</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN166"><span class='Ref_to_Struct'>avw_dbase</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN168"><span class='Ref_to_Member'>adw_datid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1887"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN169"><span class='Ref_to_Member'>adw_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1908"><span class='Ref_To_Local'>pgdatabase</span></a><span class='Operator'>-&GT;</span>datname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN170"><span class='Ref_to_Member'>adw_frozenxid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1908"><span class='Ref_To_Local'>pgdatabase</span></a><span class='Operator'>-&GT;</span>datfrozenxid<span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN171"><span class='Ref_to_Member'>adw_minmulti</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN1908"><span class='Ref_To_Local'>pgdatabase</span></a><span class='Operator'>-&GT;</span>datminmxid<span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* this gets set later: */ 
</span>        <a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN172"><span class='Ref_to_Member'>adw_entry</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1884"><span class='Ref_To_Local'>dblist</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1884"><span class='Ref_To_Local'>dblist</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1909"><span class='Ref_To_Local'>avdb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1910"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while HeapTupleIsValid(tup=... &raquo; </span> 
 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1886"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1885"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="autovacuum.c.html#LN1884"><span class='Ref_To_Local'>dblist</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_database_list &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process a database table-by-table 
 * 
 * Note that CHECK_FOR_INTERRUPTS is supposed to be used in certain spots in 
 * order not to ignore shutdown commands for too long. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1948"></a><span class='Declare_Function'>do_autovacuum</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1950"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>classRel</span><span class='Delimiter'>; 
</span><a name="LN1951"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1952"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>relScan</span><span class='Delimiter'>; 
</span><a name="LN1953"></a>    <a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a> <span class='Declare_Local'>dbForm</span><span class='Delimiter'>; 
</span><a name="LN1954"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>table_oids</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1955"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>orphan_oids</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1956"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span><a name="LN1957"></a>    <a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>table_toast_map</span><span class='Delimiter'>; 
</span><a name="LN1958"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN1959"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>shared</span><span class='Delimiter'>; 
</span><a name="LN1960"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN1961"></a>    <a href="../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Local'>bstrategy</span><span class='Delimiter'>; 
</span><a name="LN1962"></a>    <a href="../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN1963"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>pg_class_desc</span><span class='Delimiter'>; 
</span><a name="LN1964"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>effective_multixact_freeze_max_age</span><span class='Delimiter'>; 
</span><a name="LN1965"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>did_vacuum</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1966"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found_concurrent_worker</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * StartTransactionCommand and CommitTransactionCommand will automatically 
     * switch to other contexts.  We need this one to keep the list of 
     * relations to vacuum/analyze across transactions. 
     */ 
</span>    <a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"AV worker"</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * may be NULL if we couldn't find an entry (only happens if we are 
     * forcing a vacuum for anti-wrap purposes). 
     */ 
</span>    <a href="autovacuum.c.html#LN1960"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Start a transaction so our commands have one to play into. */ 
</span>    <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clean up any dead statistics collector entries for this DB. We always 
     * want to do this exactly once per DB-processing cycle, even if we find 
     * nothing worth vacuuming in the database. 
     */ 
</span>    <a href="pgstat.c.html#LN1020"><span class='Ref_to_Func'>pgstat_vacuum_stat</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the multixact age for which freezing is urgent.  This is 
     * normally autovacuum_multixact_freeze_max_age, but may be less if we are 
     * short of multixact member space. 
     */ 
</span>    <a href="autovacuum.c.html#LN1964"><span class='Ref_To_Local'>effective_multixact_freeze_max_age</span></a> <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN144"><span class='Ref_to_Proto'>MultiXactMemberFreezeThreshold</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find the pg_database entry and select the default freeze ages. We use 
     * zero in template and nonconnectable databases, else the system-wide 
     * default. 
     */ 
</span>    <a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN54"><span class='Ref_to_EnumConst'>DATABASEOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for database %u"</span><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1953"><span class='Ref_To_Local'>dbForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_database</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1953"><span class='Ref_To_Local'>dbForm</span></a><span class='Operator'>-&GT;</span>datistemplate <span class='Operator'>|| !</span><a href="autovacuum.c.html#LN1953"><span class='Ref_To_Local'>dbForm</span></a><span class='Operator'>-&GT;</span>datallowconn<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN148"><span class='Ref_to_Global_Var'>default_freeze_min_age</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN149"><span class='Ref_to_Global_Var'>default_freeze_table_age</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN150"><span class='Ref_to_Global_Var'>default_multixact_freeze_min_age</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN151"><span class='Ref_to_Global_Var'>default_multixact_freeze_table_age</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN148"><span class='Ref_to_Global_Var'>default_freeze_min_age</span></a> <span class='Operator'>= </span><a href="../commands/vacuum.c.html#LN57"><span class='Ref_to_Global_Var'>vacuum_freeze_min_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN149"><span class='Ref_to_Global_Var'>default_freeze_table_age</span></a> <span class='Operator'>= </span><a href="../commands/vacuum.c.html#LN58"><span class='Ref_to_Global_Var'>vacuum_freeze_table_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN150"><span class='Ref_to_Global_Var'>default_multixact_freeze_min_age</span></a> <span class='Operator'>= </span><a href="../commands/vacuum.c.html#LN59"><span class='Ref_to_Global_Var'>vacuum_multixact_freeze_min_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN151"><span class='Ref_to_Global_Var'>default_multixact_freeze_table_age</span></a> <span class='Operator'>= </span><a href="../commands/vacuum.c.html#LN60"><span class='Ref_to_Global_Var'>vacuum_multixact_freeze_table_age</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* StartTransactionCommand changed elsewhere */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The database hash where pgstat keeps shared relations */ 
</span>    <a href="autovacuum.c.html#LN1959"><span class='Ref_To_Local'>shared</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN1950"><span class='Ref_To_Local'>classRel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create a copy so we can use it after closing pg_class */ 
</span>    <a href="autovacuum.c.html#LN1963"><span class='Ref_To_Local'>pg_class_desc</span></a> <span class='Operator'>= </span><a href="../../include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1950"><span class='Ref_To_Local'>classRel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create hash table for toast &LT;-&GT; main relid mapping */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1956"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1956"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1956"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN1956"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN176"><span class='Ref_to_Struct'>av_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN1957"><span class='Ref_To_Local'>table_toast_map</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"TOAST to main relid map"</span><span class='Delimiter'>, 
</span>                                  <span class='Number'>100</span><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="autovacuum.c.html#LN1956"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan pg_class to determine which tables to vacuum. 
     * 
     * We do this in two passes: on the first one we collect the list of plain 
     * relations and materialized views, and on the second one we collect 
     * TOAST tables. The reason for doing the second pass is that during it we 
     * want to use the main relation's pg_class.reloptions entry if the TOAST 
     * table does not have any, and we cannot obtain it unless we know 
     * beforehand what's the main table OID. 
     * 
     * We need to check TOAST tables separately because in cases with short, 
     * wide tables there might be proportionally much more activity in the 
     * TOAST table than in its parent. 
     */ 
</span>    <a href="autovacuum.c.html#LN1952"><span class='Ref_To_Local'>relScan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1950"><span class='Ref_To_Local'>classRel</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On the first pass, we collect main tables to vacuum, and also the main 
     * table relid to TOAST relid mapping. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1952"><span class='Ref_To_Local'>relScan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2071"></a>        <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2072"></a>        <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN2073"></a>        <a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Local'>relopts</span><span class='Delimiter'>; 
</span><a name="LN2074"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN2075"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>dovacuum</span><span class='Delimiter'>; 
</span><a name="LN2076"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>doanalyze</span><span class='Delimiter'>; 
</span><a name="LN2077"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>wraparound</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>            <a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2074"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check if it is a temp table (presumably, of some other backend's). 
         * We cannot safely process other backends' temp tables. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2091"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>backendID</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN2091"><span class='Ref_To_Local'>backendID</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN128"><span class='Ref_to_Proto'>GetTempNamespaceBackendId</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* We just ignore it if the owning backend is still active */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2091"><span class='Ref_To_Local'>backendID</span></a> <span class='Operator'>!= </span><a href="../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2091"><span class='Ref_To_Local'>backendID</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>|| 
</span>                 <a href="../../include/storage/sinvaladt.h.html#LN33"><span class='Ref_to_Proto'>BackendIdGetProc</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2091"><span class='Ref_To_Local'>backendID</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The table seems to be orphaned -- although it might be that 
                 * the owning backend has already deleted it and exited; our 
                 * pg_class scan snapshot is not necessarily up-to-date 
                 * anymore, so we could be looking at a committed-dead entry. 
                 * Remember it so we can try to delete it later. 
                 */ 
</span>                <a href="autovacuum.c.html#LN1955"><span class='Ref_To_Local'>orphan_oids</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN162"><span class='Ref_to_Func'>lappend_oid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1955"><span class='Ref_To_Local'>orphan_oids</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2074"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if classForm-&GT;relpersist... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Fetch reloptions and the pgstat entry for this table */ 
</span>        <a href="autovacuum.c.html#LN2073"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN344"><span class='Ref_to_Proto'>extract_autovac_opts</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1963"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2072"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN346"><span class='Ref_to_Proto'>get_pgstat_tabentry_relid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2074"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Delimiter'>, 
</span>                                             <a href="autovacuum.c.html#LN1959"><span class='Ref_To_Local'>shared</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1960"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check if it needs vacuum or analyze */ 
</span>        <a href="autovacuum.c.html#LN336"><span class='Ref_to_Proto'>relation_needs_vacanalyze</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2074"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2073"><span class='Ref_To_Local'>relopts</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2072"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>, 
</span>                                  <a href="autovacuum.c.html#LN1964"><span class='Ref_To_Local'>effective_multixact_freeze_max_age</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="autovacuum.c.html#LN2075"><span class='Ref_To_Local'>dovacuum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2076"><span class='Ref_To_Local'>doanalyze</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2077"><span class='Ref_To_Local'>wraparound</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Relations that need work are added to table_oids */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2075"><span class='Ref_To_Local'>dovacuum</span></a> <span class='Operator'>|| </span><a href="autovacuum.c.html#LN2076"><span class='Ref_To_Local'>doanalyze</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN1954"><span class='Ref_To_Local'>table_oids</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN162"><span class='Ref_to_Func'>lappend_oid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1954"><span class='Ref_To_Local'>table_oids</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2074"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Remember TOAST associations for the second pass.  Note: we must do 
         * this whether or not the table is going to be vacuumed, because we 
         * don't automatically vacuum toast tables along the parent table. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2133"></a>            <a href="autovacuum.c.html#LN176"><span class='Ref_to_Struct'>av_relation</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN2134"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN2133"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1957"><span class='Ref_To_Local'>table_toast_map</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="autovacuum.c.html#LN2071"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2134"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2134"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* hash_search already filled in the key */ 
</span>                <a href="autovacuum.c.html#LN2133"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN179"><span class='Ref_to_Member'>ar_relid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2074"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN2133"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN180"><span class='Ref_to_Member'>ar_hasrelopts</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2073"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="autovacuum.c.html#LN2133"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN180"><span class='Ref_to_Member'>ar_hasrelopts</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2133"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN181"><span class='Ref_to_Member'>ar_reloptions</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2073"><span class='Ref_To_Local'>relopts</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if OidIsValid(classForm-... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=heap_getnext(r... &raquo; </span> 
 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1952"><span class='Ref_To_Local'>relScan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* second pass: check TOAST tables */ 
</span>    <a href="../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1962"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/catalog/pg_class.h.html#LN117"><span class='Ref_to_Const'>Anum_pg_class_relkind</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_CHAREQ<span class='Delimiter'>, 
</span>                <a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN1952"><span class='Ref_To_Local'>relScan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN110"><span class='Ref_to_Proto'>heap_beginscan_catalog</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1950"><span class='Ref_To_Local'>classRel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN1962"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1952"><span class='Ref_To_Local'>relScan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2166"></a>        <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classForm</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2167"></a>        <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN2168"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN2169"></a>        <a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Local'>relopts</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2170"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>dovacuum</span><span class='Delimiter'>; 
</span><a name="LN2171"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>doanalyze</span><span class='Delimiter'>; 
</span><a name="LN2172"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>wraparound</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We cannot safely process other backends' temp tables, so skip 'em. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2166"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2168"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * fetch reloptions -- if this toast table does not have them, try the 
         * main rel 
         */ 
</span>        <a href="autovacuum.c.html#LN2169"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN344"><span class='Ref_to_Proto'>extract_autovac_opts</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1963"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2169"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2189"></a>            <a href="autovacuum.c.html#LN176"><span class='Ref_to_Struct'>av_relation</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN2190"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN2189"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1957"><span class='Ref_To_Local'>table_toast_map</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2168"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2190"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2190"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2189"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN180"><span class='Ref_to_Member'>ar_hasrelopts</span></a><span class='Parentheses'>) 
</span>                <a href="autovacuum.c.html#LN2169"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>= &</span><a href="autovacuum.c.html#LN2189"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN181"><span class='Ref_to_Member'>ar_reloptions</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch the pgstat entry for this table */ 
</span>        <a href="autovacuum.c.html#LN2167"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN346"><span class='Ref_to_Proto'>get_pgstat_tabentry_relid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2168"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2166"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Delimiter'>, 
</span>                                             <a href="autovacuum.c.html#LN1959"><span class='Ref_To_Local'>shared</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1960"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN336"><span class='Ref_to_Proto'>relation_needs_vacanalyze</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2168"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2169"><span class='Ref_To_Local'>relopts</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2166"><span class='Ref_To_Local'>classForm</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2167"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>, 
</span>                                  <a href="autovacuum.c.html#LN1964"><span class='Ref_To_Local'>effective_multixact_freeze_max_age</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="autovacuum.c.html#LN2170"><span class='Ref_To_Local'>dovacuum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2171"><span class='Ref_To_Local'>doanalyze</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2172"><span class='Ref_To_Local'>wraparound</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ignore analyze for toast tables */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2170"><span class='Ref_To_Local'>dovacuum</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN1954"><span class='Ref_To_Local'>table_oids</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN162"><span class='Ref_to_Func'>lappend_oid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1954"><span class='Ref_To_Local'>table_oids</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2168"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=heap_getnext(r... &raquo; </span> 
 
    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1952"><span class='Ref_To_Local'>relScan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1950"><span class='Ref_To_Local'>classRel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recheck orphan temporary tables, and if they still seem orphaned, drop 
     * them.  We'll eat a transaction per dropped table, which might seem 
     * excessive, but we should only need to do anything as a result of a 
     * previous backend crash, so this should not happen often enough to 
     * justify "optimizing".  Using separate transactions ensures that we 
     * don't bloat the lock table if there are many temp tables to be dropped, 
     * and it ensures that we don't lose work if a deletion attempt fails. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1958"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1955"><span class='Ref_To_Local'>orphan_oids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2224"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1958"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2225"></a>        <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classForm</span><span class='Delimiter'>; 
</span><a name="LN2226"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>backendID</span><span class='Delimiter'>; 
</span><a name="LN2227"></a>        <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>object</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check for user-requested abort. 
         */ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Try to lock the table.  If we can't get the lock immediately, 
         * somebody else is using (or dropping) the table, so it's not our 
         * concern anymore.  Having the lock prevents race conditions below. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/lmgr.h.html#LN40"><span class='Ref_to_Proto'>ConditionalLockRelationOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2224"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Re-fetch the pg_class tuple and re-check whether it still seems to 
         * be an orphaned temp table.  If it's not there or no longer the same 
         * relation, ignore it. 
         */ 
</span>        <a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2224"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* be sure to drop useless lock so we don't bloat lock table */ 
</span>            <a href="../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2224"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1951"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make all the same tests made in the loop above.  In event of OID 
         * counter wraparound, the pg_class entry we have now might be 
         * completely unrelated to the one we saw before. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>((</span><a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>               <a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>              <a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relpersistence <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN171"><span class='Ref_to_Const'>RELPERSISTENCE_TEMP</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2224"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="autovacuum.c.html#LN2226"><span class='Ref_To_Local'>backendID</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN128"><span class='Ref_to_Proto'>GetTempNamespaceBackendId</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2226"><span class='Ref_To_Local'>backendID</span></a> <span class='Operator'>!= </span><a href="../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a> <span class='Operator'>&& 
</span>              <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2226"><span class='Ref_To_Local'>backendID</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>|| 
</span>               <a href="../../include/storage/sinvaladt.h.html#LN33"><span class='Ref_to_Proto'>BackendIdGetProc</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2226"><span class='Ref_To_Local'>backendID</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2224"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* OK, let's delete it */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum: dropping orphan temp table \"%s.%s.%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relnamespace<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2225"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relname<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2227"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2227"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2224"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2227"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/dependency.h.html#LN182"><span class='Ref_to_Proto'>performDeletion</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2227"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN1655"><span class='Ref_to_EnumConst'>DROP_CASCADE</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/catalog/dependency.h.html#LN173"><span class='Ref_to_Const'>PERFORM_DELETION_INTERNAL</span></a> <span class='Operator'>| 
</span>                        <a href="../../include/catalog/dependency.h.html#LN175"><span class='Ref_to_Const'>PERFORM_DELETION_QUIETLY</span></a> <span class='Operator'>| 
</span>                        <a href="../../include/catalog/dependency.h.html#LN177"><span class='Ref_to_Const'>PERFORM_DELETION_SKIP_EXTENSIONS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * To commit the deletion, end current transaction and start a new 
         * one.  Note this also releases the lock we took. 
         */ 
</span>        <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* StartTransactionCommand changed current memory context */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a buffer access strategy object for VACUUM to use.  We want to 
     * use the same one across all the vacuum operations we perform, since the 
     * point is for VACUUM not to blow out the shared cache. 
     */ 
</span>    <a href="autovacuum.c.html#LN1961"><span class='Ref_To_Local'>bstrategy</span></a> <span class='Operator'>= </span><a href="../../include/storage/bufmgr.h.html#LN231"><span class='Ref_to_Proto'>GetAccessStrategy</span></a><span class='Parentheses'>(</span><a href="../../include/storage/bufmgr.h.html#LN33"><span class='Ref_to_EnumConst'>BAS_VACUUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * create a memory context to act as fake PortalContext, so that the 
     * contexts created in the vacuum code are cleaned up for each table. 
     */ 
</span>    <a href="../utils/mmgr/mcxt.c.html#LN51"><span class='Ref_to_Global_Var'>PortalContext</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Delimiter'>, 
</span>                                          <span class='String'>"Autovacuum Portal"</span><span class='Delimiter'>, 
</span>                                          <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Perform operations on collected tables. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1958"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1954"><span class='Ref_To_Local'>table_oids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2323"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN107"><span class='Ref_to_Macro'>lfirst_oid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1958"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2324"></a>        <a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tab</span><span class='Delimiter'>; 
</span><a name="LN2325"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>skipit</span><span class='Delimiter'>; 
</span><a name="LN2326"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>stdVacuumCostDelay</span><span class='Delimiter'>; 
</span><a name="LN2327"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>stdVacuumCostLimit</span><span class='Delimiter'>; 
</span><a name="LN2328"></a>        <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check for config changes before processing each collected table. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * You might be tempted to bail out if we see autovacuum is now 
             * disabled.  Must resist that temptation -- this might be a 
             * for-wraparound emergency worker, in which case that would be 
             * entirely inappropriate. 
             */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * hold schedule lock from here until we're sure that this table still 
         * needs vacuuming.  We also need the AutovacuumLock to walk the 
         * worker array, but we'll let go of that one quickly. 
         */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumScheduleLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check whether the table is being vacuumed concurrently by another 
         * worker. 
         */ 
</span>        <a href="autovacuum.c.html#LN2325"><span class='Ref_To_Local'>skipit</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2328"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN267"><span class='Ref_to_Member'>av_runningWorkers</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2363"></a>            <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Local'>worker</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN218"><span class='Ref_to_Struct'>WorkerInfoData</span></a><span class='Delimiter'>, </span>wi_links<span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2328"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* ignore myself */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2363"><span class='Ref_To_Local'>worker</span></a> <span class='Operator'>== </span><a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* ignore workers in other databases (unless table is shared) */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2363"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_sharedrel <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2363"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_dboid <span class='Operator'>!= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2363"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span>wi_tableoid <span class='Operator'>== </span><a href="autovacuum.c.html#LN2323"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="autovacuum.c.html#LN2325"><span class='Ref_To_Local'>skipit</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN1966"><span class='Ref_To_Local'>found_concurrent_worker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2325"><span class='Ref_To_Local'>skipit</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumScheduleLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check whether pgstat data still says we need to vacuum this table. 
         * It could have changed if something else processed the table while 
         * we weren't looking. 
         * 
         * Note: we have a special case in pgstat code to ensure that the 
         * stats we read are as up-to-date as possible, to avoid the problem 
         * that somebody just finished vacuuming this table.  The window to 
         * the race condition is not closed but it is very small. 
         */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN154"><span class='Ref_to_Global_Var'>AutovacMemCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN333"><span class='Ref_to_Proto'>table_recheck_autovac</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2323"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1957"><span class='Ref_To_Local'>table_toast_map</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1963"><span class='Ref_To_Local'>pg_class_desc</span></a><span class='Delimiter'>, 
</span>                                    <a href="autovacuum.c.html#LN1964"><span class='Ref_To_Local'>effective_multixact_freeze_max_age</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* someone else vacuumed the table, or it went away */ 
</span>            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumScheduleLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Ok, good to go.  Store the table in shared memory before releasing 
         * the lock so that other workers don't vacuum it concurrently. 
         */ 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_tableoid <span class='Operator'>= </span><a href="autovacuum.c.html#LN2323"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_sharedrel <span class='Operator'>= </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN194"><span class='Ref_to_Member'>at_sharedrel</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumScheduleLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Remember the prevailing values of the vacuum cost GUCs.  We have to 
         * restore these at the bottom of the loop, else we'll compute wrong 
         * values in the next iteration of autovac_balance_cost(). 
         */ 
</span>        <a href="autovacuum.c.html#LN2326"><span class='Ref_To_Local'>stdVacuumCostDelay</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN132"><span class='Ref_to_Global_Var'>VacuumCostDelay</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2327"><span class='Ref_To_Local'>stdVacuumCostLimit</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN131"><span class='Ref_to_Global_Var'>VacuumCostLimit</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Must hold AutovacuumLock while mucking with cost balance info */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* advertise my cost delay parameters for the balancing algorithm */ 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_dobalance <span class='Operator'>= </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN193"><span class='Ref_to_Member'>at_dobalance</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_delay <span class='Operator'>= </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN191"><span class='Ref_to_Member'>at_vacuum_cost_delay</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_limit <span class='Operator'>= </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN192"><span class='Ref_to_Member'>at_vacuum_cost_limit</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_cost_limit_base <span class='Operator'>= </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN192"><span class='Ref_to_Member'>at_vacuum_cost_limit</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* do a balance */ 
</span>        <a href="autovacuum.c.html#LN328"><span class='Ref_to_Proto'>autovac_balance_cost</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* set the active cost parameters from the result of that */ 
</span>        <a href="../../include/postmaster/autovacuum.h.html#LN64"><span class='Ref_to_Proto'>AutoVacuumUpdateDelay</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* done */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* clean up memory before each iteration */ 
</span>        <a href="../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN51"><span class='Ref_to_Global_Var'>PortalContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Save the relation name for a possible error message, to avoid a 
         * catalog lookup in case of an error.  If any of these return NULL, 
         * then the relation has been dropped since last we checked; skip it. 
         * Note: they must live in a long-lived memory context because we call 
         * vacuum and analyze in different transactions. 
         */ 
</span> 
        <a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN188"><span class='Ref_to_Member'>at_relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN125"><span class='Ref_to_Proto'>get_rel_namespace</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN188"><span class='Ref_to_Member'>at_relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a> <span class='Operator'>= </span><a href="../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a> <span class='Operator'>|| !</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a> <span class='Operator'>|| !</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="autovacuum.c.html#LN2508"><span class='Ref_to_Label'>deleted</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We will abort vacuuming the current table if something errors out, 
         * and continue with the next one in schedule; in particular, this 
         * happens if we are interrupted with SIGINT. 
         */ 
</span>        <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* have at it */ 
</span>            <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN342"><span class='Ref_to_Proto'>autovacuum_do_vac_analyze</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN1961"><span class='Ref_To_Local'>bstrategy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Clear a possible query-cancel signal, to avoid a late reaction 
             * to an automatically-sent signal because of vacuuming the 
             * current table (we're done with it, so it would make no sense to 
             * cancel at this point.) 
             */ 
</span>            <a href="../utils/init/globals.c.html#LN29"><span class='Ref_to_Global_Var'>QueryCancelPending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Abort the transaction, start a new one, and proceed with the 
             * next table in our list. 
             */ 
</span>            <a href="../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN189"><span class='Ref_to_Member'>at_vacoptions</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3062"><span class='Ref_to_EnumConst'>VACOPT_VACUUM</span></a><span class='Parentheses'>) 
</span>                errcontext<span class='Parentheses'>(</span><span class='String'>"automatic vacuum of table \"%s.%s.%s\""</span><span class='Delimiter'>, 
</span>                           <a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                errcontext<span class='Parentheses'>(</span><span class='String'>"automatic analyze of table \"%s.%s.%s\""</span><span class='Delimiter'>, 
</span>                           <a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN362"><span class='Ref_to_Proto'>EmitErrorReport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* this resets the PGXACT flags too */ 
</span>            <a href="../../include/access/xact.h.html#LN369"><span class='Ref_to_Proto'>AbortOutOfAnyTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN51"><span class='Ref_to_Global_Var'>PortalContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* restart our transaction for the following operations */ 
</span>            <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1965"><span class='Ref_To_Local'>did_vacuum</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* the PGXACT flags are reset at the next end of transaction */ 
</span> 
        <span class='Comment_Multi_Line'>/* be tidy */ 
</span><a name="LN2508"></a><span class='Label'>deleted</span><span class='Operator'>: 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2324"><span class='Ref_To_Local'>tab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Remove my info from shared memory.  We could, but intentionally 
         * don't, clear wi_cost_limit and friends --- this is on the 
         * assumption that we probably have more to do with similar cost 
         * settings, so we don't want to give up our share of I/O for a very 
         * short interval and thereby thrash the global balance. 
         */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_tableoid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN283"><span class='Ref_to_Global_Var'>MyWorkerInfo</span></a><span class='Operator'>-&GT;</span>wi_sharedrel <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* restore vacuum cost GUCs for the next iteration */ 
</span>        <a href="../utils/init/globals.c.html#LN132"><span class='Ref_to_Global_Var'>VacuumCostDelay</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2326"><span class='Ref_To_Local'>stdVacuumCostDelay</span></a><span class='Delimiter'>; 
</span>        <a href="../utils/init/globals.c.html#LN131"><span class='Ref_to_Global_Var'>VacuumCostLimit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2327"><span class='Ref_To_Local'>stdVacuumCostLimit</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Perform additional work items, as requested by backends. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2539"></a>        <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>wi_ptr</span><span class='Delimiter'>; 
</span><a name="LN2540"></a>        <a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitems</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Scan the list of pending items, and process the inactive ones in 
         * our database. 
         */ 
</span>        <a href="autovacuum.c.html#LN2540"><span class='Ref_To_Local'>workitems</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2540"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN305"><span class='Ref_to_Member'>avs_usedItems</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a> <span class='Operator'>!= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2554"></a>            <a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitem</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN294"><span class='Ref_to_Member'>avw_database</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>&& !</span><a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN297"><span class='Ref_to_Member'>avw_active</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2561"></a>                <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>next_ptr</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* claim this one */ 
</span>                <a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN297"><span class='Ref_to_Member'>avw_active</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="autovacuum.c.html#LN349"><span class='Ref_to_Proto'>perform_work_item</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Check for config changes before acquiring lock for further 
                 * jobs. 
                 */ 
</span>                <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Put the array item back for the next user */ 
</span>                <a href="autovacuum.c.html#LN2561"><span class='Ref_To_Local'>next_ptr</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN357"><span class='Ref_to_Proto'>remove_wi_from_list</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2540"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN305"><span class='Ref_to_Member'>avs_usedItems</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN358"><span class='Ref_to_Proto'>add_wi_to_list</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2540"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2561"><span class='Ref_To_Local'>next_ptr</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if workitem-&GT;avw_databas... &raquo; </span> 
            <span class='Control'>else</span> 
                <a href="autovacuum.c.html#LN2539"><span class='Ref_To_Local'>wi_ptr</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2554"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while wi_ptr!=InvalidDsaPoi... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* all done */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if AutoVacuumShmem-&GT;av_w... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We leak table_toast_map here (among other things), but since we're 
     * going away soon, it's not a problem. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update pg_database.datfrozenxid, and truncate pg_xact if possible. We 
     * only need to do this once, not after each table. 
     * 
     * Even if we didn't vacuum anything, it may still be important to do 
     * this, because one indirect effect of vac_update_datfrozenxid() is to 
     * update ShmemVariableCache-&GT;xidVacLimit.  That might need to be done 
     * even if we haven't vacuumed anything, because relations with older 
     * relfrozenxid values or other databases with older datfrozenxid values 
     * might have been dropped, allowing xidVacLimit to advance. 
     * 
     * However, it's also important not to do this blindly in all cases, 
     * because when autovacuum=off this will restart the autovacuum launcher. 
     * If we're not careful, an infinite loop can result, where workers find 
     * no work to do and restart the launcher, which starts another worker in 
     * the same database that finds no work to do.  To prevent that, we skip 
     * this if (1) we found no work to do and (2) we skipped at least one 
     * table due to concurrent autovacuum activity.  In that case, the other 
     * worker has already done it, or will do so when it finishes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN1965"><span class='Ref_To_Local'>did_vacuum</span></a> <span class='Operator'>|| !</span><a href="autovacuum.c.html#LN1966"><span class='Ref_To_Local'>found_concurrent_worker</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/commands/vacuum.h.html#LN187"><span class='Ref_to_Proto'>vac_update_datfrozenxid</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Finally close out the last transaction. */ 
</span>    <a href="../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end do_autovacuum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Execute a previously registered work item. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2633"></a><span class='Declare_Function'>perform_work_item</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workitem</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2635"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cur_datname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2636"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cur_nspname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2637"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cur_relname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note we do not store table info in MyWorkerInfo, since this is not 
     * vacuuming proper. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Save the relation name for a possible error message, to avoid a catalog 
     * lookup in case of an error.  If any of these return NULL, then the 
     * relation has been dropped since last we checked; skip it. Note: they 
     * must live in a long-lived memory context because we call vacuum and 
     * analyze in different transactions. 
     */ 
</span> 
    <a href="autovacuum.c.html#LN2637"><span class='Ref_To_Local'>cur_relname</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN295"><span class='Ref_to_Member'>avw_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN2636"><span class='Ref_To_Local'>cur_nspname</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../include/utils/lsyscache.h.html#LN125"><span class='Ref_to_Proto'>get_rel_namespace</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN295"><span class='Ref_to_Member'>avw_relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN2635"><span class='Ref_To_Local'>cur_datname</span></a> <span class='Operator'>= </span><a href="../../include/commands/dbcommands.h.html#LN29"><span class='Ref_to_Proto'>get_database_name</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2637"><span class='Ref_To_Local'>cur_relname</span></a> <span class='Operator'>|| !</span><a href="autovacuum.c.html#LN2636"><span class='Ref_To_Local'>cur_nspname</span></a> <span class='Operator'>|| !</span><a href="autovacuum.c.html#LN2635"><span class='Ref_To_Local'>cur_datname</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="autovacuum.c.html#LN2717"><span class='Ref_to_Label'>deleted2</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN351"><span class='Ref_to_Proto'>autovac_report_workitem</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2636"><span class='Ref_To_Local'>cur_nspname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2635"><span class='Ref_To_Local'>cur_datname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We will abort the current work item if something errors out, and 
     * continue with the next one; in particular, this happens if we are 
     * interrupted with SIGINT.  Note that this means that the work item list 
     * can be lossy. 
     */ 
</span>    <a href="../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* have at it */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN293"><span class='Ref_to_Member'>avw_type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/postmaster/autovacuum.h.html#LN24"><span class='Ref_to_EnumConst'>AVW_BRINSummarizeRange</span></a><span class='Operator'>: 
</span>                <a href="../../include/fmgr.h.html#LN585"><span class='Ref_to_Macro'>DirectFunctionCall2</span></a><span class='Parentheses'>(</span><a href="../access/brin/brin.c.html#LN849"><span class='Ref_to_Func'>brin_summarize_range</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN295"><span class='Ref_to_Member'>avw_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../include/postgres.h.html#LN624"><span class='Ref_to_Macro'>Int64GetDatum</span></a><span class='Parentheses'>((</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN296"><span class='Ref_to_Member'>avw_blockNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized work item found: type %d"</span><span class='Delimiter'>, 
</span>                     <a href="autovacuum.c.html#LN2633"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN293"><span class='Ref_to_Member'>avw_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Clear a possible query-cancel signal, to avoid a late reaction to 
         * an automatically-sent signal because of vacuuming the current table 
         * (we're done with it, so it would make no sense to cancel at this 
         * point.) 
         */ 
</span>        <a href="../utils/init/globals.c.html#LN29"><span class='Ref_to_Global_Var'>QueryCancelPending</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Abort the transaction, start a new one, and proceed with the next 
         * table in our list. 
         */ 
</span>        <a href="../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        errcontext<span class='Parentheses'>(</span><span class='String'>"processing work entry for relation \"%s.%s.%s\""</span><span class='Delimiter'>, 
</span>                   <a href="autovacuum.c.html#LN2635"><span class='Ref_To_Local'>cur_datname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2636"><span class='Ref_To_Local'>cur_nspname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2637"><span class='Ref_To_Local'>cur_relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN362"><span class='Ref_to_Proto'>EmitErrorReport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* this resets the PGXACT flags too */ 
</span>        <a href="../../include/access/xact.h.html#LN369"><span class='Ref_to_Proto'>AbortOutOfAnyTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN51"><span class='Ref_to_Global_Var'>PortalContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* restart our transaction for the following operations */ 
</span>        <a href="../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We intentionally do not set did_vacuum here */ 
</span> 
    <span class='Comment_Multi_Line'>/* be tidy */ 
</span><a name="LN2717"></a><span class='Label'>deleted2</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2635"><span class='Ref_To_Local'>cur_datname</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2635"><span class='Ref_To_Local'>cur_datname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2636"><span class='Ref_To_Local'>cur_nspname</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2636"><span class='Ref_To_Local'>cur_nspname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2637"><span class='Ref_To_Local'>cur_relname</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2637"><span class='Ref_To_Local'>cur_relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end perform_work_item &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * extract_autovac_opts 
 * 
 * Given a relation's pg_class tuple, return the AutoVacOpts portion of 
 * reloptions, if set; otherwise, return NULL. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>* 
</span><a name="LN2733"></a><span class='Declare_Function'>extract_autovac_opts</span><span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2735"></a>    <a href="../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>relopts</span><span class='Delimiter'>; 
</span><a name="LN2736"></a>    <a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2733"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>           <span class='Parentheses'>((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2733"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>           <span class='Parentheses'>((</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2733"><span class='Ref_to_Parameter'>tup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2735"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>= </span><a href="../../include/access/reloptions.h.html#LN261"><span class='Ref_to_Proto'>extractRelOptions</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2733"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2733"><span class='Ref_to_Parameter'>pg_class_desc</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2735"><span class='Ref_To_Local'>relopts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2736"><span class='Ref_To_Local'>av</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2736"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(((</span><a href="../../include/utils/rel.h.html#LN275"><span class='Ref_to_Struct'>StdRdOptions</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN2735"><span class='Ref_To_Local'>relopts</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>autovacuum<span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2735"><span class='Ref_To_Local'>relopts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="autovacuum.c.html#LN2736"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end extract_autovac_opts &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_pgstat_tabentry_relid 
 * 
 * Fetch the pgstat entry of a table, either local to a database or shared. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>* 
</span><a name="LN2759"></a><span class='Declare_Function'>get_pgstat_tabentry_relid</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isshared</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>shared</span><span class='Delimiter'>, 
</span><a name="LN2760"></a>                          <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2762"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2759"><span class='Ref_to_Parameter'>isshared</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2759"><span class='Ref_to_Parameter'>shared</span></a><span class='Parentheses'>))</span> 
            <a href="autovacuum.c.html#LN2762"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2759"><span class='Ref_to_Parameter'>shared</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2759"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2760"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Parentheses'>))</span> 
        <a href="autovacuum.c.html#LN2762"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2760"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2759"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="autovacuum.c.html#LN2762"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * table_recheck_autovac 
 * 
 * Recheck whether a table still needs vacuum or analyze.  Return value is a 
 * valid autovac_table pointer if it does, NULL otherwise. 
 * 
 * Note that the returned autovac_table does not have the name fields set. 
 */ 
</span><span class='Keyword'>static </span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>* 
</span><a name="LN2786"></a><span class='Declare_Function'>table_recheck_autovac</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>table_toast_map</span><span class='Delimiter'>, 
</span><a name="LN2787"></a>                      <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>pg_class_desc</span><span class='Delimiter'>, 
</span><a name="LN2788"></a>                      <span class='Keyword'>int </span><span class='Declare_Parameter'>effective_multixact_freeze_max_age</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2790"></a>    <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classForm</span><span class='Delimiter'>; 
</span><a name="LN2791"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>classTup</span><span class='Delimiter'>; 
</span><a name="LN2792"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>dovacuum</span><span class='Delimiter'>; 
</span><a name="LN2793"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>doanalyze</span><span class='Delimiter'>; 
</span><a name="LN2794"></a>    <a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tab</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2795"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN2796"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>shared</span><span class='Delimiter'>; 
</span><a name="LN2797"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN2798"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>wraparound</span><span class='Delimiter'>; 
</span><a name="LN2799"></a>    <a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Local'>avopts</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* use fresh stats */ 
</span>    <a href="autovacuum.c.html#LN356"><span class='Ref_to_Proto'>autovac_refresh_stats</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2796"><span class='Ref_To_Local'>shared</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN2797"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fetch the relation's relcache entry */ 
</span>    <a href="autovacuum.c.html#LN2791"><span class='Ref_To_Local'>classTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2791"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN2790"><span class='Ref_To_Local'>classForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2791"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the applicable reloptions.  If it is a TOAST table, try to get the 
     * main table reloptions if the toast table itself doesn't have. 
     */ 
</span>    <a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN344"><span class='Ref_to_Proto'>extract_autovac_opts</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2791"><span class='Ref_To_Local'>classTup</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2787"><span class='Ref_to_Parameter'>pg_class_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2790"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a> <span class='Operator'>&& 
</span>        <a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>table_toast_map</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2821"></a>        <a href="autovacuum.c.html#LN176"><span class='Ref_to_Struct'>av_relation</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN2822"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2821"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>table_toast_map</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2822"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2822"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2821"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN180"><span class='Ref_to_Member'>ar_hasrelopts</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>= &</span><a href="autovacuum.c.html#LN2821"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN181"><span class='Ref_to_Member'>ar_reloptions</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* fetch the pgstat table entry */ 
</span>    <a href="autovacuum.c.html#LN2795"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN346"><span class='Ref_to_Proto'>get_pgstat_tabentry_relid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2790"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Delimiter'>, 
</span>                                         <a href="autovacuum.c.html#LN2796"><span class='Ref_To_Local'>shared</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2797"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN336"><span class='Ref_to_Proto'>relation_needs_vacanalyze</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2790"><span class='Ref_To_Local'>classForm</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2795"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>, 
</span>                              <a href="autovacuum.c.html#LN2788"><span class='Ref_to_Parameter'>effective_multixact_freeze_max_age</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="autovacuum.c.html#LN2792"><span class='Ref_To_Local'>dovacuum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2793"><span class='Ref_To_Local'>doanalyze</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN2798"><span class='Ref_To_Local'>wraparound</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ignore ANALYZE for toast tables */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2790"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a><span class='Parentheses'>) 
</span>        <a href="autovacuum.c.html#LN2793"><span class='Ref_To_Local'>doanalyze</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, it needs something done */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2793"><span class='Ref_To_Local'>doanalyze</span></a> <span class='Operator'>|| </span><a href="autovacuum.c.html#LN2792"><span class='Ref_To_Local'>dovacuum</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2844"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>freeze_min_age</span><span class='Delimiter'>; 
</span><a name="LN2845"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>freeze_table_age</span><span class='Delimiter'>; 
</span><a name="LN2846"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>multixact_freeze_min_age</span><span class='Delimiter'>; 
</span><a name="LN2847"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>multixact_freeze_table_age</span><span class='Delimiter'>; 
</span><a name="LN2848"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>vac_cost_limit</span><span class='Delimiter'>; 
</span><a name="LN2849"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>vac_cost_delay</span><span class='Delimiter'>; 
</span><a name="LN2850"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>log_min_duration</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate the vacuum cost parameters and the freeze ages.  If there 
         * are options set in pg_class.reloptions, use them; in the case of a 
         * toast table, try the main table too.  Otherwise use the GUC 
         * defaults, autovacuum's own first and plain vacuum second. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* -1 in autovac setting means use plain vacuum_cost_delay */ 
</span>        <a href="autovacuum.c.html#LN2849"><span class='Ref_To_Local'>vac_cost_delay</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN262"><span class='Ref_to_Member'>vacuum_cost_delay</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN262"><span class='Ref_to_Member'>vacuum_cost_delay</span></a> 
            <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN122"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_delay</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN122"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_delay</span></a> 
            <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN132"><span class='Ref_to_Global_Var'>VacuumCostDelay</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 0 or -1 in autovac setting means use plain vacuum_cost_limit */ 
</span>        <a href="autovacuum.c.html#LN2848"><span class='Ref_To_Local'>vac_cost_limit</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN263"><span class='Ref_to_Member'>vacuum_cost_limit</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN263"><span class='Ref_to_Member'>vacuum_cost_limit</span></a> 
            <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN123"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_limit</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN123"><span class='Ref_to_Global_Var'>autovacuum_vac_cost_limit</span></a> 
            <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN131"><span class='Ref_to_Global_Var'>VacuumCostLimit</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* -1 in autovac setting means use log_autovacuum_min_duration */ 
</span>        <a href="autovacuum.c.html#LN2850"><span class='Ref_To_Local'>log_min_duration</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN270"><span class='Ref_to_Member'>log_min_duration</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN270"><span class='Ref_to_Member'>log_min_duration</span></a> 
            <span class='Operator'>: </span><a href="autovacuum.c.html#LN125"><span class='Ref_to_Global_Var'>Log_autovacuum_min_duration</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* these do not have autovacuum-specific settings */ 
</span>        <a href="autovacuum.c.html#LN2844"><span class='Ref_To_Local'>freeze_min_age</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN264"><span class='Ref_to_Member'>freeze_min_age</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN264"><span class='Ref_to_Member'>freeze_min_age</span></a> 
            <span class='Operator'>: </span><a href="autovacuum.c.html#LN148"><span class='Ref_to_Global_Var'>default_freeze_min_age</span></a><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2845"><span class='Ref_To_Local'>freeze_table_age</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN266"><span class='Ref_to_Member'>freeze_table_age</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN266"><span class='Ref_to_Member'>freeze_table_age</span></a> 
            <span class='Operator'>: </span><a href="autovacuum.c.html#LN149"><span class='Ref_to_Global_Var'>default_freeze_table_age</span></a><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2846"><span class='Ref_To_Local'>multixact_freeze_min_age</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& 
</span>                                    <a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN267"><span class='Ref_to_Member'>multixact_freeze_min_age</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN267"><span class='Ref_to_Member'>multixact_freeze_min_age</span></a> 
            <span class='Operator'>: </span><a href="autovacuum.c.html#LN150"><span class='Ref_to_Global_Var'>default_multixact_freeze_min_age</span></a><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2847"><span class='Ref_To_Local'>multixact_freeze_table_age</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& 
</span>                                      <a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN269"><span class='Ref_to_Member'>multixact_freeze_table_age</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>? </span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN269"><span class='Ref_to_Member'>multixact_freeze_table_age</span></a> 
            <span class='Operator'>: </span><a href="autovacuum.c.html#LN151"><span class='Ref_to_Global_Var'>default_multixact_freeze_table_age</span></a><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN188"><span class='Ref_to_Member'>at_relid</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2786"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN194"><span class='Ref_to_Member'>at_sharedrel</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2790"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN189"><span class='Ref_to_Member'>at_vacoptions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN3068"><span class='Ref_to_EnumConst'>VACOPT_SKIPTOAST</span></a> <span class='Operator'>| 
</span>            <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2792"><span class='Ref_To_Local'>dovacuum</span></a> <span class='Operator'>? </span><a href="../../include/nodes/parsenodes.h.html#LN3062"><span class='Ref_to_EnumConst'>VACOPT_VACUUM</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>| 
</span>            <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2793"><span class='Ref_To_Local'>doanalyze</span></a> <span class='Operator'>? </span><a href="../../include/nodes/parsenodes.h.html#LN3063"><span class='Ref_to_EnumConst'>VACOPT_ANALYZE</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>| 
</span>            <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2798"><span class='Ref_To_Local'>wraparound</span></a> <span class='Operator'>? </span><a href="../../include/nodes/parsenodes.h.html#LN3067"><span class='Ref_to_EnumConst'>VACOPT_NOWAIT</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN137"><span class='Ref_to_Member'>freeze_min_age</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2844"><span class='Ref_To_Local'>freeze_min_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN138"><span class='Ref_to_Member'>freeze_table_age</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2845"><span class='Ref_To_Local'>freeze_table_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN139"><span class='Ref_to_Member'>multixact_freeze_min_age</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2846"><span class='Ref_To_Local'>multixact_freeze_min_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN141"><span class='Ref_to_Member'>multixact_freeze_table_age</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2847"><span class='Ref_To_Local'>multixact_freeze_table_age</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN143"><span class='Ref_to_Member'>is_wraparound</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2798"><span class='Ref_To_Local'>wraparound</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN144"><span class='Ref_to_Member'>log_min_duration</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2850"><span class='Ref_To_Local'>log_min_duration</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN192"><span class='Ref_to_Member'>at_vacuum_cost_limit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2848"><span class='Ref_To_Local'>vac_cost_limit</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN191"><span class='Ref_to_Member'>at_vacuum_cost_delay</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2849"><span class='Ref_To_Local'>vac_cost_delay</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN197"><span class='Ref_to_Member'>at_datname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If any of the cost delay parameters has been set individually for 
         * this table, disable the balancing algorithm. 
         */ 
</span>        <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN193"><span class='Ref_to_Member'>at_dobalance</span></a> <span class='Operator'>= 
</span>            <span class='Operator'>!</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN263"><span class='Ref_to_Member'>vacuum_cost_limit</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                         <a href="autovacuum.c.html#LN2799"><span class='Ref_To_Local'>avopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN262"><span class='Ref_to_Member'>vacuum_cost_delay</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if doanalyze||dovacuum &raquo; </span> 
 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2791"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="autovacuum.c.html#LN2794"><span class='Ref_To_Local'>tab</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end table_recheck_autovac &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * relation_needs_vacanalyze 
 * 
 * Check whether a relation needs to be vacuumed or analyzed; return each into 
 * "dovacuum" and "doanalyze", respectively.  Also return whether the vacuum is 
 * being forced because of Xid or multixact wraparound. 
 * 
 * relopts is a pointer to the AutoVacOpts options (either for itself in the 
 * case of a plain table, or for either itself or its parent table in the case 
 * of a TOAST table), NULL if none; tabentry is the pgstats entry, which can be 
 * NULL. 
 * 
 * A table needs to be vacuumed if the number of dead tuples exceeds a 
 * threshold.  This threshold is calculated as 
 * 
 * threshold = vac_base_thresh + vac_scale_factor * reltuples 
 * 
 * For analyze, the analysis done is that the number of tuples inserted, 
 * deleted and updated since the last analyze exceeds a threshold calculated 
 * in the same fashion as above.  Note that the collector actually stores 
 * the number of tuples (both live and dead) that there were as of the last 
 * analyze.  This is asymmetric to the VACUUM case. 
 * 
 * We also force vacuum if the table's relfrozenxid is more than freeze_max_age 
 * transactions back, and if its relminmxid is more than 
 * multixact_freeze_max_age multixacts back. 
 * 
 * A table whose autovacuum_enabled option is false is 
 * automatically skipped (unless we have to vacuum it due to freeze_max_age). 
 * Thus autovacuum can be disabled for specific tables. Also, when the stats 
 * collector does not have data about a table, it will be skipped. 
 * 
 * A table whose vac_base_thresh value is &LT; 0 takes the base value from the 
 * autovacuum_vacuum_threshold GUC variable.  Similarly, a vac_scale_factor 
 * value &LT; 0 is substituted with the value of 
 * autovacuum_vacuum_scale_factor GUC variable.  Ditto for analyze. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2968"></a><span class='Declare_Function'>relation_needs_vacanalyze</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, 
</span><a name="LN2969"></a>                          <a href="../../include/utils/rel.h.html#LN257"><span class='Ref_to_Struct'>AutoVacOpts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relopts</span><span class='Delimiter'>, 
</span><a name="LN2970"></a>                          <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Parameter'>classForm</span><span class='Delimiter'>, 
</span><a name="LN2971"></a>                          <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tabentry</span><span class='Delimiter'>, 
</span><a name="LN2972"></a>                          <span class='Keyword'>int </span><span class='Declare_Parameter'>effective_multixact_freeze_max_age</span><span class='Delimiter'>, 
</span> <span class='Comment_Multi_Line'>/* output params below */ 
</span><a name="LN2974"></a>                          <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>dovacuum</span><span class='Delimiter'>, 
</span><a name="LN2975"></a>                          <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>doanalyze</span><span class='Delimiter'>, 
</span><a name="LN2976"></a>                          <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>wraparound</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2978"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>force_vacuum</span><span class='Delimiter'>; 
</span><a name="LN2979"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>av_enabled</span><span class='Delimiter'>; 
</span><a name="LN2980"></a>    <a href="../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>reltuples</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* pg_class.reltuples */ 
</span> 
    <span class='Comment_Multi_Line'>/* constants from reloptions or GUC variables */ 
</span><a name="LN2983"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>vac_base_thresh</span><span class='Delimiter'>, 
</span><a name="LN2984"></a>                <span class='Declare_Local'>anl_base_thresh</span><span class='Delimiter'>; 
</span><a name="LN2985"></a>    <a href="../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>vac_scale_factor</span><span class='Delimiter'>, 
</span><a name="LN2986"></a>                <span class='Declare_Local'>anl_scale_factor</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* thresholds calculated from above constants */ 
</span><a name="LN2989"></a>    <a href="../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>vacthresh</span><span class='Delimiter'>, 
</span><a name="LN2990"></a>                <span class='Declare_Local'>anlthresh</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* number of vacuum (resp. analyze) tuples at this time */ 
</span><a name="LN2993"></a>    <a href="../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>vactuples</span><span class='Delimiter'>, 
</span><a name="LN2994"></a>                <span class='Declare_Local'>anltuples</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* freeze parameters */ 
</span><a name="LN2997"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>freeze_max_age</span><span class='Delimiter'>; 
</span><a name="LN2998"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>multixact_freeze_max_age</span><span class='Delimiter'>; 
</span><a name="LN2999"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xidForceLimit</span><span class='Delimiter'>; 
</span><a name="LN3000"></a>    <a href="../../include/c.h.html#LN406"><span class='Ref_to_Typedef'>MultiXactId</span></a> <span class='Declare_Local'>multiForceLimit</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2970"><span class='Ref_to_Parameter'>classForm</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2968"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine vacuum/analyze equation parameters.  We have two possible 
     * sources: the passed reloptions (which could be a main table or a toast 
     * table), or the autovacuum GUC variables. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* -1 in autovac setting means use plain vacuum_cost_delay */ 
</span>    <a href="autovacuum.c.html#LN2985"><span class='Ref_To_Local'>vac_scale_factor</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN271"><span class='Ref_to_Member'>vacuum_scale_factor</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>? </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN271"><span class='Ref_to_Member'>vacuum_scale_factor</span></a> 
        <span class='Operator'>: </span><a href="autovacuum.c.html#LN116"><span class='Ref_to_Global_Var'>autovacuum_vac_scale</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2983"><span class='Ref_To_Local'>vac_base_thresh</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN260"><span class='Ref_to_Member'>vacuum_threshold</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>? </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN260"><span class='Ref_to_Member'>vacuum_threshold</span></a> 
        <span class='Operator'>: </span><a href="autovacuum.c.html#LN115"><span class='Ref_to_Global_Var'>autovacuum_vac_thresh</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2986"><span class='Ref_To_Local'>anl_scale_factor</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN272"><span class='Ref_to_Member'>analyze_scale_factor</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>? </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN272"><span class='Ref_to_Member'>analyze_scale_factor</span></a> 
        <span class='Operator'>: </span><a href="autovacuum.c.html#LN118"><span class='Ref_to_Global_Var'>autovacuum_anl_scale</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2984"><span class='Ref_To_Local'>anl_base_thresh</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN261"><span class='Ref_to_Member'>analyze_threshold</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>? </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN261"><span class='Ref_to_Member'>analyze_threshold</span></a> 
        <span class='Operator'>: </span><a href="autovacuum.c.html#LN117"><span class='Ref_to_Global_Var'>autovacuum_anl_thresh</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2997"><span class='Ref_To_Local'>freeze_max_age</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN265"><span class='Ref_to_Member'>freeze_max_age</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>? </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN265"><span class='Ref_to_Member'>freeze_max_age</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN119"><span class='Ref_to_Global_Var'>autovacuum_freeze_max_age</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>: </span><a href="autovacuum.c.html#LN119"><span class='Ref_to_Global_Var'>autovacuum_freeze_max_age</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2998"><span class='Ref_To_Local'>multixact_freeze_max_age</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>&& </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN268"><span class='Ref_to_Member'>multixact_freeze_max_age</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Operator'>? </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN268"><span class='Ref_to_Member'>multixact_freeze_max_age</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2972"><span class='Ref_to_Parameter'>effective_multixact_freeze_max_age</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>: </span><a href="autovacuum.c.html#LN2972"><span class='Ref_to_Parameter'>effective_multixact_freeze_max_age</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN2979"><span class='Ref_To_Local'>av_enabled</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a> <span class='Operator'>? </span><a href="autovacuum.c.html#LN2969"><span class='Ref_to_Parameter'>relopts</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN259"><span class='Ref_to_Member'>enabled</span></a> <span class='Operator'>: </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Force vacuum if table is at risk of wraparound */ 
</span>    <a href="autovacuum.c.html#LN2999"><span class='Ref_To_Local'>xidForceLimit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN144"><span class='Ref_to_Global_Var'>recentXid</span></a> <span class='Operator'>- </span><a href="autovacuum.c.html#LN2997"><span class='Ref_To_Local'>freeze_max_age</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2999"><span class='Ref_To_Local'>xidForceLimit</span></a> <span class='Operator'>&LT; </span><a href="../../include/access/transam.h.html#LN33"><span class='Ref_to_Const'>FirstNormalTransactionId</span></a><span class='Parentheses'>) 
</span>        <a href="autovacuum.c.html#LN2999"><span class='Ref_To_Local'>xidForceLimit</span></a> <span class='Operator'>-= </span><a href="../../include/access/transam.h.html#LN33"><span class='Ref_to_Const'>FirstNormalTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2970"><span class='Ref_to_Parameter'>classForm</span></a><span class='Operator'>-&GT;</span>relfrozenxid<span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2970"><span class='Ref_to_Parameter'>classForm</span></a><span class='Operator'>-&GT;</span>relfrozenxid<span class='Delimiter'>, 
</span>                                          <a href="autovacuum.c.html#LN2999"><span class='Ref_To_Local'>xidForceLimit</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN3000"><span class='Ref_To_Local'>multiForceLimit</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN145"><span class='Ref_to_Global_Var'>recentMulti</span></a> <span class='Operator'>- </span><a href="autovacuum.c.html#LN2998"><span class='Ref_To_Local'>multixact_freeze_max_age</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3000"><span class='Ref_To_Local'>multiForceLimit</span></a> <span class='Operator'>&LT; </span><a href="../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Parentheses'>) 
</span>            <a href="autovacuum.c.html#LN3000"><span class='Ref_To_Local'>multiForceLimit</span></a> <span class='Operator'>-= </span><a href="../../include/access/multixact.h.html#LN23"><span class='Ref_to_Const'>FirstMultiXactId</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a> <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN114"><span class='Ref_to_Proto'>MultiXactIdPrecedes</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2970"><span class='Ref_to_Parameter'>classForm</span></a><span class='Operator'>-&GT;</span>relminmxid<span class='Delimiter'>, 
</span>                                           <a href="autovacuum.c.html#LN3000"><span class='Ref_To_Local'>multiForceLimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="autovacuum.c.html#LN2976"><span class='Ref_to_Parameter'>wraparound</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* User disabled it in pg_class.reloptions?  (But ignore if at risk) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN2979"><span class='Ref_To_Local'>av_enabled</span></a> <span class='Operator'>&& !</span><a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2975"><span class='Ref_to_Parameter'>doanalyze</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2974"><span class='Ref_to_Parameter'>dovacuum</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we found the table in the stats hash, and autovacuum is currently 
     * enabled, make a threshold-based decision whether to vacuum and/or 
     * analyze.  If autovacuum is currently disabled, we must be here for 
     * anti-wraparound vacuuming only, so don't vacuum (or analyze) anything 
     * that's not being forced. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2971"><span class='Ref_to_Parameter'>tabentry</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../include/postmaster/autovacuum.h.html#LN48"><span class='Ref_to_Proto'>AutoVacuumingActive</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN2980"><span class='Ref_To_Local'>reltuples</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2970"><span class='Ref_to_Parameter'>classForm</span></a><span class='Operator'>-&GT;</span>reltuples<span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2993"><span class='Ref_To_Local'>vactuples</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2971"><span class='Ref_to_Parameter'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2994"><span class='Ref_To_Local'>anltuples</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2971"><span class='Ref_to_Parameter'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN630"><span class='Ref_to_Member'>changes_since_analyze</span></a><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN2989"><span class='Ref_To_Local'>vacthresh</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN2983"><span class='Ref_To_Local'>vac_base_thresh</span></a> <span class='Operator'>+ </span><a href="autovacuum.c.html#LN2985"><span class='Ref_To_Local'>vac_scale_factor</span></a> <span class='Operator'>* </span><a href="autovacuum.c.html#LN2980"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN2990"><span class='Ref_To_Local'>anlthresh</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a><span class='Parentheses'>) </span><a href="autovacuum.c.html#LN2984"><span class='Ref_To_Local'>anl_base_thresh</span></a> <span class='Operator'>+ </span><a href="autovacuum.c.html#LN2986"><span class='Ref_To_Local'>anl_scale_factor</span></a> <span class='Operator'>* </span><a href="autovacuum.c.html#LN2980"><span class='Ref_To_Local'>reltuples</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note that we don't need to take special consideration for stat 
         * reset, because if that happens, the last vacuum and analyze counts 
         * will be reset too. 
         */ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"%s: vac: %.0f (threshold %.0f), anl: %.0f (threshold %.0f)"</span><span class='Delimiter'>, 
</span>             <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2970"><span class='Ref_to_Parameter'>classForm</span></a><span class='Operator'>-&GT;</span>relname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="autovacuum.c.html#LN2993"><span class='Ref_To_Local'>vactuples</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2989"><span class='Ref_To_Local'>vacthresh</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2994"><span class='Ref_To_Local'>anltuples</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN2990"><span class='Ref_To_Local'>anlthresh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Determine if this table needs vacuum or analyze. */ 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2974"><span class='Ref_to_Parameter'>dovacuum</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2993"><span class='Ref_To_Local'>vactuples</span></a> <span class='Operator'>&GT; </span><a href="autovacuum.c.html#LN2989"><span class='Ref_To_Local'>vacthresh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2975"><span class='Ref_to_Parameter'>doanalyze</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2994"><span class='Ref_To_Local'>anltuples</span></a> <span class='Operator'>&GT; </span><a href="autovacuum.c.html#LN2990"><span class='Ref_To_Local'>anlthresh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PointerIsValid(tabent... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Skip a table not found in stat hash, unless we have to force vacuum 
         * for anti-wrap purposes.  If it's not acted upon, there's no need to 
         * vacuum it. 
         */ 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2974"><span class='Ref_to_Parameter'>dovacuum</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN2978"><span class='Ref_To_Local'>force_vacuum</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2975"><span class='Ref_to_Parameter'>doanalyze</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* ANALYZE refuses to work with pg_statistic */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN2968"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_statistic.h.html#LN28"><span class='Ref_to_Const'>StatisticRelationId</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN2975"><span class='Ref_to_Parameter'>doanalyze</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end relation_needs_vacanalyze &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * autovacuum_do_vac_analyze 
 *      Vacuum and/or analyze the specified table 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3113"></a><span class='Declare_Function'>autovacuum_do_vac_analyze</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tab</span><span class='Delimiter'>, </span><a href="../../include/storage/buf.h.html#LN43"><span class='Ref_to_Typedef'>BufferAccessStrategy</span></a> <span class='Declare_Parameter'>bstrategy</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3115"></a>    <a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a>    <span class='Declare_Local'>rangevar</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up command parameters --- use local variables instead of palloc */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN3115"><span class='Ref_To_Local'>rangevar</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3115"><span class='Ref_To_Local'>rangevar</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN3115"><span class='Ref_To_Local'>rangevar</span></a><span class='Operator'>.</span><a href="../../include/nodes/primnodes.h.html#LN66"><span class='Ref_to_Member'>schemaname</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3115"><span class='Ref_To_Local'>rangevar</span></a><span class='Operator'>.</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3115"><span class='Ref_To_Local'>rangevar</span></a><span class='Operator'>.</span><a href="../../include/nodes/primnodes.h.html#LN72"><span class='Ref_to_Member'>location</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Let pgstat know what we're doing */ 
</span>    <a href="autovacuum.c.html#LN350"><span class='Ref_to_Proto'>autovac_report_activity</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>tab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../commands/vacuum.c.html#LN147"><span class='Ref_to_Func'>vacuum</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN189"><span class='Ref_to_Member'>at_vacoptions</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN3115"><span class='Ref_To_Local'>rangevar</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN188"><span class='Ref_to_Member'>at_relid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, 
</span>           <a href="autovacuum.c.html#LN3113"><span class='Ref_to_Parameter'>bstrategy</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * autovac_report_activity 
 *      Report to pgstat what autovacuum is doing 
 * 
 * We send a SQL string corresponding to what the user would see if the 
 * equivalent command was to be issued manually. 
 * 
 * Note we assume that we are going to report the next command as soon as we're 
 * done with the current one, and exit right after the last one, so we don't 
 * bother to report "&LT;IDLE&GT;" or some such. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3143"></a><span class='Declare_Function'>autovac_report_activity</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN186"><span class='Ref_to_Struct'>autovac_table</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tab</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3145"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_AUTOVAC_ACTIV_LEN</span> <span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>56</span><span class='Parentheses'>) 
</span><a name="LN3146"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>activity</span><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN3147"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report the command and possible options */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3143"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN189"><span class='Ref_to_Member'>at_vacoptions</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3062"><span class='Ref_to_EnumConst'>VACOPT_VACUUM</span></a><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3146"><span class='Ref_To_Local'>activity</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"autovacuum: VACUUM%s"</span><span class='Delimiter'>, 
</span>                 <a href="autovacuum.c.html#LN3143"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN189"><span class='Ref_to_Member'>at_vacoptions</span></a> <span class='Operator'>& </span><a href="../../include/nodes/parsenodes.h.html#LN3063"><span class='Ref_to_EnumConst'>VACOPT_ANALYZE</span></a> <span class='Operator'>? </span><span class='String'>" ANALYZE"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3146"><span class='Ref_To_Local'>activity</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"autovacuum: ANALYZE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report the qualified name of the relation. 
     */ 
</span>    <a href="autovacuum.c.html#LN3147"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3146"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3146"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>+ </span><a href="autovacuum.c.html#LN3147"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a> <span class='Operator'>- </span><a href="autovacuum.c.html#LN3147"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, 
</span>             <span class='String'>" %s.%s%s"</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3143"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN196"><span class='Ref_to_Member'>at_nspname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3143"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN195"><span class='Ref_to_Member'>at_relname</span></a><span class='Delimiter'>, 
</span>             <a href="autovacuum.c.html#LN3143"><span class='Ref_to_Parameter'>tab</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN190"><span class='Ref_to_Member'>at_params</span></a><span class='Operator'>.</span><a href="../../include/commands/vacuum.h.html#LN143"><span class='Ref_to_Member'>is_wraparound</span></a> <span class='Operator'>? </span><span class='String'>" (to prevent wraparound)"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set statement_timestamp() to current time for pg_stat_activity */ 
</span>    <a href="../../include/access/xact.h.html#LN343"><span class='Ref_to_Proto'>SetCurrentStatementStartTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1168"><span class='Ref_to_Proto'>pgstat_report_activity</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN724"><span class='Ref_to_EnumConst'>STATE_RUNNING</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3146"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end autovac_report_activity &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * autovac_report_workitem 
 *      Report to pgstat that autovacuum is processing a work item 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3178"></a><span class='Declare_Function'>autovac_report_workitem</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>workitem</span><span class='Delimiter'>, 
</span><a name="LN3179"></a>                        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>nspname</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>relname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3181"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>activity</span><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>12</span> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN3182"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>blk</span><span class='Delimiter'>[</span><span class='Number'>12</span> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN3183"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3178"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN293"><span class='Ref_to_Member'>avw_type</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/postmaster/autovacuum.h.html#LN24"><span class='Ref_to_EnumConst'>AVW_BRINSummarizeRange</span></a><span class='Operator'>: 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3181"><span class='Ref_To_Local'>activity</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"autovacuum: BRIN summarize"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report the qualified name of the relation, and the block number if any 
     */ 
</span>    <a href="autovacuum.c.html#LN3183"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3181"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/block.h.html#LN69"><span class='Ref_to_Macro'>BlockNumberIsValid</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3178"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN296"><span class='Ref_to_Member'>avw_blockNumber</span></a><span class='Parentheses'>))</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3182"><span class='Ref_To_Local'>blk</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3182"><span class='Ref_To_Local'>blk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>" %u"</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3178"><span class='Ref_to_Parameter'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN296"><span class='Ref_to_Member'>avw_blockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="autovacuum.c.html#LN3182"><span class='Ref_To_Local'>blk</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3181"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>+ </span><a href="autovacuum.c.html#LN3183"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3145"><span class='Ref_to_Const'>MAX_AUTOVAC_ACTIV_LEN</span></a> <span class='Operator'>- </span><a href="autovacuum.c.html#LN3183"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, 
</span>             <span class='String'>" %s.%s%s"</span><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3179"><span class='Ref_to_Parameter'>nspname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3179"><span class='Ref_to_Parameter'>relname</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3182"><span class='Ref_To_Local'>blk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set statement_timestamp() to current time for pg_stat_activity */ 
</span>    <a href="../../include/access/xact.h.html#LN343"><span class='Ref_to_Proto'>SetCurrentStatementStartTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1168"><span class='Ref_to_Proto'>pgstat_report_activity</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN724"><span class='Ref_to_EnumConst'>STATE_RUNNING</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3181"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end autovac_report_workitem &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AutoVacuumingActive 
 *      Check GUC vars and report whether the autovacuum process should be 
 *      running. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3218"></a><span class='Declare_Function'>AutoVacuumingActive</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN111"><span class='Ref_to_Global_Var'>autovacuum_start_daemon</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Request one work item to the next autovacuum run processing our database. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3229"></a><span class='Declare_Function'>AutoVacuumRequestWork</span><span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN22"><span class='Ref_to_Typedef'>AutoVacuumWorkItemType</span></a> <span class='Declare_Parameter'>type</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relationId</span><span class='Delimiter'>, 
</span><a name="LN3230"></a>                      <a href="../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3232"></a>    <a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitems</span><span class='Delimiter'>; 
</span><a name="LN3233"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>wi_ptr</span><span class='Delimiter'>; 
</span><a name="LN3234"></a>    <a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitem</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It may be useful to de-duplicate the list upon insertion.  For the only 
     * currently existing caller, this is not necessary. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* First use in this process?  Set up DSA */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* autovacuum launcher not started; nothing can be done */ 
</span>            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN106"><span class='Ref_to_Proto'>dsa_attach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN269"><span class='Ref_to_Member'>av_dsa_handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/dsa.h.html#LN111"><span class='Ref_to_Proto'>dsa_pin_mapping</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* First use overall?  Allocate work items array */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a> <span class='Operator'>== </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3259"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3260"></a>        <a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitems</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a> <span class='Operator'>= 
</span>            <a href="../../include/utils/dsa.h.html#LN118"><span class='Ref_to_Proto'>dsa_allocate_extended</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, 
</span>                                  <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                  <a href="autovacuum.c.html#LN302"><span class='Ref_to_Const'>NUM_WORKITEMS</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/dsa.h.html#LN73"><span class='Ref_to_Const'>DSA_ALLOC_NO_OOM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* if out of memory, silently disregard the request */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a> <span class='Operator'>== </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/dsa.h.html#LN112"><span class='Ref_to_Proto'>dsa_detach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize each array entry as a member of the free list */ 
</span>        <a href="autovacuum.c.html#LN3260"><span class='Ref_To_Local'>workitems</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN3260"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN305"><span class='Ref_to_Member'>avs_usedItems</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN3260"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3259"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="autovacuum.c.html#LN3259"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="autovacuum.c.html#LN302"><span class='Ref_to_Const'>NUM_WORKITEMS</span></a><span class='Delimiter'>; </span><a href="autovacuum.c.html#LN3259"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* XXX surely there is a simpler way to do this */ 
</span>            <a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="autovacuum.c.html#LN3259"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN293"><span class='Ref_to_Member'>avw_type</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN294"><span class='Ref_to_Member'>avw_database</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN295"><span class='Ref_to_Member'>avw_relation</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN297"><span class='Ref_to_Member'>avw_active</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* put this item in the free list */ 
</span>            <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3260"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a><span class='Delimiter'>; 
</span>            <a href="autovacuum.c.html#LN3260"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if AutoVacuumShmem-&GT;av_w... &raquo; </span> 
 
    <a href="autovacuum.c.html#LN3232"><span class='Ref_To_Local'>workitems</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN303"><span class='Ref_to_Typedef'>AutovacWorkItems</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN270"><span class='Ref_to_Member'>av_workitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If array is full, disregard the request */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3232"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a> <span class='Operator'>== </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/dsa.h.html#LN112"><span class='Ref_to_Proto'>dsa_detach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* remove workitem struct from free list ... */ 
</span>    <a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3232"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN357"><span class='Ref_to_Proto'>remove_wi_from_list</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN3232"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN306"><span class='Ref_to_Member'>avs_freeItems</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ... initialize it ... */ 
</span>    <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN293"><span class='Ref_to_Member'>avw_type</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3229"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN294"><span class='Ref_to_Member'>avw_database</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN295"><span class='Ref_to_Member'>avw_relation</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3229"><span class='Ref_to_Parameter'>relationId</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN296"><span class='Ref_to_Member'>avw_blockNumber</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3230"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3234"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN297"><span class='Ref_to_Member'>avw_active</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ... and put it on autovacuum's to-do list */ 
</span>    <a href="autovacuum.c.html#LN358"><span class='Ref_to_Proto'>add_wi_to_list</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN3232"><span class='Ref_To_Local'>workitems</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN305"><span class='Ref_to_Member'>avs_usedItems</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3233"><span class='Ref_To_Local'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>AutovacuumLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/dsa.h.html#LN112"><span class='Ref_to_Proto'>dsa_detach</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AutoVacuumRequestWork &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * autovac_init 
 *      This is called at postmaster initialization. 
 * 
 * All we do here is annoy the user if he got it wrong. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3339"></a><span class='Declare_Function'>autovac_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN111"><span class='Ref_to_Global_Var'>autovacuum_start_daemon</span></a> <span class='Operator'>&& !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"autovacuum not started because of misconfiguration"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Enable the \"track_counts\" option."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * IsAutoVacuum functions 
 *      Return whether this is either a launcher autovacuum process or a worker 
 *      process. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3353"></a><span class='Declare_Function'>IsAutoVacuumLauncherProcess</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="autovacuum.c.html#LN135"><span class='Ref_to_Global_Var'>am_autovacuum_launcher</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN3359"></a><span class='Declare_Function'>IsAutoVacuumWorkerProcess</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="autovacuum.c.html#LN136"><span class='Ref_to_Global_Var'>am_autovacuum_worker</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * AutoVacuumShmemSize 
 *      Compute space needed for autovacuum-related shared memory 
 */ 
</span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN3370"></a><span class='Declare_Function'>AutoVacuumShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3372"></a>    <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Need the fixed struct and the array of WorkerInfoData. 
     */ 
</span>    <a href="autovacuum.c.html#LN3372"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN262"><span class='Ref_to_Typedef'>AutoVacuumShmemStruct</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3372"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3372"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="autovacuum.c.html#LN3372"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3372"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN112"><span class='Ref_to_Global_Var'>autovacuum_max_workers</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN218"><span class='Ref_to_Struct'>WorkerInfoData</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="autovacuum.c.html#LN3372"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AutoVacuumShmemInit 
 *      Allocate and initialize autovacuum-related shared memory 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3389"></a><span class='Declare_Function'>AutoVacuumShmemInit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3391"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN262"><span class='Ref_to_Typedef'>AutoVacuumShmemStruct</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"AutoVacuum Data"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/postmaster/autovacuum.h.html#LN77"><span class='Ref_to_Proto'>AutoVacuumShmemSize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="autovacuum.c.html#LN3391"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3400"></a>        <a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a>  <span class='Declare_Local'>worker</span><span class='Delimiter'>; 
</span><a name="LN3401"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="autovacuum.c.html#LN3391"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN265"><span class='Ref_to_Member'>av_launcherpid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN267"><span class='Ref_to_Member'>av_runningWorkers</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN268"><span class='Ref_to_Member'>av_startingWorker</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN3400"><span class='Ref_To_Local'>worker</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../bin/pg_dump/parallel.c.html#LN118"><span class='Ref_to_Typedef'>WorkerInfo</span></a><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a> <span class='Operator'>+ 
</span>                               <a href="../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN262"><span class='Ref_to_Typedef'>AutoVacuumShmemStruct</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* initialize the WorkerInfo free list */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3401"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="autovacuum.c.html#LN3401"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="autovacuum.c.html#LN112"><span class='Ref_to_Global_Var'>autovacuum_max_workers</span></a><span class='Delimiter'>; </span><a href="autovacuum.c.html#LN3401"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="autovacuum.c.html#LN273"><span class='Ref_to_Global_Var'>AutoVacuumShmem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN266"><span class='Ref_to_Member'>av_freeWorkers</span></a><span class='Delimiter'>, 
</span>                            <span class='Operator'>&</span><a href="autovacuum.c.html#LN3400"><span class='Ref_To_Local'>worker</span></a><span class='Delimiter'>[</span><a href="autovacuum.c.html#LN3401"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>wi_links<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !IsUnderPostmaster &raquo; </span> 
    <span class='Control'>else</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3391"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AutoVacuumShmemInit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * autovac_refresh_stats 
 *      Refresh pgstats data for an autovacuum process 
 * 
 * Cause the next pgstats read operation to obtain fresh data, but throttle 
 * such refreshing in the autovacuum launcher.  This is mostly to avoid 
 * rereading the pgstats files too many times in quick succession when there 
 * are many databases. 
 * 
 * Note: we avoid throttling in the autovac worker, as it would be 
 * counterproductive in the recheck logic. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3435"></a><span class='Declare_Function'>autovac_refresh_stats</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN49"><span class='Ref_to_Proto'>IsAutoVacuumLauncherProcess</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3439"></a>        <span class='Keyword'>static </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>last_read</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN3440"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>current_time</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN3440"><span class='Ref_To_Local'>current_time</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3439"><span class='Ref_To_Local'>last_read</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3440"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>, 
</span>                                        <a href="autovacuum.c.html#LN128"><span class='Ref_to_Const'>STATS_READ_DELAY</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN3439"><span class='Ref_To_Local'>last_read</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3440"><span class='Ref_To_Local'>current_time</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/pgstat.h.html#LN1150"><span class='Ref_to_Proto'>pgstat_clear_snapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Simplistic open-coded list implementation for objects stored in DSA. 
 * Each item is doubly linked, but we have no tail pointer, and the "prev" 
 * element of the first item is null, not the list. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Remove a work item from the given list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3464"></a><span class='Declare_Function'>remove_wi_from_list</span><span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list</span><span class='Delimiter'>, </span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>wi_ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3466"></a>    <a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitem</span> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3464"><span class='Ref_to_Parameter'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3467"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>next</span> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a><span class='Delimiter'>; 
</span><a name="LN3468"></a>    <a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>prev</span> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN299"><span class='Ref_to_Member'>avw_prev</span></a><span class='Delimiter'>; 
</span> 
    <a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN299"><span class='Ref_to_Member'>avw_prev</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3467"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>!= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3467"><span class='Ref_To_Local'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN299"><span class='Ref_to_Member'>avw_prev</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3468"><span class='Ref_To_Local'>prev</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="autovacuum.c.html#LN3468"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>!= </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3468"><span class='Ref_To_Local'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN3466"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3467"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Operator'>*</span><a href="autovacuum.c.html#LN3464"><span class='Ref_to_Parameter'>list</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3467"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end remove_wi_from_list &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a workitem to the given list 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3491"></a><span class='Declare_Function'>add_wi_to_list</span><span class='Parentheses'>(</span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>list</span><span class='Delimiter'>, </span><a href="../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>wi_ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>list</span></a> <span class='Operator'>== </span><a href="../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* list is empty; item is now singleton */ 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>list</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>wi_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3500"></a>        <a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workitem</span> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>wi_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3501"></a>        <a href="autovacuum.c.html#LN291"><span class='Ref_to_Struct'>AutoVacuumWorkItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>old</span> <span class='Operator'>= </span><a href="../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="autovacuum.c.html#LN309"><span class='Ref_to_Global_Var'>AutoVacuumDSA</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Put item at head of list */ 
</span>        <a href="autovacuum.c.html#LN3500"><span class='Ref_To_Local'>workitem</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN298"><span class='Ref_to_Member'>avw_next</span></a> <span class='Operator'>= *</span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>list</span></a><span class='Delimiter'>; 
</span>        <a href="autovacuum.c.html#LN3501"><span class='Ref_To_Local'>old</span></a><span class='Operator'>-&GT;</span><a href="autovacuum.c.html#LN299"><span class='Ref_to_Member'>avw_prev</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>wi_ptr</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>list</span></a> <span class='Operator'>= </span><a href="autovacuum.c.html#LN3491"><span class='Ref_to_Parameter'>wi_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>