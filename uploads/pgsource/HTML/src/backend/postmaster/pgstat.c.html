<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\postmaster\pgstat.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\postmaster\pgstat.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:45 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/* ---------- 
 * pgstat.c 
 * 
 *  All the statistics collector stuff hacked up in one big, ugly file. 
 * 
 *  TODO:   - Separate collector, postmaster and backend stuff 
 *            into different files. 
 * 
 *          - Add some automatic call for pgstat vacuuming. 
 * 
 *          - Add a pgstat config column to pg_database, so this 
 *            entire thing can be enabled/disabled on a per db basis. 
 * 
 *  Copyright (c) 2001-2017, PostgreSQL Global Development Group 
 * 
 *  src/backend/postmaster/pgstat.c 
 * ---------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/param.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase_rmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_database.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/ip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/fork_process.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/backendid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/dsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/latch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinvaladt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ascii.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ps_status.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Timer definitions. 
 * ---------- 
 */ 
</span><a name="LN76"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_STAT_INTERVAL</span>    <span class='Number'>500</span>     <span class='Comment_Multi_Line'>/* Minimum time between stats file 
                                         * updates; in milliseconds. */ 
</span> 
<a name="LN79"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_RETRY_DELAY</span>      <span class='Number'>10</span>      <span class='Comment_Multi_Line'>/* How long to wait between checks for 
                                         * a new file; in milliseconds. */ 
</span> 
<a name="LN82"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_MAX_WAIT_TIME</span>    <span class='Number'>10000</span>   <span class='Comment_Multi_Line'>/* Maximum time to wait for a stats 
                                         * file update; in milliseconds. */ 
</span> 
<a name="LN85"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_INQ_INTERVAL</span>     <span class='Number'>640</span>     <span class='Comment_Multi_Line'>/* How often to ping the collector for 
                                         * a new file; in milliseconds. */ 
</span> 
<a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_RESTART_INTERVAL</span> <span class='Number'>60</span>      <span class='Comment_Multi_Line'>/* How often to attempt to restart a 
                                         * failed statistics collector; in 
                                         * seconds. */ 
</span> 
<a name="LN92"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_POLL_LOOP_COUNT</span>  <span class='Parentheses'>(</span><a href="pgstat.c.html#LN82"><span class='Ref_to_Const'>PGSTAT_MAX_WAIT_TIME</span></a> <span class='Operator'>/ </span><a href="pgstat.c.html#LN79"><span class='Ref_to_Const'>PGSTAT_RETRY_DELAY</span></a><span class='Parentheses'>) 
</span><a name="LN93"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_INQ_LOOP_COUNT</span>   <span class='Parentheses'>(</span><a href="pgstat.c.html#LN85"><span class='Ref_to_Const'>PGSTAT_INQ_INTERVAL</span></a> <span class='Operator'>/ </span><a href="pgstat.c.html#LN79"><span class='Ref_to_Const'>PGSTAT_RETRY_DELAY</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Minimum receive buffer size for the collector's socket. */ 
</span><a name="LN96"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_MIN_RCVBUF</span>       <span class='Parentheses'>(</span><span class='Number'>100</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * The initial size hints for the hash tables used in the collector. 
 * ---------- 
 */ 
</span><a name="LN103"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_DB_HASH_SIZE</span>     <span class='Number'>16</span> 
<a name="LN104"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_TAB_HASH_SIZE</span>    <span class='Number'>512</span> 
<a name="LN105"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PGSTAT_FUNCTION_HASH_SIZE</span>   <span class='Number'>512</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Total number of backends including auxiliary 
 * 
 * We reserve a slot for each possible BackendId, plus one for each 
 * possible auxiliary process type.  (This scheme assumes there is not 
 * more than one of any auxiliary process type at a time.) MaxBackends 
 * includes autovacuum workers and background workers as well. 
 * ---------- 
 */ 
</span><a name="LN117"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NumBackendStatSlots</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>+ </span><a href="../../include/miscadmin.h.html#LN401"><span class='Ref_to_EnumConst'>NUM_AUXPROCTYPES</span></a><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * GUC parameters 
 * ---------- 
 */ 
</span><a name="LN124"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>pgstat_track_activities</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN125"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>pgstat_track_counts</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN126"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>pgstat_track_functions</span> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN38"><span class='Ref_to_EnumConst'>TRACK_FUNC_OFF</span></a><span class='Delimiter'>; 
</span><a name="LN127"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>pgstat_track_activity_query_size</span> <span class='Operator'>= </span><span class='Number'>1024</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * Built from GUC parameter 
 * ---------- 
 */ 
</span><a name="LN133"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>pgstat_stat_directory</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN134"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>pgstat_stat_filename</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN135"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>pgstat_stat_tmpname</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * BgWriter global statistics counters (unused in other processes). 
 * Stored directly in a stats message structure so it can be sent 
 * without needing to copy things around.  We assume this inits to zeroes. 
 */ 
</span><a name="LN142"></a><a href="../../include/pgstat.h.html#LN408"><span class='Ref_to_Struct'>PgStat_MsgBgWriter</span></a> <span class='Declare_Var'>BgWriterStats</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local data 
 * ---------- 
 */ 
</span><a name="LN148"></a><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Var'>pgStatSock</span> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span> 
<a name="LN150"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../include/libpq/pqcomm.h.html#LN43"><span class='Ref_to_Struct'>sockaddr_storage</span></a> <span class='Declare_Var'>pgStatAddr</span><span class='Delimiter'>; 
</span> 
<a name="LN152"></a><span class='Keyword'>static </span>time_t <span class='Declare_Var'>last_pgstat_start_time</span><span class='Delimiter'>; 
</span> 
<a name="LN154"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>pgStatRunningInCollector</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Structures in which backends store per-table info that's waiting to be 
 * sent to the collector. 
 * 
 * NOTE: once allocated, TabStatusArray structures are never moved or deleted 
 * for the life of the backend.  Also, we zero out the t_id fields of the 
 * contained PgStat_TableStatus structs whenever they are not actively in use. 
 * This allows relcache pgstat_info pointers to be treated as long-lived data, 
 * avoiding repeated searches in pgstat_initstats() when a relation is 
 * repeatedly opened during a transaction. 
 */ 
</span><a name="LN167"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TABSTAT_QUANTUM</span>     <span class='Number'>100</span> <span class='Comment_Single_Line'>/* we alloc this many at a time */ 
</span> 
<a name="LN169"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TabStatusArray</span> 
<span class='Delimiter'>{ 
</span><a name="LN171"></a>    <span class='Control'>struct</span> <a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tsa_next</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* link to next array, if any */ 
</span><a name="LN172"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>tsa_used</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* # entries currently used */ 
</span><a name="LN173"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Declare_Member'>tsa_entries</span><span class='Delimiter'>[</span><a href="pgstat.c.html#LN167"><span class='Ref_to_Const'>TABSTAT_QUANTUM</span></a><span class='Delimiter'>];</span>    <span class='Comment_Single_Line'>/* per-table data */ 
</span><a name="LN174"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TabStatusArray</span><span class='Delimiter'>; 
</span> 
<a name="LN176"></a><span class='Keyword'>static </span><a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pgStatTabList</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pgStatTabHash entry: map from relation OID to PgStat_TableStatus pointer 
 */ 
</span><a name="LN181"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TabStatHashEntry</span> 
<span class='Delimiter'>{ 
</span><a name="LN183"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>t_id</span><span class='Delimiter'>; 
</span><a name="LN184"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tsa_entry</span><span class='Delimiter'>; 
</span><a name="LN185"></a>} <span class='Declare_Typedef'>TabStatHashEntry</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Hash table for O(1) t_id -&GT; tsa_entry lookup 
 */ 
</span><a name="LN190"></a><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pgStatTabHash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Backends store per-function info that's waiting to be sent to the collector 
 * in this hash table (indexed by function OID). 
 */ 
</span><a name="LN196"></a><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pgStatFunctions</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Indicates if backend has some function stats that it hasn't yet 
 * sent to the collector. 
 */ 
</span><a name="LN202"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>have_function_stats</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Tuple insertion/deletion counts for an open transaction can't be propagated 
 * into PgStat_TableStatus counters until we know if it is going to commit 
 * or abort.  Hence, we keep these counts in per-subxact structs that live 
 * in TopTransactionContext.  This data structure is designed on the assumption 
 * that subxacts won't usually modify very many tables. 
 */ 
</span><a name="LN211"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>PgStat_SubXactStatus</span> 
<span class='Delimiter'>{ 
</span><a name="LN213"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nest_level</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* subtransaction nest level */ 
</span><a name="LN214"></a>    <span class='Control'>struct</span> <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Member'>prev</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* higher-level subxact if any */ 
</span><a name="LN215"></a>    <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Member'>first</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* head of list for this subxact */ 
</span><a name="LN216"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>PgStat_SubXactStatus</span><span class='Delimiter'>; 
</span> 
<a name="LN218"></a><span class='Keyword'>static </span><a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pgStatXactStack</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN220"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>pgStatXactCommit</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN221"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>pgStatXactRollback</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN222"></a><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Var'>pgStatBlockReadTime</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN223"></a><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Var'>pgStatBlockWriteTime</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Record that's written to 2PC state file when pgstat state is persisted */ 
</span><a name="LN226"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TwoPhasePgStatRecord</span> 
<span class='Delimiter'>{ 
</span><a name="LN228"></a>    <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Member'>tuples_inserted</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* tuples inserted in xact */ 
</span><a name="LN229"></a>    <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Member'>tuples_updated</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* tuples updated in xact */ 
</span><a name="LN230"></a>    <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Member'>tuples_deleted</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* tuples deleted in xact */ 
</span><a name="LN231"></a>    <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Member'>inserted_pre_trunc</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* tuples inserted prior to truncate */ 
</span><a name="LN232"></a>    <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Member'>updated_pre_trunc</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* tuples updated prior to truncate */ 
</span><a name="LN233"></a>    <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Member'>deleted_pre_trunc</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* tuples deleted prior to truncate */ 
</span><a name="LN234"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>t_id</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* table's OID */ 
</span><a name="LN235"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>t_shared</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* is it a shared catalog? */ 
</span><a name="LN236"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>t_truncated</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* was the relation truncated? */ 
</span><a name="LN237"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TwoPhasePgStatRecord</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Info about current "snapshot" of stats file 
 */ 
</span><a name="LN242"></a><span class='Keyword'>static </span><a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>pgStatLocalContext</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN243"></a><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pgStatDBHash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Status for backends including auxiliary */ 
</span><a name="LN246"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN1063"><span class='Ref_to_Struct'>LocalPgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Var'>localBackendStatusTable</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Total number of backends including auxiliary */ 
</span><a name="LN249"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>localNumBackends</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Cluster wide statistics, kept in the stats collector. 
 * Contains statistics that are not collected per database 
 * or per table. 
 */ 
</span><a name="LN256"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN664"><span class='Ref_to_Struct'>PgStat_ArchiverStats</span></a> <span class='Declare_Var'>archiverStats</span><span class='Delimiter'>; 
</span><a name="LN257"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN680"><span class='Ref_to_Struct'>PgStat_GlobalStats</span></a> <span class='Declare_Var'>globalStats</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of OIDs of databases we need to write out.  If an entry is InvalidOid, 
 * it means to write only the shared-catalog stats ("DB 0"); otherwise, we 
 * will write both that DB's data and the shared stats. 
 */ 
</span><a name="LN264"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pending_write_requests</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Signal handler flags */ 
</span><a name="LN267"></a><span class='Keyword'>static volatile bool </span><span class='Declare_Var'>need_exit</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN268"></a><span class='Keyword'>static volatile bool </span><span class='Declare_Var'>got_SIGHUP</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Total time charged to functions so far in the current backend. 
 * We use this to help separate "self" and "other" time charges. 
 * (We assume this initializes to zero.) 
 */ 
</span><a name="LN275"></a><span class='Keyword'>static </span><a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a> <span class='Declare_Var'>total_func_time</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local function forward declarations 
 * ---------- 
 */ 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
<a name="LN283"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>pgstat_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN286"></a><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void </span><a href="pgstat.c.html#LN4176"><span class='Ref_to_Func'>PgstatCollectorMain</span></a><span class='Parentheses'>(</span><span class='Keyword'>int </span>argc<span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span>argv<span class='Delimiter'>[]</span><span class='Parentheses'>) </span><span class='Declare_Var'>pg_attribute_noreturn</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN287"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_exit</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN288"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_beshutdown_hook</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN289"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_sighup_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN291"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_db_entry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN292"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_tab_entry</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Delimiter'>, 
</span><a name="LN293"></a>                     <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tableoid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN294"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_write_statsfiles</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allDbs</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN295"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_write_db_statsfile</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN296"></a><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_read_statsfiles</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>onlydb</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>deep</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN297"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_read_db_statsfile</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Delimiter'>, </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tabhash</span><span class='Delimiter'>, </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>funchash</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN298"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>backend_read_statsfile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN299"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_read_current_status</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN301"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>pgstat_write_statsfile_needed</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN302"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>pgstat_db_requested</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN304"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_send_tabstat</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tsmsg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN305"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_send_funcstats</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN306"></a><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_collect_oids</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>catalogid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN308"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_tabstat_entry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>rel_id</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isshared</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN310"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_setup_memcxt</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN312"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_wait_activity</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN754"><span class='Ref_to_Typedef'>WaitEventActivity</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN313"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_wait_client</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN780"><span class='Ref_to_Typedef'>WaitEventClient</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN314"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_wait_ipc</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN798"><span class='Ref_to_Typedef'>WaitEventIPC</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN315"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_wait_timeout</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN823"><span class='Ref_to_Typedef'>WaitEventTimeout</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN316"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>pgstat_get_wait_io</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN836"><span class='Ref_to_Typedef'>WaitEventIO</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN318"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_setheader</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN192"><span class='Ref_to_Struct'>PgStat_MsgHdr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN47"><span class='Ref_to_Enum'>StatMsgType</span></a> <span class='Declare_Parameter'>mtype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN319"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_send</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN321"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_inquiry</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN238"><span class='Ref_to_Struct'>PgStat_MsgInquiry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN322"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_tabstat</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN323"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_tabpurge</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN324"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_dropdb</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN302"><span class='Ref_to_Struct'>PgStat_MsgDropdb</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN325"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_resetcounter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN314"><span class='Ref_to_Struct'>PgStat_MsgResetcounter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN326"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_resetsharedcounter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN325"><span class='Ref_to_Struct'>PgStat_MsgResetsharedcounter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN327"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_resetsinglecounter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN336"><span class='Ref_to_Struct'>PgStat_MsgResetsinglecounter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN328"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_autovac</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN349"><span class='Ref_to_Struct'>PgStat_MsgAutovacStart</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN329"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_vacuum</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN362"><span class='Ref_to_Struct'>PgStat_MsgVacuum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN330"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_analyze</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN379"><span class='Ref_to_Struct'>PgStat_MsgAnalyze</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN331"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_archiver</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN396"><span class='Ref_to_Struct'>PgStat_MsgArchiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN332"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_bgwriter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN408"><span class='Ref_to_Struct'>PgStat_MsgBgWriter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN333"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_funcstat</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN496"><span class='Ref_to_Struct'>PgStat_MsgFuncstat</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN334"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_funcpurge</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN513"><span class='Ref_to_Struct'>PgStat_MsgFuncpurge</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN335"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_recoveryconflict</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN428"><span class='Ref_to_Struct'>PgStat_MsgRecoveryConflict</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN336"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_deadlock</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN526"><span class='Ref_to_Struct'>PgStat_MsgDeadlock</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN337"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pgstat_recv_tempfile</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN440"><span class='Ref_to_Struct'>PgStat_MsgTempFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ 
 * Public functions called from postmaster follow 
 * ------------------------------------------------------------ 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_init() - 
 * 
 *  Called from postmaster at startup. Create the resources required 
 *  by the statistics collector process.  If unable to do so, do not 
 *  fail --- better to let the postmaster start with stats collection 
 *  disabled. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN354"></a><span class='Declare_Function'>pgstat_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN356"></a>    ACCEPT_TYPE_ARG3 <span class='Declare_Local'>alen</span><span class='Delimiter'>; 
</span><a name="LN357"></a>    <span class='Control'>struct</span> <a href="../../include/getaddrinfo.h.html#LN114"><span class='Ref_to_Struct'>addrinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>addrs</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN358"></a>               <span class='Operator'>*</span><span class='Declare_Local'>addr</span><span class='Delimiter'>, 
</span><a name="LN359"></a>                <span class='Declare_Local'>hints</span><span class='Delimiter'>; 
</span><a name="LN360"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN361"></a>    fd_set      <span class='Declare_Local'>rset</span><span class='Delimiter'>; 
</span><a name="LN362"></a>    <span class='Control'>struct</span> timeval <span class='Declare_Local'>tv</span><span class='Delimiter'>; 
</span><a name="LN363"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>test_byte</span><span class='Delimiter'>; 
</span><a name="LN364"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>sel_res</span><span class='Delimiter'>; 
</span><a name="LN365"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tries</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN367"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TESTBYTEVAL</span> <span class='Parentheses'>((</span><span class='Keyword'>char</span><span class='Parentheses'>) </span><span class='Number'>199</span><span class='Parentheses'>)</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * This static assertion verifies that we didn't mess up the calculations 
     * involved in selecting maximum payload sizes for our UDP messages. 
     * Because the only consequence of overrunning PGSTAT_MAX_MSG_SIZE would 
     * be silent performance loss from fragmentation, it seems worth having a 
     * compile-time cross-check that we didn't. 
     */ 
</span>    <a href="../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN537"><span class='Ref_to_Union'>PgStat_Msg</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="../../include/pgstat.h.html#LN205"><span class='Ref_to_Const'>PGSTAT_MAX_MSG_SIZE</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"maximum stats message size exceeds PGSTAT_MAX_MSG_SIZE"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the UDP socket for sending and receiving statistic messages 
     */ 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN99"><span class='Ref_to_Member'>ai_flags</span></a> <span class='Operator'>= </span><a href="../../include/getaddrinfo.h.html#LN61"><span class='Ref_to_Const'>AI_PASSIVE</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>= </span>AF_UNSPEC<span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN101"><span class='Ref_to_Member'>ai_socktype</span></a> <span class='Operator'>= </span>SOCK_DGRAM<span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN102"><span class='Ref_to_Member'>ai_protocol</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN105"><span class='Ref_to_Member'>ai_canonname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN106"><span class='Ref_to_Member'>ai_next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN360"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN26"><span class='Ref_to_Proto'>pg_getaddrinfo_all</span></a><span class='Parentheses'>(</span><span class='String'>"localhost"</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN357"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN360"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN357"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not resolve \"localhost\": %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN360"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN612"><span class='Ref_to_Label'>startup_failed</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On some platforms, pg_getaddrinfo_all() may return multiple addresses 
     * only one of which will actually work (eg, both IPv6 and IPv4 addresses 
     * when kernel will reject IPv6).  Worse, the failure may occur at the 
     * bind() or perhaps even connect() stage.  So we must loop through the 
     * results till we find a working combination. We will generate LOG 
     * messages, but no error, for bogus combinations. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN357"><span class='Ref_To_Local'>addrs</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN106"><span class='Ref_to_Member'>ai_next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
        <span class='Comment_Multi_Line'>/* Ignore AF_UNIX sockets, if any are returned. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a> <span class='Operator'>== </span>AF_UNIX<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="pgstat.c.html#LN365"><span class='Ref_To_Local'>tries</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"trying another address for the statistics collector"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create the socket. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN368"><span class='Ref_to_Macro'>socket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span>SOCK_DGRAM<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create socket for statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Bind it to a kernel assigned port on localhost and get the assigned 
         * port via getsockname(). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN369"><span class='Ref_to_Macro'>bind</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN104"><span class='Ref_to_Member'>ai_addr</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a><span class='Operator'>-&GT;</span><a href="../../include/getaddrinfo.h.html#LN103"><span class='Ref_to_Member'>ai_addrlen</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>              <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not bind socket for statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pgstat.c.html#LN356"><span class='Ref_To_Local'>alen</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN150"><span class='Ref_to_Global_Var'>pgStatAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockname<span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="pgstat.c.html#LN150"><span class='Ref_to_Global_Var'>pgStatAddr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN356"><span class='Ref_To_Local'>alen</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not get address of socket for statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Connect the socket to its own address.  This saves a few cycles by 
         * not having to respecify the target address on every send. This also 
         * provides a kernel-level check that only packets from this same 
         * address will be received. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN372"><span class='Ref_to_Macro'>connect</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Control'>struct</span> sockaddr <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="pgstat.c.html#LN150"><span class='Ref_to_Global_Var'>pgStatAddr</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN356"><span class='Ref_To_Local'>alen</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not connect socket for statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Try to send and receive a one-byte test message on the socket. This 
         * is to catch situations where the socket can be created but will not 
         * actually pass data (for instance, because kernel packet filtering 
         * rules prevent it). 
         */ 
</span>        <a href="pgstat.c.html#LN363"><span class='Ref_To_Local'>test_byte</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN367"><span class='Ref_to_Const'>TESTBYTEVAL</span></a><span class='Delimiter'>; 
</span> 
<a name="LN479"></a><span class='Label'>retry1</span><span class='Operator'>: 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN363"><span class='Ref_To_Local'>test_byte</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="pgstat.c.html#LN479"><span class='Ref_to_Label'>retry1</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* if interrupted, just retry */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not send test message on socket for statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * There could possibly be a little delay before the message can be 
         * received.  We arbitrarily allow up to half a second before deciding 
         * it's broken. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>)</span>                <span class='Comment_Single_Line'>/* need a loop to handle EINTR */ 
</span>        <span class='Delimiter'>{ 
</span>            FD_ZERO<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN361"><span class='Ref_To_Local'>rset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            FD_SET<span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN361"><span class='Ref_To_Local'>rset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN362"><span class='Ref_To_Local'>tv</span></a><span class='Operator'>.</span>tv_sec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN362"><span class='Ref_To_Local'>tv</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>= </span><span class='Number'>500000</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN364"><span class='Ref_To_Local'>sel_res</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN361"><span class='Ref_To_Local'>rset</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN362"><span class='Ref_To_Local'>tv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN364"><span class='Ref_To_Local'>sel_res</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span>errno <span class='Operator'>!= </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN364"><span class='Ref_To_Local'>sel_res</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"select() failed in statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN364"><span class='Ref_To_Local'>sel_res</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| !</span>FD_ISSET<span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN361"><span class='Ref_To_Local'>rset</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This is the case we actually think is likely, so take pains to 
             * give a specific message for it. 
             * 
             * errno will not be set meaningfully here, so don't use it. 
             */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONNECTION_FAILURE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"test message did not get through on socket for statistics collector"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pgstat.c.html#LN363"><span class='Ref_To_Local'>test_byte</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* just make sure variable is changed */ 
</span> 
<a name="LN535"></a><span class='Label'>retry2</span><span class='Operator'>: 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN374"><span class='Ref_to_Macro'>recv</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN363"><span class='Ref_To_Local'>test_byte</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="pgstat.c.html#LN535"><span class='Ref_to_Label'>retry2</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* if interrupted, just retry */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive test message on socket for statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN363"><span class='Ref_To_Local'>test_byte</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN367"><span class='Ref_to_Const'>TESTBYTEVAL</span></a><span class='Parentheses'>)</span>   <span class='Comment_Single_Line'>/* strictly paranoia ... */ 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incorrect test message transmission on socket for statistics collector"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If we get here, we have a working socket */ 
</span>        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for addr=addrs;addr;addr=... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Did we find a working address? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN358"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>|| </span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN612"><span class='Ref_to_Label'>startup_failed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the socket to non-blocking IO.  This ensures that if the collector 
     * falls behind, statistics messages will be discarded; backends won't 
     * block waiting to send messages to the collector. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../port/noblock.c.html#LN23"><span class='Ref_to_Func'>pg_set_noblock</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not set statistics collector socket to nonblocking mode: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN612"><span class='Ref_to_Label'>startup_failed</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to ensure that the socket's receive buffer is at least 
     * PGSTAT_MIN_RCVBUF bytes, so that it won't easily overflow and lose 
     * data.  Use of UDP protocol means that we are willing to lose data under 
     * heavy load, but we don't want it to happen just because of ridiculously 
     * small default buffer sizes (such as 8KB on older Windows versions). 
     */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN587"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>old_rcvbuf</span><span class='Delimiter'>; 
</span><a name="LN588"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>new_rcvbuf</span><span class='Delimiter'>; 
</span><a name="LN589"></a>        ACCEPT_TYPE_ARG3 <span class='Declare_Local'>rcvbufsize</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN587"><span class='Ref_To_Local'>old_rcvbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>getsockopt<span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span>SOL_SOCKET<span class='Delimiter'>, </span>SO_RCVBUF<span class='Delimiter'>, 
</span>                       <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN587"><span class='Ref_To_Local'>old_rcvbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN589"><span class='Ref_To_Local'>rcvbufsize</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"getsockopt(SO_RCVBUF) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* if we can't get existing size, always try to set it */ 
</span>            <a href="pgstat.c.html#LN587"><span class='Ref_To_Local'>old_rcvbuf</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pgstat.c.html#LN588"><span class='Ref_To_Local'>new_rcvbuf</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN96"><span class='Ref_to_Const'>PGSTAT_MIN_RCVBUF</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN587"><span class='Ref_To_Local'>old_rcvbuf</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN588"><span class='Ref_To_Local'>new_rcvbuf</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>setsockopt<span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span>SOL_SOCKET<span class='Delimiter'>, </span>SO_RCVBUF<span class='Delimiter'>, 
</span>                           <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN588"><span class='Ref_To_Local'>new_rcvbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN588"><span class='Ref_To_Local'>new_rcvbuf</span></a><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"setsockopt(SO_RCVBUF) failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN357"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
<a name="LN612"></a><span class='Label'>startup_failed</span><span class='Operator'>: 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>      <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"disabling statistics collector for lack of working socket"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN357"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/ip.h.html#LN29"><span class='Ref_to_Proto'>pg_freeaddrinfo_all</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN359"><span class='Ref_To_Local'>hints</span></a><span class='Operator'>.</span><a href="../../include/getaddrinfo.h.html#LN100"><span class='Ref_to_Member'>ai_family</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN357"><span class='Ref_To_Local'>addrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Adjust GUC variables to suppress useless activity, and for debugging 
     * purposes (seeing track_counts off is a clue that we failed here). We 
     * use PGC_S_OVERRIDE because there is no point in trying to turn it back 
     * on from postgresql.conf without a restart. 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"track_counts"</span><span class='Delimiter'>, </span><span class='String'>"off"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN69"><span class='Ref_to_EnumConst'>PGC_INTERNAL</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_init &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * subroutine for pgstat_reset_all 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN636"></a><span class='Declare_Function'>pgstat_reset_remove_files</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>directory</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN638"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN639"></a>    <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN640"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fname</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <a href="pgstat.c.html#LN638"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN636"><span class='Ref_to_Parameter'>directory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN638"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN636"><span class='Ref_to_Parameter'>directory</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN645"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nchars</span><span class='Delimiter'>; 
</span><a name="LN646"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tmp_oid</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Skip directory entries that don't match the file names we write. 
         * See get_dbstat_filename for the database-specific pattern. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"global."</span><span class='Delimiter'>, </span><span class='Number'>7</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pgstat.c.html#LN645"><span class='Ref_To_Local'>nchars</span></a> <span class='Operator'>= </span><span class='Number'>7</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN645"><span class='Ref_To_Local'>nchars</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>sscanf<span class='Parentheses'>(</span><a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"db_%u.%n"</span><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="pgstat.c.html#LN646"><span class='Ref_To_Local'>tmp_oid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN645"><span class='Ref_To_Local'>nchars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN645"><span class='Ref_To_Local'>nchars</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* %u allows leading whitespace, so reject that */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><span class='String'>"0123456789"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN645"><span class='Ref_To_Local'>nchars</span></a><span class='Delimiter'>, </span><span class='String'>"tmp"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            strcmp<span class='Parentheses'>(</span><a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN645"><span class='Ref_To_Local'>nchars</span></a><span class='Delimiter'>, </span><span class='String'>"stat"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN640"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN640"><span class='Ref_To_Local'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN636"><span class='Ref_to_Parameter'>directory</span></a><span class='Delimiter'>, 
</span>                 <a href="pgstat.c.html#LN639"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN640"><span class='Ref_To_Local'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (entry=ReadDir(dir,di... &raquo; </span> 
    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN638"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_reset_remove_files &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pgstat_reset_all() - 
 * 
 * Remove the stats files.  This is currently used only if WAL 
 * recovery is needed after a crash. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN684"></a><span class='Declare_Function'>pgstat_reset_all</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN635"><span class='Ref_to_Func'>pgstat_reset_remove_files</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN635"><span class='Ref_to_Func'>pgstat_reset_remove_files</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN28"><span class='Ref_to_Const'>PGSTAT_STAT_PERMANENT_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
 
<span class='Comment_Multi_Line'>/* 
 * pgstat_forkexec() - 
 * 
 * Format up the arglist for, then fork and exec, statistics collector process 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN698"></a><span class='Declare_Function'>pgstat_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN700"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN701"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN700"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN701"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN700"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN701"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"--forkcol"</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN700"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN701"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by postmaster_forkexec */ 
</span> 
    <a href="pgstat.c.html#LN700"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN701"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN701"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN700"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/postmaster/postmaster.h.html#LN57"><span class='Ref_to_Proto'>postmaster_forkexec</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN701"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN700"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * pgstat_start() - 
 * 
 *  Called from postmaster at startup or after an existing collector 
 *  died.  Attempt to fire up a fresh statistics collector. 
 * 
 *  Returns PID of child process, or 0 if fail. 
 * 
 *  Note: if fail, we will be called again from the postmaster main loop. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN726"></a><span class='Declare_Function'>pgstat_start</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN728"></a>    time_t      <span class='Declare_Local'>curtime</span><span class='Delimiter'>; 
</span><a name="LN729"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pgStatPid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the socket is there, else pgstat_init failed and we can do 
     * nothing useful. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do nothing if too soon since last collector start.  This is a safety 
     * valve to protect against continuous respawn attempts if the collector 
     * is dying immediately at launch.  Note that since we will be re-called 
     * from the postmaster main loop, we will get another chance later. 
     */ 
</span>    <a href="pgstat.c.html#LN728"><span class='Ref_To_Local'>curtime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) (</span><a href="pgstat.c.html#LN728"><span class='Ref_To_Local'>curtime</span></a> <span class='Operator'>- </span><a href="pgstat.c.html#LN152"><span class='Ref_to_Global_Var'>last_pgstat_start_time</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN88"><span class='Ref_to_Const'>PGSTAT_RESTART_INTERVAL</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN152"><span class='Ref_to_Global_Var'>last_pgstat_start_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN728"><span class='Ref_To_Local'>curtime</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Okay, fork off the collector. 
     */ 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN729"><span class='Ref_To_Local'>pgStatPid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN283"><span class='Ref_to_Proto'>pgstat_forkexec</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN729"><span class='Ref_To_Local'>pgStatPid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork statistics collector: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> EXEC_BACKEND 
        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster child ... */ 
</span>            <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>            <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Drop our connection to postmaster's shared memory, as well */ 
</span>            <a href="../../include/storage/dsm.h.html#LN29"><span class='Ref_to_Proto'>dsm_detach_all</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/pg_shmem.h.html#LN69"><span class='Ref_to_Proto'>PGSharedMemoryDetach</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN4176"><span class='Ref_to_Func'>PgstatCollectorMain</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN729"><span class='Ref_To_Local'>pgStatPid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch (pgStatPid=fork_proce... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* shouldn't get here */ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_start &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN789"></a><span class='Declare_Function'>allow_immediate_pgstat_restart</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN152"><span class='Ref_to_Global_Var'>last_pgstat_start_time</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ 
 * Public functions used by backends follow 
 *------------------------------------------------------------ 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_report_stat() - 
 * 
 *  Must be called by processes that performs DML: tcop/postgres.c, logical 
 *  receiver processes, SPI worker, etc. to send the so far collected 
 *  per-table and function usage statistics to the collector.  Note that this 
 *  is called only when not within a transaction, so it is fair to use 
 *  transaction stop time as an approximation of current time. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN811"></a><span class='Declare_Function'>pgstat_report_stat</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>force</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* we assume this inits to all zeroes: */ 
</span><a name="LN814"></a>    <span class='Keyword'>static const </span><a href="../../include/pgstat.h.html#LN96"><span class='Ref_to_Struct'>PgStat_TableCounts</span></a> <span class='Declare_Local'>all_zeroes</span><span class='Delimiter'>; 
</span><a name="LN815"></a>    <span class='Keyword'>static </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>last_report</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN817"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span><a name="LN818"></a>    <a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Declare_Local'>regular_msg</span><span class='Delimiter'>; 
</span><a name="LN819"></a>    <a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Declare_Local'>shared_msg</span><span class='Delimiter'>; 
</span><a name="LN820"></a>    <a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tsa</span><span class='Delimiter'>; 
</span><a name="LN821"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't expend a clock check if nothing to do */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN176"><span class='Ref_to_Global_Var'>pgStatTabList</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="pgstat.c.html#LN176"><span class='Ref_to_Global_Var'>pgStatTabList</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN172"><span class='Ref_to_Member'>tsa_used</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="pgstat.c.html#LN220"><span class='Ref_to_Global_Var'>pgStatXactCommit</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pgstat.c.html#LN221"><span class='Ref_to_Global_Var'>pgStatXactRollback</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="pgstat.c.html#LN202"><span class='Ref_to_Global_Var'>have_function_stats</span></a><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't send a message unless it's been at least PGSTAT_STAT_INTERVAL 
     * msec since we last sent one, or the caller wants to force stats out. 
     */ 
</span>    <a href="pgstat.c.html#LN817"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN342"><span class='Ref_to_Proto'>GetCurrentTransactionStopTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN811"><span class='Ref_to_Parameter'>force</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN815"><span class='Ref_To_Local'>last_report</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN817"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN76"><span class='Ref_to_Const'>PGSTAT_STAT_INTERVAL</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN815"><span class='Ref_To_Local'>last_report</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN817"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Destroy pgStatTabHash before we start invalidating PgStat_TableEntry 
     * entries it points to.  (Should we fail partway through the loop below, 
     * it's okay to have removed the hashtable already --- the only 
     * consequence is we'd get multiple entries for the same table in the 
     * pgStatTabList, and that's safe.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan through the TabStatusArray struct(s) to find tables that actually 
     * have counts, and build messages to send.  We have to separate shared 
     * relations from regular ones because the databaseid field in the message 
     * header has to depend on that. 
     */ 
</span>    <a href="pgstat.c.html#LN818"><span class='Ref_To_Local'>regular_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN269"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN819"><span class='Ref_To_Local'>shared_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN269"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN818"><span class='Ref_To_Local'>regular_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN819"><span class='Ref_To_Local'>shared_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN176"><span class='Ref_to_Global_Var'>pgStatTabList</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN171"><span class='Ref_to_Member'>tsa_next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN821"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN821"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN172"><span class='Ref_to_Member'>tsa_used</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN821"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN865"></a>            <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span> <span class='Operator'>= &</span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN173"><span class='Ref_to_Member'>tsa_entries</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN821"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN866"></a>            <a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Operator'>*</span><span class='Declare_Local'>this_msg</span><span class='Delimiter'>; 
</span><a name="LN867"></a>            <a href="../../include/pgstat.h.html#LN251"><span class='Ref_to_Struct'>PgStat_TableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>this_ent</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Shouldn't have any pending transaction-dependent counts */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN865"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Ignore entries that didn't accumulate any actual counts, such 
             * as indexes that were opened by the planner but not used. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN865"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN814"><span class='Ref_To_Local'>all_zeroes</span></a><span class='Delimiter'>, 
</span>                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN96"><span class='Ref_to_Struct'>PgStat_TableCounts</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * OK, insert data into the appropriate message, and send if full. 
             */ 
</span>            <a href="pgstat.c.html#LN866"><span class='Ref_To_Local'>this_msg</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN865"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN155"><span class='Ref_to_Member'>t_shared</span></a> <span class='Operator'>? &</span><a href="pgstat.c.html#LN819"><span class='Ref_To_Local'>shared_msg</span></a> <span class='Operator'>: &</span><a href="pgstat.c.html#LN818"><span class='Ref_To_Local'>regular_msg</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN867"><span class='Ref_To_Local'>this_ent</span></a> <span class='Operator'>= &</span><a href="pgstat.c.html#LN866"><span class='Ref_To_Local'>this_msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN275"><span class='Ref_to_Member'>m_entry</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN866"><span class='Ref_To_Local'>this_msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>]; 
</span>            <a href="pgstat.c.html#LN867"><span class='Ref_To_Local'>this_ent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN253"><span class='Ref_to_Member'>t_id</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN865"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN154"><span class='Ref_to_Member'>t_id</span></a><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN867"><span class='Ref_To_Local'>this_ent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN865"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Delimiter'>, 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN96"><span class='Ref_to_Struct'>PgStat_TableCounts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="pgstat.c.html#LN866"><span class='Ref_To_Local'>this_msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT;= </span><a href="../../include/pgstat.h.html#LN262"><span class='Ref_to_Const'>PGSTAT_NUM_TABENTRIES</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pgstat.c.html#LN304"><span class='Ref_to_Proto'>pgstat_send_tabstat</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN866"><span class='Ref_To_Local'>this_msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN866"><span class='Ref_To_Local'>this_msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;tsa-&GT;tsa_used;i... &raquo; </span> 
        <span class='Comment_Multi_Line'>/* zero out TableStatus structs after use */ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN173"><span class='Ref_to_Member'>tsa_entries</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>               <a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN172"><span class='Ref_to_Member'>tsa_used</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN820"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN172"><span class='Ref_to_Member'>tsa_used</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for tsa=pgStatTabList;tsa... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Send partial messages.  Make sure that any pending xact commit/abort 
     * gets counted, even if there are no table stats to send. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN818"><span class='Ref_To_Local'>regular_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="pgstat.c.html#LN220"><span class='Ref_to_Global_Var'>pgStatXactCommit</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pgstat.c.html#LN221"><span class='Ref_to_Global_Var'>pgStatXactRollback</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN304"><span class='Ref_to_Proto'>pgstat_send_tabstat</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN818"><span class='Ref_To_Local'>regular_msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN819"><span class='Ref_To_Local'>shared_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN304"><span class='Ref_to_Proto'>pgstat_send_tabstat</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN819"><span class='Ref_To_Local'>shared_msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now, send function statistics */ 
</span>    <a href="pgstat.c.html#LN305"><span class='Ref_to_Proto'>pgstat_send_funcstats</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_report_stat &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine for pgstat_report_stat: finish and send a tabstat message 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN918"></a><span class='Declare_Function'>pgstat_send_tabstat</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tsmsg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN920"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN921"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* It's unlikely we'd get here with no socket, but maybe not impossible */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Report and reset accumulated xact commit/rollback and I/O timings 
     * whenever we send a normal tabstat message 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN269"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN271"><span class='Ref_to_Member'>m_xact_commit</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN220"><span class='Ref_to_Global_Var'>pgStatXactCommit</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN272"><span class='Ref_to_Member'>m_xact_rollback</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN221"><span class='Ref_to_Global_Var'>pgStatXactRollback</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN273"><span class='Ref_to_Member'>m_block_read_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN222"><span class='Ref_to_Global_Var'>pgStatBlockReadTime</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN274"><span class='Ref_to_Member'>m_block_write_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN223"><span class='Ref_to_Global_Var'>pgStatBlockWriteTime</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN220"><span class='Ref_to_Global_Var'>pgStatXactCommit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN221"><span class='Ref_to_Global_Var'>pgStatXactRollback</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN222"><span class='Ref_to_Global_Var'>pgStatBlockReadTime</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN223"><span class='Ref_to_Global_Var'>pgStatBlockWriteTime</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN271"><span class='Ref_to_Member'>m_xact_commit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN272"><span class='Ref_to_Member'>m_xact_rollback</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN273"><span class='Ref_to_Member'>m_block_read_time</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN274"><span class='Ref_to_Member'>m_block_write_time</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pgstat.c.html#LN920"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN921"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a><span class='Delimiter'>, </span>m_entry<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <a href="pgstat.c.html#LN920"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN251"><span class='Ref_to_Struct'>PgStat_TableEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN268"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN51"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TABSTAT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN918"><span class='Ref_to_Parameter'>tsmsg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN921"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_send_tabstat &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine for pgstat_report_stat: populate and send a function stat message 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN962"></a><span class='Declare_Function'>pgstat_send_funcstats</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* we assume this inits to all zeroes: */ 
</span><a name="LN965"></a>    <span class='Keyword'>static const </span><a href="../../include/pgstat.h.html#LN458"><span class='Ref_to_Struct'>PgStat_FunctionCounts</span></a> <span class='Declare_Local'>all_zeroes</span><span class='Delimiter'>; 
</span> 
<a name="LN967"></a>    <a href="../../include/pgstat.h.html#LN496"><span class='Ref_to_Struct'>PgStat_MsgFuncstat</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN968"></a>    <a href="../../include/pgstat.h.html#LN469"><span class='Ref_to_Struct'>PgStat_BackendFunctionEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN969"></a>    <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>fstat</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN498"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN62"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_FUNCSTAT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN499"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN969"><span class='Ref_To_Local'>fstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN469"><span class='Ref_to_Struct'>PgStat_BackendFunctionEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN969"><span class='Ref_To_Local'>fstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN981"></a>        <a href="../../include/pgstat.h.html#LN479"><span class='Ref_to_Struct'>PgStat_FunctionEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>m_ent</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip it if no counts accumulated since last time */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN965"><span class='Ref_To_Local'>all_zeroes</span></a><span class='Delimiter'>, 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN458"><span class='Ref_to_Struct'>PgStat_FunctionCounts</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* need to convert format of time accumulators */ 
</span>        <a href="pgstat.c.html#LN981"><span class='Ref_To_Local'>m_ent</span></a> <span class='Operator'>= &</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN501"><span class='Ref_to_Member'>m_entry</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>]; 
</span>        <a href="pgstat.c.html#LN981"><span class='Ref_To_Local'>m_ent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN481"><span class='Ref_to_Member'>f_id</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN471"><span class='Ref_to_Member'>f_id</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN981"><span class='Ref_To_Local'>m_ent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN482"><span class='Ref_to_Member'>f_numcalls</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN460"><span class='Ref_to_Member'>f_numcalls</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN981"><span class='Ref_To_Local'>m_ent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN483"><span class='Ref_to_Member'>f_total_time</span></a> <span class='Operator'>= </span><a href="../../include/portability/instr_time.h.html#LN137"><span class='Ref_to_Macro'>INSTR_TIME_GET_MICROSEC</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN461"><span class='Ref_to_Member'>f_total_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN981"><span class='Ref_To_Local'>m_ent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN484"><span class='Ref_to_Member'>f_self_time</span></a> <span class='Operator'>= </span><a href="../../include/portability/instr_time.h.html#LN137"><span class='Ref_to_Macro'>INSTR_TIME_GET_MICROSEC</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN462"><span class='Ref_to_Member'>f_self_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT;= </span><a href="../../include/pgstat.h.html#LN492"><span class='Ref_to_Const'>PGSTAT_NUM_FUNCENTRIES</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN496"><span class='Ref_to_Struct'>PgStat_MsgFuncstat</span></a><span class='Delimiter'>, </span>m_entry<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                        <a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN479"><span class='Ref_to_Struct'>PgStat_FunctionEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* reset the entry's counts */ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN968"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN458"><span class='Ref_to_Struct'>PgStat_FunctionCounts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (entry=(PgStat_Backen... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN496"><span class='Ref_to_Struct'>PgStat_MsgFuncstat</span></a><span class='Delimiter'>, </span>m_entry<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                    <a href="pgstat.c.html#LN967"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN479"><span class='Ref_to_Struct'>PgStat_FunctionEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN202"><span class='Ref_to_Global_Var'>have_function_stats</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_send_funcstats &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_vacuum_stat() - 
 * 
 *  Will tell the collector about objects he can get rid of. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1021"></a><span class='Declare_Function'>pgstat_vacuum_stat</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1023"></a>    <a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>htab</span><span class='Delimiter'>; 
</span><a name="LN1024"></a>    <a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN1025"></a>    <a href="../../include/pgstat.h.html#LN513"><span class='Ref_to_Struct'>PgStat_MsgFuncpurge</span></a> <span class='Declare_Local'>f_msg</span><span class='Delimiter'>; 
</span><a name="LN1026"></a>    <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hstat</span><span class='Delimiter'>; 
</span><a name="LN1027"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN1028"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN1029"></a>    <a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcentry</span><span class='Delimiter'>; 
</span><a name="LN1030"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If not done for this transaction, read the statistics collector stats 
     * file into some hash tables. 
     */ 
</span>    <a href="pgstat.c.html#LN298"><span class='Ref_to_Proto'>backend_read_statsfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read pg_database and make a list of OIDs of all existing databases 
     */ 
</span>    <a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN306"><span class='Ref_to_Proto'>pgstat_collect_oids</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_database.h.html#LN28"><span class='Ref_to_Const'>DatabaseRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Search the database hash table for dead databases and tell the 
     * collector to drop them. 
     */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1026"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1026"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1053"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* the DB entry for shared tables (with InvalidOid) is never dropped */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1053"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>            <a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1053"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="../../include/pgstat.h.html#LN1148"><span class='Ref_to_Proto'>pgstat_drop_database</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1053"><span class='Ref_To_Local'>dbid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup our own database entry; if not found, nothing more to do. 
     */ 
</span>    <a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Similarly to above, make a list of all known relations in this DB. 
     */ 
</span>    <a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN306"><span class='Ref_to_Proto'>pgstat_collect_oids</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize our messages table counter to zero 
     */ 
</span>    <a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for all tables listed in stats hashtable if they still exist. 
     */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1026"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN1028"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1026"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1091"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tabid</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1028"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN616"><span class='Ref_to_Member'>tableid</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1091"><span class='Ref_To_Local'>tabid</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Not there, so add this table's Oid to the message 
         */ 
</span>        <a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN293"><span class='Ref_to_Member'>m_tableid</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pgstat.c.html#LN1091"><span class='Ref_To_Local'>tabid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the message is full, send it out and reinitialize to empty 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT;= </span><a href="../../include/pgstat.h.html#LN284"><span class='Ref_to_Const'>PGSTAT_NUM_TABPURGE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a><span class='Delimiter'>, </span>m_tableid<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Operator'>+</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN290"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN52"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TABPURGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN291"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tabentry=(PgStat_Sta... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Send the rest 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a><span class='Delimiter'>, </span>m_tableid<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Operator'>+</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN290"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN52"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TABPURGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN291"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1024"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now repeat the above steps for functions.  However, we needn't bother 
     * in the common case where no function stats are being collected. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="../../include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN306"><span class='Ref_to_Proto'>pgstat_collect_oids</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_proc.h.html#LN32"><span class='Ref_to_Const'>ProcedureRelationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN515"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN63"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_FUNCPURGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN516"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1026"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1027"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN1029"><span class='Ref_To_Local'>funcentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1026"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1151"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>funcid</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1029"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN652"><span class='Ref_to_Member'>functionid</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1151"><span class='Ref_To_Local'>funcid</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Not there, so add this function's Oid to the message 
             */ 
</span>            <a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN518"><span class='Ref_to_Member'>m_functionid</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pgstat.c.html#LN1151"><span class='Ref_To_Local'>funcid</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the message is full, send it out and reinitialize to empty 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT;= </span><a href="../../include/pgstat.h.html#LN509"><span class='Ref_to_Const'>PGSTAT_NUM_FUNCPURGE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN513"><span class='Ref_to_Struct'>PgStat_MsgFuncpurge</span></a><span class='Delimiter'>, </span>m_functionid<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    <span class='Operator'>+</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (funcentry=(PgStat_St... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Send the rest 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN513"><span class='Ref_to_Struct'>PgStat_MsgFuncpurge</span></a><span class='Delimiter'>, </span>m_functionid<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Operator'>+</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1025"><span class='Ref_To_Local'>f_msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1030"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1023"><span class='Ref_To_Local'>htab</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dbentry-&GT;functions!=N... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_vacuum_stat &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_collect_oids() - 
 * 
 *  Collect the OIDs of all objects listed in the specified system catalog 
 *  into a temporary hash table.  Caller should hash_destroy the result 
 *  when done with it.  (However, we make the table in CurrentMemoryContext 
 *  so that it will be freed properly in event of an error.) 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>* 
</span><a name="LN1203"></a><span class='Declare_Function'>pgstat_collect_oids</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>catalogid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1205"></a>    <a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>htab</span><span class='Delimiter'>; 
</span><a name="LN1206"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span><a name="LN1207"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1208"></a>    <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scan</span><span class='Delimiter'>; 
</span><a name="LN1209"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN1210"></a>    <a href="../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1206"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1206"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1206"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1206"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1206"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1205"><span class='Ref_To_Local'>htab</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Temporary table of OIDs"</span><span class='Delimiter'>, 
</span>                       <a href="pgstat.c.html#LN104"><span class='Ref_to_Const'>PGSTAT_TAB_HASH_SIZE</span></a><span class='Delimiter'>, 
</span>                       <span class='Operator'>&</span><a href="pgstat.c.html#LN1206"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN1207"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1203"><span class='Ref_to_Parameter'>catalogid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1210"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../include/utils/snapmgr.h.html#LN80"><span class='Ref_to_Proto'>RegisterSnapshot</span></a><span class='Parentheses'>(</span><a href="../../include/utils/snapmgr.h.html#LN64"><span class='Ref_to_Proto'>GetLatestSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1208"><span class='Ref_To_Local'>scan</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN108"><span class='Ref_to_Proto'>heap_beginscan</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1207"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1210"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN1209"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1208"><span class='Ref_To_Local'>scan</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1226"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>thisoid</span> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1209"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1205"><span class='Ref_To_Local'>htab</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1226"><span class='Ref_To_Local'>thisoid</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1208"><span class='Ref_To_Local'>scan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/snapmgr.h.html#LN81"><span class='Ref_to_Proto'>UnregisterSnapshot</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1210"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1207"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN1205"><span class='Ref_To_Local'>htab</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_collect_oids &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_drop_database() - 
 * 
 *  Tell the collector that we just dropped a database. 
 *  (If the message gets lost, we will still clean the dead DB eventually 
 *  via future invocations of pgstat_vacuum_stat().) 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1249"></a><span class='Declare_Function'>pgstat_drop_database</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1251"></a>    <a href="../../include/pgstat.h.html#LN302"><span class='Ref_to_Struct'>PgStat_MsgDropdb</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1251"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN304"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN53"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_DROPDB</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1251"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN305"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1249"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1251"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1251"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_drop_relation() - 
 * 
 *  Tell the collector that we just dropped a relation. 
 *  (If the message gets lost, we will still clean the dead entry eventually 
 *  via future invocations of pgstat_vacuum_stat().) 
 * 
 *  Currently not used for lack of any good place to call it; we rely 
 *  entirely on pgstat_vacuum_stat() to clean out stats for dead rels. 
 * ---------- 
 */ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
<span class='Keyword'>void 
</span><a name="LN1275"></a><span class='Declare_Function'>pgstat_drop_relation</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1277"></a>    <a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN1278"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN1277"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN293"><span class='Ref_to_Member'>m_tableid</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pgstat.c.html#LN1275"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1277"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN1278"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a><span class='Delimiter'>, </span>m_tableid<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>+</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1277"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN290"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN52"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TABPURGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1277"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN291"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1277"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1278"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* NOT_USED */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_reset_counters() - 
 * 
 *  Tell the statistics collector to reset counters for our database. 
 * 
 *  Permission checking for this function is managed through the normal 
 *  GRANT system. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1305"></a><span class='Declare_Function'>pgstat_reset_counters</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1307"></a>    <a href="../../include/pgstat.h.html#LN314"><span class='Ref_to_Struct'>PgStat_MsgResetcounter</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1307"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN316"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN54"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RESETCOUNTER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1307"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN317"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1307"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1307"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_reset_shared_counters() - 
 * 
 *  Tell the statistics collector to reset cluster-wide shared counters. 
 * 
 *  Permission checking for this function is managed through the normal 
 *  GRANT system. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1327"></a><span class='Declare_Function'>pgstat_reset_shared_counters</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>target</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1329"></a>    <a href="../../include/pgstat.h.html#LN325"><span class='Ref_to_Struct'>PgStat_MsgResetsharedcounter</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pgstat.c.html#LN1327"><span class='Ref_to_Parameter'>target</span></a><span class='Delimiter'>, </span><span class='String'>"archiver"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="pgstat.c.html#LN1329"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN328"><span class='Ref_to_Member'>m_resettarget</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN120"><span class='Ref_to_EnumConst'>RESET_ARCHIVER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pgstat.c.html#LN1327"><span class='Ref_to_Parameter'>target</span></a><span class='Delimiter'>, </span><span class='String'>"bgwriter"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="pgstat.c.html#LN1329"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN328"><span class='Ref_to_Member'>m_resettarget</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN121"><span class='Ref_to_EnumConst'>RESET_BGWRITER</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unrecognized reset target: \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1327"><span class='Ref_to_Parameter'>target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Target must be \"archiver\" or \"bgwriter\"."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1329"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN327"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN55"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RESETSHAREDCOUNTER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1329"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1329"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_reset_shared_counters &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_reset_single_counter() - 
 * 
 *  Tell the statistics collector to reset a single counter. 
 * 
 *  Permission checking for this function is managed through the normal 
 *  GRANT system. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1358"></a><span class='Declare_Function'>pgstat_reset_single_counter</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objoid</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN125"><span class='Ref_to_Enum'>PgStat_Single_Reset_Type</span></a> <span class='Declare_Parameter'>type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1360"></a>    <a href="../../include/pgstat.h.html#LN336"><span class='Ref_to_Struct'>PgStat_MsgResetsinglecounter</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1360"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN338"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN56"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RESETSINGLECOUNTER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1360"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN339"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1360"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN340"><span class='Ref_to_Member'>m_resettype</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1358"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1360"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN341"><span class='Ref_to_Member'>m_objectid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1358"><span class='Ref_to_Parameter'>objoid</span></a><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1360"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1360"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_report_autovac() - 
 * 
 *  Called from autovacuum.c to report startup of an autovacuum process. 
 *  We are called before InitPostgres is done, so can't rely on MyDatabaseId; 
 *  the db OID must be passed in, instead. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1382"></a><span class='Declare_Function'>pgstat_report_autovac</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dboid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1384"></a>    <a href="../../include/pgstat.h.html#LN349"><span class='Ref_to_Struct'>PgStat_MsgAutovacStart</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1384"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN351"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN57"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_AUTOVAC_START</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1384"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN352"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1382"><span class='Ref_to_Parameter'>dboid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1384"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN353"><span class='Ref_to_Member'>m_start_time</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1384"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1384"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* --------- 
 * pgstat_report_vacuum() - 
 * 
 *  Tell the collector about the table we just vacuumed. 
 * --------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1404"></a><span class='Declare_Function'>pgstat_report_vacuum</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tableoid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>shared</span><span class='Delimiter'>, 
</span><a name="LN1405"></a>                     <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Parameter'>livetuples</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Parameter'>deadtuples</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1407"></a>    <a href="../../include/pgstat.h.html#LN362"><span class='Ref_to_Struct'>PgStat_MsgVacuum</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN364"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN58"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_VACUUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN365"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1404"><span class='Ref_to_Parameter'>shared</span></a> <span class='Operator'>? </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN366"><span class='Ref_to_Member'>m_tableoid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1404"><span class='Ref_to_Parameter'>tableoid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN367"><span class='Ref_to_Member'>m_autovacuum</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN368"><span class='Ref_to_Member'>m_vacuumtime</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN369"><span class='Ref_to_Member'>m_live_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1405"><span class='Ref_to_Parameter'>livetuples</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN370"><span class='Ref_to_Member'>m_dead_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1405"><span class='Ref_to_Parameter'>deadtuples</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1407"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------- 
 * pgstat_report_analyze() - 
 * 
 *  Tell the collector about the table we just analyzed. 
 * 
 * Caller must provide new live- and dead-tuples estimates, as well as a 
 * flag indicating whether to reset the changes_since_analyze counter. 
 * -------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1432"></a><span class='Declare_Function'>pgstat_report_analyze</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN1433"></a>                      <a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Parameter'>livetuples</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Parameter'>deadtuples</span><span class='Delimiter'>, 
</span><a name="LN1434"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>resetcounter</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1436"></a>    <a href="../../include/pgstat.h.html#LN379"><span class='Ref_to_Struct'>PgStat_MsgAnalyze</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unlike VACUUM, ANALYZE might be running inside a transaction that has 
     * already inserted and/or deleted rows in the target table. ANALYZE will 
     * have counted such rows as live or dead respectively. Because we will 
     * report our counts of such rows at transaction end, we should subtract 
     * off these counts from what we send to the collector now, else they'll 
     * be double-counted after commit.  (This approach also ensures that the 
     * collector ends up with the right numbers if we abort instead of 
     * committing.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1432"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1453"></a>        <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trans</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1432"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>livetuples</span></a> <span class='Operator'>-= </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>- </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>deadtuples</span></a> <span class='Operator'>-= </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN1453"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* count stuff inserted by already-aborted subxacts, too */ 
</span>        <a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>deadtuples</span></a> <span class='Operator'>-= </span><a href="pgstat.c.html#LN1432"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Since ANALYZE's counts are estimates, we could have underflowed */ 
</span>        <a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>livetuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>livetuples</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>deadtuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>deadtuples</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN381"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN59"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_ANALYZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN382"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1432"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared <span class='Operator'>? </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>: </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN383"><span class='Ref_to_Member'>m_tableoid</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1432"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN384"><span class='Ref_to_Member'>m_autovacuum</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN385"><span class='Ref_to_Member'>m_resetcounter</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1434"><span class='Ref_to_Parameter'>resetcounter</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN386"><span class='Ref_to_Member'>m_analyzetime</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN387"><span class='Ref_to_Member'>m_live_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>livetuples</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN388"><span class='Ref_to_Member'>m_dead_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1433"><span class='Ref_to_Parameter'>deadtuples</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1436"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_report_analyze &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------- 
 * pgstat_report_recovery_conflict() - 
 * 
 *  Tell the collector about a Hot Standby recovery conflict. 
 * -------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1485"></a><span class='Declare_Function'>pgstat_report_recovery_conflict</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>reason</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1487"></a>    <a href="../../include/pgstat.h.html#LN428"><span class='Ref_to_Struct'>PgStat_MsgRecoveryConflict</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1487"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN430"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN64"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RECOVERYCONFLICT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1487"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN432"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1487"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN433"><span class='Ref_to_Member'>m_reason</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1485"><span class='Ref_to_Parameter'>reason</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1487"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1487"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------- 
 * pgstat_report_deadlock() - 
 * 
 *  Tell the collector about a deadlock detected. 
 * -------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1505"></a><span class='Declare_Function'>pgstat_report_deadlock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1507"></a>    <a href="../../include/pgstat.h.html#LN526"><span class='Ref_to_Struct'>PgStat_MsgDeadlock</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1507"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN528"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN66"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_DEADLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1507"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN529"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1507"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1507"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* -------- 
 * pgstat_report_tempfile() - 
 * 
 *  Tell the collector about a temporary file. 
 * -------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1524"></a><span class='Declare_Function'>pgstat_report_tempfile</span><span class='Parentheses'>(</span>size_t <span class='Declare_Parameter'>filesize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1526"></a>    <a href="../../include/pgstat.h.html#LN440"><span class='Ref_to_Struct'>PgStat_MsgTempFile</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1526"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN442"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN65"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TEMPFILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1526"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN444"><span class='Ref_to_Member'>m_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1526"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN445"><span class='Ref_to_Member'>m_filesize</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1524"><span class='Ref_to_Parameter'>filesize</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1526"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1526"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_ping() - 
 * 
 *  Send some junk data to the collector to increase traffic. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1545"></a><span class='Declare_Function'>pgstat_ping</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1547"></a>    <a href="../../include/pgstat.h.html#LN213"><span class='Ref_to_Struct'>PgStat_MsgDummy</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1547"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN215"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN49"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_DUMMY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1547"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1547"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_send_inquiry() - 
 * 
 *  Notify collector that we need fresh data. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1563"></a><span class='Declare_Function'>pgstat_send_inquiry</span><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>clock_time</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>cutoff_time</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1565"></a>    <a href="../../include/pgstat.h.html#LN238"><span class='Ref_to_Struct'>PgStat_MsgInquiry</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1565"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN240"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN50"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_INQUIRY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1565"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN241"><span class='Ref_to_Member'>clock_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1563"><span class='Ref_to_Parameter'>clock_time</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1565"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN242"><span class='Ref_to_Member'>cutoff_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1563"><span class='Ref_to_Parameter'>cutoff_time</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1565"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN243"><span class='Ref_to_Member'>databaseid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1563"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1565"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1565"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize function call usage data. 
 * Called by the executor before invoking a function. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1580"></a><span class='Declare_Function'>pgstat_init_function_usage</span><span class='Parentheses'>(</span><a href="../../include/fmgr.h.html#LN76"><span class='Ref_to_Struct'>FunctionCallInfoData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN1581"></a>                           <a href="../../include/pgstat.h.html#LN1086"><span class='Ref_to_Struct'>PgStat_FunctionCallUsage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fcu</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1583"></a>    <a href="../../include/pgstat.h.html#LN469"><span class='Ref_to_Struct'>PgStat_BackendFunctionEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>htabent</span><span class='Delimiter'>; 
</span><a name="LN1584"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN126"><span class='Ref_to_Global_Var'>pgstat_track_functions</span></a> <span class='Operator'>&LT;= </span><a href="pgstat.c.html#LN1580"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN62"><span class='Ref_to_Member'>fn_stats</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* stats not wanted */ 
</span>        <a href="pgstat.c.html#LN1581"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1090"><span class='Ref_to_Member'>fs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* First time through - initialize function stat table */ 
</span><a name="LN1596"></a>        <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1596"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1596"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1596"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1596"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN469"><span class='Ref_to_Struct'>PgStat_BackendFunctionEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Function stat entries"</span><span class='Delimiter'>, 
</span>                                      <a href="pgstat.c.html#LN105"><span class='Ref_to_Const'>PGSTAT_FUNCTION_HASH_SIZE</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="pgstat.c.html#LN1596"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Get the stats entry for this function, create if necessary */ 
</span>    <a href="pgstat.c.html#LN1583"><span class='Ref_To_Local'>htabent</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1580"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Delimiter'>, 
</span>                          <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1584"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN1584"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1583"><span class='Ref_To_Local'>htabent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN458"><span class='Ref_to_Struct'>PgStat_FunctionCounts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN1581"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1090"><span class='Ref_to_Member'>fs</span></a> <span class='Operator'>= &</span><a href="pgstat.c.html#LN1583"><span class='Ref_To_Local'>htabent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* save stats for this function, later used to compensate for recursion */ 
</span>    <a href="pgstat.c.html#LN1581"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1092"><span class='Ref_to_Member'>save_f_total_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1583"><span class='Ref_To_Local'>htabent</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN472"><span class='Ref_to_Member'>f_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN461"><span class='Ref_to_Member'>f_total_time</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* save current backend-wide total time */ 
</span>    <a href="pgstat.c.html#LN1581"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1094"><span class='Ref_to_Member'>save_total</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN275"><span class='Ref_to_Global_Var'>total_func_time</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get clock time as of function start */ 
</span>    <a href="../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1581"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1096"><span class='Ref_to_Member'>f_start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_init_function_usage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * find_funcstat_entry - find any existing PgStat_BackendFunctionEntry entry 
 *      for specified function 
 * 
 * If no entry, return NULL, don't create a new one 
 */ 
</span><a href="../../include/pgstat.h.html#LN469"><span class='Ref_to_Struct'>PgStat_BackendFunctionEntry</span></a> <span class='Operator'>* 
</span><a name="LN1632"></a><span class='Declare_Function'>find_funcstat_entry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>func_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN469"><span class='Ref_to_Struct'>PgStat_BackendFunctionEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN196"><span class='Ref_to_Global_Var'>pgStatFunctions</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1632"><span class='Ref_to_Parameter'>func_id</span></a><span class='Delimiter'>, 
</span>                                                       <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Calculate function call usage and update stat counters. 
 * Called by the executor after invoking a function. 
 * 
 * In the case of a set-returning function that runs in value-per-call mode, 
 * we will see multiple pgstat_init_function_usage/pgstat_end_function_usage 
 * calls for what the user considers a single call of the function.  The 
 * finalize flag should be TRUE on the last call. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1652"></a><span class='Declare_Function'>pgstat_end_function_usage</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN1086"><span class='Ref_to_Struct'>PgStat_FunctionCallUsage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fcu</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>finalize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1654"></a>    <a href="../../include/pgstat.h.html#LN458"><span class='Ref_to_Struct'>PgStat_FunctionCounts</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fs</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1652"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1090"><span class='Ref_to_Member'>fs</span></a><span class='Delimiter'>; 
</span><a name="LN1655"></a>    <a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>f_total</span><span class='Delimiter'>; 
</span><a name="LN1656"></a>    <a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>f_others</span><span class='Delimiter'>; 
</span><a name="LN1657"></a>    <a href="../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>f_self</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* stats not wanted? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1654"><span class='Ref_To_Local'>fs</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* total elapsed time in this function call */ 
</span>    <a href="../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1655"><span class='Ref_To_Local'>f_total</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/portability/instr_time.h.html#LN102"><span class='Ref_to_Macro'>INSTR_TIME_SUBTRACT</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1655"><span class='Ref_To_Local'>f_total</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1652"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1096"><span class='Ref_to_Member'>f_start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* self usage: elapsed minus anything already charged to other calls */ 
</span>    <a href="pgstat.c.html#LN1656"><span class='Ref_To_Local'>f_others</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN275"><span class='Ref_to_Global_Var'>total_func_time</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/portability/instr_time.h.html#LN102"><span class='Ref_to_Macro'>INSTR_TIME_SUBTRACT</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1656"><span class='Ref_To_Local'>f_others</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1652"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1094"><span class='Ref_to_Member'>save_total</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1657"><span class='Ref_To_Local'>f_self</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1655"><span class='Ref_To_Local'>f_total</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/portability/instr_time.h.html#LN102"><span class='Ref_to_Macro'>INSTR_TIME_SUBTRACT</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1657"><span class='Ref_To_Local'>f_self</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1656"><span class='Ref_To_Local'>f_others</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* update backend-wide total time */ 
</span>    <a href="../../include/portability/instr_time.h.html#LN90"><span class='Ref_to_Macro'>INSTR_TIME_ADD</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN275"><span class='Ref_to_Global_Var'>total_func_time</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1657"><span class='Ref_To_Local'>f_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the new f_total_time as the total elapsed time added to the 
     * pre-call value of f_total_time.  This is necessary to avoid 
     * double-counting any time taken by recursive calls of myself.  (We do 
     * not need any similar kluge for self time, since that already excludes 
     * any recursive calls.) 
     */ 
</span>    <a href="../../include/portability/instr_time.h.html#LN90"><span class='Ref_to_Macro'>INSTR_TIME_ADD</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1655"><span class='Ref_To_Local'>f_total</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1652"><span class='Ref_to_Parameter'>fcu</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1092"><span class='Ref_to_Member'>save_f_total_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* update counters in function stats table */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1652"><span class='Ref_to_Parameter'>finalize</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN1654"><span class='Ref_To_Local'>fs</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN460"><span class='Ref_to_Member'>f_numcalls</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1654"><span class='Ref_To_Local'>fs</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN461"><span class='Ref_to_Member'>f_total_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1655"><span class='Ref_To_Local'>f_total</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/portability/instr_time.h.html#LN90"><span class='Ref_to_Macro'>INSTR_TIME_ADD</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1654"><span class='Ref_To_Local'>fs</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN462"><span class='Ref_to_Member'>f_self_time</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1657"><span class='Ref_To_Local'>f_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* indicate that we have something to send */ 
</span>    <a href="pgstat.c.html#LN202"><span class='Ref_to_Global_Var'>have_function_stats</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_end_function_usage &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_initstats() - 
 * 
 *  Initialize a relcache entry to count access statistics. 
 *  Called whenever a relation is opened. 
 * 
 *  We assume that a relcache entry's pgstat_info field is zeroed by 
 *  relcache.c when the relcache entry is made; thereafter it is long-lived 
 *  data.  We can avoid repeated searches of the TabStatus arrays when the 
 *  same relation is touched repeatedly within a transaction. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1709"></a><span class='Declare_Function'>pgstat_initstats</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1711"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>rel_id</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Delimiter'>; 
</span><a name="LN1712"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>relkind</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We only count stats for things that have storage */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1712"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>          <a href="pgstat.c.html#LN1712"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>          <a href="pgstat.c.html#LN1712"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN160"><span class='Ref_to_Const'>RELKIND_INDEX</span></a> <span class='Operator'>|| 
</span>          <a href="pgstat.c.html#LN1712"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN162"><span class='Ref_to_Const'>RELKIND_TOASTVALUE</span></a> <span class='Operator'>|| 
</span>          <a href="pgstat.c.html#LN1712"><span class='Ref_To_Local'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN161"><span class='Ref_to_Const'>RELKIND_SEQUENCE</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN125"><span class='Ref_to_Global_Var'>pgstat_track_counts</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We're not counting at all */ 
</span>        <a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we already set up this relation in the current transaction, nothing 
     * to do. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN154"><span class='Ref_to_Member'>t_id</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN1711"><span class='Ref_To_Local'>rel_id</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Else find or make the PgStat_TableStatus entry, and update link */ 
</span>    <a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN308"><span class='Ref_to_Proto'>get_tabstat_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1711"><span class='Ref_To_Local'>rel_id</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1709"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_initstats &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_tabstat_entry - find or create a PgStat_TableStatus entry for rel 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>* 
</span><a name="LN1748"></a><span class='Declare_Function'>get_tabstat_entry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>rel_id</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isshared</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1750"></a>    <a href="pgstat.c.html#LN181"><span class='Ref_to_Struct'>TabStatHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hash_entry</span><span class='Delimiter'>; 
</span><a name="LN1751"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN1752"></a>    <a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tsa</span><span class='Delimiter'>; 
</span><a name="LN1753"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create hash table if we don't have it already. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1760"></a>        <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN1760"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1760"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1760"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1760"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN181"><span class='Ref_to_Struct'>TabStatHashEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"pgstat TabStatusArray lookup hash table"</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN167"><span class='Ref_to_Const'>TABSTAT_QUANTUM</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="pgstat.c.html#LN1760"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find an entry or create a new one. 
     */ 
</span>    <a href="pgstat.c.html#LN1750"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1748"><span class='Ref_to_Parameter'>rel_id</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1753"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN1753"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* initialize new entry with null pointer */ 
</span>        <a href="pgstat.c.html#LN1750"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN184"><span class='Ref_to_Member'>tsa_entry</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If entry is already valid, we're done. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1750"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN184"><span class='Ref_to_Member'>tsa_entry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="pgstat.c.html#LN1750"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN184"><span class='Ref_to_Member'>tsa_entry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Locate the first pgStatTabList entry with free space, making a new list 
     * entry if needed.  Note that we could get an OOM failure here, but if so 
     * we have left the hashtable and the list in a consistent state. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN176"><span class='Ref_to_Global_Var'>pgStatTabList</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Set up first pgStatTabList entry */ 
</span>        <a href="pgstat.c.html#LN176"><span class='Ref_to_Global_Var'>pgStatTabList</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN176"><span class='Ref_to_Global_Var'>pgStatTabList</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN172"><span class='Ref_to_Member'>tsa_used</span></a> <span class='Operator'>&GT;= </span><a href="pgstat.c.html#LN167"><span class='Ref_to_Const'>TABSTAT_QUANTUM</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN171"><span class='Ref_to_Member'>tsa_next</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN171"><span class='Ref_to_Member'>tsa_next</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN169"><span class='Ref_to_Struct'>TabStatusArray</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN171"><span class='Ref_to_Member'>tsa_next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate a PgStat_TableStatus entry within this list entry.  We assume 
     * the entry was already zeroed, either at creation or after last use. 
     */ 
</span>    <a href="pgstat.c.html#LN1751"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= &</span><a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN173"><span class='Ref_to_Member'>tsa_entries</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN1752"><span class='Ref_To_Local'>tsa</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN172"><span class='Ref_to_Member'>tsa_used</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>    <a href="pgstat.c.html#LN1751"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN154"><span class='Ref_to_Member'>t_id</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1748"><span class='Ref_to_Parameter'>rel_id</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1751"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN155"><span class='Ref_to_Member'>t_shared</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1748"><span class='Ref_to_Parameter'>isshared</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we can fill the entry in pgStatTabHash. 
     */ 
</span>    <a href="pgstat.c.html#LN1750"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN184"><span class='Ref_to_Member'>tsa_entry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1751"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN1751"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_tabstat_entry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * find_tabstat_entry - find any existing PgStat_TableStatus entry for rel 
 * 
 * If no entry, return NULL, don't create a new one 
 * 
 * Note: if we got an error in the most recent execution of pgstat_report_stat, 
 * it's possible that an entry exists but there's no hashtable entry for it. 
 * That's okay, we'll treat this case as "doesn't exist". 
 */ 
</span><a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>* 
</span><a name="LN1837"></a><span class='Declare_Function'>find_tabstat_entry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>rel_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1839"></a>    <a href="pgstat.c.html#LN181"><span class='Ref_to_Struct'>TabStatHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hash_entry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If hashtable doesn't exist, there are no entries at all */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN1839"><span class='Ref_To_Local'>hash_entry</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN190"><span class='Ref_to_Global_Var'>pgStatTabHash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN1837"><span class='Ref_to_Parameter'>rel_id</span></a><span class='Delimiter'>, </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN1839"><span class='Ref_To_Local'>hash_entry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Note that this step could also return NULL, but that's correct */ 
</span>    <span class='Control'>return</span> <a href="pgstat.c.html#LN1839"><span class='Ref_To_Local'>hash_entry</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN184"><span class='Ref_to_Member'>tsa_entry</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * get_tabstat_stack_level - add a new (sub)transaction stack entry if needed 
 */ 
</span><span class='Keyword'>static </span><a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>* 
</span><a name="LN1857"></a><span class='Declare_Function'>get_tabstat_stack_level</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nest_level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1859"></a>    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xact_state</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN213"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN1857"><span class='Ref_to_Parameter'>nest_level</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN213"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1857"><span class='Ref_to_Parameter'>nest_level</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN214"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="pgstat.c.html#LN1859"><span class='Ref_To_Local'>xact_state</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * add_tabstat_xact_level - add a new (sub)transaction state record 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1879"></a><span class='Declare_Function'>add_tabstat_xact_level</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pgstat_info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nest_level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1881"></a>    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xact_state</span><span class='Delimiter'>; 
</span><a name="LN1882"></a>    <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trans</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is the first rel to be modified at the current nest level, we 
     * first have to push a transaction stack entry. 
     */ 
</span>    <a href="pgstat.c.html#LN1881"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1856"><span class='Ref_to_Func'>get_tabstat_stack_level</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1879"><span class='Ref_to_Parameter'>nest_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now make a per-table stack entry */ 
</span>    <a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1879"><span class='Ref_to_Parameter'>nest_level</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1879"><span class='Ref_to_Parameter'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN176"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1879"><span class='Ref_to_Parameter'>pgstat_info</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN178"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1881"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1881"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN1879"><span class='Ref_to_Parameter'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1882"><span class='Ref_To_Local'>trans</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end add_tabstat_xact_level &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pgstat_count_heap_insert - count a tuple insertion of n tuples 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1906"></a><span class='Declare_Function'>pgstat_count_heap_insert</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1908"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1906"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1908"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We have to log the effect at the proper transactional level */ 
</span><a name="LN1913"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nest_level</span> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1908"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <a href="pgstat.c.html#LN1908"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN1913"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>) 
</span>            <a href="pgstat.c.html#LN1878"><span class='Ref_to_Func'>add_tabstat_xact_level</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1908"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1913"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN1908"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN1906"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pgstat_count_heap_update - count a tuple update 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1927"></a><span class='Declare_Function'>pgstat_count_heap_update</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>hot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1929"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1927"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1929"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We have to log the effect at the proper transactional level */ 
</span><a name="LN1934"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nest_level</span> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1929"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <a href="pgstat.c.html#LN1929"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN1934"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>) 
</span>            <a href="pgstat.c.html#LN1878"><span class='Ref_to_Func'>add_tabstat_xact_level</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1929"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1934"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN1929"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* t_tuples_hot_updated is nontransactional, so just advance it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1927"><span class='Ref_to_Parameter'>hot</span></a><span class='Parentheses'>) 
</span>            <a href="pgstat.c.html#LN1929"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN106"><span class='Ref_to_Member'>t_tuples_hot_updated</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_count_heap_update &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pgstat_count_heap_delete - count a tuple deletion 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1952"></a><span class='Declare_Function'>pgstat_count_heap_delete</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1954"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN1952"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1954"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We have to log the effect at the proper transactional level */ 
</span><a name="LN1959"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nest_level</span> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1954"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <a href="pgstat.c.html#LN1954"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN1959"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>) 
</span>            <a href="pgstat.c.html#LN1878"><span class='Ref_to_Func'>add_tabstat_xact_level</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN1954"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN1959"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN1954"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pgstat_truncate_save_counters 
 * 
 * Whenever a table is truncated, we save its i/u/d counters so that they can 
 * be cleared, and if the (sub)xact that executed the truncate later aborts, 
 * the counters can be restored to the saved (pre-truncate) values.  Note we do 
 * this on the first truncate in any particular subxact level only. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1978"></a><span class='Declare_Function'>pgstat_truncate_save_counters</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trans</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN170"><span class='Ref_to_Member'>inserted_pre_trunc</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN171"><span class='Ref_to_Member'>updated_pre_trunc</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN172"><span class='Ref_to_Member'>deleted_pre_trunc</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1978"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pgstat_truncate_restore_counters - restore counters when a truncate aborts 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1993"></a><span class='Declare_Function'>pgstat_truncate_restore_counters</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trans</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN170"><span class='Ref_to_Member'>inserted_pre_trunc</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN171"><span class='Ref_to_Member'>updated_pre_trunc</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1993"><span class='Ref_to_Parameter'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN172"><span class='Ref_to_Member'>deleted_pre_trunc</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pgstat_count_truncate - update tuple counters due to truncate 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2007"></a><span class='Declare_Function'>pgstat_count_truncate</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2009"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2007"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We have to log the effect at the proper transactional level */ 
</span><a name="LN2014"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nest_level</span> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN2014"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>) 
</span>            <a href="pgstat.c.html#LN1878"><span class='Ref_to_Func'>add_tabstat_xact_level</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2014"><span class='Ref_To_Local'>nest_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN1977"><span class='Ref_to_Func'>pgstat_truncate_save_counters</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2009"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_count_truncate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pgstat_update_heap_dead_tuples - update dead-tuples count 
 * 
 * The semantics of this are that we are reporting the nontransactional 
 * recovery of "delta" dead tuples; so t_delta_dead_tuples decreases 
 * rather than increasing, and the change goes straight into the per-table 
 * counter, not into transactional state. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2036"></a><span class='Declare_Function'>pgstat_update_heap_dead_tuples</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>delta</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2038"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2036"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN217"><span class='Ref_to_Member'>pgstat_info</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2038"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN2038"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>-= </span><a href="pgstat.c.html#LN2036"><span class='Ref_to_Parameter'>delta</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * AtEOXact_PgStat 
 * 
 *  Called from access/transam/xact.c at top-level transaction commit/abort. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2052"></a><span class='Declare_Function'>AtEOXact_PgStat</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2054"></a>    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xact_state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Count transaction commit or abort.  (We use counters, not just bools, 
     * in case the reporting message isn't sent right away.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2052"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN220"><span class='Ref_to_Global_Var'>pgStatXactCommit</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pgstat.c.html#LN221"><span class='Ref_to_Global_Var'>pgStatXactRollback</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Transfer transactional insert/update counts into the base tabstat 
     * entries.  We don't bother to free any of the transactional state, since 
     * it's all in TopTransactionContext and will go away anyway. 
     */ 
</span>    <a href="pgstat.c.html#LN2054"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2054"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2073"></a>        <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trans</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2054"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN213"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2054"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN214"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2054"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN178"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2079"></a>            <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabstat</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN176"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* restore pre-truncate stats (if any) in case of aborted xact */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2052"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>                <a href="pgstat.c.html#LN1992"><span class='Ref_to_Func'>pgstat_truncate_restore_counters</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* count attempted actions regardless of commit/abort */ 
</span>            <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2052"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN107"><span class='Ref_to_Member'>t_truncated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* forget live/dead stats seen by backend thus far */ 
</span>                    <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN109"><span class='Ref_to_Member'>t_delta_live_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Comment_Multi_Line'>/* insert adds a live tuple, delete removes one */ 
</span>                <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN109"><span class='Ref_to_Member'>t_delta_live_tuples</span></a> <span class='Operator'>+= 
</span>                    <a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>- </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* update and delete each create a dead tuple */ 
</span>                <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>+= 
</span>                    <a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* insert, update, delete each count as one change event */ 
</span>                <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN111"><span class='Ref_to_Member'>t_changed_tuples</span></a> <span class='Operator'>+= 
</span>                    <a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+ 
</span>                    <a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isCommit &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* inserted tuples are dead, deleted tuples are unaffected */ 
</span>                <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>+= 
</span>                    <a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2073"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* an aborted xact generates no changed_tuple events */ 
</span>            <span class='Delimiter'>} 
</span>            <a href="pgstat.c.html#LN2079"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for trans=xact_state-&GT;fir... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if xact_state!=NULL &raquo; </span> 
    <a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure any stats snapshot is thrown away */ 
</span>    <a href="../../include/pgstat.h.html#LN1150"><span class='Ref_to_Proto'>pgstat_clear_snapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtEOXact_PgStat &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * AtEOSubXact_PgStat 
 * 
 *  Called from access/transam/xact.c at subtransaction commit/abort. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2135"></a><span class='Declare_Function'>AtEOSubXact_PgStat</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nestDepth</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2137"></a>    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xact_state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Transfer transactional insert/update counts into the next higher 
     * subtransaction state. 
     */ 
</span>    <a href="pgstat.c.html#LN2137"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2137"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="pgstat.c.html#LN2137"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN213"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>&GT;= </span><a href="pgstat.c.html#LN2135"><span class='Ref_to_Parameter'>nestDepth</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2147"></a>        <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trans</span><span class='Delimiter'>; 
</span><a name="LN2148"></a>        <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next_trans</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* delink xact_state from stack immediately to simplify reuse case */ 
</span>        <a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2137"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN214"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2137"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2148"><span class='Ref_To_Local'>next_trans</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2155"></a>            <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabstat</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN2148"><span class='Ref_To_Local'>next_trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN178"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN2135"><span class='Ref_to_Parameter'>nestDepth</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN176"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2135"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a> <span class='Operator'>&& </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN2135"><span class='Ref_to_Parameter'>nestDepth</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* propagate the truncate status one level up */ 
</span>                        <a href="pgstat.c.html#LN1977"><span class='Ref_to_Func'>pgstat_truncate_save_counters</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Comment_Multi_Line'>/* replace upper xact stats with ours */ 
</span>                        <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>                        <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>                        <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>                        <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>                        <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Delimiter'>; 
</span>                    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if trans-&GT;upper&&trans-&GT;... &raquo; </span> 
                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * When there isn't an immediate parent state, we can just 
                     * reuse the record instead of going through a 
                     * palloc/pfree pushup (this works since it's all in 
                     * TopTransactionContext anyway).  We have to re-link it 
                     * into the parent level, though, and that might mean 
                     * pushing a new entry into the pgStatXactStack. 
                     */ 
</span><a name="LN2193"></a>                    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>upper_xact_state</span><span class='Delimiter'>; 
</span> 
                    <a href="pgstat.c.html#LN2193"><span class='Ref_To_Local'>upper_xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN1856"><span class='Ref_to_Func'>get_tabstat_stack_level</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2135"><span class='Ref_to_Parameter'>nestDepth</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN178"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2193"><span class='Ref_To_Local'>upper_xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; 
</span>                    <a href="pgstat.c.html#LN2193"><span class='Ref_To_Local'>upper_xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Delimiter'>; 
</span>                    <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2135"><span class='Ref_to_Parameter'>nestDepth</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isCommit &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * On abort, update top-level tabstat counts, then forget the 
                 * subtransaction 
                 */ 
</span> 
                <span class='Comment_Multi_Line'>/* first restore values obliterated by truncate */ 
</span>                <a href="pgstat.c.html#LN1992"><span class='Ref_to_Func'>pgstat_truncate_restore_counters</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* count attempted actions regardless of commit/abort */ 
</span>                <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* inserted tuples are dead, deleted tuples are unaffected */ 
</span>                <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>+= 
</span>                    <a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN2155"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2147"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for trans=xact_state-&GT;fir... &raquo; </span> 
        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2137"><span class='Ref_To_Local'>xact_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if xact_state!=NULL&&xac... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtEOSubXact_PgStat &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * AtPrepare_PgStat 
 *      Save the transactional stats state at 2PC transaction prepare. 
 * 
 * In this phase we just generate 2PC records for all the pending 
 * transaction-dependent stats work. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2234"></a><span class='Declare_Function'>AtPrepare_PgStat</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2236"></a>    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xact_state</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN2236"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2236"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2241"></a>        <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trans</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2236"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN213"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2236"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN214"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2236"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN178"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2247"></a>            <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabstat</span><span class='Delimiter'>; 
</span><a name="LN2248"></a>            <a href="pgstat.c.html#LN226"><span class='Ref_to_Struct'>TwoPhasePgStatRecord</span></a> <span class='Declare_Local'>record</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN173"><span class='Ref_to_Member'>nest_level</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN175"><span class='Ref_to_Member'>upper</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2247"><span class='Ref_To_Local'>tabstat</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN176"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2247"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN166"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN167"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN168"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN231"><span class='Ref_to_Member'>inserted_pre_trunc</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN170"><span class='Ref_to_Member'>inserted_pre_trunc</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN232"><span class='Ref_to_Member'>updated_pre_trunc</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN171"><span class='Ref_to_Member'>updated_pre_trunc</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN233"><span class='Ref_to_Member'>deleted_pre_trunc</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN172"><span class='Ref_to_Member'>deleted_pre_trunc</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN234"><span class='Ref_to_Member'>t_id</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2247"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN154"><span class='Ref_to_Member'>t_id</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN235"><span class='Ref_to_Member'>t_shared</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2247"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN155"><span class='Ref_to_Member'>t_shared</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="pgstat.c.html#LN236"><span class='Ref_to_Member'>t_truncated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2241"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN169"><span class='Ref_to_Member'>truncated</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../include/access/twophase_rmgr.h.html#LN36"><span class='Ref_to_Proto'>RegisterTwoPhaseRecord</span></a><span class='Parentheses'>(</span><a href="../../include/access/twophase_rmgr.h.html#LN25"><span class='Ref_to_Const'>TWOPHASE_RM_PGSTAT_ID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="pgstat.c.html#LN2248"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN226"><span class='Ref_to_Struct'>TwoPhasePgStatRecord</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for trans=xact_state-&GT;fir... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if xact_state!=NULL &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtPrepare_PgStat &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PostPrepare_PgStat 
 *      Clean up after successful PREPARE. 
 * 
 * All we need do here is unlink the transaction stats state from the 
 * nontransactional state.  The nontransactional action counts will be 
 * reported to the stats collector immediately, while the effects on live 
 * and dead tuple counts are preserved in the 2PC state file. 
 * 
 * Note: AtEOXact_PgStat is not called during PREPARE. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2283"></a><span class='Declare_Function'>PostPrepare_PgStat</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2285"></a>    <a href="pgstat.c.html#LN211"><span class='Ref_to_Struct'>PgStat_SubXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>xact_state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't bother to free any of the transactional state, since it's all 
     * in TopTransactionContext and will go away anyway. 
     */ 
</span>    <a href="pgstat.c.html#LN2285"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2285"><span class='Ref_To_Local'>xact_state</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2294"></a>        <a href="../../include/pgstat.h.html#LN164"><span class='Ref_to_Struct'>PgStat_TableXactStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trans</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2294"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2285"><span class='Ref_To_Local'>xact_state</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN215"><span class='Ref_to_Member'>first</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2294"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2294"><span class='Ref_To_Local'>trans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2294"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN178"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2298"></a>            <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabstat</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN2298"><span class='Ref_To_Local'>tabstat</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2294"><span class='Ref_To_Local'>trans</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN176"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2298"><span class='Ref_To_Local'>tabstat</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN156"><span class='Ref_to_Member'>trans</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="pgstat.c.html#LN218"><span class='Ref_to_Global_Var'>pgStatXactStack</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure any stats snapshot is thrown away */ 
</span>    <a href="../../include/pgstat.h.html#LN1150"><span class='Ref_to_Proto'>pgstat_clear_snapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PostPrepare_PgStat &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * 2PC processing routine for COMMIT PREPARED case. 
 * 
 * Load the saved counts into our local pgstats state. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2316"></a><span class='Declare_Function'>pgstat_twophase_postcommit</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN2317"></a>                           <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2319"></a>    <a href="pgstat.c.html#LN226"><span class='Ref_to_Struct'>TwoPhasePgStatRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN226"><span class='Ref_to_Struct'>TwoPhasePgStatRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN2317"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>; 
</span><a name="LN2320"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create a tabstat entry for the rel */ 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN308"><span class='Ref_to_Proto'>get_tabstat_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN234"><span class='Ref_to_Member'>t_id</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN235"><span class='Ref_to_Member'>t_shared</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Same math as in AtEOXact_PgStat, commit case */ 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN107"><span class='Ref_to_Member'>t_truncated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN236"><span class='Ref_to_Member'>t_truncated</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN236"><span class='Ref_to_Member'>t_truncated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* forget live/dead stats seen by backend thus far */ 
</span>        <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN109"><span class='Ref_to_Member'>t_delta_live_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN109"><span class='Ref_to_Member'>t_delta_live_tuples</span></a> <span class='Operator'>+= 
</span>        <a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>- </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>+= 
</span>        <a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2320"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN111"><span class='Ref_to_Member'>t_changed_tuples</span></a> <span class='Operator'>+= 
</span>        <a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+ 
</span>        <a href="pgstat.c.html#LN2319"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_twophase_postcommit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * 2PC processing routine for ROLLBACK PREPARED case. 
 * 
 * Load the saved counts into our local pgstats state, but treat them 
 * as aborted. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2352"></a><span class='Declare_Function'>pgstat_twophase_postabort</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN2353"></a>                          <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2355"></a>    <a href="pgstat.c.html#LN226"><span class='Ref_to_Struct'>TwoPhasePgStatRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN226"><span class='Ref_to_Struct'>TwoPhasePgStatRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN2353"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>; 
</span><a name="LN2356"></a>    <a href="../../include/pgstat.h.html#LN152"><span class='Ref_to_Struct'>PgStat_TableStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pgstat_info</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create a tabstat entry for the rel */ 
</span>    <a href="pgstat.c.html#LN2356"><span class='Ref_To_Local'>pgstat_info</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN308"><span class='Ref_to_Proto'>get_tabstat_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN234"><span class='Ref_to_Member'>t_id</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN235"><span class='Ref_to_Member'>t_shared</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Same math as in AtEOXact_PgStat, abort case */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN236"><span class='Ref_to_Member'>t_truncated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN231"><span class='Ref_to_Member'>inserted_pre_trunc</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN232"><span class='Ref_to_Member'>updated_pre_trunc</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN233"><span class='Ref_to_Member'>deleted_pre_trunc</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pgstat.c.html#LN2356"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2356"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2356"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN230"><span class='Ref_to_Member'>tuples_deleted</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2356"><span class='Ref_To_Local'>pgstat_info</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN157"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a> <span class='Operator'>+= 
</span>        <a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN228"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2355"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="pgstat.c.html#LN229"><span class='Ref_to_Member'>tuples_updated</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_twophase_postabort &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_fetch_stat_dbentry() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  the collected statistics for one database or NULL. NULL doesn't mean 
 *  that the database doesn't exist, it is just not yet known by the 
 *  collector, so the caller is better off to report ZERO instead. 
 * ---------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>* 
</span><a name="LN2386"></a><span class='Declare_Function'>pgstat_fetch_stat_dbentry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If not done for this transaction, read the statistics collector stats 
     * file into some hash tables. 
     */ 
</span>    <a href="pgstat.c.html#LN298"><span class='Ref_to_Proto'>backend_read_statsfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup the requested database; return NULL if not found 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Delimiter'>, 
</span>                                              <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2386"><span class='Ref_to_Parameter'>dbid</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_fetch_stat_tabentry() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  the collected statistics for one table or NULL. NULL doesn't mean 
 *  that the table doesn't exist, it is just not yet known by the 
 *  collector, so the caller is better off to report ZERO instead. 
 * ---------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>* 
</span><a name="LN2413"></a><span class='Declare_Function'>pgstat_fetch_stat_tabentry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2415"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span><span class='Delimiter'>; 
</span><a name="LN2416"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN2417"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If not done for this transaction, read the statistics collector stats 
     * file into some hash tables. 
     */ 
</span>    <a href="pgstat.c.html#LN298"><span class='Ref_to_Proto'>backend_read_statsfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup our database, then look in its table hash table. 
     */ 
</span>    <a href="pgstat.c.html#LN2415"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2415"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2417"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2413"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                                                       <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2417"><span class='Ref_To_Local'>tabentry</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="pgstat.c.html#LN2417"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we didn't find it, maybe it's a shared table. 
     */ 
</span>    <a href="pgstat.c.html#LN2415"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2415"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2417"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2416"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2413"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, 
</span>                                                       <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2417"><span class='Ref_To_Local'>tabentry</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="pgstat.c.html#LN2417"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_fetch_stat_tabentry &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_fetch_stat_funcentry() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  the collected statistics for one function or NULL. 
 * ---------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>* 
</span><a name="LN2469"></a><span class='Declare_Function'>pgstat_fetch_stat_funcentry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>func_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2471"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN2472"></a>    <a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcentry</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* load the stats file if needed */ 
</span>    <a href="pgstat.c.html#LN298"><span class='Ref_to_Proto'>backend_read_statsfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lookup our database, then find the requested function.  */ 
</span>    <a href="pgstat.c.html#LN2471"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1317"><span class='Ref_to_Proto'>pgstat_fetch_stat_dbentry</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2471"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pgstat.c.html#LN2471"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2472"><span class='Ref_To_Local'>funcentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2471"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Delimiter'>, 
</span>                                                         <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2469"><span class='Ref_to_Parameter'>func_id</span></a><span class='Delimiter'>, 
</span>                                                         <a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN2472"><span class='Ref_To_Local'>funcentry</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_fetch_stat_funcentry &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_fetch_stat_beentry() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  our local copy of the current-activity entry for one backend. 
 * 
 *  NB: caller is responsible for a check if the user is permitted to see 
 *  this info (especially the querystring). 
 * ---------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>* 
</span><a name="LN2501"></a><span class='Declare_Function'>pgstat_fetch_stat_beentry</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>beid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN299"><span class='Ref_to_Proto'>pgstat_read_current_status</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2501"><span class='Ref_to_Parameter'>beid</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="pgstat.c.html#LN2501"><span class='Ref_to_Parameter'>beid</span></a> <span class='Operator'>&GT; </span><a href="pgstat.c.html#LN249"><span class='Ref_to_Global_Var'>localNumBackends</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgstat.c.html#LN246"><span class='Ref_to_Global_Var'>localBackendStatusTable</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2501"><span class='Ref_to_Parameter'>beid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_fetch_stat_local_beentry() - 
 * 
 *  Like pgstat_fetch_stat_beentry() but with locally computed additions (like 
 *  xid and xmin values of the backend) 
 * 
 *  NB: caller is responsible for a check if the user is permitted to see 
 *  this info (especially the querystring). 
 * ---------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN1063"><span class='Ref_to_Struct'>LocalPgBackendStatus</span></a> <span class='Operator'>* 
</span><a name="LN2523"></a><span class='Declare_Function'>pgstat_fetch_stat_local_beentry</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>beid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN299"><span class='Ref_to_Proto'>pgstat_read_current_status</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2523"><span class='Ref_to_Parameter'>beid</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="pgstat.c.html#LN2523"><span class='Ref_to_Parameter'>beid</span></a> <span class='Operator'>&GT; </span><a href="pgstat.c.html#LN249"><span class='Ref_to_Global_Var'>localNumBackends</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgstat.c.html#LN246"><span class='Ref_to_Global_Var'>localBackendStatusTable</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2523"><span class='Ref_to_Parameter'>beid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_fetch_stat_numbackends() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  the maximum current backend id. 
 * ---------- 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2542"></a><span class='Declare_Function'>pgstat_fetch_stat_numbackends</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN299"><span class='Ref_to_Proto'>pgstat_read_current_status</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN249"><span class='Ref_to_Global_Var'>localNumBackends</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * --------- 
 * pgstat_fetch_stat_archiver() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  a pointer to the archiver statistics struct. 
 * --------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN664"><span class='Ref_to_Struct'>PgStat_ArchiverStats</span></a> <span class='Operator'>* 
</span><a name="LN2558"></a><span class='Declare_Function'>pgstat_fetch_stat_archiver</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN298"><span class='Ref_to_Proto'>backend_read_statsfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * --------- 
 * pgstat_fetch_global() - 
 * 
 *  Support function for the SQL-callable pgstat* functions. Returns 
 *  a pointer to the global statistics struct. 
 * --------- 
 */ 
</span><a href="../../include/pgstat.h.html#LN680"><span class='Ref_to_Struct'>PgStat_GlobalStats</span></a> <span class='Operator'>* 
</span><a name="LN2575"></a><span class='Declare_Function'>pgstat_fetch_global</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN298"><span class='Ref_to_Proto'>backend_read_statsfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ 
 * Functions for management of the shared-memory PgBackendStatus array 
 * ------------------------------------------------------------ 
 */ 
</span> 
<a name="LN2588"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Var'>BackendStatusArray</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2589"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Var'>MyBEEntry</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2590"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>BackendAppnameBuffer</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2591"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>BackendClientHostnameBuffer</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2592"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>BackendActivityBuffer</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2593"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Var'>BackendActivityBufferSize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
<a name="LN2595"></a><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a> <span class='Operator'>*</span><span class='Declare_Var'>BackendSslStatusBuffer</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Report shared-memory space needed by CreateSharedBackendStatus. 
 */ 
</span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN2603"></a><span class='Declare_Function'>BackendStatusShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2605"></a>    <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* BackendStatusArray: */ 
</span>    <a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* BackendAppnameBuffer: */ 
</span>    <a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* BackendClientHostnameBuffer: */ 
</span>    <a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* BackendActivityBuffer: */ 
</span>    <a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>            <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Comment_Multi_Line'>/* BackendSslStatusBuffer: */ 
</span>    <a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                  <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN2605"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BackendStatusShmemSize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize the shared status array and several string buffers 
 * during postmaster startup. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2631"></a><span class='Declare_Function'>CreateSharedBackendStatus</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2633"></a>    <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN2634"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN2635"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2636"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create or attach to the shared array */ 
</span>    <a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Backend Status Array"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We're the first - initialize. 
         */ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Create or attach to the shared appname buffer */ 
</span>    <a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2590"><span class='Ref_to_Global_Var'>BackendAppnameBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Backend Application Name Buffer"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2590"><span class='Ref_to_Global_Var'>BackendAppnameBuffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize st_appname pointers. */ 
</span>        <a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2590"><span class='Ref_to_Global_Var'>BackendAppnameBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>+= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Create or attach to the shared client hostname buffer */ 
</span>    <a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2591"><span class='Ref_to_Global_Var'>BackendClientHostnameBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Backend Client Host Name Buffer"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2591"><span class='Ref_to_Global_Var'>BackendClientHostnameBuffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize st_clienthostname pointers. */ 
</span>        <a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2591"><span class='Ref_to_Global_Var'>BackendClientHostnameBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN989"><span class='Ref_to_Member'>st_clienthostname</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>+= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Create or attach to the shared activity buffer */ 
</span>    <a href="pgstat.c.html#LN2593"><span class='Ref_to_Global_Var'>BackendActivityBufferSize</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a><span class='Delimiter'>, 
</span>                                         <a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2592"><span class='Ref_to_Global_Var'>BackendActivityBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Backend Activity Buffer"</span><span class='Delimiter'>, 
</span>                        <a href="pgstat.c.html#LN2593"><span class='Ref_to_Global_Var'>BackendActivityBufferSize</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2592"><span class='Ref_to_Global_Var'>BackendActivityBuffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize st_activity pointers. */ 
</span>        <a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2592"><span class='Ref_to_Global_Var'>BackendActivityBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2636"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Comment_Multi_Line'>/* Create or attach to the shared SSL status buffer */ 
</span>    <a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2595"><span class='Ref_to_Global_Var'>BackendSslStatusBuffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Backend SSL Status Buffer"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2634"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2716"></a>        <a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2595"><span class='Ref_to_Global_Var'>BackendSslStatusBuffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2633"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize st_sslstatus pointers. */ 
</span>        <a href="pgstat.c.html#LN2716"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2595"><span class='Ref_to_Global_Var'>BackendSslStatusBuffer</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2716"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2716"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CreateSharedBackendStatus &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_initialize() - 
 * 
 *  Initialize pgstats state, and set up our on-proc-exit hook. 
 *  Called from InitPostgres and AuxiliaryProcessMain. For auxiliary process, 
 *  MyBackendId is invalid. Otherwise, MyBackendId must be set, 
 *  but we must not have started any transaction yet (since the 
 *  exit hook must run after the last transaction exit). 
 *  NOTE: MyDatabaseId isn't set yet; so the shutdown hook has to be careful. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2744"></a><span class='Declare_Function'>pgstat_initialize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Initialize MyBEEntry */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>!= </span><a href="../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>&LT;= </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a> <span class='Operator'>= &</span><a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>[</span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Must be an auxiliary process */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../bootstrap/bootstrap.c.html#LN67"><span class='Ref_to_Global_Var'>MyAuxProcType</span></a> <span class='Operator'>!= </span><a href="../../include/miscadmin.h.html#LN392"><span class='Ref_to_EnumConst'>NotAnAuxProcess</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Assign the MyBEEntry for an auxiliary process.  Since it doesn't 
         * have a BackendId, the slot is statically allocated based on the 
         * auxiliary process type (MyAuxProcType).  Backends use slots indexed 
         * in the range from 1 to MaxBackends (inclusive), so we use 
         * MaxBackends + AuxBackendType + 1 as the index of the slot for an 
         * auxiliary process. 
         */ 
</span>        <a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a> <span class='Operator'>= &</span><a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>[</span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>+ </span><a href="../bootstrap/bootstrap.c.html#LN67"><span class='Ref_to_Global_Var'>MyAuxProcType</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Set up a process-exit hook to clean up */ 
</span>    <a href="../../include/storage/ipc.h.html#LN69"><span class='Ref_to_Proto'>on_shmem_exit</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN288"><span class='Ref_to_Proto'>pgstat_beshutdown_hook</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_initialize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_bestart() - 
 * 
 *  Initialize this backend's entry in the PgBackendStatus array. 
 *  Called from InitPostgres. 
 * 
 *  Apart from auxiliary processes, MyBackendId, MyDatabaseId, 
 *  session userid, and application_name must be set for a 
 *  backend (hence, this cannot be combined with pgstat_initialize). 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2784"></a><span class='Declare_Function'>pgstat_bestart</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2786"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>proc_start_timestamp</span><span class='Delimiter'>; 
</span><a name="LN2787"></a>    <a href="../../include/libpq/pqcomm.h.html#LN61"><span class='Ref_to_Typedef'>SockAddr</span></a>    <span class='Declare_Local'>clientaddr</span><span class='Delimiter'>; 
</span><a name="LN2788"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To minimize the time spent modifying the PgBackendStatus entry, fetch 
     * all the needed data first. 
     * 
     * If we have a MyProcPort, use its session start time (for consistency, 
     * and to save a kernel call). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN2786"><span class='Ref_To_Local'>proc_start_timestamp</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN150"><span class='Ref_to_Member'>SessionStartTime</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pgstat.c.html#LN2786"><span class='Ref_To_Local'>proc_start_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We may not have a MyProcPort (eg, if this is the autovacuum process). 
     * If so, use all-zeroes client address, which is dealt with specially in 
     * pg_stat_get_backend_client_addr and pg_stat_get_backend_client_port. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN2787"><span class='Ref_To_Local'>clientaddr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2787"><span class='Ref_To_Local'>clientaddr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN2787"><span class='Ref_To_Local'>clientaddr</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2787"><span class='Ref_To_Local'>clientaddr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize my status entry, following the protocol of bumping 
     * st_changecount before and after; and make sure it's even afterwards. We 
     * use a volatile pointer here to ensure the compiler doesn't try to get 
     * cute. 
     */ 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pgstats state must be initialized from pgstat_initialize() */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a> <span class='Operator'>!= </span><a href="../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN49"><span class='Ref_to_Proto'>IsAutoVacuumLauncherProcess</span></a><span class='Parentheses'>())</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Autovacuum Launcher */ 
</span>            <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN703"><span class='Ref_to_EnumConst'>B_AUTOVAC_LAUNCHER</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>())</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Autovacuum Worker */ 
</span>            <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN704"><span class='Ref_to_EnumConst'>B_AUTOVAC_WORKER</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Wal sender */ 
</span>            <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN711"><span class='Ref_to_EnumConst'>B_WAL_SENDER</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN102"><span class='Ref_to_Global_Var'>IsBackgroundWorker</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* bgworker */ 
</span>            <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN706"><span class='Ref_to_EnumConst'>B_BG_WORKER</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* client-backend */ 
</span>            <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN705"><span class='Ref_to_EnumConst'>B_BACKEND</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if MyBackendId!=InvalidB... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Must be an auxiliary process */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../bootstrap/bootstrap.c.html#LN67"><span class='Ref_to_Global_Var'>MyAuxProcType</span></a> <span class='Operator'>!= </span><a href="../../include/miscadmin.h.html#LN392"><span class='Ref_to_EnumConst'>NotAnAuxProcess</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../bootstrap/bootstrap.c.html#LN67"><span class='Ref_to_Global_Var'>MyAuxProcType</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN395"><span class='Ref_to_EnumConst'>StartupProcess</span></a><span class='Operator'>: 
</span>                <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN709"><span class='Ref_to_EnumConst'>B_STARTUP</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN396"><span class='Ref_to_EnumConst'>BgWriterProcess</span></a><span class='Operator'>: 
</span>                <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN707"><span class='Ref_to_EnumConst'>B_BG_WRITER</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN397"><span class='Ref_to_EnumConst'>CheckpointerProcess</span></a><span class='Operator'>: 
</span>                <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN708"><span class='Ref_to_EnumConst'>B_CHECKPOINTER</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN398"><span class='Ref_to_EnumConst'>WalWriterProcess</span></a><span class='Operator'>: 
</span>                <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN712"><span class='Ref_to_EnumConst'>B_WAL_WRITER</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN399"><span class='Ref_to_EnumConst'>WalReceiverProcess</span></a><span class='Operator'>: 
</span>                <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN710"><span class='Ref_to_EnumConst'>B_WAL_RECEIVER</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized process type: %d"</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../bootstrap/bootstrap.c.html#LN67"><span class='Ref_to_Global_Var'>MyAuxProcType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch MyAuxProcType &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN971"><span class='Ref_to_Member'>st_changecount</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN980"><span class='Ref_to_Member'>st_proc_start_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2786"><span class='Ref_To_Local'>proc_start_timestamp</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN982"><span class='Ref_to_Member'>st_activity_start_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN983"><span class='Ref_to_Member'>st_state_start_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN981"><span class='Ref_to_Member'>st_xact_start_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN986"><span class='Ref_to_Member'>st_databaseid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We have userid for client-backends, wal-sender and bgworker processes */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN705"><span class='Ref_to_EnumConst'>B_BACKEND</span></a> 
        <span class='Operator'>|| </span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN711"><span class='Ref_to_EnumConst'>B_WAL_SENDER</span></a> 
        <span class='Operator'>|| </span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN977"><span class='Ref_to_Member'>st_backendType</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN706"><span class='Ref_to_EnumConst'>B_BG_WORKER</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN987"><span class='Ref_to_Member'>st_userid</span></a> <span class='Operator'>= </span><a href="../../include/miscadmin.h.html#LN310"><span class='Ref_to_Proto'>GetSessionUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN987"><span class='Ref_to_Member'>st_userid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN988"><span class='Ref_to_Member'>st_clientaddr</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2787"><span class='Ref_To_Local'>clientaddr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a> <span class='Operator'>&& </span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a><span class='Parentheses'>) 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN989"><span class='Ref_to_Member'>st_clienthostname</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a><span class='Delimiter'>, 
</span>                <a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN989"><span class='Ref_to_Member'>st_clienthostname</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a> <span class='Operator'>&& </span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN189"><span class='Ref_to_Member'>ssl</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN992"><span class='Ref_to_Member'>st_ssl</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN934"><span class='Ref_to_Member'>ssl_bits</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq-be.h.html#LN206"><span class='Ref_to_Proto'>be_tls_get_cipher_bits</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN935"><span class='Ref_to_Member'>ssl_compression</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq-be.h.html#LN207"><span class='Ref_to_Proto'>be_tls_get_compression</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/libpq/libpq-be.h.html#LN208"><span class='Ref_to_Proto'>be_tls_get_version</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN936"><span class='Ref_to_Member'>ssl_version</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/libpq/libpq-be.h.html#LN209"><span class='Ref_to_Proto'>be_tls_get_cipher</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN937"><span class='Ref_to_Member'>ssl_cipher</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/libpq/libpq-be.h.html#LN210"><span class='Ref_to_Proto'>be_tls_get_peerdn_name</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN938"><span class='Ref_to_Member'>ssl_clientdn</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN992"><span class='Ref_to_Member'>st_ssl</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN992"><span class='Ref_to_Member'>st_ssl</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN996"><span class='Ref_to_Member'>st_state</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN722"><span class='Ref_to_EnumConst'>STATE_UNDEFINED</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Also make sure the last byte in each string area is always 0 */ 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN989"><span class='Ref_to_Member'>st_clienthostname</span></a><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1013"><span class='Ref_to_Member'>st_progress_command</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN913"><span class='Ref_to_EnumConst'>PROGRESS_COMMAND_INVALID</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1014"><span class='Ref_to_Member'>st_progress_command_target</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * we don't zero st_progress_param here to save cycles; nobody should 
     * examine it until st_progress_command has been set to something other 
     * than PROGRESS_COMMAND_INVALID 
     */ 
</span> 
    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2788"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update app name to current GUC setting */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN468"><span class='Ref_to_Global_Var'>application_name</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/pgstat.h.html#LN1170"><span class='Ref_to_Proto'>pgstat_report_appname</span></a><span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN468"><span class='Ref_to_Global_Var'>application_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_bestart &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Shut down a single backend's statistics reporting at process exit. 
 * 
 * Flush any remaining statistics counts out to the collector. 
 * Without this, operations triggered during backend exit (such as 
 * temp table deletions) won't be counted. 
 * 
 * Lastly, clear out our entry in the PgBackendStatus array. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2955"></a><span class='Declare_Function'>pgstat_beshutdown_hook</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2957"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we got as far as discovering our own database ID, we can report what 
     * we did to the collector.  Otherwise, we'd be sending an invalid 
     * database ID, so forget it.  (This means that accesses to pg_database 
     * during failed backend starts might never get counted.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>))</span> 
        <a href="pgstat.c.html#LN810"><span class='Ref_to_Func'>pgstat_report_stat</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear my status entry, following the protocol of bumping st_changecount 
     * before and after.  We use a volatile pointer here to ensure the 
     * compiler doesn't try to get cute. 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2957"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN2957"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* mark invalid */ 
</span> 
    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2957"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_beshutdown_hook &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_report_activity() - 
 * 
 *  Called from tcop/postgres.c to report what the backend is actually doing 
 *  (but note cmd_str can be NULL for certain cases). 
 * 
 * All updates of the status entry follow the protocol of bumping 
 * st_changecount before and after.  We use a volatile pointer here to 
 * ensure the compiler doesn't try to get cute. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2993"></a><span class='Declare_Function'>pgstat_report_activity</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN720"><span class='Ref_to_Enum'>BackendState</span></a> <span class='Declare_Parameter'>state</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>cmd_str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2995"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span><a name="LN2996"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>start_timestamp</span><span class='Delimiter'>; 
</span><a name="LN2997"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>current_timestamp</span><span class='Delimiter'>; 
</span><a name="LN2998"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_STATEMENT_STATUS<span class='Parentheses'>(</span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>cmd_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN124"><span class='Ref_to_Global_Var'>pgstat_track_activities</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN996"><span class='Ref_to_Member'>st_state</span></a> <span class='Operator'>!= </span><a href="../../include/pgstat.h.html#LN728"><span class='Ref_to_EnumConst'>STATE_DISABLED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3009"></a>            <span class='Keyword'>volatile </span><a href="../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * track_activities is disabled, but we last reported a 
             * non-disabled state.  As our final update, change the state and 
             * clear fields we will not be updating anymore. 
             */ 
</span>            <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN996"><span class='Ref_to_Member'>st_state</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN728"><span class='Ref_to_EnumConst'>STATE_DISABLED</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN983"><span class='Ref_to_Member'>st_state_start_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN982"><span class='Ref_to_Member'>st_activity_start_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* st_xact_start_timestamp and wait_event_info are also disabled */ 
</span>            <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN981"><span class='Ref_to_Member'>st_xact_start_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN3009"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/proc.h.html#LN171"><span class='Ref_to_Member'>wait_event_info</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !pgstat_track_activit... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * To minimize the time spent modifying the entry, fetch all the needed 
     * data first. 
     */ 
</span>    <a href="pgstat.c.html#LN2996"><span class='Ref_To_Local'>start_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/access/xact.h.html#LN341"><span class='Ref_to_Proto'>GetCurrentStatementStartTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>cmd_str</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN2998"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN530"><span class='Ref_to_Proto'>pg_mbcliplen</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>cmd_str</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>cmd_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pgstat.c.html#LN2997"><span class='Ref_To_Local'>current_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now update the status entry 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN996"><span class='Ref_to_Member'>st_state</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN983"><span class='Ref_to_Member'>st_state_start_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2997"><span class='Ref_To_Local'>current_timestamp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>cmd_str</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2993"><span class='Ref_to_Parameter'>cmd_str</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN2998"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN2998"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN982"><span class='Ref_to_Member'>st_activity_start_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2996"><span class='Ref_To_Local'>start_timestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN2995"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_report_activity &raquo; </span> 
 
<span class='Comment_Multi_Line'>/*----------- 
 * pgstat_progress_start_command() - 
 * 
 * Set st_progress_command (and st_progress_command_target) in own backend 
 * entry.  Also, zero-initialize st_progress_param array. 
 *----------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3067"></a><span class='Declare_Function'>pgstat_progress_start_command</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN911"><span class='Ref_to_Enum'>ProgressCommandType</span></a> <span class='Declare_Parameter'>cmdtype</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3069"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN124"><span class='Ref_to_Global_Var'>pgstat_track_activities</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1013"><span class='Ref_to_Member'>st_progress_command</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3067"><span class='Ref_to_Parameter'>cmdtype</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1014"><span class='Ref_to_Member'>st_progress_command_target</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3067"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1015"><span class='Ref_to_Member'>st_progress_param</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1015"><span class='Ref_to_Member'>st_progress_param</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3069"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/*----------- 
 * pgstat_progress_update_param() - 
 * 
 * Update index'th member in st_progress_param[] of own backend entry. 
 *----------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3088"></a><span class='Declare_Function'>pgstat_progress_update_param</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Parameter'>val</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3090"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3088"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pgstat.c.html#LN3088"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>&LT; </span><a href="../../include/pgstat.h.html#LN917"><span class='Ref_to_Const'>PGSTAT_NUM_PROGRESS_PARAM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN3090"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN124"><span class='Ref_to_Global_Var'>pgstat_track_activities</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3090"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3090"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1015"><span class='Ref_to_Member'>st_progress_param</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3088"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pgstat.c.html#LN3088"><span class='Ref_to_Parameter'>val</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3090"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/*----------- 
 * pgstat_progress_update_multi_param() - 
 * 
 * Update multiple members in st_progress_param[] of own backend entry. 
 * This is atomic; readers won't see intermediate states. 
 *----------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3110"></a><span class='Declare_Function'>pgstat_progress_update_multi_param</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>nparam</span><span class='Delimiter'>, </span><span class='Keyword'>const int </span><span class='Operator'>*</span><span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN3111"></a>                                   <span class='Keyword'>const </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>val</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3113"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span><a name="LN3114"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN3113"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN124"><span class='Ref_to_Global_Var'>pgstat_track_activities</span></a> <span class='Operator'>|| </span><a href="pgstat.c.html#LN3110"><span class='Ref_to_Parameter'>nparam</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3113"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN3110"><span class='Ref_to_Parameter'>nparam</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3110"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pgstat.c.html#LN3110"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><a href="../../include/pgstat.h.html#LN917"><span class='Ref_to_Const'>PGSTAT_NUM_PROGRESS_PARAM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN3113"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1015"><span class='Ref_to_Member'>st_progress_param</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3110"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]] </span><span class='Operator'>= </span><a href="pgstat.c.html#LN3111"><span class='Ref_to_Parameter'>val</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3114"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3113"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_progress_update_multi_param &raquo; </span> 
 
<span class='Comment_Multi_Line'>/*----------- 
 * pgstat_progress_end_command() - 
 * 
 * Reset st_progress_command (and st_progress_command_target) in own backend 
 * entry.  This signals the end of the command. 
 *----------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3139"></a><span class='Declare_Function'>pgstat_progress_end_command</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3141"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN3141"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN124"><span class='Ref_to_Global_Var'>pgstat_track_activities</span></a> 
        <span class='Operator'>&& </span><a href="pgstat.c.html#LN3141"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1013"><span class='Ref_to_Member'>st_progress_command</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN913"><span class='Ref_to_EnumConst'>PROGRESS_COMMAND_INVALID</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3141"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3141"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1013"><span class='Ref_to_Member'>st_progress_command</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN913"><span class='Ref_to_EnumConst'>PROGRESS_COMMAND_INVALID</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3141"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1014"><span class='Ref_to_Member'>st_progress_command_target</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3141"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_report_appname() - 
 * 
 *  Called to update our application name. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3162"></a><span class='Declare_Function'>pgstat_report_appname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>appname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3164"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span><a name="LN3165"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN3164"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This should be unnecessary if GUC did its job, but be safe */ 
</span>    <a href="pgstat.c.html#LN3165"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/mb/pg_wchar.h.html#LN530"><span class='Ref_to_Proto'>pg_mbcliplen</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3162"><span class='Ref_to_Parameter'>appname</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="pgstat.c.html#LN3162"><span class='Ref_to_Parameter'>appname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update my status entry, following the protocol of bumping 
     * st_changecount before and after.  We use a volatile pointer here to 
     * ensure the compiler doesn't try to get cute. 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3164"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3164"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3162"><span class='Ref_to_Parameter'>appname</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3165"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3164"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN3165"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3164"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_report_appname &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Report current transaction start timestamp as the specified value. 
 * Zero means there is no active transaction. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3191"></a><span class='Declare_Function'>pgstat_report_xact_timestamp</span><span class='Parentheses'>(</span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>tstamp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3193"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN2589"><span class='Ref_to_Global_Var'>MyBEEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN124"><span class='Ref_to_Global_Var'>pgstat_track_activities</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN3193"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update my status entry, following the protocol of bumping 
     * st_changecount before and after.  We use a volatile pointer here to 
     * ensure the compiler doesn't try to get cute. 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN1030"><span class='Ref_to_Macro'>pgstat_increment_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3193"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3193"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN981"><span class='Ref_to_Member'>st_xact_start_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3191"><span class='Ref_to_Parameter'>tstamp</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1036"><span class='Ref_to_Macro'>pgstat_increment_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3193"><span class='Ref_To_Local'>beentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_read_current_status() - 
 * 
 *  Copy the current contents of the PgBackendStatus array to local memory, 
 *  if not already done in this transaction. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3216"></a><span class='Declare_Function'>pgstat_read_current_status</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3218"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span><span class='Delimiter'>; 
</span><a name="LN3219"></a>    <a href="../../include/pgstat.h.html#LN1063"><span class='Ref_to_Struct'>LocalPgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>localtable</span><span class='Delimiter'>; 
</span><a name="LN3220"></a>    <a href="../../include/pgstat.h.html#LN1063"><span class='Ref_to_Struct'>LocalPgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>localentry</span><span class='Delimiter'>; 
</span><a name="LN3221"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>localappname</span><span class='Delimiter'>, 
</span><a name="LN3222"></a>               <span class='Operator'>*</span><span class='Declare_Local'>localactivity</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
<a name="LN3224"></a>    <a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>localsslstatus</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN3226"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN246"><span class='Ref_to_Global_Var'>localBackendStatusTable</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* already done */ 
</span> 
    <a href="pgstat.c.html#LN310"><span class='Ref_to_Proto'>pgstat_setup_memcxt</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN3219"><span class='Ref_To_Local'>localtable</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN1063"><span class='Ref_to_Struct'>LocalPgBackendStatus</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN1063"><span class='Ref_to_Struct'>LocalPgBackendStatus</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3221"><span class='Ref_To_Local'>localappname</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>, 
</span>                           <a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>* </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3222"><span class='Ref_To_Local'>localactivity</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>, 
</span>                     <a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a> <span class='Operator'>* </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <a href="pgstat.c.html#LN3224"><span class='Ref_To_Local'>localsslstatus</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="pgstat.c.html#LN249"><span class='Ref_to_Global_Var'>localNumBackends</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3219"><span class='Ref_To_Local'>localtable</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3226"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3226"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="pgstat.c.html#LN117"><span class='Ref_to_Const'>NumBackendStatSlots</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3226"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Follow the protocol of retrying if st_changecount changes while we 
         * copy the entry, or if it's odd.  (The check for odd is needed to 
         * cover the case where we are able to completely copy the entry while 
         * the source backend is between increment steps.)  We use a volatile 
         * pointer here to ensure the compiler doesn't try to get cute. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3264"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>before_changecount</span><span class='Delimiter'>; 
</span><a name="LN3265"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>after_changecount</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/pgstat.h.html#LN1043"><span class='Ref_to_Macro'>pgstat_save_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3264"><span class='Ref_To_Local'>before_changecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * strcpy is safe even if the string is modified concurrently, 
                 * because there's always a \0 at the end of the buffer. 
                 */ 
</span>                <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3221"><span class='Ref_To_Local'>localappname</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN999"><span class='Ref_to_Member'>st_appname</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3221"><span class='Ref_To_Local'>localappname</span></a><span class='Delimiter'>; 
</span>                <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3222"><span class='Ref_To_Local'>localactivity</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3222"><span class='Ref_To_Local'>localactivity</span></a><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN992"><span class='Ref_to_Member'>st_ssl</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN992"><span class='Ref_to_Member'>st_ssl</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN992"><span class='Ref_to_Member'>st_ssl</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    memcpy<span class='Parentheses'>(</span><a href="pgstat.c.html#LN3224"><span class='Ref_To_Local'>localsslstatus</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN931"><span class='Ref_to_Struct'>PgBackendSSLStatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN993"><span class='Ref_to_Member'>st_sslstatus</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3224"><span class='Ref_To_Local'>localsslstatus</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if localentry-&GT;backendSt... &raquo; </span> 
 
            <a href="../../include/pgstat.h.html#LN1049"><span class='Ref_to_Macro'>pgstat_save_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3265"><span class='Ref_To_Local'>after_changecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3264"><span class='Ref_To_Local'>before_changecount</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN3265"><span class='Ref_To_Local'>after_changecount</span></a> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3264"><span class='Ref_To_Local'>before_changecount</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Make sure we can break out of loop if stuck... */ 
</span>            <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
        <a href="pgstat.c.html#LN3218"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Only valid entries get included into the local array */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1068"><span class='Ref_to_Member'>backendStatus</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/sinvaladt.h.html#LN34"><span class='Ref_to_Proto'>BackendIdGetTransactionIds</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3226"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1074"><span class='Ref_to_Member'>backend_xid</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1080"><span class='Ref_to_Member'>backend_xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN3220"><span class='Ref_To_Local'>localentry</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN3221"><span class='Ref_To_Local'>localappname</span></a> <span class='Operator'>+= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN3222"><span class='Ref_To_Local'>localactivity</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
            <a href="pgstat.c.html#LN3224"><span class='Ref_To_Local'>localsslstatus</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <a href="pgstat.c.html#LN249"><span class='Ref_to_Global_Var'>localNumBackends</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;=NumBackendStat... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Set the pointer only after completion of a valid table */ 
</span>    <a href="pgstat.c.html#LN246"><span class='Ref_to_Global_Var'>localBackendStatusTable</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3219"><span class='Ref_To_Local'>localtable</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_read_current_status &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_event_type() - 
 * 
 *  Return a string representing the current wait event type, backend is 
 *  waiting on. 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN3330"></a><span class='Declare_Function'>pgstat_get_wait_event_type</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3332"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>classId</span><span class='Delimiter'>; 
</span><a name="LN3333"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_type</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* report process as not waiting. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3330"><span class='Ref_to_Parameter'>wait_event_info</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN3332"><span class='Ref_To_Local'>classId</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3330"><span class='Ref_to_Parameter'>wait_event_info</span></a> <span class='Operator'>& </span><span class='Number'>0xFF000000</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3332"><span class='Ref_To_Local'>classId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN736"><span class='Ref_to_Const'>PG_WAIT_LWLOCK</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"LWLock"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN737"><span class='Ref_to_Const'>PG_WAIT_LOCK</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"Lock"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN738"><span class='Ref_to_Const'>PG_WAIT_BUFFER_PIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"BufferPin"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN739"><span class='Ref_to_Const'>PG_WAIT_ACTIVITY</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"Activity"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN740"><span class='Ref_to_Const'>PG_WAIT_CLIENT</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"Client"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN741"><span class='Ref_to_Const'>PG_WAIT_EXTENSION</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"Extension"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN742"><span class='Ref_to_Const'>PG_WAIT_IPC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"IPC"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN743"><span class='Ref_to_Const'>PG_WAIT_TIMEOUT</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"Timeout"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN744"><span class='Ref_to_Const'>PG_WAIT_IO</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"IO"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a> <span class='Operator'>= </span><span class='String'>"???"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch classId &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3333"><span class='Ref_To_Local'>event_type</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_event_type &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_event() - 
 * 
 *  Return a string representing the current wait event, backend is 
 *  waiting on. 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN3385"></a><span class='Declare_Function'>pgstat_get_wait_event</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3387"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>classId</span><span class='Delimiter'>; 
</span><a name="LN3388"></a>    <a href="../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>eventId</span><span class='Delimiter'>; 
</span><a name="LN3389"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_name</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* report process as not waiting. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN3387"><span class='Ref_To_Local'>classId</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a> <span class='Operator'>& </span><span class='Number'>0xFF000000</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN3388"><span class='Ref_To_Local'>eventId</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a> <span class='Operator'>& </span><span class='Number'>0x0000FFFF</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3387"><span class='Ref_To_Local'>classId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN736"><span class='Ref_to_Const'>PG_WAIT_LWLOCK</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="../../include/storage/lwlock.h.html#LN161"><span class='Ref_to_Proto'>GetLWLockIdentifier</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3387"><span class='Ref_To_Local'>classId</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3388"><span class='Ref_To_Local'>eventId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN737"><span class='Ref_to_Const'>PG_WAIT_LOCK</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="../../include/storage/lmgr.h.html#LN106"><span class='Ref_to_Proto'>GetLockNameFromTagType</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3388"><span class='Ref_To_Local'>eventId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN738"><span class='Ref_to_Const'>PG_WAIT_BUFFER_PIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BufferPin"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN739"><span class='Ref_to_Const'>PG_WAIT_ACTIVITY</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3411"></a>                <a href="../../include/pgstat.h.html#LN754"><span class='Ref_to_Typedef'>WaitEventActivity</span></a> <span class='Declare_Local'>w</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN754"><span class='Ref_to_Typedef'>WaitEventActivity</span></a><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN312"><span class='Ref_to_Proto'>pgstat_get_wait_activity</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3411"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN740"><span class='Ref_to_Const'>PG_WAIT_CLIENT</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3418"></a>                <a href="../../include/pgstat.h.html#LN780"><span class='Ref_to_Typedef'>WaitEventClient</span></a> <span class='Declare_Local'>w</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN780"><span class='Ref_to_Typedef'>WaitEventClient</span></a><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN313"><span class='Ref_to_Proto'>pgstat_get_wait_client</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3418"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN741"><span class='Ref_to_Const'>PG_WAIT_EXTENSION</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"Extension"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN742"><span class='Ref_to_Const'>PG_WAIT_IPC</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3428"></a>                <a href="../../include/pgstat.h.html#LN798"><span class='Ref_to_Typedef'>WaitEventIPC</span></a> <span class='Declare_Local'>w</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN798"><span class='Ref_to_Typedef'>WaitEventIPC</span></a><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN314"><span class='Ref_to_Proto'>pgstat_get_wait_ipc</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3428"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN743"><span class='Ref_to_Const'>PG_WAIT_TIMEOUT</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3435"></a>                <a href="../../include/pgstat.h.html#LN823"><span class='Ref_to_Typedef'>WaitEventTimeout</span></a> <span class='Declare_Local'>w</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN823"><span class='Ref_to_Typedef'>WaitEventTimeout</span></a><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN315"><span class='Ref_to_Proto'>pgstat_get_wait_timeout</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3435"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN744"><span class='Ref_to_Const'>PG_WAIT_IO</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3442"></a>                <a href="../../include/pgstat.h.html#LN836"><span class='Ref_to_Typedef'>WaitEventIO</span></a> <span class='Declare_Local'>w</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN836"><span class='Ref_to_Typedef'>WaitEventIO</span></a><span class='Parentheses'>) </span><a href="pgstat.c.html#LN3385"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN316"><span class='Ref_to_Proto'>pgstat_get_wait_io</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3442"><span class='Ref_To_Local'>w</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"unknown wait event"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch classId &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3389"><span class='Ref_To_Local'>event_name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_event &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_activity() - 
 * 
 * Convert WaitEventActivity to string. 
 * ---------- 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN3462"></a><span class='Declare_Function'>pgstat_get_wait_activity</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN754"><span class='Ref_to_Typedef'>WaitEventActivity</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3464"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_name</span> <span class='Operator'>= </span><span class='String'>"unknown wait event"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3462"><span class='Ref_to_Parameter'>w</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN756"><span class='Ref_to_EnumConst'>WAIT_EVENT_ARCHIVER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ArchiverMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN757"><span class='Ref_to_EnumConst'>WAIT_EVENT_AUTOVACUUM_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"AutoVacuumMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN758"><span class='Ref_to_EnumConst'>WAIT_EVENT_BGWRITER_HIBERNATE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BgWriterHibernate"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN759"><span class='Ref_to_EnumConst'>WAIT_EVENT_BGWRITER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BgWriterMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN760"><span class='Ref_to_EnumConst'>WAIT_EVENT_CHECKPOINTER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"CheckpointerMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN761"><span class='Ref_to_EnumConst'>WAIT_EVENT_PGSTAT_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"PgStatMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN762"><span class='Ref_to_EnumConst'>WAIT_EVENT_RECOVERY_WAL_ALL</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"RecoveryWalAll"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN763"><span class='Ref_to_EnumConst'>WAIT_EVENT_RECOVERY_WAL_STREAM</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"RecoveryWalStream"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN764"><span class='Ref_to_EnumConst'>WAIT_EVENT_SYSLOGGER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SysLoggerMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN765"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_RECEIVER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WalReceiverMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN766"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_SENDER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WalSenderMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN767"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_WRITER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WalWriterMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN768"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_LAUNCHER_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalLauncherMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN769"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_APPLY_MAIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalApplyMain"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* no default case, so that compiler will warn */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch w &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3464"><span class='Ref_To_Local'>event_name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_activity &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_client() - 
 * 
 * Convert WaitEventClient to string. 
 * ---------- 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN3523"></a><span class='Declare_Function'>pgstat_get_wait_client</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN780"><span class='Ref_to_Typedef'>WaitEventClient</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3525"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_name</span> <span class='Operator'>= </span><span class='String'>"unknown wait event"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3523"><span class='Ref_to_Parameter'>w</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN782"><span class='Ref_to_EnumConst'>WAIT_EVENT_CLIENT_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ClientRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN783"><span class='Ref_to_EnumConst'>WAIT_EVENT_CLIENT_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ClientWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN784"><span class='Ref_to_EnumConst'>WAIT_EVENT_SSL_OPEN_SERVER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SSLOpenServer"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN785"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_RECEIVER_WAIT_START</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WalReceiverWaitStart"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN786"><span class='Ref_to_EnumConst'>WAIT_EVENT_LIBPQWALRECEIVER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LibPQWalReceiver"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN787"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_SENDER_WAIT_WAL</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WalSenderWaitForWAL"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN788"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_SENDER_WRITE_DATA</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WalSenderWriteData"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* no default case, so that compiler will warn */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch w &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3525"><span class='Ref_To_Local'>event_name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_client &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_ipc() - 
 * 
 * Convert WaitEventIPC to string. 
 * ---------- 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN3563"></a><span class='Declare_Function'>pgstat_get_wait_ipc</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN798"><span class='Ref_to_Typedef'>WaitEventIPC</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3565"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_name</span> <span class='Operator'>= </span><span class='String'>"unknown wait event"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3563"><span class='Ref_to_Parameter'>w</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN800"><span class='Ref_to_EnumConst'>WAIT_EVENT_BGWORKER_SHUTDOWN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BgWorkerShutdown"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN801"><span class='Ref_to_EnumConst'>WAIT_EVENT_BGWORKER_STARTUP</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BgWorkerStartup"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN802"><span class='Ref_to_EnumConst'>WAIT_EVENT_BTREE_PAGE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BtreePage"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN803"><span class='Ref_to_EnumConst'>WAIT_EVENT_EXECUTE_GATHER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ExecuteGather"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN804"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_INTERNAL</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"MessageQueueInternal"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN805"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_PUT_MESSAGE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"MessageQueuePutMessage"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN806"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_RECEIVE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"MessageQueueReceive"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN807"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_SEND</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"MessageQueueSend"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN808"><span class='Ref_to_EnumConst'>WAIT_EVENT_PARALLEL_FINISH</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ParallelFinish"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN809"><span class='Ref_to_EnumConst'>WAIT_EVENT_PARALLEL_BITMAP_SCAN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ParallelBitmapScan"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN810"><span class='Ref_to_EnumConst'>WAIT_EVENT_PROCARRAY_GROUP_UPDATE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ProcArrayGroupUpdate"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN811"><span class='Ref_to_EnumConst'>WAIT_EVENT_SAFE_SNAPSHOT</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SafeSnapshot"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN812"><span class='Ref_to_EnumConst'>WAIT_EVENT_SYNC_REP</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SyncRep"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN813"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_SYNC_DATA</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalSyncData"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN814"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_SYNC_STATE_CHANGE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalSyncStateChange"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* no default case, so that compiler will warn */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch w &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3565"><span class='Ref_To_Local'>event_name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_ipc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_timeout() - 
 * 
 * Convert WaitEventTimeout to string. 
 * ---------- 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN3627"></a><span class='Declare_Function'>pgstat_get_wait_timeout</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN823"><span class='Ref_to_Typedef'>WaitEventTimeout</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3629"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_name</span> <span class='Operator'>= </span><span class='String'>"unknown wait event"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3627"><span class='Ref_to_Parameter'>w</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN825"><span class='Ref_to_EnumConst'>WAIT_EVENT_BASE_BACKUP_THROTTLE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3629"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BaseBackupThrottle"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN826"><span class='Ref_to_EnumConst'>WAIT_EVENT_PG_SLEEP</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3629"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"PgSleep"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN827"><span class='Ref_to_EnumConst'>WAIT_EVENT_RECOVERY_APPLY_DELAY</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3629"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"RecoveryApplyDelay"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* no default case, so that compiler will warn */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3629"><span class='Ref_To_Local'>event_name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_timeout &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_wait_io() - 
 * 
 * Convert WaitEventIO to string. 
 * ---------- 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN3655"></a><span class='Declare_Function'>pgstat_get_wait_io</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN836"><span class='Ref_to_Typedef'>WaitEventIO</span></a> <span class='Declare_Parameter'>w</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3657"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>event_name</span> <span class='Operator'>= </span><span class='String'>"unknown wait event"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3655"><span class='Ref_to_Parameter'>w</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN838"><span class='Ref_to_EnumConst'>WAIT_EVENT_BUFFILE_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BufFileRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN839"><span class='Ref_to_EnumConst'>WAIT_EVENT_BUFFILE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"BufFileWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN840"><span class='Ref_to_EnumConst'>WAIT_EVENT_CONTROL_FILE_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ControlFileRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN841"><span class='Ref_to_EnumConst'>WAIT_EVENT_CONTROL_FILE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ControlFileSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN842"><span class='Ref_to_EnumConst'>WAIT_EVENT_CONTROL_FILE_SYNC_UPDATE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ControlFileSyncUpdate"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN843"><span class='Ref_to_EnumConst'>WAIT_EVENT_CONTROL_FILE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ControlFileWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN844"><span class='Ref_to_EnumConst'>WAIT_EVENT_CONTROL_FILE_WRITE_UPDATE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ControlFileWriteUpdate"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN845"><span class='Ref_to_EnumConst'>WAIT_EVENT_COPY_FILE_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"CopyFileRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN846"><span class='Ref_to_EnumConst'>WAIT_EVENT_COPY_FILE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"CopyFileWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN847"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_EXTEND</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileExtend"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN848"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_FLUSH</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileFlush"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN849"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_IMMEDIATE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileImmediateSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN850"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_PREFETCH</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFilePrefetch"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN851"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN852"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN853"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_TRUNCATE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileTruncate"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN854"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DataFileWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN855"><span class='Ref_to_EnumConst'>WAIT_EVENT_DSM_FILL_ZERO_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"DSMFillZeroWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN856"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_ADDTODATADIR_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileAddToDataDirRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN857"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_ADDTODATADIR_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileAddToDataDirSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN858"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_ADDTODATADIR_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileAddToDataDirWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN859"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_CREATE_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileCreateRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN860"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_CREATE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileCreateSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN861"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_CREATE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileCreateWRITE"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN862"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_RECHECKDATADIR_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LockFileReCheckDataDirRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN863"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_REWRITE_CHECKPOINT_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalRewriteCheckpointSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN864"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_REWRITE_MAPPING_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalRewriteMappingSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN865"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_REWRITE_MAPPING_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalRewriteMappingWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN866"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_REWRITE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalRewriteSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN867"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_REWRITE_TRUNCATE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalRewriteTruncate"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN868"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_REWRITE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"LogicalRewriteWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN869"><span class='Ref_to_EnumConst'>WAIT_EVENT_RELATION_MAP_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"RelationMapRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN870"><span class='Ref_to_EnumConst'>WAIT_EVENT_RELATION_MAP_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"RelationMapSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN871"><span class='Ref_to_EnumConst'>WAIT_EVENT_RELATION_MAP_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"RelationMapWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN872"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_BUFFER_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReorderBufferRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN873"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_BUFFER_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReorderBufferWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN874"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_LOGICAL_MAPPING_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReorderLogicalMappingRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN875"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReplicationSlotRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN876"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_RESTORE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReplicationSlotRestoreSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN877"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReplicationSlotSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN878"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"ReplicationSlotWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN879"><span class='Ref_to_EnumConst'>WAIT_EVENT_SLRU_FLUSH_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SLRUFlushSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN880"><span class='Ref_to_EnumConst'>WAIT_EVENT_SLRU_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SLRURead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN881"><span class='Ref_to_EnumConst'>WAIT_EVENT_SLRU_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SLRUSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN882"><span class='Ref_to_EnumConst'>WAIT_EVENT_SLRU_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SLRUWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN883"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SnapbuildRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN884"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SnapbuildSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN885"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"SnapbuildWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN886"><span class='Ref_to_EnumConst'>WAIT_EVENT_TIMELINE_HISTORY_FILE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TimelineHistoryFileSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN887"><span class='Ref_to_EnumConst'>WAIT_EVENT_TIMELINE_HISTORY_FILE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TimelineHistoryFileWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN888"><span class='Ref_to_EnumConst'>WAIT_EVENT_TIMELINE_HISTORY_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TimelineHistoryRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN889"><span class='Ref_to_EnumConst'>WAIT_EVENT_TIMELINE_HISTORY_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TimelineHistorySync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN890"><span class='Ref_to_EnumConst'>WAIT_EVENT_TIMELINE_HISTORY_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TimelineHistoryWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN891"><span class='Ref_to_EnumConst'>WAIT_EVENT_TWOPHASE_FILE_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TwophaseFileRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN892"><span class='Ref_to_EnumConst'>WAIT_EVENT_TWOPHASE_FILE_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TwophaseFileSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN893"><span class='Ref_to_EnumConst'>WAIT_EVENT_TWOPHASE_FILE_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"TwophaseFileWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN894"><span class='Ref_to_EnumConst'>WAIT_EVENT_WALSENDER_TIMELINE_HISTORY_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALSenderTimelineHistoryRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN895"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_BOOTSTRAP_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALBootstrapSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN896"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_BOOTSTRAP_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALBootstrapWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN897"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_COPY_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALCopyRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN898"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_COPY_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALCopySync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN899"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_COPY_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALCopyWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN900"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_INIT_SYNC</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALInitSync"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN901"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_INIT_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALInitWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN902"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_READ</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALRead"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN903"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_SYNC_METHOD_ASSIGN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALSyncMethodAssign"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN904"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_WRITE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a> <span class='Operator'>= </span><span class='String'>"WALWrite"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* no default case, so that compiler will warn */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch w &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN3657"><span class='Ref_To_Local'>event_name</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_wait_io &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_backend_current_activity() - 
 * 
 *  Return a string representing the current activity of the backend with 
 *  the specified PID.  This looks directly at the BackendStatusArray, 
 *  and so will provide current information regardless of the age of our 
 *  transaction's snapshot of the status array. 
 * 
 *  It is the caller's responsibility to invoke this only for backends whose 
 *  state is expected to remain stable while the result is in use.  The 
 *  only current use is in deadlock reporting, where we can expect that 
 *  the target backend is blocked on a lock.  (There are corner cases 
 *  where the target's wait could get aborted while we are looking at it, 
 *  but the very worst consequence is to return a pointer to a string 
 *  that's been changed, so we won't worry too much.) 
 * 
 *  Note: return strings for special cases match pg_stat_get_backend_activity. 
 * ---------- 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN3890"></a><span class='Declare_Function'>pgstat_get_backend_current_activity</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>checkUser</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3892"></a>    <a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span><span class='Delimiter'>; 
</span><a name="LN3893"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN3892"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3893"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3893"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3893"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Although we expect the target backend's entry to be stable, that 
         * doesn't imply that anyone else's is.  To avoid identifying the 
         * wrong backend, while we check for a match to the desired PID we 
         * must follow the protocol of retrying if st_changecount changes 
         * while we examine the entry, or if it's odd.  (This might be 
         * unnecessary, since fetching or storing an int is almost certainly 
         * atomic, but let's play it safe.)  We use a volatile pointer here to 
         * ensure the compiler doesn't try to get cute. 
         */ 
</span><a name="LN3908"></a>        <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vbeentry</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN3892"><span class='Ref_To_Local'>beentry</span></a><span class='Delimiter'>; 
</span><a name="LN3909"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3913"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>before_changecount</span><span class='Delimiter'>; 
</span><a name="LN3914"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>after_changecount</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/pgstat.h.html#LN1043"><span class='Ref_to_Macro'>pgstat_save_changecount_before</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3908"><span class='Ref_To_Local'>vbeentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3913"><span class='Ref_To_Local'>before_changecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN3909"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3908"><span class='Ref_To_Local'>vbeentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN3890"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/pgstat.h.html#LN1049"><span class='Ref_to_Macro'>pgstat_save_changecount_after</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3908"><span class='Ref_To_Local'>vbeentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3914"><span class='Ref_To_Local'>after_changecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3913"><span class='Ref_To_Local'>before_changecount</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN3914"><span class='Ref_To_Local'>after_changecount</span></a> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3913"><span class='Ref_To_Local'>before_changecount</span></a> <span class='Operator'>& </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Make sure we can break out of loop if stuck... */ 
</span>            <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3909"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Now it is safe to use the non-volatile pointer */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3890"><span class='Ref_to_Parameter'>checkUser</span></a> <span class='Operator'>&& !</span><a href="../utils/misc/superuser.c.html#LN45"><span class='Ref_to_Func'>superuser</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="pgstat.c.html#LN3892"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN987"><span class='Ref_to_Member'>st_userid</span></a> <span class='Operator'>!= </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>())</span> 
                <span class='Control'>return</span> <span class='String'>"&LT;insufficient privilege&GT;"</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3892"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='String'>"&LT;command string not enabled&GT;"</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <span class='Control'>return</span> <a href="pgstat.c.html#LN3892"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pgstat.c.html#LN3892"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;=MaxBackends;i+... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* If we get here, caller is in error ... */ 
</span>    <span class='Control'>return</span> <span class='String'>"&LT;backend information not available&GT;"</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_backend_current_activity &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_get_crashed_backend_activity() - 
 * 
 *  Return a string representing the current activity of the backend with 
 *  the specified PID.  Like the function above, but reads shared memory with 
 *  the expectation that it may be corrupt.  On success, copy the string 
 *  into the "buffer" argument and return that pointer.  On failure, 
 *  return NULL. 
 * 
 *  This function is only intended to be used by the postmaster to report the 
 *  query that crashed a backend.  In particular, no attempt is made to 
 *  follow the correct concurrency protocol when accessing the 
 *  BackendStatusArray.  But that's OK, in the worst case we'll return a 
 *  corrupted message.  We also must take care not to trip on ereport(ERROR). 
 * ---------- 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN3965"></a><span class='Declare_Function'>pgstat_get_crashed_backend_activity</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>buflen</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3967"></a>    <span class='Keyword'>volatile </span><a href="../../include/pgstat.h.html#LN954"><span class='Ref_to_Struct'>PgBackendStatus</span></a> <span class='Operator'>*</span><span class='Declare_Local'>beentry</span><span class='Delimiter'>; 
</span><a name="LN3968"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN3967"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2588"><span class='Ref_to_Global_Var'>BackendStatusArray</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We probably shouldn't get here before shared memory has been set up, 
     * but be safe. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3967"><span class='Ref_To_Local'>beentry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="pgstat.c.html#LN2592"><span class='Ref_to_Global_Var'>BackendActivityBuffer</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3968"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3968"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN3968"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3967"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN974"><span class='Ref_to_Member'>st_procpid</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN3965"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Read pointer just once, so it can't change after validation */ 
</span><a name="LN3984"></a>            <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>activity</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN3967"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN1002"><span class='Ref_to_Member'>st_activity</span></a><span class='Delimiter'>; 
</span><a name="LN3985"></a>            <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>activity_last</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We mustn't access activity string before we verify that it 
             * falls within the BackendActivityBuffer. To make sure that the 
             * entire string including its ending is contained within the 
             * buffer, subtract one activity length from the buffer size. 
             */ 
</span>            <a href="pgstat.c.html#LN3985"><span class='Ref_To_Local'>activity_last</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN2592"><span class='Ref_to_Global_Var'>BackendActivityBuffer</span></a> <span class='Operator'>+ </span><a href="pgstat.c.html#LN2593"><span class='Ref_to_Global_Var'>BackendActivityBufferSize</span></a> 
                <span class='Operator'>- </span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3984"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN2592"><span class='Ref_to_Global_Var'>BackendActivityBuffer</span></a> <span class='Operator'>|| 
</span>                <a href="pgstat.c.html#LN3984"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>&GT; </span><a href="pgstat.c.html#LN3985"><span class='Ref_To_Local'>activity_last</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If no string available, no point in a report */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN3984"><span class='Ref_To_Local'>activity</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Copy only ASCII-safe characters so we don't run into encoding 
             * problems when reporting the message; and be sure not to run off 
             * the end of memory. 
             */ 
</span>            <a href="../../include/utils/ascii.h.html#LN13"><span class='Ref_to_Proto'>ascii_safe_strlcpy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3965"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN3984"><span class='Ref_To_Local'>activity</span></a><span class='Delimiter'>, 
</span>                               <a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN3965"><span class='Ref_to_Parameter'>buflen</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN127"><span class='Ref_to_Global_Var'>pgstat_track_activity_query_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="pgstat.c.html#LN3965"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if beentry-&GT;st_procpid==... &raquo; </span> 
 
        <a href="pgstat.c.html#LN3967"><span class='Ref_To_Local'>beentry</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;=MaxBackends;i+... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* PID not found */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_crashed_backend_activity &raquo; </span> 
 
<span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN4023"></a><span class='Declare_Function'>pgstat_get_backend_desc</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN701"><span class='Ref_to_Enum'>BackendType</span></a> <span class='Declare_Parameter'>backendType</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4025"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>backendDesc</span> <span class='Operator'>= </span><span class='String'>"unknown process type"</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4023"><span class='Ref_to_Parameter'>backendType</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN703"><span class='Ref_to_EnumConst'>B_AUTOVAC_LAUNCHER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"autovacuum launcher"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN704"><span class='Ref_to_EnumConst'>B_AUTOVAC_WORKER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"autovacuum worker"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN705"><span class='Ref_to_EnumConst'>B_BACKEND</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"client backend"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN706"><span class='Ref_to_EnumConst'>B_BG_WORKER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"background worker"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN707"><span class='Ref_to_EnumConst'>B_BG_WRITER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"background writer"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN708"><span class='Ref_to_EnumConst'>B_CHECKPOINTER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"checkpointer"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN709"><span class='Ref_to_EnumConst'>B_STARTUP</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"startup"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN710"><span class='Ref_to_EnumConst'>B_WAL_RECEIVER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"walreceiver"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN711"><span class='Ref_to_EnumConst'>B_WAL_SENDER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"walsender"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN712"><span class='Ref_to_EnumConst'>B_WAL_WRITER</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a> <span class='Operator'>= </span><span class='String'>"walwriter"</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch backendType &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN4025"><span class='Ref_To_Local'>backendDesc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_backend_desc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ------------------------------------------------------------ 
 * Local support functions follow 
 * ------------------------------------------------------------ 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_setheader() - 
 * 
 *      Set common header fields in a statistics message 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4077"></a><span class='Declare_Function'>pgstat_setheader</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN192"><span class='Ref_to_Struct'>PgStat_MsgHdr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN47"><span class='Ref_to_Enum'>StatMsgType</span></a> <span class='Declare_Parameter'>mtype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN4077"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN194"><span class='Ref_to_Member'>m_type</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN4077"><span class='Ref_to_Parameter'>mtype</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_send() - 
 * 
 *      Send out one statistics message to the collector 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4090"></a><span class='Declare_Function'>pgstat_send</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4092"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN192"><span class='Ref_to_Struct'>PgStat_MsgHdr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4090"><span class='Ref_to_Parameter'>msg</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>m_size <span class='Operator'>= </span><a href="pgstat.c.html#LN4090"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We'll retry after EINTR, but ignore all other failures */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN4092"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4090"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4090"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4092"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
    <span class='Comment_Multi_Line'>/* In debug builds, log send failures ... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4092"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not send to statistics collector: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_send &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_send_archiver() - 
 * 
 *  Tell the collector about the WAL file that we successfully 
 *  archived or failed to archive. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4120"></a><span class='Declare_Function'>pgstat_send_archiver</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>xlog</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>failed</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4122"></a>    <a href="../../include/pgstat.h.html#LN396"><span class='Ref_to_Struct'>PgStat_MsgArchiver</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare and send the message 
     */ 
</span>    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN398"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN60"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_ARCHIVER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN399"><span class='Ref_to_Member'>m_failed</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN4120"><span class='Ref_to_Parameter'>failed</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN400"><span class='Ref_to_Member'>m_xlog</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4120"><span class='Ref_to_Parameter'>xlog</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN400"><span class='Ref_to_Member'>m_xlog</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN401"><span class='Ref_to_Member'>m_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4122"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_send_bgwriter() - 
 * 
 *      Send bgwriter statistics to the collector 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4141"></a><span class='Declare_Function'>pgstat_send_bgwriter</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* We assume this initializes to zeroes */ 
</span><a name="LN4144"></a>    <span class='Keyword'>static const </span><a href="../../include/pgstat.h.html#LN408"><span class='Ref_to_Struct'>PgStat_MsgBgWriter</span></a> <span class='Declare_Local'>all_zeroes</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This function can be called even if nothing at all has happened. In 
     * this case, avoid sending a completely empty message to the stats 
     * collector. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>memcmp<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN142"><span class='Ref_to_Global_Var'>BgWriterStats</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4144"><span class='Ref_To_Local'>all_zeroes</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN408"><span class='Ref_to_Struct'>PgStat_MsgBgWriter</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare and send the message 
     */ 
</span>    <a href="pgstat.c.html#LN318"><span class='Ref_to_Proto'>pgstat_setheader</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN142"><span class='Ref_to_Global_Var'>BgWriterStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN410"><span class='Ref_to_Member'>m_hdr</span></a><span class='Delimiter'>, </span><a href="../../include/pgstat.h.html#LN61"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_BGWRITER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN319"><span class='Ref_to_Proto'>pgstat_send</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN142"><span class='Ref_to_Global_Var'>BgWriterStats</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN142"><span class='Ref_to_Global_Var'>BgWriterStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear out the statistics buffer, so it can be re-used. 
     */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN142"><span class='Ref_to_Global_Var'>BgWriterStats</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN142"><span class='Ref_to_Global_Var'>BgWriterStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_send_bgwriter &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * PgstatCollectorMain() - 
 * 
 *  Start up the statistics collector process.  This is the body of the 
 *  postmaster child process. 
 * 
 *  The argc/argv parameters are valid only in EXEC_BACKEND case. 
 * ---------- 
 */ 
</span><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void 
</span><a name="LN4177"></a><span class='Declare_Function'>PgstatCollectorMain</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4179"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN4180"></a>    <a href="../../include/pgstat.h.html#LN537"><span class='Ref_to_Union'>PgStat_Msg</span></a>  <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span><a name="LN4181"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>wr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ignore all signals usually bound to some action in the postmaster, 
     * except SIGHUP and SIGQUIT.  Note we don't need a SIGUSR1 handler to 
     * support latch operations, because we only use a local latch. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN289"><span class='Ref_to_Proto'>pgstat_sighup_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN287"><span class='Ref_to_Proto'>pgstat_exit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN193"><span class='Ref_to_Const'>SIGALRM</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN198"><span class='Ref_to_Const'>SIGTTIN</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN199"><span class='Ref_to_Const'>SIGTTOU</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN196"><span class='Ref_to_Const'>SIGCONT</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN200"><span class='Ref_to_Const'>SIGWINCH</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Identify myself via ps 
     */ 
</span>    <a href="../../include/utils/ps_status.h.html#LN18"><span class='Ref_to_Proto'>init_ps_display</span></a><span class='Parentheses'>(</span><span class='String'>"stats collector process"</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read in existing stats files or initialize the stats to zero. 
     */ 
</span>    <a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN296"><span class='Ref_to_Proto'>pgstat_read_statsfiles</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop to process messages until we get SIGQUIT or detect ungraceful 
     * death of our parent postmaster. 
     * 
     * For performance reasons, we don't want to do ResetLatch/WaitLatch after 
     * every message; instead, do that only after a recv() fails to obtain a 
     * message.  (This effectively means that if backends are sending us stuff 
     * like mad, we won't notice postmaster death until things slack off a 
     * bit; which seems fine.)  To do that, we have an inner loop that 
     * iterates as long as recv() succeeds.  We do recognize got_SIGHUP inside 
     * the inner loop, which means that such interrupts will get serviced but 
     * the latch won't get cleared until next time there is a break in the 
     * action. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Clear any already-pending wakeups */ 
</span>        <a href="../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Quit if we get SIGQUIT from the postmaster. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN267"><span class='Ref_to_Global_Var'>need_exit</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Inner loop iterates as long as we keep getting messages, or until 
         * need_exit becomes set. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN267"><span class='Ref_to_Global_Var'>need_exit</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Reload configuration if we got SIGHUP from the postmaster. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Write the stats file(s) if a new request has arrived that is 
             * not satisfied by existing file(s). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN301"><span class='Ref_to_Proto'>pgstat_write_statsfile_needed</span></a><span class='Parentheses'>())</span> 
                <a href="pgstat.c.html#LN294"><span class='Ref_to_Proto'>pgstat_write_statsfiles</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Try to receive and process a message.  This will not block, 
             * since the socket is set to non-blocking mode. 
             * 
             * XXX On Windows, we have to force pgwin32_recv to cooperate, 
             * despite the previous use of pg_set_noblock() on the socket. 
             * This is extremely broken and should be fixed someday. 
             */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            <a href="../port/win32/socket.c.html#LN27"><span class='Ref_to_Global_Var'>pgwin32_noblock</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN374"><span class='Ref_to_Macro'>recv</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, 
</span>                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN537"><span class='Ref_to_Union'>PgStat_Msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            <a href="../port/win32/socket.c.html#LN27"><span class='Ref_to_Global_Var'>pgwin32_noblock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* out of inner loop */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read statistics message: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We ignore messages that are smaller than our common header 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN192"><span class='Ref_to_Struct'>PgStat_MsgHdr</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The received length must match the length in the header 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN539"><span class='Ref_to_Member'>msg_hdr</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN195"><span class='Ref_to_Member'>m_size</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * O.K. - we accept this message.  Process it. 
             */ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN539"><span class='Ref_to_Member'>msg_hdr</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN194"><span class='Ref_to_Member'>m_type</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN49"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_DUMMY</span></a><span class='Operator'>: 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN50"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_INQUIRY</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN321"><span class='Ref_to_Proto'>pgstat_recv_inquiry</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN238"><span class='Ref_to_Struct'>PgStat_MsgInquiry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN51"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TABSTAT</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN322"><span class='Ref_to_Proto'>pgstat_recv_tabstat</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN52"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TABPURGE</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN323"><span class='Ref_to_Proto'>pgstat_recv_tabpurge</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN53"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_DROPDB</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN324"><span class='Ref_to_Proto'>pgstat_recv_dropdb</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN302"><span class='Ref_to_Struct'>PgStat_MsgDropdb</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN54"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RESETCOUNTER</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN325"><span class='Ref_to_Proto'>pgstat_recv_resetcounter</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN314"><span class='Ref_to_Struct'>PgStat_MsgResetcounter</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, 
</span>                                             <a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN55"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RESETSHAREDCOUNTER</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN326"><span class='Ref_to_Proto'>pgstat_recv_resetsharedcounter</span></a><span class='Parentheses'>(</span> 
                                       <span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN325"><span class='Ref_to_Struct'>PgStat_MsgResetsharedcounter</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, 
</span>                                                   <a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN56"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RESETSINGLECOUNTER</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN327"><span class='Ref_to_Proto'>pgstat_recv_resetsinglecounter</span></a><span class='Parentheses'>(</span> 
                                       <span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN336"><span class='Ref_to_Struct'>PgStat_MsgResetsinglecounter</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, 
</span>                                                   <a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN57"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_AUTOVAC_START</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN328"><span class='Ref_to_Proto'>pgstat_recv_autovac</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN349"><span class='Ref_to_Struct'>PgStat_MsgAutovacStart</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN58"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_VACUUM</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN329"><span class='Ref_to_Proto'>pgstat_recv_vacuum</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN362"><span class='Ref_to_Struct'>PgStat_MsgVacuum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN59"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_ANALYZE</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN330"><span class='Ref_to_Proto'>pgstat_recv_analyze</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN379"><span class='Ref_to_Struct'>PgStat_MsgAnalyze</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN60"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_ARCHIVER</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN331"><span class='Ref_to_Proto'>pgstat_recv_archiver</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN396"><span class='Ref_to_Struct'>PgStat_MsgArchiver</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN61"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_BGWRITER</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN332"><span class='Ref_to_Proto'>pgstat_recv_bgwriter</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN408"><span class='Ref_to_Struct'>PgStat_MsgBgWriter</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN62"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_FUNCSTAT</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN333"><span class='Ref_to_Proto'>pgstat_recv_funcstat</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN496"><span class='Ref_to_Struct'>PgStat_MsgFuncstat</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN63"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_FUNCPURGE</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN334"><span class='Ref_to_Proto'>pgstat_recv_funcpurge</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN513"><span class='Ref_to_Struct'>PgStat_MsgFuncpurge</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN64"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_RECOVERYCONFLICT</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN335"><span class='Ref_to_Proto'>pgstat_recv_recoveryconflict</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN428"><span class='Ref_to_Struct'>PgStat_MsgRecoveryConflict</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN66"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_DEADLOCK</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN336"><span class='Ref_to_Proto'>pgstat_recv_deadlock</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN526"><span class='Ref_to_Struct'>PgStat_MsgDeadlock</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../include/pgstat.h.html#LN65"><span class='Ref_to_EnumConst'>PGSTAT_MTYPE_TEMPFILE</span></a><span class='Operator'>: 
</span>                    <a href="pgstat.c.html#LN337"><span class='Ref_to_Proto'>pgstat_recv_tempfile</span></a><span class='Parentheses'>((</span><a href="../../include/pgstat.h.html#LN440"><span class='Ref_to_Struct'>PgStat_MsgTempFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4180"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4179"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch msg.msg_hdr.m_type &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while !need_exit &raquo; </span>                       <span class='Comment_Single_Line'>/* end of inner message-processing loop */ 
</span> 
        <span class='Comment_Multi_Line'>/* Sleep until there's something to do */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="pgstat.c.html#LN4181"><span class='Ref_To_Local'>wr</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                     <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>, 
</span>                               <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1L</span><span class='Delimiter'>, 
</span>                               <a href="../../include/pgstat.h.html#LN761"><span class='Ref_to_EnumConst'>WAIT_EVENT_PGSTAT_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Windows, at least in its Windows Server 2003 R2 incarnation, 
         * sometimes loses FD_READ events.  Waking up and retrying the recv() 
         * fixes that, so don't sleep indefinitely.  This is a crock of the 
         * first water, but until somebody wants to debug exactly what's 
         * happening there, this is the best we can do.  The two-second 
         * timeout matches our pre-9.2 behavior, and needs to be short enough 
         * to not provoke "using stale statistics" complaints from 
         * backend_read_statsfile. 
         */ 
</span>        <a href="pgstat.c.html#LN4181"><span class='Ref_To_Local'>wr</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>        <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a><span class='Delimiter'>, 
</span>                               <a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, 
</span>                               <span class='Number'>2</span> <span class='Operator'>* </span><span class='Number'>1000L</span> <span class='Comment_Multi_Line'>/* msec */ </span><span class='Delimiter'>, 
</span>                               <a href="../../include/pgstat.h.html#LN761"><span class='Ref_to_EnumConst'>WAIT_EVENT_PGSTAT_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Emergency bailout if postmaster has died.  This is to avoid the 
         * necessity for manual cleanup of all postmaster children. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4181"><span class='Ref_To_Local'>wr</span></a> <span class='Operator'>& </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span>                           <span class='Comment_Single_Line'>/* end of outer loop */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Save the final stats to reuse at next startup. 
     */ 
</span>    <a href="pgstat.c.html#LN294"><span class='Ref_to_Proto'>pgstat_write_statsfiles</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PgstatCollectorMain &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* SIGQUIT signal handler for collector process */ 
</span><span class='Keyword'>static void 
</span><a name="LN4431"></a><span class='Declare_Function'>pgstat_exit</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4433"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN267"><span class='Ref_to_Global_Var'>need_exit</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="pgstat.c.html#LN4433"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGHUP handler for collector process */ 
</span><span class='Keyword'>static void 
</span><a name="LN4443"></a><span class='Declare_Function'>pgstat_sighup_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4445"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="pgstat.c.html#LN4445"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Subroutine to clear stats in a database entry 
 * 
 * Tables and functions hashes are initialized to empty. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4459"></a><span class='Declare_Function'>reset_dbentry_counters</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4461"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN577"><span class='Ref_to_Member'>n_xact_commit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN578"><span class='Ref_to_Member'>n_xact_rollback</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN579"><span class='Ref_to_Member'>n_blocks_fetched</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN580"><span class='Ref_to_Member'>n_blocks_hit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN581"><span class='Ref_to_Member'>n_tuples_returned</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN582"><span class='Ref_to_Member'>n_tuples_fetched</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN583"><span class='Ref_to_Member'>n_tuples_inserted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN584"><span class='Ref_to_Member'>n_tuples_updated</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN585"><span class='Ref_to_Member'>n_tuples_deleted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN586"><span class='Ref_to_Member'>last_autovac_time</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN587"><span class='Ref_to_Member'>n_conflict_tablespace</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN588"><span class='Ref_to_Member'>n_conflict_lock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN589"><span class='Ref_to_Member'>n_conflict_snapshot</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN590"><span class='Ref_to_Member'>n_conflict_bufferpin</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN591"><span class='Ref_to_Member'>n_conflict_startup_deadlock</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN592"><span class='Ref_to_Member'>n_temp_files</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN593"><span class='Ref_to_Member'>n_temp_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN594"><span class='Ref_to_Member'>n_deadlocks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN595"><span class='Ref_to_Member'>n_block_read_time</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN596"><span class='Ref_to_Member'>n_block_write_time</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN598"><span class='Ref_to_Member'>stat_reset_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Per-database table"</span><span class='Delimiter'>, 
</span>                                  <a href="pgstat.c.html#LN104"><span class='Ref_to_Const'>PGSTAT_TAB_HASH_SIZE</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4459"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Per-database function"</span><span class='Delimiter'>, 
</span>                                     <a href="pgstat.c.html#LN105"><span class='Ref_to_Const'>PGSTAT_FUNCTION_HASH_SIZE</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="pgstat.c.html#LN4461"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end reset_dbentry_counters &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Lookup the hash table entry for the specified database. If no hash 
 * table entry exists, initialize it, if the create parameter is true. 
 * Else, return NULL. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>* 
</span><a name="LN4509"></a><span class='Declare_Function'>pgstat_get_db_entry</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4511"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN4512"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN4513"></a>    <a href="../../include/utils/hsearch.h.html#LN102"><span class='Ref_to_Typedef'>HASHACTION</span></a>  <span class='Declare_Local'>action</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4509"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>? </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a> <span class='Operator'>: </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lookup or create the hash table entry for this database */ 
</span>    <a href="pgstat.c.html#LN4511"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>&</span><a href="pgstat.c.html#LN4509"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Delimiter'>, 
</span>                                                <a href="pgstat.c.html#LN4513"><span class='Ref_To_Local'>action</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4512"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN4509"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>&& !</span><a href="pgstat.c.html#LN4512"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If not found, initialize the new one.  This creates empty hash tables 
     * for tables and functions, too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN4512"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN4458"><span class='Ref_to_Func'>reset_dbentry_counters</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4511"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN4511"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_db_entry &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Lookup the hash table entry for the specified table. If no hash 
 * table entry exists, initialize it, if the create parameter is true. 
 * Else, return NULL. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>* 
</span><a name="LN4540"></a><span class='Declare_Function'>pgstat_get_tab_entry</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tableoid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4542"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN4543"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN4544"></a>    <a href="../../include/utils/hsearch.h.html#LN102"><span class='Ref_to_Typedef'>HASHACTION</span></a>  <span class='Declare_Local'>action</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4540"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>? </span><a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a> <span class='Operator'>: </span><a href="../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lookup or create the hash table entry for this table */ 
</span>    <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4540"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Operator'>&</span><a href="pgstat.c.html#LN4540"><span class='Ref_to_Parameter'>tableoid</span></a><span class='Delimiter'>, 
</span>                                                 <a href="pgstat.c.html#LN4544"><span class='Ref_To_Local'>action</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4543"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN4540"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>&& !</span><a href="pgstat.c.html#LN4543"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If not found, initialize the new one. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN4543"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN618"><span class='Ref_to_Member'>numscans</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN620"><span class='Ref_to_Member'>tuples_returned</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN621"><span class='Ref_to_Member'>tuples_fetched</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN623"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN624"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN625"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN626"><span class='Ref_to_Member'>tuples_hot_updated</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN630"><span class='Ref_to_Member'>changes_since_analyze</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN632"><span class='Ref_to_Member'>blocks_fetched</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN633"><span class='Ref_to_Member'>blocks_hit</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN635"><span class='Ref_to_Member'>vacuum_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN636"><span class='Ref_to_Member'>vacuum_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN637"><span class='Ref_to_Member'>autovac_vacuum_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN638"><span class='Ref_to_Member'>autovac_vacuum_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN639"><span class='Ref_to_Member'>analyze_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN640"><span class='Ref_to_Member'>analyze_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN641"><span class='Ref_to_Member'>autovac_analyze_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN642"><span class='Ref_to_Member'>autovac_analyze_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !found &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN4542"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_get_tab_entry &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_write_statsfiles() - 
 *      Write the global statistics file, as well as requested DB files. 
 * 
 *  'permanent' specifies writing to the permanent files not temporary ones. 
 *  When true (happens only when the collector is shutting down), also remove 
 *  the temporary files so that backends starting up under a new postmaster 
 *  can't read old data before the new collector is ready. 
 * 
 *  When 'allDbs' is false, only the requested databases (listed in 
 *  pending_write_requests) will be written; otherwise, all databases 
 *  will be written. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4598"></a><span class='Declare_Function'>pgstat_write_statsfiles</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allDbs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4600"></a>    <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hstat</span><span class='Delimiter'>; 
</span><a name="LN4601"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN4602"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fpout</span><span class='Delimiter'>; 
</span><a name="LN4603"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>format_id</span><span class='Delimiter'>; 
</span><a name="LN4604"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>tmpfile</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN4598"><span class='Ref_to_Parameter'>permanent</span></a> <span class='Operator'>? </span><a href="../../include/pgstat.h.html#LN30"><span class='Ref_to_Const'>PGSTAT_STAT_PERMANENT_TMPFILE</span></a> <span class='Operator'>: </span><a href="pgstat.c.html#LN135"><span class='Ref_to_Global_Var'>pgstat_stat_tmpname</span></a><span class='Delimiter'>; 
</span><a name="LN4605"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>statfile</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN4598"><span class='Ref_to_Parameter'>permanent</span></a> <span class='Operator'>? </span><a href="../../include/pgstat.h.html#LN29"><span class='Ref_to_Const'>PGSTAT_STAT_PERMANENT_FILENAME</span></a> <span class='Operator'>: </span><a href="pgstat.c.html#LN134"><span class='Ref_to_Global_Var'>pgstat_stat_filename</span></a><span class='Delimiter'>; 
</span><a name="LN4606"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"writing stats file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4605"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the statistics temp file to write out the current values. 
     */ 
</span>    <a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN1035"><span class='Ref_to_Const'>PG_BINARY_W</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open temporary statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the timestamp of the stats file. 
     */ 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN682"><span class='Ref_to_Member'>stats_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write the file header --- currently just a format ID. 
     */ 
</span>    <a href="pgstat.c.html#LN4603"><span class='Ref_To_Local'>format_id</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN568"><span class='Ref_to_Const'>PGSTAT_FILE_FORMAT_ID</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4603"><span class='Ref_To_Local'>format_id</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4603"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write global stats struct 
     */ 
</span>    <a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write archiver stats struct 
     */ 
</span>    <a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Walk through the database table. 
     */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4600"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN4601"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4600"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Write out the table and function stats for this DB into the 
         * appropriate per-DB stat file, if required. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4598"><span class='Ref_to_Parameter'>allDbs</span></a> <span class='Operator'>|| </span><a href="pgstat.c.html#LN302"><span class='Ref_to_Proto'>pgstat_db_requested</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4601"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Make DB's timestamp consistent with the global stats */ 
</span>            <a href="pgstat.c.html#LN4601"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN682"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN295"><span class='Ref_to_Proto'>pgstat_write_db_statsfile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4601"><span class='Ref_To_Local'>dbentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4598"><span class='Ref_to_Parameter'>permanent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Write out the DB entry. We don't write the tables or functions 
         * pointers, since they're of no use to any other process. 
         */ 
</span>        fputc<span class='Parentheses'>(</span><span class='String'>'D'</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4601"><span class='Ref_To_Local'>dbentry</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Delimiter'>, </span>tables<span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4606"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (dbentry=(PgStat_Stat... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * No more output to be done. Close the temp file and replace the old 
     * pgstat.stat with it.  The ferror() check replaces testing for error 
     * after each individual fputc or fwrite above. 
     */ 
</span>    fputc<span class='Parentheses'>(</span><span class='String'>'E'</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>ferror<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write temporary statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                      <a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4602"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not close temporary statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                      <a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4605"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename temporary statistics file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4605"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4604"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4598"><span class='Ref_to_Parameter'>permanent</span></a><span class='Parentheses'>) 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN134"><span class='Ref_to_Global_Var'>pgstat_stat_filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now throw away the list of requests.  Note that requests sent after we 
     * started the write are still waiting on the network socket. 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_write_statsfiles &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * return the filename for a DB stat file; filename is the output buffer, 
 * of length len. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4723"></a><span class='Declare_Function'>get_dbstat_filename</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>tempname</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Delimiter'>, 
</span><a name="LN4724"></a>                    <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4726"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>printed</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* NB -- pgstat_reset_remove_files knows about the pattern this uses */ 
</span>    <a href="pgstat.c.html#LN4726"><span class='Ref_To_Local'>printed</span></a> <span class='Operator'>= </span><a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4724"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4724"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><span class='String'>"%s/db_%u.%s"</span><span class='Delimiter'>, 
</span>                       <a href="pgstat.c.html#LN4723"><span class='Ref_to_Parameter'>permanent</span></a> <span class='Operator'>? </span><a href="../../include/pgstat.h.html#LN28"><span class='Ref_to_Const'>PGSTAT_STAT_PERMANENT_DIRECTORY</span></a> <span class='Operator'>: 
</span>                       <a href="pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Delimiter'>, 
</span>                       <a href="pgstat.c.html#LN4723"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Delimiter'>, 
</span>                       <a href="pgstat.c.html#LN4723"><span class='Ref_to_Parameter'>tempname</span></a> <span class='Operator'>? </span><span class='String'>"tmp"</span> <span class='Operator'>: </span><span class='String'>"stat"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4726"><span class='Ref_To_Local'>printed</span></a> <span class='Operator'>&GT; </span><a href="pgstat.c.html#LN4724"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"overlength pgstat path"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_write_db_statsfile() - 
 *      Write the stat file for a single database. 
 * 
 *  If writing to the permanent file (happens when the collector is 
 *  shutting down only), remove the temporary file so that backends 
 *  starting up under a new postmaster can't read the old data before 
 *  the new collector is ready. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4749"></a><span class='Declare_Function'>pgstat_write_db_statsfile</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dbentry</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4751"></a>    <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>tstat</span><span class='Delimiter'>; 
</span><a name="LN4752"></a>    <a href="../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>fstat</span><span class='Delimiter'>; 
</span><a name="LN4753"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN4754"></a>    <a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcentry</span><span class='Delimiter'>; 
</span><a name="LN4755"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fpout</span><span class='Delimiter'>; 
</span><a name="LN4756"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>format_id</span><span class='Delimiter'>; 
</span><a name="LN4757"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN4749"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a><span class='Delimiter'>; 
</span><a name="LN4758"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN4759"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmpfile</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN4760"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>statfile</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="pgstat.c.html#LN4722"><span class='Ref_to_Func'>get_dbstat_filename</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4749"><span class='Ref_to_Parameter'>permanent</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4757"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4722"><span class='Ref_to_Func'>get_dbstat_filename</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4749"><span class='Ref_to_Parameter'>permanent</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4757"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"writing stats file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the statistics temp file to write out the current values. 
     */ 
</span>    <a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN1035"><span class='Ref_to_Const'>PG_BINARY_W</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open temporary statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write the file header --- currently just a format ID. 
     */ 
</span>    <a href="pgstat.c.html#LN4756"><span class='Ref_To_Local'>format_id</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN568"><span class='Ref_to_Const'>PGSTAT_FILE_FORMAT_ID</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4758"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4756"><span class='Ref_To_Local'>format_id</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4756"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4758"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Walk through the database's access stats per table. 
     */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4751"><span class='Ref_To_Local'>tstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4749"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN4753"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4751"><span class='Ref_To_Local'>tstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        fputc<span class='Parentheses'>(</span><span class='String'>'T'</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4758"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4753"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4758"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Walk through the database's function stats table. 
     */ 
</span>    <a href="../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4752"><span class='Ref_To_Local'>fstat</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4749"><span class='Ref_to_Parameter'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN4754"><span class='Ref_To_Local'>funcentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4752"><span class='Ref_To_Local'>fstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        fputc<span class='Parentheses'>(</span><span class='String'>'F'</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN4758"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4754"><span class='Ref_To_Local'>funcentry</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="pgstat.c.html#LN4758"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* we'll check for error with ferror */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No more output to be done. Close the temp file and replace the old 
     * pgstat.stat with it.  The ferror() check replaces testing for error 
     * after each individual fputc or fwrite above. 
     */ 
</span>    fputc<span class='Parentheses'>(</span><span class='String'>'E'</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>ferror<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write temporary statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                      <a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4755"><span class='Ref_To_Local'>fpout</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not close temporary statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                      <a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename temporary statistics file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4759"><span class='Ref_To_Local'>tmpfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4749"><span class='Ref_to_Parameter'>permanent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN4722"><span class='Ref_to_Func'>get_dbstat_filename</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4757"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"removing temporary stats file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4760"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_write_db_statsfile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_read_statsfiles() - 
 * 
 *  Reads in some existing statistics collector files and returns the 
 *  databases hash table that is the top level of the data. 
 * 
 *  If 'onlydb' is not InvalidOid, it means we only want data for that DB 
 *  plus the shared catalogs ("DB 0").  We'll still populate the DB hash 
 *  table for all databases, but we don't bother even creating table/function 
 *  hash tables for other databases. 
 * 
 *  'permanent' specifies reading from the permanent files not temporary ones. 
 *  When true (happens only when the collector is starting up), remove the 
 *  files after reading; the in-memory status is now authoritative, and the 
 *  files would be out of date in case somebody else reads them. 
 * 
 *  If a 'deep' read is requested, table/function stats are read, otherwise 
 *  the table/function hash tables remain empty. 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>* 
</span><a name="LN4872"></a><span class='Declare_Function'>pgstat_read_statsfiles</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>onlydb</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>deep</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4874"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN4875"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Declare_Local'>dbbuf</span><span class='Delimiter'>; 
</span><a name="LN4876"></a>    <a href="../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span><a name="LN4877"></a>    <a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>dbhash</span><span class='Delimiter'>; 
</span><a name="LN4878"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fpin</span><span class='Delimiter'>; 
</span><a name="LN4879"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>format_id</span><span class='Delimiter'>; 
</span><a name="LN4880"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN4881"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>statfile</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN4872"><span class='Ref_to_Parameter'>permanent</span></a> <span class='Operator'>? </span><a href="../../include/pgstat.h.html#LN29"><span class='Ref_to_Const'>PGSTAT_STAT_PERMANENT_FILENAME</span></a> <span class='Operator'>: </span><a href="pgstat.c.html#LN134"><span class='Ref_to_Global_Var'>pgstat_stat_filename</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The tables will live in pgStatLocalContext. 
     */ 
</span>    <a href="pgstat.c.html#LN310"><span class='Ref_to_Proto'>pgstat_setup_memcxt</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the DB hashtable 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN4877"><span class='Ref_To_Local'>dbhash</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Databases hash"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN103"><span class='Ref_to_Const'>PGSTAT_DB_HASH_SIZE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clear out global and archiver statistics so they start from zero in 
     * case we can't load an existing statsfile. 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the current timestamp (will be kept only in case we can't load an 
     * existing statsfile). 
     */ 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN693"><span class='Ref_to_Member'>stat_reset_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN674"><span class='Ref_to_Member'>stat_reset_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN693"><span class='Ref_to_Member'>stat_reset_timestamp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to open the stats file. If it doesn't exist, the backends simply 
     * return zero for anything and the collector simply starts from scratch 
     * with empty counters. 
     * 
     * ENOENT is a possibility if the stats collector is not running or has 
     * not yet written the stats file the first time.  Any other failure 
     * condition is suspicious. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../tools/entab/entab.c.html#LN12"><span class='Ref_to_Const'>PG_BINARY_R</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="pgstat.c.html#LN4877"><span class='Ref_To_Local'>dbhash</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify it's of the expected format. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4879"><span class='Ref_To_Local'>format_id</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4879"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4879"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <a href="pgstat.c.html#LN4879"><span class='Ref_To_Local'>format_id</span></a> <span class='Operator'>!= </span><a href="../../include/pgstat.h.html#LN568"><span class='Ref_to_Const'>PGSTAT_FILE_FORMAT_ID</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read global stats struct 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read archiver stats struct 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We found an existing collector stats file. Read it and put all the 
     * hashtable entries into place. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span>fgetc<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * 'D'  A PgStat_StatDBEntry struct describing a database 
                 * follows. 
                 */ 
</span>            <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4875"><span class='Ref_To_Local'>dbbuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Delimiter'>, </span>tables<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Delimiter'>, </span>tables<span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Add to the DB hash 
                 */ 
</span>                <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4877"><span class='Ref_To_Local'>dbhash</span></a><span class='Delimiter'>, 
</span>                                                  <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4875"><span class='Ref_To_Local'>dbbuf</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a><span class='Delimiter'>, 
</span>                                                             <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                                             <span class='Operator'>&</span><a href="pgstat.c.html#LN4880"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4880"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN4875"><span class='Ref_To_Local'>dbbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Don't create tables/functions hashtables for uninteresting 
                 * databases. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4872"><span class='Ref_to_Parameter'>onlydb</span></a> <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4875"><span class='Ref_To_Local'>dbbuf</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a> <span class='Operator'>!= </span><a href="pgstat.c.html#LN4872"><span class='Ref_to_Parameter'>onlydb</span></a> <span class='Operator'>&& 
</span>                        <a href="pgstat.c.html#LN4875"><span class='Ref_To_Local'>dbbuf</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a> <span class='Operator'>!= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Per-database table"</span><span class='Delimiter'>, 
</span>                                              <a href="pgstat.c.html#LN104"><span class='Ref_to_Const'>PGSTAT_TAB_HASH_SIZE</span></a><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>= </span><a href="../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Per-database function"</span><span class='Delimiter'>, 
</span>                                                 <a href="pgstat.c.html#LN105"><span class='Ref_to_Const'>PGSTAT_FUNCTION_HASH_SIZE</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Operator'>&</span><a href="pgstat.c.html#LN4876"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If requested, read the data from the database-specific 
                 * file.  Otherwise we just leave the hashtables empty. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4872"><span class='Ref_to_Parameter'>deep</span></a><span class='Parentheses'>) 
</span>                    <a href="pgstat.c.html#LN297"><span class='Ref_to_Proto'>pgstat_read_db_statsfile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a><span class='Delimiter'>, 
</span>                                             <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, 
</span>                                             <a href="pgstat.c.html#LN4874"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Delimiter'>, 
</span>                                             <a href="pgstat.c.html#LN4872"><span class='Ref_to_Parameter'>permanent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'E'</span><span class='Operator'>: 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5054"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch fgetc(fpin) &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
<a name="LN5054"></a><span class='Label'>done</span><span class='Operator'>: 
</span>    <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4878"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If requested to read the permanent file, also get rid of it. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN4872"><span class='Ref_to_Parameter'>permanent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"removing permanent stats file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN4881"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pgstat.c.html#LN4877"><span class='Ref_To_Local'>dbhash</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_read_statsfiles &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_read_db_statsfile() - 
 * 
 *  Reads in the existing statistics collector file for the given database, 
 *  filling the passed-in tables and functions hash tables. 
 * 
 *  As in pgstat_read_statsfiles, if the permanent file is requested, it is 
 *  removed after reading. 
 * 
 *  Note: this code has the ability to skip storing per-table or per-function 
 *  data, if NULL is passed for the corresponding hashtable.  That's not used 
 *  at the moment though. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5083"></a><span class='Declare_Function'>pgstat_read_db_statsfile</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Delimiter'>, </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tabhash</span><span class='Delimiter'>, </span><a href="../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>funchash</span><span class='Delimiter'>, 
</span><a name="LN5084"></a>                         <span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5086"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN5087"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Declare_Local'>tabbuf</span><span class='Delimiter'>; 
</span><a name="LN5088"></a>    <a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Declare_Local'>funcbuf</span><span class='Delimiter'>; 
</span><a name="LN5089"></a>    <a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcentry</span><span class='Delimiter'>; 
</span><a name="LN5090"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fpin</span><span class='Delimiter'>; 
</span><a name="LN5091"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>format_id</span><span class='Delimiter'>; 
</span><a name="LN5092"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN5093"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>statfile</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="pgstat.c.html#LN4722"><span class='Ref_to_Func'>get_dbstat_filename</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5084"><span class='Ref_to_Parameter'>permanent</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5083"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to open the stats file. If it doesn't exist, the backends simply 
     * return zero for anything and the collector simply starts from scratch 
     * with empty counters. 
     * 
     * ENOENT is a possibility if the stats collector is not running or has 
     * not yet written the stats file the first time.  Any other failure 
     * condition is suspicious. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN5090"><span class='Ref_To_Local'>fpin</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../tools/entab/entab.c.html#LN12"><span class='Ref_to_Const'>PG_BINARY_R</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify it's of the expected format. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5091"><span class='Ref_To_Local'>format_id</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5091"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5090"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5091"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <a href="pgstat.c.html#LN5091"><span class='Ref_To_Local'>format_id</span></a> <span class='Operator'>!= </span><a href="../../include/pgstat.h.html#LN568"><span class='Ref_to_Const'>PGSTAT_FILE_FORMAT_ID</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We found an existing collector stats file. Read it and put all the 
     * hashtable entries into place. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span>fgetc<span class='Parentheses'>(</span><a href="pgstat.c.html#LN5090"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * 'T'  A PgStat_StatTabEntry follows. 
                 */ 
</span>            <span class='Control'>case</span> <span class='String'>'T'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5087"><span class='Ref_To_Local'>tabbuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="pgstat.c.html#LN5090"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Skip if table data not wanted. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5083"><span class='Ref_to_Parameter'>tabhash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN5086"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5083"><span class='Ref_to_Parameter'>tabhash</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5087"><span class='Ref_To_Local'>tabbuf</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN616"><span class='Ref_to_Member'>tableid</span></a><span class='Delimiter'>, 
</span>                                                         <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5092"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5092"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="pgstat.c.html#LN5086"><span class='Ref_To_Local'>tabentry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5087"><span class='Ref_To_Local'>tabbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5087"><span class='Ref_To_Local'>tabbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * 'F'  A PgStat_StatFuncEntry follows. 
                 */ 
</span>            <span class='Control'>case</span> <span class='String'>'F'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5088"><span class='Ref_To_Local'>funcbuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="pgstat.c.html#LN5090"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Skip if function data not wanted. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5083"><span class='Ref_to_Parameter'>funchash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <a href="pgstat.c.html#LN5089"><span class='Ref_To_Local'>funcentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5083"><span class='Ref_to_Parameter'>funchash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5088"><span class='Ref_To_Local'>funcbuf</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN652"><span class='Ref_to_Member'>functionid</span></a><span class='Delimiter'>, 
</span>                                                         <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5092"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5092"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="pgstat.c.html#LN5089"><span class='Ref_To_Local'>funcentry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5088"><span class='Ref_To_Local'>funcbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5088"><span class='Ref_To_Local'>funcbuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * 'E'  The EOF marker of a complete stats file. 
                 */ 
</span>            <span class='Control'>case</span> <span class='String'>'E'</span><span class='Operator'>: 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5217"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch fgetc(fpin) &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
<a name="LN5217"></a><span class='Label'>done</span><span class='Operator'>: 
</span>    <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5090"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5084"><span class='Ref_to_Parameter'>permanent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"removing permanent stats file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5093"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_read_db_statsfile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_read_db_statsfile_timestamp() - 
 * 
 *  Attempt to determine the timestamp of the last db statfile write. 
 *  Returns TRUE if successful; the timestamp is stored in *ts. 
 * 
 *  This needs to be careful about handling databases for which no stats file 
 *  exists, such as databases without a stat entry or those not yet written: 
 * 
 *  - if there's a database entry in the global file, return the corresponding 
 *  stats_timestamp value. 
 * 
 *  - if there's no db stat entry (e.g. for a new or inactive database), 
 *  there's no stats_timestamp value, but also nothing to write so we return 
 *  the timestamp of the global statfile. 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5245"></a><span class='Declare_Function'>pgstat_read_db_statsfile_timestamp</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>permanent</span><span class='Delimiter'>, 
</span><a name="LN5246"></a>                                   <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>ts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5248"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN5249"></a>    <a href="../../include/pgstat.h.html#LN680"><span class='Ref_to_Struct'>PgStat_GlobalStats</span></a> <span class='Declare_Local'>myGlobalStats</span><span class='Delimiter'>; 
</span><a name="LN5250"></a>    <a href="../../include/pgstat.h.html#LN664"><span class='Ref_to_Struct'>PgStat_ArchiverStats</span></a> <span class='Declare_Local'>myArchiverStats</span><span class='Delimiter'>; 
</span><a name="LN5251"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fpin</span><span class='Delimiter'>; 
</span><a name="LN5252"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>format_id</span><span class='Delimiter'>; 
</span><a name="LN5253"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>statfile</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN5245"><span class='Ref_to_Parameter'>permanent</span></a> <span class='Operator'>? </span><a href="../../include/pgstat.h.html#LN29"><span class='Ref_to_Const'>PGSTAT_STAT_PERMANENT_FILENAME</span></a> <span class='Operator'>: </span><a href="pgstat.c.html#LN134"><span class='Ref_to_Global_Var'>pgstat_stat_filename</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to open the stats file.  As above, anything but ENOENT is worthy of 
     * complaining about. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../tools/entab/entab.c.html#LN12"><span class='Ref_to_Const'>PG_BINARY_R</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open statistics file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify it's of the expected format. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5252"><span class='Ref_To_Local'>format_id</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5252"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5252"><span class='Ref_To_Local'>format_id</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <a href="pgstat.c.html#LN5252"><span class='Ref_To_Local'>format_id</span></a> <span class='Operator'>!= </span><a href="../../include/pgstat.h.html#LN568"><span class='Ref_to_Const'>PGSTAT_FILE_FORMAT_ID</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read global stats struct 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5249"><span class='Ref_To_Local'>myGlobalStats</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5249"><span class='Ref_To_Local'>myGlobalStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5249"><span class='Ref_To_Local'>myGlobalStats</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Read archiver stats struct 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5250"><span class='Ref_To_Local'>myArchiverStats</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5250"><span class='Ref_To_Local'>myArchiverStats</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5250"><span class='Ref_To_Local'>myArchiverStats</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* By default, we're going to return the timestamp of the global file. */ 
</span>    <span class='Operator'>*</span><a href="pgstat.c.html#LN5246"><span class='Ref_to_Parameter'>ts</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5249"><span class='Ref_To_Local'>myGlobalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN682"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We found an existing collector stats file.  Read it and look for a 
     * record for the requested database.  If found, use its timestamp. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span>fgetc<span class='Parentheses'>(</span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * 'D'  A PgStat_StatDBEntry struct describing a database 
                 * follows. 
                 */ 
</span>            <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN5248"><span class='Ref_To_Local'>dbentry</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Delimiter'>, </span>tables<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a><span class='Delimiter'>, </span>tables<span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5353"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If this is the DB we're looking for, save its timestamp and 
                 * we're done. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5248"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a> <span class='Operator'>== </span><a href="pgstat.c.html#LN5245"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Operator'>*</span><a href="pgstat.c.html#LN5246"><span class='Ref_to_Parameter'>ts</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5248"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5353"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'E'</span><span class='Operator'>: 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5353"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted statistics file \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="pgstat.c.html#LN5253"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="pgstat.c.html#LN5353"><span class='Ref_to_Label'>done</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch fgetc(fpin) &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
<a name="LN5353"></a><span class='Label'>done</span><span class='Operator'>: 
</span>    <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5251"><span class='Ref_To_Local'>fpin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_read_db_statsfile_timestamp &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * If not already done, read the statistics collector stats file into 
 * some hash tables.  The results will be kept until pgstat_clear_snapshot() 
 * is called (typically, at end of transaction). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5364"></a><span class='Declare_Function'>backend_read_statsfile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5366"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>min_ts</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5367"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>ref_ts</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5368"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>inquiry_db</span><span class='Delimiter'>; 
</span><a name="LN5369"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* already read it? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN154"><span class='Ref_to_Global_Var'>pgStatRunningInCollector</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In a normal backend, we check staleness of the data for our own DB, and 
     * so we send MyDatabaseId in inquiry messages.  In the autovac launcher, 
     * check staleness of the shared-catalog data, and send InvalidOid in 
     * inquiry messages so as not to force writing unnecessary data. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN49"><span class='Ref_to_Proto'>IsAutoVacuumLauncherProcess</span></a><span class='Parentheses'>())</span> 
        <a href="pgstat.c.html#LN5368"><span class='Ref_To_Local'>inquiry_db</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pgstat.c.html#LN5368"><span class='Ref_To_Local'>inquiry_db</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop until fresh enough stats file is available or we ran out of time. 
     * The stats inquiry message is sent repeatedly in case collector drops 
     * it; but not every single time, as that just swamps the collector. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5369"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN5369"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN92"><span class='Ref_to_Const'>PGSTAT_POLL_LOOP_COUNT</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN5369"><span class='Ref_To_Local'>count</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5394"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>ok</span><span class='Delimiter'>; 
</span><a name="LN5395"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>file_ts</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5396"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>cur_ts</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN5394"><span class='Ref_To_Local'>ok</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5244"><span class='Ref_to_Func'>pgstat_read_db_statsfile_timestamp</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5368"><span class='Ref_To_Local'>inquiry_db</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5395"><span class='Ref_To_Local'>file_ts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Calculate min acceptable timestamp, if we didn't already */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5369"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN5367"><span class='Ref_To_Local'>ref_ts</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We set the minimum acceptable timestamp to PGSTAT_STAT_INTERVAL 
             * msec before now.  This indirectly ensures that the collector 
             * needn't write the file more often than PGSTAT_STAT_INTERVAL. In 
             * an autovacuum worker, however, we want a lower delay to avoid 
             * using stale data, so we use PGSTAT_RETRY_DELAY (since the 
             * number of workers is low, this shouldn't be a problem). 
             * 
             * We don't recompute min_ts after sleeping, except in the 
             * unlikely case that cur_ts went backwards.  So we might end up 
             * accepting a file a bit older than PGSTAT_STAT_INTERVAL.  In 
             * practice that shouldn't happen, though, as long as the sleep 
             * time is less than PGSTAT_STAT_INTERVAL; and we don't want to 
             * tell the collector that our cutoff time is less than what we'd 
             * actually accept. 
             */ 
</span>            <a href="pgstat.c.html#LN5367"><span class='Ref_To_Local'>ref_ts</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>())</span> 
                <a href="pgstat.c.html#LN5366"><span class='Ref_To_Local'>min_ts</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5367"><span class='Ref_To_Local'>ref_ts</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>-</span><a href="pgstat.c.html#LN79"><span class='Ref_to_Const'>PGSTAT_RETRY_DELAY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="pgstat.c.html#LN5366"><span class='Ref_To_Local'>min_ts</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5367"><span class='Ref_To_Local'>ref_ts</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>-</span><a href="pgstat.c.html#LN76"><span class='Ref_to_Const'>PGSTAT_STAT_INTERVAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if count==0||cur_ts&LT;ref_... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If the file timestamp is actually newer than cur_ts, we must have 
         * had a clock glitch (system time went backwards) or there is clock 
         * skew between our processor and the stats collector's processor. 
         * Accept the file, but send an inquiry message anyway to make 
         * pgstat_recv_inquiry do a sanity check on the collector's time. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5394"><span class='Ref_To_Local'>ok</span></a> <span class='Operator'>&& </span><a href="pgstat.c.html#LN5395"><span class='Ref_To_Local'>file_ts</span></a> <span class='Operator'>&GT; </span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * A small amount of clock skew between processors isn't terribly 
             * surprising, but a large difference is worth logging.  We 
             * arbitrarily define "large" as 1000 msec. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5395"><span class='Ref_To_Local'>file_ts</span></a> <span class='Operator'>&GT;= </span><a href="../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a><span class='Delimiter'>, </span><span class='Number'>1000</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN5447"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filetime</span><span class='Delimiter'>; 
</span><a name="LN5448"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>mytime</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Copy because timestamptz_to_str returns a static buffer */ 
</span>                <a href="pgstat.c.html#LN5447"><span class='Ref_To_Local'>filetime</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_waldump/compat.c.html#LN48"><span class='Ref_to_Func'>timestamptz_to_str</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5395"><span class='Ref_To_Local'>file_ts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN5448"><span class='Ref_To_Local'>mytime</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_waldump/compat.c.html#LN48"><span class='Ref_to_Func'>timestamptz_to_str</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"stats collector's time %s is later than backend local time %s"</span><span class='Delimiter'>, 
</span>                     <a href="pgstat.c.html#LN5447"><span class='Ref_To_Local'>filetime</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5448"><span class='Ref_To_Local'>mytime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5447"><span class='Ref_To_Local'>filetime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5448"><span class='Ref_To_Local'>mytime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="pgstat.c.html#LN1562"><span class='Ref_to_Func'>pgstat_send_inquiry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5366"><span class='Ref_To_Local'>min_ts</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5368"><span class='Ref_To_Local'>inquiry_db</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ok&&file_ts&GT;cur_ts &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Normal acceptance case: file is not older than cutoff time */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5394"><span class='Ref_To_Local'>ok</span></a> <span class='Operator'>&& </span><a href="pgstat.c.html#LN5395"><span class='Ref_To_Local'>file_ts</span></a> <span class='Operator'>&GT;= </span><a href="pgstat.c.html#LN5366"><span class='Ref_To_Local'>min_ts</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Not there or too old, so kick the collector and wait a bit */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pgstat.c.html#LN5369"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>% </span><a href="pgstat.c.html#LN93"><span class='Ref_to_Const'>PGSTAT_INQ_LOOP_COUNT</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pgstat.c.html#LN1562"><span class='Ref_to_Func'>pgstat_send_inquiry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5396"><span class='Ref_To_Local'>cur_ts</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5366"><span class='Ref_To_Local'>min_ts</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5368"><span class='Ref_To_Local'>inquiry_db</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN79"><span class='Ref_to_Const'>PGSTAT_RETRY_DELAY</span></a> <span class='Operator'>* </span><span class='Number'>1000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for count=0;count&LT;PGSTAT_... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5369"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&GT;= </span><a href="pgstat.c.html#LN92"><span class='Ref_to_Const'>PGSTAT_POLL_LOOP_COUNT</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"using stale statistics instead of current ones "</span> 
                        <span class='String'>"because stats collector is not responding"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Autovacuum launcher wants stats about all databases, but a shallow read 
     * is sufficient.  Regular backends want a deep read for just the tables 
     * they can see (MyDatabaseId + shared catalogs). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN49"><span class='Ref_to_Proto'>IsAutoVacuumLauncherProcess</span></a><span class='Parentheses'>())</span> 
        <a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN296"><span class='Ref_to_Proto'>pgstat_read_statsfiles</span></a><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN296"><span class='Ref_to_Proto'>pgstat_read_statsfiles</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end backend_read_statsfile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_setup_memcxt() - 
 * 
 *  Create pgStatLocalContext, if not already done. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5498"></a><span class='Declare_Function'>pgstat_setup_memcxt</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                                   <span class='String'>"Statistics snapshot"</span><span class='Delimiter'>, 
</span>                                                   <a href="../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_clear_snapshot() - 
 * 
 *  Discard any data collected in the current transaction.  Any subsequent 
 *  request will cause new snapshots to be read. 
 * 
 *  This is also invoked during transaction commit or abort to discard 
 *  the no-longer-wanted snapshot. 
 * ---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN5518"></a><span class='Declare_Function'>pgstat_clear_snapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Release memory, if any was allocated */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset variables */ 
</span>    <a href="pgstat.c.html#LN242"><span class='Ref_to_Global_Var'>pgStatLocalContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN246"><span class='Ref_to_Global_Var'>localBackendStatusTable</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN249"><span class='Ref_to_Global_Var'>localNumBackends</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_inquiry() - 
 * 
 *  Process stat inquiry requests. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5539"></a><span class='Declare_Function'>pgstat_recv_inquiry</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN238"><span class='Ref_to_Struct'>PgStat_MsgInquiry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5541"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"received inquiry for database %u"</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5539"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN243"><span class='Ref_to_Member'>databaseid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's already a write request for this DB, there's nothing to do. 
     * 
     * Note that if a request is found, we return early and skip the below 
     * check for clock skew.  This is okay, since the only way for a DB 
     * request to be present in the list is that we have been here since the 
     * last write round.  It seems sufficient to check for clock skew once per 
     * write round. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5539"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN243"><span class='Ref_to_Member'>databaseid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to see if we last wrote this database at a time &GT;= the requested 
     * cutoff time.  If so, this is a stale request that was generated before 
     * we updated the DB file, and we don't need to do so again. 
     * 
     * If the requestor's local clock time is older than stats_timestamp, we 
     * should suspect a clock glitch, ie system time going backwards; though 
     * the more likely explanation is just delayed message receipt.  It is 
     * worth expending a GetCurrentTimestamp call to be sure, since a large 
     * retreat in the system clock reading could otherwise cause us to neglect 
     * to update the stats file for a long time. 
     */ 
</span>    <a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5539"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN243"><span class='Ref_to_Member'>databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We have no data for this DB.  Enter a write request anyway so that 
         * the global stats will get updated.  This is needed to prevent 
         * backend_read_statsfile from waiting for data that we cannot supply, 
         * in the case of a new DB that nobody has yet reported any stats for. 
         * See the behavior of pgstat_read_db_statsfile_timestamp. 
         */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5539"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN241"><span class='Ref_to_Member'>clock_time</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5582"></a>        <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>cur_ts</span> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5582"><span class='Ref_To_Local'>cur_ts</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Sure enough, time went backwards.  Force a new stats file write 
             * to get back in sync; but first, log a complaint. 
             */ 
</span><a name="LN5590"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>writetime</span><span class='Delimiter'>; 
</span><a name="LN5591"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>mytime</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Copy because timestamptz_to_str returns a static buffer */ 
</span>            <a href="pgstat.c.html#LN5590"><span class='Ref_To_Local'>writetime</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_waldump/compat.c.html#LN48"><span class='Ref_to_Func'>timestamptz_to_str</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5591"><span class='Ref_To_Local'>mytime</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_waldump/compat.c.html#LN48"><span class='Ref_to_Func'>timestamptz_to_str</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5582"><span class='Ref_To_Local'>cur_ts</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"stats_timestamp %s is later than collector's time %s for database %u"</span><span class='Delimiter'>, 
</span>                 <a href="pgstat.c.html#LN5590"><span class='Ref_To_Local'>writetime</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5591"><span class='Ref_To_Local'>mytime</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN576"><span class='Ref_to_Member'>databaseid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5590"><span class='Ref_To_Local'>writetime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5591"><span class='Ref_To_Local'>mytime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Nope, it's just an old request.  Assuming msg's clock_time is 
             * &GT;= its cutoff_time, it must be stale, so we can ignore it. 
             */ 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if msg-&GT;clock_time&LT;dbent... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5539"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN242"><span class='Ref_to_Member'>cutoff_time</span></a> <span class='Operator'>&LT;= </span><a href="pgstat.c.html#LN5541"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN599"><span class='Ref_to_Member'>stats_timestamp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Stale request, ignore it */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to write this DB, so create a request. 
     */ 
</span>    <a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN162"><span class='Ref_to_Func'>lappend_oid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a><span class='Delimiter'>, 
</span>                                         <a href="pgstat.c.html#LN5539"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN243"><span class='Ref_to_Member'>databaseid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_inquiry &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_tabstat() - 
 * 
 *  Count what the backend has done. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5632"></a><span class='Declare_Function'>pgstat_recv_tabstat</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN266"><span class='Ref_to_Struct'>PgStat_MsgTabstat</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5634"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN5635"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span><a name="LN5636"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN5637"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN269"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update database-wide stats. 
     */ 
</span>    <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN577"><span class='Ref_to_Member'>n_xact_commit</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a><span class='Parentheses'>) (</span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN271"><span class='Ref_to_Member'>m_xact_commit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN578"><span class='Ref_to_Member'>n_xact_rollback</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN73"><span class='Ref_to_Typedef'>PgStat_Counter</span></a><span class='Parentheses'>) (</span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN272"><span class='Ref_to_Member'>m_xact_rollback</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN595"><span class='Ref_to_Member'>n_block_read_time</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN273"><span class='Ref_to_Member'>m_block_read_time</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN596"><span class='Ref_to_Member'>n_block_write_time</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN274"><span class='Ref_to_Member'>m_block_write_time</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process all table entries in the message. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5636"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN5636"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN270"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN5636"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5654"></a>        <a href="../../include/pgstat.h.html#LN251"><span class='Ref_to_Struct'>PgStat_TableEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabmsg</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5632"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN275"><span class='Ref_to_Member'>m_entry</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN5636"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN253"><span class='Ref_to_Member'>t_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                       <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5637"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN5637"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If it's a new table entry, initialize counters to the values we 
             * just got. 
             */ 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN618"><span class='Ref_to_Member'>numscans</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN98"><span class='Ref_to_Member'>t_numscans</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN620"><span class='Ref_to_Member'>tuples_returned</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN100"><span class='Ref_to_Member'>t_tuples_returned</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN621"><span class='Ref_to_Member'>tuples_fetched</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN101"><span class='Ref_to_Member'>t_tuples_fetched</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN623"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN624"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN625"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN626"><span class='Ref_to_Member'>tuples_hot_updated</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN106"><span class='Ref_to_Member'>t_tuples_hot_updated</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN109"><span class='Ref_to_Member'>t_delta_live_tuples</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN630"><span class='Ref_to_Member'>changes_since_analyze</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN111"><span class='Ref_to_Member'>t_changed_tuples</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN632"><span class='Ref_to_Member'>blocks_fetched</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN113"><span class='Ref_to_Member'>t_blocks_fetched</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN633"><span class='Ref_to_Member'>blocks_hit</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN114"><span class='Ref_to_Member'>t_blocks_hit</span></a><span class='Delimiter'>; 
</span> 
            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN635"><span class='Ref_to_Member'>vacuum_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN636"><span class='Ref_to_Member'>vacuum_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN637"><span class='Ref_to_Member'>autovac_vacuum_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN638"><span class='Ref_to_Member'>autovac_vacuum_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN639"><span class='Ref_to_Member'>analyze_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN640"><span class='Ref_to_Member'>analyze_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN641"><span class='Ref_to_Member'>autovac_analyze_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN642"><span class='Ref_to_Member'>autovac_analyze_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !found &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Otherwise add the values to the existing entry. 
             */ 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN618"><span class='Ref_to_Member'>numscans</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN98"><span class='Ref_to_Member'>t_numscans</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN620"><span class='Ref_to_Member'>tuples_returned</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN100"><span class='Ref_to_Member'>t_tuples_returned</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN621"><span class='Ref_to_Member'>tuples_fetched</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN101"><span class='Ref_to_Member'>t_tuples_fetched</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN623"><span class='Ref_to_Member'>tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN624"><span class='Ref_to_Member'>tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN625"><span class='Ref_to_Member'>tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN626"><span class='Ref_to_Member'>tuples_hot_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN106"><span class='Ref_to_Member'>t_tuples_hot_updated</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* If table was truncated, first reset the live/dead counters */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN107"><span class='Ref_to_Member'>t_truncated</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN109"><span class='Ref_to_Member'>t_delta_live_tuples</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN110"><span class='Ref_to_Member'>t_delta_dead_tuples</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN630"><span class='Ref_to_Member'>changes_since_analyze</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN111"><span class='Ref_to_Member'>t_changed_tuples</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN632"><span class='Ref_to_Member'>blocks_fetched</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN113"><span class='Ref_to_Member'>t_blocks_fetched</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN633"><span class='Ref_to_Member'>blocks_hit</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN114"><span class='Ref_to_Member'>t_blocks_hit</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Clamp n_live_tuples in case of negative delta_live_tuples */ 
</span>        <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Likewise for n_dead_tuples */ 
</span>        <a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5635"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Add per-table stats to the per-database entry, too. 
         */ 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN581"><span class='Ref_to_Member'>n_tuples_returned</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN100"><span class='Ref_to_Member'>t_tuples_returned</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN582"><span class='Ref_to_Member'>n_tuples_fetched</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN101"><span class='Ref_to_Member'>t_tuples_fetched</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN583"><span class='Ref_to_Member'>n_tuples_inserted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN103"><span class='Ref_to_Member'>t_tuples_inserted</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN584"><span class='Ref_to_Member'>n_tuples_updated</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN104"><span class='Ref_to_Member'>t_tuples_updated</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN585"><span class='Ref_to_Member'>n_tuples_deleted</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN105"><span class='Ref_to_Member'>t_tuples_deleted</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN579"><span class='Ref_to_Member'>n_blocks_fetched</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN113"><span class='Ref_to_Member'>t_blocks_fetched</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5634"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN580"><span class='Ref_to_Member'>n_blocks_hit</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN5654"><span class='Ref_To_Local'>tabmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN254"><span class='Ref_to_Member'>t_counts</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN114"><span class='Ref_to_Member'>t_blocks_hit</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;msg-&GT;m_nentries... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_tabstat &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_tabpurge() - 
 * 
 *  Arrange for dead table removal. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5739"></a><span class='Declare_Function'>pgstat_recv_tabpurge</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN288"><span class='Ref_to_Struct'>PgStat_MsgTabpurge</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5741"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN5742"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5741"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5739"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN291"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need to purge if we don't even know the database. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN5741"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN5741"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process all table entries in the message. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5742"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN5742"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN5739"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN292"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN5742"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Remove from hashtable if present; we don't care if it's not. */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5741"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, 
</span>                           <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5739"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN293"><span class='Ref_to_Member'>m_tableid</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN5742"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_tabpurge &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_dropdb() - 
 * 
 *  Arrange for dead database removal 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5772"></a><span class='Declare_Function'>pgstat_recv_dropdb</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN302"><span class='Ref_to_Struct'>PgStat_MsgDropdb</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5774"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span> <span class='Operator'>= </span><a href="pgstat.c.html#LN5772"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN305"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>; 
</span><a name="LN5775"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup the database in the hashtable. 
     */ 
</span>    <a href="pgstat.c.html#LN5775"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5774"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If found, remove it (along with the db statfile). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5775"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5787"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>statfile</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
        <a href="pgstat.c.html#LN4722"><span class='Ref_to_Func'>get_dbstat_filename</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5774"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5787"><span class='Ref_To_Local'>statfile</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"removing stats file \"%s\""</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5787"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5787"><span class='Ref_To_Local'>statfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5775"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5775"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5775"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5775"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN243"><span class='Ref_to_Global_Var'>pgStatDBHash</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="pgstat.c.html#LN5774"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database hash table corrupted during cleanup --- abort"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dbentry &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_dropdb &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_resetcounter() - 
 * 
 *  Reset the statistics for the specified database. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5815"></a><span class='Declare_Function'>pgstat_recv_resetcounter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN314"><span class='Ref_to_Struct'>PgStat_MsgResetcounter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5817"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup the database in the hashtable.  Nothing to do if not there. 
     */ 
</span>    <a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5815"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN317"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We simply throw away all the database's table entries by recreating a 
     * new hash table for them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset database-level stats, too.  This creates empty hash tables for 
     * tables and functions. 
     */ 
</span>    <a href="pgstat.c.html#LN4458"><span class='Ref_to_Func'>reset_dbentry_counters</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5817"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_resetcounter &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_resetshared() - 
 * 
 *  Reset some shared statistics of the cluster. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5853"></a><span class='Declare_Function'>pgstat_recv_resetsharedcounter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN325"><span class='Ref_to_Struct'>PgStat_MsgResetsharedcounter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5853"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN328"><span class='Ref_to_Member'>m_resettarget</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN121"><span class='Ref_to_EnumConst'>RESET_BGWRITER</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Reset the global background writer statistics for the cluster. */ 
</span>        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN693"><span class='Ref_to_Member'>stat_reset_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5853"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN328"><span class='Ref_to_Member'>m_resettarget</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN120"><span class='Ref_to_EnumConst'>RESET_ARCHIVER</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Reset the archiver statistics for the cluster. */ 
</span>        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN674"><span class='Ref_to_Member'>stat_reset_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Presumably the sender of this message validated the target, don't 
     * complain here if it's not valid 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_resetsharedcounter &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_resetsinglecounter() - 
 * 
 *  Reset a statistics for a single object 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5881"></a><span class='Declare_Function'>pgstat_recv_resetsinglecounter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN336"><span class='Ref_to_Struct'>PgStat_MsgResetsinglecounter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5883"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5883"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5881"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN339"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN5883"><span class='Ref_To_Local'>dbentry</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set the reset timestamp for the whole database */ 
</span>    <a href="pgstat.c.html#LN5883"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN598"><span class='Ref_to_Member'>stat_reset_timestamp</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove object if it exists, ignore it if not */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5881"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN340"><span class='Ref_to_Member'>m_resettype</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN127"><span class='Ref_to_EnumConst'>RESET_TABLE</span></a><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5883"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN605"><span class='Ref_to_Member'>tables</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5881"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN341"><span class='Ref_to_Member'>m_objectid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5881"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN340"><span class='Ref_to_Member'>m_resettype</span></a> <span class='Operator'>== </span><a href="../../include/pgstat.h.html#LN128"><span class='Ref_to_EnumConst'>RESET_FUNCTION</span></a><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5883"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5881"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN341"><span class='Ref_to_Member'>m_objectid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_resetsinglecounter &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_autovac() - 
 * 
 *  Process an autovacuum signalling message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5909"></a><span class='Declare_Function'>pgstat_recv_autovac</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN349"><span class='Ref_to_Struct'>PgStat_MsgAutovacStart</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5911"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store the last autovacuum time in the database's hashtable entry. 
     */ 
</span>    <a href="pgstat.c.html#LN5911"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5909"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN352"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5911"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN586"><span class='Ref_to_Member'>last_autovac_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5909"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN353"><span class='Ref_to_Member'>m_start_time</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_vacuum() - 
 * 
 *  Process a VACUUM message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5928"></a><span class='Declare_Function'>pgstat_recv_vacuum</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN362"><span class='Ref_to_Struct'>PgStat_MsgVacuum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5930"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN5931"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store the data in the table's hashtable entry. 
     */ 
</span>    <a href="pgstat.c.html#LN5930"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN365"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN292"><span class='Ref_to_Proto'>pgstat_get_tab_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5930"><span class='Ref_To_Local'>dbentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN366"><span class='Ref_to_Member'>m_tableoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN369"><span class='Ref_to_Member'>m_live_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN370"><span class='Ref_to_Member'>m_dead_tuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN367"><span class='Ref_to_Member'>m_autovacuum</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN637"><span class='Ref_to_Member'>autovac_vacuum_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN368"><span class='Ref_to_Member'>m_vacuumtime</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN638"><span class='Ref_to_Member'>autovac_vacuum_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN635"><span class='Ref_to_Member'>vacuum_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5928"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN368"><span class='Ref_to_Member'>m_vacuumtime</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5931"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN636"><span class='Ref_to_Member'>vacuum_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_vacuum &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_analyze() - 
 * 
 *  Process an ANALYZE message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5962"></a><span class='Declare_Function'>pgstat_recv_analyze</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN379"><span class='Ref_to_Struct'>PgStat_MsgAnalyze</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5964"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN5965"></a>    <a href="../../include/pgstat.h.html#LN614"><span class='Ref_to_Struct'>PgStat_StatTabEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tabentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store the data in the table's hashtable entry. 
     */ 
</span>    <a href="pgstat.c.html#LN5964"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN382"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN292"><span class='Ref_to_Proto'>pgstat_get_tab_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN5964"><span class='Ref_To_Local'>dbentry</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN383"><span class='Ref_to_Member'>m_tableoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN628"><span class='Ref_to_Member'>n_live_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN387"><span class='Ref_to_Member'>m_live_tuples</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN629"><span class='Ref_to_Member'>n_dead_tuples</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN388"><span class='Ref_to_Member'>m_dead_tuples</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If commanded, reset changes_since_analyze to zero.  This forgets any 
     * changes that were committed while the ANALYZE was in progress, but we 
     * have no good way to estimate how many of those there were. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN385"><span class='Ref_to_Member'>m_resetcounter</span></a><span class='Parentheses'>) 
</span>        <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN630"><span class='Ref_to_Member'>changes_since_analyze</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN384"><span class='Ref_to_Member'>m_autovacuum</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN641"><span class='Ref_to_Member'>autovac_analyze_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN386"><span class='Ref_to_Member'>m_analyzetime</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN642"><span class='Ref_to_Member'>autovac_analyze_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN639"><span class='Ref_to_Member'>analyze_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN5962"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN386"><span class='Ref_to_Member'>m_analyzetime</span></a><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN5965"><span class='Ref_To_Local'>tabentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN640"><span class='Ref_to_Member'>analyze_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_analyze &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_archiver() - 
 * 
 *  Process a ARCHIVER message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6005"></a><span class='Declare_Function'>pgstat_recv_archiver</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN396"><span class='Ref_to_Struct'>PgStat_MsgArchiver</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN6005"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN399"><span class='Ref_to_Member'>m_failed</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Failed archival attempt */ 
</span>        <span class='Operator'>++</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN670"><span class='Ref_to_Member'>failed_count</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN671"><span class='Ref_to_Member'>last_failed_wal</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN6005"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN400"><span class='Ref_to_Member'>m_xlog</span></a><span class='Delimiter'>, 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN671"><span class='Ref_to_Member'>last_failed_wal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN673"><span class='Ref_to_Member'>last_failed_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN6005"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN401"><span class='Ref_to_Member'>m_timestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Successful archival operation */ 
</span>        <span class='Operator'>++</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN666"><span class='Ref_to_Member'>archived_count</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN667"><span class='Ref_to_Member'>last_archived_wal</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN6005"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN400"><span class='Ref_to_Member'>m_xlog</span></a><span class='Delimiter'>, 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN667"><span class='Ref_to_Member'>last_archived_wal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN256"><span class='Ref_to_Global_Var'>archiverStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN669"><span class='Ref_to_Member'>last_archived_timestamp</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN6005"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN401"><span class='Ref_to_Member'>m_timestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_archiver &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_bgwriter() - 
 * 
 *  Process a BGWRITER message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6032"></a><span class='Declare_Function'>pgstat_recv_bgwriter</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN408"><span class='Ref_to_Struct'>PgStat_MsgBgWriter</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN683"><span class='Ref_to_Member'>timed_checkpoints</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN412"><span class='Ref_to_Member'>m_timed_checkpoints</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN684"><span class='Ref_to_Member'>requested_checkpoints</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN413"><span class='Ref_to_Member'>m_requested_checkpoints</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN685"><span class='Ref_to_Member'>checkpoint_write_time</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN420"><span class='Ref_to_Member'>m_checkpoint_write_time</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN686"><span class='Ref_to_Member'>checkpoint_sync_time</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN421"><span class='Ref_to_Member'>m_checkpoint_sync_time</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN687"><span class='Ref_to_Member'>buf_written_checkpoints</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN414"><span class='Ref_to_Member'>m_buf_written_checkpoints</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN688"><span class='Ref_to_Member'>buf_written_clean</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN415"><span class='Ref_to_Member'>m_buf_written_clean</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN689"><span class='Ref_to_Member'>maxwritten_clean</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN416"><span class='Ref_to_Member'>m_maxwritten_clean</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN690"><span class='Ref_to_Member'>buf_written_backend</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN417"><span class='Ref_to_Member'>m_buf_written_backend</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN691"><span class='Ref_to_Member'>buf_fsync_backend</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN418"><span class='Ref_to_Member'>m_buf_fsync_backend</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN257"><span class='Ref_to_Global_Var'>globalStats</span></a><span class='Operator'>.</span><a href="../../include/pgstat.h.html#LN692"><span class='Ref_to_Member'>buf_alloc</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6032"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN419"><span class='Ref_to_Member'>m_buf_alloc</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_recoveryconflict() - 
 * 
 *  Process a RECOVERYCONFLICT message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6053"></a><span class='Declare_Function'>pgstat_recv_recoveryconflict</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN428"><span class='Ref_to_Struct'>PgStat_MsgRecoveryConflict</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6055"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6055"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6053"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN432"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN6053"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN433"><span class='Ref_to_Member'>m_reason</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/storage/procsignal.h.html#LN38"><span class='Ref_to_EnumConst'>PROCSIG_RECOVERY_CONFLICT_DATABASE</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Since we drop the information about the database as soon as it 
             * replicates, there is no point in counting these conflicts. 
             */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/storage/procsignal.h.html#LN39"><span class='Ref_to_EnumConst'>PROCSIG_RECOVERY_CONFLICT_TABLESPACE</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN6055"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN587"><span class='Ref_to_Member'>n_conflict_tablespace</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/storage/procsignal.h.html#LN40"><span class='Ref_to_EnumConst'>PROCSIG_RECOVERY_CONFLICT_LOCK</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN6055"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN588"><span class='Ref_to_Member'>n_conflict_lock</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/storage/procsignal.h.html#LN41"><span class='Ref_to_EnumConst'>PROCSIG_RECOVERY_CONFLICT_SNAPSHOT</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN6055"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN589"><span class='Ref_to_Member'>n_conflict_snapshot</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/storage/procsignal.h.html#LN42"><span class='Ref_to_EnumConst'>PROCSIG_RECOVERY_CONFLICT_BUFFERPIN</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN6055"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN590"><span class='Ref_to_Member'>n_conflict_bufferpin</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/storage/procsignal.h.html#LN43"><span class='Ref_to_EnumConst'>PROCSIG_RECOVERY_CONFLICT_STARTUP_DEADLOCK</span></a><span class='Operator'>: 
</span>            <a href="pgstat.c.html#LN6055"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN591"><span class='Ref_to_Member'>n_conflict_startup_deadlock</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch msg-&GT;m_reason &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_recoveryconflict &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_deadlock() - 
 * 
 *  Process a DEADLOCK message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6093"></a><span class='Declare_Function'>pgstat_recv_deadlock</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN526"><span class='Ref_to_Struct'>PgStat_MsgDeadlock</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6095"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6095"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6093"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN529"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6095"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN594"><span class='Ref_to_Member'>n_deadlocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_tempfile() - 
 * 
 *  Process a TEMPFILE message. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6109"></a><span class='Declare_Function'>pgstat_recv_tempfile</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN440"><span class='Ref_to_Struct'>PgStat_MsgTempFile</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6111"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6111"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6109"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN444"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6111"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN593"><span class='Ref_to_Member'>n_temp_bytes</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6109"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN445"><span class='Ref_to_Member'>m_filesize</span></a><span class='Delimiter'>; 
</span>    <a href="pgstat.c.html#LN6111"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN592"><span class='Ref_to_Member'>n_temp_files</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_funcstat() - 
 * 
 *  Count what the backend has done. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6126"></a><span class='Declare_Function'>pgstat_recv_funcstat</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN496"><span class='Ref_to_Struct'>PgStat_MsgFuncstat</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6128"></a>    <a href="../../include/pgstat.h.html#LN479"><span class='Ref_to_Struct'>PgStat_FunctionEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcmsg</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6126"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN501"><span class='Ref_to_Member'>m_entry</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN6129"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN6130"></a>    <a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>funcentry</span><span class='Delimiter'>; 
</span><a name="LN6131"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN6132"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6129"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6126"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN499"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process all function entries in the message. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN6131"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN6131"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN6126"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN500"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN6131"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN650"><span class='Ref_to_Struct'>PgStat_StatFuncEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6129"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Delimiter'>, 
</span>                                                   <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN481"><span class='Ref_to_Member'>f_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                         <a href="../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pgstat.c.html#LN6132"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN6132"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If it's a new function entry, initialize counters to the values 
             * we just got. 
             */ 
</span>            <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN654"><span class='Ref_to_Member'>f_numcalls</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN482"><span class='Ref_to_Member'>f_numcalls</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN656"><span class='Ref_to_Member'>f_total_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN483"><span class='Ref_to_Member'>f_total_time</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN657"><span class='Ref_to_Member'>f_self_time</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN484"><span class='Ref_to_Member'>f_self_time</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Otherwise add the values to the existing entry. 
             */ 
</span>            <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN654"><span class='Ref_to_Member'>f_numcalls</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN482"><span class='Ref_to_Member'>f_numcalls</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN656"><span class='Ref_to_Member'>f_total_time</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN483"><span class='Ref_to_Member'>f_total_time</span></a><span class='Delimiter'>; 
</span>            <a href="pgstat.c.html#LN6130"><span class='Ref_To_Local'>funcentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN657"><span class='Ref_to_Member'>f_self_time</span></a> <span class='Operator'>+= </span><a href="pgstat.c.html#LN6128"><span class='Ref_To_Local'>funcmsg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN484"><span class='Ref_to_Member'>f_self_time</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;msg-&GT;m_nentries... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_funcstat &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_recv_funcpurge() - 
 * 
 *  Arrange for dead function removal. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6174"></a><span class='Declare_Function'>pgstat_recv_funcpurge</span><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN513"><span class='Ref_to_Struct'>PgStat_MsgFuncpurge</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6176"></a>    <a href="../../include/pgstat.h.html#LN574"><span class='Ref_to_Struct'>PgStat_StatDBEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dbentry</span><span class='Delimiter'>; 
</span><a name="LN6177"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="pgstat.c.html#LN6176"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN291"><span class='Ref_to_Proto'>pgstat_get_db_entry</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6174"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN516"><span class='Ref_to_Member'>m_databaseid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need to purge if we don't even know the database. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pgstat.c.html#LN6176"><span class='Ref_To_Local'>dbentry</span></a> <span class='Operator'>|| !</span><a href="pgstat.c.html#LN6176"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process all function entries in the message. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN6177"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pgstat.c.html#LN6177"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="pgstat.c.html#LN6174"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN517"><span class='Ref_to_Member'>m_nentries</span></a><span class='Delimiter'>; </span><a href="pgstat.c.html#LN6177"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Remove from hashtable if present; we don't care if it's not. */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6176"><span class='Ref_To_Local'>dbentry</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN606"><span class='Ref_to_Member'>functions</span></a><span class='Delimiter'>, 
</span>                           <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="pgstat.c.html#LN6174"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgstat.h.html#LN518"><span class='Ref_to_Member'>m_functionid</span></a><span class='Delimiter'>[</span><a href="pgstat.c.html#LN6177"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end pgstat_recv_funcpurge &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_write_statsfile_needed() - 
 * 
 *  Do we need to write out any stats files? 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN6206"></a><span class='Declare_Function'>pgstat_write_statsfile_needed</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Everything was written recently */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * pgstat_db_requested() - 
 * 
 *  Checks whether stats for a particular DB need to be written to a file. 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN6222"></a><span class='Declare_Function'>pgstat_db_requested</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If any requests are outstanding at all, we should write the stats for 
     * shared catalogs (the "database" with OID 0).  This ensures that 
     * backends will see up-to-date stats for shared catalogs, even though 
     * they send inquiry messages mentioning only their own DB. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pgstat.c.html#LN6222"><span class='Ref_to_Parameter'>databaseid</span></a> <span class='Operator'>== </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>&& </span><a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search to see if there's an open request to write this database. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="pgstat.c.html#LN264"><span class='Ref_to_Global_Var'>pending_write_requests</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN6222"><span class='Ref_to_Parameter'>databaseid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>