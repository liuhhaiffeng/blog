<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\postmaster\postmaster.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\postmaster\postmaster.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * postmaster.c 
 *    This program acts as a clearing house for requests to the 
 *    POSTGRES system.  Frontend programs send a startup message 
 *    to the Postmaster and the postmaster uses the info in the 
 *    message to setup a backend process. 
 * 
 *    The postmaster also manages system-wide operations such as 
 *    startup and shutdown. The postmaster itself doesn't do those 
 *    operations, mind you --- it just forks off a subprocess to do them 
 *    at the right times.  It also takes care of resetting the system 
 *    if a backend crashes. 
 * 
 *    The postmaster process creates the shared memory and semaphore 
 *    pools during startup, but as a rule does not touch them itself. 
 *    In particular, it is not a member of the PGPROC array of backends 
 *    and so it cannot participate in lock-manager operations.  Keeping 
 *    the postmaster away from shared memory operations makes it simpler 
 *    and more reliable.  The postmaster is almost always able to recover 
 *    from crashes of individual backends by resetting shared memory; 
 *    if it did much with shared memory then it would be prone to crashing 
 *    along with the backends. 
 * 
 *    When a request message is received, we now fork() immediately. 
 *    The child process performs authentication of the request, and 
 *    then becomes a backend if successful.  This allows the auth code 
 *    to be written in a simple single-threaded style (as opposed to the 
 *    crufty "poor man's multitasking" code that used to be needed). 
 *    More importantly, it ensures that blockages in non-multithreaded 
 *    libraries like SSL or PAM cannot cause denial of service to other 
 *    clients. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/postmaster/postmaster.c 
 * 
 * NOTES 
 * 
 * Initialization: 
 *      The Postmaster sets up shared memory data structures 
 *      for the backends. 
 * 
 * Synchronization: 
 *      The Postmaster shares memory with the backends but should avoid 
 *      touching shared memory, so as not to become stuck if a crashing 
 *      backend screws up locks or shared memory.  Likewise, the Postmaster 
 *      should never block on messages from frontend clients. 
 * 
 * Garbage Collection: 
 *      The Postmaster cleans up after backends if they have an emergency 
 *      exit and/or core dump. 
 * 
 * Error Reporting: 
 *      Use write_stderr() only for reporting "interactive" errors 
 *      (essentially, bogus arguments on the command line).  Once the 
 *      postmaster is launched, use ereport(). 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/wait.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;ctype.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/socket.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/param.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netdb.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> USE_BONJOUR 
<span class='Keyword'>#include </span><span class='String'>&LT;dns_sd.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> USE_SYSTEMD 
<span class='Keyword'>#include </span><span class='String'>&LT;systemd/sd-daemon.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> HAVE_PTHREAD_IS_THREADED_NP 
<span class='Keyword'>#include </span><span class='String'>&LT;pthread.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"bootstrap/bootstrap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_control.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/ip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/ilist.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/auth.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_getopt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgworker_internals.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/fork_process.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/pgarch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/syslogger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logicallauncher.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pmsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/datetime.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dynamic_loader.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ps_status.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timeout.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/varlena.h"</span> 
 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Possible types of a backend. Beyond being the possible bkend_type values in 
 * struct bkend, these are OR-able request flag bits for SignalSomeChildren() 
 * and CountChildren(). 
 */ 
</span><a name="LN141"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BACKEND_TYPE_NORMAL</span>     <span class='Number'>0x0001</span>  <span class='Comment_Single_Line'>/* normal backend */ 
</span><a name="LN142"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BACKEND_TYPE_AUTOVAC</span>    <span class='Number'>0x0002</span>  <span class='Comment_Single_Line'>/* autovacuum worker process */ 
</span><a name="LN143"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BACKEND_TYPE_WALSND</span>     <span class='Number'>0x0004</span>  <span class='Comment_Single_Line'>/* walsender process */ 
</span><a name="LN144"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BACKEND_TYPE_BGWORKER</span>   <span class='Number'>0x0008</span>  <span class='Comment_Single_Line'>/* bgworker process */ 
</span><a name="LN145"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BACKEND_TYPE_ALL</span>        <span class='Number'>0x000F</span>  <span class='Comment_Single_Line'>/* OR of all the above */ 
</span> 
<a name="LN147"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>BACKEND_TYPE_WORKER</span>     <span class='Parentheses'>(</span><a href="postmaster.c.html#LN142"><span class='Ref_to_Const'>BACKEND_TYPE_AUTOVAC</span></a> <span class='Operator'>| </span><a href="postmaster.c.html#LN144"><span class='Ref_to_Const'>BACKEND_TYPE_BGWORKER</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of active backends (or child processes anyway; we don't actually 
 * know whether a given child has become a backend or is still in the 
 * authorization phase).  This is used mainly to keep track of how many 
 * children we have and send them appropriate signals when necessary. 
 * 
 * "Special" children such as the startup, bgwriter and autovacuum launcher 
 * tasks are not in this list.  Autovacuum worker and walsender are in it. 
 * Also, "dead_end" children are in it: these are children launched just for 
 * the purpose of sending a friendly rejection message to a would-be client. 
 * We must track them because they are attached to shared memory, but we know 
 * they will never become live backends.  dead_end children are not assigned a 
 * PMChildSlot. 
 * 
 * Background workers are in this list, too. 
 */ 
</span><a name="LN165"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>bkend</span> 
<span class='Delimiter'>{ 
</span><a name="LN167"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Member'>pid</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* process id of backend */ 
</span><a name="LN168"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>cancel_key</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* cancel key for cancels for this backend */ 
</span><a name="LN169"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>child_slot</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* PMChildSlot for this backend, if any */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Flavor of backend or auxiliary process.  Note that BACKEND_TYPE_WALSND 
     * backends initially announce themselves as BACKEND_TYPE_NORMAL, so if 
     * bkend_type is normal, you should check for a recent transition. 
     */ 
</span><a name="LN176"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>bkend_type</span><span class='Delimiter'>; 
</span><a name="LN177"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>dead_end</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* is it going to send an error and quit? */ 
</span><a name="LN178"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>bgworker_notify</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* gets bgworker start/stop notifications */ 
</span><a name="LN179"></a>    <a href="../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>elem</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* list link in BackendList */ 
</span><a name="LN180"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>Backend</span><span class='Delimiter'>; 
</span> 
<a name="LN182"></a><span class='Keyword'>static </span><a href="../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a> <span class='Declare_Var'>BackendList</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN247"><span class='Ref_to_Macro'>DLIST_STATIC_INIT</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
<a name="LN185"></a><span class='Keyword'>static </span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ShmemBackendArray</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN188"></a><a href="../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a> <span class='Operator'>*</span><span class='Declare_Var'>MyBgworkerEntry</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
 
<span class='Comment_Multi_Line'>/* The socket number we are listening for connections on */ 
</span><a name="LN193"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>PostPortNumber</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* The directory names for Unix socket(s) */ 
</span><a name="LN196"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>Unix_socket_directories</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* The TCP listen address(es) */ 
</span><a name="LN199"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>ListenAddresses</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ReservedBackends is the number of backends reserved for superuser use. 
 * This number is taken out of the pool size given by MaxBackends so 
 * number of backend slots available to non-superusers is 
 * (MaxBackends - ReservedBackends).  Note what this really means is 
 * "if there are &LT;= ReservedBackends connections available, only superusers 
 * can make new connections" --- pre-existing superuser connections don't 
 * count against the limit. 
 */ 
</span><a name="LN210"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>ReservedBackends</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* The socket(s) we're listening to. */ 
</span><a name="LN213"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAXLISTEN</span>   <span class='Number'>64</span> 
<a name="LN214"></a><span class='Keyword'>static </span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Var'>ListenSocket</span><span class='Delimiter'>[</span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set by the -o option 
 */ 
</span><a name="LN219"></a><span class='Keyword'>static char </span><span class='Declare_Var'>ExtraOptions</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * These globals control the behavior of the postmaster in case some 
 * backend dumps core.  Normally, it kills all peers of the dead backend 
 * and reinitializes shared memory.  By specifying -s or -n, we can have 
 * the postmaster stop (rather than kill) peers and not reinitialize 
 * shared data structures.  (Reinit is currently dead code, though.) 
 */ 
</span><a name="LN228"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>Reinit</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN229"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>SendStop</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* still more option variables */ 
</span><a name="LN232"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>EnableSSL</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN234"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>PreAuthDelay</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN235"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>AuthenticationTimeout</span> <span class='Operator'>= </span><span class='Number'>60</span><span class='Delimiter'>; 
</span> 
<a name="LN237"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>log_hostname</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* for ps display and logging */ 
</span><a name="LN238"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Log_connections</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN239"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Db_user_namespace</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN241"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>enable_bonjour</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN242"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>bonjour_name</span><span class='Delimiter'>; 
</span><a name="LN243"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>restart_after_crash</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* PIDs of special child processes; 0 when not running */ 
</span><a name="LN246"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Var'>StartupPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN247"></a>            <span class='Declare_Var'>BgWriterPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN248"></a>            <span class='Declare_Var'>CheckpointerPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN249"></a>            <span class='Declare_Var'>WalWriterPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN250"></a>            <span class='Declare_Var'>WalReceiverPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN251"></a>            <span class='Declare_Var'>AutoVacPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN252"></a>            <span class='Declare_Var'>PgArchPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN253"></a>            <span class='Declare_Var'>PgStatPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN254"></a>            <span class='Declare_Var'>SysLoggerPID</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Startup process's status */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN259"></a>    <span class='Declare_Enum_Const'>STARTUP_NOT_RUNNING</span><span class='Delimiter'>, 
</span><a name="LN260"></a>    <span class='Declare_Enum_Const'>STARTUP_RUNNING</span><span class='Delimiter'>, 
</span><a name="LN261"></a>    <span class='Declare_Enum_Const'>STARTUP_SIGNALED</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* we sent it a SIGQUIT or SIGKILL */ 
</span><a name="LN262"></a>    <span class='Declare_Enum_Const'>STARTUP_CRASHED</span> 
<a name="LN263"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>StartupStatusEnum</span><span class='Delimiter'>; 
</span> 
<a name="LN265"></a><span class='Keyword'>static </span><a href="postmaster.c.html#LN257"><span class='Ref_to_Typedef'>StartupStatusEnum</span></a> <span class='Declare_Var'>StartupStatus</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN259"><span class='Ref_to_EnumConst'>STARTUP_NOT_RUNNING</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Startup/shutdown state */ 
</span><a name="LN268"></a><span class='Keyword'>#define</span>         <span class='Declare_Constant'>NoShutdown</span>      <span class='Number'>0</span> 
<a name="LN269"></a><span class='Keyword'>#define</span>         <span class='Declare_Constant'>SmartShutdown</span>   <span class='Number'>1</span> 
<a name="LN270"></a><span class='Keyword'>#define</span>         <span class='Declare_Constant'>FastShutdown</span>    <span class='Number'>2</span> 
<a name="LN271"></a><span class='Keyword'>#define</span>         <span class='Declare_Constant'>ImmediateShutdown</span>   <span class='Number'>3</span> 
 
<a name="LN273"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>Shutdown</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Delimiter'>; 
</span> 
<a name="LN275"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>FatalError</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* T if recovering from backend crash */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We use a simple state machine to control startup, shutdown, and 
 * crash recovery (which is rather like shutdown followed by startup). 
 * 
 * After doing all the postmaster initialization work, we enter PM_STARTUP 
 * state and the startup process is launched. The startup process begins by 
 * reading the control file and other preliminary initialization steps. 
 * In a normal startup, or after crash recovery, the startup process exits 
 * with exit code 0 and we switch to PM_RUN state.  However, archive recovery 
 * is handled specially since it takes much longer and we would like to support 
 * hot standby during archive recovery. 
 * 
 * When the startup process is ready to start archive recovery, it signals the 
 * postmaster, and we switch to PM_RECOVERY state. The background writer and 
 * checkpointer are launched, while the startup process continues applying WAL. 
 * If Hot Standby is enabled, then, after reaching a consistent point in WAL 
 * redo, startup process signals us again, and we switch to PM_HOT_STANDBY 
 * state and begin accepting connections to perform read-only queries.  When 
 * archive recovery is finished, the startup process exits with exit code 0 
 * and we switch to PM_RUN state. 
 * 
 * Normal child backends can only be launched when we are in PM_RUN or 
 * PM_HOT_STANDBY state.  (We also allow launch of normal 
 * child backends in PM_WAIT_BACKUP state, but only for superusers.) 
 * In other states we handle connection requests by launching "dead_end" 
 * child processes, which will simply send the client an error message and 
 * quit.  (We track these in the BackendList so that we can know when they 
 * are all gone; this is important because they're still connected to shared 
 * memory, and would interfere with an attempt to destroy the shmem segment, 
 * possibly leading to SHMALL failure when we try to make a new one.) 
 * In PM_WAIT_DEAD_END state we are waiting for all the dead_end children 
 * to drain out of the system, and therefore stop accepting connection 
 * requests at all until the last existing child has quit (which hopefully 
 * will not be very long). 
 * 
 * Notice that this state variable does not distinguish *why* we entered 
 * states later than PM_RUN --- Shutdown and FatalError must be consulted 
 * to find that out.  FatalError is never true in PM_RECOVERY_* or PM_RUN 
 * states, nor in PM_SHUTDOWN states (because we don't enter those states 
 * when trying to recover from a crash).  It can be true in PM_STARTUP state, 
 * because we don't clear it until we've successfully started WAL redo. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN321"></a>    <span class='Declare_Enum_Const'>PM_INIT</span><span class='Delimiter'>,</span>                    <span class='Comment_Single_Line'>/* postmaster starting */ 
</span><a name="LN322"></a>    <span class='Declare_Enum_Const'>PM_STARTUP</span><span class='Delimiter'>,</span>                 <span class='Comment_Single_Line'>/* waiting for startup subprocess */ 
</span><a name="LN323"></a>    <span class='Declare_Enum_Const'>PM_RECOVERY</span><span class='Delimiter'>,</span>                <span class='Comment_Single_Line'>/* in archive recovery mode */ 
</span><a name="LN324"></a>    <span class='Declare_Enum_Const'>PM_HOT_STANDBY</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* in hot standby mode */ 
</span><a name="LN325"></a>    <span class='Declare_Enum_Const'>PM_RUN</span><span class='Delimiter'>,</span>                     <span class='Comment_Single_Line'>/* normal "database is alive" state */ 
</span><a name="LN326"></a>    <span class='Declare_Enum_Const'>PM_WAIT_BACKUP</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* waiting for online backup mode to end */ 
</span><a name="LN327"></a>    <span class='Declare_Enum_Const'>PM_WAIT_READONLY</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* waiting for read only backends to exit */ 
</span><a name="LN328"></a>    <span class='Declare_Enum_Const'>PM_WAIT_BACKENDS</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* waiting for live backends to exit */ 
</span><a name="LN329"></a>    <span class='Declare_Enum_Const'>PM_SHUTDOWN</span><span class='Delimiter'>,</span>                <span class='Comment_Multi_Line'>/* waiting for checkpointer to do shutdown 
                                 * ckpt */ 
</span><a name="LN331"></a>    <span class='Declare_Enum_Const'>PM_SHUTDOWN_2</span><span class='Delimiter'>,</span>              <span class='Comment_Multi_Line'>/* waiting for archiver and walsenders to 
                                 * finish */ 
</span><a name="LN333"></a>    <span class='Declare_Enum_Const'>PM_WAIT_DEAD_END</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* waiting for dead_end children to exit */ 
</span><a name="LN334"></a>    <span class='Declare_Enum_Const'>PM_NO_CHILDREN</span>              <span class='Comment_Single_Line'>/* all important children have exited */ 
</span><a name="LN335"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>PMState</span><span class='Delimiter'>; 
</span> 
<a name="LN337"></a><span class='Keyword'>static </span><a href="postmaster.c.html#LN319"><span class='Ref_to_Typedef'>PMState</span></a> <span class='Declare_Var'>pmState</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN321"><span class='Ref_to_EnumConst'>PM_INIT</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Start time of SIGKILL timeout during immediate shutdown or child crash */ 
/* Zero means timeout is not running */ 
</span><a name="LN341"></a><span class='Keyword'>static </span>time_t <span class='Declare_Var'>AbortStartTime</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Comment_Multi_Line'>/* Length of said timeout */ 
</span><a name="LN343"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SIGKILL_CHILDREN_AFTER_SECS</span>     <span class='Number'>5</span> 
 
<a name="LN345"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>ReachedNormalRunning</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* T if we've reached PM_RUN */ 
</span> 
<a name="LN347"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>ClientAuthInProgress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>       <span class='Comment_Multi_Line'>/* T during new-client 
                                                 * authentication */ 
</span> 
<a name="LN350"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>redirection_done</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* stderr redirected for syslogger? */ 
</span> 
<span class='Comment_Multi_Line'>/* received START_AUTOVAC_LAUNCHER signal */ 
</span><a name="LN353"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>start_autovac_launcher</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* the launcher needs to be signalled to communicate some condition */ 
</span><a name="LN356"></a><span class='Keyword'>static volatile bool </span><span class='Declare_Var'>avlauncher_needs_signal</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* set when there's a worker that needs to be started up */ 
</span><a name="LN359"></a><span class='Keyword'>static volatile bool </span><span class='Declare_Var'>StartWorkerNeeded</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN360"></a><span class='Keyword'>static volatile bool </span><span class='Declare_Var'>HaveCrashedWorker</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> HAVE_STRONG_RANDOM 
<span class='Comment_Multi_Line'>/* 
 * State for assigning cancel keys. 
 * Also, the global MyCancelKey passes the cancel key assigned to a given 
 * backend from the postmaster to that backend (via fork). 
 */ 
</span><a name="LN368"></a><span class='Keyword'>static unsigned int </span><span class='Declare_Var'>random_seed</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN369"></a><span class='Keyword'>static </span><span class='Control'>struct</span> timeval <span class='Declare_Var'>random_start_time</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
<span class='Comment_Multi_Line'>/* Set when and if SSL has been initialized properly */ 
</span><a name="LN374"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>LoadedSSL</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> USE_BONJOUR 
<a name="LN378"></a><span class='Keyword'>static </span>DNSServiceRef <span class='Declare_Var'>bonjour_sdref</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * postmaster.c - function prototypes 
 */ 
</span><a name="LN384"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CloseServerPorts</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN385"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>unlink_external_pid_file</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN386"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>getInstallationPaths</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN387"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>checkDataDir</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN388"></a><span class='Keyword'>static </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ConnCreate</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>serverFd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN389"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ConnFree</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN390"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>reset_shared</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN391"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SIGHUP_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN392"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pmdie</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN393"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>reaper</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN394"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sigusr1_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN395"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>startup_die</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN396"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>dummy_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN397"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>StartupPacketTimeoutHandler</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN398"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CleanupBackend</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN399"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>CleanupBackgroundWorker</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN400"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>HandleChildCrash</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>procname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN401"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>LogChildExit</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>lev</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>procname</span><span class='Delimiter'>, 
</span><a name="LN402"></a>             <span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN403"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PostmasterStateMachine</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN404"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>BackendInitialize</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN405"></a><span class='Keyword'>static void </span><a href="postmaster.c.html#LN4263"><span class='Ref_to_Func'>BackendRun</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><a href="../../test/regress/pg_regress.c.html#LN88"><span class='Ref_to_Global_Var'>port</span></a><span class='Parentheses'>) </span><span class='Declare_Var'>pg_attribute_noreturn</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN406"></a><span class='Keyword'>static void </span><a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Keyword'>int </span><a href="../../bin/pg_ctl/pg_ctl.c.html#LN100"><span class='Ref_to_Global_Var'>status</span></a><span class='Parentheses'>) </span><span class='Declare_Var'>pg_attribute_noreturn</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN407"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>ServerLoop</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN408"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>BackendStartup</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN409"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>ProcessStartupPacket</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>SSLdone</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN410"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>processCancelRequest</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkt</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN411"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>initMasks</span><span class='Parentheses'>(</span>fd_set <span class='Operator'>*</span><span class='Declare_Parameter'>rmask</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN412"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>report_fork_failure_to_client</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>errnum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN413"></a><span class='Keyword'>static </span><a href="../../include/libpq/libpq-be.h.html#LN70"><span class='Ref_to_Enum'>CAC_state</span></a> <span class='Declare_Prototype'>canAcceptConnections</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN414"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>RandomCancelKey</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cancel_key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN415"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>signal_child</span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>signal</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN416"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>SignalSomeChildren</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>signal</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>targets</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN417"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>TerminateChildren</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>signal</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN419"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SignalChildren</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>sig</span><span class='Parentheses'>)</span>            <a href="postmaster.c.html#LN416"><span class='Ref_to_Proto'>SignalSomeChildren</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN419"><span class='Ref_to_Parameter'>sig</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN145"><span class='Ref_to_Const'>BACKEND_TYPE_ALL</span></a><span class='Parentheses'>) 
</span> 
<a name="LN421"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>CountChildren</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>target</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN422"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>assign_backendlist_entry</span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rw</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN423"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>maybe_start_bgworkers</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN424"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>CreateOptsFile</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[], </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fullprogname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN425"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>StartChildProcess</span><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN390"><span class='Ref_to_Typedef'>AuxProcType</span></a> <span class='Declare_Parameter'>type</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN426"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>StartAutovacuumWorker</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN427"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>InitPostmasterDeathWatchHandle</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Archiver is allowed to start up at the current postmaster state? 
 * 
 * If WAL archiving is enabled always, we are allowed to start archiver 
 * even during recovery. 
 */ 
</span><a name="LN435"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PgArchStartupAllowed</span><span class='Parentheses'>()</span>  <span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="../../include/access/xlog.h.html#LN133"><span class='Ref_to_Macro'>XLogArchivingActive</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Parentheses'>)</span> <span class='Operator'>||</span>    <span class='Operator'>\ 
</span>     <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN136"><span class='Ref_to_Macro'>XLogArchivingAlways</span></a><span class='Parentheses'>() </span><span class='Operator'>&&</span>  <span class='Operator'>\ 
</span>      <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Parentheses'>)))</span> 
 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN443"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WNOHANG</span> <span class='Number'>0</span>               <span class='Comment_Single_Line'>/* ignored, so any integer value will do */ 
</span> 
<a name="LN445"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>waitpid</span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>exitstatus</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN446"></a><span class='Keyword'>static void </span>WINAPI <span class='Declare_Prototype'>pgwin32_deadchild_callback</span><span class='Parentheses'>(</span>PVOID <span class='Declare_Parameter'>lpParameter</span><span class='Delimiter'>, </span>BOOLEAN <span class='Declare_Parameter'>TimerOrWaitFired</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN448"></a><span class='Keyword'>static </span>HANDLE <span class='Declare_Var'>win32ChildQueue</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN452"></a>    HANDLE      <span class='Declare_Member'>waitHandle</span><span class='Delimiter'>; 
</span><a name="LN453"></a>    HANDLE      <span class='Declare_Member'>procHandle</span><span class='Delimiter'>; 
</span><a name="LN454"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Member'>procId</span><span class='Delimiter'>; 
</span><a name="LN455"></a>} <span class='Declare_Typedef'>win32_deadchild_waitinfo</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<a name="LN458"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>backend_forkexec</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN459"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>internal_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[], </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Type for a socket that can be inherited to a client process */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN465"></a>    SOCKET      <span class='Declare_Member'>origsocket</span><span class='Delimiter'>;</span>     <span class='Comment_Multi_Line'>/* Original socket value, or PGINVALID_SOCKET 
                                 * if not a socket */ 
</span><a name="LN467"></a>    WSAPROTOCOL_INFO <span class='Declare_Member'>wsainfo</span><span class='Delimiter'>; 
</span><a name="LN468"></a>} <span class='Declare_Typedef'>InheritableSocket</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN470"></a><span class='Control'>typedef</span> <span class='Keyword'>int </span><span class='Declare_Typedef'>InheritableSocket</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Structure contains all variables passed to exec:ed backends 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN478"></a>    <a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a>        <span class='Declare_Member'>port</span><span class='Delimiter'>; 
</span><a name="LN479"></a>    <a href="postmaster.c.html#LN470"><span class='Ref_to_Typedef'>InheritableSocket</span></a> <span class='Declare_Member'>portsocket</span><span class='Delimiter'>; 
</span><a name="LN480"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>DataDir</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN481"></a>    <a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a>    <span class='Declare_Member'>ListenSocket</span><span class='Delimiter'>[</span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>]; 
</span><a name="LN482"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>MyCancelKey</span><span class='Delimiter'>; 
</span><a name="LN483"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>MyPMChildSlot</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN485"></a>    <span class='Keyword'>unsigned long </span><span class='Declare_Member'>UsedShmemSegID</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN487"></a>    HANDLE      <span class='Declare_Member'>UsedShmemSegID</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN489"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>UsedShmemSegAddr</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <a href="../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>ShmemLock</span><span class='Delimiter'>; 
</span><a name="LN491"></a>    <a href="../../include/access/transam.h.html#LN144"><span class='Ref_to_Typedef'>VariableCache</span></a> <span class='Declare_Member'>ShmemVariableCache</span><span class='Delimiter'>; 
</span><a name="LN492"></a>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>ShmemBackendArray</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> HAVE_SPINLOCKS 
<a name="LN494"></a>    <a href="../../include/storage/pg_sema.h.html#LN35"><span class='Ref_to_Typedef'>PGSemaphore</span></a> <span class='Operator'>*</span><span class='Declare_Member'>SpinlockSemaArray</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN496"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>NamedLWLockTrancheRequests</span><span class='Delimiter'>; 
</span><a name="LN497"></a>    <a href="../../include/storage/lwlock.h.html#LN93"><span class='Ref_to_Struct'>NamedLWLockTranche</span></a> <span class='Operator'>*</span><span class='Declare_Member'>NamedLWLockTrancheArray</span><span class='Delimiter'>; 
</span><a name="LN498"></a>    <a href="../../include/storage/lwlock.h.html#LN76"><span class='Ref_to_Union'>LWLockPadded</span></a> <span class='Operator'>*</span><span class='Declare_Member'>MainLWLockArray</span><span class='Delimiter'>; 
</span><a name="LN499"></a>    <a href="../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>ProcStructLock</span><span class='Delimiter'>; 
</span><a name="LN500"></a>    <a href="../../include/storage/proc.h.html#LN228"><span class='Ref_to_Struct'>PROC_HDR</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>ProcGlobal</span><span class='Delimiter'>; 
</span><a name="LN501"></a>    <a href="../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>AuxiliaryProcs</span><span class='Delimiter'>; 
</span><a name="LN502"></a>    <a href="../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>PreparedXactProcs</span><span class='Delimiter'>; 
</span><a name="LN503"></a>    <a href="../storage/ipc/pmsignal.c.html#LN61"><span class='Ref_to_Struct'>PMSignalData</span></a> <span class='Operator'>*</span><span class='Declare_Member'>PMSignalState</span><span class='Delimiter'>; 
</span><a name="LN504"></a>    <a href="postmaster.c.html#LN470"><span class='Ref_to_Typedef'>InheritableSocket</span></a> <span class='Declare_Member'>pgStatSock</span><span class='Delimiter'>; 
</span><a name="LN505"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Member'>PostmasterPid</span><span class='Delimiter'>; 
</span><a name="LN506"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>PgStartTime</span><span class='Delimiter'>; 
</span><a name="LN507"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>PgReloadTime</span><span class='Delimiter'>; 
</span><a name="LN508"></a>    <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a>   <span class='Declare_Member'>first_syslogger_file_time</span><span class='Delimiter'>; 
</span><a name="LN509"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>redirection_done</span><span class='Delimiter'>; 
</span><a name="LN510"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>IsBinaryUpgrade</span><span class='Delimiter'>; 
</span><a name="LN511"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>max_safe_fds</span><span class='Delimiter'>; 
</span><a name="LN512"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>MaxBackends</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN514"></a>    HANDLE      <span class='Declare_Member'>PostmasterHandle</span><span class='Delimiter'>; 
</span><a name="LN515"></a>    HANDLE      <span class='Declare_Member'>initial_signal_pipe</span><span class='Delimiter'>; 
</span><a name="LN516"></a>    HANDLE      <span class='Declare_Member'>syslogPipe</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><span class='Directive'>#else</span> 
<a name="LN518"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>postmaster_alive_fds</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN519"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>syslogPipe</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><span class='Directive'>#endif</span> 
<a name="LN521"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>my_exec_path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN522"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>pkglib_path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN523"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>ExtraOptions</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN524"></a>}<span class='Auto_Annotations'> &laquo; end {anonBackendParameters} &raquo; </span> <span class='Declare_Typedef'>BackendParameters</span><span class='Delimiter'>; 
</span> 
<a name="LN526"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>read_backend_variables</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>id</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN527"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>restore_backend_variables</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN530"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>save_backend_variables</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN532"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>save_backend_variables</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, 
</span><a name="LN533"></a>                       HANDLE <span class='Declare_Parameter'>childProcess</span><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>childPid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN536"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ShmemBackendArrayAdd</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN537"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ShmemBackendArrayRemove</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
<a name="LN540"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>StartupDataBase</span><span class='Parentheses'>()</span>       <a href="postmaster.c.html#LN425"><span class='Ref_to_Proto'>StartChildProcess</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN395"><span class='Ref_to_EnumConst'>StartupProcess</span></a><span class='Parentheses'>) 
</span><a name="LN541"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>StartBackgroundWriter</span><span class='Parentheses'>() </span><a href="postmaster.c.html#LN425"><span class='Ref_to_Proto'>StartChildProcess</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN396"><span class='Ref_to_EnumConst'>BgWriterProcess</span></a><span class='Parentheses'>) 
</span><a name="LN542"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>StartCheckpointer</span><span class='Parentheses'>()</span>     <a href="postmaster.c.html#LN425"><span class='Ref_to_Proto'>StartChildProcess</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN397"><span class='Ref_to_EnumConst'>CheckpointerProcess</span></a><span class='Parentheses'>) 
</span><a name="LN543"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>StartWalWriter</span><span class='Parentheses'>()</span>        <a href="postmaster.c.html#LN425"><span class='Ref_to_Proto'>StartChildProcess</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN398"><span class='Ref_to_EnumConst'>WalWriterProcess</span></a><span class='Parentheses'>) 
</span><a name="LN544"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>StartWalReceiver</span><span class='Parentheses'>()</span>      <a href="postmaster.c.html#LN425"><span class='Ref_to_Proto'>StartChildProcess</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN399"><span class='Ref_to_EnumConst'>WalReceiverProcess</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Macros to check exit status of a child process */ 
</span><a name="LN547"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>EXIT_STATUS_0</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>st</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Parameter'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<a name="LN548"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>EXIT_STATUS_1</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>st</span><span class='Parentheses'>)</span>  <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN41"><span class='Ref_to_Macro'>WIFEXITED</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN548"><span class='Ref_to_Parameter'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../timezone/private.h.html#LN44"><span class='Ref_to_Macro'>WEXITSTATUS</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN548"><span class='Ref_to_Parameter'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
<a name="LN549"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>EXIT_STATUS_3</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>st</span><span class='Parentheses'>)</span>  <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN41"><span class='Ref_to_Macro'>WIFEXITED</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN549"><span class='Ref_to_Parameter'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../timezone/private.h.html#LN44"><span class='Ref_to_Macro'>WEXITSTATUS</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN549"><span class='Ref_to_Parameter'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* 
 * File descriptors for pipe used to monitor if postmaster is alive. 
 * First is POSTMASTER_FD_WATCH, second is POSTMASTER_FD_OWN. 
 */ 
</span><a name="LN556"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>postmaster_alive_fds</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>}; 
</span><span class='Directive'>#else</span> 
<span class='Comment_Multi_Line'>/* Process handle of postmaster used for the same purpose on Windows */ 
</span><a name="LN559"></a>HANDLE      <span class='Declare_Var'>PostmasterHandle</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Postmaster main entry point 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN566"></a><span class='Declare_Function'>PostmasterMain</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN568"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>opt</span><span class='Delimiter'>; 
</span><a name="LN569"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN570"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>userDoption</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN571"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>listen_addr_saved</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN572"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN573"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>output_config_variable</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN86"><span class='Ref_to_Global_Var'>PostmasterPid</span></a> <span class='Operator'>= </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN99"><span class='Ref_to_Global_Var'>IsPostmasterEnvironment</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * for security, no dir or file created can be group or other accessible 
     */ 
</span>    umask<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN450"><span class='Ref_to_Const'>S_IRWXG</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN454"><span class='Ref_to_Const'>S_IRWXO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize random(3) so we don't get the same values in every run. 
     * 
     * Note: the seed is pretty predictable from externally-visible facts such 
     * as postmaster start time, so avoid using random() for security-critical 
     * random values during postmaster startup.  At the time of first 
     * connection, PostmasterRandom will select a hopefully-more-random seed. 
     */ 
</span>    <a href="../../port/srandom.c.html#LN20"><span class='Ref_to_Func'>srandom</span></a><span class='Parentheses'>((</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) (</span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a> <span class='Operator'>^ </span><a href="../utils/init/globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * By default, palloc() requests in the postmaster will be allocated in 
     * the PostmasterContext, which is space that can be recycled by backends. 
     * Allocated data that needs to be available to backends should be 
     * allocated in TopMemoryContext. 
     */ 
</span>    <a href="../utils/mmgr/mcxt.c.html#LN44"><span class='Ref_to_Global_Var'>PostmasterContext</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                              <span class='String'>"Postmaster"</span><span class='Delimiter'>, 
</span>                                              <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN44"><span class='Ref_to_Global_Var'>PostmasterContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize paths to installation files */ 
</span>    <a href="postmaster.c.html#LN386"><span class='Ref_to_Proto'>getInstallationPaths</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up signal handlers for the postmaster process. 
     * 
     * In the postmaster, we want to install non-ignored handlers *without* 
     * SA_RESTART.  This is because they'll be blocked at all times except 
     * when ServerLoop is waiting for something to happen, and during that 
     * window, we want signals to exit the select(2) wait so that ServerLoop 
     * can respond if anything interesting happened.  On some platforms, 
     * signals marked SA_RESTART would not cause the select() wait to end. 
     * Child processes will generally want SA_RESTART, but we expect them to 
     * set up their own handlers before unblocking signals. 
     * 
     * CAUTION: when changing this list, check for side-effects on the signal 
     * handling setup of child processes.  See tcop/postgres.c, 
     * bootstrap/bootstrap.c, postmaster/bgwriter.c, postmaster/walwriter.c, 
     * postmaster/autovacuum.c, postmaster/pgarch.c, postmaster/pgstat.c, 
     * postmaster/syslogger.c, postmaster/bgworker.c and 
     * postmaster/checkpointer.c. 
     */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN36"><span class='Ref_to_Proto'>pqinitmask</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN391"><span class='Ref_to_Proto'>SIGHUP_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Multi_Line'>/* reread config file 
                                                         * and have children do 
                                                         * same */ 
</span>    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="postmaster.c.html#LN392"><span class='Ref_to_Proto'>pmdie</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* send SIGTERM and shut down */ 
</span>    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN392"><span class='Ref_to_Proto'>pmdie</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* send SIGQUIT and die */ 
</span>    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="postmaster.c.html#LN392"><span class='Ref_to_Proto'>pmdie</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Multi_Line'>/* wait for children and shut 
                                                 * down */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN193"><span class='Ref_to_Const'>SIGALRM</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* ignored */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* ignored */ 
</span>    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN394"><span class='Ref_to_Proto'>sigusr1_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Multi_Line'>/* message from child 
                                                         * process */ 
</span>    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN396"><span class='Ref_to_Proto'>dummy_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Multi_Line'>/* unused, reserve for 
                                                         * children */ 
</span>    <a href="../../port/pqsignal.c.html#LN69"><span class='Ref_to_Func'>pqsignal_no_restart</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN393"><span class='Ref_to_Proto'>reaper</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* handle child termination */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN198"><span class='Ref_to_Const'>SIGTTIN</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* ignored */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN199"><span class='Ref_to_Const'>SIGTTOU</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* ignored */ 
</span>    <span class='Comment_Multi_Line'>/* ignore SIGXFSZ, so that ulimit violations work like disk full */ 
</span><span class='Directive'>#ifdef</span> SIGXFSZ 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGXFSZ<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* ignored */ 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Options setup 
     */ 
</span>    <a href="../../include/utils/guc.h.html#LN350"><span class='Ref_to_Proto'>InitializeGUCOptions</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/getopt.c.html#LN49"><span class='Ref_to_Global_Var'>opterr</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Parse command-line options.  CAUTION: keep this in sync with 
     * tcop/postgres.c (the option sets should not conflict) and with the 
     * common help() function in main/main.c. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN568"><span class='Ref_To_Local'>opt</span></a> <span class='Operator'>= </span><a href="../../include/pg_getopt.h.html#LN42"><span class='Ref_to_Proto'>getopt</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"B:bc:C:D:d:EeFf:h:ijk:lN:nOo:Pp:r:S:sTt:W:-:"</span><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN568"><span class='Ref_To_Local'>opt</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'B'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"shared_buffers"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'b'</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* Undocumented flag used for binary upgrades */ 
</span>                <a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'C'</span><span class='Operator'>: 
</span>                <a href="postmaster.c.html#LN573"><span class='Ref_To_Local'>output_config_variable</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>: 
</span>                <a href="postmaster.c.html#LN570"><span class='Ref_To_Local'>userDoption</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'d'</span><span class='Operator'>: 
</span>                <a href="../../include/tcop/tcopprot.h.html#LN85"><span class='Ref_to_Proto'>set_debug_options</span></a><span class='Parentheses'>(</span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'E'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"log_statement"</span><span class='Delimiter'>, </span><span class='String'>"all"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'e'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"datestyle"</span><span class='Delimiter'>, </span><span class='String'>"euro"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'F'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"fsync"</span><span class='Delimiter'>, </span><span class='String'>"false"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'f'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/tcop/tcopprot.h.html#LN87"><span class='Ref_to_Proto'>set_plan_disabling_options</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: invalid argument for option -f: \"%s\"\n"</span><span class='Delimiter'>, 
</span>                                 <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'h'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"listen_addresses"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'i'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"listen_addresses"</span><span class='Delimiter'>, </span><span class='String'>"*"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'j'</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* only used by interactive backend */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'k'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"unix_socket_directories"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'l'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"ssl"</span><span class='Delimiter'>, </span><span class='String'>"true"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'N'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"max_connections"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'n'</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* Don't reinit shared mem after abnormal exit */ 
</span>                <a href="postmaster.c.html#LN228"><span class='Ref_to_Global_Var'>Reinit</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'O'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"allow_system_table_mods"</span><span class='Delimiter'>, </span><span class='String'>"true"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'o'</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* Other options to pass to the backend on the command line */ 
</span>                <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <span class='String'>" %s"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'P'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"ignore_system_indexes"</span><span class='Delimiter'>, </span><span class='String'>"true"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'p'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"port"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'r'</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* only used by single-user backend */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'S'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"work_mem"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'s'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"log_statement_stats"</span><span class='Delimiter'>, </span><span class='String'>"true"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'T'</span><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * In the event that some backend dumps core, send SIGSTOP, 
                 * rather than SIGQUIT, to all its peers.  This lets the wily 
                 * post_hacker collect core dumps from everyone. 
                 */ 
</span>                <a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'t'</span><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN783"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>tmp</span> <span class='Operator'>= </span><a href="../../include/tcop/tcopprot.h.html#LN89"><span class='Ref_to_Proto'>get_stats_option_name</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN783"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN783"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>, </span><span class='String'>"true"</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: invalid argument for option -t: \"%s\"\n"</span><span class='Delimiter'>, 
</span>                                     <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
            <span class='Control'>case</span> <span class='String'>'W'</span><span class='Operator'>: 
</span>                <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"post_auth_delay"</span><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <span class='String'>'c'</span><span class='Operator'>: 
</span>            <span class='Control'>case</span> <span class='String'>'-'</span><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN805"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>, 
</span><a name="LN806"></a>                               <span class='Operator'>*</span><span class='Declare_Local'>value</span><span class='Delimiter'>; 
</span> 
                    <a href="../../include/utils/guc.h.html#LN357"><span class='Ref_to_Proto'>ParseLongOption</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN805"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Keyword'>value</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN568"><span class='Ref_To_Local'>opt</span></a> <span class='Operator'>== </span><span class='String'>'-'</span><span class='Parentheses'>) 
</span>                            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"--%s requires a value"</span><span class='Delimiter'>, 
</span>                                            <a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                        <span class='Control'>else</span> 
                            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"-c %s requires a value"</span><span class='Delimiter'>, 
</span>                                            <a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <a href="../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN805"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/guc.h.html#LN110"><span class='Ref_to_EnumConst'>PGC_S_ARGV</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN805"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>) 
</span>                        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><span class='Keyword'>value</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Delimiter'>, 
</span>                             <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch opt &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (opt=getopt(argc,argv... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Postmaster accepts no non-option switch arguments. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: invalid argument: \"%s\"\n"</span><span class='Delimiter'>, 
</span>                     <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Delimiter'>, 
</span>                     <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Locate the proper configuration files and data directory, and read 
     * postgresql.conf for the first time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/guc.h.html#LN351"><span class='Ref_to_Proto'>SelectConfigFiles</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN570"><span class='Ref_To_Local'>userDoption</span></a><span class='Delimiter'>, </span><a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>))</span> 
        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN573"><span class='Ref_To_Local'>output_config_variable</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * "-C guc" was specified, so print GUC's value and exit.  No extra 
         * permission check is needed because the user is reading inside the 
         * data dir. 
         */ 
</span><a name="LN863"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>config_val</span> <span class='Operator'>= </span><a href="../../include/utils/guc.h.html#LN346"><span class='Ref_to_Proto'>GetConfigOption</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN573"><span class='Ref_To_Local'>output_config_variable</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        puts<span class='Parentheses'>(</span><a href="postmaster.c.html#LN863"><span class='Ref_To_Local'>config_val</span></a> <span class='Operator'>? </span><a href="postmaster.c.html#LN863"><span class='Ref_To_Local'>config_val</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Verify that DataDir looks reasonable */ 
</span>    <a href="postmaster.c.html#LN387"><span class='Ref_to_Proto'>checkDataDir</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And switch working directory into it */ 
</span>    <a href="../utils/init/miscinit.c.html#LN113"><span class='Ref_to_Func'>ChangeToDataDir</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for invalid combinations of GUC settings. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN210"><span class='Ref_to_Global_Var'>ReservedBackends</span></a> <span class='Operator'>&GT;= </span><a href="../utils/init/globals.c.html#LN123"><span class='Ref_to_Global_Var'>MaxConnections</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: superuser_reserved_connections must be less than max_connections\n"</span><span class='Delimiter'>, </span><a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN119"><span class='Ref_to_Global_Var'>max_wal_senders</span></a> <span class='Operator'>&GT;= </span><a href="../utils/init/globals.c.html#LN123"><span class='Ref_to_Global_Var'>MaxConnections</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: max_wal_senders must be less than max_connections\n"</span><span class='Delimiter'>, </span><a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../access/transam/xlog.c.html#LN93"><span class='Ref_to_Global_Var'>XLogArchiveMode</span></a> <span class='Operator'>&GT; </span><a href="../../include/access/xlog.h.html#LN116"><span class='Ref_to_EnumConst'>ARCHIVE_MODE_OFF</span></a> <span class='Operator'>&& </span><a href="../access/transam/xlog.c.html#LN103"><span class='Ref_to_Global_Var'>wal_level</span></a> <span class='Operator'>== </span><a href="../../include/access/xlog.h.html#LN125"><span class='Ref_to_EnumConst'>WAL_LEVEL_MINIMAL</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"WAL archival cannot be enabled when wal_level is \"minimal\""</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN119"><span class='Ref_to_Global_Var'>max_wal_senders</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="../access/transam/xlog.c.html#LN103"><span class='Ref_to_Global_Var'>wal_level</span></a> <span class='Operator'>== </span><a href="../../include/access/xlog.h.html#LN125"><span class='Ref_to_EnumConst'>WAL_LEVEL_MINIMAL</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"WAL streaming (max_wal_senders &GT; 0) requires wal_level \"replica\" or \"logical\""</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Other one-time internal sanity checks can go here, if they are fast. 
     * (Put any slow processing further down, after postmaster.pid creation.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../interfaces/ecpg/pgtypeslib/dt.h.html#LN319"><span class='Ref_to_Proto'>CheckDateTokenTables</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: invalid datetoken tables, please fix\n"</span><span class='Delimiter'>, </span><a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we are done processing the postmaster arguments, reset 
     * getopt(3) library so that it will work correctly in subprocesses. 
     */ 
</span>    <a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_INT_OPTRESET 
    <a href="../../include/pg_getopt.h.html#LN38"><span class='Ref_to_Global_Var'>optreset</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* some systems need this too */ 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* For debugging: display postmaster environment */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN917"></a>        <span class='Keyword'>extern char </span><span class='Operator'>**</span><span class='Declare_Local'>environ</span><span class='Delimiter'>; 
</span><a name="LN918"></a>        <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s: PostmasterMain: initial environment dump:"</span><span class='Delimiter'>, 
</span>                             <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"-----------------------------------------"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN918"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN917"><span class='Ref_to_Global_Var'>environ</span></a><span class='Delimiter'>; </span><span class='Operator'>*</span><a href="postmaster.c.html#LN918"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="postmaster.c.html#LN918"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"\t%s"</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="postmaster.c.html#LN918"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"-----------------------------------------"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create lockfile for data directory. 
     * 
     * We want to do this before we try to grab the input sockets, because the 
     * data directory interlock is more reliable than the socket-file 
     * interlock (thanks to whoever decided to put socket files in /tmp :-(). 
     * For the same reason, it's best to grab the TCP socket(s) before the 
     * Unix socket(s). 
     * 
     * Also note that this internally sets up the on_proc_exit function that 
     * is responsible for removing both data directory and socket lockfiles; 
     * so it must happen before opening sockets so that at exit, the socket 
     * lockfiles go away after CloseServerPorts runs. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN458"><span class='Ref_to_Proto'>CreateDataDirLockFile</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize SSL library, if specified. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN232"><span class='Ref_to_Global_Var'>EnableSSL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../libpq/be-secure.c.html#LN71"><span class='Ref_to_Func'>secure_initialize</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN374"><span class='Ref_to_Global_Var'>LoadedSSL</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Register the apply launcher.  Since it registers a background worker, 
     * it needs to be called before InitializeMaxBackends(), and it's probably 
     * a good idea to call it before any modules had chance to take the 
     * background worker slots. 
     */ 
</span>    <a href="../../include/replication/logicallauncher.h.html#LN17"><span class='Ref_to_Proto'>ApplyLauncherRegister</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * process any libraries that should be preloaded at postmaster start 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN465"><span class='Ref_to_Proto'>process_shared_preload_libraries</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that loadable modules have had their chance to register background 
     * workers, calculate MaxBackends. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN421"><span class='Ref_to_Proto'>InitializeMaxBackends</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Establish input sockets. 
     * 
     * First, mark them all closed, and set up an on_proc_exit function that's 
     * charged with closing the sockets again at postmaster shutdown. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN572"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN572"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>; </span><a href="postmaster.c.html#LN572"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN572"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/ipc.h.html#LN68"><span class='Ref_to_Proto'>on_proc_exit</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN384"><span class='Ref_to_Proto'>CloseServerPorts</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN199"><span class='Ref_to_Global_Var'>ListenAddresses</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN991"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rawstring</span><span class='Delimiter'>; 
</span><a name="LN992"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>elemlist</span><span class='Delimiter'>; 
</span><a name="LN993"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span><a name="LN994"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>success</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a modifiable copy of ListenAddresses */ 
</span>        <a href="postmaster.c.html#LN991"><span class='Ref_To_Local'>rawstring</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN199"><span class='Ref_to_Global_Var'>ListenAddresses</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Parse string into list of hostnames */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/varlena.h.html#LN29"><span class='Ref_to_Proto'>SplitIdentifierString</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN991"><span class='Ref_To_Local'>rawstring</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN992"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* syntax error in list */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid list syntax in parameter \"%s\""</span><span class='Delimiter'>, 
</span>                            <span class='String'>"listen_addresses"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN993"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN992"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1011"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curhost</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN993"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1011"><span class='Ref_To_Local'>curhost</span></a><span class='Delimiter'>, </span><span class='String'>"*"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN55"><span class='Ref_to_Proto'>StreamServerPort</span></a><span class='Parentheses'>(</span>AF_UNSPEC<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Delimiter'>, 
</span>                                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN55"><span class='Ref_to_Proto'>StreamServerPort</span></a><span class='Parentheses'>(</span>AF_UNSPEC<span class='Delimiter'>, </span><a href="postmaster.c.html#LN1011"><span class='Ref_To_Local'>curhost</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Delimiter'>, 
</span>                                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                          <a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN994"><span class='Ref_To_Local'>success</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* record the first successful host addr in lockfile */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN571"><span class='Ref_To_Local'>listen_addr_saved</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../include/miscadmin.h.html#LN462"><span class='Ref_to_Proto'>AddToDataDirLockFile</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN455"><span class='Ref_to_Const'>LOCK_FILE_LINE_LISTEN_ADDR</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1011"><span class='Ref_To_Local'>curhost</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="postmaster.c.html#LN571"><span class='Ref_To_Local'>listen_addr_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create listen socket for \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="postmaster.c.html#LN1011"><span class='Ref_To_Local'>curhost</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN994"><span class='Ref_To_Local'>success</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN992"><span class='Ref_To_Local'>elemlist</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create any TCP/IP sockets"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN992"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN991"><span class='Ref_To_Local'>rawstring</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ListenAddresses &raquo; </span> 
 
<span class='Directive'>#ifdef</span> USE_BONJOUR 
    <span class='Comment_Multi_Line'>/* Register for Bonjour only if we opened TCP socket(s) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN241"><span class='Ref_to_Global_Var'>enable_bonjour</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1052"></a>        DNSServiceErrorType <span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We pass 0 for interface_index, which will result in registering on 
         * all "applicable" interfaces.  It's not entirely clear from the 
         * DNS-SD docs whether this would be appropriate if we have bound to 
         * just a subset of the available network interfaces. 
         */ 
</span>        <a href="postmaster.c.html#LN1052"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>= </span>DNSServiceRegister<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN378"><span class='Ref_to_Global_Var'>bonjour_sdref</span></a><span class='Delimiter'>, 
</span>                                 <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                 <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                 <a href="postmaster.c.html#LN242"><span class='Ref_to_Global_Var'>bonjour_name</span></a><span class='Delimiter'>, 
</span>                                 <span class='String'>"_postgresql._tcp."</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 htons<span class='Parentheses'>(</span><a href="postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                 <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1052"><span class='Ref_To_Local'>err</span></a> <span class='Operator'>!= </span>kDNSServiceErr_NoError<span class='Parentheses'>) 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"DNSServiceRegister() failed: error code %ld"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN1052"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't bother to read the mDNS daemon's reply, and we expect that 
         * it will automatically terminate our registration when the socket is 
         * closed at postmaster termination.  So there's nothing more to be 
         * done here.  However, the bonjour_sdref is kept around so that 
         * forked children can close their copies of the socket. 
         */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if enable_bonjour&&Liste... &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> HAVE_UNIX_SOCKETS 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN196"><span class='Ref_to_Global_Var'>Unix_socket_directories</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1089"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rawstring</span><span class='Delimiter'>; 
</span><a name="LN1090"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>elemlist</span><span class='Delimiter'>; 
</span><a name="LN1091"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span><a name="LN1092"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>success</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a modifiable copy of Unix_socket_directories */ 
</span>        <a href="postmaster.c.html#LN1089"><span class='Ref_To_Local'>rawstring</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN196"><span class='Ref_to_Global_Var'>Unix_socket_directories</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Parse string into list of directories */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/varlena.h.html#LN31"><span class='Ref_to_Proto'>SplitDirectoriesString</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1089"><span class='Ref_To_Local'>rawstring</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1090"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* syntax error in list */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid list syntax in parameter \"%s\""</span><span class='Delimiter'>, 
</span>                            <span class='String'>"unix_socket_directories"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1091"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1090"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1109"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>socketdir</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1091"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq.h.html#LN55"><span class='Ref_to_Proto'>StreamServerPort</span></a><span class='Parentheses'>(</span>AF_UNIX<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Delimiter'>, 
</span>                                      <a href="postmaster.c.html#LN1109"><span class='Ref_To_Local'>socketdir</span></a><span class='Delimiter'>, 
</span>                                      <a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN1092"><span class='Ref_To_Local'>success</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* record the first successful Unix socket in lockfile */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1092"><span class='Ref_To_Local'>success</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="../../include/miscadmin.h.html#LN462"><span class='Ref_to_Proto'>AddToDataDirLockFile</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN454"><span class='Ref_to_Const'>LOCK_FILE_LINE_SOCKET_DIR</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1109"><span class='Ref_To_Local'>socketdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create Unix-domain socket in directory \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="postmaster.c.html#LN1109"><span class='Ref_To_Local'>socketdir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN1092"><span class='Ref_To_Local'>success</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN1090"><span class='Ref_To_Local'>elemlist</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create any Unix-domain sockets"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN266"><span class='Ref_to_Proto'>list_free_deep</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1090"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1089"><span class='Ref_To_Local'>rawstring</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if Unix_socket_directori... &raquo; </span> 
<span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * check that we have some socket to listen on 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no socket created for listening"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If no valid TCP ports, write an empty line for listen address, 
     * indicating the Unix socket must be used.  Note that this line is not 
     * added to the lock file until there is a socket backing it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN571"><span class='Ref_To_Local'>listen_addr_saved</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/miscadmin.h.html#LN462"><span class='Ref_to_Proto'>AddToDataDirLockFile</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN455"><span class='Ref_to_Const'>LOCK_FILE_LINE_LISTEN_ADDR</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up shared memory and semaphores. 
     */ 
</span>    <a href="postmaster.c.html#LN390"><span class='Ref_to_Proto'>reset_shared</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Estimate number of openable files.  This must happen after setting up 
     * semaphores, because on some platforms semaphores count as open files. 
     */ 
</span>    <a href="../../include/storage/fd.h.html#LN104"><span class='Ref_to_Proto'>set_max_safe_fds</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set reference point for stack-depth checking. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN273"><span class='Ref_to_Proto'>set_stack_base</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize pipe (or process handle on Windows) that allows children to 
     * wake up from sleep on postmaster death. 
     */ 
</span>    <a href="postmaster.c.html#LN427"><span class='Ref_to_Proto'>InitPostmasterDeathWatchHandle</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * Initialize I/O completion port used to deliver list of dead children. 
     */ 
</span>    <a href="postmaster.c.html#LN448"><span class='Ref_to_Global_Var'>win32ChildQueue</span></a> <span class='Operator'>= </span>CreateIoCompletionPort<span class='Parentheses'>(</span>INVALID_HANDLE_VALUE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN448"><span class='Ref_to_Global_Var'>win32ChildQueue</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>           <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create I/O completion port for child queue"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Record postmaster options.  We delay this till now to avoid recording 
     * bogus options (eg, NBuffers too high for available memory). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN424"><span class='Ref_to_Proto'>CreateOptsFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN566"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Parentheses'>))</span> 
        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Comment_Multi_Line'>/* Write out nondefault GUC settings for child processes to use */ 
</span>    <a href="../../include/utils/guc.h.html#LN385"><span class='Ref_to_Proto'>write_nondefault_variables</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN70"><span class='Ref_to_EnumConst'>PGC_POSTMASTER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Write the external PID file if requested 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1203"></a>        FILE       <span class='Operator'>*</span><span class='Declare_Local'>fpidfile</span> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1203"><span class='Ref_To_Local'>fpidfile</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1203"><span class='Ref_To_Local'>fpidfile</span></a><span class='Delimiter'>, </span><span class='String'>"%d\n"</span><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            fclose<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1203"><span class='Ref_To_Local'>fpidfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Make PID file world readable */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>chmod<span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN447"><span class='Ref_to_Const'>S_IRGRP</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN451"><span class='Ref_to_Const'>S_IROTH</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: could not change permissions of external PID file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                             <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: could not write external PID file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                         <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/ipc.h.html#LN68"><span class='Ref_to_Proto'>on_proc_exit</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN385"><span class='Ref_to_Proto'>unlink_external_pid_file</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if external_pid_file &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Remove old temporary files.  At this point there can be no other 
     * Postgres processes running in this directory, so this should be safe. 
     */ 
</span>    <a href="../../include/storage/fd.h.html#LN112"><span class='Ref_to_Proto'>RemovePgTempFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Forcibly remove the files signaling a standby promotion request. 
     * Otherwise, the existence of those files triggers a promotion too early, 
     * whether a user wants that or not. 
     * 
     * This removal of files is usually unnecessary because they can exist 
     * only during a few moments during a standby promotion. However there is 
     * a race condition: if pg_ctl promote is executed and creates the files 
     * during a promotion, the files can stay around even after the server is 
     * brought up to new master. Then, if new standby starts by using the 
     * backup taken from that master, the files can exist at the server 
     * startup and should be removed in order to avoid an unexpected 
     * promotion. 
     * 
     * Note that promotion signal files need to be removed before the startup 
     * process is invoked. Because, after that, they can be used by 
     * postmaster's SIGUSR1 signal handler. 
     */ 
</span>    <a href="../../include/access/xlog.h.html#LN278"><span class='Ref_to_Proto'>RemovePromoteSignalFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove any outdated file holding the current log filenames. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/syslogger.h.html#LN93"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/postmaster/syslogger.h.html#LN93"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If enabled, start up syslogger collection subprocess 
     */ 
</span>    <a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/syslogger.h.html#LN81"><span class='Ref_to_Proto'>SysLogger_Start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset whereToSendOutput from DestDebug (its starting state) to 
     * DestNone. This stops ereport from sending log messages to stderr unless 
     * Log_destination permits.  We don't do this until the postmaster is 
     * fully launched, since startup failures may as well be reported to 
     * stderr. 
     * 
     * If we are in fact disabling logging to stderr, first emit a log message 
     * saying so, to provide a breadcrumb trail for users who may not remember 
     * that their logging is configured to go somewhere else. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN105"><span class='Ref_to_Global_Var'>Log_destination</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ending log output to stderr"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Future log output will go to log destination \"%s\"."</span><span class='Delimiter'>, 
</span>                      <a href="../utils/error/elog.c.html#LN106"><span class='Ref_to_Global_Var'>Log_destination_string</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../tcop/postgres.c.html#LN87"><span class='Ref_to_Global_Var'>whereToSendOutput</span></a> <span class='Operator'>= </span><a href="../../include/tcop/dest.h.html#LN87"><span class='Ref_to_EnumConst'>DestNone</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize stats collection subsystem (this does NOT start the 
     * collector process!) 
     */ 
</span>    <a href="pgstat.c.html#LN353"><span class='Ref_to_Func'>pgstat_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the autovacuum subsystem (again, no process start yet) 
     */ 
</span>    <a href="../../include/postmaster/autovacuum.h.html#LN56"><span class='Ref_to_Proto'>autovac_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Load configuration files for client authentication. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/libpq/hba.h.html#LN114"><span class='Ref_to_Proto'>load_hba</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * It makes no sense to continue if we fail to load the HBA file, 
         * since there is no way to connect to the database in this case. 
         */ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load pg_hba.conf"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/libpq/hba.h.html#LN115"><span class='Ref_to_Proto'>load_ident</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We can start up without the IDENT file, although it means that you 
         * cannot log in using any of the authentication methods that need a 
         * user name mapping. load_ident() already logged the details of error 
         * to the log. 
         */ 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> HAVE_PTHREAD_IS_THREADED_NP 
 
    <span class='Comment_Multi_Line'>/* 
     * On macOS, libintl replaces setlocale() with a version that calls 
     * CFLocaleCopyCurrent() when its second argument is "" and every relevant 
     * environment variable is unset or empty.  CFLocaleCopyCurrent() makes 
     * the process multithreaded.  The postmaster calls sigprocmask() and 
     * calls fork() without an immediate exec(), both of which have undefined 
     * behavior in a multithreaded program.  A multithreaded postmaster is the 
     * normal case on Windows, which offers neither fork() nor sigprocmask(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>pthread_is_threaded_np<span class='Parentheses'>() </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"postmaster became multithreaded during startup"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Set the LC_ALL environment variable to a valid locale."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Remember postmaster startup time 
     */ 
</span>    <a href="../utils/adt/timestamp.c.html#LN48"><span class='Ref_to_Global_Var'>PgStartTime</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> HAVE_STRONG_RANDOM 
    <span class='Comment_Multi_Line'>/* RandomCancelKey wants its own copy */ 
</span>    <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN369"><span class='Ref_to_Global_Var'>random_start_time</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We're ready to rock and roll... 
     */ 
</span>    <a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN540"><span class='Ref_to_Macro'>StartupDataBase</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN260"><span class='Ref_to_EnumConst'>STARTUP_RUNNING</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Some workers may be scheduled to start now */ 
</span>    <a href="postmaster.c.html#LN423"><span class='Ref_to_Proto'>maybe_start_bgworkers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN407"><span class='Ref_to_Proto'>ServerLoop</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ServerLoop probably shouldn't ever return, but if it does, close down. 
     */ 
</span>    <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN569"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    abort<span class='Parentheses'>()</span><span class='Delimiter'>;</span>                    <span class='Comment_Single_Line'>/* not reached */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PostmasterMain &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * on_proc_exit callback to close server's listen sockets 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1365"></a><span class='Declare_Function'>CloseServerPorts</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1367"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, explicitly close all the socket FDs.  We used to just let this 
     * happen implicitly at postmaster exit, but it's better to close them 
     * before we remove the postmaster.pid lockfile; otherwise there's a race 
     * condition if a new postmaster wants to re-use the TCP port number. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN1367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>; </span><a href="postmaster.c.html#LN1367"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/libpq/libpq.h.html#LN59"><span class='Ref_to_Proto'>StreamClose</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Next, remove any filesystem entries for Unix sockets.  To avoid race 
     * conditions against incoming postmasters, this must happen after closing 
     * the sockets and before removing lock files. 
     */ 
</span>    <a href="../../include/libpq/libpq.h.html#LN61"><span class='Ref_to_Proto'>RemoveSocketFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't do anything about socket lock files here; those will be 
     * removed in a later on_proc_exit callback. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CloseServerPorts &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * on_proc_exit callback to delete external_pid_file 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1401"></a><span class='Declare_Function'>unlink_external_pid_file</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Parentheses'>) 
</span>        <a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="../utils/misc/guc.c.html#LN464"><span class='Ref_to_Global_Var'>external_pid_file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute and check the directory paths to files that are part of the 
 * installation (as deduced from the postgres executable's own location) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1413"></a><span class='Declare_Function'>getInstallationPaths</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1415"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>pdir</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Locate the postgres executable itself */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN96"><span class='Ref_to_Proto'>find_my_exec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1413"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"%s: could not locate my own executable path"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1413"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Comment_Multi_Line'>/* Locate executable backend before we change working directory */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN97"><span class='Ref_to_Proto'>find_other_exec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1413"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><span class='String'>"postgres"</span><span class='Delimiter'>, </span><a href="../../include/miscadmin.h.html#LN30"><span class='Ref_to_Const'>PG_BACKEND_VERSIONSTR</span></a><span class='Delimiter'>, 
</span>                        <a href="../utils/init/globals.c.html#LN67"><span class='Ref_to_Global_Var'>postgres_exec_path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s: could not locate matching postgres executable"</span><span class='Delimiter'>, 
</span>                        <a href="postmaster.c.html#LN1413"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Locate the pkglib directory --- this has to be set early in case we try 
     * to load any modules from it in response to postgresql.conf entries. 
     */ 
</span>    <a href="../../include/port.h.html#LN56"><span class='Ref_to_Proto'>get_pkglib_path</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify that there's a readable directory there; otherwise the Postgres 
     * installation is incomplete or corrupt.  (A typical cause of this 
     * failure is that the postgres executable has been moved or hardlinked to 
     * some directory that's not a sibling of the installation lib/ 
     * directory.) 
     */ 
</span>    <a href="postmaster.c.html#LN1415"><span class='Ref_To_Local'>pdir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1415"><span class='Ref_To_Local'>pdir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="../utils/init/globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"This may indicate an incomplete PostgreSQL installation, or that the file \"%s\" has been moved away from its proper location."</span><span class='Delimiter'>, 
</span>                         <a href="../utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1415"><span class='Ref_To_Local'>pdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * XXX is it worth similarly checking the share/ directory?  If the lib/ 
     * directory is there, then share/ probably is too. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end getInstallationPaths &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Validate the proposed data directory 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1464"></a><span class='Declare_Function'>checkDataDir</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1466"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1467"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span><a name="LN1468"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>stat_buf</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1468"><span class='Ref_To_Local'>stat_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"data directory \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                            <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read permissions of directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* eventual chdir would fail anyway, but let's test ... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1468"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"specified data directory \"%s\" is not a directory"</span><span class='Delimiter'>, 
</span>                        <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the directory belongs to my userid; if not, reject. 
     * 
     * This check is an essential part of the interlock that prevents two 
     * postmasters from starting in the same directory (see CreateLockFile()). 
     * Do not remove or weaken it. 
     * 
     * XXX can we safely enable this check on Windows? 
     */ 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>__CYGWIN__<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1468"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>!= </span>geteuid<span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"data directory \"%s\" has wrong ownership"</span><span class='Delimiter'>, 
</span>                        <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"The server must be started by the user that owns the data directory."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Check if the directory has group or world access.  If so, reject. 
     * 
     * It would be possible to allow weaker constraints (for example, allow 
     * group access) but we cannot make a general assumption that that is 
     * okay; for example there are platforms where nearly all users 
     * customarily belong to the same group.  Perhaps this test should be 
     * configurable. 
     * 
     * XXX temporarily suppress check when on Windows, because there may not 
     * be proper support for Unix-y file permissions.  Need to think of a 
     * reasonable check to apply on Windows. 
     */ 
</span><span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span>__CYGWIN__<span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1468"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN450"><span class='Ref_to_Const'>S_IRWXG</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN454"><span class='Ref_to_Const'>S_IRWXO</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"data directory \"%s\" has group or world access"</span><span class='Delimiter'>, 
</span>                        <a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Permissions should be u=rwx (0700)."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Look for PG_VERSION before looking for pg_control */ 
</span>    <a href="../../include/miscadmin.h.html#LN464"><span class='Ref_to_Proto'>ValidatePgVersion</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1466"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1466"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/global/pg_control"</span><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN1467"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1466"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../tools/entab/entab.c.html#LN12"><span class='Ref_to_Const'>PG_BINARY_R</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1467"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"%s: could not find the database system\n"</span> 
                     <span class='String'>"Expected to find it in the directory \"%s\",\n"</span> 
                     <span class='String'>"but could not open file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                     <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1466"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1467"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end checkDataDir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine how long should we let ServerLoop sleep. 
 * 
 * In normal conditions we wait at most one minute, to ensure that the other 
 * background tasks handled by ServerLoop get done even when no requests are 
 * arriving.  However, if there are background workers waiting to be started, 
 * we don't actually sleep so that they are quickly serviced.  Other exception 
 * cases are as shown in the code. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1560"></a><span class='Declare_Function'>DetermineSleepTime</span><span class='Parentheses'>(</span><span class='Control'>struct</span> timeval <span class='Operator'>* </span><span class='Declare_Parameter'>timeout</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1562"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>next_wakeup</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normal case: either there are no background workers at all, or we're in 
     * a shutdown sequence (during which we ignore bgworkers altogether). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>&& !</span><a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* time left to abort; clamp to 0 in case it already expired */ 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="postmaster.c.html#LN343"><span class='Ref_to_Const'>SIGKILL_CHILDREN_AFTER_SECS</span></a> <span class='Operator'>- 
</span>                <span class='Parentheses'>(</span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><span class='Number'>60</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1596"></a>        <a href="../../include/lib/ilist.h.html#LN238"><span class='Ref_to_Struct'>slist_mutable_iter</span></a> <span class='Declare_Local'>siter</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * When there are crashed bgworkers, we sleep just long enough that 
         * they are restarted when they request to be.  Scan the list to 
         * determine the minimum of all wakeup times according to most recent 
         * crash time and requested restart interval. 
         */ 
</span>        <a href="../../include/lib/ilist.h.html#LN715"><span class='Ref_to_Macro'>slist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1596"><span class='Ref_To_Local'>siter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="bgworker.c.html#LN42"><span class='Ref_to_Global_Var'>BackgroundWorkerList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1606"></a>            <a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rw</span><span class='Delimiter'>; 
</span><a name="LN1607"></a>            <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>this_wakeup</span><span class='Delimiter'>; 
</span> 
            <a href="postmaster.c.html#LN1606"><span class='Ref_To_Local'>rw</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN673"><span class='Ref_to_Macro'>slist_container</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a><span class='Delimiter'>, </span>rw_lnode<span class='Delimiter'>, </span><a href="postmaster.c.html#LN1596"><span class='Ref_To_Local'>siter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN240"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1606"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1606"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN92"><span class='Ref_to_Member'>bgw_restart_time</span></a> <span class='Operator'>== </span><a href="../../include/postmaster/bgworker.h.html#LN83"><span class='Ref_to_Const'>BGW_NEVER_RESTART</span></a> 
                <span class='Operator'>|| </span><a href="postmaster.c.html#LN1606"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN40"><span class='Ref_to_Member'>rw_terminate</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/postmaster/bgworker_internals.h.html#LN49"><span class='Ref_to_Proto'>ForgetBackgroundWorker</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN1596"><span class='Ref_To_Local'>siter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="postmaster.c.html#LN1607"><span class='Ref_To_Local'>this_wakeup</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1606"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a><span class='Delimiter'>, 
</span>                                     <span class='Number'>1000L</span> <span class='Operator'>* </span><a href="postmaster.c.html#LN1606"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN92"><span class='Ref_to_Member'>bgw_restart_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1562"><span class='Ref_To_Local'>next_wakeup</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="postmaster.c.html#LN1607"><span class='Ref_To_Local'>this_wakeup</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN1562"><span class='Ref_To_Local'>next_wakeup</span></a><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN1562"><span class='Ref_To_Local'>next_wakeup</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1607"><span class='Ref_To_Local'>this_wakeup</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HaveCrashedWorker &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1562"><span class='Ref_To_Local'>next_wakeup</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1630"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>secs</span><span class='Delimiter'>; 
</span><a name="LN1631"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>microsecs</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/timestamp.h.html#LN72"><span class='Ref_to_Proto'>TimestampDifference</span></a><span class='Parentheses'>(</span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1562"><span class='Ref_To_Local'>next_wakeup</span></a><span class='Delimiter'>, 
</span>                            <span class='Operator'>&</span><a href="postmaster.c.html#LN1630"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1631"><span class='Ref_To_Local'>microsecs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><a href="postmaster.c.html#LN1630"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><a href="postmaster.c.html#LN1631"><span class='Ref_To_Local'>microsecs</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ensure we don't exceed one minute */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>&GT; </span><span class='Number'>60</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><span class='Number'>60</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_sec <span class='Operator'>= </span><span class='Number'>60</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1560"><span class='Ref_to_Parameter'>timeout</span></a><span class='Operator'>-&GT;</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end DetermineSleepTime &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Main idle loop of postmaster 
 * 
 * NB: Needs to be called with signals blocked 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1658"></a><span class='Declare_Function'>ServerLoop</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1660"></a>    fd_set      <span class='Declare_Local'>readmask</span><span class='Delimiter'>; 
</span><a name="LN1661"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nSockets</span><span class='Delimiter'>; 
</span><a name="LN1662"></a>    time_t      <span class='Declare_Local'>last_lockfile_recheck_time</span><span class='Delimiter'>, 
</span><a name="LN1663"></a>                <span class='Declare_Local'>last_touch_time</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN1662"><span class='Ref_To_Local'>last_lockfile_recheck_time</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1663"><span class='Ref_To_Local'>last_touch_time</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN1661"><span class='Ref_To_Local'>nSockets</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN411"><span class='Ref_to_Proto'>initMasks</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN1660"><span class='Ref_To_Local'>readmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1671"></a>        fd_set      <span class='Declare_Local'>rmask</span><span class='Delimiter'>; 
</span><a name="LN1672"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>selres</span><span class='Delimiter'>; 
</span><a name="LN1673"></a>        time_t      <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Wait for a connection request to arrive. 
         * 
         * We block all signals except while sleeping. That makes it safe for 
         * signal handlers, which again block all signals while executing, to 
         * do nontrivial work. 
         * 
         * If we are in PM_WAIT_DEAD_END state, then we don't want to accept 
         * any new connections, so we don't call select(), and just sleep. 
         */ 
</span>        memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1671"><span class='Ref_To_Local'>rmask</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1660"><span class='Ref_To_Local'>readmask</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>fd_set<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN333"><span class='Ref_to_EnumConst'>PM_WAIT_DEAD_END</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>100000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* 100 msec seems reasonable */ 
</span>            <a href="postmaster.c.html#LN1672"><span class='Ref_To_Local'>selres</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* must set timeout each time; some OSes change it! */ 
</span><a name="LN1699"></a>            <span class='Control'>struct</span> timeval <span class='Declare_Local'>timeout</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Needs to run with blocked signals! */ 
</span>            <a href="postmaster.c.html#LN1559"><span class='Ref_to_Func'>DetermineSleepTime</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN1699"><span class='Ref_To_Local'>timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="postmaster.c.html#LN1672"><span class='Ref_To_Local'>selres</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1661"><span class='Ref_To_Local'>nSockets</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1671"><span class='Ref_To_Local'>rmask</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1699"><span class='Ref_To_Local'>timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Now check the select() result */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1672"><span class='Ref_To_Local'>selres</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span><a href="../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"select() failed in postmaster: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * New connection pending on any of our sockets? If so, fork a child 
         * process to deal with it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1672"><span class='Ref_To_Local'>selres</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1729"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1729"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN1729"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>; </span><a href="postmaster.c.html#LN1729"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1729"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>FD_ISSET<span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1729"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1671"><span class='Ref_To_Local'>rmask</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span><a name="LN1737"></a>                    <a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>port</span><span class='Delimiter'>; 
</span> 
                    <a href="postmaster.c.html#LN1737"><span class='Ref_To_Local'>port</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN388"><span class='Ref_to_Proto'>ConnCreate</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1729"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1737"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="postmaster.c.html#LN408"><span class='Ref_to_Proto'>BackendStartup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1737"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * We no longer need the open socket or port structure 
                         * in this process 
                         */ 
</span>                        <a href="../../include/libpq/libpq.h.html#LN59"><span class='Ref_to_Proto'>StreamClose</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1737"><span class='Ref_To_Local'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="postmaster.c.html#LN389"><span class='Ref_to_Proto'>ConnFree</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1737"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;MAXLISTEN;i++ &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if selres&GT;0 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* If we have lost the log collector, try to start a new one */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="syslogger.c.html#LN62"><span class='Ref_to_Global_Var'>Logging_collector</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/syslogger.h.html#LN81"><span class='Ref_to_Proto'>SysLogger_Start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If no background writer process is running, and we are not in a 
         * state that prevents it, start one.  It doesn't matter if this 
         * fails, we'll just try again later.  Likewise for the checkpointer. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>|| 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN542"><span class='Ref_to_Macro'>StartCheckpointer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN541"><span class='Ref_to_Macro'>StartBackgroundWriter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Likewise, if we have lost the walwriter process, try to start a new 
         * one.  But this is needed only in normal operation (else we cannot 
         * be writing any new WAL). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN543"><span class='Ref_to_Macro'>StartWalWriter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we have lost the autovacuum launcher, try to start a new one. We 
         * don't want autovacuum to run in binary upgrade mode because 
         * autovacuum might update relfrozenxid for empty tables before the 
         * physical files are put in place. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="../../include/postmaster/autovacuum.h.html#LN48"><span class='Ref_to_Proto'>AutoVacuumingActive</span></a><span class='Parentheses'>() </span><span class='Operator'>|| </span><a href="postmaster.c.html#LN353"><span class='Ref_to_Global_Var'>start_autovac_launcher</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/autovacuum.h.html#LN57"><span class='Ref_to_Proto'>StartAutoVacLauncher</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN353"><span class='Ref_to_Global_Var'>start_autovac_launcher</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* signal processed */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If we have lost the stats collector, try to start a new one */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Parentheses'>))</span> 
            <a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN725"><span class='Ref_to_Func'>pgstat_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we have lost the archiver, try to start a new one. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN435"><span class='Ref_to_Macro'>PgArchStartupAllowed</span></a><span class='Parentheses'>())</span> 
            <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/pgarch.h.html#LN32"><span class='Ref_to_Proto'>pgarch_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we need to signal the autovacuum launcher, do so now */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN356"><span class='Ref_to_Global_Var'>avlauncher_needs_signal</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN356"><span class='Ref_to_Global_Var'>avlauncher_needs_signal</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Get other worker processes running, if needed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN423"><span class='Ref_to_Proto'>maybe_start_bgworkers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_PTHREAD_IS_THREADED_NP 
 
        <span class='Comment_Multi_Line'>/* 
         * With assertions enabled, check regularly for appearance of 
         * additional threads.  All builds check at start and exit. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span>pthread_is_threaded_np<span class='Parentheses'>() </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Lastly, check to see if it's time to do some things that we don't 
         * want to do every single time through the loop, because they're a 
         * bit expensive.  Note that there's up to a minute of slop in when 
         * these tasks will be performed, since DetermineSleepTime() will let 
         * us sleep at most that long; except for SIGKILL timeout which has 
         * special-case logic there. 
         */ 
</span>        <a href="postmaster.c.html#LN1673"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we already sent SIGQUIT to children and they are slow to shut 
         * down, it's time to send them SIGKILL.  This doesn't happen 
         * normally, but under certain conditions backends can get stuck while 
         * shutting down.  This is a last measure to get them unwedged. 
         * 
         * Note we also do this during recovery from a process crash. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>&& !</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1673"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>- </span><a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN343"><span class='Ref_to_Const'>SIGKILL_CHILDREN_AFTER_SECS</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We were gentle with them before. Not anymore */ 
</span>            <a href="postmaster.c.html#LN417"><span class='Ref_to_Proto'>TerminateChildren</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN191"><span class='Ref_to_Const'>SIGKILL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* reset flag so we don't SIGKILL again */ 
</span>            <a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Once a minute, verify that postmaster.pid hasn't been removed or 
         * overwritten.  If it has, we force a shutdown.  This avoids having 
         * postmasters and child processes hanging around after their database 
         * is gone, and maybe causing problems if a new database cluster is 
         * created in the same place.  It also provides some protection 
         * against a DBA foolishly removing postmaster.pid and manually 
         * starting a new postmaster.  Data corruption is likely to ensue from 
         * that anyway, but we can minimize the damage by aborting ASAP. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1673"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>- </span><a href="postmaster.c.html#LN1662"><span class='Ref_To_Local'>last_lockfile_recheck_time</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span> <span class='Operator'>* </span><a href="../../include/datatype/timestamp.h.html#LN87"><span class='Ref_to_Const'>SECS_PER_MINUTE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN463"><span class='Ref_to_Proto'>RecheckDataDirLockFile</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"performing immediate shutdown because data directory lock file is invalid"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="postmaster.c.html#LN1662"><span class='Ref_To_Local'>last_lockfile_recheck_time</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1673"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Touch Unix socket and lock files every 58 minutes, to ensure that 
         * they are not removed by overzealous /tmp-cleaning tasks.  We assume 
         * no one runs cleaners with cutoff times of less than an hour ... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1673"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>- </span><a href="postmaster.c.html#LN1663"><span class='Ref_To_Local'>last_touch_time</span></a> <span class='Operator'>&GT;= </span><span class='Number'>58</span> <span class='Operator'>* </span><a href="../../include/datatype/timestamp.h.html#LN87"><span class='Ref_to_Const'>SECS_PER_MINUTE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/libpq/libpq.h.html#LN60"><span class='Ref_to_Proto'>TouchSocketFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/miscadmin.h.html#LN461"><span class='Ref_to_Proto'>TouchSocketLockFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN1663"><span class='Ref_To_Local'>last_touch_time</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1673"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ServerLoop &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialise the masks for select() for the ports we are listening on. 
 * Return the number of sockets to listen on. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1894"></a><span class='Declare_Function'>initMasks</span><span class='Parentheses'>(</span>fd_set <span class='Operator'>*</span><span class='Declare_Parameter'>rmask</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1896"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxsock</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1897"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    FD_ZERO<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1894"><span class='Ref_to_Parameter'>rmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1897"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN1897"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>; </span><a href="postmaster.c.html#LN1897"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1903"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN1897"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1903"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        FD_SET<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1903"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1894"><span class='Ref_to_Parameter'>rmask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1903"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN1896"><span class='Ref_To_Local'>maxsock</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN1896"><span class='Ref_To_Local'>maxsock</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1903"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="postmaster.c.html#LN1896"><span class='Ref_To_Local'>maxsock</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end initMasks &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Read a client's startup packet and do something according to it. 
 * 
 * Returns STATUS_OK or STATUS_ERROR, or might call ereport(FATAL) and 
 * not return at all. 
 * 
 * (Note that ereport(FATAL) stuff is sent to the client, so only use it 
 * if that's what you want.  Return STATUS_ERROR if you don't want to 
 * send anything to the client, which would typically be appropriate 
 * if we detect a communications failure.) 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1929"></a><span class='Declare_Function'>ProcessStartupPacket</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>SSLdone</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1931"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN1932"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1933"></a>    <a href="../../include/libpq/pqcomm.h.html#LN112"><span class='Ref_to_Typedef'>ProtocolVersion</span></a> <span class='Declare_Local'>proto</span><span class='Delimiter'>; 
</span><a name="LN1934"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/libpq.h.html#LN65"><span class='Ref_to_Proto'>pq_startmsgread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN63"><span class='Ref_to_Proto'>pq_getbytes</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>== </span>EOF<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * EOF after SSLdone probably means the client didn't like our 
         * response to NEGOTIATE_SSL_CODE.  That's not an error condition, so 
         * don't clutter the log with a complaint. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>SSLdone</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incomplete startup packet"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>ntohl<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>-= </span><span class='Number'>4</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN112"><span class='Ref_to_Typedef'>ProtocolVersion</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><a href="../../include/libpq/pqcomm.h.html#LN159"><span class='Ref_to_Const'>MAX_STARTUP_PACKET_LENGTH</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid length of startup packet"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate at least the size of an old-style startup packet, plus one 
     * extra byte, and make sure all are zeroes.  This ensures we will have 
     * null termination of all strings, in both fixed- and variable-length 
     * packet layouts. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN140"><span class='Ref_to_Struct'>StartupPacket</span></a><span class='Parentheses'>))</span> 
        <a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN140"><span class='Ref_to_Struct'>StartupPacket</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN63"><span class='Ref_to_Proto'>pq_getbytes</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>EOF<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incomplete startup packet"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/libpq/libpq.h.html#LN66"><span class='Ref_to_Proto'>pq_endmsgread</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The first field is either a protocol version number or a special 
     * request code. 
     */ 
</span>    <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN119"><span class='Ref_to_Member'>proto</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a> <span class='Operator'>= </span>ntohl<span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>((</span><a href="../../include/libpq/pqcomm.h.html#LN112"><span class='Ref_to_Typedef'>ProtocolVersion</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a> <span class='Operator'>== </span><a href="../../include/libpq/pqcomm.h.html#LN189"><span class='Ref_to_Const'>CANCEL_REQUEST_CODE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN410"><span class='Ref_to_Proto'>processCancelRequest</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Not really an error, but we don't want to proceed further */ 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a> <span class='Operator'>== </span><a href="../../include/libpq/pqcomm.h.html#LN204"><span class='Ref_to_Const'>NEGOTIATE_SSL_CODE</span></a> <span class='Operator'>&& !</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>SSLdone</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1998"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>SSLok</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
        <span class='Comment_Multi_Line'>/* No SSL when disabled or on Unix sockets */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN374"><span class='Ref_to_Global_Var'>LoadedSSL</span></a> <span class='Operator'>|| </span><a href="../../include/common/ip.h.html#LN21"><span class='Ref_to_Macro'>IS_AF_UNIX</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN120"><span class='Ref_to_Member'>laddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Operator'>.</span>ss_family<span class='Parentheses'>))</span> 
            <a href="postmaster.c.html#LN1998"><span class='Ref_To_Local'>SSLok</span></a> <span class='Operator'>= </span><span class='String'>'N'</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="postmaster.c.html#LN1998"><span class='Ref_To_Local'>SSLok</span></a> <span class='Operator'>= </span><span class='String'>'S'</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Support for SSL */ 
</span><span class='Directive'>#else</span> 
        <a href="postmaster.c.html#LN1998"><span class='Ref_To_Local'>SSLok</span></a> <span class='Operator'>= </span><span class='String'>'N'</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* No support for SSL */ 
</span><span class='Directive'>#endif</span> 
 
<a name="LN2010"></a><span class='Label'>retry1</span><span class='Operator'>: 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN1998"><span class='Ref_To_Local'>SSLok</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="postmaster.c.html#LN2010"><span class='Ref_to_Label'>retry1</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* if interrupted, just retry */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN29"><span class='Ref_to_Const'>COMMERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"failed to send SSL negotiation response: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* close the connection */ 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1998"><span class='Ref_To_Local'>SSLok</span></a> <span class='Operator'>== </span><span class='String'>'S'</span> <span class='Operator'>&& </span><a href="../../include/libpq/libpq.h.html#LN85"><span class='Ref_to_Proto'>secure_open_server</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Comment_Multi_Line'>/* regular startup packet, cancel, etc packet should follow... */ 
</span>        <span class='Comment_Multi_Line'>/* but not another SSL negotiation request */ 
</span>        <span class='Control'>return</span> <a href="postmaster.c.html#LN409"><span class='Ref_to_Proto'>ProcessStartupPacket</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proto==NEGOTIATE_SSL_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Could add additional special packet types here */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set FrontendProtocol now so that ereport() knows what format to send if 
     * we fail during startup. 
     */ 
</span>    <a href="../utils/init/globals.c.html#LN26"><span class='Ref_to_Global_Var'>FrontendProtocol</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we can handle the protocol the frontend is using. */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN109"><span class='Ref_to_Const'>PG_PROTOCOL_EARLIEST</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT; </span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN110"><span class='Ref_to_Const'>PG_PROTOCOL_LATEST</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN110"><span class='Ref_to_Const'>PG_PROTOCOL_LATEST</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>         <a href="../../include/libpq/pqcomm.h.html#LN104"><span class='Ref_to_Macro'>PG_PROTOCOL_MINOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../../include/libpq/pqcomm.h.html#LN104"><span class='Ref_to_Macro'>PG_PROTOCOL_MINOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN110"><span class='Ref_to_Const'>PG_PROTOCOL_LATEST</span></a><span class='Parentheses'>)))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unsupported frontend protocol %u.%u: server supports %u.0 to %u.%u"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/libpq/pqcomm.h.html#LN104"><span class='Ref_to_Macro'>PG_PROTOCOL_MINOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN109"><span class='Ref_to_Const'>PG_PROTOCOL_EARLIEST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN110"><span class='Ref_to_Const'>PG_PROTOCOL_LATEST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../include/libpq/pqcomm.h.html#LN104"><span class='Ref_to_Macro'>PG_PROTOCOL_MINOR</span></a><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN110"><span class='Ref_to_Const'>PG_PROTOCOL_LATEST</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now fetch parameters out of startup packet and save them into the Port 
     * structure.  All data structures attached to the Port struct must be 
     * allocated in TopMemoryContext so that they will remain available in a 
     * running backend (even after PostmasterContext is destroyed).  We need 
     * not worry about leaking this storage on failure, since we aren't in the 
     * postmaster process anymore. 
     */ 
</span>    <a href="postmaster.c.html#LN1934"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN103"><span class='Ref_to_Macro'>PG_PROTOCOL_MAJOR</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1933"><span class='Ref_To_Local'>proto</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>3</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2064"></a>        <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>offset</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN112"><span class='Ref_to_Typedef'>ProtocolVersion</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Scan packet body for name/option pairs.  We can assume any string 
         * beginning within the packet body is null-terminated, thanks to 
         * zeroing extra byte above. 
         */ 
</span>        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN138"><span class='Ref_to_Member'>guc_options</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2064"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2075"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nameptr</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="postmaster.c.html#LN2064"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span><a name="LN2076"></a>            <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>valoffset</span><span class='Delimiter'>; 
</span><a name="LN2077"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>valptr</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a> <span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* found packet terminator */ 
</span>            <a href="postmaster.c.html#LN2076"><span class='Ref_To_Local'>valoffset</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN2064"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2076"><span class='Ref_To_Local'>valoffset</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* missing value, will complain below */ 
</span>            <a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="postmaster.c.html#LN2076"><span class='Ref_To_Local'>valoffset</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a><span class='Delimiter'>, </span><span class='String'>"database"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a><span class='Delimiter'>, </span><span class='String'>"user"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a><span class='Delimiter'>, </span><span class='String'>"options"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN137"><span class='Ref_to_Member'>cmdline_options</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a><span class='Delimiter'>, </span><span class='String'>"replication"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Due to backward compatibility concerns the replication 
                 * parameter is a hybrid beast which allows the value to be 
                 * either boolean or the string 'database'. The latter 
                 * connects to a specific database which is e.g. required for 
                 * logical decoding while. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Delimiter'>, </span><span class='String'>"database"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="../replication/walsender.c.html#LN116"><span class='Ref_to_Global_Var'>am_db_walsender</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/builtins.h.html#LN22"><span class='Ref_to_Proto'>parse_bool</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a><span class='Parentheses'>))</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid value for parameter \"%s\": \"%s\""</span><span class='Delimiter'>, 
</span>                                <span class='String'>"replication"</span><span class='Delimiter'>, 
</span>                                <a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Valid values are: \"false\", 0, \"true\", 1, \"database\"."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(nameptr,"repli... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Assume it's a generic GUC option */ 
</span>                <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN138"><span class='Ref_to_Member'>guc_options</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN138"><span class='Ref_to_Member'>guc_options</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2075"><span class='Ref_To_Local'>nameptr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN138"><span class='Ref_to_Member'>guc_options</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN138"><span class='Ref_to_Member'>guc_options</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="postmaster.c.html#LN2064"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN2076"><span class='Ref_To_Local'>valoffset</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN2077"><span class='Ref_To_Local'>valptr</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while offset&LT;len &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If we didn't find a packet terminator exactly at the end of the 
         * given packet length, complain. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2064"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN1931"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid startup packet layout: expected terminator as last byte"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PG_PROTOCOL_MAJOR(pro... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Get the parameters from the old-style, fixed-width-fields startup 
         * packet as C strings.  The packet destination was cleared first so a 
         * short packet has zeros silently added.  We have to be prepared to 
         * truncate the pstrdup result for oversize fields, though. 
         */ 
</span><a name="LN2142"></a>        <a href="../../include/libpq/pqcomm.h.html#LN140"><span class='Ref_to_Struct'>StartupPacket</span></a> <span class='Operator'>*</span><span class='Declare_Local'>packet</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN140"><span class='Ref_to_Struct'>StartupPacket</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN1932"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN143"><span class='Ref_to_Member'>database</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN143"><span class='Ref_to_Member'>database</span></a><span class='Parentheses'>))</span> 
            <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>[</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN143"><span class='Ref_to_Member'>database</span></a><span class='Parentheses'>)</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN145"><span class='Ref_to_Member'>user</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN145"><span class='Ref_to_Member'>user</span></a><span class='Parentheses'>))</span> 
            <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>[</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN145"><span class='Ref_to_Member'>user</span></a><span class='Parentheses'>)</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN137"><span class='Ref_to_Member'>cmdline_options</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN146"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN137"><span class='Ref_to_Member'>cmdline_options</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN146"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>))</span> 
            <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN137"><span class='Ref_to_Member'>cmdline_options</span></a><span class='Delimiter'>[</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2142"><span class='Ref_To_Local'>packet</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/pqcomm.h.html#LN146"><span class='Ref_to_Member'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN138"><span class='Ref_to_Member'>guc_options</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Check a user name was given. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no PostgreSQL user name specified in startup packet"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The database defaults to the user name. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN239"><span class='Ref_to_Global_Var'>Db_user_namespace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If user@, it is a global user, remove '@'. We only want to do this 
         * if there is an '@' at the end and no earlier in the user string or 
         * they may fake as a local user of another database attaching to this 
         * database. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><span class='String'>'@'</span><span class='Parentheses'>) </span><span class='Operator'>== 
</span>            <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Operator'>*</span>strchr<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><span class='String'>'@'</span><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Append '@' and dbname */ 
</span>            <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s@%s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Truncate given database and user names to length of a Postgres name. 
     * This avoids lookup failures when overlength names are given. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span> 
        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span> 
        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normal walsender backends, e.g. for streaming replication, are not 
     * connected to a particular database. But walsenders used for logical 
     * replication need to connect to a specific database. We allow streaming 
     * replication commands to be issued even if connected to a database as it 
     * can make sense to first make a basebackup and then stream changes 
     * starting from that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a> <span class='Operator'>&& !</span><a href="../replication/walsender.c.html#LN116"><span class='Ref_to_Global_Var'>am_db_walsender</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Done putting stuff in TopMemoryContext. 
     */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN1934"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're going to reject the connection due to database state, say so 
     * now instead of wasting cycles on an authentication exchange. (This also 
     * allows a pg_ping utility to be written.) 
     */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN1929"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN128"><span class='Ref_to_Member'>canAcceptConnections</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_STARTUP</span></a><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/fe-connect.c.html#LN94"><span class='Ref_to_Const'>ERRCODE_CANNOT_CONNECT_NOW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"the database system is starting up"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_SHUTDOWN</span></a><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/fe-connect.c.html#LN94"><span class='Ref_to_Const'>ERRCODE_CANNOT_CONNECT_NOW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"the database system is shutting down"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_RECOVERY</span></a><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/fe-connect.c.html#LN94"><span class='Ref_to_Const'>ERRCODE_CANNOT_CONNECT_NOW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"the database system is in recovery mode"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_TOOMANY</span></a><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_TOO_MANY_CONNECTIONS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"sorry, too many clients already"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/libpq-be.h.html#LN73"><span class='Ref_to_EnumConst'>CAC_WAITBACKUP</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* OK for now, will check in InitPostgres */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_OK</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch port-&GT;canAcceptConnec... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ProcessStartupPacket &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * The client has sent a cancel request packet, not a normal 
 * start-a-new-connection packet.  Perform the necessary processing. 
 * Nothing is sent back to the client. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2253"></a><span class='Declare_Function'>processCancelRequest</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pkt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/libpq/pqcomm.h.html#LN191"><span class='Ref_to_Struct'>CancelRequestPacket</span></a> <span class='Operator'>*</span>canc <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/libpq/pqcomm.h.html#LN191"><span class='Ref_to_Struct'>CancelRequestPacket</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN2253"><span class='Ref_to_Parameter'>pkt</span></a><span class='Delimiter'>; 
</span>    <span class='Keyword'>int</span>         backendPID<span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       cancelAuthCode<span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span>bp<span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> EXEC_BACKEND 
    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  iter<span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Keyword'>int</span>         <a href="../../interfaces/ecpg/test/expected/preproc-comment.c.html#LN22"><span class='Ref_to_Global_Var'>i</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    backendPID <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>ntohl<span class='Parentheses'>(</span>canc<span class='Operator'>-&GT;</span>backendPID<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    cancelAuthCode <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span>ntohl<span class='Parentheses'>(</span>canc<span class='Operator'>-&GT;</span>cancelAuthCode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * See if we have a matching backend.  In the EXEC_BACKEND case, we can no 
     * longer access the postmaster's own backend list, and must rely on the 
     * duplicate array in shared memory. 
     */ 
</span><span class='Directive'>#ifndef</span> EXEC_BACKEND 
    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span>iter<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        bp <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Delimiter'>, </span>elem<span class='Delimiter'>, </span>iter<span class='Operator'>.</span>cur<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="../../interfaces/ecpg/test/expected/preproc-comment.c.html#LN22"><span class='Ref_to_Global_Var'>i</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/postmaster.h.html#LN51"><span class='Ref_to_Proto'>MaxLivePostmasterChildren</span></a><span class='Parentheses'>() </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="../../interfaces/ecpg/test/expected/preproc-comment.c.html#LN22"><span class='Ref_to_Global_Var'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="../../interfaces/ecpg/test/expected/preproc-comment.c.html#LN22"><span class='Ref_to_Global_Var'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        bp <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>[</span><a href="../../interfaces/ecpg/test/expected/preproc-comment.c.html#LN22"><span class='Ref_to_Global_Var'>i</span></a><span class='Delimiter'>]; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>bp<span class='Operator'>-&GT;</span>pid <span class='Operator'>== </span>backendPID<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>bp<span class='Operator'>-&GT;</span>cancel_key <span class='Operator'>== </span>cancelAuthCode<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Found a match; signal that backend to cancel current op */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"processing cancel request: sending SIGINT to process %d"</span><span class='Delimiter'>, 
</span>                                         backendPID<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span>bp<span class='Operator'>-&GT;</span>pid<span class='Delimiter'>, </span>SIGINT<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <span class='Comment_Multi_Line'>/* Right PID, wrong key: no way, Jose */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"wrong key in cancel request for process %d"</span><span class='Delimiter'>, 
</span>                                backendPID<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=MaxLivePostmasterCh... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* No matching backend */ 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"PID %d in cancel request did not match any process"</span><span class='Delimiter'>, 
</span>                    backendPID<span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end processCancelRequest &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * canAcceptConnections --- check to see if database state allows connections. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/libpq/libpq-be.h.html#LN70"><span class='Ref_to_Enum'>CAC_state</span></a> 
<a name="LN2312"></a><span class='Declare_Function'>canAcceptConnections</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2314"></a>    <a href="../../include/libpq/libpq-be.h.html#LN70"><span class='Ref_to_Enum'>CAC_state</span></a>   <span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_OK</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Can't start backends when in startup/shutdown/inconsistent recovery 
     * state. 
     * 
     * In state PM_WAIT_BACKUP only superusers can connect (this must be 
     * allowed so that a superuser can end online backup mode); we return 
     * CAC_WAITBACKUP code to indicate that this must be checked later. Note 
     * that neither CAC_OK nor CAC_WAITBACKUP can safely be returned until we 
     * have checked for too many children. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN2314"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq-be.h.html#LN73"><span class='Ref_to_EnumConst'>CAC_WAITBACKUP</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* allow superusers only */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_SHUTDOWN</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* shutdown is pending */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>&& 
</span>                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a> <span class='Operator'>|| 
</span>                  <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_STARTUP</span></a><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* normal startup */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>&& 
</span>                 <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN2314"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_OK</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* connection OK during hot standby */ 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_RECOVERY</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* else must be crash recovery */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't start too many children. 
     * 
     * We allow more connections than we can have backends here because some 
     * might still be authenticating; they might fail auth, or some existing 
     * backend might exit before the auth cycle is completed. The exact 
     * MaxBackends limit is enforced when a new backend tries to join the 
     * shared-inval backend array. 
     * 
     * The limit here must match the sizes of the per-child-process arrays; 
     * see comments for MaxLivePostmasterChildren(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN421"><span class='Ref_to_Proto'>CountChildren</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN145"><span class='Ref_to_Const'>BACKEND_TYPE_ALL</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../include/postmaster/postmaster.h.html#LN51"><span class='Ref_to_Proto'>MaxLivePostmasterChildren</span></a><span class='Parentheses'>())</span> 
        <a href="postmaster.c.html#LN2314"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_TOOMANY</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="postmaster.c.html#LN2314"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end canAcceptConnections &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ConnCreate -- create a local connection data structure 
 * 
 * Returns NULL on failure, other than out-of-memory which is fatal. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>* 
</span><a name="LN2368"></a><span class='Declare_Function'>ConnCreate</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>serverFd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2370"></a>    <a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>port</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a><span class='Parentheses'>))))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN58"><span class='Ref_to_Proto'>StreamConnection</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2368"><span class='Ref_to_Parameter'>serverFd</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a> <span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/libpq/libpq.h.html#LN59"><span class='Ref_to_Proto'>StreamClose</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN389"><span class='Ref_to_Proto'>ConnFree</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate GSSAPI specific state struct 
     */ 
</span><span class='Directive'>#ifndef</span> EXEC_BACKEND 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>    <a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN81"><span class='Ref_to_Typedef'>pg_gssinfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN81"><span class='Ref_to_Typedef'>pg_gssinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="postmaster.c.html#LN2370"><span class='Ref_To_Local'>port</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ConnCreate &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ConnFree -- free a local connection data structure 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2412"></a><span class='Declare_Function'>ConnFree</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
    <a href="../../include/libpq/libpq.h.html#LN86"><span class='Ref_to_Proto'>secure_close</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2412"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2412"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2412"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * ClosePostmasterPorts -- close all the postmaster's open sockets 
 * 
 * This is called during child process startup to release file descriptors 
 * that are not needed by that child process.  The postmaster still has 
 * them open, of course. 
 * 
 * Note: we pass am_syslogger as a boolean because we don't want to set 
 * the global variable yet when this is called. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2434"></a><span class='Declare_Function'>ClosePostmasterPorts</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>am_syslogger</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2436"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * Close the write end of postmaster death watch pipe. It's important to 
     * do this as early as possible, so that if postmaster dies, others won't 
     * think that it's still running because we're holding the pipe open. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Delimiter'>[</span><a href="../../include/postmaster/postmaster.h.html#LN43"><span class='Ref_to_Const'>POSTMASTER_FD_OWN</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not close postmaster death monitoring pipe in child process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Delimiter'>[</span><a href="../../include/postmaster/postmaster.h.html#LN43"><span class='Ref_to_Const'>POSTMASTER_FD_OWN</span></a><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Close the listen sockets */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2436"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN2436"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN213"><span class='Ref_to_Const'>MAXLISTEN</span></a><span class='Delimiter'>; </span><a href="postmaster.c.html#LN2436"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN2436"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/libpq/libpq.h.html#LN59"><span class='Ref_to_Proto'>StreamClose</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN2436"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN2436"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If using syslogger, close the read side of the pipe */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN2434"><span class='Ref_to_Parameter'>am_syslogger</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            CloseHandle<span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> USE_BONJOUR 
    <span class='Comment_Multi_Line'>/* If using Bonjour, close the connection to the mDNS daemon */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN378"><span class='Ref_to_Global_Var'>bonjour_sdref</span></a><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span>DNSServiceRefSockFD<span class='Parentheses'>(</span><a href="postmaster.c.html#LN378"><span class='Ref_to_Global_Var'>bonjour_sdref</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ClosePostmasterPorts &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * reset_shared -- reset shared memory and semaphores 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2488"></a><span class='Declare_Function'>reset_shared</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Create or re-create shared memory and semaphores. 
     * 
     * Note: in each "cycle of life" we will normally assign the same IPC keys 
     * (if using SysV shmem and/or semas), since the port number is used to 
     * determine IPC keys.  This helps ensure that we will clean up dead IPC 
     * objects if the postmaster crashes and is restarted. 
     */ 
</span>    <a href="../../include/storage/ipc.h.html#LN77"><span class='Ref_to_Proto'>CreateSharedMemoryAndSemaphores</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2488"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * SIGHUP -- reread config files, and tell children to do same 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2506"></a><span class='Declare_Function'>SIGHUP_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2508"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&LT;= </span><a href="postmaster.c.html#LN269"><span class='Ref_to_Const'>SmartShutdown</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"received SIGHUP, reloading configuration files"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN419"><span class='Ref_to_Macro'>SignalChildren</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Reload authentication config files too */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/libpq/hba.h.html#LN114"><span class='Ref_to_Proto'>load_hba</span></a><span class='Parentheses'>())</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_hba.conf was not reloaded"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/libpq/hba.h.html#LN115"><span class='Ref_to_Proto'>load_ident</span></a><span class='Parentheses'>())</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_ident.conf was not reloaded"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
        <span class='Comment_Multi_Line'>/* Reload SSL configuration as well */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN232"><span class='Ref_to_Global_Var'>EnableSSL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../libpq/be-secure.c.html#LN71"><span class='Ref_to_Func'>secure_initialize</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN374"><span class='Ref_to_Global_Var'>LoadedSSL</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL configuration was not reloaded"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../libpq/be-secure.c.html#LN84"><span class='Ref_to_Func'>secure_destroy</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN374"><span class='Ref_to_Global_Var'>LoadedSSL</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
        <span class='Comment_Multi_Line'>/* Update the starting-point file for future children */ 
</span>        <a href="../../include/utils/guc.h.html#LN385"><span class='Ref_to_Proto'>write_nondefault_variables</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if Shutdown&LT;=SmartShutdo... &raquo; </span> 
 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="postmaster.c.html#LN2508"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SIGHUP_handler &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * pmdie -- signal handler for processing various postmaster signals. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2579"></a><span class='Declare_Function'>pmdie</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2581"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"postmaster received signal %d"</span><span class='Delimiter'>, 
</span>                             postgres_signal_arg<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span>postgres_signal_arg<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SIGTERM<span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Smart Shutdown: 
             * 
             * Wait for children to end their work, then shut down. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN269"><span class='Ref_to_Const'>SmartShutdown</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN269"><span class='Ref_to_Const'>SmartShutdown</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"received smart shutdown request"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> USE_SYSTEMD 
            sd_notify<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='String'>"STOPPING=1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>|| 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* autovac workers are told to shut down immediately */ 
</span>                <span class='Comment_Multi_Line'>/* and bgworkers too; does this need tweaking? */ 
</span>                <a href="postmaster.c.html#LN416"><span class='Ref_to_Proto'>SignalSomeChildren</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, 
</span>                               <a href="postmaster.c.html#LN142"><span class='Ref_to_Const'>BACKEND_TYPE_AUTOVAC</span></a> <span class='Operator'>| </span><a href="postmaster.c.html#LN144"><span class='Ref_to_Const'>BACKEND_TYPE_BGWORKER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* and the autovac launcher too */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* and the bgwriter too */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* and the walwriter too */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If we're in recovery, we can't kill the startup process 
                 * right away, because at present doing so does not release 
                 * its locks.  We might want to change this in a future 
                 * release.  For the time being, the PM_WAIT_READONLY state 
                 * indicates that we're waiting for the regular (read only) 
                 * backends to die off; once they do, we'll kill the startup 
                 * and walreceiver processes. 
                 */ 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Parentheses'>) </span><span class='Operator'>? 
</span>                    <a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a> <span class='Operator'>: </span><a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pmState==PM_RUN||pmSt... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * Now wait for online backup mode to end and backends to exit. If 
             * that is already the case, PostmasterStateMachine will take the 
             * next step. 
             */ 
</span>            <a href="postmaster.c.html#LN403"><span class='Ref_to_Proto'>PostmasterStateMachine</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> SIGINT<span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fast Shutdown: 
             * 
             * Abort all children with SIGTERM (rollback active transactions 
             * and exit) and shut down when they are gone. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN270"><span class='Ref_to_Const'>FastShutdown</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN270"><span class='Ref_to_Const'>FastShutdown</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"received fast shutdown request"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> USE_SYSTEMD 
            sd_notify<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='String'>"STOPPING=1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN416"><span class='Ref_to_Proto'>SignalSomeChildren</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="postmaster.c.html#LN144"><span class='Ref_to_Const'>BACKEND_TYPE_BGWORKER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Only startup, bgwriter, walreceiver, possibly bgworkers, 
                 * and/or checkpointer should be active in this state; we just 
                 * signaled the first four, and we don't want to kill 
                 * checkpointer yet. 
                 */ 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a> <span class='Operator'>|| 
</span>                     <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a> <span class='Operator'>|| 
</span>                     <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a> <span class='Operator'>|| 
</span>                     <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a> <span class='Operator'>|| 
</span>                     <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"aborting any active transactions"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* shut down all backends and workers */ 
</span>                <a href="postmaster.c.html#LN416"><span class='Ref_to_Proto'>SignalSomeChildren</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, 
</span>                                 <a href="postmaster.c.html#LN141"><span class='Ref_to_Const'>BACKEND_TYPE_NORMAL</span></a> <span class='Operator'>| </span><a href="postmaster.c.html#LN142"><span class='Ref_to_Const'>BACKEND_TYPE_AUTOVAC</span></a> <span class='Operator'>| 
</span>                                   <a href="postmaster.c.html#LN144"><span class='Ref_to_Const'>BACKEND_TYPE_BGWORKER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* and the autovac launcher too */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* and the walwriter too */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pmState==PM_RUN||pmSt... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * Now wait for backends to exit.  If there are none, 
             * PostmasterStateMachine will take the next step. 
             */ 
</span>            <a href="postmaster.c.html#LN403"><span class='Ref_to_Proto'>PostmasterStateMachine</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Immediate Shutdown: 
             * 
             * abort all children with SIGQUIT, wait for them to exit, 
             * terminate remaining ones with SIGKILL, then exit without 
             * attempt to properly shut down the data base system. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"received immediate shutdown request"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> USE_SYSTEMD 
            sd_notify<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='String'>"STOPPING=1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <a href="postmaster.c.html#LN417"><span class='Ref_to_Proto'>TerminateChildren</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* set stopwatch for them to die */ 
</span>            <a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Now wait for backends to exit.  If there are none, 
             * PostmasterStateMachine will take the next step. 
             */ 
</span>            <a href="postmaster.c.html#LN403"><span class='Ref_to_Proto'>PostmasterStateMachine</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch postgres_signal_arg &raquo; </span> 
 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="postmaster.c.html#LN2581"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pmdie &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Reaper -- signal handler to cleanup after a child process dies. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2749"></a><span class='Declare_Function'>reaper</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2751"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span><a name="LN2752"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pid</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* process id of dead child process */ 
</span><a name="LN2753"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>exitstatus</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* its exit status */ 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"reaping dead processes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN445"><span class='Ref_to_Proto'>waitpid</span></a><span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN443"><span class='Ref_to_Const'>WNOHANG</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Check if this child was a startup process. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Startup process exited in response to a shutdown request (or it 
             * completed normally regardless of the shutdown request). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="postmaster.c.html#LN548"><span class='Ref_to_Macro'>EXIT_STATUS_1</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN259"><span class='Ref_to_EnumConst'>STARTUP_NOT_RUNNING</span></a><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* PostmasterStateMachine logic does the rest */ 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN549"><span class='Ref_to_Macro'>EXIT_STATUS_3</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"shutdown at recovery target"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN259"><span class='Ref_to_EnumConst'>STARTUP_NOT_RUNNING</span></a><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN269"><span class='Ref_to_Const'>SmartShutdown</span></a><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN417"><span class='Ref_to_Proto'>TerminateChildren</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* PostmasterStateMachine logic does the rest */ 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Unexpected exit of startup process (including FATAL exit) 
             * during PM_STARTUP is treated as catastrophic. There are no 
             * other processes running yet, so we can just exit. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a> <span class='Operator'>&& !</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"startup process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"aborting startup due to startup process failure"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * After PM_STARTUP, any unexpected exit (including FATAL exit) of 
             * the startup process is catastrophic, so kill other children, 
             * and set StartupStatus so we don't try to reinitialize after 
             * they're gone.  Exception: if StartupStatus is STARTUP_SIGNALED, 
             * then we previously sent the startup process a SIGQUIT; so 
             * that's probably the reason it died, and we do want to try to 
             * restart in that case. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN261"><span class='Ref_to_EnumConst'>STARTUP_SIGNALED</span></a><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN259"><span class='Ref_to_EnumConst'>STARTUP_NOT_RUNNING</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN262"><span class='Ref_to_EnumConst'>STARTUP_CRASHED</span></a><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, 
</span>                                 _<span class='Parentheses'>(</span><span class='String'>"startup process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Startup succeeded, commence normal operations 
             */ 
</span>            <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN259"><span class='Ref_to_EnumConst'>STARTUP_NOT_RUNNING</span></a><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN345"><span class='Ref_to_Global_Var'>ReachedNormalRunning</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Crank up the background tasks, if we didn't do that already 
             * when we entered consistent recovery state.  It doesn't matter 
             * if this fails, we'll just try again later. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN542"><span class='Ref_to_Macro'>StartCheckpointer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN541"><span class='Ref_to_Macro'>StartBackgroundWriter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN543"><span class='Ref_to_Macro'>StartWalWriter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Likewise, start other special children as needed.  In a restart 
             * situation, some of them may be alive already. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>&& </span><a href="../../include/postmaster/autovacuum.h.html#LN48"><span class='Ref_to_Proto'>AutoVacuumingActive</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/autovacuum.h.html#LN57"><span class='Ref_to_Proto'>StartAutoVacLauncher</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN435"><span class='Ref_to_Macro'>PgArchStartupAllowed</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/pgarch.h.html#LN32"><span class='Ref_to_Proto'>pgarch_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN725"><span class='Ref_to_Func'>pgstat_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* workers may be scheduled to start now */ 
</span>            <a href="postmaster.c.html#LN423"><span class='Ref_to_Proto'>maybe_start_bgworkers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* at this point we are really open for business */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database system is ready to accept connections"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_SYSTEMD 
            sd_notify<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='String'>"READY=1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pid==StartupPID &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Was it the bgwriter?  Normal exit can be ignored; we'll start a new 
         * one at the next iteration of the postmaster's main loop, if 
         * necessary.  Any other exit condition is treated as a crash. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, 
</span>                                 _<span class='Parentheses'>(</span><span class='String'>"background writer process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Was it the checkpointer? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN329"><span class='Ref_to_EnumConst'>PM_SHUTDOWN</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * OK, we saw normal exit of the checkpointer after it's been 
                 * told to shut down.  We expect that it wrote a shutdown 
                 * checkpoint.  (If for some reason it didn't, recovery will 
                 * occur on next postmaster start.) 
                 * 
                 * At this point we should have no normal backend children 
                 * left (else we'd not be in PM_SHUTDOWN state) but we might 
                 * have dead_end children to wait for. 
                 * 
                 * If we have an archiver subprocess, tell it to do a last 
                 * archive cycle and quit. Likewise, if we have walsender 
                 * processes, tell them to send any remaining WAL and quit. 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Waken archiver for the last time */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Waken walsenders for the last time. No regular backends 
                 * should be around anymore. 
                 */ 
</span>                <a href="postmaster.c.html#LN419"><span class='Ref_to_Macro'>SignalChildren</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN331"><span class='Ref_to_EnumConst'>PM_SHUTDOWN_2</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * We can also shut down the stats collector now; there's 
                 * nothing left for it to do. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if EXIT_STATUS_0(exitsta... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Any unexpected exit of the checkpointer (including FATAL 
                 * exit) is treated as a crash. 
                 */ 
</span>                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, 
</span>                                 _<span class='Parentheses'>(</span><span class='String'>"checkpointer process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pid==CheckpointerPID &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Was it the wal writer?  Normal exit can be ignored; we'll start a 
         * new one at the next iteration of the postmaster's main loop, if 
         * necessary.  Any other exit condition is treated as a crash. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, 
</span>                                 _<span class='Parentheses'>(</span><span class='String'>"WAL writer process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Was it the wal receiver?  If exit status is zero (normal) or one 
         * (FATAL exit), we assume everything is all right just like normal 
         * backends. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="postmaster.c.html#LN548"><span class='Ref_to_Macro'>EXIT_STATUS_1</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, 
</span>                                 _<span class='Parentheses'>(</span><span class='String'>"WAL receiver process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Was it the autovacuum launcher?  Normal exit can be ignored; we'll 
         * start a new one at the next iteration of the postmaster's main 
         * loop, if necessary.  Any other exit condition is treated as a 
         * crash. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Delimiter'>, 
</span>                                 _<span class='Parentheses'>(</span><span class='String'>"autovacuum launcher process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Was it the archiver?  If so, just try to start a new one; no need 
         * to force reset of the rest of the system.  (If fail, we'll try 
         * again in future cycles of the main loop.).  Unless we were waiting 
         * for it to shut down; don't restart it in that case, and 
         * PostmasterStateMachine() will advance to the next shutdown step. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"archiver process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN435"><span class='Ref_to_Macro'>PgArchStartupAllowed</span></a><span class='Parentheses'>())</span> 
                <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/pgarch.h.html#LN32"><span class='Ref_to_Proto'>pgarch_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Was it the statistics collector?  If so, just try to start a new 
         * one; no need to force reset of the rest of the system.  (If fail, 
         * we'll try again in future cycles of the main loop.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"statistics collector process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN725"><span class='Ref_to_Func'>pgstat_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Was it the system logger?  If so, try to start a new one */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* for safety's sake, launch new logger *first* */ 
</span>            <a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/syslogger.h.html#LN81"><span class='Ref_to_Proto'>SysLogger_Start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"system logger process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Was it one of our background workers? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN399"><span class='Ref_to_Proto'>CleanupBackgroundWorker</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* have it be restarted */ 
</span>            <a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Else do standard backend child cleanup. 
         */ 
</span>        <a href="postmaster.c.html#LN398"><span class='Ref_to_Proto'>CleanupBackend</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN2752"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN2753"><span class='Ref_To_Local'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (pid=waitpid(-1,&exit... &raquo; </span>                           <span class='Comment_Single_Line'>/* loop over pending child-death reports */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * After cleaning out the SIGCHLD queue, see if we have any state changes 
     * or actions to make. 
     */ 
</span>    <a href="postmaster.c.html#LN403"><span class='Ref_to_Proto'>PostmasterStateMachine</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Done with signal handler */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="postmaster.c.html#LN2751"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end reaper &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Scan the bgworkers list and see if the given PID (which has just stopped 
 * or crashed) is in it.  Handle its shutdown if so, and return true.  If not a 
 * bgworker, return false. 
 * 
 * This is heavily based on CleanupBackend.  One important difference is that 
 * we don't know yet that the dying process is a bgworker, so we must be silent 
 * until we're sure it is. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3069"></a><span class='Declare_Function'>CleanupBackgroundWorker</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, 
</span><a name="LN3070"></a>                        <span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Parentheses'>) </span><span class='Comment_Single_Line'>/* child's exit status */ 
</span><span class='Delimiter'>{ 
</span><a name="LN3072"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>namebuf</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN3073"></a>    <a href="../../include/lib/ilist.h.html#LN238"><span class='Ref_to_Struct'>slist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/lib/ilist.h.html#LN715"><span class='Ref_to_Macro'>slist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3073"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="bgworker.c.html#LN42"><span class='Ref_to_Global_Var'>BackgroundWorkerList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3077"></a>        <a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rw</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN673"><span class='Ref_to_Macro'>slist_container</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a><span class='Delimiter'>, </span>rw_lnode<span class='Delimiter'>, </span><a href="postmaster.c.html#LN3073"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN240"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN3069"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Comment_Multi_Line'>/* see CleanupBackend */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a> <span class='Operator'>== </span>ERROR_WAIT_NO_CHILDREN<span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3072"><span class='Ref_To_Local'>namebuf</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s: %s"</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"worker process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN89"><span class='Ref_to_Member'>bgw_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Record timestamp, so we know when to restart the worker. */ 
</span>            <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Zero exit status means terminate */ 
</span>            <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN40"><span class='Ref_to_Member'>rw_terminate</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Additionally, for shared-memory-connected workers, just like a 
         * backend, any exit status other than 0 or 1 is considered a crash 
         * and causes a system-wide restart. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN90"><span class='Ref_to_Member'>bgw_flags</span></a> <span class='Operator'>& </span><a href="../../include/postmaster/bgworker.h.html#LN51"><span class='Ref_to_Const'>BGWORKER_SHMEM_ACCESS</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="postmaster.c.html#LN548"><span class='Ref_to_Macro'>EXIT_STATUS_1</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3069"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3072"><span class='Ref_To_Local'>namebuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We must release the postmaster child slot whether this worker is 
         * connected to shared memory or not, but we only treat it as a crash 
         * if it is in fact connected. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN90"><span class='Ref_to_Member'>bgw_flags</span></a> <span class='Operator'>& </span><a href="../../include/postmaster/bgworker.h.html#LN51"><span class='Ref_to_Const'>BGWORKER_SHMEM_ACCESS</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3069"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3072"><span class='Ref_To_Local'>namebuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Get it out of the BackendList and clear out remaining data */ 
</span>        <a href="../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN179"><span class='Ref_to_Member'>elem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
        <a href="postmaster.c.html#LN537"><span class='Ref_to_Proto'>ShmemBackendArrayRemove</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * It's possible that this background worker started some OTHER 
         * background worker and asked to be notified when that worker started 
         * or stopped.  If so, cancel any notifications destined for the 
         * now-dead backend. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN178"><span class='Ref_to_Member'>bgworker_notify</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/postmaster/bgworker_internals.h.html#LN52"><span class='Ref_to_Proto'>BackgroundWorkerStopNotifications</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN3077"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/postmaster/bgworker_internals.h.html#LN51"><span class='Ref_to_Proto'>ReportBackgroundWorkerExit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN3073"><span class='Ref_To_Local'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* report child death */ 
</span> 
        <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                     <a href="postmaster.c.html#LN3072"><span class='Ref_To_Local'>namebuf</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3069"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3070"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CleanupBackgroundWorker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CleanupBackend -- cleanup after terminated backend. 
 * 
 * Remove all local state associated with backend. 
 * 
 * If you change this, see also CleanupBackgroundWorker. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3168"></a><span class='Declare_Function'>CleanupBackend</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, 
</span><a name="LN3169"></a>               <span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Parentheses'>)</span>  <span class='Comment_Single_Line'>/* child's exit status. */ 
</span><span class='Delimiter'>{ 
</span><a name="LN3171"></a>    <a href="../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"server process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3168"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a backend dies in an ugly way then we must signal all other backends 
     * to quickdie.  If exit status is zero (normal) or one (FATAL exit), we 
     * assume everything is all right and proceed to remove the backend from 
     * the active backend list. 
     */ 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * On win32, also treat ERROR_WAIT_NO_CHILDREN (128) as nonfatal case, 
     * since that sometimes happens under load when the process fails to start 
     * properly (long before it starts using shared memory). Microsoft reports 
     * it is related to mutex failure: 
     * http://archives.postgresql.org/pgsql-hackers/2010-09/msg00790.php 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a> <span class='Operator'>== </span>ERROR_WAIT_NO_CHILDREN<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"server process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3168"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="postmaster.c.html#LN548"><span class='Ref_to_Macro'>EXIT_STATUS_1</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3168"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"server process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3171"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3206"></a>        <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bp</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Delimiter'>, </span>elem<span class='Delimiter'>, </span><a href="postmaster.c.html#LN3171"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN3168"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Uh-oh, the child failed to clean itself up.  Treat as a 
                     * crash after all. 
                     */ 
</span>                    <a href="postmaster.c.html#LN400"><span class='Ref_to_Proto'>HandleChildCrash</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3168"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3169"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"server process"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
                <a href="postmaster.c.html#LN537"><span class='Ref_to_Proto'>ShmemBackendArrayRemove</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN178"><span class='Ref_to_Member'>bgworker_notify</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * This backend may have been slated to receive SIGUSR1 when 
                 * some background worker started or stopped.  Cancel those 
                 * notifications, as we don't want to signal PIDs that are not 
                 * PostgreSQL backends.  This gets skipped in the (probably 
                 * very common) case where the backend has never requested any 
                 * such notifications. 
                 */ 
</span>                <a href="../../include/postmaster/bgworker_internals.h.html#LN52"><span class='Ref_to_Proto'>BackgroundWorkerStopNotifications</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3171"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3206"><span class='Ref_To_Local'>bp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if bp-&GT;pid==pid &raquo; </span> 
    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end CleanupBackend &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * HandleChildCrash -- cleanup after failed backend, bgwriter, checkpointer, 
 * walwriter, autovacuum, or background worker. 
 * 
 * The objectives here are to clean up our local state about the child 
 * process, and to signal all other remaining children to quickdie. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3252"></a><span class='Declare_Function'>HandleChildCrash</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>procname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3254"></a>    <a href="../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN3255"></a>    <a href="../../include/lib/ilist.h.html#LN223"><span class='Ref_to_Struct'>slist_iter</span></a>  <span class='Declare_Local'>siter</span><span class='Delimiter'>; 
</span><a name="LN3256"></a>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bp</span><span class='Delimiter'>; 
</span><a name="LN3257"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>take_action</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We only log messages and send signals if this is the first process 
     * crash and we're not doing an immediate shutdown; otherwise, we're only 
     * here to update postmaster's idea of live processes.  If we have already 
     * signalled children, nonzero exit status is to be expected, so don't 
     * clutter log. 
     */ 
</span>    <a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a> <span class='Operator'>= !</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN401"><span class='Ref_to_Proto'>LogChildExit</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>procname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"terminating any other active server processes"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Process background workers. */ 
</span>    <a href="../../include/lib/ilist.h.html#LN699"><span class='Ref_to_Macro'>slist_foreach</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3255"><span class='Ref_To_Local'>siter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="bgworker.c.html#LN42"><span class='Ref_to_Global_Var'>BackgroundWorkerList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3278"></a>        <a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rw</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN673"><span class='Ref_to_Macro'>slist_container</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a><span class='Delimiter'>, </span>rw_lnode<span class='Delimiter'>, </span><a href="postmaster.c.html#LN3255"><span class='Ref_To_Local'>siter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN225"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* not running */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Found entry for freshly-dead worker, so remove it. 
             */ 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN179"><span class='Ref_to_Member'>elem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
            <a href="postmaster.c.html#LN537"><span class='Ref_to_Proto'>ShmemBackendArrayRemove</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* don't reset crashed_at */ 
</span>            <span class='Comment_Multi_Line'>/* don't report child stop, either */ 
</span>            <span class='Comment_Multi_Line'>/* Keep looping so we can signal remaining workers */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This worker is still alive.  Unless we did so already, tell it 
             * to commit hara-kiri. 
             * 
             * SIGQUIT is the special signal that says exit without proc_exit 
             * and let the user know what's going on. But if SendStop is set 
             * (-s on command line), then we send SIGSTOP instead, so that we 
             * can get core dumps from all backends by hand. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3278"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Process regular backends */ 
</span>    <a href="../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3254"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Delimiter'>, </span>elem<span class='Delimiter'>, </span><a href="postmaster.c.html#LN3254"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Found entry for freshly-dead backend, so remove it. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
                <a href="postmaster.c.html#LN537"><span class='Ref_to_Proto'>ShmemBackendArrayRemove</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>} 
</span>            <a href="../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3254"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Keep looping so we can signal remaining backends */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This backend is still alive.  Unless we did so already, tell it 
             * to commit hara-kiri. 
             * 
             * SIGQUIT is the special signal that says exit without proc_exit 
             * and let the user know what's going on. But if SendStop is set 
             * (-s on command line), then we send SIGSTOP instead, so that we 
             * can get core dumps from all backends by hand. 
             * 
             * We could exclude dead_end children here, but at least in the 
             * SIGSTOP case it seems better to include them. 
             * 
             * Background workers were already processed above; ignore them 
             * here. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN144"><span class='Ref_to_Const'>BACKEND_TYPE_BGWORKER</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3256"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Take care of the startup process too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN262"><span class='Ref_to_EnumConst'>STARTUP_CRASHED</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN261"><span class='Ref_to_EnumConst'>STARTUP_SIGNALED</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Take care of the bgwriter too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Take care of the checkpointer too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Take care of the walwriter too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Take care of the walreceiver too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Take care of the autovacuum launcher too */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3252"><span class='Ref_to_Parameter'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><span class='String'>"SIGSTOP"</span> <span class='Operator'>: </span><span class='String'>"SIGQUIT"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN229"><span class='Ref_to_Global_Var'>SendStop</span></a> <span class='Operator'>? </span><a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a> <span class='Operator'>: </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force a power-cycle of the pgarch process too.  (This isn't absolutely 
     * necessary, but it seems like a good idea for robustness, and it 
     * simplifies the state-machine logic in the case where a shutdown request 
     * arrives during crash processing.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='String'>"SIGQUIT"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force a power-cycle of the pgstat process too.  (This isn't absolutely 
     * necessary, but it seems like a good idea for robustness, and it 
     * simplifies the state-machine logic in the case where a shutdown request 
     * arrives during crash processing.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN3257"><span class='Ref_To_Local'>take_action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending %s to process %d"</span><span class='Delimiter'>, 
</span>                                 <span class='String'>"SIGQUIT"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pgstat.c.html#LN788"><span class='Ref_to_Func'>allow_immediate_pgstat_restart</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* We do NOT restart the syslogger */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We now transit into a state of waiting for children to die */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>|| 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a> <span class='Operator'>|| 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a> <span class='Operator'>|| 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a> <span class='Operator'>|| 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a> <span class='Operator'>|| 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN329"><span class='Ref_to_EnumConst'>PM_SHUTDOWN</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * .. and if this doesn't happen quickly enough, now the clock is ticking 
     * for us to kill them without mercy. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end HandleChildCrash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Log the death of a child process. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3508"></a><span class='Declare_Function'>LogChildExit</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>lev</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>procname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>exitstatus</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * size of activity_buffer is arbitrary, but set equal to default 
     * track_activity_query_size 
     */ 
</span><a name="LN3514"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>activity_buffer</span><span class='Delimiter'>[</span><span class='Number'>1024</span><span class='Delimiter'>]; 
</span><a name="LN3515"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>activity</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN547"><span class='Ref_to_Macro'>EXIT_STATUS_0</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span> 
        <a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>= </span><a href="../../include/pgstat.h.html#LN1175"><span class='Ref_to_Proto'>pgstat_get_crashed_backend_activity</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, 
</span>                                                       <a href="postmaster.c.html#LN3514"><span class='Ref_To_Local'>activity_buffer</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3514"><span class='Ref_To_Local'>activity_buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN41"><span class='Ref_to_Macro'>WIFEXITED</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>lev</span></a><span class='Delimiter'>, 
</span> 
        <span class='Comment_Multi_Line'>/*------ 
          translator: %s is a noun phrase describing a child process, such as 
          "server process" */ 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s (PID %d) exited with exit code %d"</span><span class='Delimiter'>, 
</span>                        <a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>procname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="../../timezone/private.h.html#LN44"><span class='Ref_to_Macro'>WEXITSTATUS</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed process was running: %s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN172"><span class='Ref_to_Macro'>WIFSIGNALED</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>lev</span></a><span class='Delimiter'>, 
</span> 
        <span class='Comment_Multi_Line'>/*------ 
          translator: %s is a noun phrase describing a child process, such as 
          "server process" */ 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s (PID %d) was terminated by exception 0x%X"</span><span class='Delimiter'>, 
</span>                        <a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>procname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN174"><span class='Ref_to_Macro'>WTERMSIG</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"See C include file \"ntstatus.h\" for a description of the hexadecimal value."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed process was running: %s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>HAVE_DECL_SYS_SIGLIST<span class='Parentheses'>) </span><span class='Operator'>&& </span>HAVE_DECL_SYS_SIGLIST 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>lev</span></a><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/*------ 
      translator: %s is a noun phrase describing a child process, such as 
      "server process" */ 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s (PID %d) was terminated by signal %d: %s"</span><span class='Delimiter'>, 
</span>                    <a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>procname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN174"><span class='Ref_to_Macro'>WTERMSIG</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../include/port/win32.h.html#LN174"><span class='Ref_to_Macro'>WTERMSIG</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span>NSIG <span class='Operator'>? 
</span>                    sys_siglist<span class='Delimiter'>[</span><a href="../../include/port/win32.h.html#LN174"><span class='Ref_to_Macro'>WTERMSIG</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>] </span><span class='Operator'>: </span><span class='String'>"(unknown)"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>      <a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed process was running: %s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>lev</span></a><span class='Delimiter'>, 
</span> 
        <span class='Comment_Multi_Line'>/*------ 
          translator: %s is a noun phrase describing a child process, such as 
          "server process" */ 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s (PID %d) was terminated by signal %d"</span><span class='Delimiter'>, 
</span>                        <a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>procname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN174"><span class='Ref_to_Macro'>WTERMSIG</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed process was running: %s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>)</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>else</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>lev</span></a><span class='Delimiter'>, 
</span> 
        <span class='Comment_Multi_Line'>/*------ 
          translator: %s is a noun phrase describing a child process, such as 
          "server process" */ 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%s (PID %d) exited with unrecognized status %d"</span><span class='Delimiter'>, 
</span>                        <a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>procname</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3508"><span class='Ref_to_Parameter'>exitstatus</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a> <span class='Operator'>? </span><a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed process was running: %s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3515"><span class='Ref_To_Local'>activity</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogChildExit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Advance the postmaster's state machine and take actions as appropriate 
 * 
 * This is common code for pmdie(), reaper() and sigusr1_handler(), which 
 * receive the signals that might mean we need to change state. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3581"></a><span class='Declare_Function'>PostmasterStateMachine</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * PM_WAIT_BACKUP state ends when online backup mode is not active. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN471"><span class='Ref_to_Proto'>BackupInProgress</span></a><span class='Parentheses'>())</span> 
            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * PM_WAIT_READONLY state ends when we have no regular backends that 
         * have been started during recovery.  We kill the startup and 
         * walreceiver processes and transition to PM_WAIT_BACKENDS.  Ideally, 
         * we might like to kill these processes first and then wait for 
         * backends to die off, but that doesn't work at present because 
         * killing the startup process doesn't release its locks. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN421"><span class='Ref_to_Proto'>CountChildren</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN141"><span class='Ref_to_Const'>BACKEND_TYPE_NORMAL</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are in a state-machine state that implies waiting for backends to 
     * exit, see if they're all gone, and change state if so. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * PM_WAIT_BACKENDS state ends when we have no regular backends 
         * (including autovac workers), no bgworkers (including unconnected 
         * ones), and no walwriter, autovac launcher or bgwriter.  If we are 
         * doing crash recovery or an immediate shutdown then we expect the 
         * checkpointer to exit as well, otherwise not. The archiver, stats, 
         * and syslogger processes are disregarded since they are not 
         * connected to shared memory; we also disregard dead_end children 
         * here. Walsenders are also disregarded, they will be terminated 
         * later after writing the checkpoint record, like the archiver 
         * process. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN421"><span class='Ref_to_Proto'>CountChildren</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN141"><span class='Ref_to_Const'>BACKEND_TYPE_NORMAL</span></a> <span class='Operator'>| </span><a href="postmaster.c.html#LN147"><span class='Ref_to_Const'>BACKEND_TYPE_WORKER</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>             <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN271"><span class='Ref_to_Const'>ImmediateShutdown</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Start waiting for dead_end children to die.  This state 
                 * change causes ServerLoop to stop creating new ones. 
                 */ 
</span>                <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN333"><span class='Ref_to_EnumConst'>PM_WAIT_DEAD_END</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * We already SIGQUIT'd the archiver and stats processes, if 
                 * any, when we started immediate shutdown or entered 
                 * FatalError state. 
                 */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * If we get here, we are proceeding with normal shutdown. All 
                 * the regular children are gone, and it's time to tell the 
                 * checkpointer to do a shutdown checkpoint. 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Start the checkpointer if not running */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN542"><span class='Ref_to_Macro'>StartCheckpointer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* And tell it to shut down */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN329"><span class='Ref_to_EnumConst'>PM_SHUTDOWN</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * If we failed to fork a checkpointer, just shut down. 
                     * Any required cleanup will happen at next restart. We 
                     * set FatalError so that an "abnormal shutdown" message 
                     * gets logged when we exit. 
                     */ 
</span>                    <a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN333"><span class='Ref_to_EnumConst'>PM_WAIT_DEAD_END</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Kill the walsenders, archiver and stats collector too */ 
</span>                    <a href="postmaster.c.html#LN419"><span class='Ref_to_Macro'>SignalChildren</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if CountChildren(BACKEND... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pmState==PM_WAIT_BACK... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN331"><span class='Ref_to_EnumConst'>PM_SHUTDOWN_2</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * PM_SHUTDOWN_2 state ends when there's no other children than 
         * dead_end children left. There shouldn't be any regular backends 
         * left by now anyway; what we're really waiting for is walsenders and 
         * archiver. 
         * 
         * Walreceiver should normally be dead by now, but not when a fast 
         * shutdown is performed during recovery. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN421"><span class='Ref_to_Proto'>CountChildren</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN145"><span class='Ref_to_Const'>BACKEND_TYPE_ALL</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN333"><span class='Ref_to_EnumConst'>PM_WAIT_DEAD_END</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN333"><span class='Ref_to_EnumConst'>PM_WAIT_DEAD_END</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * PM_WAIT_DEAD_END state ends when the BackendList is entirely empty 
         * (ie, no dead_end children remain), and the archiver and stats 
         * collector are gone too. 
         * 
         * The reason we wait for those two is to protect them against a new 
         * postmaster starting conflicting subprocesses; this isn't an 
         * ironclad protection, but it at least helps in the 
         * shutdown-and-immediately-restart scenario.  Note that they have 
         * already been sent appropriate shutdown signals, either during a 
         * normal state transition leading up to PM_WAIT_DEAD_END, or during 
         * FatalError processing. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* These other guys should be dead already */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* syslogger is not considered here */ 
</span>            <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN334"><span class='Ref_to_EnumConst'>PM_NO_CHILDREN</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pmState==PM_WAIT_DEAD... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we've been told to shut down, we exit as soon as there are no 
     * remaining children.  If there was a crash, cleanup will occur at the 
     * next startup.  (Before PostgreSQL 8.3, we tried to recover from the 
     * crash before exiting, but that seems unwise if we are quitting because 
     * we got SIGTERM from init --- there may well not be time for recovery 
     * before init decides to SIGKILL us.) 
     * 
     * Note that the syslogger continues to run.  It will exit when it sees 
     * EOF on its input pipe, which happens when there are no more upstream 
     * processes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>&GT; </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN334"><span class='Ref_to_EnumConst'>PM_NO_CHILDREN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"abnormal database system shutdown"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Terminate exclusive backup mode to avoid recovery after a clean 
             * fast shutdown.  Since an exclusive backup can only be taken 
             * during normal running (and not, for example, while running 
             * under Hot Standby) it only makes sense to do this if we reached 
             * normal running. If we're still in recovery, the backup file is 
             * one we're recovering *from*, and we must keep it around so that 
             * recovery restarts from the right place. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN345"><span class='Ref_to_Global_Var'>ReachedNormalRunning</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/miscadmin.h.html#LN472"><span class='Ref_to_Proto'>CancelBackup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Normal exit from the postmaster is here */ 
</span>            <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if Shutdown&GT;NoShutdown&&... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If the startup process failed, or the user does not want an automatic 
     * restart after backend crashes, wait for all non-syslogger children to 
     * exit, and then exit postmaster.  We don't try to reinitialize when the 
     * startup process fails, because more than likely it will just fail again 
     * and we will keep trying forever. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN334"><span class='Ref_to_EnumConst'>PM_NO_CHILDREN</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN262"><span class='Ref_to_EnumConst'>STARTUP_CRASHED</span></a> <span class='Operator'>|| !</span><a href="postmaster.c.html#LN243"><span class='Ref_to_Global_Var'>restart_after_crash</span></a><span class='Parentheses'>))</span> 
        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we need to recover from a crash, wait for all non-syslogger children 
     * to exit, then reset shmem and StartupDataBase. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN334"><span class='Ref_to_EnumConst'>PM_NO_CHILDREN</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"all server processes terminated; reinitializing"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* allow background workers to immediately restart */ 
</span>        <a href="../../include/postmaster/bgworker_internals.h.html#LN53"><span class='Ref_to_Proto'>ResetBackgroundWorkerCrashTimes</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/ipc.h.html#LN67"><span class='Ref_to_Proto'>shmem_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN390"><span class='Ref_to_Proto'>reset_shared</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN540"><span class='Ref_to_Macro'>StartupDataBase</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN260"><span class='Ref_to_EnumConst'>STARTUP_RUNNING</span></a><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* crash recovery started, reset SIGKILL flag */ 
</span>        <a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PostmasterStateMachine &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Send a signal to a postmaster child process 
 * 
 * On systems that have setsid(), each child process sets itself up as a 
 * process group leader.  For signals that are generally interpreted in the 
 * appropriate fashion, we signal the entire process group not just the 
 * direct child process.  This allows us to, for example, SIGQUIT a blocked 
 * archive_recovery script, or SIGINT a script being run by a backend via 
 * system(). 
 * 
 * There is a race condition for recently-forked children: they might not 
 * have executed setsid() yet.  So we signal the child directly as well as 
 * the group.  We assume such a child will handle the signal before trying 
 * to spawn any grandchild processes.  We also assume that signaling the 
 * child twice will not cause any problems. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3831"></a><span class='Declare_Function'>signal_child</span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>signal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"kill(%ld,%d) failed: %m"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> HAVE_SETSID 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SIGINT<span class='Operator'>: 
</span>        <span class='Control'>case</span> SIGTERM<span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN194"><span class='Ref_to_Const'>SIGSTOP</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../include/port/win32.h.html#LN191"><span class='Ref_to_Const'>SIGKILL</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><span class='Operator'>-</span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"kill(%ld,%d) failed: %m"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) (</span><span class='Operator'>-</span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3831"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end signal_child &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a signal to the targeted children (but NOT special children; 
 * dead_end children are never signaled, either). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3857"></a><span class='Declare_Function'>SignalSomeChildren</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>signal</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>target</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3859"></a>    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN3860"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>signaled</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3859"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3864"></a>        <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bp</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Delimiter'>, </span>elem<span class='Delimiter'>, </span><a href="postmaster.c.html#LN3859"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Since target == BACKEND_TYPE_ALL is the most common case, we test 
         * it first and avoid touching shared memory for every child. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3857"><span class='Ref_to_Parameter'>target</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN145"><span class='Ref_to_Const'>BACKEND_TYPE_ALL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Assign bkend_type for any recently announced WAL Sender 
             * processes. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN141"><span class='Ref_to_Const'>BACKEND_TYPE_NORMAL</span></a> <span class='Operator'>&& 
</span>                <a href="../../include/storage/pmsignal.h.html#LN49"><span class='Ref_to_Proto'>IsPostmasterChildWalSender</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN143"><span class='Ref_to_Const'>BACKEND_TYPE_WALSND</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3857"><span class='Ref_to_Parameter'>target</span></a> <span class='Operator'>& </span><a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"sending signal %d to process %d"</span><span class='Delimiter'>, 
</span>                                 <a href="postmaster.c.html#LN3857"><span class='Ref_to_Parameter'>signal</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3864"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3857"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN3860"><span class='Ref_To_Local'>signaled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="postmaster.c.html#LN3860"><span class='Ref_To_Local'>signaled</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SignalSomeChildren &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a termination signal to children.  This considers all of our children 
 * processes, except syslogger and dead_end backends. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3901"></a><span class='Declare_Function'>TerminateChildren</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>signal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="postmaster.c.html#LN419"><span class='Ref_to_Macro'>SignalChildren</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a> <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a> <span class='Operator'>== </span><a href="../../include/port/win32.h.html#LN191"><span class='Ref_to_Const'>SIGKILL</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN265"><span class='Ref_to_Global_Var'>StartupStatus</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN261"><span class='Ref_to_EnumConst'>STARTUP_SIGNALED</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN249"><span class='Ref_to_Global_Var'>WalWriterPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN3901"><span class='Ref_to_Parameter'>signal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TerminateChildren &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * BackendStartup -- start backend process 
 * 
 * returns: STATUS_ERROR if the fork failed, STATUS_OK otherwise. 
 * 
 * Note: if you change this code, also consider StartAutovacuumWorker. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN3934"></a><span class='Declare_Function'>BackendStartup</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3936"></a>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bn</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* for backend cleanup */ 
</span><a name="LN3937"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create backend data structure.  Better before the fork() so we can 
     * handle failure cleanly. 
     */ 
</span>    <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the cancel key that will be assigned to this backend. The 
     * backend will have its own copy in the forked-off process' value of 
     * MyCancelKey, so that it can transmit the key to the frontend. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN414"><span class='Ref_to_Proto'>RandomCancelKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not generate random cancel key"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN168"><span class='Ref_to_Member'>cancel_key</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pass down canAcceptConnections state */ 
</span>    <a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN128"><span class='Ref_to_Member'>canAcceptConnections</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN413"><span class='Ref_to_Proto'>canAcceptConnections</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN128"><span class='Ref_to_Member'>canAcceptConnections</span></a> <span class='Operator'>!= </span><a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_OK</span></a> <span class='Operator'>&& 
</span>                    <a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN128"><span class='Ref_to_Member'>canAcceptConnections</span></a> <span class='Operator'>!= </span><a href="../../include/libpq/libpq-be.h.html#LN73"><span class='Ref_to_EnumConst'>CAC_WAITBACKUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unless it's a dead_end child, assign it a child slot number 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN42"><span class='Ref_to_Global_Var'>MyPMChildSlot</span></a> <span class='Operator'>= </span><a href="../../include/storage/pmsignal.h.html#LN47"><span class='Ref_to_Proto'>AssignPostmasterChildSlot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Hasn't asked to be notified about any bgworkers yet */ 
</span>    <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN178"><span class='Ref_to_Member'>bgworker_notify</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <a href="postmaster.c.html#LN3937"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN458"><span class='Ref_to_Proto'>backend_forkexec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !EXEC_BACKEND */ 
</span>    <a href="postmaster.c.html#LN3937"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3937"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span>               <span class='Comment_Single_Line'>/* child */ 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Detangle from postmaster */ 
</span>        <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>        <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Perform additional initialization and collect startup packet */ 
</span>        <a href="postmaster.c.html#LN404"><span class='Ref_to_Proto'>BackendInitialize</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And run the backend */ 
</span>        <a href="postmaster.c.html#LN4263"><span class='Ref_to_Func'>BackendRun</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN3937"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* in parent, fork failed */ 
</span><a name="LN4009"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="postmaster.c.html#LN4009"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork new process for connection: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN412"><span class='Ref_to_Proto'>report_fork_failure_to_client</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4009"><span class='Ref_To_Local'>save_errno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* in parent, successful fork */ 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"forked new backend, pid=%d socket=%d"</span><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN3937"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN3934"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Everything's been successful, it's safe to add this backend to our list 
     * of backends. 
     */ 
</span>    <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN3937"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN141"><span class='Ref_to_Const'>BACKEND_TYPE_NORMAL</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Can change later to WALSND */ 
</span>    <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN179"><span class='Ref_to_Member'>elem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN536"><span class='Ref_to_Proto'>ShmemBackendArrayAdd</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN3936"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BackendStartup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Try to report backend fork() failure to client before we close the 
 * connection.  Since we do not care to risk blocking the postmaster on 
 * this connection, we set the connection to non-blocking and try only once. 
 * 
 * This is grungy special-purpose code; we cannot use backend libpq since 
 * it's not up and running. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4051"></a><span class='Declare_Function'>report_fork_failure_to_client</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>errnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4053"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buffer</span><span class='Delimiter'>[</span><span class='Number'>1000</span><span class='Delimiter'>]; 
</span><a name="LN4054"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Format the error message packet (always V2 protocol) */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4053"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4053"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"E%s%s\n"</span><span class='Delimiter'>, 
</span>             _<span class='Parentheses'>(</span><span class='String'>"could not fork new process for connection: "</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4051"><span class='Ref_to_Parameter'>errnum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set port to non-blocking.  Don't do send() if this fails */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../port/noblock.c.html#LN23"><span class='Ref_to_Func'>pg_set_noblock</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4051"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We'll retry after EINTR, but ignore all other failures */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN4054"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN375"><span class='Ref_to_Macro'>send</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4051"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4053"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4053"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4054"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end report_fork_failure_to_client &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * BackendInitialize -- initialize an interactive (postmaster-child) 
 *              backend process, and collect the client's startup packet. 
 * 
 * returns: nothing.  Will not return at all if there's any failure. 
 * 
 * Note: this code does not depend on having any access to shared memory. 
 * In the EXEC_BACKEND case, we are physically attached to shared memory 
 * but have not yet set up most of our local pointers to shmem structures. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4084"></a><span class='Declare_Function'>BackendInitialize</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4086"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN4087"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN4088"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>remote_host</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span><a name="LN4089"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>remote_port</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN90"><span class='Ref_to_Const'>NI_MAXSERV</span></a><span class='Delimiter'>]; 
</span><a name="LN4090"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>remote_ps_data</span><span class='Delimiter'>[</span><a href="../../include/getaddrinfo.h.html#LN87"><span class='Ref_to_Const'>NI_MAXHOST</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Save port etc. for ps status */ 
</span>    <a href="../utils/init/globals.c.html#LN40"><span class='Ref_to_Global_Var'>MyProcPort</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * PreAuthDelay is a debugging aid for investigating problems in the 
     * authentication cycle: it can be set in postgresql.conf to allow time to 
     * attach to the newly-forked backend with a debugger.  (See also 
     * PostAuthDelay, which we allow clients to pass through PGOPTIONS, but it 
     * is not honored until after authentication.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN234"><span class='Ref_to_Global_Var'>PreAuthDelay</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN234"><span class='Ref_to_Global_Var'>PreAuthDelay</span></a> <span class='Operator'>* </span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This flag will remain set until InitPostgres finishes authentication */ 
</span>    <a href="postmaster.c.html#LN347"><span class='Ref_to_Global_Var'>ClientAuthInProgress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* limit visibility of log messages */ 
</span> 
    <span class='Comment_Multi_Line'>/* save process start time */ 
</span>    <a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN150"><span class='Ref_to_Member'>SessionStartTime</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../utils/init/globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a> <span class='Operator'>= </span><a href="../../bin/pg_waldump/compat.c.html#LN26"><span class='Ref_to_Func'>timestamptz_to_time_t</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN150"><span class='Ref_to_Member'>SessionStartTime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set these to empty in case they are needed before we set them up */ 
</span>    <a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN122"><span class='Ref_to_Member'>remote_host</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN127"><span class='Ref_to_Member'>remote_port</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize libpq and enable reporting of ereport errors to the client. 
     * Must do this now because authentication uses libpq to send messages. 
     */ 
</span>    <a href="../../include/libpq/libpq.h.html#LN62"><span class='Ref_to_Proto'>pq_init</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* initialize libpq to talk to client */ 
</span>    <a href="../tcop/postgres.c.html#LN87"><span class='Ref_to_Global_Var'>whereToSendOutput</span></a> <span class='Operator'>= </span><a href="../../include/tcop/dest.h.html#LN89"><span class='Ref_to_EnumConst'>DestRemote</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* now safe to ereport to client */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We arrange for a simple exit(1) if we receive SIGTERM or SIGQUIT or 
     * timeout while trying to collect the startup packet.  Otherwise the 
     * postmaster cannot shutdown the database FAST or IMMED cleanly if a 
     * buggy client fails to send the packet promptly.  XXX it follows that 
     * the remainder of this function must tolerate losing control at any 
     * instant.  Likewise, any pg_on_exit_callback registered before or during 
     * this function must be prepared to execute at any instant between here 
     * and the end of this function.  Furthermore, affected callbacks execute 
     * partially or not at all when a second exit-inducing signal arrives 
     * after proc_exit_prepare() decrements on_proc_exit_index.  (Thanks to 
     * that mechanic, callbacks need not anticipate more than one call.)  This 
     * is fragile; it ought to instead follow the norm of handling interrupts 
     * at selected, safe opportunities. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="postmaster.c.html#LN395"><span class='Ref_to_Proto'>startup_die</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN395"><span class='Ref_to_Proto'>startup_die</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/timeout.h.html#LN69"><span class='Ref_to_Proto'>InitializeTimeouts</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* establishes SIGALRM handler */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN23"><span class='Ref_to_Global_Var'>StartupBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the remote host name and port for logging and status display. 
     */ 
</span>    <a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN4087"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../include/common/ip.h.html#LN31"><span class='Ref_to_Proto'>pg_getnameinfo_all</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN63"><span class='Ref_to_Member'>addr</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN121"><span class='Ref_to_Member'>raddr</span></a><span class='Operator'>.</span><a href="../../include/libpq/pqcomm.h.html#LN64"><span class='Ref_to_Member'>salen</span></a><span class='Delimiter'>, 
</span>                                  <a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="postmaster.c.html#LN237"><span class='Ref_to_Global_Var'>log_hostname</span></a> <span class='Operator'>? </span><span class='Number'>0</span> <span class='Operator'>: </span><a href="../../include/getaddrinfo.h.html#LN77"><span class='Ref_to_Const'>NI_NUMERICHOST</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../include/getaddrinfo.h.html#LN80"><span class='Ref_to_Const'>NI_NUMERICSERV</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"pg_getnameinfo_all() failed: %s"</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/getaddrinfo.h.html#LN155"><span class='Ref_to_Proto'>gai_strerror</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4087"><span class='Ref_To_Local'>ret</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4090"><span class='Ref_To_Local'>remote_ps_data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4090"><span class='Ref_To_Local'>remote_ps_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4090"><span class='Ref_To_Local'>remote_ps_data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4090"><span class='Ref_To_Local'>remote_ps_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s(%s)"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Save remote_host and remote_port in port structure (after this, they 
     * will appear in log_line_prefix data for log messages). 
     */ 
</span>    <a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN122"><span class='Ref_to_Member'>remote_host</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN127"><span class='Ref_to_Member'>remote_port</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And now we can issue the Log_connections message, if wanted */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN238"><span class='Ref_to_Global_Var'>Log_connections</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"connection received: host=%s port=%s"</span><span class='Delimiter'>, 
</span>                            <a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Delimiter'>, 
</span>                            <a href="postmaster.c.html#LN4089"><span class='Ref_To_Local'>remote_port</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"connection received: host=%s"</span><span class='Delimiter'>, 
</span>                            <a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we did a reverse lookup to name, we might as well save the results 
     * rather than possibly repeating the lookup during authentication. 
     * 
     * Note that we don't want to specify NI_NAMEREQD above, because then we'd 
     * get nothing useful for a client without an rDNS entry.  Therefore, we 
     * must check whether we got a numeric IPv4 or IPv6 address, and not save 
     * it into remote_hostname if so.  (This test is conservative and might 
     * sometimes classify a hostname as numeric, but an error in that 
     * direction is safe; it only results in a possible extra lookup.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN237"><span class='Ref_to_Global_Var'>log_hostname</span></a> <span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN4087"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        strspn<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Delimiter'>, </span><span class='String'>"0123456789."</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        strspn<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Delimiter'>, </span><span class='String'>"0123456789ABCDEFabcdef:"</span><span class='Parentheses'>) </span><span class='Operator'>&LT; </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>))</span> 
        <a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN123"><span class='Ref_to_Member'>remote_hostname</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4088"><span class='Ref_To_Local'>remote_host</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ready to begin client interaction.  We will give up and exit(1) after a 
     * time delay, so that a broken client can't hog a connection 
     * indefinitely.  PreAuthDelay and any DNS interactions above don't count 
     * against the time limit. 
     * 
     * Note: AuthenticationTimeout is applied here while waiting for the 
     * startup packet, and then again in InitPostgres for the duration of any 
     * authentication operations.  So a hostile client could tie up the 
     * process for nearly twice AuthenticationTimeout before we kick him off. 
     * 
     * Note: because PostgresMain will call InitializeTimeouts again, the 
     * registration of STARTUP_PACKET_TIMEOUT will be lost.  This is okay 
     * since we never use it again after this function. 
     */ 
</span>    <a href="../../include/utils/timeout.h.html#LN70"><span class='Ref_to_Proto'>RegisterTimeout</span></a><span class='Parentheses'>(</span><a href="../../include/utils/timeout.h.html#LN25"><span class='Ref_to_EnumConst'>STARTUP_PACKET_TIMEOUT</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN397"><span class='Ref_to_Proto'>StartupPacketTimeoutHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/timeout.h.html#LN74"><span class='Ref_to_Proto'>enable_timeout_after</span></a><span class='Parentheses'>(</span><a href="../../include/utils/timeout.h.html#LN25"><span class='Ref_to_EnumConst'>STARTUP_PACKET_TIMEOUT</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN235"><span class='Ref_to_Global_Var'>AuthenticationTimeout</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Receive the startup packet (which might turn out to be a cancel request 
     * packet). 
     */ 
</span>    <a href="postmaster.c.html#LN4086"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN409"><span class='Ref_to_Proto'>ProcessStartupPacket</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Stop here if it was bad or a cancel packet.  ProcessStartupPacket 
     * already did any appropriate error reporting. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4086"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>        <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have the user and database name, we can set the process 
     * title for ps.  It's good to do this as early as possible in startup. 
     * 
     * For a walsender, the ps display is set in the following form: 
     * 
     * postgres: wal sender process &LT;user&GT; &LT;host&GT; &LT;activity&GT; 
     * 
     * To achieve that, we pass "wal sender process" as username and username 
     * as dbname to init_ps_display(). XXX: should add a new variant of 
     * init_ps_display() to avoid abusing the parameters like this. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../replication/walsender.c.html#LN113"><span class='Ref_to_Global_Var'>am_walsender</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/ps_status.h.html#LN18"><span class='Ref_to_Proto'>init_ps_display</span></a><span class='Parentheses'>(</span><span class='String'>"wal sender process"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4090"><span class='Ref_To_Local'>remote_ps_data</span></a><span class='Delimiter'>, 
</span>                        <a href="../utils/misc/ps_status.c.html#LN34"><span class='Ref_to_Global_Var'>update_process_title</span></a> <span class='Operator'>? </span><span class='String'>"authentication"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/utils/ps_status.h.html#LN18"><span class='Ref_to_Proto'>init_ps_display</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4084"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4090"><span class='Ref_To_Local'>remote_ps_data</span></a><span class='Delimiter'>, 
</span>                        <a href="../utils/misc/ps_status.c.html#LN34"><span class='Ref_to_Global_Var'>update_process_title</span></a> <span class='Operator'>? </span><span class='String'>"authentication"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Disable the timeout, and prevent SIGTERM/SIGQUIT again. 
     */ 
</span>    <a href="../../include/utils/timeout.h.html#LN77"><span class='Ref_to_Proto'>disable_timeout</span></a><span class='Parentheses'>(</span><a href="../../include/utils/timeout.h.html#LN25"><span class='Ref_to_EnumConst'>STARTUP_PACKET_TIMEOUT</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BackendInitialize &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * BackendRun -- set up the backend's argument list and invoke PostgresMain() 
 * 
 * returns: 
 *      Shouldn't return at all. 
 *      If PostgresMain() fails, return status. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4264"></a><span class='Declare_Function'>BackendRun</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4266"></a>    <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>av</span><span class='Delimiter'>; 
</span><a name="LN4267"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>maxac</span><span class='Delimiter'>; 
</span><a name="LN4268"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span><span class='Delimiter'>; 
</span><a name="LN4269"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>secs</span><span class='Delimiter'>; 
</span><a name="LN4270"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>usecs</span><span class='Delimiter'>; 
</span><a name="LN4271"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't want backend to be able to see the postmaster random number 
     * generator state.  We have to clobber the static random_seed *and* start 
     * a new random sequence in the random() library function. 
     */ 
</span><span class='Directive'>#ifndef</span> HAVE_STRONG_RANDOM 
    <a href="postmaster.c.html#LN368"><span class='Ref_to_Global_Var'>random_seed</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN369"><span class='Ref_to_Global_Var'>random_start_time</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Comment_Multi_Line'>/* slightly hacky way to convert timestamptz into integers */ 
</span>    <a href="../../include/utils/timestamp.h.html#LN72"><span class='Ref_to_Proto'>TimestampDifference</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4264"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN150"><span class='Ref_to_Member'>SessionStartTime</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4269"><span class='Ref_To_Local'>secs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4270"><span class='Ref_To_Local'>usecs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/srandom.c.html#LN20"><span class='Ref_to_Func'>srandom</span></a><span class='Parentheses'>((</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a> <span class='Operator'>^ </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4270"><span class='Ref_To_Local'>usecs</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>12</span><span class='Parentheses'>) </span><span class='Operator'>^ </span><a href="postmaster.c.html#LN4269"><span class='Ref_To_Local'>secs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now, build the argv vector that will be given to PostgresMain. 
     * 
     * The maximum possible number of commandline arguments that could come 
     * from ExtraOptions is (strlen(ExtraOptions) + 1) / 2; see 
     * pg_split_opts(). 
     */ 
</span>    <a href="postmaster.c.html#LN4267"><span class='Ref_To_Local'>maxac</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* for fixed args supplied below */ 
</span>    <a href="postmaster.c.html#LN4267"><span class='Ref_To_Local'>maxac</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN4266"><span class='Ref_To_Local'>av</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                      <a href="postmaster.c.html#LN4267"><span class='Ref_To_Local'>maxac</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN4266"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Pass any backend switches specified with -o on the postmaster's own 
     * command line.  We assume these are secure. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN420"><span class='Ref_to_Proto'>pg_split_opts</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4266"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN4266"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN4267"><span class='Ref_To_Local'>maxac</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Debug: print arguments being passed to backend 
     */ 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s child[%d]: starting with ("</span><span class='Delimiter'>, 
</span>                             <a href="../../bin/pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>getpid<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4271"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN4271"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="postmaster.c.html#LN4271"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"\t%s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4266"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4271"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>")"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure we aren't in PostmasterContext anymore.  (We can't delete it 
     * just yet, though, because InitPostgres will need the HBA data.) 
     */ 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../tcop/postgres.c.html#LN3577"><span class='Ref_to_Func'>PostgresMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4268"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4266"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4264"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN135"><span class='Ref_to_Member'>database_name</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4264"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN136"><span class='Ref_to_Member'>user_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BackendRun &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
 
<span class='Comment_Multi_Line'>/* 
 * postmaster_forkexec -- fork and exec a postmaster subprocess 
 * 
 * The caller must have set up the argv array already, except for argv[2] 
 * which will be filled with the name of the temp variable file. 
 * 
 * Returns the child process PID, or -1 on fork failure (a suitable error 
 * message has been logged on failure). 
 * 
 * All uses of this routine will dispatch to SubPostmasterMain in the 
 * child process. 
 */ 
</span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN4349"></a><span class='Declare_Function'>postmaster_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4351"></a>    <a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a>        <span class='Declare_Local'>port</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This entry point passes dummy values for the Port variables */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4351"><span class='Ref_To_Local'>port</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4351"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="postmaster.c.html#LN459"><span class='Ref_to_Proto'>internal_forkexec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4349"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4349"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4351"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * backend_forkexec -- fork/exec off a backend process 
 * 
 * Some operating systems (WIN32) don't have fork() so we have to simulate 
 * it by storing parameters that need to be passed to the child and 
 * then create a new child process. 
 * 
 * returns the pid of the fork/exec'd process, or -1 on failure 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN4368"></a><span class='Declare_Function'>backend_forkexec</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4370"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span><a name="LN4371"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN4370"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4371"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4370"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4371"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"--forkbackend"</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4370"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4371"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by internal_forkexec */ 
</span> 
    <a href="postmaster.c.html#LN4370"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4371"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4371"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4370"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="postmaster.c.html#LN459"><span class='Ref_to_Proto'>internal_forkexec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4371"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4370"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4368"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * internal_forkexec non-win32 implementation 
 * 
 * - writes out backend variables to the parameter file 
 * - fork():s, and then exec():s the child process 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN4392"></a><span class='Declare_Function'>internal_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[], </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4394"></a>    <span class='Keyword'>static unsigned long </span><span class='Declare_Local'>tmpBackendFileNum</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN4395"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span><a name="LN4396"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmpfilename</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN4397"></a>    <a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Declare_Local'>param</span><span class='Delimiter'>; 
</span><a name="LN4398"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN530"><span class='Ref_to_Proto'>save_backend_variables</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4397"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* log made by save_backend_variables */ 
</span> 
    <span class='Comment_Multi_Line'>/* Calculate name for temp file */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s/%s.backend_var.%d.%lu"</span><span class='Delimiter'>, 
</span>             <a href="../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Delimiter'>, </span><a href="../../include/storage/fd.h.html#LN127"><span class='Ref_to_Const'>PG_TEMP_FILE_PREFIX</span></a><span class='Delimiter'>, 
</span>             <a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>, </span><span class='Operator'>++</span><a href="postmaster.c.html#LN4394"><span class='Ref_To_Local'>tmpBackendFileNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open file */ 
</span>    <a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN1035"><span class='Ref_to_Const'>PG_BINARY_W</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * As in OpenTemporaryFileInTablespace, try to make the temp-file 
         * directory 
         */ 
</span>        <a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN1035"><span class='Ref_to_Const'>PG_BINARY_W</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fwrite<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4397"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4397"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Release file */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4398"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure caller set up argv properly */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT;= </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--fork"</span><span class='Delimiter'>, </span><span class='Number'>6</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Insert temp file name after --fork argument */ 
</span>    <a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="postmaster.c.html#LN4396"><span class='Ref_To_Local'>tmpfilename</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fire off execv in child */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN4395"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>())</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>execv<span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN67"><span class='Ref_to_Global_Var'>postgres_exec_path</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4392"><span class='Ref_to_Parameter'>argv</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not execute server process \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../utils/init/globals.c.html#LN67"><span class='Ref_to_Global_Var'>postgres_exec_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* We're already in the child process here, can't return */ 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="postmaster.c.html#LN4395"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* Parent returns pid, or -1 on fork failure */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end internal_forkexec &raquo; </span> 
<span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * internal_forkexec win32 implementation 
 * 
 * - starts backend using CreateProcess(), in suspended state 
 * - writes out backend variables to the parameter file 
 *  - during this, duplicates handles and sockets required for 
 *    inheritance into the new process 
 * - resumes execution of the new process once the backend parameter 
 *   file is complete. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN4484"></a><span class='Declare_Function'>internal_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[], </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4486"></a>    STARTUPINFO <span class='Declare_Local'>si</span><span class='Delimiter'>; 
</span><a name="LN4487"></a>    PROCESS_INFORMATION <span class='Declare_Local'>pi</span><span class='Delimiter'>; 
</span><a name="LN4488"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN4489"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span><a name="LN4490"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cmdLine</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN4491"></a>    HANDLE      <span class='Declare_Local'>paramHandle</span><span class='Delimiter'>; 
</span><a name="LN4492"></a>    <a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Local'>param</span><span class='Delimiter'>; 
</span><a name="LN4493"></a>    SECURITY_ATTRIBUTES <span class='Declare_Local'>sa</span><span class='Delimiter'>; 
</span><a name="LN4494"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>paramHandleStr</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN4495"></a>    <a href="postmaster.c.html#LN450"><span class='Ref_to_Typedef'>win32_deadchild_waitinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>childinfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure caller set up argv properly */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT;= </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--fork"</span><span class='Delimiter'>, </span><span class='Number'>6</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up shared memory for parameter passing */ 
</span>    ZeroMemory<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4493"><span class='Ref_To_Local'>sa</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4493"><span class='Ref_To_Local'>sa</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4493"><span class='Ref_To_Local'>sa</span></a><span class='Operator'>.</span>nLength <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4493"><span class='Ref_To_Local'>sa</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4493"><span class='Ref_To_Local'>sa</span></a><span class='Operator'>.</span>bInheritHandle <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a> <span class='Operator'>= </span>CreateFileMapping<span class='Parentheses'>(</span>INVALID_HANDLE_VALUE<span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="postmaster.c.html#LN4493"><span class='Ref_To_Local'>sa</span></a><span class='Delimiter'>, 
</span>                                    PAGE_READWRITE<span class='Delimiter'>, 
</span>                                    <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a> <span class='Operator'>== </span>INVALID_HANDLE_VALUE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not create backend parameter file mapping: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="postmaster.c.html#LN4492"><span class='Ref_To_Local'>param</span></a> <span class='Operator'>= </span>MapViewOfFile<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a><span class='Delimiter'>, </span>FILE_MAP_WRITE<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN4492"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not map backend parameter memory: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Insert temp file name after --fork argument */ 
</span><span class='Directive'>#ifdef</span> _WIN64 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4494"><span class='Ref_To_Local'>paramHandleStr</span></a><span class='Delimiter'>, </span><span class='String'>"%llu"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span>LONG_PTR<span class='Parentheses'>) </span><a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4494"><span class='Ref_To_Local'>paramHandleStr</span></a><span class='Delimiter'>, </span><span class='String'>"%lu"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>DWORD</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="postmaster.c.html#LN4494"><span class='Ref_To_Local'>paramHandleStr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Format the cmd line */ 
</span>    <a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Delimiter'>[</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Delimiter'>[</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"\"%s\""</span><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN67"><span class='Ref_to_Global_Var'>postgres_exec_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4488"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Operator'>++</span><a href="postmaster.c.html#LN4488"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN4489"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a> <span class='Operator'>+ </span><a href="postmaster.c.html#LN4489"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span> <span class='Operator'>- </span><a href="postmaster.c.html#LN4489"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, </span><span class='String'>" \"%s\""</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN4488"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Delimiter'>[</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"subprocess command line too long"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4486"><span class='Ref_To_Local'>si</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4486"><span class='Ref_To_Local'>si</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4486"><span class='Ref_To_Local'>si</span></a><span class='Operator'>.</span>cb <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4486"><span class='Ref_To_Local'>si</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the subprocess in a suspended state. This will be resumed later, 
     * once we have written out the parameter file. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CreateProcess<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4490"><span class='Ref_To_Local'>cmdLine</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span>CREATE_SUSPENDED<span class='Delimiter'>, 
</span>                       <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4486"><span class='Ref_To_Local'>si</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"CreateProcess call failed: %m (error code %lu)"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN530"><span class='Ref_to_Proto'>save_backend_variables</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4492"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4484"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Delimiter'>, </span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>dwProcessId<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * log made by save_backend_variables, but we have to clean up the 
         * mess with the half-started process 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>TerminateProcess<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Delimiter'>, </span><span class='Number'>255</span><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not terminate unstarted process: error code %lu"</span><span class='Delimiter'>, 
</span>                                     GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* log made by save_backend_variables */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Drop the parameter shared memory that is now inherited to the backend */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>UnmapViewOfFile<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4492"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not unmap view of backend parameter file: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4491"><span class='Ref_To_Local'>paramHandle</span></a><span class='Parentheses'>))</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not close handle to backend parameter file: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reserve the memory region used by our main shared memory segment before 
     * we resume the child process. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/win32.h.html#LN394"><span class='Ref_to_Proto'>pgwin32_ReserveSharedMemoryRegion</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Failed to reserve the memory, so terminate the newly created 
         * process and give up. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>TerminateProcess<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Delimiter'>, </span><span class='Number'>255</span><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not terminate process that failed to reserve memory: error code %lu"</span><span class='Delimiter'>, 
</span>                                     GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>              <span class='Comment_Multi_Line'>/* logging done made by 
                                 * pgwin32_ReserveSharedMemoryRegion() */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that the backend variables are written out, we start the child 
     * thread so it can start initializing while we set up the rest of the 
     * parent state. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>ResumeThread<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>TerminateProcess<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Delimiter'>, </span><span class='Number'>255</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not terminate unstartable process: error code %lu"</span><span class='Delimiter'>, 
</span>                                     GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>            CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not resume thread of unstarted process: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Queue a waiter for to signal when this child dies. The wait will be 
     * handled automatically by an operating system thread pool. 
     * 
     * Note: use malloc instead of palloc, since it needs to be thread-safe. 
     * Struct will be free():d from the callback function that runs on a 
     * different thread. 
     */ 
</span>    <a href="postmaster.c.html#LN4495"><span class='Ref_To_Local'>childinfo</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN450"><span class='Ref_to_Typedef'>win32_deadchild_waitinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN4495"><span class='Ref_To_Local'>childinfo</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN4495"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN453"><span class='Ref_to_Member'>procHandle</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN4495"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN454"><span class='Ref_to_Member'>procId</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>dwProcessId<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../port/win32/mingwcompat.c.html#LN58"><span class='Ref_to_Func'>RegisterWaitForSingleObject</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4495"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN452"><span class='Ref_to_Member'>waitHandle</span></a><span class='Delimiter'>, 
</span>                                     <a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hProcess<span class='Delimiter'>, 
</span>                                     <a href="postmaster.c.html#LN446"><span class='Ref_to_Proto'>pgwin32_deadchild_callback</span></a><span class='Delimiter'>, 
</span>                                     <a href="postmaster.c.html#LN4495"><span class='Ref_To_Local'>childinfo</span></a><span class='Delimiter'>, 
</span>                                     INFINITE<span class='Delimiter'>, 
</span>                                WT_EXECUTEONLYONCE <span class='Operator'>| </span>WT_EXECUTEINWAITTHREAD<span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not register process for wait: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't close pi.hProcess here - the wait thread needs access to it */ 
</span> 
    CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>hThread<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="postmaster.c.html#LN4487"><span class='Ref_To_Local'>pi</span></a><span class='Operator'>.</span>dwProcessId<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end internal_forkexec &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * SubPostmasterMain -- Get the fork/exec'd process into a state equivalent 
 *          to what it would be if we'd simply forked on Unix, and then 
 *          dispatch to the appropriate place. 
 * 
 * The first two command line arguments are expected to be "--forkFOO" 
 * (where FOO indicates which postmaster child we are to become), and 
 * the name of a variables file that we can read to load data that would 
 * have been inherited by fork() on Unix.  Remaining arguments go to the 
 * subprocess FooMain() routine. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4684"></a><span class='Declare_Function'>SubPostmasterMain</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4686"></a>    <a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a>        <span class='Declare_Local'>port</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* In EXEC_BACKEND case we will not have inherited these settings */ 
</span>    <a href="../utils/init/globals.c.html#LN99"><span class='Ref_to_Global_Var'>IsPostmasterEnvironment</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../tcop/postgres.c.html#LN87"><span class='Ref_to_Global_Var'>whereToSendOutput</span></a> <span class='Operator'>= </span><a href="../../include/tcop/dest.h.html#LN87"><span class='Ref_to_EnumConst'>DestNone</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Setup as postmaster child */ 
</span>    <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Setup essential subsystems (to ensure elog() behaves sanely) */ 
</span>    <a href="../../include/utils/guc.h.html#LN350"><span class='Ref_to_Proto'>InitializeGUCOptions</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check we got appropriate args */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"invalid subpostmaster invocation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read in the variables file */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4686"><span class='Ref_To_Local'>port</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN526"><span class='Ref_to_Proto'>read_backend_variables</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="postmaster.c.html#LN4686"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close the postmaster's sockets (as soon as we know them) */ 
</span>    <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forklog"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set reference point for stack-depth checking 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN273"><span class='Ref_to_Proto'>set_stack_base</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up memory area for GSS information. Mirrors the code in ConnCreate 
     * for the non-exec case. 
     */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>ENABLE_GSS<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN30"><span class='Ref_to_Const'>ENABLE_SSPI</span></a><span class='Parentheses'>) 
</span>    <a href="postmaster.c.html#LN4686"><span class='Ref_To_Local'>port</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN81"><span class='Ref_to_Typedef'>pg_gssinfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN81"><span class='Ref_to_Typedef'>pg_gssinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN4686"><span class='Ref_To_Local'>port</span></a><span class='Operator'>.</span><a href="../../include/libpq/libpq-be.h.html#LN172"><span class='Ref_to_Member'>gss</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If appropriate, physically re-attach to shared memory segment. We want 
     * to do this before going any further to ensure that we can attach at the 
     * same address the postmaster used.  On the other hand, if we choose not 
     * to re-attach, we may have other cleanup to do. 
     * 
     * If testing EXEC_BACKEND on Linux, you should run this as root before 
     * starting the postmaster: 
     * 
     * echo 0 &GT;/proc/sys/kernel/randomize_va_space 
     * 
     * This prevents using randomized stack and code addresses that cause the 
     * child process's memory map to be different from the parent's, making it 
     * sometimes impossible to attach to shared memory at the desired address. 
     * Return the setting to its old value (usually '1' or '2') when finished. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkbackend"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkavlauncher"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkavworker"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkboot"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        strncmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkbgworker="</span><span class='Delimiter'>, </span><span class='Number'>15</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/storage/pg_shmem.h.html#LN62"><span class='Ref_to_Proto'>PGSharedMemoryReAttach</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../include/storage/pg_shmem.h.html#LN63"><span class='Ref_to_Proto'>PGSharedMemoryNoReAttach</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* autovacuum needs this set before calling InitProcess */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkavlauncher"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/postmaster/autovacuum.h.html#LN70"><span class='Ref_to_Proto'>AutovacuumLauncherIAm</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkavworker"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/postmaster/autovacuum.h.html#LN69"><span class='Ref_to_Proto'>AutovacuumWorkerIAm</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start our win32 signal implementation. This has to be done after we 
     * read the backend variables, because we need to pick up the signal pipe 
     * from the parent process. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="../port/win32/signal.c.html#LN66"><span class='Ref_to_Func'>pgwin32_signal_initialize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* In EXEC_BACKEND case we will not have inherited these settings */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN36"><span class='Ref_to_Proto'>pqinitmask</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Read in remaining GUC variables */ 
</span>    <a href="../../include/utils/guc.h.html#LN386"><span class='Ref_to_Proto'>read_nondefault_variables</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reload any libraries that were preloaded by the postmaster.  Since we 
     * exec'd this process, those libraries didn't come along with us; but we 
     * should load them into all child processes to be consistent with the 
     * non-EXEC_BACKEND behavior. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN465"><span class='Ref_to_Proto'>process_shared_preload_libraries</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Run backend or appropriate child */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkbackend"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>== </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* shouldn't be any more args */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Need to reinitialize the SSL library in the backend, since the 
         * context structures contain function pointers and cannot be passed 
         * through the parameter file. 
         * 
         * If for some reason reload fails (maybe the user installed broken 
         * key files), soldier on without SSL; that's better than all 
         * connections becoming impossible. 
         * 
         * XXX should we do this in all child processes?  For the moment it's 
         * enough to do it in backend children. 
         */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/pg_config_manual.h.html#LN172"><span class='Ref_to_Const'>USE_SSL</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN232"><span class='Ref_to_Global_Var'>EnableSSL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../libpq/be-secure.c.html#LN71"><span class='Ref_to_Func'>secure_initialize</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="postmaster.c.html#LN374"><span class='Ref_to_Global_Var'>LoadedSSL</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SSL configuration could not be loaded in child process"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Perform additional initialization and collect startup packet. 
         * 
         * We want to do this before InitProcess() for a couple of reasons: 1. 
         * so that we aren't eating up a PGPROC slot while waiting on the 
         * client. 2. so that if InitProcess() fails due to being out of 
         * PGPROC slots, we have already initialized libpq and are able to 
         * report the error to the client. 
         */ 
</span>        <a href="postmaster.c.html#LN404"><span class='Ref_to_Proto'>BackendInitialize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4686"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Restore basic shared memory pointers */ 
</span>        <a href="../../include/storage/shmem.h.html#LN34"><span class='Ref_to_Proto'>InitShmemAccess</span></a><span class='Parentheses'>(</span><a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a PGPROC to run CreateSharedMemoryAndSemaphores */ 
</span>        <a href="../storage/lmgr/proc.c.html#LN285"><span class='Ref_to_Func'>InitProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Attach process to shared data structures */ 
</span>        <a href="../../include/storage/ipc.h.html#LN77"><span class='Ref_to_Proto'>CreateSharedMemoryAndSemaphores</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And run the backend */ 
</span>        <a href="postmaster.c.html#LN4263"><span class='Ref_to_Func'>BackendRun</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN4686"><span class='Ref_To_Local'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(argv[1],"--for... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkboot"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Restore basic shared memory pointers */ 
</span>        <a href="../../include/storage/shmem.h.html#LN34"><span class='Ref_to_Proto'>InitShmemAccess</span></a><span class='Parentheses'>(</span><a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a PGPROC to run CreateSharedMemoryAndSemaphores */ 
</span>        <a href="../../include/storage/proc.h.html#LN290"><span class='Ref_to_Proto'>InitAuxiliaryProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Attach process to shared data structures */ 
</span>        <a href="../../include/storage/ipc.h.html#LN77"><span class='Ref_to_Proto'>CreateSharedMemoryAndSemaphores</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../bootstrap/bootstrap.c.html#LN192"><span class='Ref_to_Func'>AuxiliaryProcessMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkavlauncher"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Restore basic shared memory pointers */ 
</span>        <a href="../../include/storage/shmem.h.html#LN34"><span class='Ref_to_Proto'>InitShmemAccess</span></a><span class='Parentheses'>(</span><a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a PGPROC to run CreateSharedMemoryAndSemaphores */ 
</span>        <a href="../storage/lmgr/proc.c.html#LN285"><span class='Ref_to_Func'>InitProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Attach process to shared data structures */ 
</span>        <a href="../../include/storage/ipc.h.html#LN77"><span class='Ref_to_Proto'>CreateSharedMemoryAndSemaphores</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN440"><span class='Ref_to_Func'>AutoVacLauncherMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkavworker"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Restore basic shared memory pointers */ 
</span>        <a href="../../include/storage/shmem.h.html#LN34"><span class='Ref_to_Proto'>InitShmemAccess</span></a><span class='Parentheses'>(</span><a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a PGPROC to run CreateSharedMemoryAndSemaphores */ 
</span>        <a href="../storage/lmgr/proc.c.html#LN285"><span class='Ref_to_Func'>InitProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Attach process to shared data structures */ 
</span>        <a href="../../include/storage/ipc.h.html#LN77"><span class='Ref_to_Proto'>CreateSharedMemoryAndSemaphores</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="autovacuum.c.html#LN1524"><span class='Ref_to_Func'>AutoVacWorkerMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkbgworker="</span><span class='Delimiter'>, </span><span class='Number'>15</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN4873"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>shmem_slot</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* do this as early as possible; in particular, before InitProcess() */ 
</span>        <a href="../utils/init/globals.c.html#LN102"><span class='Ref_to_Global_Var'>IsBackgroundWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Restore basic shared memory pointers */ 
</span>        <a href="../../include/storage/shmem.h.html#LN34"><span class='Ref_to_Proto'>InitShmemAccess</span></a><span class='Parentheses'>(</span><a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need a PGPROC to run CreateSharedMemoryAndSemaphores */ 
</span>        <a href="../storage/lmgr/proc.c.html#LN285"><span class='Ref_to_Func'>InitProcess</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Attach process to shared data structures */ 
</span>        <a href="../../include/storage/ipc.h.html#LN77"><span class='Ref_to_Proto'>CreateSharedMemoryAndSemaphores</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch MyBgworkerEntry from shared memory */ 
</span>        <a href="postmaster.c.html#LN4873"><span class='Ref_To_Local'>shmem_slot</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>+ </span><span class='Number'>15</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN188"><span class='Ref_to_Global_Var'>MyBgworkerEntry</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/bgworker_internals.h.html#LN59"><span class='Ref_to_Proto'>BackgroundWorkerEntry</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4873"><span class='Ref_To_Local'>shmem_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="bgworker.c.html#LN698"><span class='Ref_to_Func'>StartBackgroundWorker</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strncmp(argv[1],"--fo... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkarch"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Do not want to attach to shared memory */ 
</span> 
        <a href="pgarch.c.html#LN88"><span class='Ref_to_Func'>PgArchiverMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forkcol"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Do not want to attach to shared memory */ 
</span> 
        <a href="pgstat.c.html#LN4176"><span class='Ref_to_Func'>PgstatCollectorMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--forklog"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Do not want to attach to shared memory */ 
</span> 
        <a href="syslogger.c.html#LN133"><span class='Ref_to_Func'>SysLoggerMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN4684"><span class='Ref_to_Parameter'>argv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* does not return */ 
</span>    <span class='Delimiter'>} 
</span> 
    abort<span class='Parentheses'>()</span><span class='Delimiter'>;</span>                    <span class='Comment_Single_Line'>/* shouldn't get here */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SubPostmasterMain &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * ExitPostmaster -- cleanup 
 * 
 * Do NOT call exit() directly --- always go through here! 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4923"></a><span class='Declare_Function'>ExitPostmaster</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_PTHREAD_IS_THREADED_NP 
 
    <span class='Comment_Multi_Line'>/* 
     * There is no known cause for a postmaster to become multithreaded after 
     * startup.  Recheck to account for the possibility of unknown causes. 
     * This message uses LOG level, because an unclean shutdown at this point 
     * would usually not look much different from a clean shutdown. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>pthread_is_threaded_np<span class='Parentheses'>() </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"postmaster became multithreaded"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Please report this to &LT;pgsql-bugs@postgresql.org&GT;."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* should cleanup shared memory and kill all backends */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Not sure of the semantics here.  When the Postmaster dies, should the 
     * backends all be killed? probably not. 
     * 
     * MUST     -- vadim 05-10-1999 
     */ 
</span> 
    <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN4923"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExitPostmaster &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * sigusr1_handler - handle signal conditions from child processes 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN4956"></a><span class='Declare_Function'>sigusr1_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4958"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process background worker state change. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN30"><span class='Ref_to_EnumConst'>PMSIGNAL_BACKGROUND_WORKER_CHANGE</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/postmaster/bgworker_internals.h.html#LN48"><span class='Ref_to_Proto'>BackgroundWorkerStateChange</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * RECOVERY_STARTED and BEGIN_HOT_STANDBY signals are ignored in 
     * unexpected states. If the startup process quickly starts up, completes 
     * recovery, exits, we might process the death of the startup process 
     * first. We don't want to go back to recovery in that case. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN24"><span class='Ref_to_EnumConst'>PMSIGNAL_RECOVERY_STARTED</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* WAL redo has started. We're out of reinitialization. */ 
</span>        <a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN341"><span class='Ref_to_Global_Var'>AbortStartTime</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Crank up the background tasks.  It doesn't matter if this fails, 
         * we'll just try again later. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN248"><span class='Ref_to_Global_Var'>CheckpointerPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN542"><span class='Ref_to_Macro'>StartCheckpointer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN247"><span class='Ref_to_Global_Var'>BgWriterPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN541"><span class='Ref_to_Macro'>StartBackgroundWriter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Start the archiver if we're responsible for (re-)archiving received 
         * files. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN136"><span class='Ref_to_Macro'>XLogArchivingAlways</span></a><span class='Parentheses'>())</span> 
            <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/pgarch.h.html#LN32"><span class='Ref_to_Proto'>pgarch_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_SYSTEMD 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../access/transam/xlog.c.html#LN95"><span class='Ref_to_Global_Var'>EnableHotStandby</span></a><span class='Parentheses'>) 
</span>            sd_notify<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='String'>"READY=1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if CheckPostmasterSignal... &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN25"><span class='Ref_to_EnumConst'>PMSIGNAL_BEGIN_HOT_STANDBY</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>&& </span><a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Likewise, start other special children as needed. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN253"><span class='Ref_to_Global_Var'>PgStatPID</span></a> <span class='Operator'>= </span><a href="pgstat.c.html#LN725"><span class='Ref_to_Func'>pgstat_start</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database system is ready to accept read only connections"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_SYSTEMD 
        sd_notify<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='String'>"READY=1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Some workers may be scheduled to start now */ 
</span>        <a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if CheckPostmasterSignal... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a><span class='Parentheses'>) 
</span>        <a href="postmaster.c.html#LN423"><span class='Ref_to_Proto'>maybe_start_bgworkers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN26"><span class='Ref_to_EnumConst'>PMSIGNAL_WAKEN_ARCHIVER</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Send SIGUSR1 to archiver process, to wake it up and begin archiving 
         * next WAL file. 
         */ 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN252"><span class='Ref_to_Global_Var'>PgArchPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN27"><span class='Ref_to_EnumConst'>PMSIGNAL_ROTATE_LOGFILE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Tell syslogger to rotate logfile */ 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN254"><span class='Ref_to_Global_Var'>SysLoggerPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN28"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_LAUNCHER</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Start one iteration of the autovacuum daemon, even if autovacuuming 
         * is nominally not enabled.  This is so we can have an active defense 
         * against transaction ID wraparound.  We set a flag for the main loop 
         * to do it rather than trying to do it here --- this is because the 
         * autovac process itself may send the signal, and we want to handle 
         * that by launching another iteration as soon as the current one 
         * completes. 
         */ 
</span>        <a href="postmaster.c.html#LN353"><span class='Ref_to_Global_Var'>start_autovac_launcher</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN29"><span class='Ref_to_EnumConst'>PMSIGNAL_START_AUTOVAC_WORKER</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The autovacuum launcher wants us to start a worker process. */ 
</span>        <a href="postmaster.c.html#LN426"><span class='Ref_to_Proto'>StartAutovacuumWorker</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN31"><span class='Ref_to_EnumConst'>PMSIGNAL_START_WALRECEIVER</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>|| 
</span>         <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="postmaster.c.html#LN273"><span class='Ref_to_Global_Var'>Shutdown</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN268"><span class='Ref_to_Const'>NoShutdown</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Startup Process wants us to start the walreceiver process. */ 
</span>        <a href="postmaster.c.html#LN250"><span class='Ref_to_Global_Var'>WalReceiverPID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN544"><span class='Ref_to_Macro'>StartWalReceiver</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN46"><span class='Ref_to_Proto'>CheckPostmasterSignal</span></a><span class='Parentheses'>(</span><a href="../../include/storage/pmsignal.h.html#LN32"><span class='Ref_to_EnumConst'>PMSIGNAL_ADVANCE_STATE_MACHINE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Advance postmaster's state machine */ 
</span>        <a href="postmaster.c.html#LN403"><span class='Ref_to_Proto'>PostmasterStateMachine</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN280"><span class='Ref_to_Proto'>CheckPromoteSignal</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a> <span class='Operator'>|| 
</span>         <a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Tell startup process to finish recovery */ 
</span>        <a href="postmaster.c.html#LN415"><span class='Ref_to_Proto'>signal_child</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN246"><span class='Ref_to_Global_Var'>StartupPID</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="postmaster.c.html#LN4958"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sigusr1_handler &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SIGTERM or SIGQUIT while processing startup packet. 
 * Clean up and exit(1). 
 * 
 * XXX: possible future improvement: try to send a message indicating 
 * why we are disconnecting.  Problem is to be sure we don't block while 
 * doing so, nor mess up SSL initialization.  In practice, if the client 
 * has wedged here, it probably couldn't do anything with the message anyway. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5109"></a><span class='Declare_Function'>startup_die</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Dummy signal handler 
 * 
 * We use this for signals that we don't actually use in the postmaster, 
 * but we do use in backends.  If we were to SIG_IGN such signals in the 
 * postmaster, then a newly started backend might drop a signal that arrives 
 * before it's able to reconfigure its signal processing.  (See notes in 
 * tcop/postgres.c.) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5124"></a><span class='Declare_Function'>dummy_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Timeout while processing startup packet. 
 * As for startup_die(), we clean up and exit(1). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5133"></a><span class='Declare_Function'>StartupPacketTimeoutHandler</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Generate a random cancel key. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5143"></a><span class='Declare_Function'>RandomCancelKey</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cancel_key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_STRONG_RANDOM 
    <span class='Control'>return</span> <a href="../../port/pg_strong_random.c.html#LN98"><span class='Ref_to_Func'>pg_strong_random</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN5143"><span class='Ref_to_Parameter'>cancel_key</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If built with --disable-strong-random, use plain old erand48. 
     * 
     * We cannot use pg_backend_random() in postmaster, because it stores its 
     * state in shared memory. 
     */ 
</span><a name="LN5155"></a>    <span class='Keyword'>static unsigned short </span><span class='Declare_Local'>seed</span><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select a random seed at the time of first receiving a request. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN368"><span class='Ref_to_Global_Var'>random_seed</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5162"></a>        <span class='Control'>struct</span> timeval <span class='Declare_Local'>random_stop_time</span><span class='Delimiter'>; 
</span> 
        <a href="../../port/gettimeofday.c.html#LN103"><span class='Ref_to_Func'>gettimeofday</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5162"><span class='Ref_To_Local'>random_stop_time</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN5155"><span class='Ref_To_Local'>seed</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN369"><span class='Ref_to_Global_Var'>random_start_time</span></a><span class='Operator'>.</span>tv_usec<span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN5155"><span class='Ref_To_Local'>seed</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) (</span><a href="postmaster.c.html#LN5162"><span class='Ref_To_Local'>random_stop_time</span></a><span class='Operator'>.</span>tv_usec<span class='Parentheses'>) </span><span class='Operator'>^ </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN369"><span class='Ref_to_Global_Var'>random_start_time</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN5155"><span class='Ref_To_Local'>seed</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) (</span><a href="postmaster.c.html#LN5162"><span class='Ref_To_Local'>random_stop_time</span></a><span class='Operator'>.</span>tv_usec <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN368"><span class='Ref_to_Global_Var'>random_seed</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="postmaster.c.html#LN5143"><span class='Ref_to_Parameter'>cancel_key</span></a> <span class='Operator'>= </span><a href="../../port/erand48.c.html#LN93"><span class='Ref_to_Func'>pg_jrand48</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5155"><span class='Ref_To_Local'>seed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end RandomCancelKey &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Count up number of child processes of specified types (dead_end children 
 * are always excluded). 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN5184"></a><span class='Declare_Function'>CountChildren</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>target</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5186"></a>    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN5187"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>cnt</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5186"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5191"></a>        <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bp</span> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Delimiter'>, </span>elem<span class='Delimiter'>, </span><a href="postmaster.c.html#LN5186"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5191"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Since target == BACKEND_TYPE_ALL is the most common case, we test 
         * it first and avoid touching shared memory for every child. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5184"><span class='Ref_to_Parameter'>target</span></a> <span class='Operator'>!= </span><a href="postmaster.c.html#LN145"><span class='Ref_to_Const'>BACKEND_TYPE_ALL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Assign bkend_type for any recently announced WAL Sender 
             * processes. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5191"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN141"><span class='Ref_to_Const'>BACKEND_TYPE_NORMAL</span></a> <span class='Operator'>&& 
</span>                <a href="../../include/storage/pmsignal.h.html#LN49"><span class='Ref_to_Proto'>IsPostmasterChildWalSender</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5191"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Parentheses'>))</span> 
                <a href="postmaster.c.html#LN5191"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN143"><span class='Ref_to_Const'>BACKEND_TYPE_WALSND</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5184"><span class='Ref_to_Parameter'>target</span></a> <span class='Operator'>& </span><a href="postmaster.c.html#LN5191"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="postmaster.c.html#LN5187"><span class='Ref_To_Local'>cnt</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="postmaster.c.html#LN5187"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CountChildren &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * StartChildProcess -- start an auxiliary process for the postmaster 
 * 
 * "type" determines what kind of child will be started.  All child types 
 * initially go to AuxiliaryProcessMain, which will handle common setup. 
 * 
 * Return value of StartChildProcess is subprocess' PID, or 0 if failed 
 * to start subprocess. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN5230"></a><span class='Declare_Function'>StartChildProcess</span><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN390"><span class='Ref_to_Typedef'>AuxProcType</span></a> <span class='Declare_Parameter'>type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5232"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span><a name="LN5233"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN5234"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5235"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>typebuf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up command-line arguments for subprocess 
     */ 
</span>    <a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"--forkboot"</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by postmaster_forkexec */ 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5235"><span class='Ref_To_Local'>typebuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5235"><span class='Ref_To_Local'>typebuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"-x%d"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5230"><span class='Ref_to_Parameter'>type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="postmaster.c.html#LN5235"><span class='Ref_To_Local'>typebuf</span></a><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <a href="postmaster.c.html#LN5232"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/postmaster.h.html#LN57"><span class='Ref_to_Proto'>postmaster_forkexec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !EXEC_BACKEND */ 
</span>    <a href="postmaster.c.html#LN5232"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5232"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span>               <span class='Comment_Single_Line'>/* child */ 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>        <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release postmaster's working memory context */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN44"><span class='Ref_to_Global_Var'>PostmasterContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../utils/mmgr/mcxt.c.html#LN44"><span class='Ref_to_Global_Var'>PostmasterContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="../bootstrap/bootstrap.c.html#LN192"><span class='Ref_to_Func'>AuxiliaryProcessMain</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5234"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5233"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5232"><span class='Ref_To_Local'>pid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* in parent, fork failed */ 
</span><a name="LN5278"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        errno <span class='Operator'>= </span><a href="postmaster.c.html#LN5278"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5230"><span class='Ref_to_Parameter'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN395"><span class='Ref_to_EnumConst'>StartupProcess</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork startup process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN396"><span class='Ref_to_EnumConst'>BgWriterProcess</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                   <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork background writer process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN397"><span class='Ref_to_EnumConst'>CheckpointerProcess</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork checkpointer process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN398"><span class='Ref_to_EnumConst'>WalWriterProcess</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork WAL writer process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/miscadmin.h.html#LN399"><span class='Ref_to_EnumConst'>WalReceiverProcess</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork WAL receiver process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * fork failure is fatal during startup, but there's no need to choke 
         * immediately if starting other child types fails. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5230"><span class='Ref_to_Parameter'>type</span></a> <span class='Operator'>== </span><a href="../../include/miscadmin.h.html#LN395"><span class='Ref_to_EnumConst'>StartupProcess</span></a><span class='Parentheses'>) 
</span>            <a href="postmaster.c.html#LN4922"><span class='Ref_to_Func'>ExitPostmaster</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if pid&LT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * in parent, successful fork 
     */ 
</span>    <span class='Control'>return</span> <a href="postmaster.c.html#LN5232"><span class='Ref_To_Local'>pid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartChildProcess &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * StartAutovacuumWorker 
 *      Start an autovac worker process. 
 * 
 * This function is here because it enters the resulting PID into the 
 * postmaster's private backends list. 
 * 
 * NB -- this code very roughly matches BackendStartup. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5334"></a><span class='Declare_Function'>StartAutovacuumWorker</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5336"></a>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bn</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If not in condition to run a process, don't try, but handle it like a 
     * fork failure.  This does not normally happen, since the signal is only 
     * supposed to be sent by autovacuum launcher when it's OK to do it, but 
     * we have to check to avoid race-condition problems during DB state 
     * changes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN413"><span class='Ref_to_Proto'>canAcceptConnections</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><a href="../../include/libpq/libpq-be.h.html#LN72"><span class='Ref_to_EnumConst'>CAC_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Compute the cancel key that will be assigned to this session. We 
         * probably don't need cancel keys for autovac workers, but we'd 
         * better have something random in the field to prevent unfriendly 
         * people from sending cancels to them. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN414"><span class='Ref_to_Proto'>RandomCancelKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not generate random cancel key"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN168"><span class='Ref_to_Member'>cancel_key</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Autovac workers are not dead_end and need a child slot */ 
</span>            <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN42"><span class='Ref_to_Global_Var'>MyPMChildSlot</span></a> <span class='Operator'>= </span><a href="../../include/storage/pmsignal.h.html#LN47"><span class='Ref_to_Proto'>AssignPostmasterChildSlot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN178"><span class='Ref_to_Member'>bgworker_notify</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/autovacuum.h.html#LN58"><span class='Ref_to_Proto'>StartAutoVacWorker</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN142"><span class='Ref_to_Const'>BACKEND_TYPE_AUTOVAC</span></a><span class='Delimiter'>; 
</span>                <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN179"><span class='Ref_to_Member'>elem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
                <a href="postmaster.c.html#LN536"><span class='Ref_to_Proto'>ShmemBackendArrayAdd</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Comment_Multi_Line'>/* all OK */ 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * fork failed, fall through to report -- actual error message was 
             * logged by StartAutoVacWorker 
             */ 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5336"><span class='Ref_To_Local'>bn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if bn &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if canAcceptConnections(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Report the failure to the launcher, if it's running.  (If it's not, we 
     * might not even be connected to shared memory, so don't try to call 
     * AutoVacWorkerFailed.)  Note that we also need to signal it so that it 
     * responds to the condition, but we don't do that here, instead waiting 
     * for ServerLoop to do it.  This way we avoid a ping-pong signalling in 
     * quick succession between the autovac launcher and postmaster in case 
     * things get ugly. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN251"><span class='Ref_to_Global_Var'>AutoVacPID</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/postmaster/autovacuum.h.html#LN61"><span class='Ref_to_Proto'>AutoVacWorkerFailed</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN356"><span class='Ref_to_Global_Var'>avlauncher_needs_signal</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end StartAutovacuumWorker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create the opts file 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5416"></a><span class='Declare_Function'>CreateOptsFile</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[], </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fullprogname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5418"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span><a name="LN5419"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
<a name="LN5421"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>OPTS_FILE</span>   <span class='String'>"postmaster.opts"</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN5418"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5421"><span class='Ref_to_Const'>OPTS_FILE</span></a><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not create file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5421"><span class='Ref_to_Const'>OPTS_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5418"><span class='Ref_To_Local'>fp</span></a><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5416"><span class='Ref_to_Parameter'>fullprogname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5419"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="postmaster.c.html#LN5419"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="postmaster.c.html#LN5416"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>; </span><a href="postmaster.c.html#LN5419"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5418"><span class='Ref_To_Local'>fp</span></a><span class='Delimiter'>, </span><span class='String'>" \"%s\""</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5416"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5419"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/ecpg/preproc/pgc.l.html#LN390"><span class='Ref_to_Proto'>fputs</span></a><span class='Parentheses'>(</span><span class='String'>"\n"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5418"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fclose<span class='Parentheses'>(</span><a href="postmaster.c.html#LN5418"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not write file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5421"><span class='Ref_to_Const'>OPTS_FILE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateOptsFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * MaxLivePostmasterChildren 
 * 
 * This reports the number of entries needed in per-child-process arrays 
 * (the PMChildFlags array, and if EXEC_BACKEND the ShmemBackendArray). 
 * These arrays include regular backends, autovac workers, walsenders 
 * and background workers, but not special children nor dead_end children. 
 * This allows the arrays to have a fixed maximum size, to wit the same 
 * too-many-children limit enforced by canAcceptConnections().  The exact value 
 * isn't too critical as long as it's more than MaxBackends. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN5456"></a><span class='Declare_Function'>MaxLivePostmasterChildren</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Number'>2</span> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN123"><span class='Ref_to_Global_Var'>MaxConnections</span></a> <span class='Operator'>+ </span><a href="autovacuum.c.html#LN112"><span class='Ref_to_Global_Var'>autovacuum_max_workers</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ 
</span>                <a href="../utils/init/globals.c.html#LN124"><span class='Ref_to_Global_Var'>max_worker_processes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Connect background worker to a database. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN5466"></a><span class='Declare_Function'>BackgroundWorkerInitializeConnection</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbname</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>username</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5468"></a>    <a href="../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a> <span class='Operator'>*</span><span class='Declare_Local'>worker</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN188"><span class='Ref_to_Global_Var'>MyBgworkerEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XXX is this the right errcode? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5468"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker.h.html#LN90"><span class='Ref_to_Member'>bgw_flags</span></a> <span class='Operator'>& </span><a href="../../include/postmaster/bgworker.h.html#LN58"><span class='Ref_to_Const'>BGWORKER_BACKEND_DATABASE_CONNECTION</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database connection requirement not indicated during registration"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN422"><span class='Ref_to_Proto'>InitPostgres</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5466"><span class='Ref_to_Parameter'>dbname</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5466"><span class='Ref_to_Parameter'>username</span></a><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* it had better not gotten out of "init" mode yet */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN370"><span class='Ref_to_Macro'>IsInitProcessingMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid processing mode in background worker"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../include/miscadmin.h.html#LN375"><span class='Ref_to_Macro'>SetProcessingMode</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN364"><span class='Ref_to_EnumConst'>NormalProcessing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Connect background worker to a database using OIDs. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN5489"></a><span class='Declare_Function'>BackgroundWorkerInitializeConnectionByOid</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dboid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>useroid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5491"></a>    <a href="../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a> <span class='Operator'>*</span><span class='Declare_Local'>worker</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN188"><span class='Ref_to_Global_Var'>MyBgworkerEntry</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XXX is this the right errcode? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5491"><span class='Ref_To_Local'>worker</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker.h.html#LN90"><span class='Ref_to_Member'>bgw_flags</span></a> <span class='Operator'>& </span><a href="../../include/postmaster/bgworker.h.html#LN58"><span class='Ref_to_Const'>BGWORKER_BACKEND_DATABASE_CONNECTION</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database connection requirement not indicated during registration"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN422"><span class='Ref_to_Proto'>InitPostgres</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5489"><span class='Ref_to_Parameter'>dboid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5489"><span class='Ref_to_Parameter'>useroid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* it had better not gotten out of "init" mode yet */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/miscadmin.h.html#LN370"><span class='Ref_to_Macro'>IsInitProcessingMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid processing mode in background worker"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../include/miscadmin.h.html#LN375"><span class='Ref_to_Macro'>SetProcessingMode</span></a><span class='Parentheses'>(</span><a href="../../include/miscadmin.h.html#LN364"><span class='Ref_to_EnumConst'>NormalProcessing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Block/unblock signals in a background worker 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN5512"></a><span class='Declare_Function'>BackgroundWorkerBlockSignals</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN5518"></a><span class='Declare_Function'>BackgroundWorkerUnblockSignals</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
<span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN5525"></a><span class='Declare_Function'>bgworker_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>shmem_slot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5527"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN5528"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5529"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>forkav</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5529"><span class='Ref_To_Local'>forkav</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"--forkbgworker=%d"</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5525"><span class='Ref_to_Parameter'>shmem_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5527"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5528"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5527"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5528"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="postmaster.c.html#LN5529"><span class='Ref_To_Local'>forkav</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5527"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5528"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by postmaster_forkexec */ 
</span>    <a href="postmaster.c.html#LN5527"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN5528"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5528"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5527"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/postmaster/postmaster.h.html#LN57"><span class='Ref_to_Proto'>postmaster_forkexec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5528"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5527"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Start a new bgworker. 
 * Starting time conditions must have been checked already. 
 * 
 * Returns true on success, false on failure. 
 * In either case, update the RegisteredBgWorker's state appropriately. 
 * 
 * This code is heavily based on autovacuum.c, q.v. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5554"></a><span class='Declare_Function'>do_start_bgworker</span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rw</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5556"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>worker_pid</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate and assign the Backend element.  Note we must do this before 
     * forking, so that we can handle out of memory properly. 
     * 
     * Treat failure as though the worker had crashed.  That way, the 
     * postmaster will wait a bit before attempting to start it again; if it 
     * tried again right away, most likely it'd find itself repeating the 
     * out-of-memory or fork failure condition. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN422"><span class='Ref_to_Proto'>assign_backendlist_entry</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"starting background worker process \"%s\""</span><span class='Delimiter'>, 
</span>                    <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN89"><span class='Ref_to_Member'>bgw_name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN5556"><span class='Ref_To_Local'>worker_pid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN5524"><span class='Ref_to_Func'>bgworker_forkexec</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN39"><span class='Ref_to_Member'>rw_shmem_slot</span></a><span class='Parentheses'>)))</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="postmaster.c.html#LN5556"><span class='Ref_To_Local'>worker_pid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster, fork failed ... */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork worker process: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* undo what assign_backendlist_entry did */ 
</span>            <a href="../../include/storage/pmsignal.h.html#LN48"><span class='Ref_to_Proto'>ReleasePostmasterChildSlot</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* mark entry as crashed, so we'll try again later */ 
</span>            <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> EXEC_BACKEND 
        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster child ... */ 
</span>            <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>            <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Before blowing away PostmasterContext, save this bgworker's 
             * data where it can find it. 
             */ 
</span>            <a href="postmaster.c.html#LN188"><span class='Ref_to_Global_Var'>MyBgworkerEntry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="postmaster.c.html#LN188"><span class='Ref_to_Global_Var'>MyBgworkerEntry</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker.h.html#LN87"><span class='Ref_to_Struct'>BackgroundWorker</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Release postmaster's working memory context */ 
</span>            <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN44"><span class='Ref_to_Global_Var'>PostmasterContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../utils/mmgr/mcxt.c.html#LN44"><span class='Ref_to_Global_Var'>PostmasterContext</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <a href="bgworker.c.html#LN698"><span class='Ref_to_Func'>StartBackgroundWorker</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* should not get here */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster, fork successful ... */ 
</span>            <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN5556"><span class='Ref_To_Local'>worker_pid</span></a><span class='Delimiter'>; 
</span>            <a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/postmaster/bgworker_internals.h.html#LN50"><span class='Ref_to_Proto'>ReportBackgroundWorkerPID</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* add new worker to lists of backends */ 
</span>            <a href="../../include/lib/ilist.h.html#LN298"><span class='Ref_to_Func'>dlist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN179"><span class='Ref_to_Member'>elem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
            <a href="postmaster.c.html#LN536"><span class='Ref_to_Proto'>ShmemBackendArrayAdd</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5554"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch (worker_pid=fork_proc... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end do_start_bgworker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Does the current postmaster state require starting a worker with the 
 * specified start_time? 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5645"></a><span class='Declare_Function'>bgworker_should_start_now</span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker.h.html#LN75"><span class='Ref_to_Typedef'>BgWorkerStartTime</span></a> <span class='Declare_Parameter'>start_time</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN337"><span class='Ref_to_Global_Var'>pmState</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN334"><span class='Ref_to_EnumConst'>PM_NO_CHILDREN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN333"><span class='Ref_to_EnumConst'>PM_WAIT_DEAD_END</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN331"><span class='Ref_to_EnumConst'>PM_SHUTDOWN_2</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN329"><span class='Ref_to_EnumConst'>PM_SHUTDOWN</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN328"><span class='Ref_to_EnumConst'>PM_WAIT_BACKENDS</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN327"><span class='Ref_to_EnumConst'>PM_WAIT_READONLY</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN326"><span class='Ref_to_EnumConst'>PM_WAIT_BACKUP</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="postmaster.c.html#LN325"><span class='Ref_to_EnumConst'>PM_RUN</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5645"><span class='Ref_to_Parameter'>start_time</span></a> <span class='Operator'>== </span><a href="../../include/postmaster/bgworker.h.html#LN79"><span class='Ref_to_EnumConst'>BgWorkerStart_RecoveryFinished</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* fall through */ 
</span> 
        <span class='Control'>case</span> <a href="postmaster.c.html#LN324"><span class='Ref_to_EnumConst'>PM_HOT_STANDBY</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5645"><span class='Ref_to_Parameter'>start_time</span></a> <span class='Operator'>== </span><a href="../../include/postmaster/bgworker.h.html#LN78"><span class='Ref_to_EnumConst'>BgWorkerStart_ConsistentState</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* fall through */ 
</span> 
        <span class='Control'>case</span> <a href="postmaster.c.html#LN323"><span class='Ref_to_EnumConst'>PM_RECOVERY</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN322"><span class='Ref_to_EnumConst'>PM_STARTUP</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="postmaster.c.html#LN321"><span class='Ref_to_EnumConst'>PM_INIT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5645"><span class='Ref_to_Parameter'>start_time</span></a> <span class='Operator'>== </span><a href="../../include/postmaster/bgworker.h.html#LN77"><span class='Ref_to_EnumConst'>BgWorkerStart_PostmasterStart</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* fall through */ 
</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch pmState &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end bgworker_should_start_now &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate the Backend struct for a connected background worker, but don't 
 * add it to the list of backends just yet. 
 * 
 * On failure, return false without changing any worker state. 
 * 
 * Some info from the Backend is copied into the passed rw. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5689"></a><span class='Declare_Function'>assign_backendlist_entry</span><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rw</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5691"></a>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bn</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the cancel key that will be assigned to this session. We 
     * probably don't need cancel keys for background workers, but we'd better 
     * have something random in the field to prevent unfriendly people from 
     * sending cancels to them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN414"><span class='Ref_to_Proto'>RandomCancelKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not generate random cancel key"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a> <span class='Operator'>= </span><a href="../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN168"><span class='Ref_to_Member'>cancel_key</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN42"><span class='Ref_to_Global_Var'>MyPMChildSlot</span></a> <span class='Operator'>= </span><a href="../../include/storage/pmsignal.h.html#LN47"><span class='Ref_to_Proto'>AssignPostmasterChildSlot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN176"><span class='Ref_to_Member'>bkend_type</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN144"><span class='Ref_to_Const'>BACKEND_TYPE_BGWORKER</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN177"><span class='Ref_to_Member'>dead_end</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN178"><span class='Ref_to_Member'>bgworker_notify</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5689"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN35"><span class='Ref_to_Member'>rw_backend</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5689"><span class='Ref_to_Parameter'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN37"><span class='Ref_to_Member'>rw_child_slot</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN5691"><span class='Ref_To_Local'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end assign_backendlist_entry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * If the time is right, start background worker(s). 
 * 
 * As a side effect, the bgworker control variables are set or reset 
 * depending on whether more workers may need to be started. 
 * 
 * We limit the number of workers started per call, to avoid consuming the 
 * postmaster's attention for too long when many such requests are pending. 
 * As long as StartWorkerNeeded is true, ServerLoop will not block and will 
 * call this function again after dealing with any other issues. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN5740"></a><span class='Declare_Function'>maybe_start_bgworkers</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5742"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_BGWORKERS_TO_LAUNCH</span> <span class='Number'>100</span> 
<a name="LN5743"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_launched</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5744"></a>    <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN5745"></a>    <a href="../../include/lib/ilist.h.html#LN238"><span class='Ref_to_Struct'>slist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * During crash recovery, we have no need to be called until the state 
     * transition out of recovery. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN275"><span class='Ref_to_Global_Var'>FatalError</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Don't need to be called again unless we find a reason for it below */ 
</span>    <a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/lib/ilist.h.html#LN715"><span class='Ref_to_Macro'>slist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5745"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="bgworker.c.html#LN42"><span class='Ref_to_Global_Var'>BackgroundWorkerList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN5764"></a>        <a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rw</span><span class='Delimiter'>; 
</span> 
        <a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN673"><span class='Ref_to_Macro'>slist_container</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/bgworker_internals.h.html#LN32"><span class='Ref_to_Struct'>RegisteredBgWorker</span></a><span class='Delimiter'>, </span>rw_lnode<span class='Delimiter'>, </span><a href="postmaster.c.html#LN5745"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN240"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ignore if already running */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN36"><span class='Ref_to_Member'>rw_pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if marked for death, clean up and remove from list */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN40"><span class='Ref_to_Member'>rw_terminate</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/postmaster/bgworker_internals.h.html#LN49"><span class='Ref_to_Proto'>ForgetBackgroundWorker</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5745"><span class='Ref_To_Local'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this worker has crashed previously, maybe it needs to be 
         * restarted (unless on registration it specified it doesn't want to 
         * be restarted at all).  Check how long ago did a crash last happen. 
         * If the last crash is too recent, don't start it right away; let it 
         * be restarted once enough time has passed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN92"><span class='Ref_to_Member'>bgw_restart_time</span></a> <span class='Operator'>== </span><a href="../../include/postmaster/bgworker.h.html#LN83"><span class='Ref_to_Const'>BGW_NEVER_RESTART</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/postmaster/bgworker_internals.h.html#LN49"><span class='Ref_to_Proto'>ForgetBackgroundWorker</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5745"><span class='Ref_To_Local'>iter</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* read system time only when needed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5744"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="postmaster.c.html#LN5744"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5744"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, 
</span>                                      <a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN92"><span class='Ref_to_Member'>bgw_restart_time</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Set flag to remember that we have workers to start later */ 
</span>                <a href="postmaster.c.html#LN360"><span class='Ref_to_Global_Var'>HaveCrashedWorker</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rw-&GT;rw_crashed_at!=0 &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5644"><span class='Ref_to_Func'>bgworker_should_start_now</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN34"><span class='Ref_to_Member'>rw_worker</span></a><span class='Operator'>.</span><a href="../../include/postmaster/bgworker.h.html#LN91"><span class='Ref_to_Member'>bgw_start_time</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* reset crash time before trying to start worker */ 
</span>            <a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Operator'>-&GT;</span><a href="../../include/postmaster/bgworker_internals.h.html#LN38"><span class='Ref_to_Member'>rw_crashed_at</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Try to start the worker. 
             * 
             * On failure, give up processing workers for now, but set 
             * StartWorkerNeeded so we'll come back here on the next iteration 
             * of ServerLoop to try again.  (We don't want to wait, because 
             * there might be additional ready-to-run workers.)  We could set 
             * HaveCrashedWorker as well, since this worker is now marked 
             * crashed, but there's no need because the next run of this 
             * function will do that. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN5553"><span class='Ref_to_Func'>do_start_bgworker</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5764"><span class='Ref_To_Local'>rw</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we've launched as many workers as allowed, quit, but have 
             * ServerLoop call us again to look for additional ready-to-run 
             * workers.  There might not be any, but we'll find out the next 
             * time we run. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="postmaster.c.html#LN5743"><span class='Ref_To_Local'>num_launched</span></a> <span class='Operator'>&GT;= </span><a href="postmaster.c.html#LN5742"><span class='Ref_to_Const'>MAX_BGWORKERS_TO_LAUNCH</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="postmaster.c.html#LN359"><span class='Ref_to_Global_Var'>StartWorkerNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if bgworker_should_start... &raquo; </span> 
    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end maybe_start_bgworkers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * When a backend asks to be notified about worker state changes, we 
 * set a flag in its backend entry.  The background worker machinery needs 
 * to know when such backends exit. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN5850"></a><span class='Declare_Function'>PostmasterMarkPIDForWorkerNotify</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>pid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5852"></a>    <a href="../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN5853"></a>    <a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>bp</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5852"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN182"><span class='Ref_to_Global_Var'>BackendList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="postmaster.c.html#LN5853"><span class='Ref_To_Local'>bp</span></a> <span class='Operator'>= </span><a href="../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Delimiter'>, </span>elem<span class='Delimiter'>, </span><a href="postmaster.c.html#LN5852"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN5853"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN5850"><span class='Ref_to_Parameter'>pid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="postmaster.c.html#LN5853"><span class='Ref_To_Local'>bp</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN178"><span class='Ref_to_Member'>bgworker_notify</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
 
<span class='Comment_Multi_Line'>/* 
 * The following need to be available to the save/restore_backend_variables 
 * functions.  They are marked NON_EXEC_STATIC in their home modules. 
 */ 
</span><a name="LN5873"></a><span class='Keyword'>extern </span><a href="../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ShmemLock</span><span class='Delimiter'>; 
</span><a name="LN5874"></a><span class='Keyword'>extern </span><a href="../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ProcStructLock</span><span class='Delimiter'>; 
</span><a name="LN5875"></a><span class='Keyword'>extern </span><a href="../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Var'>AuxiliaryProcs</span><span class='Delimiter'>; 
</span><a name="LN5876"></a><span class='Keyword'>extern </span><a href="../storage/ipc/pmsignal.c.html#LN61"><span class='Ref_to_Struct'>PMSignalData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>PMSignalState</span><span class='Delimiter'>; 
</span><a name="LN5877"></a><span class='Keyword'>extern </span><a href="../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Var'>pgStatSock</span><span class='Delimiter'>; 
</span><a name="LN5878"></a><span class='Keyword'>extern </span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a> <span class='Declare_Var'>first_syslogger_file_time</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN5881"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>write_inheritable_socket</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>childpid</span><span class='Parentheses'>) ((</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5881"><span class='Ref_to_Parameter'>dest</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5881"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span> 
<a name="LN5882"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>read_inheritable_socket</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) (</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5882"><span class='Ref_to_Parameter'>dest</span></a><span class='Parentheses'>) </span><span class='Operator'>= *</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5882"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>))</span> 
<span class='Directive'>#else</span> 
<a name="LN5884"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>write_duplicated_handle</span><span class='Parentheses'>(</span>HANDLE <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span>HANDLE <span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span>HANDLE <span class='Declare_Parameter'>child</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN5885"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>write_inheritable_socket</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN470"><span class='Ref_to_Typedef'>InheritableSocket</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span>SOCKET <span class='Declare_Parameter'>src</span><span class='Delimiter'>, 
</span><a name="LN5886"></a>                         <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>childPid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN5887"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>read_inheritable_socket</span><span class='Parentheses'>(</span>SOCKET <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN470"><span class='Ref_to_Typedef'>InheritableSocket</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* Save critical backend variables into the BackendParameters struct */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static bool 
</span><a name="LN5894"></a><span class='Declare_Function'>save_backend_variables</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<span class='Keyword'>static bool 
</span><a href="postmaster.c.html#LN530"><span class='Ref_to_Proto'>save_backend_variables</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, 
</span>                       HANDLE childProcess<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> childPid<span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>{ 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN478"><span class='Ref_to_Member'>port</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN5881"><span class='Ref_to_Macro'>write_inheritable_socket</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN479"><span class='Ref_to_Member'>portsocket</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span>childPid<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN480"><span class='Ref_to_Member'>DataDir</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN481"><span class='Ref_to_Member'>ListenSocket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN482"><span class='Ref_to_Member'>MyCancelKey</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN483"><span class='Ref_to_Member'>MyPMChildSlot</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN42"><span class='Ref_to_Global_Var'>MyPMChildSlot</span></a><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN485"><span class='Ref_to_Member'>UsedShmemSegID</span></a> <span class='Operator'>= </span><a href="../port/win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN489"><span class='Ref_to_Member'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN490"><span class='Ref_to_Member'>ShmemLock</span></a> <span class='Operator'>= </span><a href="../storage/ipc/shmem.c.html#LN83"><span class='Ref_to_Global_Var'>ShmemLock</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN491"><span class='Ref_to_Member'>ShmemVariableCache</span></a> <span class='Operator'>= </span><a href="../access/transam/varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN492"><span class='Ref_to_Member'>ShmemBackendArray</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> HAVE_SPINLOCKS 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN494"><span class='Ref_to_Member'>SpinlockSemaArray</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/spin.c.html#LN30"><span class='Ref_to_Global_Var'>SpinlockSemaArray</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN496"><span class='Ref_to_Member'>NamedLWLockTrancheRequests</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/lwlock.c.html#LN153"><span class='Ref_to_Global_Var'>NamedLWLockTrancheRequests</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN497"><span class='Ref_to_Member'>NamedLWLockTrancheArray</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/lwlock.c.html#LN155"><span class='Ref_to_Global_Var'>NamedLWLockTrancheArray</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN498"><span class='Ref_to_Member'>MainLWLockArray</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/lwlock.c.html#LN124"><span class='Ref_to_Global_Var'>MainLWLockArray</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN499"><span class='Ref_to_Member'>ProcStructLock</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/proc.c.html#LN76"><span class='Ref_to_Global_Var'>ProcStructLock</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN500"><span class='Ref_to_Member'>ProcGlobal</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN501"><span class='Ref_to_Member'>AuxiliaryProcs</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/proc.c.html#LN80"><span class='Ref_to_Global_Var'>AuxiliaryProcs</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN502"><span class='Ref_to_Member'>PreparedXactProcs</span></a> <span class='Operator'>= </span><a href="../storage/lmgr/proc.c.html#LN81"><span class='Ref_to_Global_Var'>PreparedXactProcs</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN503"><span class='Ref_to_Member'>PMSignalState</span></a> <span class='Operator'>= </span><a href="../storage/ipc/pmsignal.c.html#LN71"><span class='Ref_to_Global_Var'>PMSignalState</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN5881"><span class='Ref_to_Macro'>write_inheritable_socket</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN504"><span class='Ref_to_Member'>pgStatSock</span></a><span class='Delimiter'>, </span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span>childPid<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN505"><span class='Ref_to_Member'>PostmasterPid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN86"><span class='Ref_to_Global_Var'>PostmasterPid</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN506"><span class='Ref_to_Member'>PgStartTime</span></a> <span class='Operator'>= </span><a href="../utils/adt/timestamp.c.html#LN48"><span class='Ref_to_Global_Var'>PgStartTime</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN507"><span class='Ref_to_Member'>PgReloadTime</span></a> <span class='Operator'>= </span><a href="../utils/adt/timestamp.c.html#LN51"><span class='Ref_to_Global_Var'>PgReloadTime</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN508"><span class='Ref_to_Member'>first_syslogger_file_time</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN85"><span class='Ref_to_Global_Var'>first_syslogger_file_time</span></a><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN509"><span class='Ref_to_Member'>redirection_done</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN350"><span class='Ref_to_Global_Var'>redirection_done</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN510"><span class='Ref_to_Member'>IsBinaryUpgrade</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN511"><span class='Ref_to_Member'>max_safe_fds</span></a> <span class='Operator'>= </span><a href="../storage/file/fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN512"><span class='Ref_to_Member'>MaxBackends</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN514"><span class='Ref_to_Member'>PostmasterHandle</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN559"><span class='Ref_to_Global_Var'>PostmasterHandle</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN5884"><span class='Ref_to_Proto'>write_duplicated_handle</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN515"><span class='Ref_to_Member'>initial_signal_pipe</span></a><span class='Delimiter'>, 
</span>                                 <a href="../port/win32/signal.c.html#LN179"><span class='Ref_to_Func'>pgwin32_create_signal_listener</span></a><span class='Parentheses'>(</span>childPid<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 childProcess<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN518"><span class='Ref_to_Member'>postmaster_alive_fds</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN516"><span class='Ref_to_Member'>syslogPipe</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN521"><span class='Ref_to_Member'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN522"><span class='Ref_to_Member'>pkglib_path</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN5894"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN523"><span class='Ref_to_Member'>ExtraOptions</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end save_backend_variables &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* 
 * Duplicate a handle for usage in a child process, and write the child 
 * process instance of the handle to the parameter file. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN5973"></a><span class='Declare_Function'>write_duplicated_handle</span><span class='Parentheses'>(</span>HANDLE <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span>HANDLE <span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span>HANDLE <span class='Declare_Parameter'>childProcess</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN5975"></a>    HANDLE      <span class='Declare_Local'>hChild</span> <span class='Operator'>= </span>INVALID_HANDLE_VALUE<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>DuplicateHandle<span class='Parentheses'>(</span>GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="postmaster.c.html#LN5973"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, 
</span>                         <a href="postmaster.c.html#LN5973"><span class='Ref_to_Parameter'>childProcess</span></a><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="postmaster.c.html#LN5975"><span class='Ref_To_Local'>hChild</span></a><span class='Delimiter'>, 
</span>                         <span class='Number'>0</span><span class='Delimiter'>, 
</span>                         <span class='Boolean'>TRUE</span><span class='Delimiter'>, 
</span>                         DUPLICATE_CLOSE_SOURCE <span class='Operator'>| </span>DUPLICATE_SAME_ACCESS<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not duplicate handle to be written to backend parameter file: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="postmaster.c.html#LN5973"><span class='Ref_to_Parameter'>dest</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN5975"><span class='Ref_To_Local'>hChild</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end write_duplicated_handle &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Duplicate a socket for usage in a child process, and write the resulting 
 * structure to the parameter file. 
 * This is required because a number of LSPs (Layered Service Providers) very 
 * common on Windows (antivirus, firewalls, download managers etc) break 
 * straight socket inheritance. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN6003"></a><span class='Declare_Function'>write_inheritable_socket</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN470"><span class='Ref_to_Typedef'>InheritableSocket</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span>SOCKET <span class='Declare_Parameter'>src</span><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>childpid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>dest</span></a><span class='Operator'>-&GT;</span>origsocket <span class='Operator'>= </span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>src</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>src</span></a> <span class='Operator'>!= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Actual socket */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>WSADuplicateSocket<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>childpid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>dest</span></a><span class='Operator'>-&GT;</span>wsainfo<span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not duplicate socket %d for use in backend: error code %d"</span><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN6003"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span>WSAGetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Read a duplicate socket structure back, and get the socket descriptor. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6024"></a><span class='Declare_Function'>read_inheritable_socket</span><span class='Parentheses'>(</span>SOCKET <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN470"><span class='Ref_to_Typedef'>InheritableSocket</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6026"></a>    SOCKET      <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span>origsocket <span class='Operator'>== </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>|| </span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span>origsocket <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Not a real socket! */ 
</span>        <span class='Operator'>*</span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>dest</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span>origsocket<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Actual socket, so create from structure */ 
</span>        <a href="postmaster.c.html#LN6026"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span>WSASocket<span class='Parentheses'>(</span>FROM_PROTOCOL_INFO<span class='Delimiter'>, 
</span>                      FROM_PROTOCOL_INFO<span class='Delimiter'>, 
</span>                      FROM_PROTOCOL_INFO<span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span>wsainfo<span class='Delimiter'>, 
</span>                      <span class='Number'>0</span><span class='Delimiter'>, 
</span>                      <span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN6026"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>== </span>INVALID_SOCKET<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not create inherited socket: error code %d\n"</span><span class='Delimiter'>, 
</span>                         WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Operator'>*</span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>dest</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6026"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * To make sure we don't get two references to the same socket, close 
         * the original one. (This would happen when inheritance actually 
         * works.. 
         */ 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>closesocket</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6024"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span>origsocket<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end read_inheritable_socket &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>static void 
</span><a name="LN6061"></a><span class='Declare_Function'>read_backend_variables</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>id</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6063"></a>    <a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Declare_Local'>param</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Non-win32 implementation reads from file */ 
</span><a name="LN6067"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Open file */ 
</span>    <a href="postmaster.c.html#LN6067"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Delimiter'>, </span><a href="../../tools/entab/entab.c.html#LN12"><span class='Ref_to_Const'>PG_BINARY_R</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN6067"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not open backend variables file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                     <a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN6063"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6063"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6067"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from backend variables file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                     <a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Release file */ 
</span>    <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6067"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %s\n"</span><span class='Delimiter'>, 
</span>                     <a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* Win32 version uses mapped file */ 
</span><a name="LN6095"></a>    HANDLE      <span class='Declare_Local'>paramHandle</span><span class='Delimiter'>; 
</span><a name="LN6096"></a>    <a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Local'>paramp</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> _WIN64 
    <a href="postmaster.c.html#LN6095"><span class='Ref_To_Local'>paramHandle</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span>_atoi64<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="postmaster.c.html#LN6095"><span class='Ref_To_Local'>paramHandle</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span>atol<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="postmaster.c.html#LN6096"><span class='Ref_To_Local'>paramp</span></a> <span class='Operator'>= </span>MapViewOfFile<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6095"><span class='Ref_To_Local'>paramHandle</span></a><span class='Delimiter'>, </span>FILE_MAP_READ<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN6096"><span class='Ref_To_Local'>paramp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not map view of backend variables: error code %lu\n"</span><span class='Delimiter'>, 
</span>                     GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN6063"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6096"><span class='Ref_To_Local'>paramp</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>UnmapViewOfFile<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6096"><span class='Ref_To_Local'>paramp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not unmap view of backend variables: error code %lu\n"</span><span class='Delimiter'>, 
</span>                     GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6095"><span class='Ref_To_Local'>paramHandle</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not close handle to backend parameter variables: error code %lu\n"</span><span class='Delimiter'>, 
</span>                     GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="postmaster.c.html#LN527"><span class='Ref_to_Proto'>restore_backend_variables</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN6063"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6061"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end read_backend_variables &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Restore critical backend variables from the BackendParameters struct */ 
</span><span class='Keyword'>static void 
</span><a name="LN6133"></a><span class='Declare_Function'>restore_backend_variables</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN476"><span class='Ref_to_Typedef'>BackendParameters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param</span><span class='Delimiter'>, </span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    memcpy<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN478"><span class='Ref_to_Member'>port</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/libpq/libpq-be.h.html#LN115"><span class='Ref_to_Struct'>Port</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5882"><span class='Ref_to_Macro'>read_inheritable_socket</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>port</span></a><span class='Operator'>-&GT;</span><a href="../../include/libpq/libpq-be.h.html#LN117"><span class='Ref_to_Member'>sock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN479"><span class='Ref_to_Member'>portsocket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/miscinit.c.html#LN92"><span class='Ref_to_Func'>SetDataDir</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN480"><span class='Ref_to_Member'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN481"><span class='Ref_to_Member'>ListenSocket</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN214"><span class='Ref_to_Global_Var'>ListenSocket</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN41"><span class='Ref_to_Global_Var'>MyCancelKey</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN482"><span class='Ref_to_Member'>MyCancelKey</span></a><span class='Delimiter'>; 
</span>    <a href="../utils/init/globals.c.html#LN42"><span class='Ref_to_Global_Var'>MyPMChildSlot</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN483"><span class='Ref_to_Member'>MyPMChildSlot</span></a><span class='Delimiter'>; 
</span> 
    <a href="../port/win32_shmem.c.html#LN19"><span class='Ref_to_Global_Var'>UsedShmemSegID</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN485"><span class='Ref_to_Member'>UsedShmemSegID</span></a><span class='Delimiter'>; 
</span>    <a href="../port/win32_shmem.c.html#LN20"><span class='Ref_to_Global_Var'>UsedShmemSegAddr</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN489"><span class='Ref_to_Member'>UsedShmemSegAddr</span></a><span class='Delimiter'>; 
</span> 
    <a href="../storage/ipc/shmem.c.html#LN83"><span class='Ref_to_Global_Var'>ShmemLock</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN490"><span class='Ref_to_Member'>ShmemLock</span></a><span class='Delimiter'>; 
</span>    <a href="../access/transam/varsup.c.html#LN33"><span class='Ref_to_Global_Var'>ShmemVariableCache</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN491"><span class='Ref_to_Member'>ShmemVariableCache</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN492"><span class='Ref_to_Member'>ShmemBackendArray</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> HAVE_SPINLOCKS 
    <a href="../storage/lmgr/spin.c.html#LN30"><span class='Ref_to_Global_Var'>SpinlockSemaArray</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN494"><span class='Ref_to_Member'>SpinlockSemaArray</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="../storage/lmgr/lwlock.c.html#LN153"><span class='Ref_to_Global_Var'>NamedLWLockTrancheRequests</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN496"><span class='Ref_to_Member'>NamedLWLockTrancheRequests</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/lwlock.c.html#LN155"><span class='Ref_to_Global_Var'>NamedLWLockTrancheArray</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN497"><span class='Ref_to_Member'>NamedLWLockTrancheArray</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/lwlock.c.html#LN124"><span class='Ref_to_Global_Var'>MainLWLockArray</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN498"><span class='Ref_to_Member'>MainLWLockArray</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/proc.c.html#LN76"><span class='Ref_to_Global_Var'>ProcStructLock</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN499"><span class='Ref_to_Member'>ProcStructLock</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN500"><span class='Ref_to_Member'>ProcGlobal</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/proc.c.html#LN80"><span class='Ref_to_Global_Var'>AuxiliaryProcs</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN501"><span class='Ref_to_Member'>AuxiliaryProcs</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/proc.c.html#LN81"><span class='Ref_to_Global_Var'>PreparedXactProcs</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN502"><span class='Ref_to_Member'>PreparedXactProcs</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/ipc/pmsignal.c.html#LN71"><span class='Ref_to_Global_Var'>PMSignalState</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN503"><span class='Ref_to_Member'>PMSignalState</span></a><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN5882"><span class='Ref_to_Macro'>read_inheritable_socket</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pgstat.c.html#LN148"><span class='Ref_to_Global_Var'>pgStatSock</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN504"><span class='Ref_to_Member'>pgStatSock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN86"><span class='Ref_to_Global_Var'>PostmasterPid</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN505"><span class='Ref_to_Member'>PostmasterPid</span></a><span class='Delimiter'>; 
</span>    <a href="../utils/adt/timestamp.c.html#LN48"><span class='Ref_to_Global_Var'>PgStartTime</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN506"><span class='Ref_to_Member'>PgStartTime</span></a><span class='Delimiter'>; 
</span>    <a href="../utils/adt/timestamp.c.html#LN51"><span class='Ref_to_Global_Var'>PgReloadTime</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN507"><span class='Ref_to_Member'>PgReloadTime</span></a><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN85"><span class='Ref_to_Global_Var'>first_syslogger_file_time</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN508"><span class='Ref_to_Member'>first_syslogger_file_time</span></a><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN350"><span class='Ref_to_Global_Var'>redirection_done</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN509"><span class='Ref_to_Member'>redirection_done</span></a><span class='Delimiter'>; 
</span>    <a href="../utils/init/globals.c.html#LN101"><span class='Ref_to_Global_Var'>IsBinaryUpgrade</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN510"><span class='Ref_to_Member'>IsBinaryUpgrade</span></a><span class='Delimiter'>; 
</span>    <a href="../storage/file/fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN511"><span class='Ref_to_Member'>max_safe_fds</span></a><span class='Delimiter'>; 
</span> 
    <a href="../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN512"><span class='Ref_to_Member'>MaxBackends</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="postmaster.c.html#LN559"><span class='Ref_to_Global_Var'>PostmasterHandle</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN514"><span class='Ref_to_Member'>PostmasterHandle</span></a><span class='Delimiter'>; 
</span>    <a href="../port/win32/signal.c.html#LN27"><span class='Ref_to_Global_Var'>pgwin32_initial_signal_pipe</span></a> <span class='Operator'>= </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN515"><span class='Ref_to_Member'>initial_signal_pipe</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN518"><span class='Ref_to_Member'>postmaster_alive_fds</span></a><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN516"><span class='Ref_to_Member'>syslogPipe</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN521"><span class='Ref_to_Member'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN522"><span class='Ref_to_Member'>pkglib_path</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN219"><span class='Ref_to_Global_Var'>ExtraOptions</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6133"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN523"><span class='Ref_to_Member'>ExtraOptions</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end restore_backend_variables &raquo; </span> 
 
 
<a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN6195"></a><span class='Declare_Function'>ShmemBackendArraySize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/postmaster.h.html#LN51"><span class='Ref_to_Proto'>MaxLivePostmasterChildren</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN6201"></a><span class='Declare_Function'>ShmemBackendArrayAllocation</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6203"></a>    <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span> <span class='Operator'>= </span><a href="../../include/postmaster/postmaster.h.html#LN60"><span class='Ref_to_Proto'>ShmemBackendArraySize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/storage/shmem.h.html#LN36"><span class='Ref_to_Proto'>ShmemAlloc</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6203"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Mark all slots as empty */ 
</span>    memset<span class='Parentheses'>(</span><a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6203"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN6211"></a><span class='Declare_Function'>ShmemBackendArrayAdd</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* The array slot corresponding to my PMChildSlot should be free */ 
</span><a name="LN6214"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN6211"><span class='Ref_to_Parameter'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN6214"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN6214"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="postmaster.c.html#LN6211"><span class='Ref_to_Parameter'>bn</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN6221"></a><span class='Declare_Function'>ShmemBackendArrayRemove</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN165"><span class='Ref_to_Typedef'>Backend</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6223"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><a href="postmaster.c.html#LN6221"><span class='Ref_to_Parameter'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN169"><span class='Ref_to_Member'>child_slot</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN6223"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><a href="postmaster.c.html#LN6221"><span class='Ref_to_Parameter'>bn</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Mark the slot as empty */ 
</span>    <a href="postmaster.c.html#LN185"><span class='Ref_to_Global_Var'>ShmemBackendArray</span></a><span class='Delimiter'>[</span><a href="postmaster.c.html#LN6223"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="postmaster.c.html#LN167"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * Subset implementation of waitpid() for Windows.  We assume pid is -1 
 * (that is, check all child processes) and options is WNOHANG (don't wait). 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN6239"></a><span class='Declare_Function'>waitpid</span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Parameter'>pid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>exitstatus</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6241"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>dwd</span><span class='Delimiter'>; 
</span><a name="LN6242"></a>    ULONG_PTR   <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN6243"></a>    OVERLAPPED <span class='Operator'>*</span><span class='Declare_Local'>ovl</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if there are any dead children. If there are, return the pid of 
     * the first one that died. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>GetQueuedCompletionStatus<span class='Parentheses'>(</span><a href="postmaster.c.html#LN448"><span class='Ref_to_Global_Var'>win32ChildQueue</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6241"><span class='Ref_To_Local'>dwd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6242"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6243"><span class='Ref_To_Local'>ovl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="postmaster.c.html#LN6239"><span class='Ref_to_Parameter'>exitstatus</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN6242"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="postmaster.c.html#LN6241"><span class='Ref_To_Local'>dwd</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Note! Code below executes on a thread pool! All operations must 
 * be thread safe! Note that elog() and friends must *not* be used. 
 */ 
</span><span class='Keyword'>static void </span>WINAPI 
<a name="LN6263"></a><span class='Declare_Function'>pgwin32_deadchild_callback</span><span class='Parentheses'>(</span>PVOID <span class='Declare_Parameter'>lpParameter</span><span class='Delimiter'>, </span>BOOLEAN <span class='Declare_Parameter'>TimerOrWaitFired</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN6265"></a>    <a href="postmaster.c.html#LN450"><span class='Ref_to_Typedef'>win32_deadchild_waitinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>childinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="postmaster.c.html#LN450"><span class='Ref_to_Typedef'>win32_deadchild_waitinfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="postmaster.c.html#LN6263"><span class='Ref_to_Parameter'>lpParameter</span></a><span class='Delimiter'>; 
</span><a name="LN6266"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>exitcode</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN6263"><span class='Ref_to_Parameter'>TimerOrWaitFired</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Multi_Line'>/* timeout. Should never happen, since we use 
                                 * INFINITE as timeout value. */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove handle from wait - required even though it's set to wait only 
     * once 
     */ 
</span>    UnregisterWaitEx<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6265"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN452"><span class='Ref_to_Member'>waitHandle</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetExitCodeProcess<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6265"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN453"><span class='Ref_to_Member'>procHandle</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="postmaster.c.html#LN6266"><span class='Ref_To_Local'>exitcode</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Should never happen. Inform user and set a fixed exitcode. 
         */ 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not read exit code for process\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="postmaster.c.html#LN6266"><span class='Ref_To_Local'>exitcode</span></a> <span class='Operator'>= </span><span class='Number'>255</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>PostQueuedCompletionStatus<span class='Parentheses'>(</span><a href="postmaster.c.html#LN448"><span class='Ref_to_Global_Var'>win32ChildQueue</span></a><span class='Delimiter'>, </span><a href="postmaster.c.html#LN6265"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN454"><span class='Ref_to_Member'>procId</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>ULONG_PTR<span class='Parentheses'>) </span><a href="postmaster.c.html#LN6266"><span class='Ref_To_Local'>exitcode</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not post child completion status\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Handle is per-process, so we close it here instead of in the 
     * originating thread 
     */ 
</span>    CloseHandle<span class='Parentheses'>(</span><a href="postmaster.c.html#LN6265"><span class='Ref_To_Local'>childinfo</span></a><span class='Operator'>-&GT;</span><a href="postmaster.c.html#LN453"><span class='Ref_to_Member'>procHandle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free struct that was allocated before the call to 
     * RegisterWaitForSingleObject() 
     */ 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="postmaster.c.html#LN6265"><span class='Ref_To_Local'>childinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Queue SIGCHLD signal */ 
</span>    <a href="../port/win32/signal.c.html#LN208"><span class='Ref_to_Func'>pg_queue_signal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pgwin32_deadchild_callback &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize one and only handle for monitoring postmaster death. 
 * 
 * Called once in the postmaster, so that child processes can subsequently 
 * monitor if their parent is dead. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN6314"></a><span class='Declare_Function'>InitPostmasterDeathWatchHandle</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * Create a pipe. Postmaster holds the write end of the pipe open 
     * (POSTMASTER_FD_OWN), and children hold the read end. Children can pass 
     * the read file descriptor to select() to wake up in case postmaster 
     * dies, or check for postmaster death with a (read() == 0). Children must 
     * close the write end as soon as possible after forking, because EOF 
     * won't be signaled in the read end until all processes have closed the 
     * write fd. That is taken care of in ClosePostmasterPorts(). 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN86"><span class='Ref_to_Global_Var'>PostmasterPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>pipe<span class='Parentheses'>(</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not create pipe to monitor postmaster death: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set O_NONBLOCK to allow testing for the fd's presence with a read() 
     * call. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Delimiter'>[</span><a href="../../include/postmaster/postmaster.h.html#LN41"><span class='Ref_to_Const'>POSTMASTER_FD_WATCH</span></a><span class='Delimiter'>], </span>F_SETFL<span class='Delimiter'>, </span>O_NONBLOCK<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not set postmaster death monitoring pipe to nonblocking mode: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * On Windows, we use a process handle for the same purpose. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>DuplicateHandle<span class='Parentheses'>(</span>GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                        GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                        GetCurrentProcess<span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="postmaster.c.html#LN559"><span class='Ref_to_Global_Var'>PostmasterHandle</span></a><span class='Delimiter'>, 
</span>                        <span class='Number'>0</span><span class='Delimiter'>, 
</span>                        <span class='Boolean'>TRUE</span><span class='Delimiter'>, 
</span>                        DUPLICATE_SAME_ACCESS<span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"could not duplicate postmaster handle: error code %lu"</span><span class='Delimiter'>, 
</span>                                 GetLastError<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end InitPostmasterDeathWatchHandle &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>