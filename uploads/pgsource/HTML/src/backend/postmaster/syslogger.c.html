<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\postmaster\syslogger.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\postmaster\syslogger.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * syslogger.c 
 * 
 * The system logger (syslogger) appeared in Postgres 8.0. It catches all 
 * stderr output from the postmaster, backends, and other subprocesses 
 * by redirecting to a pipe, and writes it to a set of logfiles. 
 * It's possible to have size and age limits for the logfile configured 
 * in postgresql.conf. If these limits are reached or passed, the 
 * current logfile is closed and a new one is created (rotated). 
 * The logfiles are stored in a subdirectory (configurable in 
 * postgresql.conf), using a user-selectable naming scheme. 
 * 
 * Author: Andreas Pflug &LT;pgadmin@pse-consulting.de&GT; 
 * 
 * Copyright (c) 2004-2017, PostgreSQL Global Development Group 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/postmaster/syslogger.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/pg_list.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgtime.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/fork_process.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/syslogger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/dsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/latch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ps_status.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * We read() into a temp buffer twice as big as a chunk, so that any fragment 
 * left after processing can be moved down to the front and we'll still have 
 * room to read a full chunk. 
 */ 
</span><a name="LN55"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>READ_BUF_SIZE</span> <span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><a href="../../include/postmaster/syslogger.h.html#LN34"><span class='Ref_to_Const'>PIPE_CHUNK_SIZE</span></a><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * GUC parameters.  Logging_collector cannot be changed after postmaster 
 * start, but the rest can change at SIGHUP. 
 */ 
</span><a name="LN62"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Logging_collector</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN63"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Log_RotationAge</span> <span class='Operator'>= </span><a href="../../include/datatype/timestamp.h.html#LN77"><span class='Ref_to_Const'>HOURS_PER_DAY</span></a> <span class='Operator'>* </span><a href="../../include/datatype/timestamp.h.html#LN88"><span class='Ref_to_Const'>MINS_PER_HOUR</span></a><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Log_RotationSize</span> <span class='Operator'>= </span><span class='Number'>10</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Delimiter'>; 
</span><a name="LN65"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>Log_directory</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN66"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>Log_filename</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Log_truncate_on_rotation</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Log_file_mode</span> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Globally visible state (used by elog.c) 
 */ 
</span><a name="LN73"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>am_syslogger</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN75"></a><span class='Keyword'>extern bool </span><span class='Declare_Var'>redirection_done</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Private state 
 */ 
</span><a name="LN80"></a><span class='Keyword'>static </span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a> <span class='Declare_Var'>next_rotation_time</span><span class='Delimiter'>; 
</span><a name="LN81"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>pipe_eof_seen</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>rotation_disabled</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN83"></a><span class='Keyword'>static </span>FILE <span class='Operator'>*</span><span class='Declare_Var'>syslogFile</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN84"></a><span class='Keyword'>static </span>FILE <span class='Operator'>*</span><span class='Declare_Var'>csvlogFile</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN85"></a><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a> <span class='Declare_Var'>first_syslogger_file_time</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN86"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>last_file_name</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>last_csv_file_name</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Buffers for saving partial messages from different backends. 
 * 
 * Keep NBUFFER_LISTS lists of these, with the entry for a given source pid 
 * being in the list numbered (pid % NBUFFER_LISTS), so as to cut down on 
 * the number of entries we have to examine for any one incoming message. 
 * There must never be more than one entry for the same source pid. 
 * 
 * An inactive buffer is not removed from its list, just held for re-use. 
 * An inactive buffer has pid == 0 and undefined contents of data. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN102"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>pid</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* PID of source process */ 
</span><a name="LN103"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Member'>data</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* accumulated data, as a StringInfo */ 
</span><a name="LN104"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>save_buffer</span><span class='Delimiter'>; 
</span> 
<a name="LN106"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NBUFFER_LISTS</span> <span class='Number'>256</span> 
<a name="LN107"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Var'>buffer_lists</span><span class='Delimiter'>[</span><a href="syslogger.c.html#LN106"><span class='Ref_to_Const'>NBUFFER_LISTS</span></a><span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* These must be exported for EXEC_BACKEND case ... annoying */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN111"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>syslogPipe</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>}; 
</span><span class='Directive'>#else</span> 
<a name="LN113"></a>HANDLE      <span class='Declare_Var'>syslogPipe</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>}; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN117"></a><span class='Keyword'>static </span>HANDLE <span class='Declare_Var'>threadHandle</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>static </span>CRITICAL_SECTION <span class='Declare_Var'>sysloggerSection</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Flags set by interrupt handlers for later service in the main loop. 
 */ 
</span><a name="LN124"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>got_SIGHUP</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN125"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>rotation_requested</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* Local subroutines */ 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
<a name="LN130"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Prototype'>syslogger_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN131"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>syslogger_parseArgs</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN133"></a><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void </span><span class='Declare_Function'>SysLoggerMain</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) </span><a href="../replication/logical/tablesync.c.html#LN118"><span class='Ref_to_Func'>pg_attribute_noreturn</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN791"><span class='Ref_to_Func'>process_pipe_input</span></a><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><a href="syslogger.c.html#LN159"><span class='Ref_To_Local'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN942"><span class='Ref_to_Func'>flush_pipe_input</span></a><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><a href="syslogger.c.html#LN159"><span class='Ref_To_Local'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN1096"><span class='Ref_to_Func'>open_csvlogfile</span></a><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static </span>FILE <span class='Operator'>*</span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><a href="../../bin/pg_test_fsync/pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span>mode<span class='Delimiter'>, 
</span>             <span class='Keyword'>bool </span>allow_errors<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static unsigned int </span>__stdcall <a href="syslogger.c.html#LN1019"><span class='Ref_to_Func'>pipeThread</span></a><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span>arg<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Keyword'>static void </span><a href="syslogger.c.html#LN1160"><span class='Ref_to_Func'>logfile_rotate</span></a><span class='Parentheses'>(</span><span class='Keyword'>bool </span>time_based_rotation<span class='Delimiter'>, </span><span class='Keyword'>int </span>size_rotation_for<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static char </span><span class='Operator'>*</span><a href="syslogger.c.html#LN1295"><span class='Ref_to_Func'>logfile_getname</span></a><span class='Parentheses'>(</span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a> <a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN8">timestamp</a><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span>suffix<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN1325"><span class='Ref_to_Func'>set_next_rotation_time</span></a><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN1424"><span class='Ref_to_Func'>sigHupHandler</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN1436"><span class='Ref_to_Func'>sigUsr1Handler</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="syslogger.c.html#LN1359"><span class='Ref_to_Func'>update_metainfo_datafile</span></a><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Main entry point for syslogger process 
 * argc/argv parameters are valid only in EXEC_BACKEND case. 
 */ 
</span><a href="../../include/c.h.html#LN1118"><span class='Ref_to_Const'>NON_EXEC_STATIC</span></a> <span class='Keyword'>void 
</span><a href="syslogger.c.html#LN133"><span class='Ref_to_Func'>SysLoggerMain</span></a><span class='Parentheses'>(</span><span class='Keyword'>int </span><a href="syslogger.c.html#LN133"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><a href="syslogger.c.html#LN133"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN159"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>logbuffer</span><span class='Delimiter'>[</span><a href="syslogger.c.html#LN55"><span class='Ref_to_Const'>READ_BUF_SIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN160"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes_in_logbuffer</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN162"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>currentLogDir</span><span class='Delimiter'>; 
</span><a name="LN163"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>currentLogFilename</span><span class='Delimiter'>; 
</span><a name="LN164"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>currentLogRotationAge</span><span class='Delimiter'>; 
</span><a name="LN165"></a>    <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a>   <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN165"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <a href="syslogger.c.html#LN131"><span class='Ref_to_Proto'>syslogger_parseArgs</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN133"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN133"><span class='Ref_to_Parameter'>argv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
    <a href="syslogger.c.html#LN73"><span class='Ref_to_Global_Var'>am_syslogger</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/ps_status.h.html#LN18"><span class='Ref_to_Proto'>init_ps_display</span></a><span class='Parentheses'>(</span><span class='String'>"logger process"</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we restarted, our stderr is already redirected into our own input 
     * pipe.  This is of course pretty useless, not to mention that it 
     * interferes with detecting pipe EOF.  Point stderr to /dev/null. This 
     * assumes that all interesting messages generated in the syslogger will 
     * come through elog.c and will be sent to write_syslogger_file. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="postmaster.c.html#LN350"><span class='Ref_to_Global_Var'>redirection_done</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN186"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="../../include/port.h.html#LN113"><span class='Ref_to_Const'>DEVNULL</span></a><span class='Delimiter'>, </span>O_WRONLY<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The closes might look redundant, but they are not: we want to be 
         * darn sure the pipe gets closed even if the open failed.  We can 
         * survive running with stderr pointing nowhere, but we can't afford 
         * to have extra pipe input descriptors hanging around. 
         * 
         * As we're just trying to reset these to go to DEVNULL, there's not 
         * much point in checking for failure from the close/dup2 calls here, 
         * if they fail then presumably the file descriptors are closed and 
         * any writes will go into the bitbucket anyway. 
         */ 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span>stdout<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN186"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>dup2<span class='Parentheses'>(</span><a href="syslogger.c.html#LN186"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span>fileno<span class='Parentheses'>(</span>stdout<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>dup2<span class='Parentheses'>(</span><a href="syslogger.c.html#LN186"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span>fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN186"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if redirection_done &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Syslogger's own stderr can't be the syslogPipe, so set it back to text 
     * mode if we didn't just close it. (It was set to binary in 
     * SubPostmasterMain). 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>else</span> 
        _setmode<span class='Parentheses'>(</span>_fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>, </span>_O_TEXT<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Also close our copy of the write end of the pipe.  This is needed to 
     * ensure we can detect pipe EOF correctly.  (But note that in the restart 
     * case, the postmaster already did this.) 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        CloseHandle<span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Properly accept or ignore signals the postmaster might send us 
     * 
     * Note: we ignore all termination signals, and instead exit only when all 
     * upstream processes are gone, to ensure we don't miss any dying gasps of 
     * broken backends... 
     */ 
</span> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN1424"><span class='Ref_to_Func'>sigHupHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* set flag to read config file */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN193"><span class='Ref_to_Const'>SIGALRM</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN1436"><span class='Ref_to_Func'>sigUsr1Handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* request log rotation */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset some signals that are accepted by postmaster but not here 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN198"><span class='Ref_to_Const'>SIGTTIN</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN199"><span class='Ref_to_Const'>SIGTTOU</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN196"><span class='Ref_to_Const'>SIGCONT</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN200"><span class='Ref_to_Const'>SIGWINCH</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Fire up separate data transfer thread */ 
</span>    InitializeCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN117"><span class='Ref_to_Global_Var'>threadHandle</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span>_beginthreadex<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="syslogger.c.html#LN1019"><span class='Ref_to_Func'>pipeThread</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN117"><span class='Ref_to_Global_Var'>threadHandle</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"could not create syslogger data transfer thread: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remember active logfile's name.  We recompute this from the reference 
     * time because passing down just the pg_time_t is a lot cheaper than 
     * passing a whole file path in the EXEC_BACKEND case. 
     */ 
</span>    <a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1295"><span class='Ref_to_Func'>logfile_getname</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN85"><span class='Ref_to_Global_Var'>first_syslogger_file_time</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* remember active logfile parameters */ 
</span>    <a href="syslogger.c.html#LN162"><span class='Ref_To_Local'>currentLogDir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN163"><span class='Ref_To_Local'>currentLogFilename</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN66"><span class='Ref_to_Global_Var'>Log_filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN164"><span class='Ref_To_Local'>currentLogRotationAge</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* set next planned rotation time */ 
</span>    <a href="syslogger.c.html#LN1325"><span class='Ref_to_Func'>set_next_rotation_time</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1359"><span class='Ref_to_Func'>update_metainfo_datafile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* main worker loop */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN290"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>time_based_rotation</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN291"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>size_rotation_for</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN292"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>cur_timeout</span><span class='Delimiter'>; 
</span><a name="LN293"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>cur_flags</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN296"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* Clear any already-pending wakeups */ 
</span>        <a href="../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Process any requests or signals received recently. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check if the log directory or filename pattern changed in 
             * postgresql.conf. If so, force rotation to make sure we're 
             * writing the logfiles in the right place. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN162"><span class='Ref_To_Local'>currentLogDir</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN162"><span class='Ref_To_Local'>currentLogDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN162"><span class='Ref_To_Local'>currentLogDir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Also, create new directory if not present; ignore errors 
                 */ 
</span>                <a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="syslogger.c.html#LN66"><span class='Ref_to_Global_Var'>Log_filename</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN163"><span class='Ref_To_Local'>currentLogFilename</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN163"><span class='Ref_To_Local'>currentLogFilename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN163"><span class='Ref_To_Local'>currentLogFilename</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN66"><span class='Ref_to_Global_Var'>Log_filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If rotation time parameter changed, reset next rotation time, 
             * but don't immediately force a rotation. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN164"><span class='Ref_To_Local'>currentLogRotationAge</span></a> <span class='Operator'>!= </span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="syslogger.c.html#LN164"><span class='Ref_To_Local'>currentLogRotationAge</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN1325"><span class='Ref_to_Func'>set_next_rotation_time</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we had a rotation-disabling failure, re-enable rotation 
             * attempts after SIGHUP, and force one immediately. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Force rewriting last log filename when reloading configuration. 
             * Even if rotation_requested is false, log_destination may have 
             * been changed and we don't want to wait the next file rotation. 
             */ 
</span>            <a href="syslogger.c.html#LN1359"><span class='Ref_to_Func'>update_metainfo_datafile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if got_SIGHUP &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Do a logfile rotation if it's time */ 
</span>            <a href="syslogger.c.html#LN165"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a><span class='Parentheses'>) </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN165"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>&GT;= </span><a href="syslogger.c.html#LN80"><span class='Ref_to_Global_Var'>next_rotation_time</span></a><span class='Parentheses'>) 
</span>                <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN290"><span class='Ref_To_Local'>time_based_rotation</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>&& </span><a href="syslogger.c.html#LN64"><span class='Ref_to_Global_Var'>Log_RotationSize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Do a rotation if file is too big */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>ftell<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="syslogger.c.html#LN64"><span class='Ref_to_Global_Var'>Log_RotationSize</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN291"><span class='Ref_To_Local'>size_rotation_for</span></a> <span class='Operator'>|= </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                ftell<span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="syslogger.c.html#LN64"><span class='Ref_to_Global_Var'>Log_RotationSize</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN291"><span class='Ref_To_Local'>size_rotation_for</span></a> <span class='Operator'>|= </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Force rotation when both values are zero. It means the request 
             * was sent by pg_rotate_logfile. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN290"><span class='Ref_To_Local'>time_based_rotation</span></a> <span class='Operator'>&& </span><a href="syslogger.c.html#LN291"><span class='Ref_To_Local'>size_rotation_for</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="syslogger.c.html#LN291"><span class='Ref_To_Local'>size_rotation_for</span></a> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a> <span class='Operator'>| </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN1160"><span class='Ref_to_Func'>logfile_rotate</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN290"><span class='Ref_To_Local'>time_based_rotation</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN291"><span class='Ref_To_Local'>size_rotation_for</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate time till next time-based rotation, so that we don't 
         * sleep longer than that.  We assume the value of "now" obtained 
         * above is still close enough.  Note we can't make this calculation 
         * until after calling logfile_rotate(), since it will advance 
         * next_rotation_time. 
         * 
         * Also note that we need to beware of overflow in calculation of the 
         * timeout: with large settings of Log_RotationAge, next_rotation_time 
         * could be more than INT_MAX msec in the future.  In that case we'll 
         * wait no more than INT_MAX msec, and try again. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN410"></a>            <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a>   <span class='Declare_Local'>delay</span><span class='Delimiter'>; 
</span> 
            <a href="syslogger.c.html#LN410"><span class='Ref_To_Local'>delay</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN80"><span class='Ref_to_Global_Var'>next_rotation_time</span></a> <span class='Operator'>- </span><a href="syslogger.c.html#LN165"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN410"><span class='Ref_To_Local'>delay</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN410"><span class='Ref_To_Local'>delay</span></a> <span class='Operator'>&GT; </span>INT_MAX <span class='Operator'>/ </span><span class='Number'>1000</span><span class='Parentheses'>) 
</span>                    <a href="syslogger.c.html#LN410"><span class='Ref_To_Local'>delay</span></a> <span class='Operator'>= </span>INT_MAX <span class='Operator'>/ </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN292"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN410"><span class='Ref_To_Local'>delay</span></a> <span class='Operator'>* </span><span class='Number'>1000L</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* msec */ 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="syslogger.c.html#LN292"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN293"><span class='Ref_To_Local'>cur_flags</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="syslogger.c.html#LN292"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN293"><span class='Ref_To_Local'>cur_flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sleep until there's something to do 
         */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="syslogger.c.html#LN296"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="syslogger.c.html#LN293"><span class='Ref_To_Local'>cur_flags</span></a><span class='Delimiter'>, 
</span>                               <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                               <a href="syslogger.c.html#LN292"><span class='Ref_To_Local'>cur_timeout</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/pgstat.h.html#LN764"><span class='Ref_to_EnumConst'>WAIT_EVENT_SYSLOGGER_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN296"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN441"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bytesRead</span><span class='Delimiter'>; 
</span> 
            <a href="syslogger.c.html#LN441"><span class='Ref_To_Local'>bytesRead</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                             <a href="syslogger.c.html#LN159"><span class='Ref_To_Local'>logbuffer</span></a> <span class='Operator'>+ </span><a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Delimiter'>, 
</span>                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN159"><span class='Ref_To_Local'>logbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN441"><span class='Ref_To_Local'>bytesRead</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span><a href="../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from logger pipe: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN441"><span class='Ref_To_Local'>bytesRead</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a> <span class='Operator'>+= </span><a href="syslogger.c.html#LN441"><span class='Ref_To_Local'>bytesRead</span></a><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN791"><span class='Ref_to_Func'>process_pipe_input</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN159"><span class='Ref_To_Local'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Zero bytes read when select() is saying read-ready means 
                 * EOF on the pipe: that is, there are no longer any processes 
                 * with the pipe write end open.  Therefore, the postmaster 
                 * and all backends are shut down, and we are done. 
                 */ 
</span>                <a href="syslogger.c.html#LN81"><span class='Ref_to_Global_Var'>pipe_eof_seen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* if there's any data left then force it out now */ 
</span>                <a href="syslogger.c.html#LN942"><span class='Ref_to_Func'>flush_pipe_input</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN159"><span class='Ref_To_Local'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="syslogger.c.html#LN160"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rc&WL_SOCKET_READABLE &raquo; </span> 
<span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * On Windows we leave it to a separate thread to transfer data and 
         * detect pipe EOF.  The main thread just wakes up to handle SIGHUP 
         * and rotation conditions. 
         * 
         * Server code isn't generally thread-safe, so we ensure that only one 
         * of the threads is active at a time by entering the critical section 
         * whenever we're not sleeping. 
         */ 
</span>        LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="syslogger.c.html#LN293"><span class='Ref_To_Local'>cur_flags</span></a><span class='Delimiter'>, 
</span>                         <a href="syslogger.c.html#LN292"><span class='Ref_To_Local'>cur_timeout</span></a><span class='Delimiter'>, 
</span>                         <a href="../../include/pgstat.h.html#LN764"><span class='Ref_to_EnumConst'>WAIT_EVENT_SYSLOGGER_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN81"><span class='Ref_to_Global_Var'>pipe_eof_seen</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * seeing this message on the real stderr is annoying - so we make 
             * it DEBUG1 to suppress in normal use. 
             */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logger shutting down"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Normal exit from the syslogger is here.  Note that we 
             * deliberately do not close syslogFile before exiting; this is to 
             * allow for the possibility of elog messages being generated 
             * inside proc_exit.  Regular exit() will take care of flushing 
             * and closing stdio channels. 
             */ 
</span>            <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SysLoggerMain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Postmaster subroutine to start a syslogger subprocess. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN519"></a><span class='Declare_Function'>SysLogger_Start</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN521"></a>    <a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>sysloggerPid</span><span class='Delimiter'>; 
</span><a name="LN522"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filename</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN62"><span class='Ref_to_Global_Var'>Logging_collector</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If first time through, create the pipe which will receive stderr 
     * output. 
     * 
     * If the syslogger crashes and needs to be restarted, we continue to use 
     * the same pipe (indeed must do so, since extant backends will be writing 
     * into that pipe). 
     * 
     * This means the postmaster must continue to hold the read end of the 
     * pipe open, so we can pass it down to the reincarnated syslogger. This 
     * is a bit klugy but we have little choice. 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>pipe<span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create pipe for syslog: %m"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN550"></a>        SECURITY_ATTRIBUTES <span class='Declare_Local'>sa</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN550"><span class='Ref_To_Local'>sa</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>SECURITY_ATTRIBUTES<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN550"><span class='Ref_To_Local'>sa</span></a><span class='Operator'>.</span>nLength <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>SECURITY_ATTRIBUTES<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN550"><span class='Ref_To_Local'>sa</span></a><span class='Operator'>.</span>bInheritHandle <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>CreatePipe<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="syslogger.c.html#LN550"><span class='Ref_To_Local'>sa</span></a><span class='Delimiter'>, </span><span class='Number'>32768</span><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create pipe for syslog: %m"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Create log directory if not present; ignore errors 
     */ 
</span>    <a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The initial logfile is created right in the postmaster, to verify that 
     * the Log_directory is writable.  We save the reference time so that the 
     * syslogger child process can recompute this file name. 
     * 
     * It might look a bit strange to re-do this during a syslogger restart, 
     * but we must do so since the postmaster closed syslogFile after the 
     * previous fork (and remembering that old file wouldn't be right anyway). 
     * Note we always append here, we won't overwrite any existing file.  This 
     * is consistent with the normal rules, because by definition this is not 
     * a time-based rotation. 
     */ 
</span>    <a href="syslogger.c.html#LN85"><span class='Ref_to_Global_Var'>first_syslogger_file_time</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN522"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1295"><span class='Ref_to_Func'>logfile_getname</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN85"><span class='Ref_to_Global_Var'>first_syslogger_file_time</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN522"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN522"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="syslogger.c.html#LN521"><span class='Ref_To_Local'>sysloggerPid</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN130"><span class='Ref_to_Proto'>syslogger_forkexec</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="syslogger.c.html#LN521"><span class='Ref_To_Local'>sysloggerPid</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/fork_process.h.html#LN14"><span class='Ref_to_Proto'>fork_process</span></a><span class='Parentheses'>()))</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>: 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fork system logger: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> EXEC_BACKEND 
        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* in postmaster child ... */ 
</span>            <a href="../utils/init/miscinit.c.html#LN173"><span class='Ref_to_Func'>InitPostmasterChild</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Close the postmaster's sockets */ 
</span>            <a href="../../include/postmaster/postmaster.h.html#LN49"><span class='Ref_to_Proto'>ClosePostmasterPorts</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Drop our connection to postmaster's shared memory, as well */ 
</span>            <a href="../../include/storage/dsm.h.html#LN29"><span class='Ref_to_Proto'>dsm_detach_all</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/pg_shmem.h.html#LN69"><span class='Ref_to_Proto'>PGSharedMemoryDetach</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* do the work */ 
</span>            <a href="syslogger.c.html#LN133"><span class='Ref_to_Func'>SysLoggerMain</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* success, in postmaster */ 
</span> 
            <span class='Comment_Multi_Line'>/* now we redirect stderr, if not done already */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="postmaster.c.html#LN350"><span class='Ref_to_Global_Var'>redirection_done</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN622"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
                <span class='Comment_Multi_Line'>/* 
                 * Leave a breadcrumb trail when redirecting, in case the user 
                 * forgets that redirection is active and looks only at the 
                 * original stderr target file. 
                 */ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"redirecting log output to logging collector process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Future log output will appear in directory \"%s\"."</span><span class='Delimiter'>, 
</span>                        <a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
                fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>dup2<span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span>fileno<span class='Parentheses'>(</span>stdout<span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not redirect stdout: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>dup2<span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span>fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not redirect stderr: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Now we are done with the write end of the pipe. */ 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
                <span class='Comment_Multi_Line'>/* 
                 * open the pipe in binary mode and make sure stderr is binary 
                 * after it's been dup'ed into, to avoid disturbing the pipe 
                 * chunking protocol. 
                 */ 
</span>                fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN622"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span>_open_osfhandle<span class='Parentheses'>((</span>intptr_t<span class='Parentheses'>) </span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                                     _O_APPEND <span class='Operator'>| </span>_O_BINARY<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>dup2<span class='Parentheses'>(</span><a href="syslogger.c.html#LN622"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span>_fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not redirect stderr: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN622"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                _setmode<span class='Parentheses'>(</span>_fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>, </span>_O_BINARY<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Now we are done with the write end of the pipe. 
                 * CloseHandle() must not be called because the preceding 
                 * close() closes the underlying handle. 
                 */ 
</span>                <a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <a href="postmaster.c.html#LN350"><span class='Ref_to_Global_Var'>redirection_done</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !redirection_done &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* postmaster will never write the file; close it */ 
</span>            fclose<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="syslogger.c.html#LN521"><span class='Ref_To_Local'>sysloggerPid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch (sysloggerPid=fork_pr... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* we should never reach here */ 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SysLogger_Start &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
 
<span class='Comment_Multi_Line'>/* 
 * syslogger_forkexec() - 
 * 
 * Format up the arglist for, then fork and exec, a syslogger process 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> 
<a name="LN695"></a><span class='Declare_Function'>syslogger_forkexec</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN697"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>av</span><span class='Delimiter'>[</span><span class='Number'>10</span><span class='Delimiter'>]; 
</span><a name="LN698"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ac</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN699"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>filenobuf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
    <a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"postgres"</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"--forklog"</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* filled in by postmaster_forkexec */ 
</span> 
    <span class='Comment_Multi_Line'>/* static variables (those not passed by write_backend_variables) */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, 
</span>                 fileno<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Delimiter'>, </span><span class='String'>"-1"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%ld"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>)</span> _get_osfhandle<span class='Parentheses'>(</span>_fileno<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Delimiter'>, </span><span class='String'>"0"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="syslogger.c.html#LN699"><span class='Ref_To_Local'>filenobuf</span></a><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a> <span class='Operator'>&LT; </span><a href="../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/postmaster/postmaster.h.html#LN57"><span class='Ref_to_Proto'>postmaster_forkexec</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN698"><span class='Ref_To_Local'>ac</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN697"><span class='Ref_To_Local'>av</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end syslogger_forkexec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * syslogger_parseArgs() - 
 * 
 * Extract data from the arglist for exec'ed syslogger process 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN733"></a><span class='Declare_Function'>syslogger_parseArgs</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv</span><span class='Delimiter'>[]</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN735"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN733"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>== </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN733"><span class='Ref_to_Parameter'>argv</span></a> <span class='Operator'>+= </span><span class='Number'>3</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="syslogger.c.html#LN733"><span class='Ref_to_Parameter'>argv</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>= </span>fdopen<span class='Parentheses'>(</span><a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        setvbuf<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN339"><span class='Ref_to_Const'>PG_IOLBF</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="syslogger.c.html#LN733"><span class='Ref_to_Parameter'>argv</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span>_open_osfhandle<span class='Parentheses'>(</span><a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span>_O_APPEND <span class='Operator'>| </span>_O_TEXT<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>= </span>fdopen<span class='Parentheses'>(</span><a href="syslogger.c.html#LN735"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            setvbuf<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN339"><span class='Ref_to_Const'>PG_IOLBF</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end syslogger_parseArgs &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EXEC_BACKEND */ 
</span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      pipe protocol handling 
 * -------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Process data received through the syslogger pipe. 
 * 
 * This routine interprets the log pipe protocol which sends log messages as 
 * (hopefully atomic) chunks - such chunks are detected and reassembled here. 
 * 
 * The protocol has a header that starts with two nul bytes, then has a 16 bit 
 * length, the pid of the sending process, and a flag to indicate if it is 
 * the last chunk in a message. Incomplete chunks are saved until we read some 
 * more, and non-final chunks are accumulated until we get the final chunk. 
 * 
 * All of this is to avoid 2 problems: 
 * . partial messages being written to logfiles (messes rotation), and 
 * . messages from different backends being interleaved (messages garbled). 
 * 
 * Any non-protocol messages are written out directly. These should only come 
 * from non-PostgreSQL sources, however (e.g. third party libraries writing to 
 * stderr). 
 * 
 * logbuffer is the data input buffer, and *bytes_in_logbuffer is the number 
 * of bytes present.  On exit, any not-yet-eaten data is left-justified in 
 * logbuffer, and *bytes_in_logbuffer is updated. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN792"></a><span class='Declare_Function'>process_pipe_input</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>logbuffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>bytes_in_logbuffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN794"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cursor</span> <span class='Operator'>= </span><a href="syslogger.c.html#LN792"><span class='Ref_to_Parameter'>logbuffer</span></a><span class='Delimiter'>; 
</span><a name="LN795"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= *</span><a href="syslogger.c.html#LN792"><span class='Ref_to_Parameter'>bytes_in_logbuffer</span></a><span class='Delimiter'>; 
</span><a name="LN796"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>dest</span> <span class='Operator'>= </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* While we have enough for a header, process data... */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/syslogger.h.html#LN43"><span class='Ref_to_Typedef'>PipeProtoHeader</span></a><span class='Delimiter'>, </span>data<span class='Parentheses'>) </span><span class='Operator'>+</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN801"></a>        <a href="../../include/postmaster/syslogger.h.html#LN43"><span class='Ref_to_Typedef'>PipeProtoHeader</span></a> <span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN802"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>chunklen</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do we have a valid header? */ 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/syslogger.h.html#LN43"><span class='Ref_to_Typedef'>PipeProtoHeader</span></a><span class='Delimiter'>, </span>data<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN45"><span class='Ref_to_Member'>nuls</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span> <span class='Operator'>&& </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN45"><span class='Ref_to_Member'>nuls</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span> <span class='Operator'>&& 
</span>            <a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>&LT;= </span><a href="../../include/postmaster/syslogger.h.html#LN60"><span class='Ref_to_Const'>PIPE_MAX_PAYLOAD</span></a> <span class='Operator'>&& 
</span>            <a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN47"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'t'</span> <span class='Operator'>|| </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'f'</span> <span class='Operator'>|| 
</span>             <a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'T'</span> <span class='Operator'>|| </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'F'</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN812"></a>            <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>buffer_list</span><span class='Delimiter'>; 
</span><a name="LN813"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN814"></a>            <a href="syslogger.c.html#LN100"><span class='Ref_to_Typedef'>save_buffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>existing_slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span><a name="LN815"></a>                       <span class='Operator'>*</span><span class='Declare_Local'>free_slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN816"></a>            <a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a>  <span class='Declare_Local'>str</span><span class='Delimiter'>; 
</span> 
            <a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a> <span class='Operator'>= </span><a href="../../include/postmaster/syslogger.h.html#LN59"><span class='Ref_to_Const'>PIPE_HEADER_SIZE</span></a> <span class='Operator'>+ </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Fall out of loop if we don't have the whole chunk yet */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&LT; </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <a href="syslogger.c.html#LN796"><span class='Ref_To_Local'>dest</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'T'</span> <span class='Operator'>|| </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'F'</span><span class='Parentheses'>) </span><span class='Operator'>? 
</span>                <a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Locate any existing buffer for this source pid */ 
</span>            <a href="syslogger.c.html#LN812"><span class='Ref_To_Local'>buffer_list</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN107"><span class='Ref_to_Global_Var'>buffer_lists</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN47"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>% </span><a href="syslogger.c.html#LN106"><span class='Ref_to_Const'>NBUFFER_LISTS</span></a><span class='Delimiter'>]; 
</span>            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN813"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN812"><span class='Ref_To_Local'>buffer_list</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN831"></a>                <a href="syslogger.c.html#LN100"><span class='Ref_to_Typedef'>save_buffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN100"><span class='Ref_to_Typedef'>save_buffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN813"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN831"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN102"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN47"><span class='Ref_to_Member'>pid</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="syslogger.c.html#LN814"><span class='Ref_To_Local'>existing_slot</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN831"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN831"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN102"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN831"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'f'</span> <span class='Operator'>|| </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN48"><span class='Ref_to_Member'>is_last</span></a> <span class='Operator'>== </span><span class='String'>'F'</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Save a complete non-final chunk in a per-pid buffer 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN814"><span class='Ref_To_Local'>existing_slot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Add chunk to data from preceding chunks */ 
</span>                    <a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN814"><span class='Ref_To_Local'>existing_slot</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN103"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, 
</span>                                           <a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>+ </span><a href="../../include/postmaster/syslogger.h.html#LN59"><span class='Ref_to_Const'>PIPE_HEADER_SIZE</span></a><span class='Delimiter'>, 
</span>                                           <a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* First chunk of message, save in a new buffer */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * Need a free slot, but there isn't one in the list, 
                         * so create a new one and extend the list with it. 
                         */ 
</span>                        <a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN100"><span class='Ref_to_Typedef'>save_buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <a href="syslogger.c.html#LN812"><span class='Ref_To_Local'>buffer_list</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN812"><span class='Ref_To_Local'>buffer_list</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="syslogger.c.html#LN107"><span class='Ref_to_Global_Var'>buffer_lists</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN47"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>% </span><a href="syslogger.c.html#LN106"><span class='Ref_to_Const'>NBUFFER_LISTS</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="syslogger.c.html#LN812"><span class='Ref_To_Local'>buffer_list</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN102"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN47"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>                    <a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN815"><span class='Ref_To_Local'>free_slot</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN103"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, 
</span>                                           <a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>+ </span><a href="../../include/postmaster/syslogger.h.html#LN59"><span class='Ref_to_Const'>PIPE_HEADER_SIZE</span></a><span class='Delimiter'>, 
</span>                                           <a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if p.is_last=='f'||p.is_... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Final chunk --- add it to anything saved for that pid, and 
                 * either way write the whole thing out. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN814"><span class='Ref_To_Local'>existing_slot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN814"><span class='Ref_To_Local'>existing_slot</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN103"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, 
</span>                                           <a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>+ </span><a href="../../include/postmaster/syslogger.h.html#LN59"><span class='Ref_to_Const'>PIPE_HEADER_SIZE</span></a><span class='Delimiter'>, 
</span>                                           <a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../include/postmaster/syslogger.h.html#LN83"><span class='Ref_to_Proto'>write_syslogger_file</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN796"><span class='Ref_To_Local'>dest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Mark the buffer unused, and reclaim string storage */ 
</span>                    <a href="syslogger.c.html#LN814"><span class='Ref_To_Local'>existing_slot</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN102"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN816"><span class='Ref_To_Local'>str</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* The whole message was one chunk, evidently. */ 
</span>                    <a href="../../include/postmaster/syslogger.h.html#LN83"><span class='Ref_to_Proto'>write_syslogger_file</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>+ </span><a href="../../include/postmaster/syslogger.h.html#LN59"><span class='Ref_to_Const'>PIPE_HEADER_SIZE</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN801"><span class='Ref_To_Local'>p</span></a><span class='Operator'>.</span><a href="../../include/postmaster/syslogger.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, 
</span>                                         <a href="syslogger.c.html#LN796"><span class='Ref_To_Local'>dest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Finished processing this chunk */ 
</span>            <a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>+= </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>-= </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if p.nuls[0]=='\0'&&p.nu... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Process non-protocol data */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Look for the start of a protocol header.  If found, dump data 
             * up to there and repeat the loop.  Otherwise, dump it all and 
             * fall out of the loop.  (Note: we want to dump it all if at all 
             * possible, so as to avoid dividing non-protocol messages across 
             * logfiles.  We expect that in many scenarios, a non-protocol 
             * message will arrive all in one read(), and we want to respect 
             * the read() boundary if possible.) 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a> <span class='Operator'>&LT; </span><a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* fall back on the stderr log as the destination */ 
</span>            <a href="../../include/postmaster/syslogger.h.html#LN83"><span class='Ref_to_Proto'>write_syslogger_file</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>+= </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>-= </span><a href="syslogger.c.html#LN802"><span class='Ref_To_Local'>chunklen</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while count&GT;=(int)(offsetof... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* We don't have a full chunk, so left-align what remains in the buffer */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a> <span class='Operator'>!= </span><a href="syslogger.c.html#LN792"><span class='Ref_to_Parameter'>logbuffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN792"><span class='Ref_to_Parameter'>logbuffer</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN794"><span class='Ref_To_Local'>cursor</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="syslogger.c.html#LN792"><span class='Ref_to_Parameter'>bytes_in_logbuffer</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN795"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end process_pipe_input &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Force out any buffered data 
 * 
 * This is currently used only at syslogger shutdown, but could perhaps be 
 * useful at other times, so it is careful to leave things in a clean state. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN943"></a><span class='Declare_Function'>flush_pipe_input</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>logbuffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>bytes_in_logbuffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN945"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Dump any incomplete protocol messages */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN945"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="syslogger.c.html#LN945"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="syslogger.c.html#LN106"><span class='Ref_to_Const'>NBUFFER_LISTS</span></a><span class='Delimiter'>; </span><a href="syslogger.c.html#LN945"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN950"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>list</span> <span class='Operator'>= </span><a href="syslogger.c.html#LN107"><span class='Ref_to_Global_Var'>buffer_lists</span></a><span class='Delimiter'>[</span><a href="syslogger.c.html#LN945"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN951"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN951"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN950"><span class='Ref_To_Local'>list</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN955"></a>            <a href="syslogger.c.html#LN100"><span class='Ref_to_Typedef'>save_buffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN100"><span class='Ref_to_Typedef'>save_buffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN951"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN955"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN102"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN959"></a>                <a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a>  <span class='Declare_Local'>str</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN955"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN103"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/postmaster/syslogger.h.html#LN83"><span class='Ref_to_Proto'>write_syslogger_file</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN959"><span class='Ref_To_Local'>str</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN959"><span class='Ref_To_Local'>str</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Mark the buffer unused, and reclaim string storage */ 
</span>                <a href="syslogger.c.html#LN955"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="syslogger.c.html#LN102"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN959"><span class='Ref_To_Local'>str</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;NBUFFER_LISTS;i... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Force out any remaining pipe data as-is; we don't bother trying to 
     * remove any protocol headers that may exist in it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="syslogger.c.html#LN943"><span class='Ref_to_Parameter'>bytes_in_logbuffer</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/postmaster/syslogger.h.html#LN83"><span class='Ref_to_Proto'>write_syslogger_file</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN943"><span class='Ref_to_Parameter'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="syslogger.c.html#LN943"><span class='Ref_to_Parameter'>bytes_in_logbuffer</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="syslogger.c.html#LN943"><span class='Ref_to_Parameter'>bytes_in_logbuffer</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end flush_pipe_input &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      logfile routines 
 * -------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write text to the currently open logfile 
 * 
 * This is exported so that elog.c can call it when am_syslogger is true. 
 * This allows the syslogger process to record elog messages of its own, 
 * even though its stderr does not point at the syslog pipe. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN994"></a><span class='Declare_Function'>write_syslogger_file</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>count</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>destination</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN996"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN997"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>logfile</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN994"><span class='Ref_to_Parameter'>destination</span></a> <span class='Operator'>== </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a> <span class='Operator'>&& </span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="syslogger.c.html#LN1096"><span class='Ref_to_Func'>open_csvlogfile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN997"><span class='Ref_To_Local'>logfile</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN994"><span class='Ref_to_Parameter'>destination</span></a> <span class='Operator'>== </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a> <span class='Operator'>? </span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>: </span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN996"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>fwrite<span class='Parentheses'>(</span><a href="syslogger.c.html#LN994"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="syslogger.c.html#LN994"><span class='Ref_to_Parameter'>count</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN997"><span class='Ref_To_Local'>logfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* can't use ereport here because of possible recursion */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN996"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><a href="syslogger.c.html#LN994"><span class='Ref_to_Parameter'>count</span></a><span class='Parentheses'>) 
</span>        <a href="../../bin/pg_dump/parallel.c.html#LN179"><span class='Ref_to_Macro'>write_stderr</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to log file: %s\n"</span><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * Worker thread to transfer data from the pipe to the current logfile. 
 * 
 * We need this because on Windows, WaitforMultipleObjects does not work on 
 * unnamed pipes: it always reports "signaled", so the blocking ReadFile won't 
 * allow for SIGHUP; and select is for sockets only. 
 */ 
</span><span class='Keyword'>static unsigned int </span>__stdcall 
<a name="LN1020"></a><span class='Declare_Function'>pipeThread</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1022"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>logbuffer</span><span class='Delimiter'>[</span><a href="syslogger.c.html#LN55"><span class='Ref_to_Const'>READ_BUF_SIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN1023"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes_in_logbuffer</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1027"></a>        <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>bytesRead</span><span class='Delimiter'>; 
</span><a name="LN1028"></a>        BOOL        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <a href="syslogger.c.html#LN1028"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>ReadFile<span class='Parentheses'>(</span><a href="syslogger.c.html#LN111"><span class='Ref_to_Global_Var'>syslogPipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                          <a href="syslogger.c.html#LN1022"><span class='Ref_To_Local'>logbuffer</span></a> <span class='Operator'>+ </span><a href="syslogger.c.html#LN1023"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Delimiter'>, 
</span>                          <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1022"><span class='Ref_To_Local'>logbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="syslogger.c.html#LN1023"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="syslogger.c.html#LN1027"><span class='Ref_To_Local'>bytesRead</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Enter critical section before doing anything that might touch 
         * global state shared by the main thread. Anything that uses 
         * palloc()/pfree() in particular are not safe outside the critical 
         * section. 
         */ 
</span>        EnterCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN1028"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1044"></a>            <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>error</span> <span class='Operator'>= </span>GetLastError<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1044"><span class='Ref_To_Local'>error</span></a> <span class='Operator'>== </span>ERROR_HANDLE_EOF <span class='Operator'>|| 
</span>                <a href="syslogger.c.html#LN1044"><span class='Ref_To_Local'>error</span></a> <span class='Operator'>== </span>ERROR_BROKEN_PIPE<span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="../../port/win32error.c.html#LN169"><span class='Ref_to_Func'>_dosmaperr</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1044"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from logger pipe: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1027"><span class='Ref_To_Local'>bytesRead</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="syslogger.c.html#LN1023"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a> <span class='Operator'>+= </span><a href="syslogger.c.html#LN1027"><span class='Ref_To_Local'>bytesRead</span></a><span class='Delimiter'>; 
</span>            <a href="syslogger.c.html#LN791"><span class='Ref_to_Func'>process_pipe_input</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1022"><span class='Ref_To_Local'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="syslogger.c.html#LN1023"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we've filled the current logfile, nudge the main thread to do a 
         * log rotation. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN64"><span class='Ref_to_Global_Var'>Log_RotationSize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>ftell<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT;= </span><a href="syslogger.c.html#LN64"><span class='Ref_to_Global_Var'>Log_RotationSize</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span> <span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span>ftell<span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="syslogger.c.html#LN64"><span class='Ref_to_Global_Var'>Log_RotationSize</span></a> <span class='Operator'>* </span><span class='Number'>1024L</span><span class='Parentheses'>))</span> 
                <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* We exit the above loop only upon detecting pipe EOF */ 
</span>    <a href="syslogger.c.html#LN81"><span class='Ref_to_Global_Var'>pipe_eof_seen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if there's any data left then force it out now */ 
</span>    <a href="syslogger.c.html#LN942"><span class='Ref_to_Func'>flush_pipe_input</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1022"><span class='Ref_To_Local'>logbuffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="syslogger.c.html#LN1023"><span class='Ref_To_Local'>bytes_in_logbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set the latch to waken the main thread, which will quit */ 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    LeaveCriticalSection<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN118"><span class='Ref_to_Global_Var'>sysloggerSection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    _endthread<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pipeThread &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Open the csv log file - we do this opportunistically, because 
 * we don't know if CSV logging will be wanted. 
 * 
 * This is only used the first time we open the csv log in a given syslogger 
 * process, not during rotations.  As with opening the main log file, we 
 * always append in this situation. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1097"></a><span class='Declare_Function'>open_csvlogfile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1099"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filename</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN1099"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1295"><span class='Ref_to_Func'>logfile_getname</span></a><span class='Parentheses'>(</span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>".csv"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1099"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>     <span class='Comment_Single_Line'>/* probably shouldn't happen */ 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1099"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN1359"><span class='Ref_to_Func'>update_metainfo_datafile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Open a new logfile with proper permissions and buffering options. 
 * 
 * If allow_errors is true, we just log any open failure and return NULL 
 * (with errno still correct for the fopen failure). 
 * Otherwise, errors are treated as fatal. 
 */ 
</span><span class='Keyword'>static </span>FILE <span class='Operator'>* 
</span><a name="LN1121"></a><span class='Declare_Function'>logfile_open</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>mode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allow_errors</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1123"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fh</span><span class='Delimiter'>; 
</span><a name="LN1124"></a>    <a href="../../include/port/win32.h.html#LN422"><span class='Ref_to_Typedef'>mode_t</span></a>      <span class='Declare_Local'>oumask</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note we do not let Log_file_mode disable IWUSR, since we certainly want 
     * to be able to write the files ourselves. 
     */ 
</span>    <a href="syslogger.c.html#LN1124"><span class='Ref_To_Local'>oumask</span></a> <span class='Operator'>= </span>umask<span class='Parentheses'>((</span><a href="../../include/port/win32.h.html#LN422"><span class='Ref_to_Typedef'>mode_t</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>((</span><span class='Operator'>~</span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN68"><span class='Ref_to_Global_Var'>Log_file_mode</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>))</span> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN450"><span class='Ref_to_Const'>S_IRWXG</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN454"><span class='Ref_to_Const'>S_IRWXO</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1123"><span class='Ref_To_Local'>fh</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1121"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN1121"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    umask<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1124"><span class='Ref_To_Local'>oumask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1123"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        setvbuf<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1123"><span class='Ref_To_Local'>fh</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../include/port.h.html#LN339"><span class='Ref_to_Const'>PG_IOLBF</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Comment_Multi_Line'>/* use CRLF line endings on Windows */ 
</span>        _setmode<span class='Parentheses'>(</span>_fileno<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1123"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span>_O_TEXT<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1145"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1121"><span class='Ref_to_Parameter'>allow_errors</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open log file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="syslogger.c.html#LN1121"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="syslogger.c.html#LN1145"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="syslogger.c.html#LN1123"><span class='Ref_To_Local'>fh</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end logfile_open &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * perform logfile rotation 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1161"></a><span class='Declare_Function'>logfile_rotate</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>time_based_rotation</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size_rotation_for</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1163"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filename</span><span class='Delimiter'>; 
</span><a name="LN1164"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>csvfilename</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1165"></a>    <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a>   <span class='Declare_Local'>fntime</span><span class='Delimiter'>; 
</span><a name="LN1166"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fh</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When doing a time-based rotation, invent the new logfile name based on 
     * the planned rotation time, not current time, to avoid "slippage" in the 
     * file name when we don't do the rotation immediately. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>time_based_rotation</span></a><span class='Parentheses'>) 
</span>        <a href="syslogger.c.html#LN1165"><span class='Ref_To_Local'>fntime</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN80"><span class='Ref_to_Global_Var'>next_rotation_time</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="syslogger.c.html#LN1165"><span class='Ref_To_Local'>fntime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1295"><span class='Ref_to_Func'>logfile_getname</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1165"><span class='Ref_To_Local'>fntime</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1295"><span class='Ref_to_Func'>logfile_getname</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1165"><span class='Ref_To_Local'>fntime</span></a><span class='Delimiter'>, </span><span class='String'>".csv"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decide whether to overwrite or append.  We can overwrite if (a) 
     * Log_truncate_on_rotation is set, (b) the rotation was triggered by 
     * elapsed time and not something else, and (c) the computed file name is 
     * different from what we were previously logging into. 
     * 
     * Note: last_file_name should never be NULL here, but if it is, append. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>time_based_rotation</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>size_rotation_for</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN67"><span class='Ref_to_Global_Var'>Log_truncate_on_rotation</span></a> <span class='Operator'>&& </span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>time_based_rotation</span></a> <span class='Operator'>&& 
</span>            <a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            strcmp<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * ENFILE/EMFILE are not too surprising on a busy system; just 
             * keep using the old file till we manage to get a new one. 
             * Otherwise, assume something's wrong with Log_directory and stop 
             * trying to create files. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENFILE <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EMFILE<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"disabling automatic rotation (use SIGHUP to re-enable)"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !fh &raquo; </span> 
 
        fclose<span class='Parentheses'>(</span><a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN83"><span class='Ref_to_Global_Var'>syslogFile</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* instead of pfree'ing filename, remember it for next time */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if time_based_rotation||... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Same as above, but for csv file. */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>time_based_rotation</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>size_rotation_for</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN67"><span class='Ref_to_Global_Var'>Log_truncate_on_rotation</span></a> <span class='Operator'>&& </span><a href="syslogger.c.html#LN1161"><span class='Ref_to_Parameter'>time_based_rotation</span></a> <span class='Operator'>&& 
</span>            <a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            strcmp<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * ENFILE/EMFILE are not too surprising on a busy system; just 
             * keep using the old file till we manage to get a new one. 
             * Otherwise, assume something's wrong with Log_directory and stop 
             * trying to create files. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENFILE <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EMFILE<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"disabling automatic rotation (use SIGHUP to re-enable)"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="syslogger.c.html#LN82"><span class='Ref_to_Global_Var'>rotation_disabled</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !fh &raquo; </span> 
 
        fclose<span class='Parentheses'>(</span><a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN84"><span class='Ref_to_Global_Var'>csvlogFile</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1166"><span class='Ref_To_Local'>fh</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* instead of pfree'ing filename, remember it for next time */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Delimiter'>; 
</span>        <a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if csvlogFile!=NULL&&(ti... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1163"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1164"><span class='Ref_To_Local'>csvfilename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN1359"><span class='Ref_to_Func'>update_metainfo_datafile</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN1325"><span class='Ref_to_Func'>set_next_rotation_time</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end logfile_rotate &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * construct logfile name using timestamp information 
 * 
 * If suffix isn't NULL, append it to the name, replacing any ".log" 
 * that may be in the pattern. 
 * 
 * Result is palloc'd. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1296"></a><span class='Declare_Function'>logfile_getname</span><span class='Parentheses'>(</span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a> <span class='Declare_Parameter'>timestamp</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>suffix</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1298"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filename</span><span class='Delimiter'>; 
</span><a name="LN1299"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><span class='String'>"%s/"</span><span class='Delimiter'>, </span><a href="syslogger.c.html#LN65"><span class='Ref_to_Global_Var'>Log_directory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* treat Log_filename as a strftime pattern */ 
</span>    <a href="../../include/pgtime.h.html#LN67"><span class='Ref_to_Proto'>pg_strftime</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>+ </span><a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>- </span><a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN66"><span class='Ref_to_Global_Var'>Log_filename</span></a><span class='Delimiter'>, 
</span>                <a href="../../include/pgtime.h.html#LN47"><span class='Ref_to_Proto'>pg_localtime</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN1296"><span class='Ref_to_Parameter'>timestamp</span></a><span class='Delimiter'>, </span><a href="../../timezone/pgtz.c.html#LN30"><span class='Ref_to_Global_Var'>log_timezone</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1296"><span class='Ref_to_Parameter'>suffix</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><span class='Number'>4</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>".log"</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
            <a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>-= </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>+ </span><a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="syslogger.c.html#LN1296"><span class='Ref_to_Parameter'>suffix</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>- </span><a href="syslogger.c.html#LN1299"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="syslogger.c.html#LN1298"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end logfile_getname &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine the next planned rotation time, and store in next_rotation_time. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1326"></a><span class='Declare_Function'>set_next_rotation_time</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1328"></a>    <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a>   <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span><a name="LN1329"></a>    <span class='Control'>struct</span> <a href="../../include/pgtime.h.html#LN24"><span class='Ref_to_Struct'>pg_tm</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tm</span><span class='Delimiter'>; 
</span><a name="LN1330"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rotinterval</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* nothing to do if time-based rotation is disabled */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The requirements here are to choose the next time &GT; now that is a 
     * "multiple" of the log rotation interval.  "Multiple" can be interpreted 
     * fairly loosely.  In this version we align to log_timezone rather than 
     * GMT. 
     */ 
</span>    <a href="syslogger.c.html#LN1330"><span class='Ref_To_Local'>rotinterval</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN63"><span class='Ref_to_Global_Var'>Log_RotationAge</span></a> <span class='Operator'>* </span><a href="../../include/datatype/timestamp.h.html#LN87"><span class='Ref_to_Const'>SECS_PER_MINUTE</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* convert to seconds */ 
</span>    <a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a><span class='Parentheses'>) </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1329"><span class='Ref_To_Local'>tm</span></a> <span class='Operator'>= </span><a href="../../include/pgtime.h.html#LN47"><span class='Ref_to_Proto'>pg_localtime</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, </span><a href="../../timezone/pgtz.c.html#LN30"><span class='Ref_to_Global_Var'>log_timezone</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>+= </span><a href="syslogger.c.html#LN1329"><span class='Ref_To_Local'>tm</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgtime.h.html#LN35"><span class='Ref_to_Member'>tm_gmtoff</span></a><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>-= </span><a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>% </span><a href="syslogger.c.html#LN1330"><span class='Ref_To_Local'>rotinterval</span></a><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>+= </span><a href="syslogger.c.html#LN1330"><span class='Ref_To_Local'>rotinterval</span></a><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>-= </span><a href="syslogger.c.html#LN1329"><span class='Ref_To_Local'>tm</span></a><span class='Operator'>-&GT;</span><a href="../../include/pgtime.h.html#LN35"><span class='Ref_to_Member'>tm_gmtoff</span></a><span class='Delimiter'>; 
</span>    <a href="syslogger.c.html#LN80"><span class='Ref_to_Global_Var'>next_rotation_time</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1328"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end set_next_rotation_time &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Store the name of the file(s) where the log collector, when enabled, writes 
 * log messages.  Useful for finding the name(s) of the current log file(s) 
 * when there is time-based logfile rotation.  Filenames are stored in a 
 * temporary file and which is renamed into the final destination for 
 * atomicity. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1360"></a><span class='Declare_Function'>update_metainfo_datafile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1362"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fh</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN105"><span class='Ref_to_Global_Var'>Log_destination</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <span class='Operator'>!</span><span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN105"><span class='Ref_to_Global_Var'>Log_destination</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/syslogger.h.html#LN93"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/postmaster/syslogger.h.html#LN93"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="syslogger.c.html#LN1362"><span class='Ref_To_Local'>fh</span></a> <span class='Operator'>= </span><a href="syslogger.c.html#LN1120"><span class='Ref_to_Func'>logfile_open</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN105"><span class='Ref_to_Global_Var'>Log_destination</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN394"><span class='Ref_to_Const'>LOG_DESTINATION_STDERR</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1362"><span class='Ref_To_Local'>fh</span></a><span class='Delimiter'>, </span><span class='String'>"stderr %s\n"</span><span class='Delimiter'>, </span><a href="syslogger.c.html#LN86"><span class='Ref_to_Global_Var'>last_file_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            fclose<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1362"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN105"><span class='Ref_to_Global_Var'>Log_destination</span></a> <span class='Operator'>& </span><a href="../../include/utils/elog.h.html#LN397"><span class='Ref_to_Const'>LOG_DESTINATION_CSVLOG</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span><a href="syslogger.c.html#LN1362"><span class='Ref_To_Local'>fh</span></a><span class='Delimiter'>, </span><span class='String'>"csvlog %s\n"</span><span class='Delimiter'>, </span><a href="syslogger.c.html#LN87"><span class='Ref_to_Global_Var'>last_csv_file_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            fclose<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1362"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    fclose<span class='Parentheses'>(</span><a href="syslogger.c.html#LN1362"><span class='Ref_To_Local'>fh</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Delimiter'>, </span><a href="../../include/postmaster/syslogger.h.html#LN93"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Delimiter'>, </span><a href="../../include/postmaster/syslogger.h.html#LN93"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end update_metainfo_datafile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      signal handler routines 
 * -------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* SIGHUP: set flag to reload config file */ 
</span><span class='Keyword'>static void 
</span><a name="LN1425"></a><span class='Declare_Function'>sigHupHandler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1427"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="syslogger.c.html#LN1427"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGUSR1: set flag to rotate logfile */ 
</span><span class='Keyword'>static void 
</span><a name="LN1437"></a><span class='Declare_Function'>sigUsr1Handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1439"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="syslogger.c.html#LN125"><span class='Ref_to_Global_Var'>rotation_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="syslogger.c.html#LN1439"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>