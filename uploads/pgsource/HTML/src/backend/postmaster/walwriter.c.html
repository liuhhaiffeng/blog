<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\postmaster\walwriter.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\postmaster\walwriter.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * walwriter.c 
 * 
 * The WAL writer background process is new as of Postgres 8.3.  It attempts 
 * to keep regular backends from having to write out (and fsync) WAL pages. 
 * Also, it guarantees that transaction commit records that weren't synced 
 * to disk immediately upon commit (ie, were "asynchronously committed") 
 * will reach disk within a knowable time --- which, as it happens, is at 
 * most three times the wal_writer_delay cycle time. 
 * 
 * Note that as with the bgwriter for shared buffers, regular backends are 
 * still empowered to issue WAL writes and fsyncs when the walwriter doesn't 
 * keep up. This means that the WALWriter is not an essential process and 
 * can shutdown quickly when requested. 
 * 
 * Because the walwriter's cycle is directly linked to the maximum delay 
 * before async-commit transactions are guaranteed committed, it's probably 
 * unwise to load additional functionality onto it.  For instance, if you've 
 * got a yen to create xlog segments further in advance, that'd be better done 
 * in bgwriter than in walwriter. 
 * 
 * The walwriter is started by the postmaster as soon as the startup subprocess 
 * finishes.  It remains alive until the postmaster commands it to terminate. 
 * Normal termination is by SIGTERM, which instructs the walwriter to exit(0). 
 * Emergency termination is by SIGQUIT; like any backend, the walwriter will 
 * simply abort and exit on SIGQUIT. 
 * 
 * If the walwriter exits unexpectedly, the postmaster treats that the same 
 * as a backend crash: shared memory may be corrupted, so remaining backends 
 * should be killed by SIGQUIT and then a recovery cycle started. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/postmaster/walwriter.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/walwriter.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/condition_variable.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lwlock.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * GUC parameters 
 */ 
</span><a name="LN67"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>WalWriterDelay</span> <span class='Operator'>= </span><span class='Number'>200</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>WalWriterFlushAfter</span> <span class='Operator'>= </span><span class='Number'>128</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Number of do-nothing loops before lengthening the delay time, and the 
 * multiplier to apply to WalWriterDelay when we do decide to hibernate. 
 * (Perhaps these need to be configurable?) 
 */ 
</span><a name="LN75"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>LOOPS_UNTIL_HIBERNATE</span>       <span class='Number'>50</span> 
<a name="LN76"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>HIBERNATE_FACTOR</span>            <span class='Number'>25</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Flags set by interrupt handlers for later service in the main loop. 
 */ 
</span><a name="LN81"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>got_SIGHUP</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>shutdown_requested</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Signal handlers */ 
</span><a name="LN85"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>wal_quickdie</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN86"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WalSigHupHandler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WalShutdownHandler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>walwriter_sigusr1_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Main entry point for walwriter process 
 * 
 * This is invoked from AuxiliaryProcessMain, which has already created the 
 * basic execution environment, but not enabled signals yet. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN97"></a><span class='Declare_Function'>WalWriterMain</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN99"></a>    <a href="../../include/c.h.html#LN1087"><span class='Ref_to_Const'>sigjmp_buf</span></a>  <span class='Declare_Local'>local_sigjmp_buf</span><span class='Delimiter'>; 
</span><a name="LN100"></a>    <a href="../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>walwriter_context</span><span class='Delimiter'>; 
</span><a name="LN101"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>left_till_hibernate</span><span class='Delimiter'>; 
</span><a name="LN102"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>hibernating</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Properly accept or ignore signals the postmaster might send us 
     * 
     * We have no particular use for SIGINT at the moment, but seems 
     * reasonable to treat like SIGTERM. 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="walwriter.c.html#LN86"><span class='Ref_to_Proto'>WalSigHupHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* set flag to read config file */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="walwriter.c.html#LN87"><span class='Ref_to_Proto'>WalShutdownHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* request shutdown */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="walwriter.c.html#LN87"><span class='Ref_to_Proto'>WalShutdownHandler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* request shutdown */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Delimiter'>, </span><a href="walwriter.c.html#LN85"><span class='Ref_to_Proto'>wal_quickdie</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* hard crash time */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN193"><span class='Ref_to_Const'>SIGALRM</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN192"><span class='Ref_to_Const'>SIGPIPE</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Delimiter'>, </span><a href="walwriter.c.html#LN88"><span class='Ref_to_Proto'>walwriter_sigusr1_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN202"><span class='Ref_to_Const'>SIGUSR2</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN184"><span class='Ref_to_Const'>SIG_IGN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* not used */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset some signals that are accepted by postmaster but not here 
     */ 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN197"><span class='Ref_to_Const'>SIGCHLD</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN198"><span class='Ref_to_Const'>SIGTTIN</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN199"><span class='Ref_to_Const'>SIGTTOU</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN196"><span class='Ref_to_Const'>SIGCONT</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN200"><span class='Ref_to_Const'>SIGWINCH</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN182"><span class='Ref_to_Const'>SIG_DFL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We allow SIGQUIT (quickdie) at all times */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN29"><span class='Ref_to_Macro'>sigdelset</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN188"><span class='Ref_to_Const'>SIGQUIT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a resource owner to keep track of our resources (not clear that 
     * we need this, but may as well have one). 
     */ 
</span>    <a href="../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="../../include/utils/resowner.h.html#LN66"><span class='Ref_to_Proto'>ResourceOwnerCreate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>"Wal Writer"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a memory context that we will do all our work in.  We do this so 
     * that we can reset the context during error recovery and thereby avoid 
     * possible memory leaks.  Formerly this code just ran in 
     * TopMemoryContext, but resetting that would be a really bad idea. 
     */ 
</span>    <a href="walwriter.c.html#LN100"><span class='Ref_To_Local'>walwriter_context</span></a> <span class='Operator'>= </span><a href="../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                              <span class='String'>"Wal Writer"</span><span class='Delimiter'>, 
</span>                                              <a href="../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="walwriter.c.html#LN100"><span class='Ref_To_Local'>walwriter_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If an exception is encountered, processing resumes here. 
     * 
     * This code is heavily based on bgwriter.c, q.v. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1088"><span class='Ref_to_Macro'>sigsetjmp</span></a><span class='Parentheses'>(</span><a href="walwriter.c.html#LN99"><span class='Ref_To_Local'>local_sigjmp_buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Since not using PG_TRY, must reset error stack by hand */ 
</span>        <a href="../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prevent interrupts while cleaning up */ 
</span>        <a href="../../include/miscadmin.h.html#LN116"><span class='Ref_to_Macro'>HOLD_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Report the error to the server log */ 
</span>        <a href="../../include/utils/elog.h.html#LN362"><span class='Ref_to_Proto'>EmitErrorReport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * These operations are really just a minimal subset of 
         * AbortTransaction().  We don't have very many resources to worry 
         * about in walwriter, but we do have LWLocks, and perhaps buffers? 
         */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN150"><span class='Ref_to_Proto'>LWLockReleaseAll</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/condition_variable.h.html#LN45"><span class='Ref_to_Proto'>ConditionVariableCancelSleep</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/bufmgr.h.html#LN221"><span class='Ref_to_Proto'>AbortBufferIO</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/bufmgr.h.html#LN213"><span class='Ref_to_Proto'>UnlockBuffers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* buffer pins are released here: */ 
</span>        <a href="../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* we needn't bother with the other ResourceOwnerRelease phases */ 
</span>        <a href="../../include/storage/bufmgr.h.html#LN184"><span class='Ref_to_Proto'>AtEOXact_Buffers</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/smgr.h.html#LN111"><span class='Ref_to_Proto'>AtEOXact_SMgr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN109"><span class='Ref_to_Proto'>AtEOXact_Files</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/hsearch.h.html#LN141"><span class='Ref_to_Proto'>AtEOXact_HashTables</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now return to normal top-level context and clear ErrorContext for 
         * next time. 
         */ 
</span>        <a href="../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="walwriter.c.html#LN100"><span class='Ref_To_Local'>walwriter_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN365"><span class='Ref_to_Proto'>FlushErrorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Flush any leaked data in the top-level context */ 
</span>        <a href="../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="walwriter.c.html#LN100"><span class='Ref_To_Local'>walwriter_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Now we can allow interrupts again */ 
</span>        <a href="../../include/miscadmin.h.html#LN118"><span class='Ref_to_Macro'>RESUME_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sleep at least 1 second after any error.  A write error is likely 
         * to be repeated, and we don't want to be filling the error logs as 
         * fast as we can. 
         */ 
</span>        <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Close all open files after any error.  This is helpful on Windows, 
         * where holding deleted files open causes various strange errors. 
         * It's not clear we need it elsewhere, but shouldn't hurt. 
         */ 
</span>        <a href="../../include/storage/smgr.h.html#LN88"><span class='Ref_to_Proto'>smgrcloseall</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if sigsetjmp(local_sigjm... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* We can now handle ereport(ERROR) */ 
</span>    <a href="../utils/error/elog.c.html#LN89"><span class='Ref_to_Global_Var'>PG_exception_stack</span></a> <span class='Operator'>= &</span><a href="walwriter.c.html#LN99"><span class='Ref_To_Local'>local_sigjmp_buf</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unblock signals (they were blocked when the postmaster forked us) 
     */ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN21"><span class='Ref_to_Global_Var'>UnBlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reset hibernation state after any error. 
     */ 
</span>    <a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a> <span class='Operator'>= </span><a href="walwriter.c.html#LN75"><span class='Ref_to_Const'>LOOPS_UNTIL_HIBERNATE</span></a><span class='Delimiter'>; 
</span>    <a href="walwriter.c.html#LN102"><span class='Ref_To_Local'>hibernating</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/xlog.h.html#LN282"><span class='Ref_to_Proto'>SetWalWriterSleeping</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advertise our latch that backends can use to wake us up while we're 
     * sleeping. 
     */ 
</span>    <a href="../storage/lmgr/proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/proc.h.html#LN245"><span class='Ref_to_Member'>walwriterLatch</span></a> <span class='Operator'>= &</span><a href="../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Loop forever 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN238"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>cur_timeout</span><span class='Delimiter'>; 
</span><a name="LN239"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Advertise whether we might hibernate in this cycle.  We do this 
         * before resetting the latch to ensure that any async commits will 
         * see the flag set if they might possibly need to wake us up, and 
         * that we won't miss any signal they send us.  (If we discover work 
         * to do in the last cycle before we would hibernate, the global flag 
         * will be set unnecessarily, but little harm is done.)  But avoid 
         * touching the global flag if it doesn't need to change. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walwriter.c.html#LN102"><span class='Ref_To_Local'>hibernating</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a> <span class='Operator'>&LT;= </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="walwriter.c.html#LN102"><span class='Ref_To_Local'>hibernating</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a> <span class='Operator'>&LT;= </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/xlog.h.html#LN282"><span class='Ref_to_Proto'>SetWalWriterSleeping</span></a><span class='Parentheses'>(</span><a href="walwriter.c.html#LN102"><span class='Ref_To_Local'>hibernating</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Clear any already-pending wakeups */ 
</span>        <a href="../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Process any requests or signals received recently. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="startup.c.html#LN41"><span class='Ref_to_Global_Var'>shutdown_requested</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Normal exit from the walwriter is here */ 
</span>            <a href="../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* done */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Do what we're here for; then, if XLogBackgroundFlush() found useful 
         * work to do, reset hibernation counter. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN226"><span class='Ref_to_Proto'>XLogBackgroundFlush</span></a><span class='Parentheses'>())</span> 
            <a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a> <span class='Operator'>= </span><a href="walwriter.c.html#LN75"><span class='Ref_to_Const'>LOOPS_UNTIL_HIBERNATE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sleep until we are signaled or WalWriterDelay has elapsed.  If we 
         * haven't done anything useful for quite some time, lengthen the 
         * sleep time so as to reduce the server's idle power consumption. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walwriter.c.html#LN101"><span class='Ref_To_Local'>left_till_hibernate</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="walwriter.c.html#LN238"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= </span><a href="walwriter.c.html#LN67"><span class='Ref_to_Global_Var'>WalWriterDelay</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* in ms */ 
</span>        <span class='Control'>else</span> 
            <a href="walwriter.c.html#LN238"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= </span><a href="walwriter.c.html#LN67"><span class='Ref_to_Global_Var'>WalWriterDelay</span></a> <span class='Operator'>* </span><a href="bgwriter.c.html#LN72"><span class='Ref_to_Const'>HIBERNATE_FACTOR</span></a><span class='Delimiter'>; 
</span> 
        <a href="walwriter.c.html#LN239"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>, 
</span>                       <a href="walwriter.c.html#LN238"><span class='Ref_To_Local'>cur_timeout</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/pgstat.h.html#LN767"><span class='Ref_to_EnumConst'>WAIT_EVENT_WAL_WRITER_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Emergency bailout if postmaster has died.  This is to avoid the 
         * necessity for manual cleanup of all postmaster children. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="walwriter.c.html#LN239"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WalWriterMain &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* -------------------------------- 
 *      signal handler routines 
 * -------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * wal_quickdie() occurs when signalled SIGQUIT by the postmaster. 
 * 
 * Some backend has bought the farm, 
 * so we need to stop what we're doing and exit. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN319"></a><span class='Declare_Function'>wal_quickdie</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/libpq/pqsignal.h.html#LN18"><span class='Ref_to_Macro'>PG_SETMASK</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="../libpq/pqsignal.c.html#LN22"><span class='Ref_to_Global_Var'>BlockSig</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We DO NOT want to run proc_exit() callbacks -- we're here because 
     * shared memory may be corrupted, so we don't want to try to clean up our 
     * transaction.  Just nail the windows shut and get out of town.  Now that 
     * there's an atexit callback to prevent third-party code from breaking 
     * things by calling exit() directly, we have to reset the callbacks 
     * explicitly to make this work as intended. 
     */ 
</span>    <a href="../../include/storage/ipc.h.html#LN72"><span class='Ref_to_Proto'>on_exit_reset</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note we do exit(2) not exit(0).  This is to force the postmaster into a 
     * system reset cycle if some idiot DBA sends a manual SIGQUIT to a random 
     * backend.  This is necessary precisely because we don't clean up our 
     * shared memory state.  (The "dead man switch" mechanism in pmsignal.c 
     * should ensure the postmaster sees this as a crash, too, but no harm in 
     * being doubly sure.) 
     */ 
</span>    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end wal_quickdie &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* SIGHUP: set flag to re-read config file at next convenient time */ 
</span><span class='Keyword'>static void 
</span><a name="LN346"></a><span class='Declare_Function'>WalSigHupHandler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN348"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="walwriter.c.html#LN348"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGTERM: set flag to exit normally */ 
</span><span class='Keyword'>static void 
</span><a name="LN358"></a><span class='Declare_Function'>WalShutdownHandler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN360"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="startup.c.html#LN41"><span class='Ref_to_Global_Var'>shutdown_requested</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="walwriter.c.html#LN360"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGUSR1: used for latch wakeups */ 
</span><span class='Keyword'>static void 
</span><a name="LN370"></a><span class='Declare_Function'>walwriter_sigusr1_handler</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN372"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/latch.h.html#LN173"><span class='Ref_to_Proto'>latch_sigusr1_handler</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="walwriter.c.html#LN372"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>