<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\regex\regprefix.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\regex\regprefix.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * regprefix.c 
 *    Extract a common prefix, if any, from a compiled regex. 
 * 
 * 
 * Portions Copyright (c) 2012-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1998, 1999 Henry Spencer 
 * 
 * IDENTIFICATION 
 *    src/backend/regex/regprefix.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"regex/regguts.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * forward declarations 
 */ 
</span><a name="LN21"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>findprefix</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="regprefix.c.html#LN21"><span class='Ref_to_Parameter'>cnfa</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>cnfa</span><span class='Delimiter'>, </span><span class='Control'>struct</span> <a href="../../include/regex/regguts.h.html#LN205"><span class='Ref_to_Struct'>colormap</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>cm</span><span class='Delimiter'>, 
</span><a name="LN22"></a>           <a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>string</span><span class='Delimiter'>, </span>size_t <span class='Operator'>*</span><span class='Declare_Parameter'>slength</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * pg_regprefix - get common prefix for regular expression 
 * 
 * Returns one of: 
 *  REG_NOMATCH: there is no common prefix of strings matching the regex 
 *  REG_PREFIX: there is a common prefix of strings matching the regex 
 *  REG_EXACT: all strings satisfying the regex must match the same string 
 *  or a REG_XXX error code 
 * 
 * In the non-failure cases, *string is set to a malloc'd string containing 
 * the common prefix or exact value, of length *slength (measured in chrs 
 * not bytes!). 
 * 
 * This function does not analyze all complex cases (such as lookaround 
 * constraints) exactly.  Therefore it is possible that some strings matching 
 * the reported prefix or exact-match string do not satisfy the regex.  But 
 * it should never be the case that a string satisfying the regex does not 
 * match the reported prefix or exact-match string. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN45"></a><span class='Declare_Function'>pg_regprefix</span><span class='Parentheses'>(</span><a href="../../include/regex/regex.h.html#LN54"><span class='Ref_to_Typedef'>regex_t</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>re</span><span class='Delimiter'>, 
</span><a name="LN46"></a>             <a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>string</span><span class='Delimiter'>, 
</span><a name="LN47"></a>             size_t <span class='Operator'>*</span><span class='Declare_Parameter'>slength</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN49"></a>    <span class='Control'>struct</span> <a href="../../include/regex/regguts.h.html#LN461"><span class='Ref_to_Struct'>guts</span></a> <span class='Operator'>*</span><span class='Declare_Local'>g</span><span class='Delimiter'>; 
</span><a name="LN50"></a>    <span class='Control'>struct</span> <a href="regprefix.c.html#LN50"><span class='Ref_To_Local'>cnfa</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cnfa</span><span class='Delimiter'>; 
</span><a name="LN51"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sanity checks */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="regprefix.c.html#LN47"><span class='Ref_to_Parameter'>slength</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN151"><span class='Ref_to_Const'>REG_INVARG</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* initialize for failure cases */ 
</span>    <span class='Operator'>*</span><a href="regprefix.c.html#LN47"><span class='Ref_to_Parameter'>slength</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN45"><span class='Ref_to_Parameter'>re</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="regprefix.c.html#LN45"><span class='Ref_to_Parameter'>re</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regex.h.html#LN56"><span class='Ref_to_Member'>re_magic</span></a> <span class='Operator'>!= </span><a href="../../include/regex/regguts.h.html#LN95"><span class='Ref_to_Const'>REMAGIC</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN151"><span class='Ref_to_Const'>REG_INVARG</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN45"><span class='Ref_to_Parameter'>re</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regex.h.html#LN73"><span class='Ref_to_Member'>re_csize</span></a> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN152"><span class='Ref_to_Const'>REG_MIXED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize locale-dependent support */ 
</span>    <a href="regc_pg_locale.c.html#LN230"><span class='Ref_to_Func'>pg_set_regex_collation</span></a><span class='Parentheses'>(</span><a href="regprefix.c.html#LN45"><span class='Ref_to_Parameter'>re</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regex.h.html#LN75"><span class='Ref_to_Member'>re_collation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* setup */ 
</span>    <a href="regprefix.c.html#LN49"><span class='Ref_To_Local'>g</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="../../include/regex/regguts.h.html#LN461"><span class='Ref_to_Struct'>guts</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="regprefix.c.html#LN45"><span class='Ref_to_Parameter'>re</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regex.h.html#LN77"><span class='Ref_to_Member'>re_guts</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN49"><span class='Ref_To_Local'>g</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN466"><span class='Ref_to_Member'>info</span></a> <span class='Operator'>& </span><a href="../../include/regex/regex.h.html#LN71"><span class='Ref_to_Const'>REG_UIMPOSSIBLE</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN137"><span class='Ref_to_Const'>REG_NOMATCH</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This implementation considers only the search NFA for the topmost regex 
     * tree node.  Therefore, constraints such as backrefs are not fully 
     * applied, which is allowed per the function's API spec. 
     */ 
</span>    <span class='Debug'>assert</span><span class='Parentheses'>(</span><a href="regprefix.c.html#LN49"><span class='Ref_To_Local'>g</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN468"><span class='Ref_to_Member'>tree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="regprefix.c.html#LN50"><span class='Ref_To_Local'>cnfa</span></a> <span class='Operator'>= &</span><a href="regprefix.c.html#LN49"><span class='Ref_To_Local'>g</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN468"><span class='Ref_to_Member'>tree</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN434"><span class='Ref_to_Member'>cnfa</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since a correct NFA should never contain any exit-free loops, it should 
     * not be possible for our traversal to return to a previously visited NFA 
     * state.  Hence we need at most nstates chrs in the output string. 
     */ 
</span>    <span class='Operator'>*</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/regex/regcustom.h.html#LN61"><span class='Ref_to_Macro'>MALLOC</span></a><span class='Parentheses'>(</span><a href="regprefix.c.html#LN50"><span class='Ref_To_Local'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN355"><span class='Ref_to_Member'>nstates</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN148"><span class='Ref_to_Const'>REG_ESPACE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* do it */ 
</span>    <a href="regprefix.c.html#LN51"><span class='Ref_To_Local'>st</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN21"><span class='Ref_to_Proto'>findprefix</span></a><span class='Parentheses'>(</span><a href="regprefix.c.html#LN50"><span class='Ref_To_Local'>cnfa</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="regprefix.c.html#LN49"><span class='Ref_To_Local'>g</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN471"><span class='Ref_to_Member'>cmap</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a><span class='Delimiter'>, </span><a href="regprefix.c.html#LN47"><span class='Ref_to_Parameter'>slength</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>assert</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="regprefix.c.html#LN47"><span class='Ref_to_Parameter'>slength</span></a> <span class='Operator'>&LT;= </span><a href="regprefix.c.html#LN50"><span class='Ref_To_Local'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN355"><span class='Ref_to_Member'>nstates</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* clean up */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN51"><span class='Ref_To_Local'>st</span></a> <span class='Operator'>!= </span><a href="../../include/regex/regex.h.html#LN161"><span class='Ref_to_Const'>REG_PREFIX</span></a> <span class='Operator'>&& </span><a href="regprefix.c.html#LN51"><span class='Ref_To_Local'>st</span></a> <span class='Operator'>!= </span><a href="../../include/regex/regex.h.html#LN162"><span class='Ref_to_Const'>REG_EXACT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../common/unicode_norm.c.html#LN25"><span class='Ref_to_Macro'>FREE</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="regprefix.c.html#LN46"><span class='Ref_to_Parameter'>string</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="regprefix.c.html#LN47"><span class='Ref_to_Parameter'>slength</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="regprefix.c.html#LN51"><span class='Ref_To_Local'>st</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_regprefix &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * findprefix - extract common prefix from cNFA 
 * 
 * Results are returned into the preallocated chr array string[], with 
 * *slength (which must be preset to zero) incremented for each chr. 
 */ 
</span><span class='Keyword'>static int</span>                      <span class='Comment_Single_Line'>/* regprefix return code */ 
</span><a name="LN111"></a><span class='Declare_Function'>findprefix</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>cnfa</span><span class='Delimiter'>, 
</span><a name="LN112"></a>           <span class='Control'>struct</span> <a href="../../include/regex/regguts.h.html#LN205"><span class='Ref_to_Struct'>colormap</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>cm</span><span class='Delimiter'>, 
</span><a name="LN113"></a>           <a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>string</span><span class='Delimiter'>, 
</span><a name="LN114"></a>           size_t <span class='Operator'>*</span><span class='Declare_Parameter'>slength</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN116"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span><a name="LN117"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nextst</span><span class='Delimiter'>; 
</span><a name="LN118"></a>    <a href="../../include/regex/regguts.h.html#LN133"><span class='Ref_to_Typedef'>color</span></a>       <span class='Declare_Local'>thiscolor</span><span class='Delimiter'>; 
</span><a name="LN119"></a>    <a href="../../include/regex/regcustom.h.html#LN67"><span class='Ref_to_Typedef'>chr</span></a>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN120"></a>    <span class='Control'>struct</span> <a href="../../include/regex/regguts.h.html#LN347"><span class='Ref_to_Struct'>carc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ca</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The "pre" state must have only BOS/BOL outarcs, else pattern isn't 
     * anchored left.  If we have both BOS and BOL, they must go to the same 
     * next state. 
     */ 
</span>    <a href="regprefix.c.html#LN116"><span class='Ref_To_Local'>st</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN359"><span class='Ref_to_Member'>pre</span></a><span class='Delimiter'>; 
</span>    <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN365"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="regprefix.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Delimiter'>]; </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>!= </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Delimiter'>; </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN361"><span class='Ref_to_Member'>bos</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>|| </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN361"><span class='Ref_to_Member'>bos</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN350"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>!= </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN350"><span class='Ref_to_Member'>to</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN137"><span class='Ref_to_Const'>REG_NOMATCH</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN137"><span class='Ref_to_Const'>REG_NOMATCH</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN137"><span class='Ref_to_Const'>REG_NOMATCH</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan through successive states, stopping as soon as we find one with 
     * more than one acceptable transition character (either multiple colors 
     * on out-arcs, or a color with more than one member chr). 
     * 
     * We could find a state with multiple out-arcs that are all labeled with 
     * the same singleton color; this comes from patterns like "^ab(cde|cxy)". 
     * In that case we add the chr "c" to the output string but then exit the 
     * loop with nextst == -1.  This leaves a little bit on the table: if the 
     * pattern is like "^ab(cde|cdy)", we won't notice that "d" could be added 
     * to the prefix.  But chasing multiple parallel state chains doesn't seem 
     * worth the trouble. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="regprefix.c.html#LN116"><span class='Ref_To_Local'>st</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a><span class='Delimiter'>; 
</span>        <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>= </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN365"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="regprefix.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Delimiter'>]; </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>!= </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Delimiter'>; </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We can ignore BOS/BOL arcs */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN361"><span class='Ref_to_Member'>bos</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>|| </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN361"><span class='Ref_to_Member'>bos</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* ... but EOS/EOL arcs terminate the search, as do LACONs */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN362"><span class='Ref_to_Member'>eos</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>|| </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN362"><span class='Ref_to_Member'>eos</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>|| 
</span>                <a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>&GT;= </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN356"><span class='Ref_to_Member'>ncolors</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>= </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>== </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* First plain outarc */ 
</span>                <a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a><span class='Delimiter'>; 
</span>                <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN350"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Another plain outarc for same color */ 
</span>                <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* More than one plain outarc color terminates the search */ 
</span>                <a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>= </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ca=cnfa-&GT;states[st];c... &raquo; </span> 
        <span class='Comment_Multi_Line'>/* Done if we didn't find exactly one color on plain outarcs */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a> <span class='Operator'>== </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* The color must be a singleton */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN112"><span class='Ref_to_Parameter'>cm</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN213"><span class='Ref_to_Member'>cd</span></a><span class='Delimiter'>[</span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/regex/regguts.h.html#LN155"><span class='Ref_to_Member'>nschrs</span></a> <span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Must not have any high-color-map entries */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN112"><span class='Ref_to_Parameter'>cm</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN213"><span class='Ref_to_Member'>cd</span></a><span class='Delimiter'>[</span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/regex/regguts.h.html#LN156"><span class='Ref_to_Member'>nuchrs</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Identify the color's sole member chr and add it to the prefix 
         * string.  In general the colormap data structure doesn't provide a 
         * way to find color member chrs, except by trying GETCOLOR() on each 
         * possible chr value, which won't do at all.  However, for the cases 
         * we care about it should be sufficient to test the "firstchr" value, 
         * that is the first chr ever added to the color.  There are cases 
         * where this might no longer be a member of the color (so we do need 
         * to test), but none of them are likely to arise for a character that 
         * is a member of a common prefix.  If we do hit such a corner case, 
         * we just fall out without adding anything to the prefix string. 
         */ 
</span>        <a href="regprefix.c.html#LN119"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN112"><span class='Ref_to_Parameter'>cm</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN213"><span class='Ref_to_Member'>cd</span></a><span class='Delimiter'>[</span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/regex/regguts.h.html#LN160"><span class='Ref_to_Member'>firstchr</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/regex/regguts.h.html#LN234"><span class='Ref_to_Macro'>GETCOLOR</span></a><span class='Parentheses'>(</span><a href="regprefix.c.html#LN112"><span class='Ref_to_Parameter'>cm</span></a><span class='Delimiter'>, </span><a href="regprefix.c.html#LN119"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="regprefix.c.html#LN118"><span class='Ref_To_Local'>thiscolor</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="regprefix.c.html#LN113"><span class='Ref_to_Parameter'>string</span></a><span class='Delimiter'>[</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="regprefix.c.html#LN114"><span class='Ref_to_Parameter'>slength</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="regprefix.c.html#LN119"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Advance to next state, but only if we have a unique next state */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we ended at a state that only has EOS/EOL outarcs leading to the 
     * "post" state, then we have an exact-match string.  Note this is true 
     * even if the string is of zero length. 
     */ 
</span>    <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN365"><span class='Ref_to_Member'>states</span></a><span class='Delimiter'>[</span><a href="regprefix.c.html#LN116"><span class='Ref_To_Local'>st</span></a><span class='Delimiter'>]; </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>!= </span><a href="../../include/regex/regguts.h.html#LN136"><span class='Ref_to_Const'>COLORLESS</span></a><span class='Delimiter'>; </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN362"><span class='Ref_to_Member'>eos</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>|| </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN349"><span class='Ref_to_Member'>co</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN362"><span class='Ref_to_Member'>eos</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN350"><span class='Ref_to_Member'>to</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>!= </span><a href="regprefix.c.html#LN120"><span class='Ref_To_Local'>ca</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN350"><span class='Ref_to_Member'>to</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="regprefix.c.html#LN117"><span class='Ref_To_Local'>nextst</span></a> <span class='Operator'>== </span><a href="regprefix.c.html#LN111"><span class='Ref_to_Parameter'>cnfa</span></a><span class='Operator'>-&GT;</span><a href="../../include/regex/regguts.h.html#LN360"><span class='Ref_to_Member'>post</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN162"><span class='Ref_to_Const'>REG_EXACT</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise, if we were unable to identify any prefix characters, say 
     * NOMATCH --- the pattern is anchored left, but doesn't specify any 
     * particular first character. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="regprefix.c.html#LN114"><span class='Ref_to_Parameter'>slength</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN161"><span class='Ref_to_Const'>REG_PREFIX</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/regex/regex.h.html#LN137"><span class='Ref_to_Const'>REG_NOMATCH</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end findprefix &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>