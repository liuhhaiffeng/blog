<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\replication\basebackup.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\replication\basebackup.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * basebackup.c 
 *    code for taking a base backup and streaming it to a standby 
 * 
 * Portions Copyright (c) 2010-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/backend/replication/basebackup.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span>       <span class='Comment_Single_Line'>/* for pg_start/stop_backup */ 
</span><span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqformat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/pg_list.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgtar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/syslogger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/basebackup.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/dsm_impl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/elog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ps_status.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN43"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Member'>label</span><span class='Delimiter'>; 
</span><a name="LN44"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>progress</span><span class='Delimiter'>; 
</span><a name="LN45"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>fastcheckpoint</span><span class='Delimiter'>; 
</span><a name="LN46"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>nowait</span><span class='Delimiter'>; 
</span><a name="LN47"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>includewal</span><span class='Delimiter'>; 
</span><a name="LN48"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>maxrate</span><span class='Delimiter'>; 
</span><a name="LN49"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>sendtblspcmapfile</span><span class='Delimiter'>; 
</span><a name="LN50"></a>} <span class='Declare_Typedef'>basebackup_options</span><span class='Delimiter'>; 
</span> 
 
<a name="LN53"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Prototype'>sendDir</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>basepathlen</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Delimiter'>, 
</span><a name="LN54"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tablespaces</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sendtblspclinks</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN55"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>sendFile</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>readfilename</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tarfilename</span><span class='Delimiter'>, 
</span><a name="LN56"></a>         <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>statbuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN57"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sendFileWithContent</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>content</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN58"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Prototype'>_tarWriteHeader</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>linktarget</span><span class='Delimiter'>, 
</span><a name="LN59"></a>                <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>statbuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN60"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Prototype'>_tarWriteDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathbuf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>basepathlen</span><span class='Delimiter'>, </span><span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>statbuf</span><span class='Delimiter'>, 
</span><a name="LN61"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN62"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>send_int8_string</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Parameter'>intval</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN63"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SendBackupHeader</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tablespaces</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>base_backup_cleanup</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN65"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>perform_base_backup</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN41"><span class='Ref_to_Typedef'>basebackup_options</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opt</span><span class='Delimiter'>, </span><a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tblspcdir</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN66"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>parse_basebackup_options</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN41"><span class='Ref_to_Typedef'>basebackup_options</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opt</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SendXlogRecPtrResult</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Declare_Parameter'>tli</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>compareWalFileNames</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>throttle</span><span class='Parentheses'>(</span>size_t <span class='Declare_Parameter'>increment</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Was the backup currently in-progress initiated in recovery mode? */ 
</span><a name="LN72"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>backup_started_in_recovery</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Relative path of temporary statistics directory */ 
</span><a name="LN75"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>statrelpath</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Size of each block sent into the tar stream for larger files. 
 */ 
</span><a name="LN80"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TAR_SEND_SIZE</span> <span class='Number'>32768</span> 
 
<span class='Comment_Multi_Line'>/* 
 * How frequently to throttle, as a fraction of the specified rate-second. 
 */ 
</span><a name="LN85"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>THROTTLING_FREQUENCY</span>    <span class='Number'>8</span> 
 
<span class='Comment_Multi_Line'>/* The actual number of bytes, transfer of which may cause sleep. */ 
</span><a name="LN88"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Var'>throttling_sample</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Amount of data already transferred but not yet throttled.  */ 
</span><a name="LN91"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Var'>throttling_counter</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* The minimum time required to transfer throttling_sample bytes. */ 
</span><a name="LN94"></a><span class='Keyword'>static </span><a href="../../include/datatype/timestamp.h.html#LN39"><span class='Ref_to_Typedef'>TimeOffset</span></a> <span class='Declare_Var'>elapsed_min_unit</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* The last check of the transfer rate. */ 
</span><a name="LN97"></a><span class='Keyword'>static </span><a href="../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Var'>throttled_last</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The contents of these directories are removed or recreated during server 
 * start so they are not included in backups.  The directories themselves are 
 * kept and included as empty to preserve access permissions. 
 */ 
</span><a name="LN104"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Var'>excludeDirContents</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Skip temporary statistics files. PG_STAT_TMP_DIR must be skipped even 
     * when stats_temp_directory is set because PGSS_TEXT_FILE is always 
     * created there. 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN33"><span class='Ref_to_Const'>PG_STAT_TMP_DIR</span></a><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It is generally not useful to backup the contents of this directory 
     * even if the intention is to restore to another master. See backup.sgml 
     * for a more detailed description. 
     */ 
</span>    <span class='String'>"pg_replslot"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* Contents removed on startup, see dsm_cleanup_for_mmap(). */ 
</span>    <a href="../../include/storage/dsm_impl.h.html#LN50"><span class='Ref_to_Const'>PG_DYNSHMEM_DIR</span></a><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* Contents removed on startup, see AsyncShmemInit(). */ 
</span>    <span class='String'>"pg_notify"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Old contents are loaded for possible debugging but are not required for 
     * normal operation, see OldSerXidInit(). 
     */ 
</span>    <span class='String'>"pg_serial"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* Contents removed on startup, see DeleteAllExportedSnapshotFiles(). */ 
</span>    <span class='String'>"pg_snapshots"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* Contents zeroed on startup, see StartupSUBTRANS(). */ 
</span>    <span class='String'>"pg_subtrans"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* end of list */ 
</span>    <span class='Null_Value'>NULL 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of files excluded from backups. 
 */ 
</span><a name="LN145"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Var'>excludeFiles</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Skip auto conf temporary file. */ 
</span>    <a href="../../include/utils/guc.h.html#LN33"><span class='Ref_to_Const'>PG_AUTOCONF_FILENAME</span></a> <span class='String'>".tmp"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* Skip current log file temporary file */ 
</span>    <a href="../../include/postmaster/syslogger.h.html#LN94"><span class='Ref_to_Const'>LOG_METAINFO_DATAFILE_TMP</span></a><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's a backup_label or tablespace_map file, it belongs to a 
     * backup started by the user with pg_start_backup().  It is *not* correct 
     * for this backup.  Our backup_label/tablespace_map is injected into the 
     * tar separately. 
     */ 
</span>    <a href="../../include/access/xlog.h.html#LN320"><span class='Ref_to_Const'>BACKUP_LABEL_FILE</span></a><span class='Delimiter'>, 
</span>    <a href="../../include/access/xlog.h.html#LN323"><span class='Ref_to_Const'>TABLESPACE_MAP</span></a><span class='Delimiter'>, 
</span> 
    <span class='String'>"postmaster.pid"</span><span class='Delimiter'>, 
</span>    <span class='String'>"postmaster.opts"</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* end of list */ 
</span>    <span class='Null_Value'>NULL 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Called when ERROR or FATAL happens in perform_base_backup() after 
 * we have started the backup - make sure we end it! 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN174"></a><span class='Declare_Function'>base_backup_cleanup</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/access/xlog.h.html#LN316"><span class='Ref_to_Proto'>do_pg_abort_backup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Actually do a base backup for the specified tablespaces. 
 * 
 * This is split out mainly to avoid complaints about "variable might be 
 * clobbered by longjmp" from stupider versions of gcc. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN186"></a><span class='Declare_Function'>perform_base_backup</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN41"><span class='Ref_to_Typedef'>basebackup_options</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opt</span><span class='Delimiter'>, </span><a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tblspcdir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN188"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>startptr</span><span class='Delimiter'>; 
</span><a name="LN189"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>starttli</span><span class='Delimiter'>; 
</span><a name="LN190"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>endptr</span><span class='Delimiter'>; 
</span><a name="LN191"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>endtli</span><span class='Delimiter'>; 
</span><a name="LN192"></a>    <a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a>  <span class='Declare_Local'>labelfile</span><span class='Delimiter'>; 
</span><a name="LN193"></a>    <a href="../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a>  <span class='Declare_Local'>tblspc_map_file</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN194"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>datadirpathlen</span><span class='Delimiter'>; 
</span><a name="LN195"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>tablespaces</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN194"><span class='Ref_To_Local'>datadirpathlen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN72"><span class='Ref_to_Global_Var'>backup_started_in_recovery</span></a> <span class='Operator'>= </span><a href="../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN192"><span class='Ref_To_Local'>labelfile</span></a> <span class='Operator'>= </span><a href="../lib/stringinfo.c.html#LN26"><span class='Ref_to_Func'>makeStringInfo</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="basebackup.c.html#LN193"><span class='Ref_To_Local'>tblspc_map_file</span></a> <span class='Operator'>= </span><a href="../lib/stringinfo.c.html#LN26"><span class='Ref_to_Func'>makeStringInfo</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN188"><span class='Ref_To_Local'>startptr</span></a> <span class='Operator'>= </span><a href="../../include/access/xlog.h.html#LN310"><span class='Ref_to_Proto'>do_pg_start_backup</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN43"><span class='Ref_to_Member'>label</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN45"><span class='Ref_to_Member'>fastcheckpoint</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN189"><span class='Ref_To_Local'>starttli</span></a><span class='Delimiter'>, 
</span>                                  <a href="basebackup.c.html#LN192"><span class='Ref_To_Local'>labelfile</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>tblspcdir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Delimiter'>, 
</span>                                  <a href="basebackup.c.html#LN193"><span class='Ref_To_Local'>tblspc_map_file</span></a><span class='Delimiter'>, 
</span>                                  <a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN44"><span class='Ref_to_Member'>progress</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN49"><span class='Ref_to_Member'>sendtblspcmapfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Once do_pg_start_backup has been called, ensure that any failure causes 
     * us to abort the backup so we don't "leak" a backup counter. For this 
     * reason, *all* functionality between do_pg_start_backup() and 
     * do_pg_stop_backup() should be inside the error cleanup block! 
     */ 
</span> 
    <a href="../../include/storage/ipc.h.html#LN46"><span class='Ref_to_Macro'>PG_ENSURE_ERROR_CLEANUP</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN64"><span class='Ref_to_Proto'>base_backup_cleanup</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN218"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN219"></a>        <a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ti</span><span class='Delimiter'>; 
</span> 
        <a href="basebackup.c.html#LN67"><span class='Ref_to_Proto'>SendXlogRecPtrResult</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN188"><span class='Ref_To_Local'>startptr</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN189"><span class='Ref_To_Local'>starttli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate the relative path of temporary statistics directory in 
         * order to skip the files which are located in that directory later. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="../postmaster/pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            strncmp<span class='Parentheses'>(</span><a href="../postmaster/pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Delimiter'>, </span><a href="../utils/init/globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN194"><span class='Ref_To_Local'>datadirpathlen</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="basebackup.c.html#LN75"><span class='Ref_to_Global_Var'>statrelpath</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"./%s"</span><span class='Delimiter'>, </span><a href="../postmaster/pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a> <span class='Operator'>+ </span><a href="basebackup.c.html#LN194"><span class='Ref_To_Local'>datadirpathlen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="../postmaster/pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Delimiter'>, </span><span class='String'>"./"</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="basebackup.c.html#LN75"><span class='Ref_to_Global_Var'>statrelpath</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"./%s"</span><span class='Delimiter'>, </span><a href="../postmaster/pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="basebackup.c.html#LN75"><span class='Ref_to_Global_Var'>statrelpath</span></a> <span class='Operator'>= </span><a href="../postmaster/pgstat.c.html#LN133"><span class='Ref_to_Global_Var'>pgstat_stat_directory</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Add a node for the base directory at the end */ 
</span>        <a href="basebackup.c.html#LN219"><span class='Ref_To_Local'>ti</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="basebackup.c.html#LN219"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN28"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN44"><span class='Ref_to_Member'>progress</span></a> <span class='Operator'>? </span><a href="basebackup.c.html#LN53"><span class='Ref_to_Proto'>sendDir</span></a><span class='Parentheses'>(</span><span class='String'>"."</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>: -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN219"><span class='Ref_To_Local'>ti</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Send tablespace header */ 
</span>        <a href="basebackup.c.html#LN63"><span class='Ref_to_Proto'>SendBackupHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Setup and activate network throttling, if client requested it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN48"><span class='Ref_to_Member'>maxrate</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>throttling_sample</span></a> <span class='Operator'>= 
</span>                <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN48"><span class='Ref_to_Member'>maxrate</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><span class='Number'>1024</span> <span class='Operator'>/ </span><a href="basebackup.c.html#LN85"><span class='Ref_to_Const'>THROTTLING_FREQUENCY</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The minimum amount of time for throttling_sample bytes to be 
             * transferred. 
             */ 
</span>            <a href="basebackup.c.html#LN94"><span class='Ref_to_Global_Var'>elapsed_min_unit</span></a> <span class='Operator'>= </span><a href="../../include/datatype/timestamp.h.html#LN93"><span class='Ref_to_Const'>USECS_PER_SEC</span></a> <span class='Operator'>/ </span><a href="basebackup.c.html#LN85"><span class='Ref_to_Const'>THROTTLING_FREQUENCY</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Enable throttling. */ 
</span>            <a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* The 'real data' starts now (header was ignored). */ 
</span>            <a href="basebackup.c.html#LN97"><span class='Ref_to_Global_Var'>throttled_last</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Disable throttling. */ 
</span>            <a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Send off our tablespaces one by one */ 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN218"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN270"></a>            <a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ti</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN218"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN271"></a>            <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Send CopyOutResponse message */ 
</span>            <a href="../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN271"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'H'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/pqformat.h.html#LN18"><span class='Ref_to_Proto'>pq_sendbyte</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN271"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* overall format */ 
</span>            <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN271"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* natts */ 
</span>            <a href="../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN271"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN270"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN26"><span class='Ref_to_Member'>path</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN281"></a>                <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* In the main tar, include the backup_label first... */ 
</span>                <a href="basebackup.c.html#LN57"><span class='Ref_to_Proto'>sendFileWithContent</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN320"><span class='Ref_to_Const'>BACKUP_LABEL_FILE</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN192"><span class='Ref_To_Local'>labelfile</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Send tablespace_map file if required and then the bulk of 
                 * the files. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN193"><span class='Ref_To_Local'>tblspc_map_file</span></a> <span class='Operator'>&& </span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN49"><span class='Ref_to_Member'>sendtblspcmapfile</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="basebackup.c.html#LN57"><span class='Ref_to_Proto'>sendFileWithContent</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN323"><span class='Ref_to_Const'>TABLESPACE_MAP</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN193"><span class='Ref_To_Local'>tblspc_map_file</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="basebackup.c.html#LN53"><span class='Ref_to_Proto'>sendDir</span></a><span class='Parentheses'>(</span><span class='String'>"."</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                    <a href="basebackup.c.html#LN53"><span class='Ref_to_Proto'>sendDir</span></a><span class='Parentheses'>(</span><span class='String'>"."</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN195"><span class='Ref_To_Local'>tablespaces</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* ... and pg_control after everything else. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog_internal.h.html#LN131"><span class='Ref_to_Const'>XLOG_CONTROL_FILE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN281"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat control file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                    <a href="../../include/access/xlog_internal.h.html#LN131"><span class='Ref_to_Const'>XLOG_CONTROL_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="basebackup.c.html#LN55"><span class='Ref_to_Proto'>sendFile</span></a><span class='Parentheses'>(</span><a href="../../include/access/xlog_internal.h.html#LN131"><span class='Ref_to_Const'>XLOG_CONTROL_FILE</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlog_internal.h.html#LN131"><span class='Ref_to_Const'>XLOG_CONTROL_FILE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN281"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ti-&GT;path==NULL &raquo; </span> 
            <span class='Control'>else</span> 
                <a href="../../include/replication/basebackup.h.html#LN33"><span class='Ref_to_Proto'>sendTablespace</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN270"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN26"><span class='Ref_to_Member'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we're including WAL, and this is the main data directory we 
             * don't terminate the tar stream here. Instead, we will append 
             * the xlog files below and terminate it then. This is safe since 
             * the main data directory is always sent *last*. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN47"><span class='Ref_to_Member'>includewal</span></a> <span class='Operator'>&& </span><a href="basebackup.c.html#LN270"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN26"><span class='Ref_to_Member'>path</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN218"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../../include/libpq/pqformat.h.html#LN35"><span class='Ref_to_Proto'>pq_putemptymessage</span></a><span class='Parentheses'>(</span><span class='String'>'c'</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* CopyDone */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/ipc.h.html#LN51"><span class='Ref_to_Macro'>PG_END_ENSURE_ERROR_CLEANUP</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN64"><span class='Ref_to_Proto'>base_backup_cleanup</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN190"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>= </span><a href="../../include/access/xlog.h.html#LN314"><span class='Ref_to_Proto'>do_pg_stop_backup</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN192"><span class='Ref_To_Local'>labelfile</span></a><span class='Operator'>-&GT;</span><a href="../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>!</span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN46"><span class='Ref_to_Member'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN191"><span class='Ref_To_Local'>endtli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN186"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN47"><span class='Ref_to_Member'>includewal</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We've left the last tar file "open", so we can now append the 
         * required WAL files to it. 
         */ 
</span><a name="LN333"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>pathbuf</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN334"></a>        <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span><a name="LN335"></a>        <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>startsegno</span><span class='Delimiter'>; 
</span><a name="LN336"></a>        <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>endsegno</span><span class='Delimiter'>; 
</span><a name="LN337"></a>        <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN338"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>historyFileList</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN339"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>walFileList</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN340"></a>        <span class='Keyword'>char</span>      <span class='Operator'>**</span><span class='Declare_Local'>walFiles</span><span class='Delimiter'>; 
</span><a name="LN341"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nWalFiles</span><span class='Delimiter'>; 
</span><a name="LN342"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>firstoff</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span><a name="LN343"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>lastoff</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span><a name="LN344"></a>        <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN345"></a>        <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN346"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN347"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN348"></a>        <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>tli</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * I'd rather not worry about timelines here, so scan pg_wal and 
         * include all WAL files in the range between 'startptr' and 'endptr', 
         * regardless of the timeline the file is stamped with. If there are 
         * some spurious WAL files belonging to timelines that don't belong in 
         * this server's history, they will be included too. Normally there 
         * shouldn't be such files, but if there are, there's little harm in 
         * including them. 
         */ 
</span>        <a href="../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN188"><span class='Ref_To_Local'>startptr</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN335"><span class='Ref_To_Local'>startsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN342"><span class='Ref_To_Local'>firstoff</span></a><span class='Delimiter'>, </span><a href="../access/transam/xlog.c.html#LN178"><span class='Ref_to_Global_Var'>ThisTimeLineID</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN335"><span class='Ref_To_Local'>startsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xlog_internal.h.html#LN108"><span class='Ref_to_Macro'>XLByteToPrevSeg</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN190"><span class='Ref_To_Local'>endptr</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN336"><span class='Ref_To_Local'>endsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN343"><span class='Ref_To_Local'>lastoff</span></a><span class='Delimiter'>, </span><a href="../access/transam/xlog.c.html#LN178"><span class='Ref_to_Global_Var'>ThisTimeLineID</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN336"><span class='Ref_To_Local'>endsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="basebackup.c.html#LN344"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_wal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="basebackup.c.html#LN344"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, </span><span class='String'>"pg_wal"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN344"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_wal"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Does it look like a WAL segment, and is it in the range? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog_internal.h.html#LN150"><span class='Ref_to_Macro'>IsXLogFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN342"><span class='Ref_To_Local'>firstoff</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN343"><span class='Ref_To_Local'>lastoff</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="basebackup.c.html#LN339"><span class='Ref_To_Local'>walFileList</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN339"><span class='Ref_To_Local'>walFileList</span></a><span class='Delimiter'>, </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* Does it look like a timeline history file? */ 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog_internal.h.html#LN180"><span class='Ref_to_Macro'>IsTLHistoryFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="basebackup.c.html#LN338"><span class='Ref_To_Local'>historyFileList</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN338"><span class='Ref_To_Local'>historyFileList</span></a><span class='Delimiter'>, </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN345"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN344"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Before we go any further, check that none of the WAL segments we 
         * need were removed. 
         */ 
</span>        <a href="../../include/access/xlog.h.html#LN231"><span class='Ref_to_Proto'>CheckXLogRemoved</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN335"><span class='Ref_To_Local'>startsegno</span></a><span class='Delimiter'>, </span><a href="../access/transam/xlog.c.html#LN178"><span class='Ref_to_Global_Var'>ThisTimeLineID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Put the WAL filenames into an array, and sort. We send the files in 
         * order from oldest to newest, to reduce the chance that a file is 
         * recycled before we get a chance to send it over. 
         */ 
</span>        <a href="basebackup.c.html#LN341"><span class='Ref_To_Local'>nWalFiles</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN339"><span class='Ref_To_Local'>walFileList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN341"><span class='Ref_To_Local'>nWalFiles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN347"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN339"><span class='Ref_To_Local'>walFileList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN347"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN341"><span class='Ref_To_Local'>nWalFiles</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN68"><span class='Ref_to_Proto'>compareWalFileNames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * There must be at least one xlog file in the pg_wal directory, since 
         * we are doing backup-including-xlog. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN341"><span class='Ref_To_Local'>nWalFiles</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not find any WAL files"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sanity check: the first and last segment should cover startptr and 
         * endptr, with no gaps in between. 
         */ 
</span>        <a href="../../include/access/xlog_internal.h.html#LN164"><span class='Ref_to_Macro'>XLogFromFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>!= </span><a href="basebackup.c.html#LN335"><span class='Ref_To_Local'>startsegno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN420"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>startfname</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
            <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN420"><span class='Ref_To_Local'>startfname</span></a><span class='Delimiter'>, </span><a href="../access/transam/xlog.c.html#LN178"><span class='Ref_to_Global_Var'>ThisTimeLineID</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN335"><span class='Ref_To_Local'>startsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not find WAL file \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN420"><span class='Ref_To_Local'>startfname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="basebackup.c.html#LN341"><span class='Ref_To_Local'>nWalFiles</span></a><span class='Delimiter'>; </span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN428"></a>            <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>currsegno</span> <span class='Operator'>= </span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>; 
</span><a name="LN429"></a>            <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>nextsegno</span> <span class='Operator'>= </span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/access/xlog_internal.h.html#LN164"><span class='Ref_to_Macro'>XLogFromFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN429"><span class='Ref_To_Local'>nextsegno</span></a> <span class='Operator'>== </span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>|| </span><a href="basebackup.c.html#LN428"><span class='Ref_To_Local'>currsegno</span></a> <span class='Operator'>== </span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN434"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>nextfname</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
                <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN434"><span class='Ref_To_Local'>nextfname</span></a><span class='Delimiter'>, </span><a href="../access/transam/xlog.c.html#LN178"><span class='Ref_to_Global_Var'>ThisTimeLineID</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN429"><span class='Ref_To_Local'>nextsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                      <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not find WAL file \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN434"><span class='Ref_To_Local'>nextfname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>!= </span><a href="basebackup.c.html#LN336"><span class='Ref_To_Local'>endsegno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN443"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>endfname</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span> 
            <a href="../../include/access/xlog_internal.h.html#LN142"><span class='Ref_to_Macro'>XLogFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN443"><span class='Ref_To_Local'>endfname</span></a><span class='Delimiter'>, </span><a href="../access/transam/xlog.c.html#LN178"><span class='Ref_to_Global_Var'>ThisTimeLineID</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN336"><span class='Ref_To_Local'>endsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not find WAL file \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN443"><span class='Ref_To_Local'>endfname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Ok, we have everything we need. Send the WAL files. */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="basebackup.c.html#LN341"><span class='Ref_To_Local'>nWalFiles</span></a><span class='Delimiter'>; </span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN453"></a>            FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span><a name="LN454"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="basebackup.c.html#LN80"><span class='Ref_to_Const'>TAR_SEND_SIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN455"></a>            size_t      <span class='Declare_Local'>cnt</span><span class='Delimiter'>; 
</span><a name="LN456"></a>            <a href="../../include/port/win32.h.html#LN230"><span class='Ref_to_Const'>pgoff_t</span></a>     <span class='Declare_Local'>len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlog_internal.h.html#LN130"><span class='Ref_to_Const'>XLOGDIR</span></a> <span class='String'>"/%s"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/xlog_internal.h.html#LN164"><span class='Ref_to_Macro'>XLogFromFileName</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN453"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='String'>"rb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN453"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Most likely reason for this is that the file was already 
                 * removed by a checkpoint, so check for that to get a better 
                 * error message. 
                 */ 
</span>                <a href="../../include/access/xlog.h.html#LN231"><span class='Ref_to_Proto'>CheckXLogRemoved</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>fstat<span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span><a href="basebackup.c.html#LN453"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN337"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN337"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>!= </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/access/xlog.h.html#LN231"><span class='Ref_to_Proto'>CheckXLogRemoved</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                    <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected WAL file size \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* send the WAL file itself */ 
</span>            <a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN337"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="basebackup.c.html#LN455"><span class='Ref_To_Local'>cnt</span></a> <span class='Operator'>= </span>fread<span class='Parentheses'>(</span><a href="basebackup.c.html#LN454"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN454"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a> <span class='Operator'>- </span><a href="basebackup.c.html#LN456"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN453"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/access/xlog.h.html#LN231"><span class='Ref_to_Proto'>CheckXLogRemoved</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Send the chunk as a CopyData message */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN454"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN455"><span class='Ref_To_Local'>cnt</span></a><span class='Parentheses'>))</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"base backup could not send data, aborting backup"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
                <a href="basebackup.c.html#LN456"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN455"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; 
</span>                <a href="basebackup.c.html#LN69"><span class='Ref_to_Proto'>throttle</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN455"><span class='Ref_To_Local'>cnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN456"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN456"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>!= </span><a href="../../include/access/xlog_internal.h.html#LN91"><span class='Ref_to_Const'>XLogSegSize</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/access/xlog.h.html#LN231"><span class='Ref_to_Proto'>CheckXLogRemoved</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN334"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN348"><span class='Ref_To_Local'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                    <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected WAL file size \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* XLogSegSize is a multiple of 512, so no need for padding */ 
</span> 
            <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN453"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Mark file as archived, otherwise files can get archived again 
             * after promotion of a new node. This is in line with 
             * walreceiver.c always doing an XLogArchiveForceDone() after a 
             * complete segment. 
             */ 
</span>            <a href="../../include/access/xlog_internal.h.html#LN188"><span class='Ref_to_Macro'>StatusFilePath</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN340"><span class='Ref_To_Local'>walFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN346"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>".done"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN57"><span class='Ref_to_Proto'>sendFileWithContent</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nWalFiles;i++ &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Send timeline history files too. Only the latest timeline history 
         * file is required for recovery, and even that only if there happens 
         * to be a timeline switch in the first WAL segment that contains the 
         * checkpoint record, or if we're taking a base backup from a standby 
         * server and the target timeline changes while the backup is taken. 
         * But they are small and highly useful for debugging purposes, so 
         * better include them all, always. 
         */ 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN347"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN338"><span class='Ref_To_Local'>historyFileList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN540"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fname</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN347"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><a href="../../include/access/xlog_internal.h.html#LN130"><span class='Ref_to_Const'>XLOGDIR</span></a> <span class='String'>"/%s"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN540"><span class='Ref_To_Local'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN337"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN55"><span class='Ref_to_Proto'>sendFile</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN337"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* unconditionally mark file as archived */ 
</span>            <a href="../../include/access/xlog_internal.h.html#LN188"><span class='Ref_to_Macro'>StatusFilePath</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN540"><span class='Ref_To_Local'>fname</span></a><span class='Delimiter'>, </span><span class='String'>".done"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN57"><span class='Ref_to_Proto'>sendFileWithContent</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN333"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Send CopyDone message for the last tar file */ 
</span>        <a href="../../include/libpq/pqformat.h.html#LN35"><span class='Ref_to_Proto'>pq_putemptymessage</span></a><span class='Parentheses'>(</span><span class='String'>'c'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if opt-&GT;includewal &raquo; </span> 
    <a href="basebackup.c.html#LN67"><span class='Ref_to_Proto'>SendXlogRecPtrResult</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN190"><span class='Ref_To_Local'>endptr</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN191"><span class='Ref_To_Local'>endtli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end perform_base_backup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * qsort comparison function, to compare log/seg portion of WAL segment 
 * filenames, ignoring the timeline portion. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN567"></a><span class='Declare_Function'>compareWalFileNames</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN569"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fna</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="basebackup.c.html#LN567"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN570"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fnb</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Parentheses'>) </span><a href="basebackup.c.html#LN567"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN569"><span class='Ref_To_Local'>fna</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN570"><span class='Ref_To_Local'>fnb</span></a> <span class='Operator'>+ </span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Parse the base backup options passed down by the parser 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN579"></a><span class='Declare_Function'>parse_basebackup_options</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN41"><span class='Ref_to_Typedef'>basebackup_options</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>opt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN581"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lopt</span><span class='Delimiter'>; 
</span><a name="LN582"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_label</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN583"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_progress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN584"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_fast</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN585"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_nowait</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN586"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_wal</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN587"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_maxrate</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN588"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>o_tablespace_map</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN581"><span class='Ref_To_Local'>lopt</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>options</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN593"></a>        <a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>defel</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN715"><span class='Ref_to_Struct'>DefElem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN581"><span class='Ref_To_Local'>lopt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"label"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN582"><span class='Ref_To_Local'>o_label</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN43"><span class='Ref_to_Member'>label</span></a> <span class='Operator'>= </span><a href="../../include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN582"><span class='Ref_To_Local'>o_label</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"progress"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN583"><span class='Ref_To_Local'>o_progress</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN44"><span class='Ref_to_Member'>progress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN583"><span class='Ref_To_Local'>o_progress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"fast"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN584"><span class='Ref_To_Local'>o_fast</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN45"><span class='Ref_to_Member'>fastcheckpoint</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN584"><span class='Ref_To_Local'>o_fast</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"nowait"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN585"><span class='Ref_To_Local'>o_nowait</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN46"><span class='Ref_to_Member'>nowait</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN585"><span class='Ref_To_Local'>o_nowait</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"wal"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN586"><span class='Ref_To_Local'>o_wal</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN47"><span class='Ref_to_Member'>includewal</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN586"><span class='Ref_To_Local'>o_wal</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"max_rate"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN642"></a>            <span class='Keyword'>long</span>        <span class='Declare_Local'>maxrate</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN587"><span class='Ref_To_Local'>o_maxrate</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN642"><span class='Ref_To_Local'>maxrate</span></a> <span class='Operator'>= </span><a href="../../include/nodes/value.h.html#LN51"><span class='Ref_to_Macro'>intVal</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN720"><span class='Ref_to_Member'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN642"><span class='Ref_To_Local'>maxrate</span></a> <span class='Operator'>&LT; </span><a href="../../include/replication/basebackup.h.html#LN19"><span class='Ref_to_Const'>MAX_RATE_LOWER</span></a> <span class='Operator'>|| </span><a href="basebackup.c.html#LN642"><span class='Ref_To_Local'>maxrate</span></a> <span class='Operator'>&GT; </span><a href="../../include/replication/basebackup.h.html#LN20"><span class='Ref_to_Const'>MAX_RATE_UPPER</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"%d is outside the valid range for parameter \"%s\" (%d .. %d)"</span><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="basebackup.c.html#LN642"><span class='Ref_To_Local'>maxrate</span></a><span class='Delimiter'>, </span><span class='String'>"MAX_RATE"</span><span class='Delimiter'>, </span><a href="../../include/replication/basebackup.h.html#LN19"><span class='Ref_to_Const'>MAX_RATE_LOWER</span></a><span class='Delimiter'>, </span><a href="../../include/replication/basebackup.h.html#LN20"><span class='Ref_to_Const'>MAX_RATE_UPPER</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN48"><span class='Ref_to_Member'>maxrate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="basebackup.c.html#LN642"><span class='Ref_To_Local'>maxrate</span></a><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN587"><span class='Ref_To_Local'>o_maxrate</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Delimiter'>, </span><span class='String'>"tablespace_map"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN588"><span class='Ref_To_Local'>o_tablespace_map</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"duplicate option \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN49"><span class='Ref_to_Member'>sendtblspcmapfile</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN588"><span class='Ref_To_Local'>o_tablespace_map</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"option \"%s\" not recognized"</span><span class='Delimiter'>, 
</span>                 <a href="basebackup.c.html#LN593"><span class='Ref_To_Local'>defel</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN719"><span class='Ref_to_Member'>defname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN43"><span class='Ref_to_Member'>label</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="basebackup.c.html#LN579"><span class='Ref_to_Parameter'>opt</span></a><span class='Operator'>-&GT;</span><a href="basebackup.c.html#LN43"><span class='Ref_to_Member'>label</span></a> <span class='Operator'>= </span><span class='String'>"base backup"</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parse_basebackup_options &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * SendBaseBackup() - send a complete base backup. 
 * 
 * The function will put the system into backup mode like pg_start_backup() 
 * does, so that the backup is consistent even though we read directly from 
 * the filesystem, bypassing the buffer cache. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN685"></a><span class='Declare_Function'>SendBaseBackup</span><span class='Parentheses'>(</span><a href="../../include/nodes/replnodes.h.html#LN40"><span class='Ref_to_Struct'>BaseBackupCmd</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN687"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN688"></a>    <a href="basebackup.c.html#LN41"><span class='Ref_to_Typedef'>basebackup_options</span></a> <span class='Declare_Local'>opt</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN66"><span class='Ref_to_Proto'>parse_basebackup_options</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN685"><span class='Ref_to_Parameter'>cmd</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/replnodes.h.html#LN43"><span class='Ref_to_Member'>options</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN688"><span class='Ref_To_Local'>opt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/replication/walsender_private.h.html#LN102"><span class='Ref_to_Proto'>WalSndSetState</span></a><span class='Parentheses'>(</span><a href="../../include/replication/walsender_private.h.html#LN24"><span class='Ref_to_EnumConst'>WALSNDSTATE_BACKUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../utils/misc/ps_status.c.html#LN34"><span class='Ref_to_Global_Var'>update_process_title</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN696"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>activitymsg</span><span class='Delimiter'>[</span><span class='Number'>50</span><span class='Delimiter'>]; 
</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN696"><span class='Ref_To_Local'>activitymsg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN696"><span class='Ref_To_Local'>activitymsg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"sending backup \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="basebackup.c.html#LN688"><span class='Ref_To_Local'>opt</span></a><span class='Operator'>.</span><a href="basebackup.c.html#LN43"><span class='Ref_to_Member'>label</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/ps_status.h.html#LN21"><span class='Ref_to_Proto'>set_ps_display</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN696"><span class='Ref_To_Local'>activitymsg</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we can open the directory with tablespaces in it */ 
</span>    <a href="basebackup.c.html#LN687"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="basebackup.c.html#LN687"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, </span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN65"><span class='Ref_to_Proto'>perform_base_backup</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN688"><span class='Ref_To_Local'>opt</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN687"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN687"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SendBaseBackup &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN715"></a><span class='Declare_Function'>send_int8_string</span><span class='Parentheses'>(</span><a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Parameter'>intval</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN717"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>is</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN717"><span class='Ref_To_Local'>is</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN715"><span class='Ref_to_Parameter'>intval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN715"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="basebackup.c.html#LN717"><span class='Ref_To_Local'>is</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN19"><span class='Ref_to_Proto'>pq_sendbytes</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN715"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN717"><span class='Ref_To_Local'>is</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="basebackup.c.html#LN717"><span class='Ref_To_Local'>is</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN725"></a><span class='Declare_Function'>SendBackupHeader</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tablespaces</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN727"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN728"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Construct and send the directory information */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'T'</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* RowDescription */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* 3 fields */ 
</span> 
    <span class='Comment_Multi_Line'>/* First field - spcoid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN23"><span class='Ref_to_Proto'>pq_sendstring</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"spcoid"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* table oid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* attnum */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* type oid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* typlen */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* typmod */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* format code */ 
</span> 
    <span class='Comment_Multi_Line'>/* Second field - spcpath */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN23"><span class='Ref_to_Proto'>pq_sendstring</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"spclocation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Third field - size */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN23"><span class='Ref_to_Proto'>pq_sendstring</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"size"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN21"><span class='Ref_to_Const'>INT8OID</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN728"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN725"><span class='Ref_to_Parameter'>tablespaces</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN764"></a>        <a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ti</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN728"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Send one datarow message */ 
</span>        <a href="../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* number of columns */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN26"><span class='Ref_to_Member'>path</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* Length = -1 ==&GT; NULL */ 
</span>            <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN776"></a>            <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN776"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN25"><span class='Ref_to_Member'>oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN776"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/pqformat.h.html#LN19"><span class='Ref_to_Proto'>pq_sendbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN25"><span class='Ref_to_Member'>oid</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN776"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN776"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN26"><span class='Ref_to_Member'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN776"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/pqformat.h.html#LN19"><span class='Ref_to_Proto'>pq_sendbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN26"><span class='Ref_to_Member'>path</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN776"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN28"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="basebackup.c.html#LN62"><span class='Ref_to_Proto'>send_int8_string</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN764"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN28"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>/ </span><span class='Number'>1024</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* NULL */ 
</span> 
        <a href="../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN727"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Send a CommandComplete message */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN34"><span class='Ref_to_Proto'>pq_puttextmessage</span></a><span class='Parentheses'>(</span><span class='String'>'C'</span><span class='Delimiter'>, </span><span class='String'>"SELECT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SendBackupHeader &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a single resultset containing just a single 
 * XLogRecPtr record (in text format) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN803"></a><span class='Declare_Function'>SendXlogRecPtrResult</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span><a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Declare_Parameter'>tli</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN805"></a>    <a href="../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN806"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>str</span><span class='Delimiter'>[</span><a href="../../include/access/xlog_internal.h.html#LN137"><span class='Ref_to_Const'>MAXFNAMELEN</span></a><span class='Delimiter'>]; 
</span><a name="LN807"></a>    <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'T'</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* RowDescription */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* 2 fields */ 
</span> 
    <span class='Comment_Multi_Line'>/* Field headers */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN23"><span class='Ref_to_Proto'>pq_sendstring</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"recptr"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* table oid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* attnum */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* type oid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqformat.h.html#LN23"><span class='Ref_to_Proto'>pq_sendstring</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"tli"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* table oid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* attnum */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * int8 may seem like a surprising data type for this, but in theory int4 
     * would not be wide enough for this, as TimeLineID is unsigned. 
     */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN21"><span class='Ref_to_Const'>INT8OID</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* type oid */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Data row */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN17"><span class='Ref_to_Proto'>pq_beginmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* number of columns */ 
</span> 
    <a href="basebackup.c.html#LN807"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN806"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN806"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <span class='String'>"%X/%X"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="basebackup.c.html#LN803"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="basebackup.c.html#LN803"><span class='Ref_to_Parameter'>ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN807"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN19"><span class='Ref_to_Proto'>pq_sendbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN806"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN807"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN807"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN806"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN806"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%u"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN803"><span class='Ref_to_Parameter'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN807"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/libpq/pqformat.h.html#LN19"><span class='Ref_to_Proto'>pq_sendbytes</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN806"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN807"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/libpq/pqformat.h.html#LN29"><span class='Ref_to_Proto'>pq_endmessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="basebackup.c.html#LN805"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Send a CommandComplete message */ 
</span>    <a href="../../include/libpq/pqformat.h.html#LN34"><span class='Ref_to_Proto'>pq_puttextmessage</span></a><span class='Parentheses'>(</span><span class='String'>'C'</span><span class='Delimiter'>, </span><span class='String'>"SELECT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SendXlogRecPtrResult &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Inject a file with given name and content in the output tar stream. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN858"></a><span class='Declare_Function'>sendFileWithContent</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>content</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN860"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN861"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pad</span><span class='Delimiter'>, 
</span><a name="LN862"></a>                <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN862"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="basebackup.c.html#LN858"><span class='Ref_to_Parameter'>content</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Construct a stat struct for the backup_label file we're injecting in 
     * the tar. 
     */ 
</span>    <span class='Comment_Multi_Line'>/* Windows doesn't have the concept of uid and gid */ 
</span><span class='Directive'>#ifdef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_gid <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_uid <span class='Operator'>= </span>geteuid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_gid <span class='Operator'>= </span>getegid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mtime <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Delimiter'>; 
</span>    <a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>= </span><a href="basebackup.c.html#LN862"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN858"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN860"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Send the contents as a CopyData message */ 
</span>    <a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN858"><span class='Ref_to_Parameter'>content</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN862"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Pad to 512 byte boundary, per tar format requirements */ 
</span>    <a href="basebackup.c.html#LN861"><span class='Ref_To_Local'>pad</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="basebackup.c.html#LN862"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="basebackup.c.html#LN862"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN861"><span class='Ref_To_Local'>pad</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN890"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>512</span><span class='Delimiter'>]; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN890"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN861"><span class='Ref_To_Local'>pad</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN890"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN861"><span class='Ref_To_Local'>pad</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end sendFileWithContent &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Include the tablespace directory pointed to by 'path' in the output tar 
 * stream.  If 'sizeonly' is true, we just calculate a total length and return 
 * it, without actually sending anything. 
 * 
 * Only used to send auxiliary tablespaces, not PGDATA. 
 */ 
</span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN905"></a><span class='Declare_Function'>sendTablespace</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN907"></a>    <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN908"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pathbuf</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN909"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * 'path' points to the tablespace location, but we only want to include 
     * the version directory in it that belongs to us. 
     */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN908"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN908"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN905"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, 
</span>             <a href="../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Store a directory entry in the tar file so we get the permissions 
     * right. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN908"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN909"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file or directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="basebackup.c.html#LN908"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If the tablespace went away while scanning, it's no error. */ 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="basebackup.c.html#LN907"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN909"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, 
</span>                           <a href="basebackup.c.html#LN905"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Send all the files in the tablespace version directory */ 
</span>    <a href="basebackup.c.html#LN907"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN53"><span class='Ref_to_Proto'>sendDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN908"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="basebackup.c.html#LN905"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN905"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="basebackup.c.html#LN907"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sendTablespace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Include all files from the given directory in the output tar stream. If 
 * 'sizeonly' is true, we just calculate a total length and return it, without 
 * actually sending anything. 
 * 
 * Omit any directory in the tablespaces list, to avoid backing up 
 * tablespaces twice when they were created inside PGDATA. 
 * 
 * If sendtblspclinks is true, we need to include symlink 
 * information in the tar file. If not, we can skip that 
 * as it will be sent separately in the tablespace_map file. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN956"></a><span class='Declare_Function'>sendDir</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>basepathlen</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tablespaces</span><span class='Delimiter'>, 
</span><a name="LN957"></a>        <span class='Keyword'>bool </span><span class='Declare_Parameter'>sendtblspclinks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN959"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN960"></a>    <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN961"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pathbuf</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN962"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN963"></a>    <a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN959"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN959"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN968"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>excludeIdx</span><span class='Delimiter'>; 
</span><a name="LN969"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>excludeFound</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip special stuff */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip temporary files */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/storage/fd.h.html#LN127"><span class='Ref_to_Const'>PG_TEMP_FILE_PREFIX</span></a><span class='Delimiter'>, 
</span>                    strlen<span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN127"><span class='Ref_to_Const'>PG_TEMP_FILE_PREFIX</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check if the postmaster has signaled us to exit, and abort with an 
         * error in that case. The error handler further up will call 
         * do_pg_abort_backup() for us. Also check that if the backup was 
         * started while still in recovery, the server wasn't promoted. 
         * dp_pg_stop_backup() will check that too, but it's better to stop 
         * the backup early than continue to the end and fail there. 
         */ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="basebackup.c.html#LN72"><span class='Ref_to_Global_Var'>backup_started_in_recovery</span></a><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"the standby was promoted during online backup"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"This means that the backup being taken is corrupt "</span> 
                         <span class='String'>"and should not be used. "</span> 
                         <span class='String'>"Try taking another online backup."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan for files that should be excluded */ 
</span>        <a href="basebackup.c.html#LN969"><span class='Ref_To_Local'>excludeFound</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="basebackup.c.html#LN145"><span class='Ref_to_Global_Var'>excludeFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN145"><span class='Ref_to_Global_Var'>excludeFiles</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"file \"%s\" excluded from backup"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="basebackup.c.html#LN969"><span class='Ref_To_Local'>excludeFound</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN969"><span class='Ref_To_Local'>excludeFound</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip pg_control here to back up it last */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='String'>"./global/pg_control"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file or directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If the file went away while scanning, it's not an error. */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Scan for directories whose contents should be excluded */ 
</span>        <a href="basebackup.c.html#LN969"><span class='Ref_To_Local'>excludeFound</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>excludeDirContents</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>excludeDirContents</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN968"><span class='Ref_To_Local'>excludeIdx</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"contents of directory \"%s\" excluded from backup"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN960"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN60"><span class='Ref_to_Proto'>_tarWriteDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="basebackup.c.html#LN969"><span class='Ref_To_Local'>excludeFound</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN969"><span class='Ref_To_Local'>excludeFound</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Exclude contents of directory specified by statrelpath if not set 
         * to the default (pg_stat_tmp) which is caught in the loop above. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN75"><span class='Ref_to_Global_Var'>statrelpath</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN75"><span class='Ref_to_Global_Var'>statrelpath</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"contents of directory \"%s\" excluded from backup"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN75"><span class='Ref_to_Global_Var'>statrelpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN60"><span class='Ref_to_Proto'>_tarWriteDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can skip pg_wal, the WAL segments need to be fetched from the 
         * WAL archive anyway. But include it as an empty directory anyway, so 
         * we get permissions right. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='String'>"./pg_wal"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* If pg_wal is a symlink, write it as a directory anyway */ 
</span>            <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN60"><span class='Ref_to_Proto'>_tarWriteDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Also send archive_status directory (by hackishly reusing 
             * statbuf from above ...). 
             */ 
</span>            <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><span class='String'>"./pg_wal/archive_status"</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, 
</span>                                    <a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* don't recurse into pg_wal */ 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Allow symbolic links in pg_tblspc only */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><span class='String'>"./pg_tblspc"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            S_ISLNK<span class='Parentheses'>(</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
            <a href="../../include/port.h.html#LN253"><span class='Ref_to_Proto'>pgwin32_is_junction</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
            <span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>HAVE_READLINK<span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) 
</span><a name="LN1088"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>linkpath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1089"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>rllen</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN1089"><span class='Ref_To_Local'>rllen</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN256"><span class='Ref_to_Macro'>readlink</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1088"><span class='Ref_To_Local'>linkpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1088"><span class='Ref_To_Local'>linkpath</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1089"><span class='Ref_To_Local'>rllen</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read symbolic link \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1089"><span class='Ref_To_Local'>rllen</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1088"><span class='Ref_To_Local'>linkpath</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"symbolic link \"%s\" target is too long"</span><span class='Delimiter'>, 
</span>                                <a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN1088"><span class='Ref_To_Local'>linkpath</span></a><span class='Delimiter'>[</span><a href="basebackup.c.html#LN1089"><span class='Ref_To_Local'>rllen</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
            <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a> <span class='Operator'>+ </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1088"><span class='Ref_To_Local'>linkpath</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
            <span class='Comment_Multi_Line'>/* 
             * If the platform does not have symbolic links, it should not be 
             * possible to have tablespaces - clearly somebody else created 
             * them. Warn about it and ignore. 
             */ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"tablespaces are not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_READLINK */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(path,"./pg_tbl... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1121"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>skip_this_dir</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1122"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Store a directory entry in the tar file so we can get the 
             * permissions right. 
             */ 
</span>            <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a> <span class='Operator'>+ </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, 
</span>                                    <a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Call ourselves recursively for a directory, unless it happens 
             * to be a separate tablespace located within PGDATA. 
             */ 
</span>            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1122"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>tablespaces</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1137"></a>                <a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ti</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/replication/basebackup.h.html#LN23"><span class='Ref_to_Typedef'>tablespaceinfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1122"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * ti-&GT;rpath is the tablespace relative path within PGDATA, or 
                 * NULL if the tablespace has been properly located somewhere 
                 * else. 
                 * 
                 * Skip past the leading "./" in pathbuf when comparing. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1137"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN27"><span class='Ref_to_Member'>rpath</span></a> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN1137"><span class='Ref_To_Local'>ti</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/basebackup.h.html#LN27"><span class='Ref_to_Member'>rpath</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="basebackup.c.html#LN1121"><span class='Ref_To_Local'>skip_this_dir</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * skip sending directories inside pg_tblspc, if not required. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><span class='String'>"./pg_tblspc"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="basebackup.c.html#LN957"><span class='Ref_to_Parameter'>sendtblspclinks</span></a><span class='Parentheses'>)</span> 
                <a href="basebackup.c.html#LN1121"><span class='Ref_To_Local'>skip_this_dir</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="basebackup.c.html#LN1121"><span class='Ref_To_Local'>skip_this_dir</span></a><span class='Parentheses'>) 
</span>                <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN53"><span class='Ref_to_Proto'>sendDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>tablespaces</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN957"><span class='Ref_to_Parameter'>sendtblspclinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if S_ISDIR(statbuf.st_mo... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1164"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>sent</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>) 
</span>                <a href="basebackup.c.html#LN1164"><span class='Ref_To_Local'>sent</span></a> <span class='Operator'>= </span><a href="basebackup.c.html#LN55"><span class='Ref_to_Proto'>sendFile</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a> <span class='Operator'>+ </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>basepathlen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1164"><span class='Ref_To_Local'>sent</span></a> <span class='Operator'>|| </span><a href="basebackup.c.html#LN956"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Add size, rounded up to 512byte block */ 
</span>                <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><span class='Parentheses'>((</span><a href="basebackup.c.html#LN962"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><span class='Number'>512</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* Size of the header of the file */ 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"skipping special file \"%s\""</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN961"><span class='Ref_To_Local'>pathbuf</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDir(dir,path)... &raquo; </span> 
    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN959"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="basebackup.c.html#LN963"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sendDir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/***** 
 * Functions for handling tar file format 
 * 
 * Copied from pg_dump, but modified to work with libpq for sending 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given the member, write the TAR header & send the file. 
 * 
 * If 'missing_ok' is true, will not throw an error if the file is not found. 
 * 
 * Returns true if the file was successfully sent, false if 'missing_ok', 
 * and the file did not exist. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1201"></a><span class='Declare_Function'>sendFile</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>readfilename</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tarfilename</span><span class='Delimiter'>, </span><span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>statbuf</span><span class='Delimiter'>, 
</span><a name="LN1202"></a>         <span class='Keyword'>bool </span><span class='Declare_Parameter'>missing_ok</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1204"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>fp</span><span class='Delimiter'>; 
</span><a name="LN1205"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="basebackup.c.html#LN80"><span class='Ref_to_Const'>TAR_SEND_SIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN1206"></a>    size_t      <span class='Declare_Local'>cnt</span><span class='Delimiter'>; 
</span><a name="LN1207"></a>    <a href="../../include/port/win32.h.html#LN230"><span class='Ref_to_Const'>pgoff_t</span></a>     <span class='Declare_Local'>len</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1208"></a>    size_t      <span class='Declare_Local'>pad</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN1204"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>readfilename</span></a><span class='Delimiter'>, </span><span class='String'>"rb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1204"><span class='Ref_To_Local'>fp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT <span class='Operator'>&& </span><a href="basebackup.c.html#LN1202"><span class='Ref_to_Parameter'>missing_ok</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>readfilename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>tarfilename</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a> <span class='Operator'>= </span>fread<span class='Parentheses'>(</span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_size <span class='Operator'>- </span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1204"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Send the chunk as a CopyData message */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a><span class='Parentheses'>))</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"base backup could not send data, aborting backup"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; 
</span>        <a href="basebackup.c.html#LN69"><span class='Ref_to_Proto'>throttle</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_size<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Reached end of file. The file could be longer, if it was 
             * extended while we were sending it, but for a base backup we can 
             * ignore such extended data. It will be restored from WAL. 
             */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (cnt=fread(buf,1,Min(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* If the file was truncated while we were sending it, pad it with zeros */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_size<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_size<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a> <span class='Operator'>= </span><a href="../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1201"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_size <span class='Operator'>- </span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a><span class='Delimiter'>; 
</span>            <a href="basebackup.c.html#LN69"><span class='Ref_to_Proto'>throttle</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1206"><span class='Ref_To_Local'>cnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Pad to 512 byte boundary, per tar format requirements. (This small 
     * piece of data is probably not worth throttling.) 
     */ 
</span>    <a href="basebackup.c.html#LN1208"><span class='Ref_To_Local'>pad</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="basebackup.c.html#LN1207"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1208"><span class='Ref_To_Local'>pad</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1208"><span class='Ref_To_Local'>pad</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1205"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1208"><span class='Ref_To_Local'>pad</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1204"><span class='Ref_To_Local'>fp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sendFile &raquo; </span> 
 
 
<span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN1274"></a><span class='Declare_Function'>_tarWriteHeader</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>linktarget</span><span class='Delimiter'>, 
</span><a name="LN1275"></a>                <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>statbuf</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1277"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>h</span><span class='Delimiter'>[</span><span class='Number'>512</span><span class='Delimiter'>]; 
</span><a name="LN1278"></a>    <span class='Control'>enum</span> <a href="../../include/pgtar.h.html#LN14"><span class='Ref_to_Enum'>tarError</span></a> <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="basebackup.c.html#LN1275"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="basebackup.c.html#LN1278"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/pgtar.h.html#LN21"><span class='Ref_to_Proto'>tarCreateHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1277"><span class='Ref_To_Local'>h</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1274"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1274"><span class='Ref_to_Parameter'>linktarget</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1275"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_size<span class='Delimiter'>, 
</span>                          <a href="basebackup.c.html#LN1275"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_mode<span class='Delimiter'>, </span><a href="basebackup.c.html#LN1275"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_uid<span class='Delimiter'>, </span><a href="basebackup.c.html#LN1275"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_gid<span class='Delimiter'>, 
</span>                             <a href="basebackup.c.html#LN1275"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_mtime<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1278"><span class='Ref_To_Local'>rc</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/pgtar.h.html#LN16"><span class='Ref_to_EnumConst'>TAR_OK</span></a><span class='Operator'>: 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/pgtar.h.html#LN17"><span class='Ref_to_EnumConst'>TAR_NAME_TOO_LONG</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"file name too long for tar format: \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="basebackup.c.html#LN1274"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/pgtar.h.html#LN18"><span class='Ref_to_EnumConst'>TAR_SYMLINK_TOO_LONG</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"symbolic link target too long for tar format: "</span> 
                             <span class='String'>"file name \"%s\", target \"%s\""</span><span class='Delimiter'>, 
</span>                             <a href="basebackup.c.html#LN1274"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1274"><span class='Ref_to_Parameter'>linktarget</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized tar error: %d"</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1278"><span class='Ref_To_Local'>rc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/libpq/libpq.h.html#LN41"><span class='Ref_to_Macro'>pq_putmessage</span></a><span class='Parentheses'>(</span><span class='String'>'d'</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1277"><span class='Ref_To_Local'>h</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1277"><span class='Ref_To_Local'>h</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !sizeonly &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1277"><span class='Ref_To_Local'>h</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _tarWriteHeader &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write tar header for a directory.  If the entry in statbuf is a link then 
 * write it as a directory anyway. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN1316"></a><span class='Declare_Function'>_tarWriteDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>pathbuf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>basepathlen</span><span class='Delimiter'>, </span><span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>statbuf</span><span class='Delimiter'>, 
</span><a name="LN1317"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>sizeonly</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* If symlink, write it as a directory anyway */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>S_ISLNK<span class='Parentheses'>(</span><a href="basebackup.c.html#LN1316"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_mode<span class='Parentheses'>))</span> 
<span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN253"><span class='Ref_to_Proto'>pgwin32_is_junction</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1316"><span class='Ref_to_Parameter'>pathbuf</span></a><span class='Parentheses'>))</span> 
<span class='Directive'>#endif</span> 
        <a href="basebackup.c.html#LN1316"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Operator'>-&GT;</span>st_mode <span class='Operator'>= </span>S_IFDIR <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="basebackup.c.html#LN58"><span class='Ref_to_Proto'>_tarWriteHeader</span></a><span class='Parentheses'>(</span><a href="basebackup.c.html#LN1316"><span class='Ref_to_Parameter'>pathbuf</span></a> <span class='Operator'>+ </span><a href="basebackup.c.html#LN1316"><span class='Ref_to_Parameter'>basepathlen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1316"><span class='Ref_to_Parameter'>statbuf</span></a><span class='Delimiter'>, </span><a href="basebackup.c.html#LN1317"><span class='Ref_to_Parameter'>sizeonly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Increment the network transfer counter by the given number of bytes, 
 * and sleep if necessary to comply with the requested network transfer 
 * rate. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1336"></a><span class='Declare_Function'>throttle</span><span class='Parentheses'>(</span>size_t <span class='Declare_Parameter'>increment</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1338"></a>    <a href="../../include/datatype/timestamp.h.html#LN39"><span class='Ref_to_Typedef'>TimeOffset</span></a>  <span class='Declare_Local'>elapsed</span><span class='Delimiter'>, 
</span><a name="LN1339"></a>                <span class='Declare_Local'>elapsed_min</span><span class='Delimiter'>, 
</span><a name="LN1340"></a>                <span class='Declare_Local'>sleep</span><span class='Delimiter'>; 
</span><a name="LN1341"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>wait_result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>+= </span><a href="basebackup.c.html#LN1336"><span class='Ref_to_Parameter'>increment</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>&LT; </span><a href="basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>throttling_sample</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Time elapsed since the last measurement (and possible wake up). */ 
</span>    <a href="basebackup.c.html#LN1338"><span class='Ref_To_Local'>elapsed</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>() </span><span class='Operator'>- </span><a href="basebackup.c.html#LN97"><span class='Ref_to_Global_Var'>throttled_last</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* How much should have elapsed at minimum? */ 
</span>    <a href="basebackup.c.html#LN1339"><span class='Ref_To_Local'>elapsed_min</span></a> <span class='Operator'>= </span><a href="basebackup.c.html#LN94"><span class='Ref_to_Global_Var'>elapsed_min_unit</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>/ </span><a href="basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>throttling_sample</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="basebackup.c.html#LN1340"><span class='Ref_To_Local'>sleep</span></a> <span class='Operator'>= </span><a href="basebackup.c.html#LN1339"><span class='Ref_To_Local'>elapsed_min</span></a> <span class='Operator'>- </span><a href="basebackup.c.html#LN1338"><span class='Ref_To_Local'>elapsed</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Only sleep if the transfer is faster than it should be. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1340"><span class='Ref_To_Local'>sleep</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We're eating a potentially set latch, so check for interrupts */ 
</span>        <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * (TAR_SEND_SIZE / throttling_sample * elapsed_min_unit) should be 
         * the maximum time to sleep. Thus the cast to long is safe. 
         */ 
</span>        <a href="basebackup.c.html#LN1341"><span class='Ref_To_Local'>wait_result</span></a> <span class='Operator'>= </span><a href="../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a> <span class='Operator'>| </span><a href="../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) (</span><a href="basebackup.c.html#LN1340"><span class='Ref_To_Local'>sleep</span></a> <span class='Operator'>/ </span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/pgstat.h.html#LN825"><span class='Ref_to_EnumConst'>WAIT_EVENT_BASE_BACKUP_THROTTLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="basebackup.c.html#LN1341"><span class='Ref_To_Local'>wait_result</span></a> <span class='Operator'>& </span><a href="../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * As we work with integers, only whole multiple of throttling_sample was 
     * processed. The rest will be done during the next call of this function. 
     */ 
</span>    <a href="basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>throttling_counter</span></a> <span class='Operator'>%= </span><a href="basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>throttling_sample</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Time interval for the remaining amount and possible next increments 
     * starts now. 
     */ 
</span>    <a href="basebackup.c.html#LN97"><span class='Ref_to_Global_Var'>throttled_last</span></a> <span class='Operator'>= </span><a href="../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end throttle &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>