<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\replication\libpqwalreceiver\libpqwalreceiver.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\replication\libpqwalreceiver\libpqwalreceiver.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * libpqwalreceiver.c 
 * 
 * This file contains the libpq-specific parts of walreceiver. It's 
 * loaded as a dynamic module to avoid linking the main server binary with 
 * libpq. 
 * 
 * Portions Copyright (c) 2010-2017, PostgreSQL Global Development Group 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/replication/libpqwalreceiver/libpqwalreceiver.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pqexpbuffer.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walreceiver.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/pg_lsn.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tuplestore.h"</span> 
 
<a href="../../../include/fmgr.h.html#LN442"><span class='Ref_to_Const'>PG_MODULE_MAGIC</span></a><span class='Delimiter'>; 
</span> 
<a name="LN37"></a><span class='Keyword'>void</span>        <span class='Declare_Prototype'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN39"></a><span class='Control'>struct</span> <span class='Declare_Struct'>WalReceiverConn</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Current connection to the primary, if any */ 
</span><a name="LN42"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>streamConn</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Used to remember if the connection is logical or physical */ 
</span><a name="LN44"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>logical</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Buffer for currently read records */ 
</span><a name="LN46"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>recvBuf</span><span class='Delimiter'>; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* Prototypes for interface functions */ 
</span><a name="LN50"></a><span class='Keyword'>static </span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>libpqrcv_connect</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conninfo</span><span class='Delimiter'>, 
</span><a name="LN51"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>logical</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>appname</span><span class='Delimiter'>, 
</span><a name="LN52"></a>                 <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>err</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN53"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>libpqrcv_check_conninfo</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conninfo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN54"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>libpqrcv_get_conninfo</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN55"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>libpqrcv_identify_system</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN56"></a>                         <a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>primary_tli</span><span class='Delimiter'>, 
</span><a name="LN57"></a>                         <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>server_version</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN58"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>libpqrcv_readtimelinehistoryfile</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN59"></a>                                 <a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Declare_Parameter'>tli</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, 
</span><a name="LN60"></a>                                 <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>content</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN61"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>libpqrcv_startstreaming</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN62"></a>                        <span class='Keyword'>const </span><a href="../../../include/replication/walreceiver.h.html#LN139"><span class='Ref_to_Typedef'>WalRcvStreamOptions</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN63"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>libpqrcv_endstreaming</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN64"></a>                      <a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>next_tli</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN65"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>libpqrcv_receive</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN66"></a>                 <a href="../../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wait_fd</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>libpqrcv_send</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN68"></a>              <span class='Keyword'>int </span><span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>libpqrcv_create_slot</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN70"></a>                     <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>slotname</span><span class='Delimiter'>, 
</span><a name="LN71"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>temporary</span><span class='Delimiter'>, 
</span><a name="LN72"></a>                     <a href="../../../include/replication/walsender.h.html#LN21"><span class='Ref_to_Typedef'>CRSSnapshotAction</span></a> <span class='Declare_Parameter'>snapshot_action</span><span class='Delimiter'>, 
</span><a name="LN73"></a>                     <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lsn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static </span><a href="../../../include/replication/walreceiver.h.html#LN184"><span class='Ref_to_Struct'>WalRcvExecResult</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>libpqrcv_exec</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN75"></a>              <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, 
</span><a name="LN76"></a>              <span class='Keyword'>const int </span><span class='Declare_Parameter'>nRetTypes</span><span class='Delimiter'>, 
</span><a name="LN77"></a>              <span class='Keyword'>const </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>retTypes</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>libpqrcv_disconnect</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN80"></a><span class='Keyword'>static </span><a href="../../../include/replication/walreceiver.h.html#LN223"><span class='Ref_to_Struct'>WalReceiverFunctionsType</span></a> <span class='Declare_Var'>PQWalReceiverFunctions</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="libpqwalreceiver.c.html#LN50"><span class='Ref_to_Proto'>libpqrcv_connect</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN53"><span class='Ref_to_Proto'>libpqrcv_check_conninfo</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN54"><span class='Ref_to_Proto'>libpqrcv_get_conninfo</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN55"><span class='Ref_to_Proto'>libpqrcv_identify_system</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN58"><span class='Ref_to_Proto'>libpqrcv_readtimelinehistoryfile</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN61"><span class='Ref_to_Proto'>libpqrcv_startstreaming</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN63"><span class='Ref_to_Proto'>libpqrcv_endstreaming</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN65"><span class='Ref_to_Proto'>libpqrcv_receive</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN67"><span class='Ref_to_Proto'>libpqrcv_send</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN69"><span class='Ref_to_Proto'>libpqrcv_create_slot</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN74"><span class='Ref_to_Proto'>libpqrcv_exec</span></a><span class='Delimiter'>, 
</span>    <a href="libpqwalreceiver.c.html#LN78"><span class='Ref_to_Proto'>libpqrcv_disconnect</span></a> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* Prototypes for private functions */ 
</span><a name="LN96"></a><span class='Keyword'>static </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>libpqrcv_PQexec</span><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>streamConn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>stringlist_to_identifierstr</span><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>strings</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Module initialization function 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN103"></a><span class='Declare_Function'>_PG_init</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN79"><span class='Ref_to_Global_Var'>WalReceiverFunctions</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"libpqwalreceiver already loaded"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../walreceiver.c.html#LN79"><span class='Ref_to_Global_Var'>WalReceiverFunctions</span></a> <span class='Operator'>= &</span><a href="libpqwalreceiver.c.html#LN80"><span class='Ref_to_Global_Var'>PQWalReceiverFunctions</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Establish the connection to the primary server for XLOG streaming 
 * 
 * Returns NULL on error and fills the err with palloc'ed error message. 
 */ 
</span><span class='Keyword'>static </span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>* 
</span><a name="LN116"></a><span class='Declare_Function'>libpqrcv_connect</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conninfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>logical</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>appname</span><span class='Delimiter'>, 
</span><a name="LN117"></a>                 <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>err</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN119"></a>    <a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Local'>conn</span><span class='Delimiter'>; 
</span><a name="LN120"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN71"><span class='Ref_to_Typedef'>PostgresPollingStatusType</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN121"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>keys</span><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>]; 
</span><a name="LN122"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>vals</span><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>]; 
</span><a name="LN123"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We use the expand_dbname parameter to process the connection string (or 
     * URI), and pass some extra options. The deliberately undocumented 
     * parameter "replication=true" makes it a replication connection. The 
     * database name is ignored by the server in replication mode, but specify 
     * "replication" for .pgpass lookup. 
     */ 
</span>    <a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"dbname"</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN116"><span class='Ref_to_Parameter'>conninfo</span></a><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>[</span><span class='Operator'>++</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"replication"</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN116"><span class='Ref_to_Parameter'>logical</span></a> <span class='Operator'>? </span><span class='String'>"database"</span> <span class='Operator'>: </span><span class='String'>"true"</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="libpqwalreceiver.c.html#LN116"><span class='Ref_to_Parameter'>logical</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>[</span><span class='Operator'>++</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"dbname"</span><span class='Delimiter'>; 
</span>        <a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"replication"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>[</span><span class='Operator'>++</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"fallback_application_name"</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN116"><span class='Ref_to_Parameter'>appname</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN116"><span class='Ref_to_Parameter'>logical</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>[</span><span class='Operator'>++</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>"client_encoding"</span><span class='Delimiter'>; 
</span>        <a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/mb/pg_wchar.h.html#LN546"><span class='Ref_to_Proto'>GetDatabaseEncodingName</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>[</span><span class='Operator'>++</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN123"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN255"><span class='Ref_to_Proto'>PQconnectStartParams</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN121"><span class='Ref_To_Local'>keys</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN122"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>, 
</span>                                             <span class='Comment_Multi_Line'>/* expand_dbname = */ </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN117"><span class='Ref_to_Parameter'>err</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Poll connection until we have OK or FAILED status. 
     * 
     * Per spec for PQconnectPoll, first wait till socket is write-ready. 
     */ 
</span>    <a href="libpqwalreceiver.c.html#LN120"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN75"><span class='Ref_to_EnumConst'>PGRES_POLLING_WRITING</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Wait for socket ready and/or other events. */ 
</span><a name="LN171"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>io_flag</span><span class='Delimiter'>; 
</span><a name="LN172"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
        <a href="libpqwalreceiver.c.html#LN171"><span class='Ref_To_Local'>io_flag</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN120"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN74"><span class='Ref_to_EnumConst'>PGRES_POLLING_READING</span></a> 
                   <span class='Operator'>? </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> 
                   <span class='Operator'>: </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="libpqwalreceiver.c.html#LN172"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>| 
</span>                               <a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| </span><a href="libpqwalreceiver.c.html#LN171"><span class='Ref_To_Local'>io_flag</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../interfaces/libpq/libpq-fe.h.html#LN324"><span class='Ref_to_Proto'>PQsocket</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <a href="../../../include/pgstat.h.html#LN786"><span class='Ref_to_EnumConst'>WAIT_EVENT_LIBPQWALRECEIVER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Emergency bailout? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN172"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>            <a href="../../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Interrupted? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN172"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If socket is ready, advance the libpq state machine */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN172"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="libpqwalreceiver.c.html#LN171"><span class='Ref_To_Local'>io_flag</span></a><span class='Parentheses'>) 
</span>            <a href="libpqwalreceiver.c.html#LN120"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN257"><span class='Ref_to_Proto'>PQconnectPoll</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN120"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN76"><span class='Ref_to_EnumConst'>PGRES_POLLING_OK</span></a> <span class='Operator'>&& </span><a href="libpqwalreceiver.c.html#LN120"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN73"><span class='Ref_to_EnumConst'>PGRES_POLLING_FAILED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN48"><span class='Ref_to_EnumConst'>CONNECTION_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN117"><span class='Ref_to_Parameter'>err</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN44"><span class='Ref_to_Member'>logical</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN116"><span class='Ref_to_Parameter'>logical</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN119"><span class='Ref_To_Local'>conn</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_connect &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Validate connection info string (just try to parse it) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN216"></a><span class='Declare_Function'>libpqrcv_check_conninfo</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>conninfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN218"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>opts</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN219"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="libpqwalreceiver.c.html#LN218"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN278"><span class='Ref_to_Proto'>PQconninfoParse</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN216"><span class='Ref_to_Parameter'>conninfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN219"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN218"><span class='Ref_To_Local'>opts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid connection string syntax: %s"</span><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN219"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN284"><span class='Ref_to_Proto'>PQconninfoFree</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN218"><span class='Ref_To_Local'>opts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return a user-displayable conninfo string.  Any security-sensitive fields 
 * are obfuscated. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN235"></a><span class='Declare_Function'>libpqrcv_get_conninfo</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN237"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>conn_opts</span><span class='Delimiter'>; 
</span><a name="LN238"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>conn_opt</span><span class='Delimiter'>; 
</span><a name="LN239"></a>    <a href="../../../interfaces/libpq/pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN240"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN235"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../interfaces/libpq/pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN239"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN237"><span class='Ref_To_Local'>conn_opts</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN281"><span class='Ref_to_Proto'>PQconninfo</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN235"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN237"><span class='Ref_To_Local'>conn_opts</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not parse connection string: %s"</span><span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* build a clean connection string from pieces */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN237"><span class='Ref_To_Local'>conn_opts</span></a><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN255"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>obfuscate</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip debug and empty options */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN207"><span class='Ref_to_Member'>dispchar</span></a><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>            <a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Obfuscate security-sensitive options */ 
</span>        <a href="libpqwalreceiver.c.html#LN255"><span class='Ref_To_Local'>obfuscate</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN207"><span class='Ref_to_Member'>dispchar</span></a><span class='Delimiter'>, </span><span class='String'>'*'</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="../../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN239"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s%s=%s"</span><span class='Delimiter'>, 
</span>                          <a href="libpqwalreceiver.c.html#LN239"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>? </span><span class='String'>""</span> <span class='Operator'>: </span><span class='String'>" "</span><span class='Delimiter'>, 
</span>                          <a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, 
</span>                          <a href="libpqwalreceiver.c.html#LN255"><span class='Ref_To_Local'>obfuscate</span></a> <span class='Operator'>? </span><span class='String'>"********"</span> <span class='Operator'>: </span><a href="libpqwalreceiver.c.html#LN238"><span class='Ref_To_Local'>conn_opt</span></a><span class='Operator'>-&GT;</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN284"><span class='Ref_to_Proto'>PQconninfoFree</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN237"><span class='Ref_To_Local'>conn_opts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="libpqwalreceiver.c.html#LN240"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/pqexpbuffer.h.html#LN66"><span class='Ref_to_Macro'>PQExpBufferDataBroken</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN239"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Null_Value'>NULL </span><span class='Operator'>: </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN239"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../interfaces/libpq/pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN239"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN240"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_get_conninfo &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check that primary's system identifier matches ours, and fetch the current 
 * timeline ID of the primary. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN284"></a><span class='Declare_Function'>libpqrcv_identify_system</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>primary_tli</span><span class='Delimiter'>, 
</span><a name="LN285"></a>                         <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>server_version</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN287"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN288"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>primary_sysid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the system identifier and timeline ID as a DataRow message from the 
     * primary server. 
     */ 
</span>    <a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN96"><span class='Ref_to_Proto'>libpqrcv_PQexec</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN284"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><span class='String'>"IDENTIFY_SYSTEM"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive database system identifier and timeline ID from "</span> 
                        <span class='String'>"the primary server: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN284"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>3</span> <span class='Operator'>|| </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN305"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ntuples</span> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN306"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nfields</span> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid response from primary server"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Could not identify system: got %d rows and %d fields, expected %d rows and %d or more fields."</span><span class='Delimiter'>, 
</span>                           <a href="libpqwalreceiver.c.html#LN305"><span class='Ref_To_Local'>ntuples</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN306"><span class='Ref_To_Local'>nfields</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="libpqwalreceiver.c.html#LN288"><span class='Ref_To_Local'>primary_sysid</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN284"><span class='Ref_to_Parameter'>primary_tli</span></a> <span class='Operator'>= </span><a href="../../utils/adt/numutils.c.html#LN35"><span class='Ref_to_Func'>pg_atoi</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN287"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN285"><span class='Ref_to_Parameter'>server_version</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN284"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN288"><span class='Ref_To_Local'>primary_sysid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_identify_system &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Start streaming WAL data from given streaming options. 
 * 
 * Returns true if we switched successfully to copy-both mode. False 
 * means the server received the command and executed it successfully, but 
 * didn't switch to copy-mode.  That means that there was no WAL on the 
 * requested timeline and starting point, because the server switched to 
 * another timeline at or before the requested starting point. On failure, 
 * throws an ERROR. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN334"></a><span class='Declare_Function'>libpqrcv_startstreaming</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN335"></a>                        <span class='Keyword'>const </span><a href="../../../include/replication/walreceiver.h.html#LN139"><span class='Ref_to_Typedef'>WalRcvStreamOptions</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>options</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN337"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>cmd</span><span class='Delimiter'>; 
</span><a name="LN338"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN141"><span class='Ref_to_Member'>logical</span></a> <span class='Operator'>== </span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN44"><span class='Ref_to_Member'>logical</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN143"><span class='Ref_to_Member'>slotname</span></a> <span class='Operator'>|| !</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN141"><span class='Ref_to_Member'>logical</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build the command. */ 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>"START_REPLICATION"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN143"><span class='Ref_to_Member'>slotname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" SLOT \"%s\""</span><span class='Delimiter'>, 
</span>                         <a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN143"><span class='Ref_to_Member'>slotname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN141"><span class='Ref_to_Member'>logical</span></a><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" LOGICAL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" %X/%X"</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN144"><span class='Ref_to_Member'>startpoint</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN144"><span class='Ref_to_Member'>startpoint</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Additional options are different depending on if we are doing logical 
     * or physical replication. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN141"><span class='Ref_to_Member'>logical</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN364"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pubnames_str</span><span class='Delimiter'>; 
</span><a name="LN365"></a>        <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>pubnames</span><span class='Delimiter'>; 
</span><a name="LN366"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pubnames_literal</span><span class='Delimiter'>; 
</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" ("</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>"proto_version '%u'"</span><span class='Delimiter'>, 
</span>                         <a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN157"><span class='Ref_to_Member'>proto</span></a><span class='Operator'>.</span>logical<span class='Operator'>.</span>proto_version<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="libpqwalreceiver.c.html#LN365"><span class='Ref_To_Local'>pubnames</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN157"><span class='Ref_to_Member'>proto</span></a><span class='Operator'>.</span>logical<span class='Operator'>.</span>publication_names<span class='Delimiter'>; 
</span>        <a href="libpqwalreceiver.c.html#LN364"><span class='Ref_To_Local'>pubnames_str</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN97"><span class='Ref_to_Proto'>stringlist_to_identifierstr</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN365"><span class='Ref_To_Local'>pubnames</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="libpqwalreceiver.c.html#LN364"><span class='Ref_To_Local'>pubnames_str</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not start WAL streaming: %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>        <a href="libpqwalreceiver.c.html#LN366"><span class='Ref_To_Local'>pubnames_literal</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN524"><span class='Ref_to_Proto'>PQescapeLiteral</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN364"><span class='Ref_To_Local'>pubnames_str</span></a><span class='Delimiter'>, 
</span>                                           strlen<span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN364"><span class='Ref_To_Local'>pubnames_str</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="libpqwalreceiver.c.html#LN366"><span class='Ref_To_Local'>pubnames_literal</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not start WAL streaming: %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>", publication_names %s"</span><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN366"><span class='Ref_To_Local'>pubnames_literal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN366"><span class='Ref_To_Local'>pubnames_literal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN364"><span class='Ref_To_Local'>pubnames_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>')'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if options-&GT;logical &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" TIMELINE %u"</span><span class='Delimiter'>, 
</span>                         <a href="libpqwalreceiver.c.html#LN335"><span class='Ref_to_Parameter'>options</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN157"><span class='Ref_to_Member'>proto</span></a><span class='Operator'>.</span>physical<span class='Operator'>.</span>startpointTLI<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Start streaming. */ 
</span>    <a href="libpqwalreceiver.c.html#LN338"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN96"><span class='Ref_to_Proto'>libpqrcv_PQexec</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN337"><span class='Ref_To_Local'>cmd</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN338"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN338"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN338"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN96"><span class='Ref_to_EnumConst'>PGRES_COPY_BOTH</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN338"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not start WAL streaming: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN334"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN338"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_startstreaming &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Stop streaming WAL data. Returns the next timeline's ID in *next_tli, as 
 * reported by the server, or 0 if it did not report it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN420"></a><span class='Declare_Function'>libpqrcv_endstreaming</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>next_tli</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN422"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN432"><span class='Ref_to_Proto'>PQputCopyEnd</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN451"><span class='Ref_to_Proto'>PQflush</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not send end-of-streaming message to primary: %s"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>next_tli</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * After COPY is finished, we should receive a result set indicating the 
     * next timeline's ID, or just CommandComplete if the server was shut 
     * down. 
     * 
     * If we had not yet received CopyDone from the backend, PGRES_COPY_OUT is 
     * also possible in case we aborted the copy in mid-stream. 
     */ 
</span>    <a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Read the next timeline's ID. The server also sends the timeline's 
         * starting point, but it is ignored. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>2</span> <span class='Operator'>|| </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected result set after end-of-streaming"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>next_tli</span></a> <span class='Operator'>= </span><a href="../../utils/adt/numutils.c.html#LN35"><span class='Ref_to_Func'>pg_atoi</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* the result set should be followed by CommandComplete */ 
</span>        <a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN90"><span class='Ref_to_EnumConst'>PGRES_COPY_OUT</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* End the copy */ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN440"><span class='Ref_to_Proto'>PQendcopy</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* CommandComplete should follow */ 
</span>        <a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"error reading result of streaming command: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Verify that there are no more results */ 
</span>    <a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN422"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected result after CommandComplete: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN420"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_endstreaming &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch the timeline history file for 'tli' from primary. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN485"></a><span class='Declare_Function'>libpqrcv_readtimelinehistoryfile</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, 
</span><a name="LN486"></a>                                 <a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a> <span class='Declare_Parameter'>tli</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, 
</span><a name="LN487"></a>                                 <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>content</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN489"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>cmd</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="libpqwalreceiver.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN44"><span class='Ref_to_Member'>logical</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Request the primary to send over the history file for given timeline. 
     */ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN490"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN490"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"TIMELINE_HISTORY %u"</span><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN486"><span class='Ref_to_Parameter'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN96"><span class='Ref_to_Proto'>libpqrcv_PQexec</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN490"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive timeline history file from "</span> 
                        <span class='String'>"the primary server: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN485"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>2</span> <span class='Operator'>|| </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN509"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ntuples</span> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN510"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nfields</span> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid response from primary server"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Expected 1 tuple with 2 fields, got %d tuples with %d fields."</span><span class='Delimiter'>, 
</span>                           <a href="libpqwalreceiver.c.html#LN509"><span class='Ref_To_Local'>ntuples</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN510"><span class='Ref_To_Local'>nfields</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN486"><span class='Ref_to_Parameter'>filename</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN487"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN489"><span class='Ref_to_Proto'>PQgetlength</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN487"><span class='Ref_to_Parameter'>content</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN487"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN487"><span class='Ref_to_Parameter'>content</span></a><span class='Delimiter'>, </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN487"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN489"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_readtimelinehistoryfile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a query and wait for the results by using the asynchronous libpq 
 * functions and socket readiness events. 
 * 
 * We must not use the regular blocking libpq functions like PQexec() 
 * since they are uninterruptible by signals on some platforms, such as 
 * Windows. 
 * 
 * The function is modeled on PQexec() in libpq, but only implements 
 * those parts that are in use in the walreceiver api. 
 * 
 * Queries are always executed on the connection in streamConn. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>* 
</span><a name="LN540"></a><span class='Declare_Function'>libpqrcv_PQexec</span><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>streamConn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN542"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN543"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lastResult</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * PQexec() silently discards any prior query results on the connection. 
     * This is not required for this function as it's expected that the caller 
     * (which is this library in all cases) will behave correctly and we don't 
     * have to be backwards compatible with old libpq. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Submit a query. Since we don't use non-blocking mode, this also can 
     * block. But its risk is relatively small, so we ignore that for now. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN401"><span class='Ref_to_Proto'>PQsendQuery</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Receive data until PQgetResult is ready to get the result without 
         * blocking. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN424"><span class='Ref_to_Proto'>PQisBusy</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>streamConn</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN567"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We don't need to break down the sleep into smaller increments, 
             * since we'll get interrupted by signals and can either handle 
             * interrupts here or elog(FATAL) within SIGTERM signal handler if 
             * the signal arrives in the middle of establishment of 
             * replication connection. 
             */ 
</span>            <a href="libpqwalreceiver.c.html#LN567"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| 
</span>                                   <a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../interfaces/libpq/libpq-fe.h.html#LN324"><span class='Ref_to_Proto'>PQsocket</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                   <a href="../../../include/pgstat.h.html#LN786"><span class='Ref_to_EnumConst'>WAIT_EVENT_LIBPQWALRECEIVER</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Emergency bailout? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN567"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>                <a href="../../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Interrupted? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN567"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>streamConn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* trouble */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while PQisBusy(streamConn) &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Emulate the PQexec()'s behavior of returning the last result when 
         * there are many. We are fine with returning just last error message. 
         */ 
</span>        <a href="libpqwalreceiver.c.html#LN542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* query is complete */ 
</span> 
        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN543"><span class='Ref_To_Local'>lastResult</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="libpqwalreceiver.c.html#LN543"><span class='Ref_To_Local'>lastResult</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN542"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN543"><span class='Ref_To_Local'>lastResult</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN91"><span class='Ref_to_EnumConst'>PGRES_COPY_IN</span></a> <span class='Operator'>|| 
</span>            <a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN543"><span class='Ref_To_Local'>lastResult</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN90"><span class='Ref_to_EnumConst'>PGRES_COPY_OUT</span></a> <span class='Operator'>|| 
</span>            <a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN543"><span class='Ref_To_Local'>lastResult</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN96"><span class='Ref_to_EnumConst'>PGRES_COPY_BOTH</span></a> <span class='Operator'>|| 
</span>            <a href="../../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN540"><span class='Ref_to_Parameter'>streamConn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN543"><span class='Ref_To_Local'>lastResult</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_PQexec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Disconnect connection to primary, if any. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN622"></a><span class='Declare_Function'>libpqrcv_disconnect</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN622"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN622"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN622"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN622"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Receive a message available from XLOG stream. 
 * 
 * Returns: 
 * 
 *   If data was received, returns the length of the data. *buffer is set to 
 *   point to a buffer holding the received message. The buffer is only valid 
 *   until the next libpqrcv_* call. 
 * 
 *   If no data was available immediately, returns 0, and *wait_fd is set to a 
 *   socket descriptor which can be waited on before trying again. 
 * 
 *   -1 if the server ended the COPY. 
 * 
 * ereports on error. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN647"></a><span class='Declare_Function'>libpqrcv_receive</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN648"></a>                 <a href="../../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>wait_fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN650"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rawlen</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Try to receive a CopyData message */ 
</span>    <a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN433"><span class='Ref_to_Proto'>PQgetCopyData</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Try consuming some data. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN425"><span class='Ref_to_Proto'>PQconsumeInput</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive data from WAL stream: %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Now that we've consumed some input, try again */ 
</span>        <a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN433"><span class='Ref_to_Proto'>PQgetCopyData</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Tell caller to try again when our socket is ready. */ 
</span>            <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN648"><span class='Ref_to_Parameter'>wait_fd</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN324"><span class='Ref_to_Proto'>PQsocket</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span>           <span class='Comment_Single_Line'>/* end-of-streaming or error */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN677"></a>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
        <a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Verify that there are no more results. */ 
</span>            <a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If the other side closed the connection orderly (otherwise 
                 * we'd seen an error, or PGRES_COPY_IN) don't report an error 
                 * here, but let callers deal with it. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN317"><span class='Ref_to_Proto'>PQstatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN49"><span class='Ref_to_EnumConst'>CONNECTION_BAD</span></a><span class='Parentheses'>)</span> 
                    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"unexpected result after CommandComplete: %s"</span><span class='Delimiter'>, 
</span>                                <a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PQresultStatus(res)==... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN91"><span class='Ref_to_EnumConst'>PGRES_COPY_IN</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN677"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive data from WAL stream: %s"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rawlen==-1 &raquo; </span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a> <span class='Operator'>&LT; -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not receive data from WAL stream: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return received messages to caller */ 
</span>    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN647"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN46"><span class='Ref_to_Member'>recvBuf</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN650"><span class='Ref_To_Local'>rawlen</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_receive &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a message to XLOG stream. 
 * 
 * ereports on error. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN734"></a><span class='Declare_Function'>libpqrcv_send</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN431"><span class='Ref_to_Proto'>PQputCopyData</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN734"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN734"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN734"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN451"><span class='Ref_to_Proto'>PQflush</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN734"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not send data to WAL stream: %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN734"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create new replication slot. 
 * Returns the name of the exported snapshot for logical slot or NULL for 
 * physical slot. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN749"></a><span class='Declare_Function'>libpqrcv_create_slot</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>slotname</span><span class='Delimiter'>, 
</span><a name="LN750"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>temporary</span><span class='Delimiter'>, </span><a href="../../../include/replication/walsender.h.html#LN21"><span class='Ref_to_Typedef'>CRSSnapshotAction</span></a> <span class='Declare_Parameter'>snapshot_action</span><span class='Delimiter'>, 
</span><a name="LN751"></a>                     <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN753"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN754"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>cmd</span><span class='Delimiter'>; 
</span><a name="LN755"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span> 
    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>"CREATE_REPLICATION_SLOT \"%s\""</span><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN749"><span class='Ref_to_Parameter'>slotname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN750"><span class='Ref_to_Parameter'>temporary</span></a><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" TEMPORARY"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN749"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN44"><span class='Ref_to_Member'>logical</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" LOGICAL pgoutput"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN750"><span class='Ref_to_Parameter'>snapshot_action</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/replication/walsender.h.html#LN23"><span class='Ref_to_EnumConst'>CRS_EXPORT_SNAPSHOT</span></a><span class='Operator'>: 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" EXPORT_SNAPSHOT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/replication/walsender.h.html#LN24"><span class='Ref_to_EnumConst'>CRS_NOEXPORT_SNAPSHOT</span></a><span class='Operator'>: 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" NOEXPORT_SNAPSHOT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/replication/walsender.h.html#LN25"><span class='Ref_to_EnumConst'>CRS_USE_SNAPSHOT</span></a><span class='Operator'>: 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Delimiter'>, </span><span class='String'>" USE_SNAPSHOT"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN96"><span class='Ref_to_Proto'>libpqrcv_PQexec</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN749"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN754"><span class='Ref_To_Local'>cmd</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create replication slot \"%s\": %s"</span><span class='Delimiter'>, 
</span>                        <a href="libpqwalreceiver.c.html#LN749"><span class='Ref_to_Parameter'>slotname</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN749"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="libpqwalreceiver.c.html#LN751"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>= </span><a href="../../../include/utils/pg_lsn.h.html#LN20"><span class='Ref_to_Macro'>DatumGetLSN</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN462"><span class='Ref_to_Proto'>DirectFunctionCall1Coll</span></a><span class='Parentheses'>(</span><a href="../../utils/adt/pg_lsn.c.html#LN28"><span class='Ref_to_Func'>pg_lsn_in</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>))</span> 
        <a href="libpqwalreceiver.c.html#LN755"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="libpqwalreceiver.c.html#LN755"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN753"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN755"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_create_slot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Convert tuple query result to tuplestore. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN808"></a><span class='Declare_Function'>libpqrcv_processTuples</span><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pgres</span><span class='Delimiter'>, </span><a href="../../../include/replication/walreceiver.h.html#LN184"><span class='Ref_to_Struct'>WalRcvExecResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>walres</span><span class='Delimiter'>, 
</span><a name="LN809"></a>                       <span class='Keyword'>const int </span><span class='Declare_Parameter'>nRetTypes</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>retTypes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN811"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>tupn</span><span class='Delimiter'>; 
</span><a name="LN812"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>coln</span><span class='Delimiter'>; 
</span><a name="LN813"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nfields</span> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>pgres</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN814"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN815"></a>    <a href="../../../include/funcapi.h.html#LN34"><span class='Ref_to_Struct'>AttInMetadata</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attinmeta</span><span class='Delimiter'>; 
</span><a name="LN816"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>rowcontext</span><span class='Delimiter'>; 
</span><a name="LN817"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we got expected number of fields. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN813"><span class='Ref_To_Local'>nfields</span></a> <span class='Operator'>!= </span><a href="libpqwalreceiver.c.html#LN809"><span class='Ref_to_Parameter'>nRetTypes</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid query response"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Expected %d fields, got %d fields."</span><span class='Delimiter'>, 
</span>                           <a href="libpqwalreceiver.c.html#LN809"><span class='Ref_to_Parameter'>nRetTypes</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN813"><span class='Ref_To_Local'>nfields</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN188"><span class='Ref_to_Member'>tuplestore</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create tuple descriptor corresponding to expected result. */ 
</span>    <a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN189"><span class='Ref_to_Member'>tupledesc</span></a> <span class='Operator'>= </span><a href="../../access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN809"><span class='Ref_to_Parameter'>nRetTypes</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a> <span class='Operator'>&LT; </span><a href="libpqwalreceiver.c.html#LN809"><span class='Ref_to_Parameter'>nRetTypes</span></a><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN189"><span class='Ref_to_Member'>tupledesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                           <a href="../../../interfaces/libpq/libpq-fe.h.html#LN476"><span class='Ref_to_Proto'>PQfname</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>pgres</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN809"><span class='Ref_to_Parameter'>retTypes</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Delimiter'>], </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="libpqwalreceiver.c.html#LN815"><span class='Ref_To_Local'>attinmeta</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN230"><span class='Ref_to_Proto'>TupleDescGetAttInMetadata</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN189"><span class='Ref_to_Member'>tupledesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No point in doing more here if there were no tuples returned. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>pgres</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create temporary context for local allocations. */ 
</span>    <a href="libpqwalreceiver.c.html#LN816"><span class='Ref_To_Local'>rowcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                       <span class='String'>"libpqrcv query result context"</span><span class='Delimiter'>, 
</span>                                       <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process returned rows. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN811"><span class='Ref_To_Local'>tupn</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN811"><span class='Ref_To_Local'>tupn</span></a> <span class='Operator'>&LT; </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>pgres</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN811"><span class='Ref_To_Local'>tupn</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN847"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>cstrs</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN32"><span class='Ref_to_Const'>MaxTupleAttributeNumber</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do the allocations in temporary context. */ 
</span>        <a href="libpqwalreceiver.c.html#LN817"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN816"><span class='Ref_To_Local'>rowcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fill cstrs with null-terminated strings of column values. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a> <span class='Operator'>&LT; </span><a href="libpqwalreceiver.c.html#LN813"><span class='Ref_To_Local'>nfields</span></a><span class='Delimiter'>; </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>pgres</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN811"><span class='Ref_To_Local'>tupn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Parentheses'>))</span> 
                <a href="libpqwalreceiver.c.html#LN847"><span class='Ref_To_Local'>cstrs</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="libpqwalreceiver.c.html#LN847"><span class='Ref_To_Local'>cstrs</span></a><span class='Delimiter'>[</span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>pgres</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN811"><span class='Ref_To_Local'>tupn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN812"><span class='Ref_To_Local'>coln</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Convert row to a tuple, and add it to the tuplestore */ 
</span>        <a href="libpqwalreceiver.c.html#LN814"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/funcapi.h.html#LN231"><span class='Ref_to_Proto'>BuildTupleFromCStrings</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN815"><span class='Ref_To_Local'>attinmeta</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN847"><span class='Ref_To_Local'>cstrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/tuplestore.h.html#LN54"><span class='Ref_to_Proto'>tuplestore_puttuple</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN808"><span class='Ref_to_Parameter'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN188"><span class='Ref_to_Member'>tuplestore</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN814"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Clean up */ 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN817"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN816"><span class='Ref_To_Local'>rowcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for tupn=0;tupn&LT;PQntuples... &raquo; </span> 
 
    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN816"><span class='Ref_To_Local'>rowcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_processTuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Public interface for sending generic queries (and commands). 
 * 
 * This can only be called from process connected to database. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/replication/walreceiver.h.html#LN184"><span class='Ref_to_Struct'>WalRcvExecResult</span></a> <span class='Operator'>* 
</span><a name="LN883"></a><span class='Declare_Function'>libpqrcv_exec</span><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query</span><span class='Delimiter'>, 
</span><a name="LN884"></a>              <span class='Keyword'>const int </span><span class='Declare_Parameter'>nRetTypes</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>retTypes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN886"></a>    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>pgres</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN887"></a>    <a href="../../../include/replication/walreceiver.h.html#LN184"><span class='Ref_to_Struct'>WalRcvExecResult</span></a> <span class='Operator'>*</span><span class='Declare_Local'>walres</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/walreceiver.h.html#LN184"><span class='Ref_to_Struct'>WalRcvExecResult</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"the query interface requires a database connection"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="libpqwalreceiver.c.html#LN886"><span class='Ref_To_Local'>pgres</span></a> <span class='Operator'>= </span><a href="libpqwalreceiver.c.html#LN96"><span class='Ref_to_Proto'>libpqrcv_PQexec</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN883"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN883"><span class='Ref_to_Parameter'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN886"><span class='Ref_To_Local'>pgres</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN97"><span class='Ref_to_EnumConst'>PGRES_SINGLE_TUPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN173"><span class='Ref_to_EnumConst'>WALRCV_OK_TUPLES</span></a><span class='Delimiter'>; 
</span>            <a href="libpqwalreceiver.c.html#LN807"><span class='Ref_to_Func'>libpqrcv_processTuples</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN886"><span class='Ref_To_Local'>pgres</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN884"><span class='Ref_to_Parameter'>nRetTypes</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN884"><span class='Ref_to_Parameter'>retTypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN91"><span class='Ref_to_EnumConst'>PGRES_COPY_IN</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN174"><span class='Ref_to_EnumConst'>WALRCV_OK_COPY_IN</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN90"><span class='Ref_to_EnumConst'>PGRES_COPY_OUT</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN175"><span class='Ref_to_EnumConst'>WALRCV_OK_COPY_OUT</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN96"><span class='Ref_to_EnumConst'>PGRES_COPY_BOTH</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN176"><span class='Ref_to_EnumConst'>WALRCV_OK_COPY_BOTH</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN171"><span class='Ref_to_EnumConst'>WALRCV_OK_COMMAND</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Empty query is considered error. */ 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN83"><span class='Ref_to_EnumConst'>PGRES_EMPTY_QUERY</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN170"><span class='Ref_to_EnumConst'>WALRCV_ERROR</span></a><span class='Delimiter'>; 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN187"><span class='Ref_to_Member'>err</span></a> <span class='Operator'>= </span>_<span class='Parentheses'>(</span><span class='String'>"empty query"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN94"><span class='Ref_to_EnumConst'>PGRES_NONFATAL_ERROR</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN95"><span class='Ref_to_EnumConst'>PGRES_FATAL_ERROR</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/libpq/libpq-fe.h.html#LN92"><span class='Ref_to_EnumConst'>PGRES_BAD_RESPONSE</span></a><span class='Operator'>: 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN186"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN170"><span class='Ref_to_EnumConst'>WALRCV_ERROR</span></a><span class='Delimiter'>; 
</span>            <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/walreceiver.h.html#LN187"><span class='Ref_to_Member'>err</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN129"><span class='Ref_to_Proto'>pchomp</span></a><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN883"><span class='Ref_to_Parameter'>conn</span></a><span class='Operator'>-&GT;</span><a href="libpqwalreceiver.c.html#LN42"><span class='Ref_to_Member'>streamConn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch PQresultStatus(pgres) &raquo; </span> 
 
    <a href="../../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN886"><span class='Ref_To_Local'>pgres</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN887"><span class='Ref_To_Local'>walres</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end libpqrcv_exec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given a List of strings, return it as single comma separated 
 * string, quoting identifiers as needed. 
 * 
 * This is essentially the reverse of SplitIdentifierString. 
 * 
 * The caller should free the result. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN948"></a><span class='Declare_Function'>stringlist_to_identifierstr</span><span class='Parentheses'>(</span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>strings</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN950"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN951"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN952"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>first</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN951"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN950"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN948"><span class='Ref_to_Parameter'>strings</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN958"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>val</span> <span class='Operator'>= </span><a href="../../../include/nodes/value.h.html#LN53"><span class='Ref_to_Macro'>strVal</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN950"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN959"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>val_escaped</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN952"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>) 
</span>            <a href="libpqwalreceiver.c.html#LN952"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN951"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="libpqwalreceiver.c.html#LN959"><span class='Ref_To_Local'>val_escaped</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/libpq-fe.h.html#LN525"><span class='Ref_to_Proto'>PQescapeIdentifier</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN948"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN958"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN958"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="libpqwalreceiver.c.html#LN959"><span class='Ref_To_Local'>val_escaped</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN951"><span class='Ref_To_Local'>res</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="libpqwalreceiver.c.html#LN951"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="libpqwalreceiver.c.html#LN959"><span class='Ref_To_Local'>val_escaped</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="libpqwalreceiver.c.html#LN959"><span class='Ref_To_Local'>val_escaped</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="libpqwalreceiver.c.html#LN951"><span class='Ref_To_Local'>res</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end stringlist_to_identifierstr &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>