<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\replication\logical\reorderbuffer.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\replication\logical\reorderbuffer.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:47 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * reorderbuffer.c 
 *    PostgreSQL logical replay/reorder buffer management 
 * 
 * 
 * Copyright (c) 2012-2017, PostgreSQL Global Development Group 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/replication/reorderbuffer.c 
 * 
 * NOTES 
 *    This module gets handed individual pieces of transactions in the order 
 *    they are written to the WAL and is responsible to reassemble them into 
 *    toplevel transaction sized pieces. When a transaction is completely 
 *    reassembled - signalled by reading the transaction commit record - it 
 *    will then call the output plugin (c.f. ReorderBufferCommit()) with the 
 *    individual changes. The output plugins rely on snapshots built by 
 *    snapbuild.c which hands them to us. 
 * 
 *    Transactions and subtransactions/savepoints in postgres are not 
 *    immediately linked to each other from outside the performing 
 *    backend. Only at commit/abort (or special xact_assignment records) they 
 *    are linked together. Which means that we will have to splice together a 
 *    toplevel transaction from its subtransactions. To do that efficiently we 
 *    build a binary heap indexed by the smallest current lsn of the individual 
 *    subtransactions' changestreams. As the individual streams are inherently 
 *    ordered by LSN - since that is where we build them from - the transaction 
 *    can easily be reassembled by always using the subtransaction with the 
 *    smallest current LSN from the heap. 
 * 
 *    In order to cope with large transactions - which can be several times as 
 *    big as the available memory - this module supports spooling the contents 
 *    of a large transactions to disk. When the transaction is replayed the 
 *    contents of individual (sub-)transactions will be read from disk in 
 *    chunks. 
 * 
 *    This module also has to deal with reassembling toast records from the 
 *    individual chunks stored in WAL. When a new (or initial) version of a 
 *    tuple is stored in WAL it will always be preceded by the toast chunks 
 *    emitted for the columns stored out of line. Within a single toplevel 
 *    transaction there will be no other data carrying records between a row's 
 *    toast chunks and the row data itself. See ReorderBufferToast* for 
 *    details. 
 * ------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/rewriteheap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/tuptoaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/binaryheap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logical.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/reorderbuffer.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/slot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/snapbuild.h"</span>      <span class='Comment_Single_Line'>/* just for SnapBuildSnapDecRefcount */ 
</span><span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/combocid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memdebug.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/relfilenodemap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* entry for a hash table we use to map from xid to our transaction state */ 
</span><a name="LN78"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferTXNByIdEnt</span> 
<span class='Delimiter'>{ 
</span><a name="LN80"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xid</span><span class='Delimiter'>; 
</span><a name="LN81"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Member'>txn</span><span class='Delimiter'>; 
</span><a name="LN82"></a>} <span class='Declare_Typedef'>ReorderBufferTXNByIdEnt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* data structures for (relfilenode, ctid) =&GT; (cmin, cmax) mapping */ 
</span><a name="LN85"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferTupleCidKey</span> 
<span class='Delimiter'>{ 
</span><a name="LN87"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Member'>relnode</span><span class='Delimiter'>; 
</span><a name="LN88"></a>    <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Member'>tid</span><span class='Delimiter'>; 
</span><a name="LN89"></a>} <span class='Declare_Typedef'>ReorderBufferTupleCidKey</span><span class='Delimiter'>; 
</span> 
<a name="LN91"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferTupleCidEnt</span> 
<span class='Delimiter'>{ 
</span><a name="LN93"></a>    <a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a> <span class='Declare_Member'>key</span><span class='Delimiter'>; 
</span><a name="LN94"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Member'>cmin</span><span class='Delimiter'>; 
</span><a name="LN95"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Member'>cmax</span><span class='Delimiter'>; 
</span><a name="LN96"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Member'>combocid</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* just for debugging */ 
</span><a name="LN97"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>ReorderBufferTupleCidEnt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* k-way in-order change iteration support structures */ 
</span><a name="LN100"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferIterTXNEntry</span> 
<span class='Delimiter'>{ 
</span><a name="LN102"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>lsn</span><span class='Delimiter'>; 
</span><a name="LN103"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Member'>change</span><span class='Delimiter'>; 
</span><a name="LN104"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Member'>txn</span><span class='Delimiter'>; 
</span><a name="LN105"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fd</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Member'>segno</span><span class='Delimiter'>; 
</span><a name="LN107"></a>} <span class='Declare_Typedef'>ReorderBufferIterTXNEntry</span><span class='Delimiter'>; 
</span> 
<a name="LN109"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferIterTXNState</span> 
<span class='Delimiter'>{ 
</span><a name="LN111"></a>    <a href="../../../include/lib/binaryheap.h.html#LN29"><span class='Ref_to_Struct'>binaryheap</span></a> <span class='Operator'>*</span><span class='Declare_Member'>heap</span><span class='Delimiter'>; 
</span><a name="LN112"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>nr_txns</span><span class='Delimiter'>; 
</span><a name="LN113"></a>    <a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a>  <span class='Declare_Member'>old_change</span><span class='Delimiter'>; 
</span><a name="LN114"></a>    <a href="reorderbuffer.c.html#LN100"><span class='Ref_to_Struct'>ReorderBufferIterTXNEntry</span></a> <span class='Declare_Member'>entries</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN115"></a>} <span class='Declare_Typedef'>ReorderBufferIterTXNState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* toast datastructures */ 
</span><a name="LN118"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferToastEnt</span> 
<span class='Delimiter'>{ 
</span><a name="LN120"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>chunk_id</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* toast_table.chunk_id */ 
</span><a name="LN121"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>last_chunk_seq</span><span class='Delimiter'>; </span><span class='Comment_Multi_Line'>/* toast_table.chunk_seq of the last chunk we 
                                 * have seen */ 
</span><a name="LN123"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>num_chunks</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* number of chunks we've already seen */ 
</span><a name="LN124"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>size</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* combined size of chunks seen */ 
</span><a name="LN125"></a>    <a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a>  <span class='Declare_Member'>chunks</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* linked list of chunks */ 
</span><a name="LN126"></a>    <span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Member'>reconstructed</span><span class='Delimiter'>;</span>      <span class='Comment_Multi_Line'>/* reconstructed varlena now pointed 
                                         * to in main tup */ 
</span><a name="LN128"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>ReorderBufferToastEnt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Disk serialization support datastructures */ 
</span><a name="LN131"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReorderBufferDiskChange</span> 
<span class='Delimiter'>{ 
</span><a name="LN133"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>size</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Declare_Member'>change</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* data follows */ 
</span><a name="LN136"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>ReorderBufferDiskChange</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Maximum number of changes kept in memory, per transaction. After that, 
 * changes are spooled to disk. 
 * 
 * The current value should be sufficient to decode the entire transaction 
 * without hitting disk in OLTP workloads, while starting to spool to disk in 
 * other workloads reasonably fast. 
 * 
 * At some point in the future it probably makes sense to have a more elaborate 
 * resource management here, but it's not entirely clear what that would look 
 * like. 
 */ 
</span><a name="LN150"></a><span class='Keyword'>static const </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Var'>max_changes_in_memory</span> <span class='Operator'>= </span><span class='Number'>4096</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We use a very simple form of a slab allocator for frequently allocated 
 * objects, simply keeping a fixed number in a linked list when unused, 
 * instead pfree()ing them. Without that in many workloads aset.c becomes a 
 * major bottleneck, especially when spilling to disk while decoding batch 
 * workloads. 
 */ 
</span><a name="LN159"></a><span class='Keyword'>static const </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Var'>max_cached_tuplebufs</span> <span class='Operator'>= </span><span class='Number'>4096</span> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* ~8MB */ 
</span> 
<span class='Comment_Multi_Line'>/* --------------------------------------- 
 * primary reorderbuffer support routines 
 * --------------------------------------- 
 */ 
</span><a name="LN165"></a><span class='Keyword'>static </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ReorderBufferGetTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN166"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferReturnTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN167"></a><span class='Keyword'>static </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ReorderBufferTXNByXid</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, 
</span><a name="LN168"></a>                      <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>is_new</span><span class='Delimiter'>, 
</span><a name="LN169"></a>                      <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create_as_top</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN171"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AssertTXNLsnOrder</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* --------------------------------------- 
 * support functions for lsn-order iterating over the -&GT;changes of a 
 * transaction and its subtransactions 
 * 
 * used for iteration over the k-way heap merge of a transaction and its 
 * subtransactions 
 * --------------------------------------- 
 */ 
</span><a name="LN181"></a><span class='Keyword'>static </span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ReorderBufferIterTXNInit</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>* 
</span><a name="LN183"></a>            <span class='Declare_Prototype'>ReorderBufferIterTXNNext</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN184"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferIterTXNFinish</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, 
</span><a name="LN185"></a>                           <a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN186"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferExecuteInvalidations</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * --------------------------------------- 
 * Disk serialization support functions 
 * --------------------------------------- 
 */ 
</span><a name="LN193"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferCheckSerializeTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN194"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferSerializeTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN195"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferSerializeChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN196"></a>                             <span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN197"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>ReorderBufferRestoreChanges</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN198"></a>                            <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN199"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferRestoreChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN200"></a>                           <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN201"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferRestoreCleanup</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN203"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferFreeSnap</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN204"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Prototype'>ReorderBufferCopySnap</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>orig_snap</span><span class='Delimiter'>, 
</span><a name="LN205"></a>                      <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* --------------------------------------- 
 * toast reassembly support 
 * --------------------------------------- 
 */ 
</span><a name="LN211"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferToastInitHash</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN212"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferToastReset</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN213"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferToastReplace</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN214"></a>                          <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN215"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReorderBufferToastAppendChunk</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN216"></a>                              <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate a new ReorderBuffer 
 */ 
</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>* 
</span><a name="LN223"></a><span class='Declare_Function'>ReorderBufferAllocate</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN225"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Local'>buffer</span><span class='Delimiter'>; 
</span><a name="LN226"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span><a name="LN227"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>new_ctx</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* allocate memory in own context, to have better accountability */ 
</span>    <a href="reorderbuffer.c.html#LN227"><span class='Ref_To_Local'>new_ctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                    <span class='String'>"ReorderBuffer"</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN227"><span class='Ref_To_Local'>new_ctx</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN226"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN226"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN227"><span class='Ref_To_Local'>new_ctx</span></a><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN335"><span class='Ref_to_Member'>change_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN152"><span class='Ref_to_Proto'>SlabContextCreate</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN227"><span class='Ref_To_Local'>new_ctx</span></a><span class='Delimiter'>, 
</span>                                               <span class='String'>"Change"</span><span class='Delimiter'>, 
</span>                                               <a href="../../../include/utils/memutils.h.html#LN193"><span class='Ref_to_Const'>SLAB_DEFAULT_BLOCK_SIZE</span></a><span class='Delimiter'>, 
</span>                                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN336"><span class='Ref_to_Member'>txn_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN152"><span class='Ref_to_Proto'>SlabContextCreate</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN227"><span class='Ref_To_Local'>new_ctx</span></a><span class='Delimiter'>, 
</span>                                            <span class='String'>"TXN"</span><span class='Delimiter'>, 
</span>                                            <a href="../../../include/utils/memutils.h.html#LN193"><span class='Ref_to_Const'>SLAB_DEFAULT_BLOCK_SIZE</span></a><span class='Delimiter'>, 
</span>                                            <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN226"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN226"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN78"><span class='Ref_to_Struct'>ReorderBufferTXNByIdEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN226"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN299"><span class='Ref_to_Member'>by_txn</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"ReorderBufferByXid"</span><span class='Delimiter'>, </span><span class='Number'>1000</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN226"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN311"><span class='Ref_to_Member'>by_txn_last_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN312"><span class='Ref_to_Member'>by_txn_last_txn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN350"><span class='Ref_to_Member'>nr_cached_tuplebufs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN356"><span class='Ref_to_Member'>outbufsize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN352"><span class='Ref_to_Member'>current_restart_decoding_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN552"><span class='Ref_to_Func'>slist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN349"><span class='Ref_to_Member'>cached_tuplebufs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN225"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferAllocate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free a ReorderBuffer 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN278"></a><span class='Declare_Function'>ReorderBufferFree</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN280"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>context</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN278"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We free separately allocated data by entirely scrapping reorderbuffer's 
     * memory context. 
     */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN280"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get an unused, possibly preallocated, ReorderBufferTXN. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>* 
</span><a name="LN293"></a><span class='Declare_Function'>ReorderBufferGetTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN295"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN295"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN293"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN336"><span class='Ref_to_Member'>txn_context</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN295"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN295"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN295"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN225"><span class='Ref_to_Member'>tuplecids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN295"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN295"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Free a ReorderBufferTXN. 
 * 
 * Deallocation might be delayed for efficiency purposes, for details check 
 * the comments above max_cached_changes's definition. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN316"></a><span class='Declare_Function'>ReorderBufferReturnTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* clean the lookup cache if we were cached (quite likely) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN311"><span class='Ref_to_Member'>by_txn_last_xid</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN311"><span class='Ref_to_Member'>by_txn_last_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN312"><span class='Ref_to_Member'>by_txn_last_txn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* free data that's contained */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN316"><span class='Ref_to_Parameter'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferReturnTXN &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get an unused, possibly preallocated, ReorderBufferChange. 
 */ 
</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>* 
</span><a name="LN346"></a><span class='Declare_Function'>ReorderBufferGetChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN348"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN348"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN346"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN335"><span class='Ref_to_Member'>change_context</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN348"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN348"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Free an ReorderBufferChange. 
 * 
 * Deallocation might be delayed for efficiency purposes, for details check 
 * the comments above max_cached_changes's definition. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN364"></a><span class='Declare_Function'>ReorderBufferReturnChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* free contained data */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN53"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INSERT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN54"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_UPDATE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN55"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_DELETE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN60"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_INSERT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/replication/reorderbuffer.h.html#LN364"><span class='Ref_to_Proto'>ReorderBufferReturnTupleBuf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/replication/reorderbuffer.h.html#LN364"><span class='Ref_to_Proto'>ReorderBufferReturnTupleBuf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN56"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_MESSAGE</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN57"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SNAPSHOT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="reorderbuffer.c.html#LN203"><span class='Ref_to_Proto'>ReorderBufferFreeSnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* no data in addition to the struct itself */ 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN61"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_CONFIRM</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN58"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_COMMAND_ID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch change-&GT;action &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN364"><span class='Ref_to_Parameter'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferReturnChange &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get an unused, possibly preallocated, ReorderBufferTupleBuf fitting at 
 * least a tuple of size tuple_len (excluding header overhead). 
 */ 
</span><a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>* 
</span><a name="LN415"></a><span class='Declare_Function'>ReorderBufferGetTupleBuf</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>tuple_len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN417"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN418"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>alloc_len</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN418"><span class='Ref_To_Local'>alloc_len</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN415"><span class='Ref_to_Parameter'>tuple_len</span></a> <span class='Operator'>+ </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Most tuples are below MaxHeapTupleSize, so we use a slab allocator for 
     * those. Thus always allocate at least MaxHeapTupleSize. Note that tuples 
     * generated for oldtuples can be bigger, as they don't have out-of-line 
     * toast columns. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN418"><span class='Ref_To_Local'>alloc_len</span></a> <span class='Operator'>&LT; </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Parentheses'>) 
</span>        <a href="reorderbuffer.c.html#LN418"><span class='Ref_To_Local'>alloc_len</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* if small enough, check the slab cache */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN418"><span class='Ref_To_Local'>alloc_len</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a> <span class='Operator'>&& </span><a href="reorderbuffer.c.html#LN415"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN350"><span class='Ref_to_Member'>nr_cached_tuplebufs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN415"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN350"><span class='Ref_to_Member'>nr_cached_tuplebufs</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN673"><span class='Ref_to_Macro'>slist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/lib/ilist.h.html#LN594"><span class='Ref_to_Func'>slist_pop_head_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN415"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN349"><span class='Ref_to_Member'>cached_tuplebufs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a> <span class='Operator'>== </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Number'>0xa9</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN35"><span class='Ref_to_Macro'>ReorderBufferTupleBufData</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
        memset<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><span class='Number'>0xa8</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN415"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                               MAXIMUM_ALIGNOF <span class='Operator'>+ </span><a href="reorderbuffer.c.html#LN418"><span class='Ref_To_Local'>alloc_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN418"><span class='Ref_To_Local'>alloc_len</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN35"><span class='Ref_to_Macro'>ReorderBufferTupleBufData</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN417"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferGetTupleBuf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free an ReorderBufferTupleBuf. 
 * 
 * Deallocation might be delayed for efficiency purposes, for details check 
 * the comments above max_cached_changes's definition. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN469"></a><span class='Declare_Function'>ReorderBufferReturnTupleBuf</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* check whether to put into the slab cache, oversized tuples never are */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a> <span class='Operator'>== </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a> <span class='Operator'>&& 
</span>        <a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN350"><span class='Ref_to_Member'>nr_cached_tuplebufs</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN159"><span class='Ref_to_Global_Var'>max_cached_tuplebufs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN350"><span class='Ref_to_Member'>nr_cached_tuplebufs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN572"><span class='Ref_to_Func'>slist_push_head</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN349"><span class='Ref_to_Member'>cached_tuplebufs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN23"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN23"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN23"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN29"><span class='Ref_to_Member'>alloc_tuple_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN469"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return the ReorderBufferTXN from the given buffer, specified by Xid. 
 * If create is true, and a transaction doesn't already exist, create it 
 * (with the given LSN, and as top transaction if that's specified); 
 * when this happens, is_new is set to true. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>* 
</span><a name="LN495"></a><span class='Declare_Function'>ReorderBufferTXNByXid</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create</span><span class='Delimiter'>, 
</span><a name="LN496"></a>                      <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>is_new</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>create_as_top</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN498"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span><a name="LN499"></a>    <a href="reorderbuffer.c.html#LN78"><span class='Ref_to_Struct'>ReorderBufferTXNByIdEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span><a name="LN500"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>|| </span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check the one-entry lookup cache first 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN311"><span class='Ref_to_Member'>by_txn_last_xid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN311"><span class='Ref_to_Member'>by_txn_last_xid</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN312"><span class='Ref_to_Member'>by_txn_last_txn</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* found it, and it's valid */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>is_new</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>is_new</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * cached as non-existent, and asked not to create? Then nothing else 
         * to do. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>create</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* otherwise fall through to create it */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdIsValid(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If the cache wasn't hit or it yielded an "does-not-exist" and we want 
     * to create an entry. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* search the lookup table */ 
</span>    <a href="reorderbuffer.c.html#LN499"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN78"><span class='Ref_to_Struct'>ReorderBufferTXNByIdEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN299"><span class='Ref_to_Member'>by_txn</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, 
</span>                    <a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>? </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a> <span class='Operator'>: </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                    <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN500"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN500"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN499"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN81"><span class='Ref_to_Member'>txn</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>create</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* initialize the new entry, if creation was requested */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN499"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN499"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN81"><span class='Ref_to_Member'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN165"><span class='Ref_to_Proto'>ReorderBufferGetTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN499"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN81"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN499"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN81"><span class='Ref_to_Member'>txn</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN184"><span class='Ref_to_Member'>restart_decoding_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN352"><span class='Ref_to_Member'>current_restart_decoding_lsn</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>create_as_top</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN171"><span class='Ref_to_Proto'>AssertTXNLsnOrder</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* not found and not asked to create */ 
</span> 
    <span class='Comment_Multi_Line'>/* update cache */ 
</span>    <a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN311"><span class='Ref_to_Member'>by_txn_last_xid</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN312"><span class='Ref_to_Member'>by_txn_last_txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>is_new</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN496"><span class='Ref_to_Parameter'>is_new</span></a> <span class='Operator'>= !</span><a href="reorderbuffer.c.html#LN500"><span class='Ref_To_Local'>found</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN495"><span class='Ref_to_Parameter'>create</span></a> <span class='Operator'>|| </span><a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN498"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferTXNByXid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Queue a change into a transaction so it can be replayed upon commit. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN578"></a><span class='Declare_Function'>ReorderBufferQueueChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, 
</span><a name="LN579"></a>                         <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN581"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN581"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN578"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN578"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN578"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN579"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN578"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN578"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN581"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN579"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN581"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN581"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN193"><span class='Ref_to_Proto'>ReorderBufferCheckSerializeTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN578"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN581"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Queue message into a transaction so it can be processed upon commit. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN598"></a><span class='Declare_Function'>ReorderBufferQueueMessage</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN599"></a>                          <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, 
</span><a name="LN600"></a>                          <span class='Keyword'>bool </span><span class='Declare_Parameter'>transactional</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>prefix</span><span class='Delimiter'>, 
</span><a name="LN601"></a>                          <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>message_size</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>message</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN600"><span class='Ref_to_Parameter'>transactional</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN605"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN606"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>xid</span></a> <span class='Operator'>!= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN605"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN345"><span class='Ref_to_Func'>ReorderBufferGetChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN56"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_MESSAGE</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN600"><span class='Ref_to_Parameter'>prefix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN601"><span class='Ref_to_Parameter'>message_size</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN601"><span class='Ref_to_Parameter'>message_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN601"><span class='Ref_to_Parameter'>message</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN601"><span class='Ref_to_Parameter'>message_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/replication/reorderbuffer.h.html#LN368"><span class='Ref_to_Proto'>ReorderBufferQueueChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN599"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN606"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN605"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if transactional &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN625"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN626"></a>        <span class='Keyword'>volatile </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Local'>snapshot_now</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN599"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>xid</span></a> <span class='Operator'>!= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>) 
</span>            <a href="reorderbuffer.c.html#LN625"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN599"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* setup snapshot to allow catalog access */ 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN103"><span class='Ref_to_Proto'>SetupHistoricSnapshot</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN626"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN320"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN598"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN625"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN599"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN600"><span class='Ref_to_Parameter'>prefix</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN601"><span class='Ref_to_Parameter'>message_size</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN601"><span class='Ref_to_Parameter'>message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/snapmgr.h.html#LN104"><span class='Ref_to_Proto'>TeardownHistoricSnapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/snapmgr.h.html#LN104"><span class='Ref_to_Proto'>TeardownHistoricSnapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferQueueMessage &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN650"></a><span class='Declare_Function'>AssertTXNLsnOrder</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
<a name="LN653"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN654"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>prev_first_lsn</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN653"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN650"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN658"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur_txn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN653"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN177"><span class='Ref_to_Member'>end_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a> <span class='Operator'>&LT;= </span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN177"><span class='Ref_to_Member'>end_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN654"><span class='Ref_To_Local'>prev_first_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN654"><span class='Ref_To_Local'>prev_first_lsn</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN654"><span class='Ref_To_Local'>prev_first_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN658"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AssertTXNLsnOrder &raquo; </span> 
 
<a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>* 
</span><a name="LN676"></a><span class='Declare_Function'>ReorderBufferGetOldestTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN678"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN676"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN171"><span class='Ref_to_Proto'>AssertTXNLsnOrder</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN676"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN678"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN486"><span class='Ref_to_Macro'>dlist_head_element</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN676"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN678"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN678"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN678"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN693"></a><span class='Declare_Function'>ReorderBufferSetRestartPoint</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="reorderbuffer.c.html#LN693"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN352"><span class='Ref_to_Member'>current_restart_decoding_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN693"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN699"></a><span class='Declare_Function'>ReorderBufferAssignChild</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN700"></a>                         <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>subxid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN702"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span><a name="LN703"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subtxn</span><span class='Delimiter'>; 
</span><a name="LN704"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_top</span><span class='Delimiter'>; 
</span><a name="LN705"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>new_sub</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN702"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN699"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN699"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN704"><span class='Ref_To_Local'>new_top</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN700"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN699"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN700"><span class='Ref_to_Parameter'>subxid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN705"><span class='Ref_To_Local'>new_sub</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN700"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN705"><span class='Ref_To_Local'>new_sub</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * we assign subtransactions to top level transaction even if we don't 
         * have data for it yet, assignment records frequently reference xids 
         * that have not yet produced any records. Knowing those aren't top 
         * level xids allows us to make processing cheaper in some places. 
         */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN702"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN702"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remove from lsn order list of top-level transactions */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* add to toplevel transaction */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN702"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN703"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN702"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN704"><span class='Ref_To_Local'>new_top</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"existing subxact assigned to unknown toplevel xact"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferAssignChild &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Associate a subtransaction with its toplevel transaction at commit 
 * time. There may be no further changes added after this. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN744"></a><span class='Declare_Function'>ReorderBufferCommitChild</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN745"></a>                         <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>subxid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>commit_lsn</span><span class='Delimiter'>, 
</span><a name="LN746"></a>                         <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>end_lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN748"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span><a name="LN749"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subtxn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN744"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN745"><span class='Ref_to_Parameter'>subxid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                   <a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need to do anything if that subtxn didn't contain any changes 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN744"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN744"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN745"><span class='Ref_to_Parameter'>commit_lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"subxact logged without previous toplevel record"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Pass our base snapshot to the parent transaction if it doesn't have 
     * one, or ours is older. That can happen if there are no changes in the 
     * toplevel transaction but in one of the child transactions. This allows 
     * the parent to simply use its base snapshot initially. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>         <a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a> <span class='Operator'>&GT; </span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN745"><span class='Ref_to_Parameter'>commit_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN177"><span class='Ref_to_Member'>end_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN746"><span class='Ref_to_Parameter'>end_lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remove from lsn order list of top-level transactions */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* add to subtransaction list */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN749"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN748"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferCommitChild &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Support for efficiently iterating over a transaction's and its 
 * subtransactions' changes. 
 * 
 * We do by doing a k-way merge between transactions/subtransactions. For that 
 * we model the current heads of the different transactions as a binary heap 
 * so we easily know which (sub-)transaction has the change with the smallest 
 * lsn next. 
 * 
 * We assume the changes in individual transactions are already sorted by LSN. 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Binary heap comparison function. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN815"></a><span class='Declare_Function'>ReorderBufferIterCompare</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>b</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN817"></a>    <a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN815"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span><a name="LN818"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>pos_a</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN817"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN815"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN102"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span><a name="LN819"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>pos_b</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN817"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN815"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN102"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN818"><span class='Ref_To_Local'>pos_a</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN819"><span class='Ref_To_Local'>pos_b</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN818"><span class='Ref_To_Local'>pos_a</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN819"><span class='Ref_To_Local'>pos_b</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Allocate & initialize an iterator which iterates in lsn order over a 
 * transaction and all its subtransactions. 
 */ 
</span><span class='Keyword'>static </span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>* 
</span><a name="LN833"></a><span class='Declare_Function'>ReorderBufferIterTXNInit</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN835"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nr_txns</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN836"></a>    <a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN837"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>cur_txn_i</span><span class='Delimiter'>; 
</span><a name="LN838"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate the size of our heap: one element for every transaction that 
     * contains changes.  (Besides the transactions already in the reorder 
     * buffer, we count the one we were directly passed.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="reorderbuffer.c.html#LN835"><span class='Ref_To_Local'>nr_txns</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN837"><span class='Ref_To_Local'>cur_txn_i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN850"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur_txn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN850"><span class='Ref_To_Local'>cur_txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN837"><span class='Ref_To_Local'>cur_txn_i</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN850"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="reorderbuffer.c.html#LN835"><span class='Ref_To_Local'>nr_txns</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * TODO: Consider adding fastpath for the rather common nr_txns=1 case, no 
     * need to allocate/build a heap then. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* allocate iteration state */ 
</span>    <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN100"><span class='Ref_to_Struct'>ReorderBufferIterTXNEntry</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN835"><span class='Ref_To_Local'>nr_txns</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN112"><span class='Ref_to_Member'>nr_txns</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN835"><span class='Ref_To_Local'>nr_txns</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN112"><span class='Ref_to_Member'>nr_txns</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN105"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN106"><span class='Ref_to_Member'>segno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* allocate heap */ 
</span>    <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a> <span class='Operator'>= </span><a href="../../lib/binaryheap.c.html#LN31"><span class='Ref_to_Func'>binaryheap_allocate</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN112"><span class='Ref_to_Member'>nr_txns</span></a><span class='Delimiter'>, 
</span>                                      <a href="reorderbuffer.c.html#LN814"><span class='Ref_to_Func'>ReorderBufferIterCompare</span></a><span class='Delimiter'>, 
</span>                                      <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now insert items into the binary heap, in an unordered fashion.  (We 
     * will run a heap assembly step at the end; this is more efficient.) 
     */ 
</span> 
    <a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* add toplevel transaction if it contains changes */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN893"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur_change</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* serialize remaining changes */ 
</span>            <a href="reorderbuffer.c.html#LN194"><span class='Ref_to_Proto'>ReorderBufferSerializeTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN197"><span class='Ref_to_Proto'>ReorderBufferRestoreChanges</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN105"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN106"><span class='Ref_to_Member'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="reorderbuffer.c.html#LN893"><span class='Ref_To_Local'>cur_change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN486"><span class='Ref_to_Macro'>dlist_head_element</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN102"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN893"><span class='Ref_To_Local'>cur_change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN103"><span class='Ref_to_Member'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN893"><span class='Ref_To_Local'>cur_change</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/lib/binaryheap.h.html#LN44"><span class='Ref_to_Proto'>binaryheap_add_unordered</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if txn-&GT;nentries&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* add subtransactions if they contain changes */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN837"><span class='Ref_To_Local'>cur_txn_i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN916"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur_txn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN837"><span class='Ref_To_Local'>cur_txn_i</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN922"></a>            <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cur_change</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* serialize remaining changes */ 
</span>                <a href="reorderbuffer.c.html#LN194"><span class='Ref_to_Proto'>ReorderBufferSerializeTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN197"><span class='Ref_to_Proto'>ReorderBufferRestoreChanges</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN833"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Delimiter'>, 
</span>                                            <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN105"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, 
</span>                                            <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN106"><span class='Ref_to_Member'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="reorderbuffer.c.html#LN922"><span class='Ref_To_Local'>cur_change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN486"><span class='Ref_to_Macro'>dlist_head_element</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                            <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN102"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN922"><span class='Ref_To_Local'>cur_change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN103"><span class='Ref_to_Member'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN922"><span class='Ref_To_Local'>cur_change</span></a><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN916"><span class='Ref_To_Local'>cur_txn</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/lib/binaryheap.h.html#LN44"><span class='Ref_to_Proto'>binaryheap_add_unordered</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN838"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_txn-&GT;nentries&GT;0 &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* assemble a valid binary heap */ 
</span>    <a href="../../../include/lib/binaryheap.h.html#LN45"><span class='Ref_to_Proto'>binaryheap_build</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN836"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferIterTXNInit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return the next change when iterating over a transaction and its 
 * subtransactions. 
 * 
 * Returns NULL when no further changes exist. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>* 
</span><a name="LN956"></a><span class='Declare_Function'>ReorderBufferIterTXNNext</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN958"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span><a name="LN959"></a>    <a href="reorderbuffer.c.html#LN100"><span class='Ref_to_Struct'>ReorderBufferIterTXNEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN960"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* nothing there anymore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/binaryheap.h.html#LN31"><span class='Ref_to_Member'>bh_size</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="../../../include/lib/binaryheap.h.html#LN47"><span class='Ref_to_Proto'>binaryheap_first</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= &</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* free memory we might have "leaked" in the previous *Next call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/lib/ilist.h.html#LN366"><span class='Ref_to_Func'>dlist_pop_head_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN103"><span class='Ref_to_Member'>change</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * update heap with information about which transaction has the next 
     * relevant change in LSN order 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* there are in-memory changes */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN400"><span class='Ref_to_Func'>dlist_has_next</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN103"><span class='Ref_to_Member'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN988"></a>        <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN419"><span class='Ref_to_Func'>dlist_next_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN989"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next_change</span> <span class='Operator'>= 
</span>        <a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN988"><span class='Ref_To_Local'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* txn stays the same */ 
</span>        <a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN102"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN989"><span class='Ref_To_Local'>next_change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN103"><span class='Ref_to_Member'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN989"><span class='Ref_To_Local'>next_change</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/lib/binaryheap.h.html#LN49"><span class='Ref_to_Proto'>binaryheap_replace_first</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* try to load changes from disk */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Ugly: restoring changes will reuse *Change records, thus delete the 
         * current one from the per-tx list and only free in the next call. 
         */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN197"><span class='Ref_to_Proto'>ReorderBufferRestoreChanges</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN105"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN106"><span class='Ref_to_Member'>segno</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* successfully restored changes from disk */ 
</span><a name="LN1014"></a>            <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next_change</span> <span class='Operator'>= 
</span>            <a href="../../../include/lib/ilist.h.html#LN486"><span class='Ref_to_Macro'>dlist_head_element</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"restored %u/%u changes from disk"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN959"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN104"><span class='Ref_to_Member'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* txn stays the same */ 
</span>            <a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN102"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1014"><span class='Ref_To_Local'>next_change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN103"><span class='Ref_to_Member'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1014"><span class='Ref_To_Local'>next_change</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/lib/binaryheap.h.html#LN49"><span class='Ref_to_Proto'>binaryheap_replace_first</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN960"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ReorderBufferRestoreC... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if entry-&GT;txn-&GT;nentries!... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* ok, no changes there anymore, remove */ 
</span>    <a href="../../../include/lib/binaryheap.h.html#LN48"><span class='Ref_to_Proto'>binaryheap_remove_first</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN956"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN958"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferIterTXNNext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Deallocate the iterator 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1042"></a><span class='Declare_Function'>ReorderBufferIterTXNFinish</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, 
</span><a name="LN1043"></a>                           <a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1045"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1045"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN1045"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN112"><span class='Ref_to_Member'>nr_txns</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN1045"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN1045"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN105"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN114"><span class='Ref_to_Member'>entries</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN1045"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN105"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* free memory we might have "leaked" in the last *Next call */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1056"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1056"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/lib/ilist.h.html#LN366"><span class='Ref_to_Func'>dlist_pop_head_node</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1042"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1056"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN113"><span class='Ref_to_Member'>old_change</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/lib/binaryheap.h.html#LN43"><span class='Ref_to_Proto'>binaryheap_free</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN111"><span class='Ref_to_Member'>heap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1043"><span class='Ref_to_Parameter'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferIterTXNFinish &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Cleanup the contents of a transaction, usually after the transaction 
 * committed or aborted. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1073"></a><span class='Declare_Function'>ReorderBufferCleanupTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1075"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN1076"></a>    <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* cleanup subtransactions & their changes */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1076"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1081"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subtxn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1081"><span class='Ref_To_Local'>subtxn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1076"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Subtransactions are always associated to the toplevel TXN, even if 
         * they originally were happening inside another subtxn, so we won't 
         * ever recurse more than one level deep here. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1081"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN152"><span class='Ref_to_Member'>is_known_as_subxact</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1081"><span class='Ref_To_Local'>subtxn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1081"><span class='Ref_To_Local'>subtxn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* cleanup changes in the toplevel txn */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1076"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1099"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1099"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1076"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1099"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Cleanup the tuplecids we stored for decoding catalog snapshot access. 
     * They are always stored in the toplevel transaction. 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1076"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN225"><span class='Ref_to_Member'>tuplecids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1112"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1112"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1076"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1112"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1112"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/replication/snapbuild.h.html#LN66"><span class='Ref_to_Proto'>SnapBuildSnapDecRefcount</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove TXN from its containing list. 
     * 
     * Note: if txn-&GT;is_known_as_subxact, we are deleting the TXN from its 
     * parent's list of known subxacts; this leaves the parent's nsubxacts 
     * count too high, but we don't care.  Otherwise, we are deleting the TXN 
     * from the LSN-ordered list of toplevel TXNs. 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN260"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now remove reference from buffer */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN299"><span class='Ref_to_Member'>by_txn</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, 
</span>                <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1075"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1075"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* remove entries spilled to disk */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN206"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Parentheses'>) 
</span>        <a href="reorderbuffer.c.html#LN201"><span class='Ref_to_Proto'>ReorderBufferRestoreCleanup</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* deallocate */ 
</span>    <a href="reorderbuffer.c.html#LN166"><span class='Ref_to_Proto'>ReorderBufferReturnTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1073"><span class='Ref_to_Parameter'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferCleanupTXN &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build a hash with a (relfilenode, ctid) -&GT; (cmin, cmax) mapping for use by 
 * tqual.c's HeapTupleSatisfiesHistoricMVCC. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1156"></a><span class='Declare_Function'>ReorderBufferBuildTupleCidHash</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1158"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN1159"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN147"><span class='Ref_to_Member'>has_catalog_changes</span></a> <span class='Operator'>|| </span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN225"><span class='Ref_to_Member'>tuplecids</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1159"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1159"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1159"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1159"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1159"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * create the hash with the exact number of to-be-stored tuplecids from 
     * the start 
     */ 
</span>    <a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"ReorderBufferTupleCid"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN226"><span class='Ref_to_Member'>ntuplecids</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1159"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1158"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN225"><span class='Ref_to_Member'>tuplecids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1180"></a>        <a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN1181"></a>        <a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span><a name="LN1182"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN1183"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1158"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* be careful about padding */ 
</span>        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1180"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1180"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>node<span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>tid<span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1180"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN88"><span class='Ref_to_Member'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1156"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1180"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1182"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN1182"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmin<span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmax<span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN96"><span class='Ref_to_Member'>combocid</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>combocid<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmin<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a> <span class='Operator'>|| 
</span>                   <a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmax<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * if the tuple got valid in this transaction and now got deleted 
             * we already have a valid cmin stored. The cmax will be 
             * InvalidCommandId though. 
             */ 
</span>            <a href="reorderbuffer.c.html#LN1181"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1183"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmax<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferBuildTupleCidHash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Copy a provided snapshot so we can modify it privately. This is needed so 
 * that catalog modifying transactions can look into intermediate catalog 
 * states. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN1230"></a><span class='Declare_Function'>ReorderBufferCopySnap</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>orig_snap</span><span class='Delimiter'>, 
</span><a name="LN1231"></a>                      <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1233"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snap</span><span class='Delimiter'>; 
</span><a name="LN1234"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN1235"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1236"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1236"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN1230"><span class='Ref_to_Parameter'>orig_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1231"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN244"><span class='Ref_to_Member'>nsubtxns</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1230"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1236"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1230"><span class='Ref_to_Parameter'>orig_snap</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* mark as active so nobody frees it */ 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1230"><span class='Ref_to_Parameter'>orig_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * snap-&GT;subxip contains all txids that belong to our transaction which we 
     * need to check via cmin/cmax. That's why we store the toplevel 
     * transaction in there as well. 
     */ 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>+ </span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN1235"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1231"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * nsubxcnt isn't decreased when subtransactions abort, so count manually. 
     * Since it's an upper boundary it is safe to use it for the allocation 
     * above. 
     */ 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1234"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1231"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1269"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>sub_txn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1269"><span class='Ref_To_Local'>sub_txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1234"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN1235"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1269"><span class='Ref_To_Local'>sub_txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* sort so we can bsearch() later */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN94"><span class='Ref_to_Proto'>xidComparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* store the specified current CommandId */ 
</span>    <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1231"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN1233"><span class='Ref_To_Local'>snap</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferCopySnap &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free a previously ReorderBufferCopySnap'ed snapshot 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1289"></a><span class='Declare_Function'>ReorderBufferFreeSnap</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1289"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1289"><span class='Ref_to_Parameter'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/replication/snapbuild.h.html#LN66"><span class='Ref_to_Proto'>SnapBuildSnapDecRefcount</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1289"><span class='Ref_to_Parameter'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Perform the replay of a transaction and it's non-aborted subtransactions. 
 * 
 * Subtransactions previously have to be processed by 
 * ReorderBufferCommitChild(), even if previously assigned to the toplevel 
 * transaction with ReorderBufferAssignChild. 
 * 
 * We currently can only decode a transaction's contents in when their commit 
 * record is read because that's currently the only place where we know about 
 * cache invalidations. Thus, once a toplevel commit is read, we iterate over 
 * the top and subtransactions (using a k-way merge) and replay the changes in 
 * lsn order. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1311"></a><span class='Declare_Function'>ReorderBufferCommit</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1312"></a>                    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>commit_lsn</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>end_lsn</span><span class='Delimiter'>, 
</span><a name="LN1313"></a>                    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>commit_time</span><span class='Delimiter'>, 
</span><a name="LN1314"></a>                    <a href="../../../include/access/xlogdefs.h.html#LN50"><span class='Ref_to_Typedef'>RepOriginId</span></a> <span class='Declare_Parameter'>origin_id</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>origin_lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1316"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span><a name="LN1317"></a>    <span class='Keyword'>volatile </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Local'>snapshot_now</span><span class='Delimiter'>; 
</span><a name="LN1318"></a>    <span class='Keyword'>volatile </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Local'>command_id</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Delimiter'>; 
</span><a name="LN1319"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>using_subtxn</span><span class='Delimiter'>; 
</span><a name="LN1320"></a>    <a href="reorderbuffer.c.html#LN109"><span class='Ref_to_Struct'>ReorderBufferIterTXNState</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>iterstate</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* unknown transaction, nothing to replay */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1312"><span class='Ref_to_Parameter'>commit_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN177"><span class='Ref_to_Member'>end_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1312"><span class='Ref_to_Parameter'>end_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN193"><span class='Ref_to_Member'>commit_time</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1313"><span class='Ref_to_Parameter'>commit_time</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN187"><span class='Ref_to_Member'>origin_id</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1314"><span class='Ref_to_Parameter'>origin_id</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN188"><span class='Ref_to_Member'>origin_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1314"><span class='Ref_to_Parameter'>origin_lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this transaction didn't have any real changes in our database, it's 
     * OK not to have a snapshot. Note that ReorderBufferCommitChild will have 
     * transferred its snapshot to this transaction if it had one and the 
     * toplevel tx didn't. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* build data to be able to lookup the CommandIds of catalog tuples */ 
</span>    <a href="reorderbuffer.c.html#LN1155"><span class='Ref_to_Func'>ReorderBufferBuildTupleCidHash</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* setup the initial snapshot */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN103"><span class='Ref_to_Proto'>SetupHistoricSnapshot</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decoding needs access to syscaches et al., which in turn use 
     * heavyweight locks and such. Thus we need to have enough state around to 
     * keep track of those.  The easiest way is to simply use a transaction 
     * internally.  That also allows us to easily enforce that nothing writes 
     * to the database by checking for xid assignments. 
     * 
     * When we're called via the SQL SRF there's already a transaction 
     * started, so start an explicit subtransaction there. 
     */ 
</span>    <a href="reorderbuffer.c.html#LN1319"><span class='Ref_To_Local'>using_subtxn</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN367"><span class='Ref_to_Proto'>IsTransactionOrTransactionBlock</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1370"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span><a name="LN1371"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>specinsert</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1319"><span class='Ref_To_Local'>using_subtxn</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='String'>"replay"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN317"><span class='Ref_to_Member'>begin</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1320"><span class='Ref_To_Local'>iterstate</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN181"><span class='Ref_to_Proto'>ReorderBufferIterTXNInit</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN182"><span class='Ref_to_Proto'>ReorderBufferIterTXNNext</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1320"><span class='Ref_To_Local'>iterstate</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1383"></a>            <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>relation</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1384"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>reloid</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN61"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_CONFIRM</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Confirmation for speculative insertion arrived. Simply 
                     * use as a normal record. It'll be cleaned up at the end 
                     * of INSERT processing. 
                     */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN53"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INSERT</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* intentionally fall through */ 
</span>                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN53"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INSERT</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN54"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_UPDATE</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN55"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_DELETE</span></a><span class='Operator'>: 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="reorderbuffer.c.html#LN1384"><span class='Ref_To_Local'>reloid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relfilenodemap.h.html#LN15"><span class='Ref_to_Proto'>RelidByRelfilenode</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>relnode<span class='Operator'>.</span>spcNode<span class='Delimiter'>, 
</span>                                            <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>relnode<span class='Operator'>.</span>relNode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Catalog tuple without data, emitted while catalog was 
                     * in the process of being rewritten. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1384"><span class='Ref_To_Local'>reloid</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>&& 
</span>                        <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                        <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="reorderbuffer.c.html#LN1471"><span class='Ref_to_Label'>change_done</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1384"><span class='Ref_To_Local'>reloid</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not map filenode \"%s\" to relation OID"</span><span class='Delimiter'>, 
</span>                             <a href="../../../include/common/relpath.h.html#LN66"><span class='Ref_to_Macro'>relpathperm</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>relnode<span class='Delimiter'>, 
</span>                                         <a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                    <a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN33"><span class='Ref_to_Proto'>RelationIdGetRelation</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1384"><span class='Ref_To_Local'>reloid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not open relation with OID %u (for filenode \"%s\")"</span><span class='Delimiter'>, 
</span>                             <a href="reorderbuffer.c.html#LN1384"><span class='Ref_To_Local'>reloid</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/common/relpath.h.html#LN66"><span class='Ref_to_Macro'>relpathperm</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>relnode<span class='Delimiter'>, 
</span>                                         <a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/rel.h.html#LN575"><span class='Ref_to_Macro'>RelationIsLogicallyLogged</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Parentheses'>))</span> 
                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="reorderbuffer.c.html#LN1471"><span class='Ref_to_Label'>change_done</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * For now ignore sequence changes entirely. Most of the 
                     * time they don't log changes using records we 
                     * understand, so it doesn't make sense to handle the few 
                     * cases we do. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN161"><span class='Ref_to_Const'>RELKIND_SEQUENCE</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="reorderbuffer.c.html#LN1471"><span class='Ref_to_Label'>change_done</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* user-triggered change */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/catalog/catalog.h.html#LN30"><span class='Ref_to_Proto'>IsToastRelation</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN213"><span class='Ref_to_Proto'>ReorderBufferToastReplace</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN318"><span class='Ref_to_Member'>apply_change</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * Only clear reassembled toast chunks if we're sure 
                         * they're not required anymore. The creator of the 
                         * tuple tells us. 
                         */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>clear_toast_afterwards<span class='Parentheses'>) 
</span>                            <a href="reorderbuffer.c.html#LN212"><span class='Ref_to_Proto'>ReorderBufferToastReset</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Comment_Multi_Line'>/* we're not interested in toast deletions */ 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../../include/replication/reorderbuffer.h.html#LN53"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INSERT</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * Need to reassemble the full toasted Datum in 
                         * memory, to ensure the chunks don't get reused till 
                         * we're done remove it from the list of this 
                         * transaction's changes. Otherwise it will get 
                         * freed/reused while restoring spooled data from 
                         * disk. 
                         */ 
</span>                        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="reorderbuffer.c.html#LN215"><span class='Ref_to_Proto'>ReorderBufferToastAppendChunk</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Delimiter'>, 
</span>                                                      <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
<a name="LN1471"></a>            <span class='Label'>change_done</span><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Either speculative insertion was confirmed, or it was 
                     * unsuccessful and the record isn't needed anymore. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/utils/relcache.h.html#LN34"><span class='Ref_to_Proto'>RelationClose</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="reorderbuffer.c.html#LN1383"><span class='Ref_To_Local'>relation</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN60"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_INSERT</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Speculative insertions are dealt with by delaying the 
                     * processing of the insert until the confirmation record 
                     * arrives. For that we simply unlink the record from the 
                     * chain, so it does not get freed/reused while restoring 
                     * spooled data from disk. 
                     * 
                     * This is safe in the face of concurrent catalog changes 
                     * because the relevant relation can't be changed between 
                     * speculative insertion and confirmation due to 
                     * CheckTableNotInUse() and locking. 
                     */ 
</span> 
                    <span class='Comment_Multi_Line'>/* clear out a pending (and thus failed) speculation */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* and memorize the pending insertion */ 
</span>                    <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN56"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_MESSAGE</span></a><span class='Operator'>: 
</span>                    <a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN320"><span class='Ref_to_Member'>message</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix<span class='Delimiter'>, 
</span>                                <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Delimiter'>, 
</span>                                <a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN57"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SNAPSHOT</span></a><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* get rid of the old */ 
</span>                    <a href="../../../include/utils/snapmgr.h.html#LN104"><span class='Ref_to_Proto'>TeardownHistoricSnapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN203"><span class='Ref_to_Proto'>ReorderBufferFreeSnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a> <span class='Operator'>= 
</span>                            <a href="reorderbuffer.c.html#LN204"><span class='Ref_to_Proto'>ReorderBufferCopySnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Delimiter'>, 
</span>                                                  <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1318"><span class='Ref_To_Local'>command_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Restored from disk, need to be careful not to double 
                     * free. We could introduce refcounting for that, but for 
                     * now this seems infrequent enough not to care. 
                     */ 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Operator'>-&GT;</span>copied<span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a> <span class='Operator'>= 
</span>                            <a href="reorderbuffer.c.html#LN204"><span class='Ref_to_Proto'>ReorderBufferCopySnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Delimiter'>, 
</span>                                                  <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1318"><span class='Ref_To_Local'>command_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
 
                    <span class='Comment_Multi_Line'>/* and continue with the new one */ 
</span>                    <a href="../../../include/utils/snapmgr.h.html#LN103"><span class='Ref_to_Proto'>SetupHistoricSnapshot</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN58"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_COMMAND_ID</span></a><span class='Operator'>: 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>command_id <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1318"><span class='Ref_To_Local'>command_id</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>command_id<span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="reorderbuffer.c.html#LN1318"><span class='Ref_To_Local'>command_id</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1370"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>command_id<span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>                        <span class='Delimiter'>{ 
</span>                            <span class='Comment_Multi_Line'>/* we don't use the global one anymore */ 
</span>                            <a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN204"><span class='Ref_to_Proto'>ReorderBufferCopySnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Delimiter'>, 
</span>                                                            <a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1318"><span class='Ref_To_Local'>command_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span> 
                        <a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1318"><span class='Ref_To_Local'>command_id</span></a><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/utils/snapmgr.h.html#LN104"><span class='Ref_to_Proto'>TeardownHistoricSnapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/utils/snapmgr.h.html#LN103"><span class='Ref_to_Proto'>SetupHistoricSnapshot</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN231"><span class='Ref_to_Member'>tuplecid_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * Every time the CommandId is incremented, we could 
                         * see new catalog contents, so execute all 
                         * invalidations. 
                         */ 
</span>                        <a href="reorderbuffer.c.html#LN186"><span class='Ref_to_Proto'>ReorderBufferExecuteInvalidations</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if command_id&LT;change-&GT;da... &raquo; </span> 
 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Operator'>: 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"tuplecid value in changequeue"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch change-&GT;action &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (change=ReorderBuffer... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * There's a speculative insertion remaining, just clean in up, it 
         * can't have been successful, otherwise we'd gotten a confirmation 
         * record. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN1371"><span class='Ref_To_Local'>specinsert</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* clean up the iterator */ 
</span>        <a href="reorderbuffer.c.html#LN184"><span class='Ref_to_Proto'>ReorderBufferIterTXNFinish</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1320"><span class='Ref_To_Local'>iterstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN1320"><span class='Ref_To_Local'>iterstate</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* call commit callback */ 
</span>        <a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN319"><span class='Ref_to_Member'>commit</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1312"><span class='Ref_to_Parameter'>commit_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* this is just a sanity check against bad output plugin behaviour */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN334"><span class='Ref_to_Proto'>GetCurrentTransactionIdIfAny</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"output plugin used XID %u"</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/access/xact.h.html#LN333"><span class='Ref_to_Proto'>GetCurrentTransactionId</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* cleanup */ 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN104"><span class='Ref_to_Proto'>TeardownHistoricSnapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Aborting the current (sub-)transaction as a whole has the right 
         * semantics. We want all locks acquired in here to be released, not 
         * reassigned to the parent and we do not want any database access 
         * have persistent effects. 
         */ 
</span>        <a href="../../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* make sure there's no cache pollution */ 
</span>        <a href="reorderbuffer.c.html#LN186"><span class='Ref_to_Proto'>ReorderBufferExecuteInvalidations</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1319"><span class='Ref_To_Local'>using_subtxn</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>            <a href="reorderbuffer.c.html#LN203"><span class='Ref_to_Proto'>ReorderBufferFreeSnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remove potential on-disk data, and deallocate */ 
</span>        <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* TODO: Encapsulate cleanup from the PG_TRY and PG_CATCH blocks */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1320"><span class='Ref_To_Local'>iterstate</span></a><span class='Parentheses'>) 
</span>            <a href="reorderbuffer.c.html#LN184"><span class='Ref_to_Proto'>ReorderBufferIterTXNFinish</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1320"><span class='Ref_To_Local'>iterstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/snapmgr.h.html#LN104"><span class='Ref_to_Proto'>TeardownHistoricSnapshot</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Force cache invalidation to happen outside of a valid transaction 
         * to prevent catalog access as we just caught an error. 
         */ 
</span>        <a href="../../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* make sure there's no cache pollution */ 
</span>        <a href="reorderbuffer.c.html#LN186"><span class='Ref_to_Proto'>ReorderBufferExecuteInvalidations</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1319"><span class='Ref_To_Local'>using_subtxn</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>            <a href="reorderbuffer.c.html#LN203"><span class='Ref_to_Proto'>ReorderBufferFreeSnap</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1317"><span class='Ref_To_Local'>snapshot_now</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remove potential on-disk data, and deallocate */ 
</span>        <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1311"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1316"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferCommit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Abort a transaction that possibly has previous changes. Needs to be first 
 * called for subtransactions and then for the toplevel xid. 
 * 
 * NB: Transactions handled here have to have actively aborted (i.e. have 
 * produced an abort record). Implicitly aborted transactions are handled via 
 * ReorderBufferAbortOld(); transactions we're just not interested in, but 
 * which have committed are handled in ReorderBufferForget(). 
 * 
 * This function purges this transaction and its contents from memory and 
 * disk. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1682"></a><span class='Declare_Function'>ReorderBufferAbort</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1684"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1684"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1682"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1682"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* unknown, nothing to remove */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1684"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* cosmetic... */ 
</span>    <a href="reorderbuffer.c.html#LN1684"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1682"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* remove potential on-disk data, and deallocate */ 
</span>    <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1682"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1684"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Abort all transactions that aren't actually running anymore because the 
 * server restarted. 
 * 
 * NB: These really have to be transactions that have aborted due to a server 
 * crash/immediate restart, as we don't deal with invalidations here. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1708"></a><span class='Declare_Function'>ReorderBufferAbortOld</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>oldestRunningXid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1710"></a>    <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Iterate through all (potential) toplevel TXNs and abort all that are 
     * older than what possibly can be running. Once we've found the first 
     * that is alive we stop, there might be some that acquired an xid earlier 
     * but started writing later, but it's unlikely and they will cleaned up 
     * in a later call to ReorderBufferAbortOld(). 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1710"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1708"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1721"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN1721"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1710"><span class='Ref_To_Local'>it</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1721"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1708"><span class='Ref_to_Parameter'>oldestRunningXid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"aborting old transaction %u"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1721"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* remove potential on-disk data, and deallocate this tx */ 
</span>            <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1708"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1721"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferAbortOld &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Forget the contents of a transaction if we aren't interested in it's 
 * contents. Needs to be first called for subtransactions and then for the 
 * toplevel xid. 
 * 
 * This is significantly different to ReorderBufferAbort() because 
 * transactions that have committed need to be treated differently from aborted 
 * ones since they may have modified the catalog. 
 * 
 * Note that this is only allowed to be called in the moment a transaction 
 * commit has just been read, not earlier; otherwise later records referring 
 * to this xid might re-create the transaction incompletely. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1751"></a><span class='Declare_Function'>ReorderBufferForget</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1753"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1751"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1751"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* unknown, nothing to forget */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* cosmetic... */ 
</span>    <a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1751"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Process cache invalidation messages if there are any. Even if we're not 
     * interested in the transaction's contents, it could have manipulated the 
     * catalog and we need to update the caches according to that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/replication/reorderbuffer.h.html#LN391"><span class='Ref_to_Proto'>ReorderBufferImmediateInvalidation</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1751"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a><span class='Delimiter'>, 
</span>                                           <a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* remove potential on-disk data, and deallocate */ 
</span>    <a href="reorderbuffer.c.html#LN1072"><span class='Ref_to_Func'>ReorderBufferCleanupTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1751"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1753"><span class='Ref_To_Local'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferForget &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Execute invalidations happening outside the context of a decoded 
 * transaction. That currently happens either for xid-less commits 
 * (c.f. RecordTransactionCommit()) or for invalidations in uninteresting 
 * transactions (via ReorderBufferForget()). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1787"></a><span class='Declare_Function'>ReorderBufferImmediateInvalidation</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>ninvalidations</span><span class='Delimiter'>, 
</span><a name="LN1788"></a>                                   <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>invalidations</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1790"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>use_subtxn</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN367"><span class='Ref_to_Proto'>IsTransactionOrTransactionBlock</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1791"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1790"><span class='Ref_To_Local'>use_subtxn</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xact.h.html#LN358"><span class='Ref_to_Proto'>BeginInternalSubTransaction</span></a><span class='Parentheses'>(</span><span class='String'>"replay"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Force invalidations to happen outside of a valid transaction - that way 
     * entries will just be marked as invalid without accessing the catalog. 
     * That's advantageous because we don't need to setup the full state 
     * necessary for catalog access. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1790"><span class='Ref_To_Local'>use_subtxn</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1791"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN1791"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN1787"><span class='Ref_to_Parameter'>ninvalidations</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN1791"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/sinval.h.html#LN151"><span class='Ref_to_Proto'>LocalExecuteInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1788"><span class='Ref_to_Parameter'>invalidations</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN1791"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1790"><span class='Ref_To_Local'>use_subtxn</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xact.h.html#LN360"><span class='Ref_to_Proto'>RollbackAndReleaseCurrentSubTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferImmediateInvalidation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Tell reorderbuffer about an xid seen in the WAL stream. Has to be called at 
 * least once for every xid in XLogRecord-&GT;xl_xid (other places in records 
 * may, but do not have to be passed through here). 
 * 
 * Reorderbuffer keeps some datastructures about transactions in LSN order, 
 * for efficiency. To do that it has to know about when transactions are seen 
 * first in the WAL. As many types of records are not actually interesting for 
 * logical decoding, they do not necessarily pass though here. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1823"></a><span class='Declare_Function'>ReorderBufferProcessXid</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* many records won't have an xid assigned, centralize check here */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1823"><span class='Ref_to_Parameter'>xid</span></a> <span class='Operator'>!= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>) 
</span>        <a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1823"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1823"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1823"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add a new snapshot to this transaction that may only used after lsn 'lsn' 
 * because the previous snapshot doesn't describe the catalog correctly for 
 * following rows. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1836"></a><span class='Declare_Function'>ReorderBufferAddSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1837"></a>                         <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1839"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN345"><span class='Ref_to_Func'>ReorderBufferGetChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1836"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1839"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1837"><span class='Ref_to_Parameter'>snap</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1839"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN57"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SNAPSHOT</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/reorderbuffer.h.html#LN368"><span class='Ref_to_Proto'>ReorderBufferQueueChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1836"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1836"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1837"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1839"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Setup the base snapshot of a transaction. The base snapshot is the snapshot 
 * that is used to decode all changes until either this transaction modifies 
 * the catalog or another catalog modifying transaction commits. 
 * 
 * Needs to be called before any changes are added with 
 * ReorderBufferQueueChange(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1856"></a><span class='Declare_Function'>ReorderBufferSetBaseSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1857"></a>                             <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1859"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span><a name="LN1860"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_new</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1859"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1856"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1856"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1860"><span class='Ref_To_Local'>is_new</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1857"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1859"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1857"><span class='Ref_to_Parameter'>snap</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1859"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1857"><span class='Ref_to_Parameter'>snap</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1859"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN199"><span class='Ref_to_Member'>base_snapshot_lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1857"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Access the catalog with this CommandId at this point in the changestream. 
 * 
 * May only be called for command ids &GT; 1 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1876"></a><span class='Declare_Function'>ReorderBufferAddNewCommandId</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1877"></a>                             <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1879"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN345"><span class='Ref_to_Func'>ReorderBufferGetChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1876"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1879"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>command_id <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1877"><span class='Ref_to_Parameter'>cid</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1879"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN58"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_COMMAND_ID</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/reorderbuffer.h.html#LN368"><span class='Ref_to_Proto'>ReorderBufferQueueChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1876"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1876"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1877"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1879"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add new (relfilenode, tid) -&GT; (cmin, cmax) mappings. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1892"></a><span class='Declare_Function'>ReorderBufferAddNewTupleCids</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1893"></a>                             <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>node</span><span class='Delimiter'>, 
</span><a name="LN1894"></a>                             <a href="../../../include/storage/itemptr.h.html#LN35"><span class='Ref_to_Struct'>ItemPointerData</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cmin</span><span class='Delimiter'>, 
</span><a name="LN1895"></a>                             <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>cmax</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>combocid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1897"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN345"><span class='Ref_to_Func'>ReorderBufferGetChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1892"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1898"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1898"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1892"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1892"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1893"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>node <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1893"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>tid <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1894"><span class='Ref_to_Parameter'>tid</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmin <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1894"><span class='Ref_to_Parameter'>cmin</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>cmax <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1895"><span class='Ref_to_Parameter'>cmax</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tuplecid<span class='Operator'>.</span>combocid <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1895"><span class='Ref_to_Parameter'>combocid</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1893"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1898"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN225"><span class='Ref_to_Member'>tuplecids</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1897"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1898"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN226"><span class='Ref_to_Member'>ntuplecids</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferAddNewTupleCids &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Setup the invalidation of the toplevel transaction. 
 * 
 * This needs to be done before ReorderBufferCommit is called! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1920"></a><span class='Declare_Function'>ReorderBufferAddInvalidations</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1921"></a>                              <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>nmsgs</span><span class='Delimiter'>, 
</span><a name="LN1922"></a>                              <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msgs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1924"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1924"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1920"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1920"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1921"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1924"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"only ever add one set of invalidations"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1921"><span class='Ref_to_Parameter'>nmsgs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1924"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN1921"><span class='Ref_to_Parameter'>nmsgs</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN1924"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1920"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN1921"><span class='Ref_to_Parameter'>nmsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1924"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1922"><span class='Ref_to_Parameter'>msgs</span></a><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN1921"><span class='Ref_to_Parameter'>nmsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferAddInvalidations &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Apply all invalidations we know. Possibly we only need parts at this point 
 * in the changestream but we don't know which those are. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1946"></a><span class='Declare_Function'>ReorderBufferExecuteInvalidations</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1948"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1948"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN1948"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN1946"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN250"><span class='Ref_to_Member'>ninvalidations</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN1948"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/sinval.h.html#LN151"><span class='Ref_to_Proto'>LocalExecuteInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN1946"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN251"><span class='Ref_to_Member'>invalidations</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN1948"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Mark a transaction as containing catalog changes 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1958"></a><span class='Declare_Function'>ReorderBufferXidSetCatalogChanges</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN1959"></a>                                  <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1961"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1961"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1958"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1958"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1959"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1961"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN147"><span class='Ref_to_Member'>has_catalog_changes</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Query whether a transaction is already *known* to contain catalog 
 * changes. This can be wrong until directly before the commit! 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1973"></a><span class='Declare_Function'>ReorderBufferXidHasCatalogChanges</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1975"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1975"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1973"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1973"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1975"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN1975"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN147"><span class='Ref_to_Member'>has_catalog_changes</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Have we already added the first snapshot? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1989"></a><span class='Declare_Function'>ReorderBufferXidHasBaseSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1991"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN1991"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN167"><span class='Ref_to_Proto'>ReorderBufferTXNByXid</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1989"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN1989"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* transaction isn't known yet, ergo no snapshot */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN1991"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * TODO: It would be a nice improvement if we would check the toplevel 
     * transaction in subtransactions, but we'd need to keep track of a bit 
     * more state. 
     */ 
</span>    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN1991"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN198"><span class='Ref_to_Member'>base_snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * --------------------------------------- 
 * Disk serialization support 
 * --------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Ensure the IO buffer is &GT;= sz. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2019"></a><span class='Declare_Function'>ReorderBufferSerializeReserve</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>sz</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN356"><span class='Ref_to_Member'>outbufsize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN356"><span class='Ref_to_Member'>outbufsize</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>sz</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN356"><span class='Ref_to_Member'>outbufsize</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>sz</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN356"><span class='Ref_to_Member'>outbufsize</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2019"><span class='Ref_to_Parameter'>sz</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Check whether the transaction tx should spill its data to disk. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2037"></a><span class='Declare_Function'>ReorderBufferCheckSerializeTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * TODO: improve accounting so we cheaply can take subtransactions into 
     * account here. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2037"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a> <span class='Operator'>&GT;= </span><a href="reorderbuffer.c.html#LN150"><span class='Ref_to_Global_Var'>max_changes_in_memory</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN194"><span class='Ref_to_Proto'>ReorderBufferSerializeTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2037"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2037"><span class='Ref_to_Parameter'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2037"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Spill data of a large transaction (and its subtransactions) to disk. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2054"></a><span class='Declare_Function'>ReorderBufferSerializeTXN</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2056"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>subtxn_i</span><span class='Delimiter'>; 
</span><a name="LN2057"></a>    <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>change_i</span><span class='Delimiter'>; 
</span><a name="LN2058"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN2059"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>curOpenSegNo</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2060"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>spilled</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2061"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"spill %u changes in XID %u to disk"</span><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* do the same to all child TXs */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2056"><span class='Ref_To_Local'>subtxn_i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN243"><span class='Ref_to_Member'>subtxns</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2069"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>subtxn</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2069"><span class='Ref_To_Local'>subtxn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2056"><span class='Ref_To_Local'>subtxn_i</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN194"><span class='Ref_to_Proto'>ReorderBufferSerializeTXN</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2069"><span class='Ref_To_Local'>subtxn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* serialize changestream */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2057"><span class='Ref_To_Local'>change_i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2078"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2078"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2057"><span class='Ref_To_Local'>change_i</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * store in segment in which it belongs by start lsn, don't split over 
         * multiple segments tho 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>|| !</span><a href="../../../include/access/xlog_internal.h.html#LN117"><span class='Ref_to_Macro'>XLByteInSeg</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2078"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2059"><span class='Ref_To_Local'>curOpenSegNo</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2088"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2078"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN73"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2059"><span class='Ref_To_Local'>curOpenSegNo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xlog_internal.h.html#LN94"><span class='Ref_to_Macro'>XLogSegNoOffsetToRecPtr</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2059"><span class='Ref_To_Local'>curOpenSegNo</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2088"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to care about TLIs here, only used during a single run, 
             * so each LSN only maps to a specific WAL record. 
             */ 
</span>            <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2061"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s/xid-%u-lsn-%X-%X.snap"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="../slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="reorderbuffer.c.html#LN2088"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2088"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* open segment, create it if necessary */ 
</span>            <a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2061"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, 
</span>                                   O_CREAT <span class='Operator'>| </span>O_WRONLY <span class='Operator'>| </span>O_APPEND <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, 
</span>                                   <a href="../../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="reorderbuffer.c.html#LN2061"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fd==-1||!XLByteInSeg(... &raquo; </span> 
 
        <a href="reorderbuffer.c.html#LN195"><span class='Ref_to_Proto'>ReorderBufferSerializeChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2078"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2078"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2078"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2060"><span class='Ref_To_Local'>spilled</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2060"><span class='Ref_To_Local'>spilled</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2054"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2058"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferSerializeTXN &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Serialize individual change to disk. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2135"></a><span class='Declare_Function'>ReorderBufferSerializeChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN2136"></a>                             <span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2138"></a>    <a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ondisk</span><span class='Delimiter'>; 
</span><a name="LN2139"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sz</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2018"><span class='Ref_to_Func'>ReorderBufferSerializeReserve</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN134"><span class='Ref_to_Member'>change</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* fall through these, they're all similar enough */ 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN53"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INSERT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN54"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_UPDATE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN55"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_DELETE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN60"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_INSERT</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2154"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN2155"></a>                <a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oldtup</span><span class='Delimiter'>, 
</span><a name="LN2156"></a>                           <span class='Operator'>*</span><span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN2157"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>oldlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2158"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newlen</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2155"><span class='Ref_To_Local'>oldtup</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2156"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2155"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2157"><span class='Ref_To_Local'>oldlen</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2155"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2157"><span class='Ref_To_Local'>oldlen</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2156"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2158"><span class='Ref_To_Local'>newlen</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2156"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2158"><span class='Ref_To_Local'>newlen</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* make sure we have enough space */ 
</span>                <a href="reorderbuffer.c.html#LN2018"><span class='Ref_to_Func'>ReorderBufferSerializeReserve</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* might have been reallocated above */ 
</span>                <a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2157"><span class='Ref_To_Local'>oldlen</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2155"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2155"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2157"><span class='Ref_To_Local'>oldlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2157"><span class='Ref_To_Local'>oldlen</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2158"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2156"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2156"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2158"><span class='Ref_To_Local'>newlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2154"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2158"><span class='Ref_To_Local'>newlen</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN56"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_MESSAGE</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2205"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN2206"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>prefix_size</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix<span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2206"><span class='Ref_To_Local'>prefix_size</span></a> <span class='Operator'>+ </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size <span class='Operator'>+ 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2018"><span class='Ref_to_Func'>ReorderBufferSerializeReserve</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* might have been reallocated above */ 
</span>                <a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* write the prefix including the size */ 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2206"><span class='Ref_To_Local'>prefix_size</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix<span class='Delimiter'>, 
</span>                       <a href="reorderbuffer.c.html#LN2206"><span class='Ref_To_Local'>prefix_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2206"><span class='Ref_To_Local'>prefix_size</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* write the message including the size */ 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message<span class='Delimiter'>, 
</span>                       <a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2205"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN57"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SNAPSHOT</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2235"></a>                <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snap</span><span class='Delimiter'>; 
</span><a name="LN2236"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>+ 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> 
                    <span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* make sure we have enough space */ 
</span>                <a href="reorderbuffer.c.html#LN2018"><span class='Ref_to_Func'>ReorderBufferSerializeReserve</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* might have been reallocated above */ 
</span>                <a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>; 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="reorderbuffer.c.html#LN2236"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2235"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN61"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_CONFIRM</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN58"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_COMMAND_ID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* ReorderBufferChange contains everything important */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch change-&GT;action &raquo; </span> 
 
    <a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2139"><span class='Ref_To_Local'>sz</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN873"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_BUFFER_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2281"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2281"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to data file for XID %u: %m"</span><span class='Delimiter'>, 
</span>                        <a href="reorderbuffer.c.html#LN2135"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2138"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN134"><span class='Ref_to_Member'>change</span></a><span class='Operator'>.</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN2136"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferSerializeChange &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Restore a number of changes spilled to disk back into memory. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN2299"></a><span class='Declare_Function'>ReorderBufferRestoreChanges</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN2300"></a>                            <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2302"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>restored</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2303"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>last_segno</span><span class='Delimiter'>; 
</span><a name="LN2304"></a>    <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>cleanup_iter</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* free current entries, so we have memory for more */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2304"><span class='Ref_To_Local'>cleanup_iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2312"></a>        <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cleanup</span> <span class='Operator'>= 
</span>        <a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2304"><span class='Ref_To_Local'>cleanup_iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2312"><span class='Ref_To_Local'>cleanup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2312"><span class='Ref_To_Local'>cleanup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2303"><span class='Ref_To_Local'>last_segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2302"><span class='Ref_To_Local'>restored</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN150"><span class='Ref_to_Global_Var'>max_changes_in_memory</span></a> <span class='Operator'>&& *</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>&LT;= </span><a href="reorderbuffer.c.html#LN2303"><span class='Ref_To_Local'>last_segno</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2325"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>readBytes</span><span class='Delimiter'>; 
</span><a name="LN2326"></a>        <a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ondisk</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2330"></a>            <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span><a name="LN2331"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* first time in */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/xlog_internal.h.html#LN94"><span class='Ref_to_Macro'>XLogSegNoOffsetToRecPtr</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2330"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to care about TLIs here, only used during a single run, 
             * so each LSN only maps to a specific WAL record. 
             */ 
</span>            <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2331"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s/xid-%u-lsn-%X-%X.snap"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="../slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="reorderbuffer.c.html#LN2330"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2330"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2331"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="reorderbuffer.c.html#LN2331"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if *fd==-1 &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Read the statically sized part of a change which has information 
         * about the total size. If we couldn't read a record, we're at the 
         * end of this file. 
         */ 
</span>        <a href="reorderbuffer.c.html#LN2018"><span class='Ref_to_Func'>ReorderBufferSerializeReserve</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN872"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_BUFFER_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* eof */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>segno</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from reorderbuffer spill file: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from reorderbuffer spill file: read %d instead of %u bytes"</span><span class='Delimiter'>, 
</span>                            <a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2326"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2018"><span class='Ref_to_Func'>ReorderBufferSerializeReserve</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, 
</span>                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="reorderbuffer.c.html#LN2326"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2326"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN872"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_BUFFER_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="reorderbuffer.c.html#LN2300"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="reorderbuffer.c.html#LN2326"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from reorderbuffer spill file: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN2326"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from reorderbuffer spill file: read %d instead of %u bytes"</span><span class='Delimiter'>, 
</span>                            <a href="reorderbuffer.c.html#LN2325"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2326"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN133"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ok, read a full change from disk, now restore it into proper 
         * in-memory format 
         */ 
</span>        <a href="reorderbuffer.c.html#LN199"><span class='Ref_to_Proto'>ReorderBufferRestoreChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>txn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2299"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN355"><span class='Ref_to_Member'>outbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2302"><span class='Ref_To_Local'>restored</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while restored&LT;max_changes_... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="reorderbuffer.c.html#LN2302"><span class='Ref_To_Local'>restored</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferRestoreChanges &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Convert change from its on-disk format to in-memory format and queue it onto 
 * the TXN's -&GT;changes list. 
 * 
 * Note: although "data" is declared char*, at entry it points to a 
 * maxalign'd buffer, making it safe in most of this function to assume 
 * that the pointed-to data is suitably aligned for direct access. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2436"></a><span class='Declare_Function'>ReorderBufferRestoreChange</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN2437"></a>                           <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2439"></a>    <a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ondisk</span><span class='Delimiter'>; 
</span><a name="LN2440"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2439"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN345"><span class='Ref_to_Func'>ReorderBufferGetChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* copy static part */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2439"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN134"><span class='Ref_to_Member'>change</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN131"><span class='Ref_to_Struct'>ReorderBufferDiskChange</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* restore individual stuff */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN76"><span class='Ref_to_Member'>action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* fall through these, they're all similar enough */ 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN53"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INSERT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN54"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_UPDATE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN55"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_DELETE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN60"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_INSERT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2461"></a>                <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>tuplelen</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>t_len<span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple <span class='Operator'>= 
</span>                    <a href="../../../include/replication/reorderbuffer.h.html#LN363"><span class='Ref_to_Proto'>ReorderBufferGetTupleBuf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2461"><span class='Ref_To_Local'>tuplelen</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* restore -&GT;tuple */ 
</span>                memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Operator'>-&GT;</span>tuple<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, 
</span>                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* reset t_data pointer into the new tuplebuf */ 
</span>                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Operator'>-&GT;</span>tuple<span class='Operator'>.</span>t_data <span class='Operator'>= 
</span>                    <a href="../../../include/replication/reorderbuffer.h.html#LN35"><span class='Ref_to_Macro'>ReorderBufferTupleBufData</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* restore tuple data itself */ 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>oldtuple<span class='Operator'>-&GT;</span>tuple<span class='Operator'>.</span>t_data<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2461"><span class='Ref_To_Local'>tuplelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2461"><span class='Ref_To_Local'>tuplelen</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if change-&GT;data.tp.oldtu... &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* here, data might not be suitably aligned! */ 
</span><a name="LN2483"></a>                <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>tuplelen</span><span class='Delimiter'>; 
</span> 
                memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2483"><span class='Ref_To_Local'>tuplelen</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Delimiter'>, </span>t_len<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple <span class='Operator'>= 
</span>                    <a href="../../../include/replication/reorderbuffer.h.html#LN363"><span class='Ref_to_Proto'>ReorderBufferGetTupleBuf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2483"><span class='Ref_To_Local'>tuplelen</span></a> <span class='Operator'>- </span><a href="../../../include/access/htup_details.h.html#LN169"><span class='Ref_to_Const'>SizeofHeapTupleHeader</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* restore -&GT;tuple */ 
</span>                memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Operator'>-&GT;</span>tuple<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, 
</span>                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* reset t_data pointer into the new tuplebuf */ 
</span>                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Operator'>-&GT;</span>tuple<span class='Operator'>.</span>t_data <span class='Operator'>= 
</span>                    <a href="../../../include/replication/reorderbuffer.h.html#LN35"><span class='Ref_to_Macro'>ReorderBufferTupleBufData</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* restore tuple data itself */ 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Operator'>-&GT;</span>tuple<span class='Operator'>.</span>t_data<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2483"><span class='Ref_To_Local'>tuplelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2483"><span class='Ref_To_Local'>tuplelen</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if change-&GT;data.tp.newtu... &raquo; </span> 
 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN56"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_MESSAGE</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2508"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>prefix_size</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* read prefix */ 
</span>                memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2508"><span class='Ref_To_Local'>prefix_size</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                                                             <a href="reorderbuffer.c.html#LN2508"><span class='Ref_To_Local'>prefix_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2508"><span class='Ref_To_Local'>prefix_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>prefix<span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2508"><span class='Ref_To_Local'>prefix_size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2508"><span class='Ref_To_Local'>prefix_size</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* read the message */ 
</span>                memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                                              <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message<span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, 
</span>                       <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>msg<span class='Operator'>.</span>message_size<span class='Delimiter'>; 
</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN57"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SNAPSHOT</span></a><span class='Operator'>: 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2532"></a>                <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>oldsnap</span><span class='Delimiter'>; 
</span><a name="LN2533"></a>                <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>newsnap</span><span class='Delimiter'>; 
</span><a name="LN2534"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2532"><span class='Ref_To_Local'>oldsnap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2534"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2532"><span class='Ref_To_Local'>oldsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>+ 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2532"><span class='Ref_To_Local'>oldsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>+ </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2534"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>snapshot<span class='Delimiter'>; 
</span> 
                memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2437"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2534"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                    <span class='Parentheses'>(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>+ </span><a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>                <a href="reorderbuffer.c.html#LN2533"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* the base struct contains all the data, easy peasy */ 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN61"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_SPEC_CONFIRM</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN58"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_COMMAND_ID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/replication/reorderbuffer.h.html#LN59"><span class='Ref_to_EnumConst'>REORDER_BUFFER_CHANGE_INTERNAL_TUPLECID</span></a><span class='Operator'>: 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch change-&GT;action &raquo; </span> 
 
    <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN218"><span class='Ref_to_Member'>changes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2440"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2436"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN212"><span class='Ref_to_Member'>nentries_mem</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferRestoreChange &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove all on-disk stored for the passed in transaction. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2568"></a><span class='Declare_Function'>ReorderBufferRestoreCleanup</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2570"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>first</span><span class='Delimiter'>; 
</span><a name="LN2571"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>cur</span><span class='Delimiter'>; 
</span><a name="LN2572"></a>    <a href="../../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>last</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2568"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2568"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2568"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN159"><span class='Ref_to_Member'>first_lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2570"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2568"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN172"><span class='Ref_to_Member'>final_lsn</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2572"><span class='Ref_To_Local'>last</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* iterate over all possible filenames, and delete them */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2571"><span class='Ref_To_Local'>cur</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2570"><span class='Ref_To_Local'>first</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN2571"><span class='Ref_To_Local'>cur</span></a> <span class='Operator'>&LT;= </span><a href="reorderbuffer.c.html#LN2572"><span class='Ref_To_Local'>last</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN2571"><span class='Ref_To_Local'>cur</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2583"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN2584"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>recptr</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xlog_internal.h.html#LN94"><span class='Ref_to_Macro'>XLogSegNoOffsetToRecPtr</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2571"><span class='Ref_To_Local'>cur</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2584"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2583"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s/xid-%u-lsn-%X-%X.snap"</span><span class='Delimiter'>, 
</span>                <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="../slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2568"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="reorderbuffer.c.html#LN2584"><span class='Ref_To_Local'>recptr</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN2584"><span class='Ref_To_Local'>recptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2583"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2583"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferRestoreCleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete all data spilled to disk after we've restarted/crashed. It will be 
 * recreated when the respective slots are reused. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2603"></a><span class='Declare_Function'>StartupReorderBuffer</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2605"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>logical_dir</span><span class='Delimiter'>; 
</span><a name="LN2606"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>logical_de</span><span class='Delimiter'>; 
</span> 
<a name="LN2608"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>spill_dir</span><span class='Delimiter'>; 
</span><a name="LN2609"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>spill_de</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2605"><span class='Ref_To_Local'>logical_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reorderbuffer.c.html#LN2606"><span class='Ref_To_Local'>logical_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2605"><span class='Ref_To_Local'>logical_dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2614"></a>        <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN2615"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>12</span><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2606"><span class='Ref_To_Local'>logical_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2606"><span class='Ref_To_Local'>logical_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if it cannot be a slot, skip the directory */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../slot.c.html#LN171"><span class='Ref_to_Func'>ReplicationSlotValidateName</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2606"><span class='Ref_To_Local'>logical_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ok, has to be a surviving logical slot, iterate and delete 
         * everything starting with xid-* 
         */ 
</span>        <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2606"><span class='Ref_To_Local'>logical_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we're only creating directories here, skip if it's not our's */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2614"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="../../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2614"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2608"><span class='Ref_To_Local'>spill_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reorderbuffer.c.html#LN2609"><span class='Ref_To_Local'>spill_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2608"><span class='Ref_To_Local'>spill_dir</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2609"><span class='Ref_To_Local'>spill_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                strcmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2609"><span class='Ref_To_Local'>spill_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* only look at names that can be ours */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2609"><span class='Ref_To_Local'>spill_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"xid"</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s/%s"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2606"><span class='Ref_To_Local'>logical_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, 
</span>                        <a href="reorderbuffer.c.html#LN2609"><span class='Ref_To_Local'>spill_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                    <a href="reorderbuffer.c.html#LN2615"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2608"><span class='Ref_To_Local'>spill_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (logical_de=ReadDir(l... &raquo; </span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2605"><span class='Ref_To_Local'>logical_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartupReorderBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* --------------------------------------- 
 * toast reassembly support 
 * --------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize per tuple toast reconstruction support. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2669"></a><span class='Declare_Function'>ReorderBufferToastInitHash</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2671"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2669"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2671"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2671"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2671"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2671"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2671"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2669"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2669"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"ReorderBufferToastHash"</span><span class='Delimiter'>, </span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2671"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Per toast-chunk handling for toast reconstruction 
 * 
 * Appends a toast chunk so we can reconstruct it when the tuple "owning" the 
 * toasted Datum comes along. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2690"></a><span class='Declare_Function'>ReorderBufferToastAppendChunk</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN2691"></a>                              <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2693"></a>    <a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span><a name="LN2694"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN2695"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN2696"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chunksize</span><span class='Delimiter'>; 
</span><a name="LN2697"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN2698"></a>    <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span><a name="LN2699"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>desc</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2691"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2700"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>chunk_id</span><span class='Delimiter'>; 
</span><a name="LN2701"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>chunk_seq</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2690"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="reorderbuffer.c.html#LN211"><span class='Ref_to_Proto'>ReorderBufferToastInitHash</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2690"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2690"><span class='Ref_to_Parameter'>txn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN30"><span class='Ref_to_Proto'>IsToastRelation</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2691"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2694"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2691"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2700"><span class='Ref_To_Local'>chunk_id</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN505"><span class='Ref_to_Macro'>DatumGetObjectId</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2694"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2699"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2697"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN2697"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2701"><span class='Ref_To_Local'>chunk_seq</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2694"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2699"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2697"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN2697"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2690"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2700"><span class='Ref_To_Local'>chunk_id</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                    <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2695"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN2695"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN120"><span class='Ref_to_Member'>chunk_id</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN2700"><span class='Ref_To_Local'>chunk_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN123"><span class='Ref_to_Member'>num_chunks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN121"><span class='Ref_to_Member'>last_chunk_seq</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN124"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN126"><span class='Ref_to_Member'>reconstructed</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/ilist.h.html#LN276"><span class='Ref_to_Func'>dlist_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN125"><span class='Ref_to_Member'>chunks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2701"><span class='Ref_To_Local'>chunk_seq</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"got sequence entry %d for toast chunk %u instead of seq 0"</span><span class='Delimiter'>, 
</span>                 <a href="reorderbuffer.c.html#LN2701"><span class='Ref_To_Local'>chunk_seq</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2700"><span class='Ref_To_Local'>chunk_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2695"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>&& </span><a href="reorderbuffer.c.html#LN2701"><span class='Ref_To_Local'>chunk_seq</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN121"><span class='Ref_to_Member'>last_chunk_seq</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"got sequence entry %d for toast chunk %u instead of seq %d"</span><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN2701"><span class='Ref_To_Local'>chunk_seq</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2700"><span class='Ref_To_Local'>chunk_id</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN121"><span class='Ref_to_Member'>last_chunk_seq</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2698"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2694"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2699"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2697"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN2697"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* calculate size so we can allocate the right size at once later */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN325"><span class='Ref_to_Macro'>VARATT_IS_EXTENDED</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2698"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span> 
        <a href="reorderbuffer.c.html#LN2696"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2698"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2698"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span> 
        <span class='Comment_Multi_Line'>/* could happen due to heap_form_tuple doing its thing */ 
</span>        <a href="reorderbuffer.c.html#LN2696"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN305"><span class='Ref_to_Macro'>VARSIZE_SHORT</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2698"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/postgres.h.html#LN268"><span class='Ref_to_Const'>VARHDRSZ_SHORT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected type of toast chunk"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN124"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+= </span><a href="reorderbuffer.c.html#LN2696"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN121"><span class='Ref_to_Member'>last_chunk_seq</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2701"><span class='Ref_To_Local'>chunk_seq</span></a><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN123"><span class='Ref_to_Member'>num_chunks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2693"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN125"><span class='Ref_to_Member'>chunks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2691"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferToastAppendChunk &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Rejigger change-&GT;newtuple to point to in-memory toast tuples instead to 
 * on-disk toast tuples that may not longer exist (think DROP TABLE or VACUUM). 
 * 
 * We cannot replace unchanged toast tuples though, so those will still point 
 * to on-disk toast data. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2763"></a><span class='Declare_Function'>ReorderBufferToastReplace</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Delimiter'>, 
</span><a name="LN2764"></a>                          <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>change</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2766"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>desc</span><span class='Delimiter'>; 
</span><a name="LN2767"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natt</span><span class='Delimiter'>; 
</span><a name="LN2768"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>attrs</span><span class='Delimiter'>; 
</span><a name="LN2769"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN2770"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>free</span><span class='Delimiter'>; 
</span><a name="LN2771"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tmphtup</span><span class='Delimiter'>; 
</span><a name="LN2772"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>toast_rel</span><span class='Delimiter'>; 
</span><a name="LN2773"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>toast_desc</span><span class='Delimiter'>; 
</span><a name="LN2774"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN2775"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* no toast tuples changed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2763"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2774"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2763"><span class='Ref_to_Parameter'>rb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN330"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we should only have toast tuples in an INSERT or UPDATE */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2764"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2764"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2772"><span class='Ref_To_Local'>toast_rel</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN33"><span class='Ref_to_Proto'>RelationIdGetRelation</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2764"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2773"><span class='Ref_To_Local'>toast_desc</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2772"><span class='Ref_To_Local'>toast_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* should we allocate from stack instead? */ 
</span>    <a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2769"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2770"><span class='Ref_To_Local'>free</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2764"><span class='Ref_to_Parameter'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/htup_details.h.html#LN813"><span class='Ref_to_Proto'>heap_deform_tuple</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2769"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2802"></a>        <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attr</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>]; 
</span><a name="LN2803"></a>        <a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span><a name="LN2804"></a>        <span class='Control'>struct</span> <a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>varlena</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* va_rawsize is the size of the original datum -- including header */ 
</span><a name="LN2807"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN67"><span class='Ref_to_Struct'>varatt_external</span></a> <span class='Declare_Local'>toast_pointer</span><span class='Delimiter'>; 
</span><a name="LN2808"></a>        <span class='Control'>struct</span> <a href="../../../include/postgres.h.html#LN84"><span class='Ref_to_Struct'>varatt_indirect</span></a> <span class='Declare_Local'>redirect_pointer</span><span class='Delimiter'>; 
</span><a name="LN2809"></a>        <span class='Control'>struct</span> <a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_datum</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2810"></a>        <span class='Control'>struct</span> <a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a> <span class='Operator'>*</span><span class='Declare_Local'>reconstructed</span><span class='Delimiter'>; 
</span><a name="LN2811"></a>        <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span><a name="LN2812"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>data_done</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* system columns aren't toasted */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2802"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attnum <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2802"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* not a varlena datatype */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2802"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attlen <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* no data */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2769"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ok, we know we have a toast datum */ 
</span>        <a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* no need to do anything if the tuple isn't external */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/tuptoaster.h.html#LN120"><span class='Ref_to_Macro'>VARATT_EXTERNAL_GET_POINTER</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2807"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check whether the toast tuple changed, replace if so. 
         */ 
</span>        <a href="reorderbuffer.c.html#LN2803"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2763"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2807"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN71"><span class='Ref_to_Member'>va_valueid</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                        <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2803"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2809"><span class='Ref_To_Local'>new_datum</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="reorderbuffer.c.html#LN2804"><span class='Ref_To_Local'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN101"><span class='Ref_to_Const'>INDIRECT_POINTER_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2770"><span class='Ref_To_Local'>free</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2810"><span class='Ref_To_Local'>reconstructed</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2807"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN69"><span class='Ref_to_Member'>va_rawsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2803"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN126"><span class='Ref_to_Member'>reconstructed</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2810"><span class='Ref_To_Local'>reconstructed</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* stitch toast tuple back together from its parts */ 
</span>        <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2811"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2803"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN125"><span class='Ref_to_Member'>chunks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2861"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN2862"></a>            <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cchange</span><span class='Delimiter'>; 
</span><a name="LN2863"></a>            <a href="../../../include/replication/reorderbuffer.h.html#LN20"><span class='Ref_to_Struct'>ReorderBufferTupleBuf</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ctup</span><span class='Delimiter'>; 
</span><a name="LN2864"></a>            <a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a>     <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span> 
            <a href="reorderbuffer.c.html#LN2862"><span class='Ref_To_Local'>cchange</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2811"><span class='Ref_To_Local'>it</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN2863"><span class='Ref_To_Local'>ctup</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2862"><span class='Ref_To_Local'>cchange</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN130"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span>tp<span class='Operator'>.</span>newtuple<span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN2864"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span> 
                          <a href="../../../include/access/htup_details.h.html#LN718"><span class='Ref_to_Macro'>fastgetattr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2863"><span class='Ref_To_Local'>ctup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2773"><span class='Ref_To_Local'>toast_desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2861"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN2861"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN313"><span class='Ref_to_Macro'>VARATT_IS_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2864"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postgres.h.html#LN324"><span class='Ref_to_Macro'>VARATT_IS_SHORT</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2864"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2810"><span class='Ref_To_Local'>reconstructed</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="reorderbuffer.c.html#LN2812"><span class='Ref_To_Local'>data_done</span></a><span class='Delimiter'>, 
</span>                   <a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2864"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2864"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN2812"><span class='Ref_To_Local'>data_done</span></a> <span class='Operator'>+= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2864"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2812"><span class='Ref_To_Local'>data_done</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN2807"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN70"><span class='Ref_to_Member'>va_extsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* make sure its marked as compressed or not */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/tuptoaster.h.html#LN110"><span class='Ref_to_Macro'>VARATT_EXTERNAL_IS_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2807"><span class='Ref_To_Local'>toast_pointer</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/postgres.h.html#LN329"><span class='Ref_to_Macro'>SET_VARSIZE_COMPRESSED</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2810"><span class='Ref_To_Local'>reconstructed</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2812"><span class='Ref_To_Local'>data_done</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2810"><span class='Ref_To_Local'>reconstructed</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2812"><span class='Ref_To_Local'>data_done</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2808"><span class='Ref_To_Local'>redirect_pointer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2808"><span class='Ref_To_Local'>redirect_pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN2808"><span class='Ref_To_Local'>redirect_pointer</span></a><span class='Operator'>.</span><a href="../../../include/postgres.h.html#LN86"><span class='Ref_to_Member'>pointer</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2810"><span class='Ref_To_Local'>reconstructed</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/postgres.h.html#LN331"><span class='Ref_to_Macro'>SET_VARTAG_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2809"><span class='Ref_To_Local'>new_datum</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN113"><span class='Ref_to_EnumConst'>VARTAG_INDIRECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN310"><span class='Ref_to_Macro'>VARDATA_EXTERNAL</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2809"><span class='Ref_To_Local'>new_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2808"><span class='Ref_To_Local'>redirect_pointer</span></a><span class='Delimiter'>, 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2808"><span class='Ref_To_Local'>redirect_pointer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2809"><span class='Ref_To_Local'>new_datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for natt=0;natt&LT;desc-&GT;nat... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Build tuple in separate memory & copy tuple back into the tuplebuf 
     * passed to the output plugin. We can't directly heap_fill_tuple() into 
     * the tuplebuf because attrs[] will point back into the current content. 
     */ 
</span>    <a href="reorderbuffer.c.html#LN2771"><span class='Ref_To_Local'>tmphtup</span></a> <span class='Operator'>= </span><a href="../../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2769"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/htup_details.h.html#LN560"><span class='Ref_to_Const'>MaxHeapTupleSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN35"><span class='Ref_to_Macro'>ReorderBufferTupleBufData</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2771"><span class='Ref_To_Local'>tmphtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2771"><span class='Ref_To_Local'>tmphtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2775"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN26"><span class='Ref_to_Member'>tuple</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN2771"><span class='Ref_To_Local'>tmphtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * free resources we won't further need, more persistent stuff will be 
     * free'd in ReorderBufferToastReset(). 
     */ 
</span>    <a href="../../../include/utils/relcache.h.html#LN34"><span class='Ref_to_Proto'>RelationClose</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2772"><span class='Ref_To_Local'>toast_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2771"><span class='Ref_To_Local'>tmphtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN2766"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2770"><span class='Ref_To_Local'>free</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN2767"><span class='Ref_To_Local'>natt</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2768"><span class='Ref_To_Local'>attrs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2770"><span class='Ref_To_Local'>free</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2769"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2774"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferToastReplace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free all resources allocated for toast reconstruction. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2932"></a><span class='Declare_Function'>ReorderBufferToastReset</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rb</span><span class='Delimiter'>, </span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>txn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2934"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hstat</span><span class='Delimiter'>; 
</span><a name="LN2935"></a>    <a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2932"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sequentially walk over the hash and free everything */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2934"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2932"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reorderbuffer.c.html#LN2935"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN118"><span class='Ref_to_Struct'>ReorderBufferToastEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2934"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2944"></a>        <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2935"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN126"><span class='Ref_to_Member'>reconstructed</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2935"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN126"><span class='Ref_to_Member'>reconstructed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2944"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2935"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN125"><span class='Ref_to_Member'>chunks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2951"></a>            <a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a> <span class='Operator'>*</span><span class='Declare_Local'>change</span> <span class='Operator'>= 
</span>            <a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN71"><span class='Ref_to_Struct'>ReorderBufferChange</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2944"><span class='Ref_To_Local'>it</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN2951"><span class='Ref_To_Local'>change</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN136"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN363"><span class='Ref_to_Func'>ReorderBufferReturnChange</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2932"><span class='Ref_to_Parameter'>rb</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN2951"><span class='Ref_To_Local'>change</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN2932"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN2932"><span class='Ref_to_Parameter'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN237"><span class='Ref_to_Member'>toast_hash</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReorderBufferToastReset &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* --------------------------------------- 
 * Visibility support for logical decoding 
 * 
 * 
 * Lookup actual cmin/cmax values when using decoding snapshot. We can't 
 * always rely on stored cmin/cmax values because of two scenarios: 
 * 
 * * A tuple got changed multiple times during a single transaction and thus 
 *   has got a combocid. Combocid's are only valid for the duration of a 
 *   single transaction. 
 * * A tuple with a cmin but no cmax (and thus no combocid) got 
 *   deleted/updated in another transaction than the one which created it 
 *   which we are looking at right now. As only one of cmin, cmax or combocid 
 *   is actually stored in the heap we don't have access to the value we 
 *   need anymore. 
 * 
 * To resolve those problems we have a per-transaction hash of (cmin, 
 * cmax) tuples keyed by (relfilenode, ctid) which contains the actual 
 * (cmin, cmax) values. That also takes care of combocids by simply 
 * not caring about them at all. As we have the real cmin/cmax values 
 * combocids aren't interesting. 
 * 
 * As we only care about catalog tuples here the overhead of this 
 * hashtable should be acceptable. 
 * 
 * Heap rewrites complicate this a bit, check rewriteheap.c for 
 * details. 
 * ------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* struct for qsort()ing mapping files by lsn somewhat efficiently */ 
</span><a name="LN2995"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>RewriteMappingFile</span> 
<span class='Delimiter'>{ 
</span><a name="LN2997"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>lsn</span><span class='Delimiter'>; 
</span><a name="LN2998"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>fname</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN2999"></a>} <span class='Declare_Typedef'>RewriteMappingFile</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> NOT_USED 
<span class='Keyword'>static void 
</span><a name="LN3003"></a><span class='Declare_Function'>DisplayMapping</span><span class='Parentheses'>(</span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuplecid_data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3005"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hstat</span><span class='Delimiter'>; 
</span><a name="LN3006"></a>    <a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3005"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3003"><span class='Ref_to_Parameter'>tuplecid_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3005"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"mapping: node: %u/%u/%u tid: %u/%u cmin: %u, cmax: %u"</span><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN93"><span class='Ref_to_Member'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN93"><span class='Ref_to_Member'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN93"><span class='Ref_to_Member'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, 
</span>             <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN93"><span class='Ref_to_Member'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN88"><span class='Ref_to_Member'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN93"><span class='Ref_to_Member'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN88"><span class='Ref_to_Member'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN3006"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> 
            <span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end DisplayMapping &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Apply a single mapping file to tuplecid_data. 
 * 
 * The mapping file has to have been verified to be a) committed b) for our 
 * transaction c) applied in LSN order. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3031"></a><span class='Declare_Function'>ApplyLogicalMappingFile</span><span class='Parentheses'>(</span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuplecid_data</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3033"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN3034"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN3035"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>readBytes</span><span class='Delimiter'>; 
</span><a name="LN3036"></a>    <a href="../../../include/access/rewriteheap.h.html#LN34"><span class='Ref_to_Struct'>LogicalRewriteMappingData</span></a> <span class='Declare_Local'>map</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3033"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_logical/mappings/%s"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3031"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN3034"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3033"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3034"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3033"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3047"></a>        <a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN3048"></a>        <a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span><a name="LN3049"></a>        <a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_ent</span><span class='Delimiter'>; 
</span><a name="LN3050"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* be careful about padding */ 
</span>        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* read all mappings till the end of the file */ 
</span>        <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN874"><span class='Ref_to_EnumConst'>WAIT_EVENT_REORDER_LOGICAL_MAPPING_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN3035"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3034"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3036"><span class='Ref_To_Local'>map</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/rewriteheap.h.html#LN34"><span class='Ref_to_Struct'>LogicalRewriteMappingData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3035"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="reorderbuffer.c.html#LN3033"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3035"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* EOF */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3035"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/rewriteheap.h.html#LN34"><span class='Ref_to_Struct'>LogicalRewriteMappingData</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from file \"%s\": read %d instead of %d bytes"</span><span class='Delimiter'>, 
</span>                            <a href="reorderbuffer.c.html#LN3033"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3035"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/rewriteheap.h.html#LN34"><span class='Ref_to_Struct'>LogicalRewriteMappingData</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3036"><span class='Ref_To_Local'>map</span></a><span class='Operator'>.</span><a href="../../../include/access/rewriteheap.h.html#LN36"><span class='Ref_to_Member'>old_node</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3036"><span class='Ref_To_Local'>map</span></a><span class='Operator'>.</span><a href="../../../include/access/rewriteheap.h.html#LN38"><span class='Ref_to_Member'>old_tid</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN88"><span class='Ref_to_Member'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
        <a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3031"><span class='Ref_to_Parameter'>tuplecid_data</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                        <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* no existing mapping, no need to update */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3036"><span class='Ref_To_Local'>map</span></a><span class='Operator'>.</span><a href="../../../include/access/rewriteheap.h.html#LN37"><span class='Ref_to_Member'>new_node</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3036"><span class='Ref_To_Local'>map</span></a><span class='Operator'>.</span><a href="../../../include/access/rewriteheap.h.html#LN39"><span class='Ref_to_Member'>new_tid</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN88"><span class='Ref_to_Member'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN3049"><span class='Ref_To_Local'>new_ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3031"><span class='Ref_to_Parameter'>tuplecid_data</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3047"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3050"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3050"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Make sure the existing mapping makes sense. We sometime update 
             * old records that did not yet have a cmax (e.g. pg_class' own 
             * entry while rewriting it) during rewrites, so allow that. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a> <span class='Operator'>|| </span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN3049"><span class='Ref_To_Local'>new_ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a> <span class='Operator'>|| </span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>== </span><a href="reorderbuffer.c.html#LN3049"><span class='Ref_To_Local'>new_ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* update mapping */ 
</span>            <a href="reorderbuffer.c.html#LN3049"><span class='Ref_To_Local'>new_ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN3049"><span class='Ref_To_Local'>new_ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a><span class='Delimiter'>; 
</span>            <a href="reorderbuffer.c.html#LN3049"><span class='Ref_To_Local'>new_ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN96"><span class='Ref_to_Member'>combocid</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3048"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN96"><span class='Ref_to_Member'>combocid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ApplyLogicalMappingFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Check whether the TransactionOId 'xid' is in the pre-sorted array 'xip'. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3124"></a><span class='Declare_Function'>TransactionIdInArray</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>xip</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>num</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> bsearch<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3124"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3124"><span class='Ref_to_Parameter'>xip</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3124"><span class='Ref_to_Parameter'>num</span></a><span class='Delimiter'>, 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN94"><span class='Ref_to_Proto'>xidComparator</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * qsort() comparator for sorting RewriteMappingFiles in LSN order. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN3134"></a><span class='Declare_Function'>file_sort_by_lsn</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a_p</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b_p</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3136"></a>    <a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>a</span> <span class='Operator'>= *</span><span class='Parentheses'>(</span><a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN3134"><span class='Ref_to_Parameter'>a_p</span></a><span class='Delimiter'>; 
</span><a name="LN3137"></a>    <a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>b</span> <span class='Operator'>= *</span><span class='Parentheses'>(</span><a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN3134"><span class='Ref_to_Parameter'>b_p</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3136"><span class='Ref_To_Local'>a</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2997"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>&LT; </span><a href="reorderbuffer.c.html#LN3137"><span class='Ref_To_Local'>b</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2997"><span class='Ref_to_Member'>lsn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3136"><span class='Ref_To_Local'>a</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2997"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>&GT; </span><a href="reorderbuffer.c.html#LN3137"><span class='Ref_To_Local'>b</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2997"><span class='Ref_to_Member'>lsn</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Apply any existing logical remapping files if there are any targeted at our 
 * transaction for relid. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3151"></a><span class='Declare_Function'>UpdateLogicalMappings</span><span class='Parentheses'>(</span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuplecid_data</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3153"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>mapping_dir</span><span class='Delimiter'>; 
</span><a name="LN3154"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>mapping_de</span><span class='Delimiter'>; 
</span><a name="LN3155"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>files</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN3156"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span><a name="LN3157"></a>    <a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>**</span><span class='Declare_Local'>files_a</span><span class='Delimiter'>; 
</span><a name="LN3158"></a>    size_t      <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN3159"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dboid</span> <span class='Operator'>= </span><a href="../../../include/catalog/catalog.h.html#LN42"><span class='Ref_to_Proto'>IsSharedRelation</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>: </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <a href="reorderbuffer.c.html#LN3153"><span class='Ref_To_Local'>mapping_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_logical/mappings"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3153"><span class='Ref_To_Local'>mapping_dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_logical/mappings"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3164"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>f_dboid</span><span class='Delimiter'>; 
</span><a name="LN3165"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>f_relid</span><span class='Delimiter'>; 
</span><a name="LN3166"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>f_mapped_xid</span><span class='Delimiter'>; 
</span><a name="LN3167"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>f_create_xid</span><span class='Delimiter'>; 
</span><a name="LN3168"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>f_lsn</span><span class='Delimiter'>; 
</span><a name="LN3169"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f_hi</span><span class='Delimiter'>, 
</span><a name="LN3170"></a>                    <span class='Declare_Local'>f_lo</span><span class='Delimiter'>; 
</span><a name="LN3171"></a>        <a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore files that aren't ours */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"map-"</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="../../../include/access/rewriteheap.h.html#LN53"><span class='Ref_to_Const'>LOGICAL_REWRITE_FORMAT</span></a><span class='Delimiter'>, 
</span>                   <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3164"><span class='Ref_To_Local'>f_dboid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3165"><span class='Ref_To_Local'>f_relid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3169"><span class='Ref_To_Local'>f_hi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3170"><span class='Ref_To_Local'>f_lo</span></a><span class='Delimiter'>, 
</span>                   <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3166"><span class='Ref_To_Local'>f_mapped_xid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3167"><span class='Ref_To_Local'>f_create_xid</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>6</span><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not parse filename \"%s\""</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="reorderbuffer.c.html#LN3168"><span class='Ref_To_Local'>f_lsn</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="reorderbuffer.c.html#LN3169"><span class='Ref_To_Local'>f_hi</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>32</span> <span class='Operator'>| </span><a href="reorderbuffer.c.html#LN3170"><span class='Ref_To_Local'>f_lo</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* mapping for another database */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3164"><span class='Ref_To_Local'>f_dboid</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN3159"><span class='Ref_To_Local'>dboid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* mapping for another relation */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3165"><span class='Ref_To_Local'>f_relid</span></a> <span class='Operator'>!= </span><a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* did the creating transaction abort? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../access/transam/transam.c.html#LN123"><span class='Ref_to_Func'>TransactionIdDidCommit</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3167"><span class='Ref_To_Local'>f_create_xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* not for our transaction */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/time/tqual.c.html#LN1629"><span class='Ref_to_Func'>TransactionIdInArray</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3166"><span class='Ref_To_Local'>f_mapped_xid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ok, relevant, queue for apply */ 
</span>        <a href="reorderbuffer.c.html#LN3171"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN3171"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2997"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3168"><span class='Ref_To_Local'>f_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3171"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2998"><span class='Ref_to_Member'>fname</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3154"><span class='Ref_To_Local'>mapping_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN3155"><span class='Ref_To_Local'>files</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3155"><span class='Ref_To_Local'>files</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3171"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (mapping_de=ReadDir(m... &raquo; </span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3153"><span class='Ref_To_Local'>mapping_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* build array we can easily sort */ 
</span>    <a href="reorderbuffer.c.html#LN3157"><span class='Ref_To_Local'>files_a</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3155"><span class='Ref_To_Local'>files</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="reorderbuffer.c.html#LN3158"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3156"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3155"><span class='Ref_To_Local'>files</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN3157"><span class='Ref_To_Local'>files_a</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN3158"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3156"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* sort files so we apply them in LSN order */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3157"><span class='Ref_To_Local'>files_a</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3155"><span class='Ref_To_Local'>files</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="reorderbuffer.c.html#LN3133"><span class='Ref_to_Func'>file_sort_by_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3158"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN3158"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3155"><span class='Ref_To_Local'>files</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="reorderbuffer.c.html#LN3158"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3226"></a>        <a href="../../access/heap/rewriteheap.c.html#LN202"><span class='Ref_to_Struct'>RewriteMappingFile</span></a> <span class='Operator'>*</span><span class='Declare_Local'>f</span> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3157"><span class='Ref_To_Local'>files_a</span></a><span class='Delimiter'>[</span><a href="reorderbuffer.c.html#LN3158"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"applying mapping: \"%s\" in %u"</span><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3226"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2998"><span class='Ref_to_Member'>fname</span></a><span class='Delimiter'>, 
</span>             <a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reorderbuffer.c.html#LN3030"><span class='Ref_to_Func'>ApplyLogicalMappingFile</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>tuplecid_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3151"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3226"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN2998"><span class='Ref_to_Member'>fname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3226"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end UpdateLogicalMappings &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Lookup cmin/cmax of a tuple, during logical decoding where we can't rely on 
 * combocids. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN3240"></a><span class='Declare_Function'>ResolveCminCmaxDuringDecoding</span><span class='Parentheses'>(</span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuplecid_data</span><span class='Delimiter'>, 
</span><a name="LN3241"></a>                              <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, 
</span><a name="LN3242"></a>                              <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>htup</span><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, 
</span><a name="LN3243"></a>                              <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmin</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmax</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3245"></a>    <a href="reorderbuffer.c.html#LN85"><span class='Ref_to_Struct'>ReorderBufferTupleCidKey</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN3246"></a>    <a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span><a name="LN3247"></a>    <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forkno</span><span class='Delimiter'>; 
</span><a name="LN3248"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blockno</span><span class='Delimiter'>; 
</span><a name="LN3249"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>updated_mapping</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* be careful about padding */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3245"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3245"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/buf.h.html#LN36"><span class='Ref_to_Macro'>BufferIsLocal</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3242"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get relfilenode from the buffer, no convenient way to access it other 
     * than that. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN208"><span class='Ref_to_Proto'>BufferGetTag</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3242"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3245"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN87"><span class='Ref_to_Member'>relnode</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3247"><span class='Ref_To_Local'>forkno</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3248"><span class='Ref_To_Local'>blockno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* tuples can only be in the main fork */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3247"><span class='Ref_To_Local'>forkno</span></a> <span class='Operator'>== </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3248"><span class='Ref_To_Local'>blockno</span></a> <span class='Operator'>== </span><a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3242"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/itemptr.h.html#LN137"><span class='Ref_to_Macro'>ItemPointerCopy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3242"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, 
</span>                    <span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3245"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="reorderbuffer.c.html#LN88"><span class='Ref_to_Member'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN3269"></a><span class='Label'>restart</span><span class='Operator'>: 
</span>    <a href="reorderbuffer.c.html#LN3246"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN91"><span class='Ref_to_Struct'>ReorderBufferTupleCidEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3240"><span class='Ref_to_Parameter'>tuplecid_data</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="reorderbuffer.c.html#LN3245"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                    <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * failed to find a mapping, check whether the table was rewritten and 
     * apply mapping if so, but only do that once - there can be no new 
     * mappings while we are in here since we have to hold a lock on the 
     * relation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3246"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& !</span><a href="reorderbuffer.c.html#LN3249"><span class='Ref_To_Local'>updated_mapping</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="reorderbuffer.c.html#LN3150"><span class='Ref_to_Func'>UpdateLogicalMappings</span></a><span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3240"><span class='Ref_to_Parameter'>tuplecid_data</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3242"><span class='Ref_to_Parameter'>htup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN65"><span class='Ref_to_Member'>t_tableOid</span></a><span class='Delimiter'>, </span><a href="reorderbuffer.c.html#LN3241"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* now check but don't update for a mapping again */ 
</span>        <a href="reorderbuffer.c.html#LN3249"><span class='Ref_To_Local'>updated_mapping</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="reorderbuffer.c.html#LN3269"><span class='Ref_to_Label'>restart</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3246"><span class='Ref_To_Local'>ent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3243"><span class='Ref_to_Parameter'>cmin</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN3243"><span class='Ref_to_Parameter'>cmin</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3246"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN94"><span class='Ref_to_Member'>cmin</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reorderbuffer.c.html#LN3243"><span class='Ref_to_Parameter'>cmax</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="reorderbuffer.c.html#LN3243"><span class='Ref_to_Parameter'>cmax</span></a> <span class='Operator'>= </span><a href="reorderbuffer.c.html#LN3246"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>-&GT;</span><a href="reorderbuffer.c.html#LN95"><span class='Ref_to_Member'>cmax</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ResolveCminCmaxDuringDecoding &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>