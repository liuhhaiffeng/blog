<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\replication\logical\snapbuild.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\replication\logical\snapbuild.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:47 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * snapbuild.c 
 * 
 *    Infrastructure for building historic catalog snapshots based on contents 
 *    of the WAL, for the purpose of decoding heapam.c style values in the 
 *    WAL. 
 * 
 * NOTES: 
 * 
 * We build snapshots which can *only* be used to read catalog contents and we 
 * do so by reading and interpreting the WAL stream. The aim is to build a 
 * snapshot that behaves the same as a freshly taken MVCC snapshot would have 
 * at the time the XLogRecord was generated. 
 * 
 * To build the snapshots we reuse the infrastructure built for Hot 
 * Standby. The in-memory snapshots we build look different than HS' because 
 * we have different needs. To successfully decode data from the WAL we only 
 * need to access catalog tables and (sys|rel|cat)cache, not the actual user 
 * tables since the data we decode is wholly contained in the WAL 
 * records. Also, our snapshots need to be different in comparison to normal 
 * MVCC ones because in contrast to those we cannot fully rely on the clog and 
 * pg_subtrans for information about committed transactions because they might 
 * commit in the future from the POV of the WAL entry we're currently 
 * decoding. This definition has the advantage that we only need to prevent 
 * removal of catalog rows, while normal table's rows can still be 
 * removed. This is achieved by using the replication slot mechanism. 
 * 
 * As the percentage of transactions modifying the catalog normally is fairly 
 * small in comparisons to ones only manipulating user data, we keep track of 
 * the committed catalog modifying ones inside [xmin, xmax) instead of keeping 
 * track of all running transactions like it's done in a normal snapshot. Note 
 * that we're generally only looking at transactions that have acquired an 
 * xid. That is we keep a list of transactions between snapshot-&GT;(xmin, xmax) 
 * that we consider committed, everything else is considered aborted/in 
 * progress. That also allows us not to care about subtransactions before they 
 * have committed which means this module, in contrast to HS, doesn't have to 
 * care about suboverflowed subtransactions and similar. 
 * 
 * One complexity of doing this is that to e.g. handle mixed DDL/DML 
 * transactions we need Snapshots that see intermediate versions of the 
 * catalog in a transaction. During normal operation this is achieved by using 
 * CommandIds/cmin/cmax. The problem with that however is that for space 
 * efficiency reasons only one value of that is stored 
 * (c.f. combocid.c). Since ComboCids are only available in memory we log 
 * additional information which allows us to get the original (cmin, cmax) 
 * pair during visibility checks. Check the reorderbuffer.c's comment above 
 * ResolveCminCmaxDuringDecoding() for details. 
 * 
 * To facilitate all this we need our own visibility routine, as the normal 
 * ones are optimized for different usecases. 
 * 
 * To replace the normal catalog snapshots with decoding ones use the 
 * SetupHistoricSnapshot() and TeardownHistoricSnapshot() functions. 
 * 
 * 
 * 
 * The snapbuild machinery is starting up in several stages, as illustrated 
 * by the following graph describing the SnapBuild-&GT;state transitions: 
 * 
 *         +-------------------------+ 
 *    +----|         START           |-------------+ 
 *    |    +-------------------------+             | 
 *    |                 |                          | 
 *    |                 |                          | 
 *    |        running_xacts #1                    | 
 *    |                 |                          | 
 *    |                 |                          | 
 *    |                 v                          | 
 *    |    +-------------------------+             v 
 *    |    |   BUILDING_SNAPSHOT     |------------&GT;| 
 *    |    +-------------------------+             | 
 *    |                 |                          | 
 *    |                 |                          | 
 *    | running_xacts #2, xacts from #1 finished   | 
 *    |                 |                          | 
 *    |                 |                          | 
 *    |                 v                          | 
 *    |    +-------------------------+             v 
 *    |    |       FULL_SNAPSHOT     |------------&GT;| 
 *    |    +-------------------------+             | 
 *    |                 |                          | 
 * running_xacts        |                      saved snapshot 
 * with zero xacts      |                 at running_xacts's lsn 
 *    |                 |                          | 
 *    | running_xacts with xacts from #2 finished  | 
 *    |                 |                          | 
 *    |                 v                          | 
 *    |    +-------------------------+             | 
 *    +---&GT;|SNAPBUILD_CONSISTENT     |&LT;------------+ 
 *         +-------------------------+ 
 * 
 * Initially the machinery is in the START stage. When an xl_running_xacts 
 * record is read that is sufficiently new (above the safe xmin horizon), 
 * there's a state transition. If there were no running xacts when the 
 * running_xacts record was generated, we'll directly go into CONSISTENT 
 * state, otherwise we'll switch to the BUILDING_SNAPSHOT state. Having a full 
 * snapshot means that all transactions that start henceforth can be decoded 
 * in their entirety, but transactions that started previously can't. In 
 * FULL_SNAPSHOT we'll switch into CONSISTENT once all those previously 
 * running transactions have committed or aborted. 
 * 
 * Only transactions that commit after CONSISTENT state has been reached will 
 * be replayed, even though they might have started while still in 
 * FULL_SNAPSHOT. That ensures that we'll reach a point where no previous 
 * changes has been exported, but all the following ones will be. That point 
 * is a convenient point to initialize replication from, which is why we 
 * export a snapshot at that point, which *can* be used to read normal data. 
 * 
 * Copyright (c) 2012-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/backend/replication/snapbuild.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam_xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"replication/logical.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/reorderbuffer.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/snapbuild.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapshot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"storage/block.h"</span>      <span class='Comment_Single_Line'>/* debugging output */ 
</span><span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/standby.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This struct contains the current state of the snapshot building 
 * machinery. Besides a forward declaration in the header, it is not exposed 
 * to the public, so we can easily change its contents. 
 */ 
</span><a name="LN152"></a><span class='Control'>struct</span> <span class='Declare_Struct'>SnapBuild</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* how far are we along building our first full snapshot */ 
</span><a name="LN155"></a>    <a href="../../../include/replication/snapbuild.h.html#LN17"><span class='Ref_to_Typedef'>SnapBuildState</span></a> <span class='Declare_Member'>state</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* private memory context used to allocate memory for this module. */ 
</span><a name="LN158"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>context</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* all transactions &LT; than this have committed/aborted */ 
</span><a name="LN161"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xmin</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* all transactions &GT;= than this are uncommitted */ 
</span><a name="LN164"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xmax</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't replay commits from an LSN &LT; this LSN. This can be set externally 
     * but it will also be advanced (never retreat) from within snapbuild.c. 
     */ 
</span><a name="LN170"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>start_decoding_at</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't start decoding WAL until the "xl_running_xacts" information 
     * indicates there are no running xids with an xid smaller than this. 
     */ 
</span><a name="LN176"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>initial_xmin_horizon</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Indicates if we are building full snapshot or just catalog one. */ 
</span><a name="LN179"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>building_full_snapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Snapshot that's valid to see the catalog state seen at this moment. 
     */ 
</span><a name="LN184"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Member'>snapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * LSN of the last location we are sure a snapshot has been serialized to. 
     */ 
</span><a name="LN189"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>last_serialized_snapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The reorderbuffer we need to update with usable snapshots et al. 
     */ 
</span><a name="LN194"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Member'>reorder</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Outdated: This struct isn't used for its original purpose anymore, but 
     * can't be removed / changed in a minor version, because it's stored 
     * on-disk. 
     */ 
</span>    <span class='Control'>struct</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * NB: This field is misused, until a major version can break on-disk 
         * compatibility. See SnapBuildNextPhaseAt() / 
         * SnapBuildStartNextPhaseAt(). 
         */ 
</span><a name="LN208"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>was_xmin</span><span class='Delimiter'>; 
</span><a name="LN209"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>was_xmax</span><span class='Delimiter'>; 
</span> 
<a name="LN211"></a>        size_t      <span class='Declare_Member'>was_xcnt</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* number of used xip entries */ 
</span><a name="LN212"></a>        size_t      <span class='Declare_Member'>was_xcnt_space</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* allocated size of xip */ 
</span><a name="LN213"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Member'>was_xip</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* running xacts array, xidComparator-sorted */ 
</span><a name="LN214"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Member'>was_running</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Array of transactions which could have catalog changes that committed 
     * between xmin and xmax. 
     */ 
</span>    <span class='Control'>struct</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* number of committed transactions */ 
</span><a name="LN223"></a>        size_t      <span class='Declare_Member'>xcnt</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* available space for committed transactions */ 
</span><a name="LN226"></a>        size_t      <span class='Declare_Member'>xcnt_space</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Until we reach a CONSISTENT state, we record commits of all 
         * transactions, not just the catalog changing ones. Record when that 
         * changes so we know we cannot export a snapshot safely anymore. 
         */ 
</span><a name="LN233"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Member'>includes_all_transactions</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Array of committed transactions that have modified the catalog. 
         * 
         * As this array is frequently modified we do *not* keep it in 
         * xidComparator order. Instead we sort the array when building & 
         * distributing a snapshot. 
         * 
         * TODO: It's unclear whether that reasoning has much merit. Every 
         * time we add something here after becoming consistent will also 
         * require distributing a snapshot. Storing them sorted would 
         * potentially also make it easier to purge (but more complicated wrt 
         * wraparound?). Should be improved if sorting while building the 
         * snapshot shows up in profiles. 
         */ 
</span><a name="LN249"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Member'>xip</span><span class='Delimiter'>; 
</span><a name="LN250"></a>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end {anoncommitted} &raquo; </span>           <span class='Declare_Member'>committed</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuild &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Starting a transaction -- which we need to do while exporting a snapshot -- 
 * removes knowledge about the previously used resowner, so we save it here. 
 */ 
</span><a name="LN257"></a><span class='Keyword'>static </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Var'>SavedResourceOwnerDuringExport</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN258"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>ExportInProgress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* -&GT;committed manipulation */ 
</span><a name="LN261"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapBuildPurgeCommittedTxn</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* snapshot building/manipulation/distribution functions */ 
</span><a name="LN264"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Prototype'>SnapBuildBuildSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN266"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapBuildFreeSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN268"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapBuildSnapIncRefcount</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN270"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapBuildDistributeNewCatalogSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* xlog reading helper functions for SnapBuildProcessRecord */ 
</span><a name="LN273"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>SnapBuildFindSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/storage/standbydefs.h.html#LN46"><span class='Ref_to_Struct'>xl_running_xacts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>running</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN274"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapBuildWaitSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/storage/standbydefs.h.html#LN46"><span class='Ref_to_Struct'>xl_running_xacts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>running</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* serialization functions */ 
</span><a name="LN277"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapBuildSerialize</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN278"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>SnapBuildRestore</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return TransactionId after which the next phase of initial snapshot 
 * building will happen. 
 */ 
</span><span class='Keyword'>static inline </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN285"></a><span class='Declare_Function'>SnapBuildNextPhaseAt</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * For backward compatibility reasons this has to be stored in the wrongly 
     * named field.  Will be fixed in next major version. 
     */ 
</span>    <span class='Control'>return</span> <a href="snapbuild.c.html#LN285"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN209"><span class='Ref_to_Member'>was_xmax</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set TransactionId after which the next phase of initial snapshot building 
 * will happen. 
 */ 
</span><span class='Keyword'>static inline void 
</span><a name="LN299"></a><span class='Declare_Function'>SnapBuildStartNextPhaseAt</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>at</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * For backward compatibility reasons this has to be stored in the wrongly 
     * named field.  Will be fixed in next major version. 
     */ 
</span>    <a href="snapbuild.c.html#LN299"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN209"><span class='Ref_to_Member'>was_xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN299"><span class='Ref_to_Parameter'>at</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Allocate a new snapshot builder. 
 * 
 * xmin_horizon is the xid &GT;= which we can be sure no catalog rows have been 
 * removed, start_lsn is the LSN &GT;= we want to replay commits. 
 */ 
</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>* 
</span><a name="LN315"></a><span class='Declare_Function'>AllocateSnapshotBuilder</span><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN294"><span class='Ref_to_Struct'>ReorderBuffer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>reorder</span><span class='Delimiter'>, 
</span><a name="LN316"></a>                        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xmin_horizon</span><span class='Delimiter'>, 
</span><a name="LN317"></a>                        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>start_lsn</span><span class='Delimiter'>, 
</span><a name="LN318"></a>                        <span class='Keyword'>bool </span><span class='Declare_Parameter'>need_full_snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN320"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span><a name="LN321"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN322"></a>    <a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>builder</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* allocate memory in own context, to have better accountability */ 
</span>    <a href="snapbuild.c.html#LN320"><span class='Ref_To_Local'>context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                    <span class='String'>"snapshot builder context"</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN321"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN320"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="../../../include/replication/snapbuild.h.html#LN22"><span class='Ref_to_EnumConst'>SNAPBUILD_START</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN320"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN315"><span class='Ref_to_Parameter'>reorder</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Other struct members initialized by zeroing via palloc0 above */ 
</span> 
    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a> <span class='Operator'>= </span><span class='Number'>128</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* arbitrary number */ 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN233"><span class='Ref_to_Member'>includes_all_transactions</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN176"><span class='Ref_to_Member'>initial_xmin_horizon</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN316"><span class='Ref_to_Parameter'>xmin_horizon</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN317"><span class='Ref_to_Parameter'>start_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN179"><span class='Ref_to_Member'>building_full_snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN318"><span class='Ref_to_Parameter'>need_full_snapshot</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN321"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapbuild.c.html#LN322"><span class='Ref_To_Local'>builder</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocateSnapshotBuilder &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free a snapshot builder. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN356"></a><span class='Declare_Function'>FreeSnapshotBuilder</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN358"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>context</span> <span class='Operator'>= </span><a href="snapbuild.c.html#LN356"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* free snapshot explicitly, that contains some error checking */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN356"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/replication/snapbuild.h.html#LN66"><span class='Ref_to_Proto'>SnapBuildSnapDecRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN356"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN356"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* other resources are deallocated via memory context reset */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN358"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Free an unreferenced snapshot that has previously been built by us. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN375"></a><span class='Declare_Function'>SnapBuildFreeSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* make sure we don't get passed an external snapshot */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN53"><span class='Ref_to_Member'>satisfies</span></a> <span class='Operator'>== </span><a href="../../../include/utils/tqual.h.html#LN68"><span class='Ref_to_Proto'>HeapTupleSatisfiesHistoricMVCC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* make sure nobody modified our snapshot */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* slightly more likely, so it's checked even without c-asserts */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot free a copied snapshot"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot free an active snapshot"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN375"><span class='Ref_to_Parameter'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildFreeSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * In which state of snapshot building are we? 
 */ 
</span><a href="../../../include/replication/snapbuild.h.html#LN17"><span class='Ref_to_Typedef'>SnapBuildState</span></a> 
<a name="LN400"></a><span class='Declare_Function'>SnapBuildCurrentState</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="snapbuild.c.html#LN400"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Should the contents of transaction ending at 'ptr' be decoded? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN409"></a><span class='Declare_Function'>SnapBuildXactNeedsSkip</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>ptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="snapbuild.c.html#LN409"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>&LT; </span><a href="snapbuild.c.html#LN409"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Increase refcount of a snapshot. 
 * 
 * This is used when handing out a snapshot to some external resource or when 
 * adding a Snapshot as builder-&GT;snapshot. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN421"></a><span class='Declare_Function'>SnapBuildSnapIncRefcount</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="snapbuild.c.html#LN421"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Decrease refcount of a snapshot and free if the refcount reaches zero. 
 * 
 * Externally visible, so that external resources that have been handed an 
 * IncRef'ed Snapshot can adjust its refcount easily. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN433"></a><span class='Declare_Function'>SnapBuildSnapDecRefcount</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* make sure we don't get passed an external snapshot */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN53"><span class='Ref_to_Member'>satisfies</span></a> <span class='Operator'>== </span><a href="../../../include/utils/tqual.h.html#LN68"><span class='Ref_to_Proto'>HeapTupleSatisfiesHistoricMVCC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* make sure nobody modified our snapshot */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* slightly more likely, so it's checked even without casserts */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot free a copied snapshot"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="snapbuild.c.html#LN266"><span class='Ref_to_Proto'>SnapBuildFreeSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN433"><span class='Ref_to_Parameter'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildSnapDecRefcount &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build a new snapshot, based on currently committed catalog-modifying 
 * transactions. 
 * 
 * In-progress transactions with catalog access are *not* allowed to modify 
 * these snapshots; they have to copy them and fill in appropriate -&GT;curcid 
 * and -&GT;subxip/subxcnt values. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN465"></a><span class='Declare_Function'>SnapBuildBuildSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN467"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span><a name="LN468"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>ssize</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/replication/snapbuild.h.html#LN38"><span class='Ref_to_EnumConst'>SNAPBUILD_FULL_SNAPSHOT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN468"><span class='Ref_To_Local'>ssize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> 
        <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>1</span> <span class='Comment_Multi_Line'>/* toplevel xid */ </span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN468"><span class='Ref_To_Local'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN53"><span class='Ref_to_Member'>satisfies</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN68"><span class='Ref_to_Proto'>HeapTupleSatisfiesHistoricMVCC</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We misuse the original meaning of SnapshotData's xip and subxip fields 
     * to make the more fitting for our needs. 
     * 
     * In the 'xip' array we store transactions that have to be treated as 
     * committed. Since we will only ever look at tuples from transactions 
     * that have modified the catalog it's more efficient to store those few 
     * that exist between xmin and xmax (frequently there are none). 
     * 
     * Snapshots that are used in transactions that have modified the catalog 
     * also use the 'subxip' array to store their toplevel xid and all the 
     * subtransaction xids so we can recognize when we need to treat rows as 
     * visible that are not in xip but still need to be visible. Subxip only 
     * gets filled when the transaction is copied into the context of a 
     * catalog modifying transaction since we otherwise share a snapshot 
     * between transactions. As long as a txn hasn't modified the catalog it 
     * doesn't need to treat any uncommitted rows as visible, so there is no 
     * need for those xids. 
     * 
     * Both arrays are qsort'ed so that we can use bsearch() on them. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* store all transactions to be treated as committed by this snapshot */ 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, 
</span>           <a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, 
</span>           <a href="snapbuild.c.html#LN465"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sort so we can bsearch() */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN94"><span class='Ref_to_Proto'>xidComparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initially, subxip is empty, i.e. it's a snapshot to be used by 
     * transactions that don't modify the catalog. Will be filled by 
     * ReorderBufferCopySnap() if necessary. 
     */ 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN412"><span class='Ref_to_Const'>FirstCommandId</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapbuild.c.html#LN467"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildBuildSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Build the initial slot snapshot and convert it to a normal snapshot that 
 * is understood by HeapTupleSatisfiesMVCC. 
 * 
 * The snapshot will be usable directly in current transaction or exported 
 * for loading in different transaction. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN544"></a><span class='Declare_Function'>SnapBuildInitialSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN546"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snap</span><span class='Delimiter'>; 
</span><a name="LN547"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span><span class='Delimiter'>; 
</span><a name="LN548"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newxip</span><span class='Delimiter'>; 
</span><a name="LN549"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>newxcnt</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/time/snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../access/transam/xact.c.html#LN73"><span class='Ref_to_Global_Var'>XactIsoLevel</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN29"><span class='Ref_to_Const'>XACT_REPEATABLE_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN544"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>!= </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot build an initial slot snapshot before reaching a consistent state"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN544"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN233"><span class='Ref_to_Member'>includes_all_transactions</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot build an initial slot snapshot, not all transactions are monitored anymore"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* so we don't overwrite the existing value */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot build an initial slot snapshot when MyPgXact-&GT;xmin already is valid"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN264"><span class='Ref_to_Proto'>SnapBuildBuildSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN544"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN331"><span class='Ref_to_Proto'>GetTopTransactionId</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We know that snap-&GT;xmin is alive, enforced by the logical xmin 
     * mechanism. Due to that we can do this without locks, we're only 
     * changing our own value. 
     */ 
</span><span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
    <span class='Delimiter'>{ 
</span><a name="LN573"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>safeXid</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ProcArrayLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN573"><span class='Ref_To_Local'>safeXid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN93"><span class='Ref_to_Proto'>GetOldestSafeDecodingTransactionId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ProcArrayLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN169"><span class='Ref_to_Proto'>TransactionIdPrecedesOrEquals</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN573"><span class='Ref_To_Local'>safeXid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* allocate in transaction context */ 
</span>    <a href="snapbuild.c.html#LN548"><span class='Ref_To_Local'>newxip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/storage/procarray.h.html#LN78"><span class='Ref_to_Proto'>GetMaxSnapshotXidCount</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * snapbuild.c builds transactions in an "inverted" manner, which means it 
     * stores committed transactions in -&GT;xip, not ones in progress. Build a 
     * classical snapshot by marking all non-committed transactions as 
     * in-progress. This can be expensive. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN547"><span class='Ref_To_Local'>xid</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; </span><a href="../../../include/access/transam.h.html#LN61"><span class='Ref_to_Macro'>NormalTransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN547"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN597"></a>        <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>test</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check whether transaction committed using the decoding snapshot 
         * meaning of -&GT;xip. 
         */ 
</span>        <a href="snapbuild.c.html#LN597"><span class='Ref_To_Local'>test</span></a> <span class='Operator'>= </span>bsearch<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapbuild.c.html#LN547"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, 
</span>                       <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN94"><span class='Ref_to_Proto'>xidComparator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN597"><span class='Ref_To_Local'>test</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN549"><span class='Ref_To_Local'>newxcnt</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/procarray.h.html#LN78"><span class='Ref_to_Proto'>GetMaxSnapshotXidCount</span></a><span class='Parentheses'>())</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_T_R_SERIALIZATION_FAILURE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"initial slot snapshot too large"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="snapbuild.c.html#LN548"><span class='Ref_To_Local'>newxip</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN549"><span class='Ref_To_Local'>newxcnt</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapbuild.c.html#LN547"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/access/transam.h.html#LN47"><span class='Ref_to_Macro'>TransactionIdAdvance</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN547"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for xid=snap-&GT;xmin;Normal... &raquo; </span> 
 
    <a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN549"><span class='Ref_To_Local'>newxcnt</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN548"><span class='Ref_To_Local'>newxip</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapbuild.c.html#LN546"><span class='Ref_To_Local'>snap</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildInitialSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Export a snapshot so it can be set in another session with SET TRANSACTION 
 * SNAPSHOT. 
 * 
 * For that we need to start a transaction in the current backend as the 
 * importing side checks whether the source transaction is still open to make 
 * sure the xmin horizon hasn't advanced since then. 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN634"></a><span class='Declare_Function'>SnapBuildExportSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN636"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snap</span><span class='Delimiter'>; 
</span><a name="LN637"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>snapname</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN367"><span class='Ref_to_Proto'>IsTransactionOrTransactionBlock</span></a><span class='Parentheses'>())</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot export a snapshot from within a transaction"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN257"><span class='Ref_to_Global_Var'>SavedResourceOwnerDuringExport</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"can only export one snapshot at a time"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN257"><span class='Ref_to_Global_Var'>SavedResourceOwnerDuringExport</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN258"><span class='Ref_to_Global_Var'>ExportInProgress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* There doesn't seem to a nice API to set these */ 
</span>    <a href="../../access/transam/xact.c.html#LN73"><span class='Ref_to_Global_Var'>XactIsoLevel</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN29"><span class='Ref_to_Const'>XACT_REPEATABLE_READ</span></a><span class='Delimiter'>; 
</span>    <a href="../../access/transam/xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN636"><span class='Ref_To_Local'>snap</span></a> <span class='Operator'>= </span><a href="../../../include/replication/snapbuild.h.html#LN68"><span class='Ref_to_Proto'>SnapBuildInitialSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN634"><span class='Ref_to_Parameter'>builder</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * now that we've built a plain snapshot, make it active and use the 
     * normal mechanisms for exporting it 
     */ 
</span>    <a href="snapbuild.c.html#LN637"><span class='Ref_To_Local'>snapname</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN98"><span class='Ref_to_Proto'>ExportSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN636"><span class='Ref_To_Local'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN848"><span class='Ref_to_Func'>errmsg_plural</span></a><span class='Parentheses'>(</span><span class='String'>"exported logical decoding snapshot: \"%s\" with %u transaction ID"</span><span class='Delimiter'>, 
</span>        <span class='String'>"exported logical decoding snapshot: \"%s\" with %u transaction IDs"</span><span class='Delimiter'>, 
</span>                           <a href="snapbuild.c.html#LN636"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, 
</span>                           <a href="snapbuild.c.html#LN637"><span class='Ref_To_Local'>snapname</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN636"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="snapbuild.c.html#LN637"><span class='Ref_To_Local'>snapname</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildExportSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Ensure there is a snapshot and if not build one for current transaction. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN674"></a><span class='Declare_Function'>SnapBuildGetOrBuildSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* only build a new snapshot if we don't have a prebuilt one */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN264"><span class='Ref_to_Proto'>SnapBuildBuildSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* increase refcount for the snapshot builder */ 
</span>        <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="snapbuild.c.html#LN674"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Reset a previously SnapBuildExportSnapshot()'ed snapshot if there is 
 * any. Aborts the previously started transaction and resets the resource 
 * owner back to its original value. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN695"></a><span class='Declare_Function'>SnapBuildClearExportedSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* nothing exported, that is the usual case */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN258"><span class='Ref_to_Global_Var'>ExportInProgress</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"clearing exported snapshot in wrong transaction state"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* make sure nothing  could have ever happened */ 
</span>    <a href="../../../include/access/xact.h.html#LN350"><span class='Ref_to_Proto'>AbortCurrentTransaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN257"><span class='Ref_to_Global_Var'>SavedResourceOwnerDuringExport</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN257"><span class='Ref_to_Global_Var'>SavedResourceOwnerDuringExport</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN258"><span class='Ref_to_Global_Var'>ExportInProgress</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle the effects of a single heap change, appropriate to the current state 
 * of the snapshot builder and returns whether changes made at (xid, lsn) can 
 * be decoded. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN718"></a><span class='Declare_Function'>SnapBuildProcessChange</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We can't handle data in transactions if we haven't built a snapshot 
     * yet, so don't store them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN38"><span class='Ref_to_EnumConst'>SNAPBUILD_FULL_SNAPSHOT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No point in keeping track of changes in transactions that we don't have 
     * enough information about to decode. This means that they started before 
     * we got into the SNAPBUILD_FULL_SNAPSHOT state. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a> <span class='Operator'>&& 
</span>        <a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN284"><span class='Ref_to_Func'>SnapBuildNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Parentheses'>)))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the reorderbuffer doesn't yet have a snapshot, add one now, it will 
     * be needed to decode the change we're currently processing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/replication/reorderbuffer.h.html#LN396"><span class='Ref_to_Proto'>ReorderBufferXidHasBaseSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* only build a new snapshot if we don't have a prebuilt one */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN264"><span class='Ref_to_Proto'>SnapBuildBuildSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* increase refcount for the snapshot builder */ 
</span>            <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Increase refcount for the transaction we're handing the snapshot 
         * out to. 
         */ 
</span>        <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/replication/reorderbuffer.h.html#LN382"><span class='Ref_to_Proto'>ReorderBufferSetBaseSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, 
</span>                                     <a href="snapbuild.c.html#LN718"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildProcessChange &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Do CommandId/ComboCid handling after reading an xl_heap_new_cid record. 
 * This implies that a transaction has done some form of write to system 
 * catalogs. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN768"></a><span class='Declare_Function'>SnapBuildProcessNewCid</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN769"></a>                       <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/access/heapam_xlog.h.html#LN332"><span class='Ref_to_Struct'>xl_heap_new_cid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>xlrec</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN771"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Local'>cid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * we only log new_cid's if a catalog tuple was modified, so mark the 
     * transaction as containing catalog modifications 
     */ 
</span>    <a href="../../../include/replication/reorderbuffer.h.html#LN394"><span class='Ref_to_Proto'>ReorderBufferXidSetCatalogChanges</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN768"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN768"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/reorderbuffer.h.html#LN386"><span class='Ref_to_Proto'>ReorderBufferAddNewTupleCids</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN768"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN338"><span class='Ref_to_Member'>top_xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, 
</span>                                 <a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN352"><span class='Ref_to_Member'>target_node</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN353"><span class='Ref_to_Member'>target_tid</span></a><span class='Delimiter'>, 
</span>                                 <a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a><span class='Delimiter'>, 
</span>                                 <a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN347"><span class='Ref_to_Member'>combocid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* figure out new command id */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a> <span class='Operator'>&& 
</span>        <a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Parentheses'>) 
</span>        <a href="snapbuild.c.html#LN771"><span class='Ref_To_Local'>cid</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Parentheses'>) 
</span>        <a href="snapbuild.c.html#LN771"><span class='Ref_To_Local'>cid</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN340"><span class='Ref_to_Member'>cmax</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Parentheses'>) 
</span>        <a href="snapbuild.c.html#LN771"><span class='Ref_To_Local'>cid</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>xlrec</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/heapam_xlog.h.html#LN339"><span class='Ref_to_Member'>cmin</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN771"><span class='Ref_To_Local'>cid</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN413"><span class='Ref_to_Const'>InvalidCommandId</span></a><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* silence compiler */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"xl_heap_new_cid record without a valid CommandId"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/replication/reorderbuffer.h.html#LN384"><span class='Ref_to_Proto'>ReorderBufferAddNewCommandId</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN768"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN768"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN769"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN771"><span class='Ref_To_Local'>cid</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildProcessNewCid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a new Snapshot to all transactions we're decoding that currently are 
 * in-progress so they can see new catalog contents made by the transaction 
 * that just committed. This is necessary because those in-progress 
 * transactions will use the new catalog's contents from here on (at the very 
 * least everything they do needs to be compatible with newer catalog 
 * contents). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN810"></a><span class='Declare_Function'>SnapBuildDistributeNewCatalogSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN812"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>txn_i</span><span class='Delimiter'>; 
</span><a name="LN813"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Iterate through all toplevel transactions. This can include 
     * subtransactions which we just don't yet know to be that, but that's 
     * fine, they will just get an unnecessary snapshot queued. 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN812"><span class='Ref_To_Local'>txn_i</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN305"><span class='Ref_to_Member'>toplevel_by_lsn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN813"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN812"><span class='Ref_To_Local'>txn_i</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN813"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we don't have a base snapshot yet, there are no changes in this 
         * transaction which in turn implies we don't yet need a snapshot at 
         * all. We'll add a snapshot when the first change gets queued. 
         * 
         * NB: This works correctly even for subtransactions because 
         * ReorderBufferCommitChild() takes care to pass the parent the base 
         * snapshot, and while iterating the changequeue we'll get the change 
         * from the subtxn. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/replication/reorderbuffer.h.html#LN396"><span class='Ref_to_Proto'>ReorderBufferXidHasBaseSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN813"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"adding a new snapshot to %u at %X/%X"</span><span class='Delimiter'>, 
</span>             <a href="snapbuild.c.html#LN813"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * increase the snapshot's refcount for the transaction we are handing 
         * it out to 
         */ 
</span>        <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/replication/reorderbuffer.h.html#LN383"><span class='Ref_to_Proto'>ReorderBufferAddSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN813"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN144"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, 
</span>                                 <a href="snapbuild.c.html#LN810"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildDistributeNewCatalogSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Keep track of a new catalog changing transaction that has committed. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN856"></a><span class='Declare_Function'>SnapBuildAddCommittedTxn</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>== </span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"increasing space for committed transactions to %u"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, 
</span>                      <a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * TODO: It might make sense to keep the array sorted here instead of 
     * doing it every time we build a new snapshot. On the other hand this 
     * gets called repeatedly when a transaction with subtransactions commits. 
     */ 
</span>    <a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapbuild.c.html#LN856"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildAddCommittedTxn &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove knowledge about transactions we treat as committed that are smaller 
 * than -&GT;xmin. Those won't ever get checked via the -&GT;committed array but via 
 * the clog machinery, so we don't need to waste memory on them. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN885"></a><span class='Declare_Function'>SnapBuildPurgeCommittedTxn</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN887"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN888"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>workspace</span><span class='Delimiter'>; 
</span><a name="LN889"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>surviving_xids</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* not ready yet */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* TODO: Neater algorithm than just copying and iterating? */ 
</span>    <a href="snapbuild.c.html#LN888"><span class='Ref_To_Local'>workspace</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                           <a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* copy xids that still are interesting to workspace */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN887"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapbuild.c.html#LN887"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; </span><a href="snapbuild.c.html#LN887"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN61"><span class='Ref_to_Macro'>NormalTransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN887"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>], 
</span>                                        <a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* remove */ 
</span>        <span class='Control'>else</span> 
            <a href="snapbuild.c.html#LN888"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN889"><span class='Ref_To_Local'>surviving_xids</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN887"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* copy workspace back to persistent state */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN888"><span class='Ref_To_Local'>workspace</span></a><span class='Delimiter'>, 
</span>           <a href="snapbuild.c.html#LN889"><span class='Ref_To_Local'>surviving_xids</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"purged committed transactions from %u to %u, xmin: %u, xmax: %u"</span><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN889"><span class='Ref_To_Local'>surviving_xids</span></a><span class='Delimiter'>, 
</span>         <a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN885"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN889"><span class='Ref_To_Local'>surviving_xids</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN888"><span class='Ref_To_Local'>workspace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildPurgeCommittedTxn &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle everything that needs to be done when a transaction commits 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN926"></a><span class='Declare_Function'>SnapBuildCommitTxn</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, 
</span><a name="LN927"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>nsubxacts</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>subxacts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN929"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nxact</span><span class='Delimiter'>; 
</span> 
<a name="LN931"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needs_snapshot</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN932"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needs_timetravel</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN933"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>sub_needs_timetravel</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN935"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xmax</span> <span class='Operator'>= </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Transactions preceding BUILDING_SNAPSHOT will neither be decoded, nor 
     * will they be part of a snapshot.  So we don't need to record anything. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN22"><span class='Ref_to_EnumConst'>SNAPBUILD_START</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN28"><span class='Ref_to_EnumConst'>SNAPBUILD_BUILDING_SNAPSHOT</span></a> <span class='Operator'>&& 
</span>         <a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN284"><span class='Ref_to_Func'>SnapBuildNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Parentheses'>))))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* ensure that only commits after this are getting replayed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>&LT;= </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>) 
</span>            <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* ensure that only commits after this are getting replayed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>&LT;= </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>) 
</span>            <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If building an exportable snapshot, force xid to be tracked, even 
         * if the transaction didn't modify the catalog. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN179"><span class='Ref_to_Member'>building_full_snapshot</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN929"><span class='Ref_To_Local'>nxact</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapbuild.c.html#LN929"><span class='Ref_To_Local'>nxact</span></a> <span class='Operator'>&LT; </span><a href="snapbuild.c.html#LN927"><span class='Ref_to_Parameter'>nsubxacts</span></a><span class='Delimiter'>; </span><a href="snapbuild.c.html#LN929"><span class='Ref_To_Local'>nxact</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN969"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>subxid</span> <span class='Operator'>= </span><a href="snapbuild.c.html#LN927"><span class='Ref_to_Parameter'>subxacts</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN929"><span class='Ref_To_Local'>nxact</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Add subtransaction to base snapshot if catalog modifying, we don't 
         * distinguish to toplevel transactions there. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN395"><span class='Ref_to_Proto'>ReorderBufferXidHasCatalogChanges</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="snapbuild.c.html#LN933"><span class='Ref_To_Local'>sub_needs_timetravel</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="snapbuild.c.html#LN931"><span class='Ref_To_Local'>needs_snapshot</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"found subtransaction %u:%u with catalog changes"</span><span class='Delimiter'>, 
</span>                 <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="snapbuild.c.html#LN855"><span class='Ref_to_Func'>SnapBuildAddCommittedTxn</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN66"><span class='Ref_to_Macro'>NormalTransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN935"><span class='Ref_To_Local'>xmax</span></a><span class='Parentheses'>))</span> 
                <a href="snapbuild.c.html#LN935"><span class='Ref_To_Local'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we're forcing timetravel we also need visibility information 
         * about subtransaction, so keep track of subtransaction's state, even 
         * if not catalog modifying.  Don't need to distribute a snapshot in 
         * that case. 
         */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="snapbuild.c.html#LN855"><span class='Ref_to_Func'>SnapBuildAddCommittedTxn</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN66"><span class='Ref_to_Macro'>NormalTransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN935"><span class='Ref_To_Local'>xmax</span></a><span class='Parentheses'>))</span> 
                <a href="snapbuild.c.html#LN935"><span class='Ref_To_Local'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN969"><span class='Ref_To_Local'>subxid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for nxact=0;nxact&LT;nsubxac... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* if top-level modified catalog, it'll need a snapshot */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/replication/reorderbuffer.h.html#LN395"><span class='Ref_to_Proto'>ReorderBufferXidHasCatalogChanges</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"found top level transaction %u, with catalog changes"</span><span class='Delimiter'>, 
</span>             <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN931"><span class='Ref_To_Local'>needs_snapshot</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN855"><span class='Ref_to_Func'>SnapBuildAddCommittedTxn</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN933"><span class='Ref_To_Local'>sub_needs_timetravel</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* track toplevel txn as well, subxact alone isn't meaningful */ 
</span>        <a href="snapbuild.c.html#LN855"><span class='Ref_to_Func'>SnapBuildAddCommittedTxn</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"forced transaction %u to do timetravel"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN855"><span class='Ref_to_Func'>SnapBuildAddCommittedTxn</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* record that we cannot export a general snapshot anymore */ 
</span>        <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN233"><span class='Ref_to_Member'>includes_all_transactions</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN931"><span class='Ref_To_Local'>needs_snapshot</span></a> <span class='Operator'>|| </span><a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Adjust xmax of the snapshot builder, we only do that for committed, 
     * catalog modifying, transactions, everything else isn't interesting for 
     * us since we'll never look at the respective rows. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN932"><span class='Ref_To_Local'>needs_timetravel</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>         <a href="../../../include/access/transam.h.html#LN171"><span class='Ref_to_Proto'>TransactionIdFollowsOrEquals</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN935"><span class='Ref_To_Local'>xmax</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN935"><span class='Ref_To_Local'>xmax</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/access/transam.h.html#LN47"><span class='Ref_to_Macro'>TransactionIdAdvance</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* if there's any reason to build a historic snapshot, do so now */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN931"><span class='Ref_To_Local'>needs_snapshot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If we haven't built a complete snapshot yet there's no need to hand 
         * it out, it wouldn't (and couldn't) be used anyway. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN38"><span class='Ref_to_EnumConst'>SNAPBUILD_FULL_SNAPSHOT</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Decrease the snapshot builder's refcount of the old snapshot, note 
         * that it still will be used if it has been handed out to the 
         * reorderbuffer earlier. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/replication/snapbuild.h.html#LN66"><span class='Ref_to_Proto'>SnapBuildSnapDecRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN264"><span class='Ref_to_Proto'>SnapBuildBuildSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we might need to execute invalidations, add snapshot */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/replication/reorderbuffer.h.html#LN396"><span class='Ref_to_Proto'>ReorderBufferXidHasBaseSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/replication/reorderbuffer.h.html#LN382"><span class='Ref_to_Proto'>ReorderBufferSetBaseSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, 
</span>                                         <a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* refcount of the snapshot builder for the new snapshot */ 
</span>        <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* add a new Snapshot to all currently running transactions */ 
</span>        <a href="snapbuild.c.html#LN270"><span class='Ref_to_Proto'>SnapBuildDistributeNewCatalogSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN926"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if needs_snapshot &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SnapBuildCommitTxn &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ----------------------------------- 
 * Snapshot building functions dealing with xlog records 
 * ----------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Process a running xacts record, and use its information to first build a 
 * historic snapshot and later to release resources that aren't needed 
 * anymore. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1093"></a><span class='Declare_Function'>SnapBuildProcessRunningXacts</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/storage/standbydefs.h.html#LN46"><span class='Ref_to_Struct'>xl_running_xacts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>running</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1095"></a>    <a href="../../../include/replication/reorderbuffer.h.html#LN139"><span class='Ref_to_Struct'>ReorderBufferTXN</span></a> <span class='Operator'>*</span><span class='Declare_Local'>txn</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're not consistent yet, inspect the record to see whether it 
     * allows to get closer to being consistent. If we are consistent, dump 
     * our snapshot so others or we, after a restart, can use it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* returns false if there's no point in performing cleanup just yet */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN273"><span class='Ref_to_Proto'>SnapBuildFindSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>running</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="snapbuild.c.html#LN277"><span class='Ref_to_Proto'>SnapBuildSerialize</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update range of interesting xids based on the running xacts 
     * information. We don't increase -&GT;xmax using it, because once we are in 
     * a consistent state we can do that ourselves and much more efficiently 
     * so, because we only need to do it for catalog transactions since we 
     * only ever look at those. 
     * 
     * NB: Because of that xmax can be lower than xmin, because we only 
     * increase xmax when a catalog modifying transaction commits. While odd 
     * looking, it's correct and actually more efficient this way since we hit 
     * fast paths in tqual.c. 
     */ 
</span>    <a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove transactions we don't need to keep track off anymore */ 
</span>    <a href="snapbuild.c.html#LN261"><span class='Ref_to_Proto'>SnapBuildPurgeCommittedTxn</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"xmin: %u, xmax: %u, oldestrunning: %u"</span><span class='Delimiter'>, 
</span>         <a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>, 
</span>         <a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Increase shared memory limits, so vacuum can work on tuples we 
     * prevented from being pruned till now. 
     */ 
</span>    <a href="../../../include/replication/logical.h.html#LN107"><span class='Ref_to_Proto'>LogicalIncreaseXminForSlot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also tell the slot where we can restart decoding from. We don't want to 
     * do that after every commit because changing that implies an fsync of 
     * the logical slot's state file, so we only do it every time we see a 
     * running xacts record. 
     * 
     * Do so by looking for the oldest in progress transaction (determined by 
     * the first LSN of any of its relevant records). Every transaction 
     * remembers the last location we stored the snapshot to disk before its 
     * beginning. That point is where we can restart from. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Can't know about a serialized snapshot's location if we're not 
     * consistent. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN1095"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>= </span><a href="../../../include/replication/reorderbuffer.h.html#LN398"><span class='Ref_to_Proto'>ReorderBufferGetOldestTXN</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * oldest ongoing txn might have started when we didn't yet serialize 
     * anything because we hadn't reached a consistent state yet. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1095"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="snapbuild.c.html#LN1095"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN184"><span class='Ref_to_Member'>restart_decoding_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/replication/logical.h.html#LN108"><span class='Ref_to_Proto'>LogicalIncreaseRestartDecodingForSlot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1095"><span class='Ref_To_Local'>txn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN184"><span class='Ref_to_Member'>restart_decoding_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No in-progress transaction, can reuse the last serialized snapshot if 
     * we have one. 
     */ 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1095"><span class='Ref_To_Local'>txn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/reorderbuffer.h.html#LN352"><span class='Ref_to_Member'>current_restart_decoding_lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>&& 
</span>             <a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/replication/logical.h.html#LN108"><span class='Ref_to_Proto'>LogicalIncreaseRestartDecodingForSlot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, 
</span>                                          <a href="snapbuild.c.html#LN1093"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildProcessRunningXacts &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Build the start of a snapshot that's capable of decoding the catalog. 
 * 
 * Helper function for SnapBuildProcessRunningXacts() while we're not yet 
 * consistent. 
 * 
 * Returns true if there is a point in performing internal maintenance/cleanup 
 * using the xl_running_xacts record. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1188"></a><span class='Declare_Function'>SnapBuildFindSnapshot</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Delimiter'>, </span><a href="../../../include/storage/standbydefs.h.html#LN46"><span class='Ref_to_Struct'>xl_running_xacts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>running</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* --- 
     * Build catalog decoding snapshot incrementally using information about 
     * the currently running transactions. There are several ways to do that: 
     * 
     * a) There were no running transactions when the xl_running_xacts record 
     *    was inserted, jump to CONSISTENT immediately. We might find such a 
     *    state while waiting on c)'s sub-states. 
     * 
     * b) This (in a previous run) or another decoding slot serialized a 
     *    snapshot to disk that we can use.  Can't use this method for the 
     *    initial snapshot when slot is being created and needs full snapshot 
     *    for export or direct use, as that snapshot will only contain catalog 
     *    modifying transactions. 
     * 
     * c) First incrementally build a snapshot for catalog tuples 
     *    (BUILDING_SNAPSHOT), that requires all, already in-progress, 
     *    transactions to finish.  Every transaction starting after that 
     *    (FULL_SNAPSHOT state), has enough information to be decoded.  But 
     *    for older running transactions no viable snapshot exists yet, so 
     *    CONSISTENT will only be reached once all of those have finished. 
     * --- 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * xl_running_xact record is older than what we can use, we might not have 
     * all necessary catalog rows anymore. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN176"><span class='Ref_to_Member'>initial_xmin_horizon</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../../include/access/transam.h.html#LN61"><span class='Ref_to_Macro'>NormalTransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Delimiter'>, 
</span>                                    <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN176"><span class='Ref_to_Member'>initial_xmin_horizon</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"skipping snapshot at %X/%X while building logical decoding snapshot, xmin horizon too low"</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"initial xmin horizon of %u vs the snapshot's %u"</span><span class='Delimiter'>, 
</span>                 <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN176"><span class='Ref_to_Member'>initial_xmin_horizon</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
 
        <a href="snapbuild.c.html#LN274"><span class='Ref_to_Proto'>SnapBuildWaitSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN176"><span class='Ref_to_Member'>initial_xmin_horizon</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * a) No transaction were running, we can jump to consistent. 
     * 
     * This is not affected by races around xl_running_xacts, because we can 
     * miss transaction commits, but currently not transactions starting. 
     * 
     * NB: We might have already started to incrementally assemble a snapshot, 
     * so we need to be careful to deal with that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a> <span class='Operator'>== </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>|| 
</span>            <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>&LT;= </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>) 
</span>            <span class='Comment_Multi_Line'>/* can decode everything after this */ 
</span>            <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN170"><span class='Ref_to_Member'>start_decoding_at</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* As no transactions were running xmin/xmax can be trivially set. */ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* &LT; are finished */ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* &GT;= are running */ 
</span> 
        <span class='Comment_Multi_Line'>/* so we can safely use the faster comparisons */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN298"><span class='Ref_to_Func'>SnapBuildStartNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical decoding found consistent point at %X/%X"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"There are no running transactions."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if running-&GT;oldestRunnin... &raquo; </span> 
    <span class='Comment_Multi_Line'>/* b) valid on disk state and not building full snapshot */ 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN179"><span class='Ref_to_Member'>building_full_snapshot</span></a> <span class='Operator'>&& 
</span>             <a href="snapbuild.c.html#LN278"><span class='Ref_to_Proto'>SnapBuildRestore</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* there won't be any state to cleanup */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * c) transition from START to BUILDING_SNAPSHOT. 
     * 
     * In START state, and a xl_running_xacts record with running xacts is 
     * encountered.  In that case, switch to BUILDING_SNAPSHOT state, and 
     * record xl_running_xacts-&GT;nextXid.  Once all running xacts have finished 
     * (i.e. they're all &GT;= nextXid), we have a complete catalog snapshot.  It 
     * might look that we could use xl_running_xact's -&GT;xids information to 
     * get there quicker, but that is problematic because transactions marked 
     * as running, might already have inserted their commit record - it's 
     * infeasible to change that with locking. 
     */ 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN22"><span class='Ref_to_EnumConst'>SNAPBUILD_START</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="../../../include/replication/snapbuild.h.html#LN28"><span class='Ref_to_EnumConst'>SNAPBUILD_BUILDING_SNAPSHOT</span></a><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN298"><span class='Ref_to_Func'>SnapBuildStartNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Start with an xmin/xmax that's correct for future, when all the 
         * currently running transactions have finished. We'll update both 
         * while waiting for the pending transactions to finish. 
         */ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* &LT; are finished */ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* &GT;= are running */ 
</span> 
        <span class='Comment_Multi_Line'>/* so we can safely use the faster comparisons */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical decoding found initial starting point at %X/%X"</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Waiting for transactions (approximately %d) older than %u to end."</span><span class='Delimiter'>, 
</span>                       <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN48"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN274"><span class='Ref_to_Proto'>SnapBuildWaitSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if builder-&GT;state==SNAPB... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * c) transition from BUILDING_SNAPSHOT to FULL_SNAPSHOT. 
     * 
     * In BUILDING_SNAPSHOT state, and this xl_running_xacts' oldestRunningXid 
     * is &GT;= than nextXid from when we switched to BUILDING_SNAPSHOT.  This 
     * means all transactions starting afterwards have enough information to 
     * be decoded.  Switch to FULL_SNAPSHOT. 
     */ 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN28"><span class='Ref_to_EnumConst'>SNAPBUILD_BUILDING_SNAPSHOT</span></a> <span class='Operator'>&& 
</span>             <a href="../../../include/access/transam.h.html#LN169"><span class='Ref_to_Proto'>TransactionIdPrecedesOrEquals</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN284"><span class='Ref_to_Func'>SnapBuildNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                           <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="../../../include/replication/snapbuild.h.html#LN38"><span class='Ref_to_EnumConst'>SNAPBUILD_FULL_SNAPSHOT</span></a><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN298"><span class='Ref_to_Func'>SnapBuildStartNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>          <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical decoding found initial consistent point at %X/%X"</span><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Waiting for transactions (approximately %d) older than %u to end."</span><span class='Delimiter'>, 
</span>                     <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN48"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN274"><span class='Ref_to_Proto'>SnapBuildWaitSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN51"><span class='Ref_to_Member'>nextXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * c) transition from FULL_SNAPSHOT to CONSISTENT. 
     * 
     * In FULL_SNAPSHOT state (see d) ), and this xl_running_xacts' 
     * oldestRunningXid is &GT;= than nextXid from when we switched to 
     * FULL_SNAPSHOT.  This means all transactions that are currently in 
     * progress have a catalog snapshot, and all their changes have been 
     * collected.  Switch to CONSISTENT. 
     */ 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN38"><span class='Ref_to_EnumConst'>SNAPBUILD_FULL_SNAPSHOT</span></a> <span class='Operator'>&& 
</span>             <a href="../../../include/access/transam.h.html#LN169"><span class='Ref_to_Proto'>TransactionIdPrecedesOrEquals</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN284"><span class='Ref_to_Func'>SnapBuildNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                           <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN52"><span class='Ref_to_Member'>oldestRunningXid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN298"><span class='Ref_to_Func'>SnapBuildStartNextPhaseAt</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical decoding found consistent point at %X/%X"</span><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1188"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"There are no old transactions anymore."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We already started to track running xacts and need to wait for all 
     * in-progress ones to finish. We fall through to the normal processing of 
     * records so incremental cleanup can be performed. 
     */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SnapBuildFindSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* --- 
 * Iterate through xids in record, wait for all older than the cutoff to 
 * finish.  Then, if possible, log a new xl_running_xacts record. 
 * 
 * This isn't required for the correctness of decoding, but to: 
 * a) allow isolationtester to notice that we're currently waiting for 
 *    something. 
 * b) log a new xl_running_xacts record where it'd be helpful, without having 
 *    to write for bgwriter or checkpointer. 
 * --- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1380"></a><span class='Declare_Function'>SnapBuildWaitSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/storage/standbydefs.h.html#LN46"><span class='Ref_to_Struct'>xl_running_xacts</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>running</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>cutoff</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1382"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1382"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapbuild.c.html#LN1382"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><a href="snapbuild.c.html#LN1380"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN48"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; </span><a href="snapbuild.c.html#LN1382"><span class='Ref_To_Local'>off</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1386"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1380"><span class='Ref_to_Parameter'>running</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/standbydefs.h.html#LN55"><span class='Ref_to_Member'>xids</span></a><span class='Delimiter'>[</span><a href="snapbuild.c.html#LN1382"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Upper layers should prevent that we ever need to wait on ourselves. 
         * Check anyway, since failing to do so would either result in an 
         * endless wait or an Assert() failure. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1386"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"waiting for ourselves"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1386"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1380"><span class='Ref_to_Parameter'>cutoff</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lmgr.h.html#LN73"><span class='Ref_to_Proto'>XactLockTableWait</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1386"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/lmgr.h.html#LN25"><span class='Ref_to_EnumConst'>XLTW_None</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * All transactions we needed to finish finished - try to ensure there is 
     * another xl_running_xacts record in a timely manner, without having to 
     * write for bgwriter or checkpointer to log one.  During recovery we 
     * can't enforce that, so we'll have to wait. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/standby.h.html#LN86"><span class='Ref_to_Proto'>LogStandbySnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildWaitSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ----------------------------------- 
 * Snapshot serialization support 
 * ----------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We store current state of struct SnapBuild on disk in the following manner: 
 * 
 * struct SnapBuildOnDisk; 
 * TransactionId * running.xcnt_space; 
 * TransactionId * committed.xcnt; (*not xcnt_space*) 
 * 
 */ 
</span><a name="LN1427"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>SnapBuildOnDisk</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* first part of this struct needs to be version independent */ 
</span> 
    <span class='Comment_Multi_Line'>/* data not covered by checksum */ 
</span><a name="LN1432"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>magic</span><span class='Delimiter'>; 
</span><a name="LN1433"></a>    <a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Member'>checksum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* data covered by checksum */ 
</span> 
    <span class='Comment_Multi_Line'>/* version, in case we want to support pg_upgrade */ 
</span><a name="LN1438"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>version</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* how large is the on disk data, excluding the constant sized part */ 
</span><a name="LN1440"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>length</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* version dependent part */ 
</span><a name="LN1443"></a>    <a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a>   <span class='Declare_Member'>builder</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* variable amount of TransactionIds follows */ 
</span><a name="LN1446"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SnapBuildOnDisk &raquo; </span> <span class='Declare_Typedef'>SnapBuildOnDisk</span><span class='Delimiter'>; 
</span> 
<a name="LN1448"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SnapBuildOnDiskConstantSize</span> <span class='Operator'>\ 
</span>    <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a><span class='Delimiter'>, </span>builder<span class='Parentheses'>) 
</span><a name="LN1450"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SnapBuildOnDiskNotChecksummedSize</span> <span class='Operator'>\ 
</span>    <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a><span class='Delimiter'>, </span>version<span class='Parentheses'>) 
</span> 
<a name="LN1453"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SNAPBUILD_MAGIC</span> <span class='Number'>0x51A1E001</span> 
<a name="LN1454"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SNAPBUILD_VERSION</span> <span class='Number'>2</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Store/Load a snapshot from disk, depending on the snapshot builder's state. 
 * 
 * Supposed to be used by external (i.e. not snapbuild.c) code that just read 
 * a record that's a potential location for a serialized snapshot. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1463"></a><span class='Declare_Function'>SnapBuildSerializationPoint</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1463"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>        <a href="snapbuild.c.html#LN278"><span class='Ref_to_Proto'>SnapBuildRestore</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1463"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1463"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="snapbuild.c.html#LN277"><span class='Ref_to_Proto'>SnapBuildSerialize</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1463"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1463"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Serialize the snapshot 'builder' at the location 'lsn' if it hasn't already 
 * been done by another decoding process. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1476"></a><span class='Declare_Function'>SnapBuildSerialize</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1478"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>needed_length</span><span class='Delimiter'>; 
</span><a name="LN1479"></a>    <a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ondisk</span><span class='Delimiter'>; 
</span><a name="LN1480"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ondisk_c</span><span class='Delimiter'>; 
</span><a name="LN1481"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1482"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1483"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1484"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1485"></a>    <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>stat_buf</span><span class='Delimiter'>; 
</span><a name="LN1486"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sz</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>|| 
</span>           <a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a> <span class='Operator'>&LT;= </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * no point in serializing if we cannot continue to work immediately after 
     * restoring the snapshot 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We identify snapshots by the LSN they are valid for. We don't need to 
     * include timelines in the name as each LSN maps to exactly one timeline 
     * unless the user used pg_resetwal or similar. If a user did so, there's 
     * no hope continuing to decode anyway. 
     */ 
</span>    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_logical/snapshots/%X-%X.snap"</span><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * first check whether some other backend already has written the snapshot 
     * for this LSN. It's perfectly fine if there's none, so we accept ENOENT 
     * as a valid state. Everything else is an unexpected error. 
     */ 
</span>    <a href="snapbuild.c.html#LN1484"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1485"><span class='Ref_To_Local'>stat_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1484"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1484"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * somebody else has already serialized to this point, don't overwrite 
         * but remember location, so we don't need to read old data again. 
         * 
         * To be sure it has been synced to disk after the rename() from the 
         * tempfile filename to the real filename, we just repeat the fsync. 
         * That ought to be cheap because in most scenarios it should already 
         * be safely on disk. 
         */ 
</span>        <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_logical/snapshots"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="snapbuild.c.html#LN1658"><span class='Ref_to_Label'>out</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * there is an obvious race condition here between the time we stat(2) the 
     * file and us writing the file. But we rename the file into place 
     * atomically and all files created need to contain the same data anyway, 
     * so this is perfectly fine, although a bit of a resource waste. Locking 
     * seems like pointless complication. 
     */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"serializing snapshot to %s"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* to make sure only we will write to this tempfile, include pid */ 
</span>    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='String'>"pg_logical/snapshots/%X-%X.snap.%u.tmp"</span><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Unlink temporary file if it already exists, needs to have been before a 
     * crash/error since we won't enter this function twice from within a 
     * single decoding slot/backend and the temporary file contains the pid of 
     * the current process. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN1478"><span class='Ref_To_Local'>needed_length</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN1480"><span class='Ref_To_Local'>ondisk_c</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1478"><span class='Ref_To_Local'>needed_length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1480"><span class='Ref_To_Local'>ondisk_c</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1432"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1453"><span class='Ref_to_Const'>SNAPBUILD_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1438"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1454"><span class='Ref_to_Const'>SNAPBUILD_VERSION</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1440"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1478"><span class='Ref_To_Local'>needed_length</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a><span class='Delimiter'>, 
</span>            <a href="snapbuild.c.html#LN1448"><span class='Ref_to_Const'>SnapBuildOnDiskConstantSize</span></a> <span class='Operator'>- </span><a href="../slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1480"><span class='Ref_To_Local'>ondisk_c</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* NULL-ify memory-only data */ 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Delimiter'>, 
</span>                <span class='Operator'>&</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Delimiter'>, 
</span>                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* there shouldn't be any running xacts */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN211"><span class='Ref_to_Member'>was_xcnt</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* copy committed xacts */ 
</span>    <a href="snapbuild.c.html#LN1486"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1480"><span class='Ref_To_Local'>ondisk_c</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1486"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1480"><span class='Ref_To_Local'>ondisk_c</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1486"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1480"><span class='Ref_To_Local'>ondisk_c</span></a> <span class='Operator'>+= </span><a href="snapbuild.c.html#LN1486"><span class='Ref_To_Local'>sz</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we have valid data now, open tempfile and write it there */ 
</span>    <a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, 
</span>                           O_CREAT <span class='Operator'>| </span>O_EXCL <span class='Operator'>| </span>O_WRONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN885"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1479"><span class='Ref_To_Local'>ondisk</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1478"><span class='Ref_To_Local'>needed_length</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="snapbuild.c.html#LN1478"><span class='Ref_To_Local'>needed_length</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * fsync the file before renaming so that even if we crash after this we 
     * have either a fully valid file or nothing. 
     * 
     * TODO: Do the fsync() via checkpoints/restartpoints, doing it here has 
     * some noticeable overhead since it's performed synchronously during 
     * decoding? 
     */ 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN884"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_SYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1481"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_logical/snapshots"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We may overwrite the work from some other backend, but that's ok, our 
     * snapshot is valid as well, we'll just have done some superfluous work. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1482"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* make sure we persist */ 
</span>    <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1483"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_logical/snapshots"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now there's no way we can loose the dumped state anymore, remember this 
     * as a serialization point. 
     */ 
</span>    <a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>lsn</span></a><span class='Delimiter'>; 
</span> 
<a name="LN1658"></a><span class='Label'>out</span><span class='Operator'>: 
</span>    <a href="../../../include/replication/reorderbuffer.h.html#LN400"><span class='Ref_to_Proto'>ReorderBufferSetRestartPoint</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, 
</span>                                 <a href="snapbuild.c.html#LN1476"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN189"><span class='Ref_to_Member'>last_serialized_snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildSerialize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Restore a snapshot into 'builder' if previously one has been stored at the 
 * location indicated by 'lsn'. Returns true if successful, false otherwise. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1668"></a><span class='Declare_Function'>SnapBuildRestore</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>builder</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1670"></a>    <a href="snapbuild.c.html#LN1427"><span class='Ref_to_Struct'>SnapBuildOnDisk</span></a> <span class='Declare_Local'>ondisk</span><span class='Delimiter'>; 
</span><a name="LN1671"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1672"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1673"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sz</span><span class='Delimiter'>; 
</span><a name="LN1674"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>readBytes</span><span class='Delimiter'>; 
</span><a name="LN1675"></a>    <a href="../../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Local'>checksum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* no point in loading a snapshot if we're already there */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_logical/snapshots/%X-%X.snap"</span><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ---- 
     * Make sure the snapshot had been stored safely to disk, that's normally 
     * cheap. 
     * Note that we do not need PANIC here, nobody will be able to use the 
     * slot without fsyncing, and saving it won't succeed without an fsync() 
     * either... 
     * ---- 
     */ 
</span>    <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_logical/snapshots"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* read statically sized portion of snapshot */ 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN883"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1448"><span class='Ref_to_Const'>SnapBuildOnDiskConstantSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><a href="snapbuild.c.html#LN1448"><span class='Ref_to_Const'>SnapBuildOnDiskConstantSize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\", read %d of %d: %m"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1448"><span class='Ref_to_Const'>SnapBuildOnDiskConstantSize</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1432"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>!= </span><a href="snapbuild.c.html#LN1453"><span class='Ref_to_Const'>SNAPBUILD_MAGIC</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"snapbuild state file \"%s\" has wrong magic number: %u instead of %u"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1432"><span class='Ref_to_Member'>magic</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1453"><span class='Ref_to_Const'>SNAPBUILD_MAGIC</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1438"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>!= </span><a href="snapbuild.c.html#LN1454"><span class='Ref_to_Const'>SNAPBUILD_VERSION</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"snapbuild state file \"%s\" has unsupported version: %u instead of %u"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1438"><span class='Ref_to_Member'>version</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1454"><span class='Ref_to_Const'>SNAPBUILD_VERSION</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a><span class='Delimiter'>, 
</span>            <a href="snapbuild.c.html#LN1448"><span class='Ref_to_Const'>SnapBuildOnDiskConstantSize</span></a> <span class='Operator'>- </span><a href="../slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* read SnapBuild */ 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN883"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\", read %d of %d: %m"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN152"><span class='Ref_to_Struct'>SnapBuild</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* restore running xacts (dead, but kept for backward compat) */ 
</span>    <a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN212"><span class='Ref_to_Member'>was_xcnt_space</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN213"><span class='Ref_to_Member'>was_xip</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN883"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN213"><span class='Ref_to_Member'>was_xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\", read %d of %d: %m"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN214"><span class='Ref_to_Member'>was_running</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN213"><span class='Ref_to_Member'>was_xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* restore committed xacts information */ 
</span>    <a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN158"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN883"><span class='Ref_to_EnumConst'>WAIT_EVENT_SNAPBUILD_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\", read %d of %d: %m"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1674"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1673"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1671"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* verify checksum of what we've read */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port/pg_crc32c.h.html#LN41"><span class='Ref_to_Macro'>EQ_CRC32C</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"checksum mismatch for snapbuild state file \"%s\": is %u, should be %u"</span><span class='Delimiter'>, 
</span>                        <a href="snapbuild.c.html#LN1672"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1675"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1433"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ok, we now have a sensible snapshot here, figure out if it has more 
     * information than we have. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We are only interested in consistent snapshots for now, comparing 
     * whether one incomplete snapshot is more "advanced" seems to be 
     * unnecessarily complex. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>&LT; </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="snapbuild.c.html#LN1846"><span class='Ref_to_Label'>snapshot_not_interesting</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't use a snapshot that requires an xmin that we cannot guarantee to 
     * be available. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN176"><span class='Ref_to_Member'>initial_xmin_horizon</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="snapbuild.c.html#LN1846"><span class='Ref_to_Label'>snapshot_not_interesting</span></a><span class='Delimiter'>; 
</span> 
 
    <span class='Comment_Multi_Line'>/* ok, we think the snapshot is sensible, copy over everything important */ 
</span>    <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN161"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN164"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* We only allocated/stored xcnt, not xcnt_space xids ! */ 
</span>    <span class='Comment_Multi_Line'>/* don't overwrite preallocated xip, if we don't have anything here */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN226"><span class='Ref_to_Member'>xcnt_space</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN223"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>        <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* our snapshot is not interesting anymore, build a new one */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/replication/snapbuild.h.html#LN66"><span class='Ref_to_Proto'>SnapBuildSnapDecRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN264"><span class='Ref_to_Proto'>SnapBuildBuildSnapshot</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapbuild.c.html#LN268"><span class='Ref_to_Proto'>SnapBuildSnapIncRefcount</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN184"><span class='Ref_to_Member'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/reorderbuffer.h.html#LN400"><span class='Ref_to_Proto'>ReorderBufferSetRestartPoint</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN194"><span class='Ref_to_Member'>reorder</span></a><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>builder</span></a><span class='Operator'>-&GT;</span><a href="snapbuild.c.html#LN155"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/replication/snapbuild.h.html#LN45"><span class='Ref_to_EnumConst'>SNAPBUILD_CONSISTENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical decoding found consistent point at %X/%X"</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>lsn</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1668"><span class='Ref_to_Parameter'>lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Logical decoding will begin using saved snapshot."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<a name="LN1846"></a><span class='Label'>snapshot_not_interesting</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1670"><span class='Ref_To_Local'>ondisk</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN1443"><span class='Ref_to_Member'>builder</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN250"><span class='Ref_to_Member'>committed</span></a><span class='Operator'>.</span><a href="snapbuild.c.html#LN249"><span class='Ref_to_Member'>xip</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapBuildRestore &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove all serialized snapshots that are not required anymore because no 
 * slot can need them. This doesn't actually have to run during a checkpoint, 
 * but it's a convenient point to schedule this. 
 * 
 * NB: We run this during checkpoints even if logical decoding is disabled so 
 * we cleanup old slots at some point after it got disabled. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1861"></a><span class='Declare_Function'>CheckPointSnapBuild</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1863"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>cutoff</span><span class='Delimiter'>; 
</span><a name="LN1864"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>redo</span><span class='Delimiter'>; 
</span><a name="LN1865"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>snap_dir</span><span class='Delimiter'>; 
</span><a name="LN1866"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>snap_de</span><span class='Delimiter'>; 
</span><a name="LN1867"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Number'>21</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We start off with a minimum of the last redo pointer. No new 
     * replication slot will start before that, so that's a safe upper bound 
     * for removal. 
     */ 
</span>    <a href="snapbuild.c.html#LN1864"><span class='Ref_To_Local'>redo</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlog.h.html#LN273"><span class='Ref_to_Proto'>GetRedoRecPtr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now check for the restart ptrs from existing slots */ 
</span>    <a href="snapbuild.c.html#LN1863"><span class='Ref_To_Local'>cutoff</span></a> <span class='Operator'>= </span><a href="../../../include/replication/slot.h.html#LN177"><span class='Ref_to_Proto'>ReplicationSlotsComputeLogicalRestartLSN</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* don't start earlier than the restart lsn */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1864"><span class='Ref_To_Local'>redo</span></a> <span class='Operator'>&LT; </span><a href="snapbuild.c.html#LN1863"><span class='Ref_To_Local'>cutoff</span></a><span class='Parentheses'>) 
</span>        <a href="snapbuild.c.html#LN1863"><span class='Ref_To_Local'>cutoff</span></a> <span class='Operator'>= </span><a href="snapbuild.c.html#LN1864"><span class='Ref_To_Local'>redo</span></a><span class='Delimiter'>; 
</span> 
    <a href="snapbuild.c.html#LN1865"><span class='Ref_To_Local'>snap_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_logical/snapshots"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="snapbuild.c.html#LN1866"><span class='Ref_To_Local'>snap_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1865"><span class='Ref_To_Local'>snap_dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_logical/snapshots"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1886"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hi</span><span class='Delimiter'>; 
</span><a name="LN1887"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lo</span><span class='Delimiter'>; 
</span><a name="LN1888"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>lsn</span><span class='Delimiter'>; 
</span><a name="LN1889"></a>        <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1866"><span class='Ref_To_Local'>snap_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1866"><span class='Ref_To_Local'>snap_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_logical/snapshots/%s"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1866"><span class='Ref_To_Local'>snap_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1889"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="../../../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1889"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"only regular files expected: %s"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * temporary filenames from SnapBuildSerialize() include the LSN and 
         * everything but are postfixed by .$pid.tmp. We can just remove them 
         * the same as other files because there can be none that are 
         * currently being written that are older than cutoff. 
         * 
         * We just log a message if a file doesn't fit the pattern, it's 
         * probably some editors lock/state file or similar... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1866"><span class='Ref_To_Local'>snap_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"%X-%X.snap"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1886"><span class='Ref_To_Local'>hi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapbuild.c.html#LN1887"><span class='Ref_To_Local'>lo</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not parse file name \"%s\""</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="snapbuild.c.html#LN1888"><span class='Ref_To_Local'>lsn</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="snapbuild.c.html#LN1886"><span class='Ref_To_Local'>hi</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>32</span> <span class='Operator'>| </span><a href="snapbuild.c.html#LN1887"><span class='Ref_To_Local'>lo</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check whether we still need it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1888"><span class='Ref_To_Local'>lsn</span></a> <span class='Operator'>&LT; </span><a href="snapbuild.c.html#LN1863"><span class='Ref_To_Local'>cutoff</span></a> <span class='Operator'>|| </span><a href="snapbuild.c.html#LN1863"><span class='Ref_To_Local'>cutoff</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"removing snapbuild snapshot %s"</span><span class='Delimiter'>, </span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * It's not particularly harmful, though strange, if we can't 
             * remove the file here. Don't prevent the checkpoint from 
             * completing, that'd be a cure worse than the disease. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="snapbuild.c.html#LN1867"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (snap_de=ReadDir(snap... &raquo; </span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="snapbuild.c.html#LN1865"><span class='Ref_To_Local'>snap_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckPointSnapBuild &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>